<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dairy POS Billing Software India - Free POS System for Milk Shops | MilkRecord</title>
    <style>
      :root {
        --bg: #f4f7fb; --panel: #ffffff; --line: #e5e7eb; --text: #0f172a; --muted: #64748b;
        --blue: #2563eb; --blue2: #1d4ed8; --green: #16a34a; --red: #dc2626; --yellow: #f59e0b;
        --shadow: 0 12px 26px rgba(0, 0, 0, 0.08);
      }
      * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        overflow: hidden;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
      }
      body {
        background: var(--bg);
        color: var(--text);
        font-family: system-ui, sans-serif;
        touch-action: manipulation;
      }
      .app {
        min-height: 100vh;
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 10px;
        width: 100%;
        box-sizing: border-box;
      }
      
      /* --- HEADER - Fully Responsive --- */
      .topbar { background: transparent; border: none; border-radius: 8px; box-shadow: none; padding: 2px 8px; display: flex; align-items: center; justify-content: space-between; height: 24px; gap: 6px; flex-shrink: 0; z-index: 100; }
      .brand { display: flex; align-items: center; gap: 6px; min-width: 0; flex-shrink: 0; }
      .logo-box { width: 16px; height: 16px; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: linear-gradient(180deg, #e0f2fe, #dbeafe); border: 1px solid #c7d2fe; font-size: 8px; flex-shrink: 0; overflow: hidden; }
      .brand-text { min-width: 0; display: flex; flex-direction: column; justify-content: center; }
      .brand-text .title { font-weight: 700; font-size: 10px; color: #0f172a; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }
      .brand-text .sub-text { font-size: 7px; font-weight: 500; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .hdr-actions { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
      .pillbtn { height: 24px; padding: 0 8px; border-radius: 6px; border: 1px solid var(--line); background: #fff; font-weight: 700; font-size: 10px; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s; white-space: nowrap; }
      .pillbtn.primary { background: #3b82f6; color: white; border-color: #3b82f6; }

      /* Mobile Responsive - Complete App-like Experience */
      @media (max-width: 768px) {
        html, body {
          position: fixed;
          overflow: hidden;
          height: 100%;
          width: 100%;
          margin: 0;
          padding: 0;
        }
        .app {
          padding: 0;
          gap: 0;
          height: 100vh;
          width: 100vw;
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }
        .topbar { 
          height: 40px; 
          padding: 4px 8px; 
          flex-shrink: 0; 
          z-index: 100 !important;
          background: #fff;
          border-bottom: 1px solid #e2e8f0;
        }
        .category-filters { display: none !important; }
        .logo-box { width: 24px; height: 24px; }
        .brand-text .title { font-size: 14px; max-width: 120px; }
        .brand-text .sub-text { font-size: 10px; display: block; }
        .pillbtn { height: 32px; padding: 0 10px; font-size: 11px; }
        .pillbtn span { display: inline; }
        .hdr-actions { gap: 6px; }
        .hdr-actions > button { padding: 0 8px !important; font-size: 10px !important; }
        .core { 
          grid-template-columns: 1fr; 
          height: calc(100vh - 40px); 
          min-height: auto;
          overflow: hidden;
        }
        .panel { 
          max-height: none !important; 
          height: auto; 
          border-radius: 0;
          border: none;
          border-bottom: 1px solid #e2e8f0;
        }
        .left-panel { 
          flex: 1;
          overflow: hidden;
          display: flex;
          flex-direction: column;
        }
        .left-panel .panelHeader { flex-shrink: 0; }
        .left-panel .product-grid {
          flex: 1;
          overflow-y: auto;
          overflow-x: hidden !important;
        }
        .product-grid {
          grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)) !important;
          gap: 6px !important;
          padding: 8px !important;
        }
        .p-card {
          min-height: 70px !important;
          padding: 4px 2px !important;
        }
        .p-card .emoji {
          font-size: 24px !important;
        }
        .p-card > div:nth-child(2) {
          font-size: 9px !important;
        }
        .p-card .price-tag {
          font-size: 8px !important;
          padding: 2px 4px !important;
        }
        .right-panel {
          flex: 1;
          overflow: hidden;
          display: flex;
          flex-direction: column;
        }
        #cartItems {
          max-height: 150px;
          overflow-y: auto;
        }
        .payment-section {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          width: 100% !important;
          padding: 8px !important;
          z-index: 100;
        }
        .payment-section > div {
          grid-template-columns: 1fr !important;
          gap: 8px !important;
          min-height: auto !important;
        }
        .payment-section #totalPayableDisplay {
          font-size: 42px !important;
          min-width: auto !important;
          padding: 12px 16px !important;
        }
        .payment-section #paymentForm {
          gap: 6px !important;
        }
        .payment-section input {
          font-size: 14px !important;
          padding: 9px !important;
        }
        .payment-section button {
          font-size: 11px !important;
          padding: 8px 10px !important;
        }
        .payment-section #roundupInput {
          width: 70px !important;
        }
        .payment-section .pay-grid {
          grid-template-columns: repeat(4, 1fr) !important;
        }
        .payment-section #advanceToggleBtn,
        .payment-section #advanceOrderBtn {
          font-size: 10px !important;
          padding: 8px 10px !important;
        }
        body { padding-bottom: 220px !important; }
      }

      @media (max-width: 480px) {
        .topbar { height: 36px; padding: 4px 6px; }
        .logo-box { width: 20px; height: 20px; font-size: 12px; }
        .brand-text .title { font-size: 12px; max-width: 100px; }
        .brand-text .sub-text { font-size: 9px; }
        .pillbtn { height: 28px; font-size: 9px; padding: 0 6px; }
        .hdr-actions > button { padding: 0 6px !important; font-size: 9px !important; }
        .product-grid {
          grid-template-columns: repeat(3, 1fr) !important;
          gap: 4px !important;
          padding: 4px !important;
        }
        .p-card {
          min-height: 60px !important;
          padding: 3px 1px !important;
        }
        .p-card .emoji {
          font-size: 20px !important;
        }
        .p-card > div:nth-child(2) {
          font-size: 8px !important;
        }
        .payment-section {
          padding: 6px !important;
        }
        .payment-section #totalPayableDisplay {
          font-size: 36px !important;
          padding: 10px 14px !important;
        }
        .payment-section input {
          font-size: 13px !important;
          padding: 8px !important;
        }
        .payment-section button {
          font-size: 10px !important;
          padding: 7px 8px !important;
        }
        .payment-section #roundupInput {
          width: 60px !important;
        }
        body { padding-bottom: 230px !important; }
      }

      /* Highlight animation for onboarding */
      @keyframes highlight-pulse {
        0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
        50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
      }
      .onboarding-highlight {
        animation: highlight-pulse 2s infinite;
        border: 3px solid #3b82f6 !important;
        position: relative;
        z-index: 1000;
      }
      .onboarding-tooltip {
        position: absolute;
        background: #3b82f6;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 700;
        z-index: 1001;
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        animation: float 2s ease-in-out infinite;
      }
      @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
      }

      /* Welcome Modal */
      .welcome-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }
      .welcome-modal.active {
        display: flex;
      }
      .welcome-content {
        background: white;
        border-radius: 16px;
        padding: 30px;
        max-width: 500px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      }

      /* Customer Ledger Mobile */
      @media (max-width: 768px) {
        #customerLedgerModal .modal {
          width: 100vw !important;
          max-width: 100vw !important;
          height: 100vh !important;
          max-height: 100vh !important;
          margin: 0 !important;
          border-radius: 0 !important;
        }
        #customerLedgerModal .modalBody {
          padding: 8px !important;
        }
        #customerLedgerContent > div {
          padding: 8px !important;
        }
        .ledger-summary-grid {
          grid-template-columns: repeat(2, 1fr) !important;
          gap: 8px !important;
        }
        .ledger-summary-grid > div {
          padding: 8px !important;
        }
        .ledger-summary-grid .amount {
          font-size: 16px !important;
        }
      }

      /* Rate List Modal Mobile */
      @media (max-width: 768px) {
        #rateListModal .modal {
          width: 100vw !important;
          max-width: 100vw !important;
          height: 100vh !important;
          max-height: 100vh !important;
          margin: 0 !important;
          border-radius: 0 !important;
        }
        #rateListProducts > div {
          margin-bottom: 12px !important;
        }
        #rateListProducts h3 {
          font-size: 14px !important;
          margin-bottom: 8px !important;
        }
        #rateListProducts .product-item {
          padding: 8px !important;
          margin-bottom: 6px !important;
        }
        #rateListProducts .emoji {
          font-size: 24px !important;
        }
        #rateListProducts .product-name {
          font-size: 12px !important;
        }
        #rateListProducts .product-price {
          font-size: 14px !important;
        }
      }

      /* --- CORE LAYOUT --- */
      .core { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; flex: 1; min-height: 0; }
      .panel { background: var(--panel); border: 1px solid var(--line); border-radius: 22px; box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; }
      .left-panel { display: flex; flex-direction: column; overflow: hidden; }
      .right-panel { overflow: visible; display: flex; flex-direction: column; }

      /* Left panel scrollable for customer search and products */
      .left-panel .panelHeader { flex-shrink: 0; }
      .left-panel #searchDropdown { max-height: 300px; overflow-y: auto; position: absolute; z-index: 1000; }
      .left-panel .product-grid {
        overflow-y: auto;
        overflow-x: auto;
        flex: 1;
        min-height: 0;
      }

      /* Fixed Payment Section at Bottom - Always Visible */
      .payment-section {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        background: var(--panel);
        border-top: 3px solid #16a34a;
        padding: 12px 15px;
        z-index: 100;
        box-shadow: 0 -6px 20px rgba(0,0,0,0.15);
        width: min(800px, 95vw);
        border-radius: 16px 16px 0 0;
        transition: all 0.3s;
      }
      .payment-section.wide {
        width: 100%;
      }

      /* Ensure emojis render properly on all systems */
      .payment-section, .p-card, .cardRow, .modal, body, .p-card .emoji, #cartItems td span {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Color Emoji", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif !important;
      }
      .p-card .emoji, #cartItems td span {
        font-size: inherit !important;
        display: inline-block !important;
        line-height: 1 !important;
      }

      /* Cart items scrollable with more height */
      #cartItems { max-height: 250px; overflow-y: auto; }
      #cartItems::-webkit-scrollbar { width: 6px; }
      #cartItems::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

      /* Panels height - more space for products */
      .left-panel, .right-panel { max-height: calc(100vh - 180px); }

      /* Product grid responsive with proper scrolling */
      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(95px, 1fr));
        gap: 8px;
        padding: 12px;
        outline: none;
        align-content: start;
        overflow-y: auto !important;
        overflow-x: auto !important;
        max-height: calc(100vh - 260px);
        width: 100%;
      }
      .product-grid::-webkit-scrollbar { width: 8px; height: 8px; }
      .product-grid::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
      .product-grid::-webkit-scrollbar-track { background: #f1f5f9; }
      .product-grid::-webkit-scrollbar-corner { background: #f1f5f9; }
      
      /* Ultra compact cards when many products */
      .p-card.compact {
        min-height: 75px;
        padding: 6px 5px;
      }
      .p-card.compact .emoji {
        font-size: 14px;
        max-height: 14px;
        margin-bottom: 3px;
      }
      .p-card.compact > div:nth-child(2) {
        font-size: 9px;
        min-height: 24px;
        margin-top: 4px;
      }
      .p-card.compact .price-tag {
        font-size: 8px !important;
        padding: 3px 6px !important;
        min-height: 16px !important;
        margin-top: 4px;
      }
      
      /* No price mode for ultra compact */
      .p-card.no-price .price-tag {
        display: none;
      }
      
      /* Beautiful product cards */
      .p-card {
        min-height: 100px;
        padding: 8px 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
      }
      .p-card:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.25);
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
      }
      /* Emoji sizes based on rank/quantity */
      .p-card .emoji {
        flex-shrink: 0;
        min-width: 40px;
        transition: all 0.3s;
        margin-bottom: 6px;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
      }
      .p-card[data-rank="1"] .emoji { font-size: 32px; }
      .p-card[data-rank="2"] .emoji { font-size: 36px; }
      .p-card[data-rank="3"] .emoji { font-size: 40px; }
      .p-card[data-rank="4"] .emoji { font-size: 44px; }
      .p-card[data-rank="5"] .emoji { font-size: 48px; }
      /* Hide emoji first when space is tight */
      .p-card.compact .emoji {
        font-size: 14px !important;
        margin-bottom: 3px;
        filter: none;
      }
      .p-card.no-emoji .emoji {
        display: none;
      }
      /* Uniform small font for all names - FORCE with !important */
      .p-card > div:nth-child(2) {
        font-size: 10px !important;
        font-weight: 900 !important;
        line-height: 1.3 !important;
        overflow: visible !important;
        text-overflow: clip !important;
        white-space: normal !important;
        word-break: break-word !important;
        text-align: center !important;
        margin-top: 4px !important;
        flex-grow: 1;
        min-height: 28px !important;
        display: -webkit-box !important;
        -webkit-line-clamp: 2 !important;
        -webkit-box-orient: vertical !important;
        flex-shrink: 0 !important;
        color: #1e293b !important;
        text-shadow: 0 1px 2px rgba(255,255,255,0.8) !important;
      }
      /* Uniform small font for all prices - FORCE with !important */
      .p-card .price-tag {
        font-size: 9px !important;
        padding: 4px 8px !important;
        flex-shrink: 0 !important;
        overflow: visible !important;
        text-overflow: clip !important;
        white-space: nowrap !important;
        max-width: 100% !important;
        min-height: 18px !important;
        line-height: 1.4 !important;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%) !important;
        border: 2px solid #86efac !important;
        border-radius: 6px !important;
        color: #166534 !important;
        font-weight: 800 !important;
        margin-top: 4px !important;
        box-shadow: 0 1px 3px rgba(134, 239, 172, 0.3) !important;
        display: inline-block !important;
        text-align: center !important;
      }

      /* Customer search max width */
      .left-panel #custSearch {
        max-width: 100%;
      }

      /* Tablet (768px - 1024px): Side by side with adjusted heights */
      @media (min-width: 768px) and (max-width: 1024px) {
        .core { grid-template-columns: 1fr 1fr; gap: 10px; flex: 1; min-height: 0; }
        .panel { max-height: none; }
        .product-grid { grid-template-columns: repeat(4, 1fr) !important; }
      }

      /* Desktop (1024px+): Full side by side */
      @media (min-width: 1025px) {
        .core { grid-template-columns: 1fr 1fr; gap: 14px; }
        .product-grid { grid-template-columns: repeat(5, 1fr) !important; }
      }

      /* Mobile: Stack panels vertically with 100% width */
      @media (max-width: 767px) {
        .app { padding: 6px; gap: 6px; }
        .core { grid-template-columns: 1fr; gap: 8px; height: auto; min-height: auto; flex: 1; }
        .panel { max-height: none !important; height: auto; border-radius: 12px; }
        .left-panel { order: 1; }
        .right-panel { order: 2; }
        .product-grid { grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)) !important; gap: 3px; }
        .p-card { padding: 3px 1px !important; min-height: 60px !important; }
        .p-card .emoji { font-size: 24px !important; }
        /* Keep uniform fonts on mobile too - but ensure prices visible */
        .p-card > div:nth-child(2) { font-size: 9px !important; }
        .p-card .price-tag { font-size: 8px !important; min-height: 16px !important; padding: 3px 5px !important; }
        .summary-box { margin: 6px; padding: 12px; }
        .summary-box .amt { font-size: 28px; }
        /* Cart items scrollable on mobile */
        .recent-table tbody { max-height: 300px; overflow-y: auto; }
        /* Payment grid 2x2 on mobile */
        .pay-grid { grid-template-columns: 1fr 1fr !important; gap: 4px; padding: 0 6px 6px; }
        .pay-btn { height: 40px; font-size: 11px; }
        /* Fixed payment section on mobile */
        .payment-section {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background: white;
          border-top: 3px solid #16a34a;
          padding: 12px 15px;
          z-index: 100;
          box-shadow: 0 -6px 20px rgba(0,0,0,0.15);
          border-radius: 16px 16px 0 0;
          width: 100% !important;
        }
        /* Maintain left column layout on mobile */
        .payment-section > div:first-child {
          grid-template-columns: auto 1fr !important;
          gap: 12px !important;
        }
        .payment-section > div:first-child > div:first-child {
          min-width: 200px !important;
        }
        .payment-section #totalPayableDisplay {
          font-size: 42px !important;
          color: #16a34a !important;
        }
        .payment-section #paymentAmount {
          font-size: 16px !important;
          padding: 12px !important;
        }
        .payment-section #roundupInput {
          font-size: 12px !important;
          padding: 12px !important;
        }
        .payment-section #roundupLabel {
          font-size: 10px !important;
        }
        .payment-section #creditDisplay {
          font-size: 12px !important;
        }
        .payment-section .pay-btn {
          padding: 10px !important;
          font-size: 11px !important;
        }
        .payment-section #btnCredit {
          padding: 12px !important;
          font-size: 12px !important;
        }
        .payment-section #advanceToggleBtn {
          padding: 12px 14px !important;
          font-size: 11px !important;
        }
        /* Advance form on mobile */
        .payment-section #monthMilk,
        .payment-section #currentAdvance {
          font-size: 20px !important;
        }
        .payment-section #advanceAmount {
          font-size: 14px !important;
          padding: 12px !important;
        }
        /* Add padding to right panel to prevent content hiding behind fixed payment */
        .right-panel { padding-bottom: 240px; }
        .left-panel { padding-bottom: 0; }
      }

      @media (max-width: 480px) {
        .core { gap: 8px; }
        .product-grid { grid-template-columns: repeat(2, 1fr) !important; }
        .p-card .emoji { font-size: 32px; }
        .topbar { height: 12px !important; z-index: 100 !important; }
        .logo-box { width: 10px !important; height: 10px !important; font-size: 6px !important; }
        .brand-text .title { font-size: 7px !important; max-width: 50px !important; }
        .brand-text .sub-text { display: none !important; }
        .pillbtn { height: 20px !important; font-size: 7px !important; }
      }
      .panelHeader { padding: 6px 12px; border-bottom: 1px solid var(--line); font-weight: 1000; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; height: 28px; }

      /* --- SEARCH & PERSISTENCE AREA --- */
      .cust-control { padding: 10px 15px; background: #f8fafc; border-bottom: 1px solid var(--line); display: flex; gap: 10px; position: relative; }
      .search-box { flex: 1; position: relative; }
      .search-box input { width: 100%; height: 40px; border-radius: 10px; border: 2px solid #e2e8f0; padding-left: 35px; outline: none; font-weight: 700; font-size: 14px; transition: all 0.2s; }
      .search-box input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
      .search-box::before { content: 'üîç'; position: absolute; left: 10px; top: 10px; font-size: 14px; z-index: 1; }

      /* Integrated Dropdown Style */
      .search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        width: 100%;
        min-width: 100%;
        max-width: 100%;
        background: #fff;
        border: 2px solid #3b82f6;
        border-top: none;
        border-radius: 0 0 12px 12px;
        z-index: 50;
        display: none;
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2);
        max-height: 250px;
        overflow-y: auto;
        margin-top: -2px;
        box-sizing: border-box;
      }
      .drop-item { 
        padding: 12px 15px; 
        border-bottom: 1px solid #f1f5f9; 
        cursor: pointer; 
        font-weight: 700; 
        font-size: 13px;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .drop-item:hover, .drop-item.selected { 
        background: #eff6ff; 
        color: #1d4ed8;
        padding-left: 20px;
      }
      .drop-item.add-new {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-bottom: 2px solid #22c55e;
        font-weight: 900;
      }
      .drop-item.add-new:hover {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      }

      .add-btn { height: 40px; padding: 0 15px; border-radius: 10px; border: none; background: var(--blue); color: #fff; font-weight: 1000; cursor: pointer; }

      .product-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; padding: 8px; overflow-y: auto; overflow-x: hidden; flex: 1; outline: none; align-content: start; }
      .p-card {
        background: #fff;
        border: none;
        border-radius: 8px;
        padding: 6px 4px;
        text-align: center;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        position: relative;
        min-height: 90px;
      }
      .p-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
      .p-card:hover .edit-prod-btn { opacity: 1; }
      .p-card:active { transform: scale(0.95); }
      .p-card.selected { border: 2px solid #3b82f6 !important; background: #eff6ff !important; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transform: scale(1.05); }
      .p-card.focused { outline: 2px solid #3b82f6; outline-offset: 2px; }
      .p-card[draggable="true"]:hover { cursor: grab; }
      .p-card[draggable="true"]:active { cursor: grabbing; }
      .p-card.dragging { opacity: 0.4; border: 2px dashed #3b82f6; }
      .p-card.drop-target { background: #eff6ff !important; border: 2px dashed #3b82f6 !important; }
      .recent-table tr[draggable="true"]:hover { cursor: grab; }
      .recent-table tr[draggable="true"]:active { cursor: grabbing; }
      .recent-table tr[draggable="true"] { transition: all 0.2s; }
      .recent-table tr.dragging { opacity: 0.4; border: 2px dashed #3b82f6; }
      .p-card.cow { background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%); }
      .p-card.buff { background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%); }
      
      /* Card sizing based on step RANK - emoji sizes vary, fonts stay uniform */
      /* Rank 1 (smallest step) - EXTRA SMALL */
      .p-card[data-rank="1"] { min-height: 65px !important; padding: 4px 2px !important; }
      .p-card[data-rank="1"] .emoji { font-size: 32px !important; }

      /* Rank 2 - SMALL */
      .p-card[data-rank="2"] { min-height: 75px !important; padding: 5px 3px !important; }
      .p-card[data-rank="2"] .emoji { font-size: 36px !important; }

      /* Rank 3 - MEDIUM (Default) */
      .p-card[data-rank="3"] { min-height: 90px !important; padding: 6px 4px !important; }
      .p-card[data-rank="3"] .emoji { font-size: 40px !important; }

      /* Rank 4 - LARGE */
      .p-card[data-rank="4"] { min-height: 105px !important; padding: 8px 5px !important; }
      .p-card[data-rank="4"] .emoji { font-size: 44px !important; }

      /* Rank 5 (largest step) - EXTRA LARGE */
      .p-card[data-rank="5"] { min-height: 120px !important; padding: 10px 6px !important; }
      .p-card[data-rank="5"] .emoji { font-size: 48px !important; }

      .qty-bar { display: flex; gap: 10px; padding: 12px 15px; background: #f8fafc; border-top: 1px solid var(--line); }
      .qty-btn { flex: 1; height: 45px; border-radius: 10px; border: 1px solid var(--line); background: #fff; font-weight: 1000; cursor: pointer; }

      .summary-box { background: linear-gradient(180deg, var(--blue), var(--blue2)); color: #fff; padding: 15px; border-radius: 18px; margin: 10px; text-align: center; }
      .amt { font-size: 42px; font-weight: 1200; }

      .pay-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; padding: 0 10px 10px; }
      .pay-btn { flex: 1; min-width: 80px; height: 36px; border-radius: 8px; border: none; font-weight: 900; font-size: 11px; cursor: pointer; transition: all 0.15s; }
      .pay-btn:hover { transform: translateY(-1px); }
      .pay-btn:active { transform: scale(0.98); }
      .pay-btn.credit { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; min-width: 100%; height: 40px; }

      .recent-table { width: 100%; border-collapse: collapse; font-size: 13px; }
      .recent-table td { padding: 10px; border-bottom: 1px solid var(--line); font-weight: 700; vertical-align: middle; }
      .recent-table input { padding: 4px; border: 1px solid var(--line); border-radius: 6px; font-weight: 700; text-align: center; }
      .recent-table input[type="number"]::-webkit-inner-spin-button { opacity: 1; cursor: pointer; }
      .recent-table .remove-btn { background: #fecaca; color: #7f1d1d; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-weight: 700; font-size: 12px; }

      .overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.45); display: none; align-items: center; justify-content: center; z-index: 1003; }
      .modal { width: min(800px, 95vw); height: min(600px, 90vh); background: #fff; border-radius: 22px; display: grid; grid-template-rows: 60px 1fr 70px; overflow: hidden; box-shadow: 0 24px 60px rgba(0,0,0,0.3); }
      .modalBody { padding: 20px; overflow-y: auto; background: #f8fafc; }
      .cardRow { background: #fff; border: 1px solid var(--line); border-radius: 16px; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }

      .toast { position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%); background: #0f172a; color: #fff; padding: 12px 20px; border-radius: 16px; font-weight: 1100; opacity: 0; transition: 0.3s; z-index: 1004; }
      .toast.show { opacity: 1; }
      
      /* Demo Banner */
      .demo-banner { background: #fef3c7; border-bottom: 2px solid #f59e0b; padding: 10px 20px; text-align: center; font-size: 13px; font-weight: 600; color: #92400e; }
      
      /* Institutional Gaps Panel */
      .gaps-panel { position: fixed; right: 0; top: 0; bottom: 0; width: 300px; background: #f8fafc; border-left: 2px solid #e2e8f0; padding: 20px; overflow-y: auto; transform: translateX(100%); transition: transform 0.3s; z-index: 1000; }
      .gaps-panel.open { transform: translateX(0); }
      .gaps-toggle { position: fixed; right: 20px; bottom: 120px; width: 50px; height: 50px; border-radius: 50%; background: #64748b; color: white; border: none; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 999; }
      .gap-item { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 10px; opacity: 0.6; }
      .gap-item h4 { margin: 0 0 5px 0; font-size: 13px; color: #475569; }
      .gap-item p { margin: 0; font-size: 12px; color: #64748b; }
      .gap-tooltip { background: #fef3c7; color: #92400e; font-size: 11px; padding: 6px; border-radius: 4px; margin-top: 6px; font-style: italic; }

      /* Card Image aur Selection Style */
.p-card img { width: 45px; height: 45px; object-fit: cover; margin-bottom: 8px; border-radius: 10px; }
.p-card.selected { border: 3px solid var(--blue) !important; background: #eff6ff !important; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3) !important; transform: scale(1.02); }
.price-input { width: 60px; border: 1px solid var(--line); border-radius: 5px; padding: 2px; font-weight: bold; text-align: center; }
.p-card .price-tag { font-size: 11px; font-weight: 700; color: #16a34a; background: #f0fdf4; padding: 4px 8px; border-radius: 4px; margin-top: 4px; display: block; text-align: center; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4"></script>
  </head>
  <body>
    <!-- Mobile POS Compact Interface CSS -->
    <link rel="stylesheet" href="../pos-mobile-compact.css" />
    <link rel="stylesheet" href="../mobile-forms-vertical.css" />
    <script src="../js/rate-chart-manager.js"></script>
    
    <div class="app">
      <div class="topbar">
        <!-- Product Category Filters (Left of Logo) -->
        <div style="display: flex; gap: 4px; align-items: center; padding: 4px 8px; background: #f8fafc; border-radius: 8px; margin-right: 8px;">
          <button onclick="filterProductsByCategory('all')" class="category-btn" style="padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-weight: 700; font-size: 10px; cursor: pointer;">üì¶ All</button>
          <button onclick="filterProductsByCategory('milk')" class="category-btn" style="padding: 4px 6px; background: white; color: #475569; border: 1px solid #e2e8f0; border-radius: 4px; font-weight: 700; font-size: 10px; cursor: pointer;" title="Milk">ü•õ Milk</button>
          <button onclick="filterProductsByCategory('paneer')" class="category-btn" style="padding: 4px 6px; background: white; color: #475569; border: 1px solid #e2e8f0; border-radius: 4px; font-weight: 700; font-size: 10px; cursor: pointer;" title="Paneer">üßÄ Paneer</button>
          <button onclick="filterProductsByCategory('ghee')" class="category-btn" style="padding: 4px 6px; background: white; color: #475569; border: 1px solid #e2e8f0; border-radius: 4px; font-weight: 700; font-size: 10px; cursor: pointer;" title="Ghee">üßà Ghee</button>
          <button onclick="filterProductsByCategory('curd')" class="category-btn" style="padding: 4px 6px; background: white; color: #475569; border: 1px solid #e2e8f0; border-radius: 4px; font-weight: 700; font-size: 10px; cursor: pointer;" title="Curd">ü•£ Curd</button>
          <button onclick="filterProductsByCategory('sweets')" class="category-btn" style="padding: 4px 6px; background: white; color: #475569; border: 1px solid #e2e8f0; border-radius: 4px; font-weight: 700; font-size: 10px; cursor: pointer;" title="Sweets">üç¨ Sweets</button>
          <button onclick="filterProductsByCategory('bakery')" class="category-btn" style="padding: 4px 6px; background: white; color: #475569; border: 1px solid #e2e8f0; border-radius: 4px; font-weight: 700; font-size: 10px; cursor: pointer;" title="Bakery">ü•ê Bakery</button>
          <button onclick="openModal('convertModal')" class="category-btn" style="padding: 4px 6px; background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; border-radius: 4px; font-weight: 700; font-size: 10px; cursor: pointer;" title="Convert Milk to Product">üîÑ Milk‚ÜíProduct</button>
        </div>
        <div class="brand">
          <a href="index.html" style="text-decoration:none; color:inherit; display: flex; align-items: center; gap: 6px;">
            <div class="logo-box" style="display: flex; align-items: center; justify-content: center;">
              <img src="../logo.jpg" alt="ü•õ" style="width: 100%; height: 100%; object-fit: contain; border-radius: 4px;" onerror="this.style.display='none'; this.parentElement.textContent='ü•õ'" />
            </div>
            <div class="brand-text" style="display: flex; flex-direction: column; justify-content: center;">
              <div class="title" id="shopTitle" style="font-weight: 700; font-size: 11px; color: #0f172a; white-space: nowrap;">MilkRecord</div>
              <div class="title" id="shopTitlePos" style="font-weight: 500; font-size: 9px; color: #64748b; white-space: nowrap;">POS</div>
            </div>
          </a>
        </div>
        <div class="hdr-actions">
          <!-- Production Module (In POS Popup) -->
          <button class="pillbtn primary" onclick="openModal('convertModal')" style="background:#7c3aed; border-color:#7c3aed;" title="Production Module">
            üè≠ Production
          </button>
          
          <!-- Customer Ledger Button -->
          <button class="pillbtn primary" onclick="openCustomerLedger()" style="background:#0891b2; border-color:#0891b2;" title="Customer Ledger & Accounts">
            üìí Customer Ledger
          </button>

          <!-- Product Rate List Button -->
          <button class="pillbtn primary" onclick="RateChartManager.showRateList()" style="background:#7c3aed; border-color:#7c3aed;" title="View & Share Rate List">
            üìã Rate List
          </button>

          <!-- Switch to Collection -->
          <button class="pillbtn primary" onclick="location.href='/collection'" style="background:#16a34a; border-color:#16a34a;">
            üìä Collection
          </button>

          <!-- Profile Dropdown (Top Right) -->
          <div style="position: relative; display: inline-block;">
            <button class="pillbtn" onclick="toggleProfileDropdown()" style="background:#f8fafc; border-color:#e2e8f0;">
              üè™ <span id="profileName">Loading...</span> ‚ñº
            </button>
            <div id="profileDropdown" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 8px; background: #f8fafc; border: 1px solid var(--line); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); min-width: 220px; z-index: 1005;">
              <div id="profileDropdownHeader" style="padding: 12px; border-bottom: 1px solid var(--line);">
                <div style="font-weight: 700; font-size: 13px;" id="dropdownEmail">user@email.com</div>
                <div style="font-size: 11px; color: var(--muted);" id="dropdownShop">Shop Name</div>
              </div>
              <button onclick="openModal('settingsModal'); toggleProfileDropdown()" style="width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text);">‚öôÔ∏è Settings</button>
              <button onclick="exportDetailedExcel(); toggleProfileDropdown()" style="width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text);">üìä Export Data</button>
              <button onclick="openModal('historyModal'); toggleProfileDropdown()" style="width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text);">üßæ History</button>
              <button onclick="toggleLanguage(); toggleProfileDropdown()" id="langToggleBtn" style="width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text);">üåê English (EN)</button>
              <div style="border-top: 1px solid var(--line); margin: 4px 0;"></div>
              <button onclick="logout()" style="width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: #dc2626;">üö™ Logout</button>
            </div>
          </div>
        </div>
      </div>

      <div class="core">
        <div class="panel" style="overflow: hidden; display: flex; flex-direction: column;">
          <!-- Product search field with actions -->
          <div style="padding: 8px 12px; background: #f8fafc; border-bottom: 1px solid var(--line); display: flex; gap: 8px; flex-shrink: 0;">
            <input type="text" id="productSearch" placeholder="üîç Search products..." oninput="filterProducts(this.value)" style="flex: 1; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600;" onclick="event.stopPropagation()" />
            <button onclick="openModal('addProductModal')" style="padding: 8px 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 13px; white-space: nowrap;" title="Create New Product">‚ûï Create</button>
            <button onclick="openEditInventory()" style="padding: 8px 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 13px; white-space: nowrap;" title="Edit Products">üìù Edit</button>
          </div>

          <div class="product-grid" id="productGrid" onclick="closeSearchDropdown()" tabindex="0" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
            <!-- Products loaded dynamically from localStorage -->
            <!-- Add & Edit Buttons -->
            <div class="p-card" style="border: 2px dashed #3b82f6; background: #eff6ff; min-height: 100px !important;" onclick="event.stopPropagation(); openModal('addProductModal')" title="Create new products to your inventory">
              <div style="font-size:40px; color:#3b82f6; font-weight: 900;">üõí‚ûï</div>
              <div style="font-weight:900; color:#3b82f6; font-size:11px; margin-top: 4px;">Create New Product</div>
            </div>
            <div class="p-card" style="border: 2px solid #f59e0b; background: #fffbeb; min-height: 100px !important;" onclick="event.stopPropagation(); openEditInventory()" title="Edit existing product prices and details">
              <div style="font-size:36px; color:#f59e0b; font-weight: 900;">üìùüìù</div>
              <div style="font-weight:900; color:#f59e0b; font-size:11px; margin-top: 4px;">Edit Product</div>
            </div>
            <div class="p-card" style="border: 2px solid #16a34a; background: #f0fdf4; min-height: 100px !important;" onclick="event.stopPropagation(); openModal('convertModal')" title="Convert milk to products">
              <div style="font-size:36px; color:#16a34a; font-weight: 900;">üîÑ</div>
              <div style="font-weight:900; color:#16a34a; font-size:11px; margin-top: 4px;">Milk ‚Üí Product</div>
            </div>
          </div>
        </div>

        <div class="panel left-panel" style="overflow-y: auto;" ondragover="handleProductDragToCart(event)" ondrop="handleProductDragToCart(event)">
          <div class="panelHeader" style="padding: 8px 12px; height: auto; min-height: 40px; background: #f8fafc; border-bottom: 1px solid var(--line);">
            <!-- Hidden element for active customer (for backwards compatibility) -->
            <span id="activeCust" style="display:none;">Walking Customer</span>

            <!-- Customer Search with Actions -->
            <div style="display: flex; gap: 8px; margin-bottom: 8px; width: 100%; max-width: 100%;">
              <div style="position: relative; flex: 1; width: 100%; min-width: 0;">
                <input type="text" id="custSearch" placeholder="üë§ Search customer..." oninput="handleSearch(this.value)" style="width: 100%; min-width: 0; padding: 8px 8px 8px 30px; border: 2px solid #3b82f6; border-radius: 8px; font-weight: 700; font-size: 13px; background: white; box-sizing: border-box;" />
                <span style="position: absolute; left: 10px; top: 8px; font-size: 14px;">üîé</span>
                <div id="searchDropdown" class="search-dropdown" onclick="event.stopPropagation()" style="top: 100%; left: 0; border-radius: 0 0 8px 8px; width: 100%; min-width: 0;"></div>
              </div>
              <button onclick="openModal('addCustModal')" style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 13px; white-space: nowrap; flex-shrink: 0;" title="Add New Customer">‚ûï Add</button>
            </div>
          </div>

          <!-- Advance/Cut Ledger Section - Collapsed by default -->
          <div id="advanceSection" style="display:none; background:#fef3c7; border:2px solid #f59e0b; border-radius:16px; margin:15px; padding:15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
              <h4 style="margin:0; color:#92400e; font-size:14px;">üìí Ledger Entry</h4>
              <button onclick="closeAdvance()" style="background:none; border:none; font-size:18px; cursor:pointer; color:#92400e;">‚úñ</button>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
              <div style="background:white; padding:10px; border-radius:8px; text-align:center;">
                <div style="font-size:11px; color:#64748b; font-weight:700;">TOTAL MILK (MONTH)</div>
                <div style="font-size:18px; font-weight:900; color:#1e293b;" id="monthMilk">0.0 L</div>
              </div>
              <div style="background:white; padding:10px; border-radius:8px; text-align:center;">
                <div style="font-size:11px; color:#64748b; font-weight:700;">CURRENT BALANCE</div>
                <div style="font-size:18px; font-weight:900; color:#166534;" id="currentAdvance">‚Çπ0.00</div>
              </div>
            </div>
            
            <!-- Credit/Debit Toggle -->
            <div style="margin-bottom:12px;">
              <div style="font-size:11px; color:#64748b; font-weight:700; margin-bottom:8px;">Transaction Type</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <label style="cursor:pointer;">
                  <input type="radio" name="ledgerType" value="credit" checked style="display:none;" onchange="updateLedgerPlaceholder()">
                  <div id="creditToggle" style="padding:10px; background:#f0fdf4; border:2px solid #22c55e; border-radius:8px; text-align:center; font-weight:700; color:#166534;">‚ûï Credit (Udhar)</div>
                </label>
                <label style="cursor:pointer;">
                  <input type="radio" name="ledgerType" value="debit" style="display:none;" onchange="updateLedgerPlaceholder()">
                  <div id="debitToggle" style="padding:10px; background:#fef2f2; border:2px solid #ef4444; border-radius:8px; text-align:center; font-weight:700; color:#7f1d1d;">‚ûñ Debit (Payment)</div>
                </label>
              </div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <input type="number" id="advanceAmount" placeholder="Kitna likhna hai? (‚Çπ)" style="padding:10px; border-radius:8px; border:1px solid #f59e0b; font-weight:700;" />
              <button onclick="updateAdvance()" style="padding:10px; background:#f59e0b; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer;">Update Ledger</button>
            </div>
            <button onclick="sendMonthlySummary()" style="width:100%; margin-top:8px; padding:12px; background:white; color:#92400e; border:1px solid #f59e0b; border-radius:8px; font-weight:700; cursor:pointer;">üí¨ Send Summary</button>
          </div>
          
          <!-- Cart Items (Top Priority - Visible Without Scroll) -->
          <div style="padding:15px; border-top:1px solid var(--line); border-bottom:1px solid var(--line); max-height: none; min-height: 300px; flex: 1; overflow-y: auto;" ondragover="handleCartDragOverTbody(event)" ondrop="handleCartDropTbody(event)" ondragleave="handleCartDragOut(event)">
            <table class="recent-table"><tbody id="cartItems" ondragover="handleCartDragOver(event)" ondrop="handleCartDrop(event)"></tbody></table>
          </div>

            <!-- Fixed Payment Section -->
            <div class="payment-section">
              <!-- Two Column Layout: Total (Left - Auto Width) + All Inputs (Right) -->
              <div style="display: grid; grid-template-columns: auto 1fr; gap: 12px; align-items: stretch; position: relative; min-height: 200px;">

                <!-- TOTAL PAYABLE (Left Column - Full Height, Auto Width) -->
                <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 4px solid #16a34a; border-radius: 12px; padding: 15px 25px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; height: 100%; min-width: 350px;">
                  <div style="font-size: 13px; color: #166534; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1.5px; white-space: nowrap;">Net Payable</div>
                  <div id="totalPayableDisplay" style="font-size: 56px; font-weight: 900; color: #16a34a; line-height: 1.1; white-space: nowrap;">‚Çπ0.00</div>
                </div>

                <!-- Right Column: Payment Form (Shows when advance is closed) -->
                <div id="paymentForm" style="display: flex !important; flex-direction: column; gap: 6px; justify-content: center;">
                  <!-- Row 1: Payment Amount (with integrated roundup) -->
                  <div style="display: flex; gap: 6px;">
                    <input type="number" id="paymentAmount" placeholder="Enter amount (‚Çπ)" style="flex: 1; padding: 11px; border: 2px solid #e2e8f0; border-radius: 8px; font-weight: 700; font-size: 17px; box-sizing:border-box;" oninput="calculateCredit()" onkeydown="if(event.key==='Enter'){saveAndInvoice();}" data-prev-total="0.00">
                    <input type="number" id="roundupInput" placeholder="Round" step="1" style="width: 80px; padding: 11px; border: 2px dashed #3b82f6; border-radius: 8px; font-weight: 700; font-size: 14px; text-align: center; background: #eff6ff; box-sizing:border-box;" oninput="applyRoundup()" title="Round to nearest 10, 50, 100 etc.">
                  </div>

                  <!-- Row 2: Status Display -->
                  <div style="display: flex; justify-content: center; align-items: center; gap: 12px; min-height: 20px;">
                    <div id="creditDisplay" style="font-size: 13px; font-weight: 700; color: #166534;">‡§∏‡§π‡•Ä ‡§∞‡§æ‡§∂‡§ø!</div>
                  </div>

                  <!-- Row 3: Payment Buttons Grid -->
                  <div class="pay-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap: 4px;">
                    <button class="pay-btn" id="btnCash" style="background:#dcfce7; color:#166534; padding: 9px;" onclick="saveEntry('Cash')">CASH</button>
                    <button class="pay-btn" id="btnUpi" style="background:#eff6ff; color:#1e40af; padding: 9px;" onclick="saveEntry('UPI')">UPI</button>
                    <button class="pay-btn" style="background:#fef3c7; color:#92400e; padding: 9px;" onclick="holdCart()">üü° HOLD</button>
                    <button class="pay-btn" style="background:#f1f5f9; color:#475569; padding: 9px;" onclick="showHeldCarts()">üìã <span id="heldCount">0</span></button>
                  </div>

                  <!-- Row 4: Credit Button + Advance Toggle + Advance Order (Same Row) -->
                  <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 6px;">
                    <button class="pay-btn credit" id="btnCredit" onclick="saveEntry('Credit')" style="width: 100%; padding: 11px; font-size: 13px; font-weight: 700;">LIKH LO (Credit)</button>
                    <button onclick="toggleAdvance()" id="advanceToggleBtn" style="padding: 11px 14px; background:#fef3c7; border:2px solid #f59e0b; border-radius:8px; font-weight:700; color:#92400e; cursor:pointer; font-size: 12px; white-space: nowrap;">üìí Advance / Udhar</button>
                    <button onclick="toggleAdvanceOrder()" id="advanceOrderBtn" style="padding: 11px 14px; background:#f5f3ff; border:2px solid #7c3aed; border-radius:8px; font-weight:700; color:#7c3aed; cursor:pointer; font-size: 12px; white-space: nowrap;">üìÖ Advance Order</button>
                  </div>
                </div>
              
              <!-- Right Column: Advance Form (Shows when advance is open - MAX HEIGHT) -->
              <div id="advanceForm" style="display: none; flex-direction: column; gap: 12px; max-height: calc(94vh - 150px); overflow-y: auto;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 2px solid #f59e0b;">
                  <h3 style="margin:0; color:#92400e; font-size: 18px; font-weight: 900;">üìí Customer Ledger</h3>
                  <button onclick="toggleAdvance()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#92400e; padding:0; width:32px; height:32px;">‚úñ</button>
                </div>
                
                <!-- Summary Cards -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                  <div style="background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding:15px; border-radius:12px; border:2px solid #0284c7; text-align:center;">
                    <div style="font-size:11px; color:#0369a1; font-weight:700; margin-bottom:6px;">üìä TOTAL MILK (MONTH)</div>
                    <div style="font-size:28px; font-weight:900; color:#0c4a6e;" id="monthMilk">0.0 L</div>
                  </div>
                  <div style="background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding:15px; border-radius:12px; border:2px solid #16a34a; text-align:center;">
                    <div style="font-size:11px; color:#166534; font-weight:700; margin-bottom:6px;">üí∞ CURRENT BALANCE</div>
                    <div style="font-size:28px; font-weight:900; color:#166534;" id="currentAdvance">‚Çπ0.00</div>
                  </div>
                </div>

                <!-- Amount Input + Transaction Type (Same Row) -->
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                  <!-- Amount Input (Auto-filled from Net Payable) -->
                  <div style="background:#fffbeb; padding:15px; border-radius:10px; border:2px solid #f59e0b; text-align:center;">
                    <div style="font-size:11px; color:#92400e; font-weight:700; margin-bottom:8px; text-transform:uppercase;">Amount (‚Çπ)</div>
                    <input type="number" id="advanceAmount" placeholder="Auto-filled" style="width:100%; padding:18px; border:2px solid #f59e0b; border-radius:10px; font-weight:900; font-size:28px; text-align:center; background:white;" oninput="updateAdvance()" />
                    <div style="font-size:10px; color:#92400e; font-weight:600; margin-top:6px;">‚ö†Ô∏è Auto-saves</div>
                  </div>
                  
                  <!-- Credit/Debit Toggle -->
                  <div style="background:#f8fafc; padding:12px; border-radius:10px; border:2px solid #e2e8f0; display:flex; flex-direction:column;">
                    <div style="font-size:11px; color:#64748b; font-weight:700; margin-bottom:10px; text-transform:uppercase; text-align:center;">Transaction Type</div>
                    <div style="display:flex; flex-direction:column; gap:8px; flex:1; justify-content:center;">
                      <label style="cursor:pointer;">
                        <input type="radio" name="ledgerType" value="credit" checked style="display:none;" onchange="updateLedgerPlaceholder()">
                        <div id="creditToggle" style="padding:12px; background:#f0fdf4; border:2px solid #22c55e; border-radius:10px; text-align:center; font-weight:700; color:#166534; font-size:13px;">‚ûï Likhlo (Credit)</div>
                      </label>
                      <label style="cursor:pointer;">
                        <input type="radio" name="ledgerType" value="debit" style="display:none;" onchange="updateLedgerPlaceholder()">
                        <div id="debitToggle" style="padding:12px; background:#fef2f2; border:2px solid #ef4444; border-radius:10px; text-align:center; font-weight:700; color:#7f1d1d; font-size:13px;">‚ûñ Payment</div>
                      </label>
                    </div>
                  </div>
                </div>
                
                <!-- Send Summary Button -->
                <button onclick="sendMonthlySummary()" style="width:100%; padding:16px; background:linear-gradient(135deg, #25d366 0%, #16a34a 100%); color:white; border:none; border-radius:10px; font-weight:700; font-size:16px; cursor:pointer; box-shadow:0 4px 12px rgba(37, 211, 102, 0.3);">üí¨ Send Summary on WhatsApp</button>
                
                <!-- Info Text -->
                <div style="text-align:center; padding:12px; background:#f8fafc; border-radius:10px; font-size:11px; color:#64748b; font-weight:600;">
                  ‚ö†Ô∏è This updates customer's credit/debit ledger for future settlement
                </div>
              </div>
              
              <!-- Advance Order Section (Separate from Advance Form) -->
              <div id="advanceOrderSection" style="display: none; flex-direction: column; gap: 12px; max-height: calc(94vh - 150px); overflow-y: auto; background: #f5f3ff; padding: 16px; border-radius: 12px; border: 2px solid #7c3aed;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 2px solid #7c3aed;">
                  <h3 style="margin:0; color:#7c3aed; font-size: 18px; font-weight: 900;">üìÖ Schedule Advance Order</h3>
                  <button onclick="toggleAdvanceOrder()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#7c3aed; padding:0; width:32px; height:32px;">‚úñ</button>
                </div>

                <!-- Order Summary -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                  <div style="background:#fff; padding:12px; border-radius:10px; border:2px solid #c084fc; text-align:center;">
                    <div style="font-size:10px; color:#6b21a8; font-weight:700; margin-bottom:4px; text-transform:uppercase;">Net Payable</div>
                    <div style="font-size:24px; font-weight:900; color:#7c3aed;" id="advanceOrderNetPayable">‚Çπ0.00</div>
                  </div>
                  <div style="background:#fff; padding:12px; border-radius:10px; border:2px solid #22c55e; text-align:center;">
                    <div style="font-size:10px; color:#166534; font-weight:700; margin-bottom:4px; text-transform:uppercase;">Advance Paid</div>
                    <input type="number" id="advanceOrderPaid" placeholder="‚Çπ0.00" style="width:100%; padding:8px; border:2px solid #22c55e; border-radius:8px; font-weight:900; font-size:20px; text-align:center; background:#f0fdf4;" oninput="calculateAdvanceOrderBalance()" />
                  </div>
                </div>

                <!-- Balance Display -->
                <div style="background:#fef3c7; padding:10px; border-radius:8px; border:2px solid #f59e0b; text-align:center;">
                  <div style="font-size:10px; color:#92400e; font-weight:700; margin-bottom:4px;">Balance to Collect</div>
                  <div id="advanceOrderBalance" style="font-size:18px; font-weight:900; color:#92400e;">‚Çπ0.00</div>
                </div>

                <!-- Customer Selection (MANDATORY) -->
                <div style="background:#fff; padding:12px; border-radius:10px; border:2px solid #3b82f6;">
                  <label style="font-size:11px; color:#1e40af; font-weight:700; display:block; margin-bottom:6px;">üë§ Select Customer <span style="color:#dc2626;">*</span></label>
                  <div style="display:grid; grid-template-columns:1fr auto; gap:8px;">
                    <select id="advanceOrderCustomer" onchange="onAdvanceOrderCustomerChange()" style="padding:10px; border:2px solid #3b82f6; border-radius:8px; font-weight:700; font-size:13px; background:white;">
                      <option value="">-- Select Customer --</option>
                    </select>
                    <button onclick="openAddCustomerFromAdvanceOrder()" style="padding:10px 16px; background:#3b82f6; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">‚ûï New</button>
                  </div>
                  <div id="advanceOrderPhoneWarning" style="font-size:10px; color:#dc2626; font-weight:700; margin-top:4px; display:none;">‚ö†Ô∏è Customer with phone number is required</div>
                  <div id="advanceOrderCustomerBalance" style="font-size:12px; color:#166534; font-weight:700; margin-top:8px; display:none;"></div>
                </div>

                <!-- Delivery Details -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                  <div>
                    <label style="font-size:11px; color:#6b21a8; font-weight:700; display:block; margin-bottom:6px;">üìç Delivery Location</label>
                    <input type="text" id="advanceOrderLocation" placeholder="Where to deliver?" style="width:100%; padding:10px; border:2px solid #c084fc; border-radius:8px; font-weight:700; font-size:13px;" />
                  </div>
                  <div>
                    <label style="font-size:11px; color:#6b21a8; font-weight:700; display:block; margin-bottom:6px;">üìÖ Delivery Date</label>
                    <input type="date" id="advanceOrderDate" style="width:100%; padding:10px; border:2px solid #c084fc; border-radius:8px; font-weight:700; font-size:13px;" />
                  </div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                  <div>
                    <label style="font-size:11px; color:#6b21a8; font-weight:700; display:block; margin-bottom:6px;">‚è∞ Delivery Time</label>
                    <input type="time" id="advanceOrderTime" style="width:100%; padding:10px; border:2px solid #c084fc; border-radius:8px; font-weight:700; font-size:13px;" />
                  </div>
                  <div>
                    <label style="font-size:11px; color:#6b21a8; font-weight:700; display:block; margin-bottom:6px;">üìù Notes (Optional)</label>
                    <input type="text" id="advanceOrderNotes" placeholder="Any special instructions" style="width:100%; padding:10px; border:2px solid #c084fc; border-radius:8px; font-weight:700; font-size:13px;" />
                  </div>
                </div>

                <!-- Action Buttons -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                  <button onclick="saveAdvanceOrder()" style="padding:12px; background:#7c3aed; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">‚úÖ Create Advance Order</button>
                  <button onclick="clearAdvanceOrderForm()" style="padding:12px; background:#e9d5ff; color:#7c3aed; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">üîÑ Clear</button>
                </div>

                <!-- View Orders Button -->
                <button onclick="viewAdvanceOrders()" style="width:100%; padding:12px; background:#f5f3ff; border:2px solid #7c3aed; border-radius:8px; color:#7c3aed; font-weight:700; cursor:pointer; font-size:13px;">üìÖ View My Advance Orders (<span id="advanceOrderCount">0</span>)</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Advance Orders Management Modal -->
      <div class="overlay" id="advanceOrdersModal">
        <div class="modal" style="width:min(900px, 95vw); height:min(80vh, 90vh); display:flex; flex-direction:column;">
          <div class="panelHeader" style="flex-shrink:0;">
            <span>üìÖ Advance Orders Management</span>
            <button onclick="closeModal('advanceOrdersModal')" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b;">‚úñ</button>
          </div>

          <!-- Stats Bar -->
          <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; padding:16px; background:#f8fafc; border-bottom:1px solid #e2e8f0; flex-shrink:0;">
            <div style="background:#fff; padding:12px; border-radius:8px; border:2px solid #3b82f6; text-align:center;">
              <div style="font-size:11px; color:#64748b; font-weight:700;">TOTAL ORDERS</div>
              <div style="font-size:24px; font-weight:900; color:#3b82f6;" id="aoTotalOrders">0</div>
            </div>
            <div style="background:#fff; padding:12px; border-radius:8px; border:2px solid #f59e0b; text-align:center;">
              <div style="font-size:11px; color:#64748b; font-weight:700;">PENDING</div>
              <div style="font-size:24px; font-weight:900; color:#f59e0b;" id="aoPendingOrders">0</div>
            </div>
            <div style="background:#fff; padding:12px; border-radius:8px; border:2px solid #22c55e; text-align:center;">
              <div style="font-size:11px; color:#64748b; font-weight:700;">TOTAL VALUE</div>
              <div style="font-size:20px; font-weight:900; color:#22c55e;" id="aoTotalValue">‚Çπ0</div>
            </div>
            <div style="background:#fff; padding:12px; border-radius:8px; border:2px solid #ef4444; text-align:center;">
              <div style="font-size:11px; color:#64748b; font-weight:700;">TO COLLECT</div>
              <div style="font-size:20px; font-weight:900; color:#ef4444;" id="aoToCollect">‚Çπ0</div>
            </div>
          </div>

          <!-- Filter & Search -->
          <div style="display:flex; gap:12px; padding:16px; border-bottom:1px solid #e2e8f0; flex-shrink:0;">
            <input type="text" id="aoSearch" placeholder="üîç Search by customer, location..." style="flex:1; padding:10px; border:2px solid #e2e8f0; border-radius:8px; font-weight:700;" oninput="filterAdvanceOrders()" />
            <select id="aoFilterStatus" onchange="filterAdvanceOrders()" style="padding:10px; border:2px solid #e2e8f0; border-radius:8px; font-weight:700;">
              <option value="all">All Orders</option>
              <option value="pending">Pending</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
            <select id="aoFilterType" onchange="filterAdvanceOrders()" style="padding:10px; border:2px solid #e2e8f0; border-radius:8px; font-weight:700;">
              <option value="all">All Types</option>
              <option value="credit">üìí Credit (Udhar)</option>
              <option value="debit">üíµ Debit (Payment)</option>
            </select>
          </div>

          <!-- Orders List -->
          <div style="flex:1; overflow-y:auto; padding:16px;" id="advanceOrdersList">
            <!-- Orders will be populated here -->
          </div>

          <!-- Footer Actions -->
          <div style="padding:16px; border-top:1px solid #e2e8f0; flex-shrink:0; display:flex; gap:8px;">
            <button onclick="exportAdvanceOrders()" style="flex:1; padding:12px; background:#3b82f6; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer;">üìä Export All</button>
            <button onclick="closeModal('advanceOrdersModal')" style="padding:12px 24px; background:#e2e8f0; color:#475569; border:none; border-radius:8px; font-weight:700; cursor:pointer;">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Rate List Modal -->
    <div class="overlay" id="rateListModal">
      <div class="modal" style="width:min(700px, 95vw); height:min(80vh, 90vh); display:flex; flex-direction:column;">
        <div class="panelHeader" style="flex-shrink:0;">
          <span>üìã Product Rate List</span>
          <button onclick="closeModal('rateListModal')" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b;">‚úñ</button>
        </div>

        <!-- Shop Info -->
        <div style="padding:12px 16px; background:#f8fafc; border-bottom:1px solid #e2e8f0; flex-shrink:0;">
          <div style="font-size:13px; font-weight:700; color:#1e293b;" id="rateListShopName">üè™ Shop Name</div>
          <div style="font-size:11px; color:#64748b;" id="rateListDate">üìÖ <span id="rateListCurrentDate"></span></div>
        </div>

        <!-- Products List -->
        <div style="flex:1; overflow-y:auto; padding:16px;" id="rateListProducts">
          <!-- Products will be populated here -->
        </div>

        <!-- Action Buttons -->
        <div style="padding:16px; border-top:1px solid #e2e8f0; flex-shrink:0; display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
          <button onclick="copyRateList()" style="padding:12px; background:#e0f2fe; color:#0369a1; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">üìã Copy</button>
          <button onclick="sendRateListWhatsApp()" style="padding:12px; background:#25d366; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">üì± Send via WhatsApp</button>
          <button onclick="printRateList()" style="padding:12px; background:#3b82f6; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">üñ®Ô∏è Print Rate List</button>
        </div>
      </div>
    </div>

    <!-- Customer Relation Modal -->
    <div class="overlay" id="customerRelationModal">
      <div class="modal" style="width:min(800px, 95vw); height:min(85vh, 90vh); display:flex; flex-direction:column;">
        <div class="panelHeader" style="flex-shrink:0;">
          <span>ü§ù Customer Relation - <span id="relationCustomerName"></span></span>
          <button onclick="closeModal('customerRelationModal')" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b;">‚úñ</button>
        </div>

        <!-- Content -->
        <div style="flex:1; overflow-y:auto; padding:16px;" id="relationContent">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Advance/Udhari Ledger Modal -->
    <div class="overlay" id="advanceLedgerModal">
      <div class="modal" style="width:min(900px, 95vw); height:min(85vh, 90vh); display:flex; flex-direction:column;">
        <div class="panelHeader" style="flex-shrink:0;">
          <span>üìí Advance & Udhari Ledger - <span id="ledgerCustomerName"></span></span>
          <button onclick="closeModal('advanceLedgerModal')" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b;">‚úñ</button>
        </div>

        <!-- Tabs -->
        <div style="display:flex; border-bottom:1px solid #e2e8f0; flex-shrink:0;">
          <button onclick="switchLedgerTab('advance')" id="tabAdvance" style="flex:1; padding:12px; border:none; background:#ede9fe; border-bottom:3px solid #7c3aed; font-weight:700; cursor:pointer; color:#7c3aed;">üì• Advance Deposits</button>
          <button onclick="switchLedgerTab('udhari')" id="tabUdhari" style="flex:1; padding:12px; border:none; background:#f8fafc; border-bottom:3px solid transparent; font-weight:700; cursor:pointer; color:#64748b;">üìí Udhari (Credit)</button>
        </div>

        <!-- Content -->
        <div style="flex:1; overflow-y:auto; padding:16px;" id="ledgerContent">
          <!-- Content will be populated by JavaScript -->
        </div>

        <!-- Action Buttons -->
        <div style="padding:16px; border-top:1px solid #e2e8f0; flex-shrink:0; display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <button onclick="addNewAdvance()" id="btnAddAdvance" style="padding:12px; background:#7c3aed; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">‚ûï New Advance</button>
          <button onclick="sendLedgerWhatsApp()" style="padding:12px; background:#25d366; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">üì± Send via WhatsApp</button>
        </div>
      </div>
    </div>

    <div class="overlay" id="addCustModal">
        <div class="modal" style="width:450px; height:auto;">
            <div class="panelHeader"><span>üìù Add/Edit Customer</span> <button onclick="closeModal('addCustModal')">‚úñ</button></div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <!-- Customer ID (Auto-generated, Editable) -->
                <div style="display:grid; grid-template-columns: 1fr 2fr; gap:8px;">
                  <input type="text" id="newCustId" placeholder="ID (e.g., C001)" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:700; font-size:13px;" />
                  <input type="text" id="newName" placeholder="Full Name *" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:1000;" required />
                </div>
                
                <!-- Customer Emoji -->
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="text" id="newCustEmoji" placeholder="üë§ Customer Emoji" value="üë§" style="flex: 1; padding:12px; border-radius:10px; border:2px solid #3b82f6; font-weight:700; font-size:14px;" />
                  <button type="button" onclick="openCustomerEmojiPicker()" style="padding: 12px 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #3b82f6; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 18px;" title="Choose Customer Emoji">üë§</button>
                </div>
                
                <input type="tel" id="newPhone" placeholder="üì± WhatsApp Mobile (e.g., 9876543210)" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:1000;" inputmode="tel" pattern="[0-9]{10}" />
                <input type="email" id="newEmail" placeholder="‚úâÔ∏è Email (optional)" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:1000;">
                <input type="text" id="newAddress" placeholder="üìç Address (optional)" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:1000;">

                <button class="add-btn" style="padding:14px; background:var(--blue); color:white; border:none; border-radius:10px; font-weight:700; cursor:pointer; font-size:15px;" onclick="addNewCustomer()">‚ûï Add Customer</button>
            </div>
            <!-- Fixed Bottom Actions -->
            <div style="position: sticky; bottom: 0; background: white; border-top: 2px solid #e2e8f0; padding: 12px 20px; display: flex; gap: 8px;">
              <button type="button" onclick="closeModal('addCustModal')" style="flex: 1; padding: 12px; background: #f1f5f9; color: #64748b; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px;">‚ùå Cancel</button>
              <button type="button" onclick="addNewCustomer()" style="flex: 2; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px;">‚úÖ Add Customer</button>
            </div>
        </div>
    </div>

    <!-- Customer Emoji Picker Modal -->
    <div class="overlay" id="customerEmojiPickerModal">
        <div class="modal" style="width: 90vw !important; max-width: 600px !important; height: auto !important; max-height: 80vh !important; overflow-y: auto !important;">
            <div class="panelHeader">
                <span>üë§ Choose Customer Emoji</span>
                <button onclick="closeModal('customerEmojiPickerModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">‚úñ</button>
            </div>
            
            <!-- Search Bar -->
            <div style="padding: 16px; border-bottom: 2px solid #e2e8f0;">
                <input type="text" id="customerEmojiSearchInput" placeholder="üîç Search emojis (person, man, woman, business...)" oninput="filterCustomerEmojis()" style="width: 100%; padding: 12px; border: 2px solid #3b82f6; border-radius: 10px; font-weight: 700; font-size: 14px; box-sizing: border-box;" />
            </div>
            
            <!-- Emoji Grid -->
            <div id="customerEmojiGrid" style="padding: 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; max-height: 50vh; overflow-y: auto;">
                <!-- Emojis will be loaded here -->
            </div>
            
            <!-- Last Selected -->
            <div id="customerLastSelectedEmoji" style="padding: 12px 16px; background: #f0f9ff; border-top: 2px solid #3b82f6; display: none;">
                <div style="font-size: 11px; font-weight: 700; color: #1e40af; margin-bottom: 6px;">üìå Last Selected:</div>
                <button id="customerLastEmojiBtn" onclick="useCustomerLastEmoji()" style="font-size: 24px; padding: 8px 16px; background: white; border: 2px solid #3b82f6; border-radius: 8px; cursor: pointer;"></button>
            </div>
        </div>
    </div>

    <div class="overlay" id="memoryModal">
      <div class="modal" style="width:500px; height:auto;">
        <div class="panelHeader"><span id="lblMemTitle">Customer Memory üß†</span> <button onclick="closeModal('memoryModal')">‚úñ</button></div>
        <div class="modalBody" id="memoryList"></div>
      </div>
    </div>

    <div class="overlay" id="historyModal">
      <div class="modal" style="width:min(800px, 95vw); height:auto; max-height:95vh; display:flex; flex-direction:column;">
        <div class="panelHeader" style="flex-shrink:0;">
          <span id="lblHistTitle">üßæ History</span>
          <button onclick="closeModal('historyModal')" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b; padding:0; width:32px; height:32px;">‚úñ</button>
        </div>

        <!-- Tabs -->
        <div style="display:flex; border-bottom:1px solid var(--line); padding:0 20px; flex-shrink:0;">
          <button onclick="switchHistoryTab('today')" id="tabToday" style="flex:1; padding:12px; border:none; background:none; font-weight:700; cursor:pointer; border-bottom:3px solid var(--blue);">üìÖ Today</button>
          <button onclick="switchHistoryTab('all')" id="tabAll" style="flex:1; padding:12px; border:none; background:none; font-weight:700; cursor:pointer; border-bottom:3px solid transparent;">üìö All History</button>
        </div>

        <!-- Tab Content - Takes remaining space -->
        <div style="flex:1; overflow-y:auto; padding:15px; min-height:0;">
          <div id="historyToday" style="display:block;"></div>
          <div id="historyWeekly" style="display:none;"></div>
        </div>

        <!-- Footer Actions -->
        <div style="padding:15px 20px; border-top:1px solid var(--line); flex-shrink:0;">
          <!-- Cash In/Out Buttons -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;">
            <button onclick="quickCashIn()" style="padding:10px; background:#dcfce7; color:#166534; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">üí∞ Cash In</button>
            <button onclick="quickCashOut()" style="padding:10px; background:#fef3c7; color:#92400e; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">üí∏ Cash Out</button>
          </div>

          <div style="display:flex; gap:10px; justify-content:space-between; align-items:center;">
            <div style="font-size:13px; color:var(--muted); font-weight:700;">
              <span id="historyCount">1 today ‚Ä¢ 0 in 7d</span>
            </div>
            <div style="display:flex; gap:8px;">
              <button onclick="downloadHistoryExcel()" style="padding:8px 16px; background:#eff6ff; color:#1e40af; border:none; border-radius:8px; font-weight:700; cursor:pointer;">‚¨áÔ∏è Excel</button>
              <button onclick="downloadHistoryPDF()" style="padding:8px 16px; background:#fef3c7; color:#92400e; border:none; border-radius:8px; font-weight:700; cursor:pointer;">üìÑ PDF</button>
              <button onclick="clearTodayHistory()" style="padding:8px 16px; background:#fecaca; color:#7f1d1d; border:none; border-radius:8px; font-weight:700; cursor:pointer;">üóëÔ∏è Clear</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="overlay" id="convertModal">
        <div class="modal" style="width:550px; height:auto; max-height:90vh; overflow-y:auto;">
            <div class="panelHeader" style="background:linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color:white;">
                <span>üè≠ Production Module</span>
                <button onclick="closeModal('convertModal')" style="background:none; border:none; font-size:24px; cursor:pointer; color:white;">‚úñ</button>
            </div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:16px;">
                
                <!-- Today's Milk Collection -->
                <div style="background:#eff6ff; padding:16px; border-radius:12px; border:2px solid #3b82f6;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="font-size:12px; font-weight:700; color:#1e40af;">üìä Today's Milk Collection</div>
                        <a href="/collection" style="font-size:11px; color:#2563eb; font-weight:700; text-decoration:none; background:#dbeafe; padding:4px 8px; border-radius:4px;">üìù Go to Collection ‚Üí</a>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div style="background:white; padding:12px; border-radius:8px;">
                            <div style="font-size:10px; color:#64748b; font-weight:700;">ü•õ COW MILK</div>
                            <div style="font-size:20px; font-weight:900; color:#1e3a8a;"><span id="todayCowMilk">0.0</span> L</div>
                            <div style="font-size:10px; color:#166534; font-weight:700;">‚Çπ<span id="todayCowAmount">0</span></div>
                        </div>
                        <div style="background:white; padding:12px; border-radius:8px;">
                            <div style="font-size:10px; color:#64748b; font-weight:700;">üêÉ BUFF MILK</div>
                            <div style="font-size:20px; font-weight:900; color:#1e3a8a;"><span id="todayBuffMilk">0.0</span> L</div>
                            <div style="font-size:10px; color:#166534; font-weight:700;">‚Çπ<span id="todayBuffAmount">0</span></div>
                        </div>
                    </div>
                    <div style="background:#fef3c7; padding:8px; border-radius:6px; border:1px solid #f59e0b; margin-top:12px;">
                        <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:700; color:#92400e;">
                            <span>üìà TOTAL:</span>
                            <span><span id="todayTotalMilk">0.0</span> L | ‚Çπ<span id="todayTotalAmount">0</span></span>
                        </div>
                    </div>
                    
                    <!-- Auto Production Suggestion -->
                    <div id="autoSuggestion" style="display:none; margin-top:12px; padding:12px; background:#f0fdf4; border:2px solid #16a34a; border-radius:8px;">
                        <div style="font-size:11px; font-weight:700; color:#166534; margin-bottom:8px;">üí° Suggested Production (Based on Sales Pattern)</div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <div style="background:white; padding:8px; border-radius:6px;">
                                <div style="font-size:10px; color:#64748b;">üßÄ Paneer</div>
                                <div style="font-size:13px; font-weight:900; color:#15803d;">100L ‚Üí 20kg</div>
                            </div>
                            <div style="background:white; padding:8px; border-radius:6px;">
                                <div style="font-size:10px; color:#64748b;">ü•£ Curd</div>
                                <div style="font-size:13px; font-weight:900; color:#15803d;">50L ‚Üí 50kg</div>
                            </div>
                        </div>
                        <button type="button" onclick="applySuggestion()" style="margin-top:8px; width:100%; padding:8px; background:#16a34a; color:white; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:11px;">‚úÖ Apply Suggestion</button>
                    </div>
                    
                    <div id="noMilkWarning" style="display:none; margin-top:12px; padding:12px; background:#fef2f2; border:2px solid #fecaca; border-radius:8px; text-align:center;">
                        <div style="font-size:12px; font-weight:700; color:#991b1b; margin-bottom:4px;">‚ö†Ô∏è No milk collected today!</div>
                        <div style="font-size:11px; color:#7f1d1d;">Go to Collection page to add milk entries first</div>
                    </div>
                </div>

                <!-- Shift Selection -->
                <div style="background:#f8fafc; padding:12px; border-radius:8px; border:1px solid #e2e8f0;">
                    <div style="font-size:11px; font-weight:700; color:#475569; margin-bottom:8px;">üìã Shift Information</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div>
                            <label style="font-size:10px; color:#64748b; font-weight:700;">Shift</label>
                            <select id="prodShift" style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1; font-weight:700; font-size:13px;">
                                <option value="morning">üåÖ Morning</option>
                                <option value="evening">üåÜ Evening</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:10px; color:#64748b; font-weight:700;">Batch ID</label>
                            <div style="font-size:12px; font-weight:700; color:#1e293b; padding:8px; background:white; border-radius:6px;" id="batchIdDisplay">Auto-generated</div>
                        </div>
                    </div>
                </div>

                <!-- Milk Source -->
                <div style="background:#f0fdf4; padding:12px; border-radius:8px; border:2px solid #16a34a;">
                    <div style="font-size:11px; font-weight:700; color:#166534; margin-bottom:8px;">ü•õ Select Milk Source:</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                        <label style="background:white; padding:10px; border-radius:6px; border:2px solid #e2e8f0; cursor:pointer; text-align:center;">
                            <input type="radio" name="milkSource" value="cow" onchange="updateProductionPreview()" style="margin-bottom:4px;" />
                            <div style="font-size:12px; font-weight:700;">ü•õ Cow</div>
                        </label>
                        <label style="background:white; padding:10px; border-radius:6px; border:2px solid #e2e8f0; cursor:pointer; text-align:center;">
                            <input type="radio" name="milkSource" value="buff" onchange="updateProductionPreview()" style="margin-bottom:4px;" />
                            <div style="font-size:12px; font-weight:700;">üêÉ Buff</div>
                        </label>
                        <label style="background:white; padding:10px; border-radius:6px; border:2px solid #16a34a; cursor:pointer; text-align:center;">
                            <input type="radio" name="milkSource" value="mixed" onchange="updateProductionPreview()" checked style="margin-bottom:4px;" />
                            <div style="font-size:12px; font-weight:700;">üîÄ Mixed</div>
                        </label>
                    </div>
                </div>

                <!-- Product Type -->
                <div>
                    <label style="font-size:10px; color:#64748b; font-weight:700;">Product Type</label>
                    <select id="prodProduct" style="width:100%; padding:12px; border-radius:8px; border:2px solid #7c3aed; font-weight:700; font-size:14px;" onchange="updateProductionRatio()">
                        <option value="">Select product...</option>
                        <option value="paneer,400,5">üßÄ Paneer (5L ‚Üí 1kg)</option>
                        <option value="ghee,600,25">üßà Ghee (25L ‚Üí 1kg)</option>
                        <option value="curd,80,1">ü•£ Curd (1L ‚Üí 1kg)</option>
                        <option value="sweets,300,8">üç¨ Sweets (8L ‚Üí 1kg)</option>
                        <option value="cream,200,20">ü•õ Cream (20L ‚Üí 1kg)</option>
                    </select>
                </div>

                <!-- Conversion Ratio -->
                <div id="prodRatioDisplay" style="background:#f3e8ff; padding:12px; border-radius:8px; border:2px solid #c084fc; display:none;">
                    <div style="font-size:11px; font-weight:700; color:#7e22ce; margin-bottom:4px;">üìä Conversion Ratio:</div>
                    <div style="font-size:13px; color:#7e22ce; font-weight:700;">
                        <span id="prodRatioText">5L Milk ‚Üí 1kg Paneer</span>
                    </div>
                </div>

                <!-- Milk Quantity -->
                <div>
                    <label style="font-size:10px; color:#64748b; font-weight:700;">Milk Used (L)</label>
                    <input type="number" id="prodMilkQty" placeholder="Enter milk quantity" style="width:100%; padding:12px; border-radius:8px; border:2px solid #3b82f6; font-weight:700; font-size:14px;" oninput="updateProductionPreview()" />
                    <div id="prodMilkWarning" style="display:none; margin-top:8px; padding:8px; background:#fef2f2; border:1px solid #fecaca; border-radius:6px; font-size:11px; color:#991b1b; font-weight:700;">
                        ‚ö†Ô∏è Exceeds available milk!
                    </div>
                </div>

                <!-- Production Preview -->
                <div id="prodPreview" style="background:#fef3c7; padding:16px; border-radius:8px; border:2px solid #f59e0b; display:none;">
                    <div style="font-size:12px; font-weight:700; color:#92400e; margin-bottom:8px;">üìã Production Preview:</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div>
                            <div style="font-size:11px; color:#78350f;">Milk Input:</div>
                            <div style="font-size:16px; font-weight:900; color:#92400e;"><span id="previewProdMilk">0</span> L</div>
                        </div>
                        <div>
                            <div style="font-size:11px; color:#78350f;">Product Output:</div>
                            <div style="font-size:16px; font-weight:900; color:#92400e;"><span id="previewProdOutput">0</span> kg</div>
                        </div>
                    </div>
                    <div style="margin-top:8px; padding-top:8px; border-top:2px dashed #f59e0b; font-size:11px; color:#92400e; font-weight:700;">
                        üí° Efficiency: <span id="previewEfficiency">100</span>%
                    </div>
                </div>

                <!-- Product Quantity with Override -->
                <div>
                    <div id="prodCalculatedQty" style="background:#f0fdf4; padding:12px; border-radius:8px; border:2px solid #16a34a;">
                        <div style="font-size:11px; font-weight:700; color:#166534; margin-bottom:4px;">‚úÖ Product Output (Auto-calculated):</div>
                        <div style="font-size:18px; color:#15803d; font-weight:900;">
                            <span id="prodProductQty">0</span> kg
                        </div>
                        <div style="font-size:10px; color:#166534; margin-top:4px;">üí° Based on conversion ratio</div>
                    </div>
                    
                    <!-- Override section - hidden by default -->
                    <div id="prodOverrideSection" style="display:none; margin-top:12px; background:#fef3c7; padding:12px; border-radius:8px; border:2px solid #f59e0b;">
                        <label style="font-size:10px; color:#92400e; font-weight:700; display:block; margin-bottom:6px;">üìù Override Actual Product Quantity (kg)</label>
                        <input type="number" id="prodActualQty" placeholder="Enter actual quantity" style="width:100%; padding:10px; border-radius:6px; border:2px solid #f59e0b; font-weight:700; font-size:14px;" oninput="updateProdActual()" />
                        <div style="font-size:10px; color:#92400e; margin-top:4px;">üí° Enter actual yield you get practically</div>
                    </div>
                    
                    <button type="button" onclick="toggleProdOverride()" style="margin-top:12px; width:100%; padding:10px; background:#fef3c7; color:#92400e; border:1px solid #f59e0b; border-radius:6px; font-weight:700; font-size:11px; cursor:pointer;">üìù Edit Actual Yield (Override)</button>
                </div>

                <!-- Notes -->
                <div>
                    <label style="font-size:10px; color:#64748b; font-weight:700;">Notes (optional)</label>
                    <textarea id="prodNotes" rows="2" placeholder="Any observations..." style="width:100%; padding:8px; border-radius:6px; border:1px solid #e2e8f0; font-size:12px; resize:none;"></textarea>
                </div>

                <!-- Actions -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <button type="button" onclick="closeModal('convertModal')" style="padding:14px; background:#f1f5f9; border:none; border-radius:8px; font-weight:700; cursor:pointer; color:#64748b; font-size:14px;">Cancel</button>
                    <button type="button" id="createBatchBtn" onclick="confirmProduction()" style="padding:14px; background:linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); border:none; border-radius:8px; font-weight:700; cursor:pointer; color:white; font-size:14px;" disabled>‚úÖ Create Batch</button>
                </div>
                <div id="createBatchDisabled" style="display:none; padding:12px; background:#fef3c7; border:2px solid #f59e0b; border-radius:8px; text-align:center; font-size:11px; color:#92400e; font-weight:700;">
                    ‚ö†Ô∏è Add milk collection first to enable production
                </div>

                <div style="font-size:10px; color:#64748b; text-align:center;">
                    üí° Common ratios: Paneer (5L‚Üí1kg), Ghee (25L‚Üí1kg), Curd (1L‚Üí1kg)
                </div>
                
                <!-- Recent Batches -->
                <div id="recentBatches" style="margin-top:16px; padding-top:16px; border-top:2px dashed #e2e8f0;">
                    <div style="font-size:11px; font-weight:700; color:#475569; margin-bottom:8px;">üìú Recent Batches (Today)</div>
                    <div id="recentBatchesList" style="max-height:150px; overflow-y:auto;">
                        <div style="text-align:center; color:#94a3b8; padding:12px; font-size:12px;">No batches created today</div>
                    </div>
                </div>
                
                <!-- 5 Ledgers Display -->
                <div style="margin-top:16px; padding-top:16px; border-top:2px dashed #e2e8f0;">
                    <div style="font-size:11px; font-weight:700; color:#475569; margin-bottom:8px;">üìä 5 Ledgers (Live)</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <button type="button" onclick="showLedger('milk')" style="padding:10px; background:#eff6ff; border:2px solid #3b82f6; border-radius:6px; font-weight:700; color:#1e3a8a; cursor:pointer; font-size:11px;">ü•õ Milk Ledger</button>
                        <button type="button" onclick="showLedger('production')" style="padding:10px; background:#f3e8ff; border:2px solid #c084fc; border-radius:6px; font-weight:700; color:#7e22ce; cursor:pointer; font-size:11px;">üè≠ Production Ledger</button>
                        <button type="button" onclick="showLedger('inventory')" style="padding:10px; background:#f0fdf4; border:2px solid #16a34a; border-radius:6px; font-weight:700; color:#15803d; cursor:pointer; font-size:11px;">üì¶ Inventory Ledger</button>
                        <button type="button" onclick="showLedger('sales')" style="padding:10px; background:#fef3c7; border:2px solid #f59e0b; border-radius:6px; font-weight:700; color:#92400e; cursor:pointer; font-size:11px;">üí∞ Sales Ledger</button>
                        <button type="button" onclick="showLedger('cash')" style="padding:10px; background:#fee2e2; border:2px solid #dc2626; border-radius:6px; font-weight:700; color:#991b1b; cursor:pointer; font-size:11px;">üíµ Cash/Credit Ledger</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="overlay" id="addProductModal">
        <div class="modal" style="width:90vw !important; max-width:450px !important; height:auto !important; max-height:90vh !important; overflow-y:auto !important; display:block !important; grid-template-rows:none !important;">
            <div class="panelHeader"><span>üì¶ Add New Product</span> <button onclick="closeModal('addProductModal')" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center;">‚úñ</button></div>
            <form onsubmit="event.preventDefault(); addNewProductFromModal();" style="padding:20px; display:flex; flex-direction:column; gap:15px;">
                <input type="text" id="pName" placeholder="Product Name (e.g., Curd 500g)" onkeydown="handleProductFieldEnter(event)" oninput="updateEmojiLink(this.value)" style="width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:700; font-size: 14px; box-sizing:border-box;" required />
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                  <input type="number" id="pPrice" placeholder="Price (‚Çπ)" step="0.01" min="0" onkeydown="handleProductFieldEnter(event)" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:700; font-size: 14px; box-sizing:border-box;" required />
                  <input type="text" id="pUnit" placeholder="Unit (L/kg/g)" list="dairyUnitSuggestions" value="unit" onchange="suggestQuantitiesForUnit()" onkeydown="handleProductFieldEnter(event)" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:700; font-size: 14px; box-sizing:border-box;" />
                <datalist id="dairyUnitSuggestions">
                  <option value="L"><option value="ml"><option value="kg"><option value="g"><option value="pcs"><option value="box"><option value="packet"><option value="bottle">
                </datalist>
              </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="text" id="pEmoji" placeholder="Emoji (ü•õ, üßÄ)" value="üì¶" onkeydown="handleProductFieldEnter(event)" style="flex: 1; padding: 12px; border-radius: 10px; border: 2px solid #3b82f6; font-weight: 700; font-size: 14px; box-sizing: border-box;" />
                  <button type="button" onclick="openEmojiPicker()" style="padding: 12px 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #3b82f6; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 18px; transition: all 0.2s;" title="Choose Emoji">üé≠</button>
                </div>
                <div style="font-size: 10px; color: #64748b; margin-top: 4px;">üí° Click üé≠ to browse dairy emojis or type to search</div>

                <!-- Quantity per Click Section -->
                <div style="background:#f8fafc; padding:16px; border-radius:10px; border:1px solid var(--line);">
                  <div style="font-size:12px; font-weight:700; color:var(--muted); margin-bottom:12px; display:flex; align-items:center; gap:6px;">
                    <span>‚ö°</span> Quantity per Click (default: 1, 2, 5)
                  </div>
                  <div style="font-size:9px; color:#64748b; margin-bottom:8px; padding:6px; background:#eff6ff; border-radius:6px; border-left:3px solid #3b82f6;">
                    üí° <strong>Tip:</strong> For g/ml use 100, 250, 500 | For L/kg use 0.5, 1, 2 | Decimals like 0.25, 0.5 are also fine!
                  </div>
                  <div id="qtyInputsContainer" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
                    <div style="display:flex; flex-direction:column; gap:4px;">
                      <label style="font-size:10px; font-weight:700; color:var(--muted); text-align:center;">Qty 1</label>
                      <input type="number" class="pQty" value="1" step="any" style="padding:8px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-align:center; width:100%; box-sizing:border-box;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                      <label style="font-size:10px; font-weight:700; color:var(--muted); text-align:center;">Qty 2</label>
                      <input type="number" class="pQty" value="2" step="any" style="padding:8px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-align:center; width:100%; box-sizing:border-box;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                      <label style="font-size:10px; font-weight:700; color:var(--muted); text-align:center;">Qty 3</label>
                      <input type="number" class="pQty" value="5" step="any" style="padding:8px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-align:center; width:100%; box-sizing:border-box;" />
                    </div>
                  </div>
                  <button type="button" onclick="addQtyInput()" id="addQtyBtn" style="margin-top:10px; padding:8px; background:#eff6ff; color:#3b82f6; border:1px dashed #3b82f6; border-radius:6px; font-weight:700; font-size:12px; cursor:pointer; width:100%;">‚ûï Add Quantity (max 5)</button>
                  <div style="font-size:10px; color:var(--muted); margin-top:10px; text-align:center;">üí° Set to 0 to disable. Edit more in Edit Products.</div>
                </div>

                <button type="submit" class="add-btn" style="width:100%; background:var(--green);">‚úÖ Create Product</button>
            </form>
            <!-- Fixed Bottom Actions -->
            <div style="position: sticky; bottom: 0; background: white; border-top: 2px solid #e2e8f0; padding: 12px 20px; display: flex; gap: 8px;">
              <button type="button" onclick="closeModal('addProductModal')" style="flex: 1; padding: 12px; background: #f1f5f9; color: #64748b; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px;">‚ùå Cancel</button>
              <button type="submit" form="addProductForm" style="flex: 2; padding: 12px; background: #16a34a; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px;">‚úÖ Create Product</button>
            </div>
        </div>
    </div>

    <!-- Emoji Picker Modal -->
    <div class="overlay" id="emojiPickerModal">
        <div class="modal" style="width: 90vw !important; max-width: 600px !important; height: auto !important; max-height: 80vh !important; overflow-y: auto !important;">
            <div class="panelHeader">
                <span>üé≠ Choose Dairy Emoji</span>
                <button onclick="closeModal('emojiPickerModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">‚úñ</button>
            </div>
            
            <!-- Search Bar -->
            <div style="padding: 16px; border-bottom: 2px solid #e2e8f0;">
                <input type="text" id="emojiSearchInput" placeholder="üîç Search emojis (milk, paneer, tea, coffee...)" oninput="filterEmojis()" style="width: 100%; padding: 12px; border: 2px solid #3b82f6; border-radius: 10px; font-weight: 700; font-size: 14px; box-sizing: border-box;" />
            </div>
            
            <!-- Emoji Grid -->
            <div id="emojiGrid" style="padding: 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; max-height: 50vh; overflow-y: auto;">
                <!-- Emojis will be loaded here -->
            </div>
            
            <!-- Last Selected -->
            <div id="lastSelectedEmoji" style="padding: 12px 16px; background: #f0f9ff; border-top: 2px solid #3b82f6; display: none;">
                <div style="font-size: 11px; font-weight: 700; color: #1e40af; margin-bottom: 6px;">üìå Last Selected:</div>
                <button id="lastEmojiBtn" onclick="useLastEmoji()" style="font-size: 24px; padding: 8px 16px; background: white; border: 2px solid #3b82f6; border-radius: 8px; cursor: pointer;"></button>
            </div>
        </div>
    </div>

    <!-- Edit Products Modal -->
    <div class="overlay" id="editInventoryModal">
        <div class="modal" style="width:90vw !important; max-width:500px !important; height:auto !important; max-height:80vh !important; display:block !important; grid-template-rows:none !important;">
            <div class="panelHeader"><span>üìù Edit Products</span> <button onclick="closeModal('editInventoryModal')" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center;">‚úñ</button></div>
            <div class="modalBody" id="editInventoryList" style="padding:20px; display:flex; flex-direction:column; gap:12px; overflow-y:auto; max-height:60vh;"></div>
        </div>
    </div>

    <!-- Held Carts Modal -->
    <div class="overlay" id="heldCartsModal">
        <div class="modal" style="width:500px; height:auto;">
            <div class="panelHeader"><span>üìã Held Orders</span> <button onclick="closeModal('heldCartsModal')">‚úñ</button></div>
            <div class="modalBody" id="heldCartsList" style="padding:20px; display:flex; flex-direction:column; gap:10px;"></div>
        </div>
    </div>

    <!-- Customer Ledger Modal -->
    <div class="overlay" id="customerLedgerModal">
      <div class="modal" style="width:min(1100px, 95vw); height:min(80vh, 90vh); display:flex; flex-direction:column;">
        <div class="panelHeader" style="flex-shrink:0; padding:12px 16px;">
          <span>üìí Customer Ledger & Accounts</span>
          <button onclick="closeModal('customerLedgerModal')" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b;">‚úñ</button>
        </div>

        <!-- Filters & Summary -->
        <div style="padding:12px 16px; background:#f8fafc; border-bottom:2px solid #e2e8f0; flex-shrink:0;">
          <!-- Search & Filters -->
          <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
            <div>
              <label style="font-size:10px; font-weight:700; color:#64748b; display:block; margin-bottom:3px;">üîç Search Customer</label>
              <input id="ledgerSearch" type="text" placeholder="Name, Phone..." style="width:100%; padding:6px; border:2px solid #e2e8f0; border-radius:6px; font-size:12px;" oninput="filterCustomerLedger()" />
            </div>
            <div>
              <label style="font-size:10px; font-weight:700; color:#64748b; display:block; margin-bottom:3px;">üìä View Type</label>
              <select id="ledgerView" onchange="switchCustomerLedgerView()" style="width:100%; padding:6px; border:2px solid #e2e8f0; border-radius:6px; font-size:12px; font-weight:700;">
                <option value="all">üìã All Customers</option>
                <option value="advances">üí∞ Advance Given</option>
                <option value="credits">üìí Credit (Udhari)</option>
                <option value="today">üìÖ Today's Sales</option>
              </select>
            </div>
            <div>
              <label style="font-size:10px; font-weight:700; color:#64748b; display:block; margin-bottom:3px;">üìÖ From Date</label>
              <input id="ledgerFromDate" type="date" onchange="filterCustomerLedger()" style="width:100%; padding:6px; border:2px solid #e2e8f0; border-radius:6px; font-size:12px;" />
            </div>
            <div>
              <label style="font-size:10px; font-weight:700; color:#64748b; display:block; margin-bottom:3px;">üìÖ To Date</label>
              <input id="ledgerToDate" type="date" onchange="filterCustomerLedger()" style="width:100%; padding:6px; border:2px solid #e2e8f0; border-radius:6px; font-size:12px;" />
            </div>
          </div>

          <!-- Summary Cards -->
          <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:8px;">
            <div style="background:white; padding:8px; border-radius:6px; border:2px solid #e2e8f0;">
              <div style="font-size:9px; color:#64748b; font-weight:700;">ü§ù CUSTOMERS</div>
              <div style="font-size:16px; font-weight:900; color:#1e293b;" id="sumTotalCustomers">0</div>
            </div>
            <div style="background:#eff6ff; padding:8px; border-radius:6px; border:2px solid #3b82f6;">
              <div style="font-size:9px; color:#1e40af; font-weight:700;">üí∞ ADVANCE</div>
              <div style="font-size:16px; font-weight:900; color:#1e40af;" id="sumTotalAdvance">‚Çπ0</div>
            </div>
            <div style="background:#fef3c7; padding:8px; border-radius:6px; border:2px solid #f59e0b;">
              <div style="font-size:9px; color:#92400e; font-weight:700;">üìí CREDIT</div>
              <div style="font-size:16px; font-weight:900; color:#92400e;" id="sumTotalCredit">‚Çπ0</div>
            </div>
            <div style="background:#dcfce7; padding:8px; border-radius:6px; border:2px solid #16a34a;">
              <div style="font-size:9px; color:#166534; font-weight:700;">üíµ CASH</div>
              <div style="font-size:16px; font-weight:900; color:#166534;" id="sumCashCollected">‚Çπ0</div>
            </div>
            <div style="background:#f0f9ff; padding:8px; border-radius:6px; border:2px solid #0284c7;">
              <div style="font-size:9px; color:#0369a1; font-weight:700;">üìä TODAY</div>
              <div style="font-size:16px; font-weight:900; color:#0369a1;" id="sumTodaySales">‚Çπ0</div>
            </div>
          </div>
        </div>

        <!-- Content Area -->
        <div style="flex:1; overflow-y:auto; padding:12px;" id="customerLedgerContent">
          <!-- Content will be populated by JavaScript -->
        </div>

        <!-- Action Buttons -->
        <div style="padding:12px 16px; border-top:1px solid #e2e8f0; flex-shrink:0;">
          <!-- Quick Actions Grid -->
          <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-bottom:12px;">
            <button onclick="showShiftReconciliation()" style="padding:12px; background:#dc2626; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:11px;">üîÑ Close Shift</button>
            <button onclick="openFSSAIScreen()" style="padding:12px; background:#16a34a; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:11px;">‚úÖ FSSAI Report</button>
            <button onclick="showQRTraceability()" style="padding:12px; background:#7c3aed; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:11px;">üì± QR Traceability</button>
            <button onclick="showProductionReport()" style="padding:12px; background:#f59e0b; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:11px;">üè≠ Production</button>
          </div>
          
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <button onclick="exportCustomerLedgerExcel()" style="padding:10px; background:#16a34a; color:white; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:12px;">üìä Export Excel</button>
            <button onclick="printCustomerLedger()" style="padding:10px; background:#3b82f6; color:white; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:12px;">üñ®Ô∏è Print Report</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Unsaved Cart Warning Modal -->
    <div class="overlay" id="unsavedCartModal" style="background: rgba(0,0,0,0.75);">
        <div class="modal" style="width:450px; height:auto; border-radius: 22px; box-shadow: 0 24px 60px rgba(0,0,0,0.5);">
            <div class="panelHeader" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; justify-content: space-between;">
                <span style="font-weight: 900;">‚ö†Ô∏è Unsaved Order!</span>
                <button onclick="closeModal('unsavedCartModal')" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">‚úñ</button>
            </div>
            <div style="padding:30px; text-align:center;">
                <div style="font-size:60px; margin-bottom:15px;">üõí</div>
                <h3 style="margin:0 0 10px 0; color:#1e293b; font-size:20px;">You have unsaved items in cart!</h3>
                <p style="color:#64748b; font-size:14px; margin:0 0 25px 0;">Do you want to HOLD or SAVE before closing?</p>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <button onclick="holdAndClose()" style="padding:15px; background:#fde68a; color:#92400e; border:2px solid #f59e0b; border-radius:12px; font-weight:900; font-size:16px; cursor:pointer;">
                        üü° HOLD<br><span style="font-size:12px; font-weight:700;">Save for later</span>
                    </button>
                    <button onclick="saveAndClose()" style="padding:15px; background:#22c55e; color:white; border:2px solid #16a34a; border-radius:12px; font-weight:900; font-size:16px; cursor:pointer;">
                        üü¢ SAVE<br><span style="font-size:12px; font-weight:700;">Complete order</span>
                    </button>
                </div>
                
                <button onclick="closeAndDiscard()" style="margin-top:15px; padding:10px; background:#f1f5f9; color:#64748b; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">
                    ‚ùå Discard and Close
                </button>
            </div>
        </div>
    </div>

    <!-- Shop Settings Modal -->
    <div class="overlay" id="settingsModal">
        <div class="modal" style="width:500px; height:auto; max-height:90vh; overflow-y:auto;">
            <div class="panelHeader"><span>‚öôÔ∏è Shop Settings</span> <button onclick="closeModal('settingsModal')">‚úñ</button></div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:15px;">
                <!-- Basic Info Section -->
                <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0;">
                    <div style="font-size:13px; font-weight:700; color:#1e293b; margin-bottom:12px; text-transform:uppercase; letter-spacing:0.5px;">üè™ Basic Information</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                        <div>
                            <label style="font-size:11px; font-weight:700; color:#64748b; display:block; margin-bottom:5px;">Proprietor Name</label>
                            <input type="text" id="shopProprietorInput" placeholder="e.g., Ramesh Kumar" style="width:100%; padding:10px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px;" />
                        </div>
                        <div>
                            <label style="font-size:11px; font-weight:700; color:#64748b; display:block; margin-bottom:5px;">Shop Name *</label>
                            <input type="text" id="shopNameInput" placeholder="e.g., Gopal Dairy Shop" style="width:100%; padding:10px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px;" />
                        </div>
                    </div>
                    <div>
                        <label style="font-size:11px; font-weight:700; color:#64748b; display:block; margin-bottom:5px;">Shop Phone (for invoice & WhatsApp) *</label>
                        <input type="tel" id="shopPhoneInput" placeholder="e.g., 9876543210" style="width:100%; padding:10px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px;" inputmode="tel" />
                    </div>
                    <div>
                        <label style="font-size:11px; font-weight:700; color:#64748b; display:block; margin-bottom:5px;">üìß Email (for account & login)</label>
                        <input type="email" id="shopEmailInput" placeholder="e.g., shop@example.com" style="width:100%; padding:10px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px;" />
                    </div>
                </div>

                <!-- Address Section -->
                <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0;">
                    <div style="font-size:13px; font-weight:700; color:#1e293b; margin-bottom:12px; text-transform:uppercase; letter-spacing:0.5px;">üìç Shop Address</div>
                    <div>
                        <label style="font-size:11px; font-weight:700; color:#64748b; display:block; margin-bottom:5px;">Shop Address</label>
                        <textarea id="shopAddressInput" placeholder="e.g., Shop No. 5, Market Road, Village A" style="width:100%; padding:10px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; min-height:60px; resize:vertical;" /></textarea>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
                        <div>
                            <label style="font-size:11px; font-weight:700; color:#64748b; display:block; margin-bottom:5px;">City</label>
                            <input type="text" id="shopCityInput" placeholder="e.g., Pune" style="width:100%; padding:10px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px;" />
                        </div>
                        <div>
                            <label style="font-size:11px; font-weight:700; color:#64748b; display:block; margin-bottom:5px;">Pincode</label>
                            <input type="text" id="shopPincodeInput" placeholder="e.g., 411001" style="width:100%; padding:10px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px;" inputmode="numeric" />
                        </div>
                    </div>
                </div>

                <!-- Tax Info Section -->
                <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0;">
                    <div style="font-size:13px; font-weight:700; color:#1e293b; margin-bottom:12px; text-transform:uppercase; letter-spacing:0.5px;">üìÑ Tax Information (Optional)</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div>
                            <label style="font-size:11px; font-weight:700; color:#64748b; display:block; margin-bottom:5px;">GST Number</label>
                            <input type="text" id="shopGstInput" placeholder="e.g., 27ABCDE1234F1Z5" style="width:100%; padding:10px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-transform:uppercase;" />
                        </div>
                        <div>
                            <label style="font-size:11px; font-weight:700; color:#64748b; display:block; margin-bottom:5px;">PAN Number</label>
                            <input type="text" id="shopPanInput" placeholder="e.g., ABCDE1234F" style="width:100%; padding:10px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-transform:uppercase;" />
                        </div>
                    </div>
                </div>

                <!-- Shop Payment Details Section -->
                <div style="background:#eff6ff; padding:15px; border-radius:8px; border:2px solid #3b82f6;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="font-size:13px; font-weight:800; color:#1e40af; text-transform:uppercase; letter-spacing:0.5px;">üí≥ Shop Payment Details</div>
                        <button onclick="copyShopPaymentDetails()" style="padding:6px 12px; background:#3b82f6; color:white; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:11px;">üìã Copy All</button>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div style="grid-column:1/-1; position:relative;">
                            <label style="font-size:11px; font-weight:700; color:#64748b; display:block; margin-bottom:5px;">üì± Shop UPI ID / VPA</label>
                            <div style="display:flex; gap:6px;">
                                <input type="text" id="shopUpiInput" placeholder="e.g., 9876543210@paytm" style="flex:1; padding:10px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px;" />
                                <button onclick="copyToClipboard('shopUpiInput')" style="padding:8px 12px; background:#e2e8f0; border:none; border-radius:6px; cursor:pointer; font-size:14px;" title="Copy">üìã</button>
                            </div>
                        </div>
                        <div style="grid-column:1/-1; position:relative;">
                            <label style="font-size:11px; font-weight:700; color:#64748b; display:block; margin-bottom:5px;">üè¶ Shop Bank Name</label>
                            <div style="display:flex; gap:6px;">
                                <input type="text" id="shopBankInput" placeholder="e.g., State Bank of India" style="flex:1; padding:10px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px;" />
                                <button onclick="copyToClipboard('shopBankInput')" style="padding:8px 12px; background:#e2e8f0; border:none; border-radius:6px; cursor:pointer; font-size:14px;" title="Copy">üìã</button>
                            </div>
                        </div>
                        <div style="position:relative;">
                            <label style="font-size:11px; font-weight:700; color:#64748b; display:block; margin-bottom:5px;">üî¢ Account Number</label>
                            <div style="display:flex; gap:6px;">
                                <input type="text" id="shopAccountInput" placeholder="Account number" style="flex:1; padding:10px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px;" />
                                <button onclick="copyToClipboard('shopAccountInput')" style="padding:8px 12px; background:#e2e8f0; border:none; border-radius:6px; cursor:pointer; font-size:14px;" title="Copy">üìã</button>
                            </div>
                        </div>
                        <div style="position:relative;">
                            <label style="font-size:11px; font-weight:700; color:#64748b; display:block; margin-bottom:5px;">üîë IFSC Code</label>
                            <div style="display:flex; gap:6px;">
                                <input type="text" id="shopIfscInput" placeholder="e.g., SBIN0001234" style="flex:1; padding:10px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-transform:uppercase;" />
                                <button onclick="copyToClipboard('shopIfscInput')" style="padding:8px 12px; background:#e2e8f0; border:none; border-radius:6px; cursor:pointer; font-size:14px;" title="Copy">üìã</button>
                            </div>
                        </div>
                        <div style="grid-column:1/-1; position:relative;">
                            <label style="font-size:11px; font-weight:700; color:#64748b; display:block; margin-bottom:5px;">üë§ Account Holder Name</label>
                            <div style="display:flex; gap:6px;">
                                <input type="text" id="shopAccountNameInput" placeholder="Name as per bank" style="flex:1; padding:10px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px;" />
                                <button onclick="copyToClipboard('shopAccountNameInput')" style="padding:8px 12px; background:#e2e8f0; border:none; border-radius:6px; cursor:pointer; font-size:14px;" title="Copy">üìã</button>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:12px; padding:10px; background:#dbeafe; border-radius:6px; border-left:3px solid #3b82f6;">
                        <p style="font-size:11px; color:#1e40af; margin:0; line-height:1.5;">üí° These payment details appear on all invoices and WhatsApp messages</p>
                    </div>
                </div>

                <div style="background:#f0f9ff; padding:12px; border-radius:8px; border:1px solid #3b82f6;">
                    <p style="font-size:11px; color:#1e40af; margin:0; line-height:1.5;">üí° <strong>Tip:</strong> Shop name and phone appear on invoices and WhatsApp messages. GST/PAN will be shown on tax invoices.</p>
                </div>

                <button onclick="saveShopSettings()" style="padding:15px; background:var(--green); color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:14px;">üíæ Save Settings</button>
            </div>
            <!-- Fixed Bottom Actions -->
            <div style="position: sticky; bottom: 0; background: white; border-top: 2px solid #e2e8f0; padding: 12px 20px; display: flex; gap: 8px;">
              <button type="button" onclick="closeModal('settingsModal')" style="flex: 1; padding: 12px; background: #f1f5f9; color: #64748b; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px;">‚ùå Cancel</button>
              <button type="button" onclick="saveShopSettings()" style="flex: 2; padding: 12px; background: #16a34a; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px;">üíæ Save Settings</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Welcome/Onboarding Modal -->
    <div class="welcome-modal" id="welcomeModal">
      <div class="welcome-content">
        <div style="font-size: 64px; margin-bottom: 20px;">üéâ</div>
        <h2 style="font-size: 28px; font-weight: 900; color: #1e293b; margin-bottom: 10px;">Welcome to MilkRecord POS!</h2>
        <p style="font-size: 16px; color: #64748b; margin-bottom: 20px; line-height: 1.6;">Let's get your dairy shop set up in 3 easy steps</p>
        
        <div style="text-align: left; background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <div id="step1" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; margin-bottom: 10px; border: 2px solid #e2e8f0;">
            <span style="font-size: 24px;">1Ô∏è‚É£</span>
            <div>
              <div style="font-weight: 700; color: #1e293b;">Add Your First Product</div>
              <div style="font-size: 12px; color: #64748b;">Click "‚ûï Create" to add products</div>
            </div>
          </div>
          <div id="step2" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; margin-bottom: 10px; border: 2px solid #e2e8f0;">
            <span style="font-size: 24px;">2Ô∏è‚É£</span>
            <div>
              <div style="font-weight: 700; color: #1e293b;">Add Your First Customer</div>
              <div style="font-size: 12px; color: #64748b;">Click "‚ûï Add" to add customers</div>
            </div>
          </div>
          <div id="step3" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
            <span style="font-size: 24px;">3Ô∏è‚É£</span>
            <div>
              <div style="font-weight: 700; color: #1e293b;">Create Your First Invoice</div>
              <div style="font-size: 12px; color: #64748b;">Select customer, add products, and save</div>
            </div>
          </div>
        </div>
        
        <button onclick="closeWelcomeModal()" style="padding: 15px 30px; background: #3b82f6; color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; width: 100%;">
          üöÄ Let's Get Started!
        </button>
      </div>
    </div>

    <!-- Institutional Gaps Panel -->
    <button class="gaps-toggle" onclick="toggleGaps()" title="Institutional Records">üìã</button>
    <div class="gaps-panel" id="gapsPanel">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;"><h3 style="margin: 0; font-size: 16px; color: #1e293b;">Institutional Records (Not Tracked)</h3><button onclick="toggleGaps()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #64748b; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;" title="Close">‚úñ</button></div>
      
      <div class="gap-item">
        <h4>üü° Farmer source</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
      
      <div class="gap-item">
        <h4>üü° Quality test (Fat/SNF)</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
      
      <div class="gap-item">
        <h4>üü° Payment settlement</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
      
      <div class="gap-item">
        <h4>üü° Deductions / loans</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
      
      <div class="gap-item">
        <h4>üü° Equipment logs</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
    </div>

    <!-- Enterprise-Grade JavaScript Modules -->
    <script src="../js/safe-execution.js"></script>
    <script src="../js/storage-adapter.js"></script>
    <script src="../js/sync-engine.js"></script>

    <!-- Backend API Calls -->
    <script>
      console.log('üöÄ POS Backend: Using Supabase APIs');
      console.log('üõ°Ô∏è Safe Execution: Enabled');
      console.log('üíæ Hybrid Storage: Enabled');
      console.log('üîÑ Background Sync: Enabled');
    </script>
    <script>
      // Check if backend is configured
      let useBackend = false;
      let currentShopId = null;
      let currentUserId = null;
      let authToken = null;
      
      // Initialize Supabase
      window.addEventListener('DOMContentLoaded', async () => {
        // Update profile name with shop/booth name
        const shopName = localStorage.getItem('MilkRecord_shop_name') || localStorage.getItem('MilkRecord_booth') || 'Gopal Dairy';
        const profileName = document.getElementById('profileName');
        if (profileName) {
          profileName.textContent = shopName;
        }
        
        if (window.MilkRecordConfig && window.MilkRecordConfig.isConfigured()) {
          useBackend = true;
          console.log('‚úÖ Backend connected');

          // Check if user is logged in
          const session = localStorage.getItem('MilkRecord_session');
          if (session) {
            const sessionData = JSON.parse(session);
            currentShopId = sessionData.shop_id;
            currentUserId = sessionData.user_id;
            authToken = sessionData.token;

            // Load customers from backend
            await loadCustomersFromBackend();

            // Load sales history from backend
            await loadSalesFromBackend();
            
            // Update profile name from session
            document.getElementById('profileName').textContent = sessionData.shop_name || shopName;
          }
        } else {
          console.log('‚ö†Ô∏è Using offline mode (localStorage)');
        }
        
        // Initialize onboarding for first-time users
        initializeOnboarding();
      });

      // ========== ONBOARDING SYSTEM ==========
      let onboardingActive = false;
      let currentOnboardingStep = 0;

      // Check if this is first visit and initialize onboarding
      function initializeOnboarding() {
        const hasProducts = loadData('mr_pos_custom_products', []).length > 0;
        const hasCustomers = loadData('mr_pos_customers', []).length > 0;
        const hasHistory = loadData('mr_sales_history', []).length > 0;
        const hasSeenWelcome = localStorage.getItem('MilkRecord_welcome_seen');
        
        // Show welcome modal on first visit
        if (!hasSeenWelcome) {
          showWelcomeModal();
          localStorage.setItem('MilkRecord_welcome_seen', 'true');
        }
        
        // Start onboarding guidance
        if (!hasProducts || !hasCustomers || !hasHistory) {
          onboardingActive = true;
          startOnboarding();
        }
      }

      // Show welcome modal
      function showWelcomeModal() {
        const modal = document.getElementById('welcomeModal');
        if (modal) {
          modal.classList.add('active');
        }
      }

      // Close welcome modal
      function closeWelcomeModal() {
        const modal = document.getElementById('welcomeModal');
        if (modal) {
          modal.classList.remove('active');
        }
        startOnboarding();
      }

      // Start onboarding guidance
      function startOnboarding() {
        const hasProducts = loadData('mr_pos_custom_products', []).length > 0;
        const hasCustomers = loadData('mr_pos_customers', []).length > 0;
        const hasHistory = loadData('mr_sales_history', []).length > 0;
        
        // Update step indicators
        updateStepIndicator('step1', hasProducts);
        updateStepIndicator('step2', hasCustomers);
        updateStepIndicator('step3', hasHistory);
        
        // Highlight appropriate fields
        if (!hasProducts) {
          highlightElement('productSearch', 'Search for products or click ‚ûï Create');
          highlightElement('addProductModal', 'Click here to add your first product', true);
        } else if (!hasCustomers) {
          highlightElement('custSearch', 'Search for customers or click ‚ûï Add');
          highlightElement('addCustModal', 'Click here to add your first customer', true);
        } else if (!hasHistory) {
          highlightElement('totalPayableDisplay', 'Add products to cart and click LIKH LO or CASH');
          highlightElement('btnCredit', 'Click to create first invoice', true);
        } else {
          onboardingActive = false;
          clearAllHighlights();
        }
      }

      // Update step indicator style
      function updateStepIndicator(stepId, completed) {
        const step = document.getElementById(stepId);
        if (step) {
          if (completed) {
            step.style.background = '#f0fdf4';
            step.style.borderColor = '#22c55e';
            step.innerHTML = '<span style="font-size: 24px;">‚úÖ</span><div><div style="font-weight: 700; color: #16a34a;">Completed!</div></div>';
          }
        }
      }

      // Highlight element with tooltip
      function highlightElement(elementId, tooltipText, isModal = false) {
        clearAllHighlights();
        
        let element;
        if (isModal) {
          element = document.getElementById(elementId);
        } else {
          element = document.getElementById(elementId);
        }
        
        if (element) {
          element.classList.add('onboarding-highlight');
          
          // Add tooltip
          const tooltip = document.createElement('div');
          tooltip.className = 'onboarding-tooltip';
          tooltip.textContent = tooltipText;
          tooltip.style.top = '-40px';
          tooltip.style.left = '50%';
          tooltip.style.transform = 'translateX(-50%)';
          element.style.position = 'relative';
          element.appendChild(tooltip);
        }
      }

      // Clear all highlights
      function clearAllHighlights() {
        document.querySelectorAll('.onboarding-highlight').forEach(el => {
          el.classList.remove('onboarding-highlight');
          const tooltip = el.querySelector('.onboarding-tooltip');
          if (tooltip) tooltip.remove();
        });
      }

      // Check onboarding progress after actions
      function checkOnboardingProgress() {
        if (onboardingActive) {
          setTimeout(() => startOnboarding(), 500);
        }
      }
      
      // Warn before close/refresh if cart has items
      window.addEventListener('beforeunload', (e) => {
        if (cart.length > 0) {
          // Show our custom modal instead of browser default
          e.preventDefault();
          e.returnValue = '';
          
          // Open the unsaved cart modal
          const modal = document.getElementById('unsavedCartModal');
          if (modal) {
            modal.style.display = 'flex';
          }
          
          return '';
        }
      });
      
      // Hold and close
      function holdAndClose() {
        if (cart.length > 0) {
          holdCart();
          closeModal('unsavedCartModal');
          showToast('Order held! You can now close safely ‚úÖ');
        }
      }
      
      // Save and close
      function saveAndClose() {
        if (cart.length > 0) {
          saveEntry('Quick');
          closeModal('unsavedCartModal');
          showToast('Order saved! You can now close ‚úÖ');
        }
      }
      
      // Close and discard
      function closeAndDiscard() {
        cart = [];
        updateUI();
        closeModal('unsavedCartModal');
        showToast('Order discarded');
      }
      
      // Show hold/save popup on page hide (tab close, refresh, navigation)
      window.addEventListener('visibilitychange', async () => {
        if (document.visibilityState === 'hidden' && cart.length > 0) {
          // Auto-hold the cart
          const customerName = el("activeCust").innerText;
          const holdId = Date.now();
          
          heldCarts.push({
            id: holdId,
            customer: customerName,
            cart: [...cart],
            total: total,
            timestamp: new Date().toISOString()
          });
          
          localStorage.setItem('mr_held_carts', JSON.stringify(heldCarts));
          console.log('üü° Auto-held cart for', customerName);
        }
      });
      
      // Load customers from backend
      async function loadCustomersFromBackend() {
        if (!useBackend || !currentShopId) return;

        try {
          // In real implementation, fetch from API
          // const response = await fetch('/api/customers', {
          //   headers: { 'Authorization': `Bearer ${authToken}` }
          // });
          // const { customers } = await response.json();
          // customers.forEach(c => {
          //   if (!customersData.find(existing => existing.name === c.name)) {
          //     customersData.push(c);
          //   }
          // });
          console.log('Loaded customers from backend');
        } catch (error) {
          console.error('Failed to load customers:', error);
        }
      }
      
      // Load sales from backend
      async function loadSalesFromBackend() {
        if (!useBackend || !currentShopId) return;

        try {
          // In real implementation, fetch from API
          console.log('Loaded sales from backend');
        } catch (error) {
          console.error('Failed to load sales:', error);
        }
      }

      // Stub function for onboarding (not implemented)
      window.checkOnboardingProgress = window.checkOnboardingProgress || function() {
        // Stub - onboarding not implemented yet
        return { success: true, level: 'basic' };
      };

      // Save sale to backend with 3-tier sync
      async function saveSaleToBackend(saleData) {
        console.log('üî¥ LEVEL 2: Saving Invoice (Transaction Sync)');
        console.log('üìä Sale Data:', saleData);

        // ALWAYS save locally first (works offline)
        try {
          const history = safeArray(loadData('mr_sales_history', []));
          const saleRecord = {
            id: saleData.id || `sale_${Date.now()}`,
            customer_name: saleData.customer || 'Walking Customer',
            customer_phone: saleData.phone || '',
            items: safeArray(saleData.items),
            total_amount: saleData.total || 0,
            paid_amount: saleData.paid || 0,
            payment_mode: saleData.paymentMode || 'cash',
            sale_date: new Date().toISOString(),
            created_at: new Date().toISOString()
          };
          history.push(saleRecord);
          saveData('mr_sales_history', history);
          console.log('‚úÖ Invoice saved locally (instant)');

          // Queue for sync with HIGH priority (but don't block UI)
          if (window.syncEngine) {
            const result = await window.syncEngine.queue('save_sale', saleRecord, 'high');
            console.log('üìù Invoice sync status:', result);
            
            if (result.type === 'local_only') {
              console.log('üîµ Trial Mode: Will sync after shop registration');
            }
          }

          return { success: true, type: 'local+queued' };
        } catch (error) {
          console.error('‚ùå Error saving invoice:', error);
          return { success: false, error: error.message };
        }
      }

      // ============================================
      // HYBRID SYNC SYSTEM (API + LocalStorage)
      // Works like enterprise POS (McDonald's, Starbucks)
      // ============================================

      // Sync queue for offline operations
      let syncQueue = [];
      let isSyncing = false;
      const SYNC_INTERVAL = 30000; // Sync every 30 seconds when online

      // Add operation to sync queue
      function addToSyncQueue(operation, data) {
        syncQueue.push({
          id: Date.now() + Math.random(),
          operation: operation,
          data: data,
          timestamp: Date.now(),
          synced: false
        });
        console.log('üìù Added to sync queue:', operation, syncQueue.length, 'items');
        processSyncQueue();
      }

      // Process sync queue
      async function processSyncQueue() {
        if (isSyncing || syncQueue.length === 0) return;
        
        // Check if online
        if (!navigator.onLine) {
          console.log('‚ö†Ô∏è Offline - sync queued');
          return;
        }
        
        isSyncing = true;
        
        try {
          const unsynced = syncQueue.filter(item => !item.synced);
          
          for (const item of unsynced) {
            try {
              await syncToAPI(item.operation, item.data);
              item.synced = true;
              console.log('‚úÖ Synced:', item.operation, item.id);
            } catch (error) {
              console.warn('‚ö†Ô∏è Sync failed:', item.operation, error);
            }
          }
          
          // Clean old synced items (keep last 100)
          if (syncQueue.length > 100) {
            syncQueue = syncQueue.slice(-100);
          }
        } finally {
          isSyncing = false;
        }
      }

      // Sync to API
      async function syncToAPI(operation, data) {
        const endpoints = {
          'save_product': '/api/products',
          'save_customer': '/api/customers',
          'save_sale': '/api/sales',
          'save_shop_settings': '/api/shop-settings'
        };
        
        const endpoint = endpoints[operation];
        if (!endpoint) throw new Error('Unknown operation: ' + operation);
        
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (!result.success) throw new Error(result.error || 'Sync failed');
        
        return result;
      }

      // Auto-sync periodically
      setInterval(() => {
        if (navigator.onLine && syncQueue.length > 0) {
          console.log('üîÑ Auto-syncing queue...');
          processSyncQueue();
        }
      }, SYNC_INTERVAL);

      // Listen for online/offline events
      window.addEventListener('online', () => {
        console.log('‚úÖ Online - processing sync queue');
        processSyncQueue();
      });

      window.addEventListener('offline', () => {
        console.log('‚ö†Ô∏è Offline - queuing operations');
      });

      // Initialize hybrid sync on page load
      async function initializeHybridSync() {
        console.log('üöÄ Initializing hybrid sync system...');
        
        // Process any pending sync queue
        await processSyncQueue();
        
        console.log('‚úÖ Hybrid sync initialized');
      }

      // Run initialization
      initializeHybridSync();
    </script>
    <script>
      const el = (id) => document.getElementById(id);
      let cart = [], total = 0, exportHistory = [], currentLang = 'en';
      let heldCarts = JSON.parse(localStorage.getItem('mr_held_carts') || '[]');
      let lastRate = parseFloat(localStorage.getItem('mr_last_rate') || '64');
      
      // ============================================
      // ROBUST DATA PERSISTENCE WITH AUDIT TRAIL
      // ============================================
      
      // Generate unique session ID
      const SESSION_ID = Date.now().toString(36) + Math.random().toString(36).substr(2);
      
      // Create data signature (simple hash for integrity check)
      function createSignature(data) {
        return btoa(unescape(encodeURIComponent(JSON.stringify(data)))).substr(0, 16);
      }
      
      // Save data with audit trail AND VALIDATION
      function saveData(key, data, action = 'update') {
        try {
          // CRITICAL: Validate array data before saving
          if (key.includes('cart') || key.includes('customers') || 
              key.includes('history') || key.includes('products') || 
              key.includes('order')) {
            if (!Array.isArray(data)) {
              console.error('‚ùå BLOCKED: Attempted to save non-array to', key);
              data = []; // Force to empty array
            }
          }
          
          const timestamp = new Date().toISOString();
          const signature = createSignature(data);

          // Save main data
          const wrappedData = {
            data: data,
            signature: signature,
            timestamp: timestamp,
            sessionId: SESSION_ID
          };
          localStorage.setItem(key, JSON.stringify(wrappedData));

          // Add to audit trail
          addToAuditTrail(key, action, signature);

          // Create TRIPLE backup for critical data
          if (key.includes('products') || key.includes('customers')) {
            try {
              const dataStr = JSON.stringify(wrappedData);
              localStorage.setItem(key + '_backup', dataStr);
              localStorage.setItem(key + '_backup2', dataStr);
            } catch(e) {
              console.error('‚ùå Backup failed:', e);
            }
          }

          console.log(`üíæ [${timestamp}] Saved ${key} (${action})`);
          return true;
        } catch (error) {
          console.error('‚ùå Save failed:', error);
          return false;
        }
      }
      
      // Load data with signature verification AND RECOVERY
      function loadData(key, defaultValue = null) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return defaultValue;
          
          const parsed = JSON.parse(raw);
          
          // Check if this is NEW format (wrapped object) or OLD format (raw array)
          if (parsed && typeof parsed === 'object' && parsed.data !== undefined) {
            // NEW format: {data: [...], signature: '...', timestamp: '...'}
            const wrapped = parsed;
            
            // Verify signature
            const expectedSig = createSignature(wrapped.data);
            if (wrapped.signature !== expectedSig) {
              console.warn('‚ö†Ô∏è Data signature mismatch for', key, '- attempting recovery');
              return recoverData(key, defaultValue);
            }

            // FINAL VALIDATION: Ensure array data is actually an array
            if (key.includes('cart') || key.includes('customers') ||
                key.includes('history') || key.includes('products') ||
                key.includes('order')) {
              if (!Array.isArray(wrapped.data)) {
                console.error('‚ùå Loaded non-array for', key, '- using default');
                return Array.isArray(defaultValue) ? defaultValue : [];
              }
            }

            console.log(`‚úÖ [${wrapped.timestamp}] Loaded ${key}`);
            return wrapped.data;
          } else {
            // OLD format: raw array - use it but don't trust signature
            console.log(`‚ö†Ô∏è Loaded old format data for ${key}, will update on next save`);
            if (Array.isArray(parsed)) {
              return parsed;
            }
            return defaultValue;
          }
        } catch (error) {
          console.error('‚ùå Load failed:', error);
          return recoverData(key, defaultValue);
        }
      }
      
      // Recovery from backup WITH VALIDATION
      function recoverData(key, defaultValue) {
        // Try backup 1
        const backup1 = localStorage.getItem(key + '_backup');
        if (backup1) {
          try {
            const wrapped = JSON.parse(backup1);
            // Validate array data
            if ((key.includes('cart') || key.includes('customers') || 
                key.includes('history') || key.includes('products') || 
                key.includes('order')) && !Array.isArray(wrapped.data)) {
              console.warn('‚ö†Ô∏è Backup 1 corrupted for', key);
            } else {
              console.log('üîÑ Recovered from backup 1:', key);
              return wrapped.data;
            }
          } catch (e) {
            console.error('‚ùå Backup 1 parse failed:', key);
          }
        }
        
        // Try backup 2
        const backup2 = localStorage.getItem(key + '_backup2');
        if (backup2) {
          try {
            const wrapped = JSON.parse(backup2);
            // Validate array data
            if ((key.includes('cart') || key.includes('customers') || 
                key.includes('history') || key.includes('products') || 
                key.includes('order')) && !Array.isArray(wrapped.data)) {
              console.warn('‚ö†Ô∏è Backup 2 corrupted for', key);
            } else {
              console.log('üîÑ Recovered from backup 2:', key);
              return wrapped.data;
            }
          } catch (e) {
            console.error('‚ùå Backup 2 parse failed:', key);
          }
        }
        
        console.error('‚ùå All recovery attempts failed for', key);
        return Array.isArray(defaultValue) ? defaultValue : [];
      }
      
      // Create backup
      function createBackup(key, data) {
        localStorage.setItem(key + '_backup', JSON.stringify(data));
      }
      
      // Audit trail
      function addToAuditTrail(key, action, signature) {
        const trail = JSON.parse(localStorage.getItem('mr_audit_trail') || '[]');
        trail.push({
          timestamp: new Date().toISOString(),
          key: key,
          action: action,
          signature: signature,
          sessionId: SESSION_ID
        });
        // Keep last 1000 entries
        if (trail.length > 1000) trail.splice(0, trail.length - 1000);
        localStorage.setItem('mr_audit_trail', JSON.stringify(trail));
      }
      
      // Auto-save timer (every 5 seconds)
      let autoSaveTimer = null;
      function scheduleAutoSave() {
        if (autoSaveTimer) clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
          saveAllData();
        }, 5000);
      }

      // Save all data WITH VALIDATION - Safe execution
      function saveAllData() {
        try {
          // Validate before saving
          if (!Array.isArray(cart)) cart = [];
          if (!Array.isArray(customers)) customers = [];
          if (!Array.isArray(exportHistory)) exportHistory = [];

          // Get products safely - USE loadData()
          let products = loadData('mr_pos_custom_products', []);
          if (!Array.isArray(products)) products = [];

          // Get product order safely - USE loadData()
          let productOrder = loadData('mr_pos_product_order', []);
          if (!Array.isArray(productOrder)) productOrder = [];

          saveData('mr_pos_cart', cart, 'cart_update');
          saveData('mr_pos_customers', customers, 'customers_update');
          saveData('mr_pos_history', exportHistory, 'history_update');
          saveData('mr_pos_custom_products', products, 'products_update');
          saveData('mr_pos_product_order', productOrder, 'order_update');
          console.log('üíæ Auto-saved all data');

          // Check onboarding progress safely
          if (typeof checkOnboardingProgress === 'function') {
            safeExecute(checkOnboardingProgress);
          }
        } catch (error) {
          console.error('‚ùå saveAllData error:', error);
          // Don't throw - continue working
        }
      }

      // Save before unload (browser close/tab close)
      window.addEventListener('beforeunload', () => {
        safeExecute(saveAllData);
      });

      // Periodic backup (every 30 seconds) - Debounced
      const debouncedSaveAll = debounce(saveAllData, 1000);
      setInterval(() => {
        safeExecute(debouncedSaveAll);
      }, 30000);
      
      // Show data status indicator
      function showDataStatus() {
        const auditTrail = JSON.parse(localStorage.getItem('mr_audit_trail') || '[]');
        const lastEntry = auditTrail[auditTrail.length - 1];
        if (lastEntry) {
          const time = new Date(lastEntry.timestamp).toLocaleTimeString();
          console.log(`üõ°Ô∏è Data Status: ${auditTrail.length} audit entries | Last save: ${time}`);
        }
      }
      
      // Initialize data from robust storage
      customers = loadData('mr_pos_customers', [
        { name: "Rahul Sharma", lastOrder: "1.5L Cow Milk", rate: 64, qty: 1.5, type: "Retail", sub: 1.5 },
        { name: "Amit DCS", lastOrder: "1kg Paneer", rate: 320, qty: 1, type: "PACS", sub: 2 }
      ]);
      
      // Load sales history from localStorage
      exportHistory = loadData('mr_pos_history', []);
      console.log(`üìä Loaded ${exportHistory.length} sales from history`);

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }


      // Logic: 4am-4pm Morning, 4pm-4am Evening
      function updateShift() {
          const now = new Date();
          const hrs = now.getHours();
          const dateStr = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
          const shift = (hrs >= 4 && hrs < 16) ? (currentLang === 'en' ? 'Morning Shift' : '‡§∏‡•Å‡§¨‡§π ‡§ï‡•Ä ‡§™‡§æ‡§≤‡•Ä') : (currentLang === 'en' ? 'Evening Shift' : '‡§∂‡§æ‡§Æ ‡§ï‡•Ä ‡§™‡§æ‡§≤‡•Ä');
          // Date/shift display removed - hidden in header
          // el("todayLabel").textContent = `${dateStr} | ${shift}`;

          // Load shop name and user info from session
          loadUserInfo();
      }
      
      // Load user info from session
      function loadUserInfo() {
          const session = localStorage.getItem('MilkRecord_session');
          if (session) {
              try {
                  const sessionData = JSON.parse(session);
                  const shopTitle = el("shopTitle");
                  const todayLabel = el("todayLabel");
                  
                  if (shopTitle && sessionData.shop_name) {
                      shopTitle.textContent = sessionData.shop_name;
                  }
                  
                  if (todayLabel && sessionData.email) {
                      const dateStr = todayLabel.textContent.split('|')[0] || '';
                      todayLabel.textContent = `${dateStr} | üë§ ${sessionData.email}`;
                  }
              } catch (error) {
                  console.error('Error loading session:', error);
              }
          }
      }


      // Language toggle with English, Hindi, and Bhojpuri
      // currentLang already declared at line 1383
      const langData = {
          en: { shop:"MilkRecord POS", mem:"üß† Memory", hist:"üßæ History", exp:"üìä Export", term:"Terminal", sum:"Summary", payable:"TOTAL PAYABLE", cash:"CASH", credit:"LIKH LO (Credit)", hold:"üü° HOLD", done:"üü¢ DONE", clear:"üî¥ CLEAR", lang:"üåê English (EN)" },
          hi: { shop:"‡§Æ‡§ø‡§≤‡•ç‡§ï-‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° POS", mem:"üß† ‡§Ø‡§æ‡§¶‡•á‡§Ç", hist:"üßæ ‡§á‡§§‡§ø‡§π‡§æ‡§∏", exp:"üìä ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü", term:"‡§ü‡§∞‡•ç‡§Æ‡§ø‡§®‡§≤", sum:"‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂", payable:"‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø ‡§∞‡§æ‡§∂‡§ø", cash:"‡§®‡§ï‡§¶", credit:"‡§≤‡§ø‡§ñ ‡§≤‡•ã (‡§â‡§ß‡§æ‡§∞)", hold:"üü° ‡§π‡•ã‡§≤‡•ç‡§°", done:"üü¢ ‡§™‡•Ç‡§∞‡•ç‡§£", clear:"üî¥ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç", lang:"üåê ‡§π‡§ø‡§Ç‡§¶‡•Ä (HI)" },
          bho: { shop:"‡§Æ‡§ø‡§≤‡•ç‡§ï-‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° POS", mem:"üß† ‡§Ø‡§æ‡§¶", hist:"üßæ ‡§á‡§§‡§ø‡§π‡§æ‡§∏", exp:"üìä ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü", term:"‡§ü‡§∞‡•ç‡§Æ‡§ø‡§®‡§≤", sum:"‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂", payable:"‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø", cash:"‡§®‡§ó‡§¶‡•Ä", credit:"‡§≤‡§ø‡§ñ ‡§≤‡§â (‡§â‡§ß‡§æ‡§∞)", hold:"üü° ‡§π‡•ã‡§≤‡•ç‡§°", done:"üü¢ ‡§π‡•ã ‡§ó‡§á‡§≤", clear:"üî¥ ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•Ä", lang:"üåê ‡§≠‡•ã‡§ú‡§™‡•Å‡§∞‡•Ä (BHO)" }
      };

      function toggleLanguage() {
          // Cycle through: English ‚Üí Hindi ‚Üí Bhojpuri ‚Üí English
          if (currentLang === 'en') {
              currentLang = 'hi';
          } else if (currentLang === 'hi') {
              currentLang = 'bho';
          } else {
              currentLang = 'en';
          }

          // Update button text to show current language
          const langBtn = el("langToggleBtn");
          if (langBtn) {
            if (currentLang === 'en') {
              langBtn.textContent = 'üåê English (EN)';
            } else if (currentLang === 'hi') {
              langBtn.textContent = 'üåê ‡§π‡§ø‡§Ç‡§¶‡•Ä (HI)';
            } else {
              langBtn.textContent = 'üåê ‡§≠‡•ã‡§ú‡§™‡•Å‡§∞‡•Ä (BHO)';
            }
          }

          const t = langData[currentLang];

          // Safe element updates with null checks
          const shopTitle = el("shopTitle");
          if (shopTitle) shopTitle.textContent = t.shop;

          const btnMem = el("btnMem");
          if (btnMem) btnMem.innerHTML = t.mem;
          const btnHist = el("btnHist");
          if (btnHist) btnHist.innerHTML = t.hist;
          const btnExp = el("btnExp");
          if (btnExp) btnExp.innerHTML = t.exp;

          const lblTerm = el("lblTerm");
          if (lblTerm) lblTerm.textContent = t.term;
          const lblSum = el("lblSum");
          if (lblSum) lblSum.textContent = t.sum;
          const lblPayable = el("lblPayable");
          if (lblPayable) lblPayable.textContent = t.payable;

          const btnCash = el("btnCash");
          if (btnCash) btnCash.textContent = t.cash;
          const btnCredit = el("btnCredit");
          if (btnCredit) btnCredit.textContent = t.credit;

          const txtHold = el("txtHold");
          if (txtHold) txtHold.textContent = t.hold;
          const txtDone = el("txtDone");
          if (txtDone) txtDone.textContent = t.done;
          const txtClear = el("txtClear");
          if (txtClear) txtClear.textContent = t.clear;

          // Cards translation using data attributes
          document.querySelectorAll("[data-en]").forEach(i => {
            if (currentLang === 'en') {
              i.textContent = i.dataset.en;
            } else if (currentLang === 'hi') {
              i.textContent = i.dataset.hi;
            } else if (currentLang === 'bho') {
              i.textContent = i.dataset.bho || i.dataset.hi; // Fallback to Hindi if Bhojpuri not available
            }
          });
          
          updateShift();

          // Show language name in toast with native script
          let langName = '';
          if (currentLang === 'en') langName = 'üá¨üáß English (EN)';
          else if (currentLang === 'hi') langName = 'üáÆüá≥ ‡§π‡§ø‡§Ç‡§¶‡•Ä (HI)';
          else langName = 'üáÆüá≥ ‡§≠‡•ã‡§ú‡§™‡•Å‡§∞‡•Ä (BHO)';

          showToast(langName);
      }

      // Logout function
      async function logout() {
          if (confirm('Are you sure you want to logout?')) {
              // Get current session
              const sessionData = localStorage.getItem('MilkRecord_session');
              
              if (sessionData) {
                  try {
                      const session = JSON.parse(sessionData);
                      
                      // If we have a Supabase token, sign out properly
                      if (session.token && window.supabase) {
                          try {
                              await window.supabase.auth.signOut({
                                  scope: 'local' // Only sign out from this device
                              });
                              console.log('‚úÖ Supabase logout successful');
                          } catch (e) {
                              console.log('‚ö†Ô∏è Supabase logout error:', e.message);
                          }
                      }
                  } catch (e) {
                      console.log('‚ö†Ô∏è Session parse error:', e.message);
                  }
              }
              
              // Clear session
              localStorage.removeItem('MilkRecord_session');

              // Clear any other stored data if needed
              // localStorage.removeItem('MilkRecord_supabase_url');
              // localStorage.removeItem('MilkRecord_supabase_key');

              showToast('Logged out successfully!');

              // Redirect to login page
              setTimeout(() => {
                  window.location.href = '/login';
              }, 500);
          }
      }
      
      // Get progress emoji based on transaction count
      function getProgressEmoji(count) {
          if (count <= 2) return { emoji: 'üìö', name: 'Learning', color: '#3b82f6' };
          if (count <= 4) return { emoji: 'üòä', name: 'Happy', color: '#16a34a' };
          if (count <= 25) return { emoji: 'ü™ô', name: 'Prosperity', color: '#f59e0b' };
          return { emoji: '‚ö°', name: 'Power', color: '#dc2626' };
      }

      // Get current shift (morning/evening)
      function getCurrentShift() {
          const hour = new Date().getHours();
          return hour >= 4 && hour < 16 ? 'morning' : 'evening';
      }

      // Get shift color
      function getShiftColor() {
          return getCurrentShift() === 'morning' ? '#3b82f6' : '#7c3aed';
      }

      // Get today's transaction count
      function getTodayTransactionCount() {
          const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
          const today = new Date().toLocaleDateString();
          return history.filter(h => {
              const entryDate = new Date(h.createdAt || Date.now()).toLocaleDateString();
              return entryDate === today;
          }).length;
      }

      // Toggle profile dropdown
      async function toggleProfileDropdown() {
          const dropdown = document.getElementById('profileDropdown');
          dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';

          // Load shop name from API
          try {
            const response = await fetch('/api/shop-settings');
            const result = await response.json();
            if (result.success && result.settings && result.settings.shop_name) {
              const shopName = result.settings.shop_name;
              const profileName = document.getElementById('profileName');
              if (profileName) {
                profileName.textContent = shopName;
              }
              const dropdownShop = document.getElementById('dropdownShop');
              if (dropdownShop) {
                dropdownShop.textContent = shopName;
              }
              console.log('‚úÖ Shop name loaded from API:', shopName);
            }
          } catch (error) {
            console.warn('‚ö†Ô∏è Failed to load shop name:', error);
          }

          // Load user info and progress
          const session = localStorage.getItem('MilkRecord_session');
          if (session) {
              const data = JSON.parse(session);
              const txCount = getTodayTransactionCount();
              const progress = getProgressEmoji(txCount);
              const shiftColor = getShiftColor();

              document.getElementById('dropdownEmail').textContent = data.email || 'user@email.com';

              // Update dropdown header with progress
              const header = document.getElementById('profileDropdownHeader');
              if (header) {
                  header.innerHTML = `
                      <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                          <span style="font-size:20px;">${progress.emoji}</span>
                          <div>
                              <div style="font-weight:700; font-size:13px;">${progress.name} Level</div>
                              <div style="font-size:10px; color:${shiftColor}; font-weight:700;">${getCurrentShift() === 'morning' ? 'üåÖ Morning Shift' : 'üåÜ Evening Shift'}</div>
                          </div>
                      </div>
                      <div style="font-size:11px; color:var(--muted);">${txCount} transactions today</div>
                  `;
              }
          }
      }
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
          const dropdown = document.getElementById('profileDropdown');
          const button = e.target.closest('button');
          if (dropdown && (!button || !button.onclick?.toString().includes('toggleProfileDropdown'))) {
              dropdown.style.display = 'none';
          }
      });

      // Sync total payable display with cart total
      function updateTotalPayableDisplay() {
        const totalPayable = el("totalPayableDisplay");
        if (totalPayable) {
          // Format with Indian numbering system (lakhs and crores)
          totalPayable.textContent = formatINR(total);
          totalPayable.style.color = '#16a34a'; // Reset to green
        }
      }

      // Apply roundup to payment amount - this becomes the FINAL accepted amount
      function applyRoundup() {
        const roundValue = parseInt(el("roundupInput").value) || 0;
        const paymentAmount = el("paymentAmount");
        const totalPayableDisplay = el("totalPayableDisplay");

        if (roundValue > 0 && total > 0) {
          // Round to nearest value (10, 50, 100, etc.)
          const rounded = Math.round(total / roundValue) * roundValue;

          // Auto-update payment amount to rounded total
          paymentAmount.value = formatIndianNumber(rounded);

          // Also update the big TOTAL PAYABLE display to show rounded amount
          totalPayableDisplay.textContent = formatINR(rounded);
          totalPayableDisplay.style.color = '#1e40af'; // Darker blue to show it's modified
        } else {
          // Reset to total if no roundup
          paymentAmount.value = formatIndianNumber(total);

          // Reset total payable display to original total
          updateTotalPayableDisplay();
        }

        calculateCredit();
      }

      // Calculate credit based on payment amount
      function calculateCredit() {
        const paymentAmount = parseFloat(el("paymentAmount").value) || 0;
        const creditDisplay = el("creditDisplay");

        if (paymentAmount > 0) {
          const remaining = total - paymentAmount;
          if (remaining > 0) {
            // Customer paying LESS - this is discount/final settlement
            creditDisplay.textContent = `‚Çπ${remaining.toFixed(2)} ‡§ï‡§Æ (Discount)`;
            creditDisplay.style.color = '#dc2626';
          } else if (remaining < 0) {
            // Customer paying MORE - extra amount
            creditDisplay.textContent = `‚Çπ${Math.abs(remaining).toFixed(2)} ‡§è‡§ï‡•ç‡§∏‡•ç‡§ü‡•ç‡§∞‡§æ`;
            creditDisplay.style.color = '#166534';
          } else {
            creditDisplay.textContent = '‡§∏‡§π‡•Ä ‡§∞‡§æ‡§∂‡§ø!';
            creditDisplay.style.color = '#166534';
          }
        } else {
          creditDisplay.textContent = '';
        }
      }
      
      // Save entry, download invoice, and open WhatsApp or print
      function saveAndInvoice() {
        if (total === 0) return showToast('Cart is empty!');

        const customerName = el("activeCust").innerText;
        let paymentAmount = parseFloat(el("paymentAmount").value);

        // If payment amount not entered, use total
        if (!paymentAmount || paymentAmount <= 0) {
          paymentAmount = total;
        }

        const customer = customers.find(c => c.name === customerName);

        // Determine payment mode and calculate credit
        // paymentAmount is the FINAL ACCEPTED AMOUNT (rounded/negotiated)
        // If payment < total, the difference is DISCOUNT (not credit)
        // If payment >= total, no credit (or extra as advance)
        let paymentMode = 'Cash';
        let creditAmount = 0;

        if (paymentAmount < total) {
          // Customer paid less - this is a DISCOUNT, not credit
          // No balance carried forward - both parties accepted this amount
          paymentMode = 'Cash';
          creditAmount = 0; // NO credit entry
        } else if (paymentAmount > total) {
          // Customer paid more - extra amount as advance
          paymentMode = 'Cash';
          creditAmount = paymentAmount - total;
        }

        // Update customer ledger ONLY if there's actual advance (extra payment)
        if (customer && creditAmount > 0) {
          if (!customer.balance) customer.balance = 0;
          if (!customer.advance) customer.advance = 0;
          customer.advance += creditAmount;
          localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
          // Create backup
          localStorage.setItem('mr_pos_customers_backup', JSON.stringify(customers));
          showToast(`‚Çπ${creditAmount.toFixed(2)} added to advance ‚úÖ`);
        }

        // Save the entry with the ACTUAL accepted amount (rounded/negotiated)
        // This becomes the invoice amount
        // IMPORTANT: Save cart items BEFORE resetCart() clears them!
        const cartItemsForInvoice = JSON.parse(JSON.stringify(cart));

        saveEntryWithPayment(paymentMode, paymentAmount, creditAmount);

        // Generate and download invoice with accepted amount (use saved cart items)
        generateInvoice(customerName, paymentAmount, paymentMode, creditAmount, cartItemsForInvoice);

        // NON-BLOCKING: Open WhatsApp/Print in background without interrupting workflow
        // Process immediately but don't wait for it to complete
        const customerPhone = customer && customer.phone && customer.phone.trim().length >= 10 ? customer.phone : null;
        
        if (customerPhone) {
          // Open WhatsApp in new tab (non-blocking)
          setTimeout(() => {
            openWhatsAppInvoice(customer, paymentAmount, creditAmount, cartItemsForInvoice);
          }, 100);
        } else {
          // Print invoice in new tab (non-blocking)
          setTimeout(() => {
            printInvoice(customerName, paymentAmount, paymentMode, creditAmount, cartItemsForInvoice);
          }, 100);
        }
        
        // Continue with next customer immediately - don't wait for print/WhatsApp
        showToast('‚úÖ Saved! Next customer...');
      }
      
      // Save entry with payment details
      function saveEntryWithPayment(mode, paidAmount, creditAmount) {
        if(total === 0) return showToast("Cart empty");
        const custName = el("activeCust").innerText;
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const itemsDetail = cart.map(i => `${i.qty}x ${i.name}`).join(" | ");

        // Auto-create customer if new (typed name)
        if (!customers.find(c => c.name === custName) && custName !== "Walking Customer") {
            customers.push({ 
              name: custName, 
              lastOrder: itemsDetail, 
              rate: cart[0]?.rate || 0, 
              qty: cart[0]?.qty || 0,
              type: "Retail",
              sub: 0,
              balance: creditAmount > 0 ? creditAmount : 0,
              advance: creditAmount > 0 ? creditAmount : 0,
              monthMilk: 0
            });
            localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
            // Create backup
            localStorage.setItem('mr_pos_customers_backup', JSON.stringify(customers));
        }

        // Calculate total milk quantity for month tracking
        const totalMilkQty = cart.filter(i => i.name.includes('Milk')).reduce((sum, i) => sum + i.qty, 0);

        // Save full cart data for replay
        const newSale = {
          date: new Date().toLocaleDateString(),
          time,
          customer: custName,
          products: itemsDetail,
          amount: total.toFixed(2),
          method: mode,
          paidAmount: paidAmount.toFixed(2),
          creditAmount: creditAmount.toFixed(2),
          cartItems: JSON.parse(JSON.stringify(cart))
        };

        // Add to history
        exportHistory.push(newSale);
        localStorage.setItem('mr_sales_history', JSON.stringify(exportHistory));
        // Create backup
        localStorage.setItem('mr_sales_history_backup', JSON.stringify(exportHistory));

        // Update customer
        let cIdx = customers.findIndex(c => c.name === custName);
        if(cIdx !== -1) {
            customers[cIdx].lastOrder = itemsDetail;
            customers[cIdx].rate = cart[0]?.rate || 0;
            customers[cIdx].qty = cart[0]?.qty || 0;
            customers[cIdx].lastProductName = cart[0]?.name || '';
            if (!customers[cIdx].monthMilk) customers[cIdx].monthMilk = 0;
            customers[cIdx].monthMilk += totalMilkQty;
            localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
            // Create backup
            localStorage.setItem('mr_pos_customers_backup', JSON.stringify(customers));
        }

        // Update UI
        const entry = `<div class="cardRow" style="flex-direction:column; align-items:flex-start; gap:4px; cursor:pointer;" onclick="loadOrderFromHistory('${custName}', ${JSON.stringify(cart).replace(/"/g, '&quot;')})">
          <div style="width:100%; display:flex; justify-content:space-between;">
            <b>${custName}</b><b>${formatINR(total)}</b>
          </div>
          <div style="font-size:11px; color:var(--muted); font-weight:700;">
            ${time} ‚Ä¢ üõí ${itemsDetail} ‚Ä¢ ${modeIcon(mode)} ${mode}${creditAmount > 0 ? ` ‚Ä¢ Credit: ${formatINR(creditAmount)}` : ''}
            <span style="color:var(--blue); font-weight:700; margin-left:8px;">üîÅ Click to reload</span>
          </div>
        </div>`;
        el("historyToday").innerHTML = entry + el("historyToday").innerHTML;

        // Track frequent buys for this customer
        if (custName !== "Walking Customer") {
          trackFrequentBuy(custName, cart);
        }

        resetCart();
        showToast(`Saved! Paid: ‚Çπ${paidAmount.toFixed(2)}${creditAmount > 0 ? ` ‚Ä¢ Credit: ‚Çπ${creditAmount.toFixed(2)}` : ''} ‚úÖ`);
      }
      
      // Generate invoice HTML and download as PDF
      function generateInvoice(customerName, paymentAmount, paymentMode, creditAmount, cartItems = null) {
        const date = new Date().toLocaleDateString('en-IN', {
          day: 'numeric', month: 'short', year: 'numeric',
          hour: '2-digit', minute: '2-digit'
        });
        const invoiceNo = 'INV-' + Date.now().toString().slice(-6);

        // Get customer object for contact details
        const customer = customers.find(c => c.name === customerName);
        
        // Calculate new balance after this transaction
        const previousBalance = customer ? (customer.balance || 0) : 0;
        const newBalance = creditAmount > 0 ? previousBalance + creditAmount : previousBalance;

        // Get shop name from booth selection or localStorage
        const booth = localStorage.getItem('MilkRecord_booth') || 'main';
        const boothNames = {
          'main': 'Main Booth',
          'village-a': 'Village A Booth',
          'village-b': 'Village B Booth',
          'market': 'Market Booth'
        };
        const shopName = localStorage.getItem('MilkRecord_shop_name') || boothNames[booth] || 'Gopal Dairy Shop';
        const shopPhone = localStorage.getItem('MilkRecord_shop_phone') || '';
        const shopAddress = localStorage.getItem('MilkRecord_shop_address') || '';
        const shopEmail = localStorage.getItem('MilkRecord_shop_email') || '';
        const shopGST = localStorage.getItem('MilkRecord_shop_gst') || '';

        // Use provided cart items OR fall back to global cart
        const itemsToDisplay = cartItems || cart;

        // Create invoice HTML
        const invoiceHTML = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>Dairy POS Billing Software India - Free POS System for Milk Shops | MilkRecord</title>
            <style>
              @media print {
                body { padding: 10px; }
                .no-print { display: none; }
              }
              body { font-family: Arial, sans-serif; padding: 15px; max-width: 650px; margin: 0 auto; font-size: 13px; }
              .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
              .header h1 { color: #000; margin: 0 0 5px 0; font-size: 22px; font-weight: bold; }
              .header p { color: #333; margin: 3px 0; font-size: 12px; }
              .shop-info { background: #f5f5f5; padding: 12px; border-radius: 6px; margin-bottom: 15px; }
              .shop-info h2 { margin: 0 0 8px 0; color: #000; font-size: 16px; font-weight: bold; }
              .shop-info p { margin: 4px 0; color: #333; font-size: 12px; }
              .info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; padding: 12px; background: #f9f9f9; border-radius: 6px; }
              .info div { font-size: 12px; line-height: 1.8; }
              .customer-details { font-weight: bold; color: #000; }
              .customer-contact { font-size: 11px; color: #555; margin-top: 3px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #000; }
              th { background: #e0e0e0; padding: 10px 8px; text-align: left; font-weight: bold; border: 1px solid #000; font-size: 12px; }
              td { padding: 10px 8px; border: 1px solid #000; font-size: 12px; }
              .total { text-align: right; font-size: 16px; font-weight: bold; color: #000; padding: 12px; background: #f0f0f0; border-radius: 6px; border: 2px solid #000; }
              .payment { background: #f5f5f5; padding: 12px; border-radius: 6px; margin-top: 15px; border: 1px solid #000; }
              .footer { text-align: center; margin-top: 25px; padding-top: 12px; border-top: 2px solid #000; color: #333; font-size: 11px; }
            </style>
          </head>
          <body>
            <div class="shop-info">
              <h2>${shopName}</h2>
              ${shopPhone ? `<p>üì± +91${shopPhone}</p>` : ''}
              ${shopAddress ? `<p>üìç ${shopAddress}</p>` : ''}
              ${shopEmail ? `<p>‚úâÔ∏è ${shopEmail}</p>` : ''}
              ${shopGST ? `<p>GSTIN: ${shopGST}</p>` : ''}
            </div>
            <div class="header">
              <h1>Dairy POS Billing Software for Indian Milk Shops</h1>
              <p>${invoiceNo} | ${date}</p>
            </div>
            <div class="info">
              <div>
                <div class="customer-details"><strong>Billed To:</strong></div>
                <div style="font-weight: bold; font-size: 13px;">${customerName}</div>
                ${customer && customer.phone ? `<div class="customer-contact">üì± +91${customer.phone}</div>` : ''}
                ${customer && customer.email ? `<div class="customer-contact">‚úâÔ∏è ${customer.email}</div>` : ''}
                ${customer && customer.address ? `<div class="customer-contact">üìç ${customer.address}</div>` : ''}
                ${customer && customer.gst ? `<div class="customer-contact">GSTIN: ${customer.gst}</div>` : ''}
              </div>
              <div style="text-align: right;">
                <div style="font-weight: bold; margin-bottom: 5px;">Payment Details:</div>
                <div>${paymentMode} - ${formatINR(paymentAmount)}</div>
                ${creditAmount > 0 ? `<div style="color: #c00; margin-top: 8px; padding: 8px; background: #fef2f2; border-radius: 4px;"><strong>üìí Credit (Udhar): ${formatINR(creditAmount)}</strong></div>` : ''}
                ${creditAmount > 0 ? `<div style="color: #c00; font-weight: bold; font-size: 14px;">‚öñÔ∏è Balance Due: ${formatINR(creditAmount)}</div>` : ''}
                ${creditAmount === 0 ? `<div style="color: #16a34a; margin-top: 5px;"><strong>‚úÖ Paid in Full</strong></div>` : ''}
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 11px;">
                  <div>Previous Balance: ${formatINR(previousBalance)}</div>
                  <div style="font-weight: bold; font-size: 13px;">New Balance: ${formatINR(newBalance)}</div>
                </div>
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th style="width: 40%;">Item</th>
                  <th style="text-align:center; width: 15%;">Qty</th>
                  <th style="text-align:right; width: 20%;">Rate</th>
                  <th style="text-align:right; width: 25%;">Amount</th>
                </tr>
              </thead>
              <tbody>
                ${itemsToDisplay.map(item => `
                  <tr>
                    <td>${item.name}</td>
                    <td style="text-align:center">${item.qty}</td>
                    <td style="text-align:right">${formatINR(item.rate)}</td>
                    <td style="text-align:right">${formatINR(item.qty * item.rate)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <div class="total">
              <strong>Grand Total: ${formatINR(total)}</strong>
            </div>
            <div class="payment">
              ${paymentMode === 'Credit' || paymentMode === 'Udhar' ? `
                <div><strong>Amount Paid:</strong> ‚Çπ0.00</div>
                <div style="margin-top: 8px; color: #dc2626;"><strong>Credit (Udhar):</strong> ${formatINR(creditAmount)}</div>
                <div style="margin-top: 8px; color: #dc2626;"><strong>Balance Due:</strong> ${formatINR(creditAmount)}</div>
              ` : `
                <div><strong>Amount Paid:</strong> ${formatINR(paymentAmount)}</div>
                ${creditAmount > 0 ? `<div style="margin-top: 8px;"><strong>Credit (Udhar):</strong> ${formatINR(creditAmount)}</div>` : ''}
                ${creditAmount > 0 ? `<div style="margin-top: 8px; color: #dc2626;"><strong>Balance Due:</strong> ${formatINR(creditAmount)}</div>` : ''}
              `}
            </div>
            <div class="footer">
              <p style="font-size: 12px; margin: 8px 0;"><strong>Terms & Conditions:</strong></p>
              <p style="font-size: 10px; margin: 4px 0;">‚Ä¢ Goods once sold will not be taken back</p>
              <p style="font-size: 10px; margin: 4px 0;">‚Ä¢ Interest @18% p.a. will be charged on delayed payments</p>
              <p style="font-size: 10px; margin: 4px 0;">‚Ä¢ Subject to local jurisdiction</p>
              <p style="margin-top: 15px; font-weight: bold;">Thank you for your business! üôè</p>
              <p style="margin-top: 8px;">${shopName}</p>
              <p style="font-size: 10px; color: #666;">Generated: ${date}</p>
            </div>
          </body>
          </html>
        `;

        // Auto-print invoice immediately (no user interaction)
        const printWindow = window.open('', '_blank');
        printWindow.document.write(invoiceHTML);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
        }, 250);
      }
      
      // Generate WhatsApp message
      function generateWhatsAppMessage(invoiceNo, date, customerName, paymentAmount, creditAmount) {
        const booth = localStorage.getItem('MilkRecord_booth') || 'main';
        const boothNames = {
          'main': 'Main Booth',
          'village-a': 'Village A Booth',
          'village-b': 'Village B Booth',
          'market': 'Market Booth'
        };
        const shopName = localStorage.getItem('MilkRecord_shop_name') || boothNames[booth] || 'Gopal Dairy Shop';
        
        let message = `*${shopName}*\n`;
        message += `üßæ Invoice: ${invoiceNo}\n`;
        message += `üìÖ Date: ${date}\n\n`;
        message += `*Customer:* ${customerName}\n\n`;
        message += `*Items:*\n`;
        cart.forEach(item => {
          message += `‚Ä¢ ${item.name} - ${item.qty} x ‚Çπ${item.rate} = ‚Çπ${(item.qty * item.rate).toFixed(2)}\n`;
        });
        message += `\n*Total: ${formatINR(total)}*`;
        message += `\nPaid: ${formatINR(paymentAmount)}`;
        if (creditAmount > 0) {
          message += `\n*Credit (Udhar): ${formatINR(creditAmount)}*`;
        }
        message += `\n\nThank you for your business! üôè`;
        return message;
      }
      
      // Generate UUID for shareable links
      function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0;
          const v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      // Save invoice for public access
      function saveInvoicePublic(invoiceData) {
        const uuid = generateUUID();
        const invoices = JSON.parse(localStorage.getItem('mr_public_invoices') || '[]');
        invoiceData.uuid = uuid;
        invoiceData.createdAt = Date.now();
        invoices.push(invoiceData);
        localStorage.setItem('mr_public_invoices', JSON.stringify(invoices));
        return uuid;
      }

      // Get invoice by UUID
      function getInvoiceByUUID(uuid) {
        const invoices = JSON.parse(localStorage.getItem('mr_public_invoices') || '[]');
        return invoices.find(inv => inv.uuid === uuid);
      }

      // Print invoice in new tab - NON-BLOCKING
      function printInvoice(customerName, paymentAmount, paymentMode, creditAmount, cartItems = null) {
        const date = new Date().toLocaleDateString('en-IN', {
          day: 'numeric', month: 'short', year: 'numeric',
          hour: '2-digit', minute: '2-digit'
        });
        const invoiceNo = 'INV-' + Date.now().toString().slice(-6);
        const uuid = generateUUID();
        const customer = customers.find(c => c.name === customerName);

        // Use provided cart items OR fall back to global cart
        const itemsToDisplay = cartItems || cart;

        // Save invoice for public access
        saveInvoicePublic({
          invoiceNo,
          uuid,
          customerName,
          customerPhone: customer?.phone,
          paymentMode,
          paymentAmount,
          creditAmount,
          items: itemsToDisplay,
          total,
          date
        });

        // Create invoice HTML for printing
        const invoiceHTML = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>Dairy POS Billing Software India - Free POS System for Milk Shops | MilkRecord</title>
            <style>
              @media print {
                body { padding: 10px; }
                .no-print { display: none; }
                @page { margin: 10mm; }
              }
              body { font-family: Arial, sans-serif; padding: 20px; max-width: 580px; margin: 0 auto; }
              .header { text-align: center; border-bottom: 3px solid #3b82f6; padding-bottom: 15px; margin-bottom: 20px; }
              .header h1 { color: #1e293b; margin: 0; font-size: 22px; }
              .header p { color: #64748b; margin: 5px 0; }
              .info { display: flex; justify-content: space-between; margin-bottom: 20px; }
              .info div { font-size: 13px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
              th { background: #f1f5f9; padding: 8px; text-align: left; font-weight: 700; font-size: 13px; }
              td { padding: 8px; border-bottom: 1px solid #e2e8f0; font-size: 13px; }
              .total { text-align: right; font-size: 16px; font-weight: 900; color: #1e293b; }
              .payment { background: #f0fdf4; padding: 12px; border-radius: 6px; margin-top: 15px; font-size: 13px; }
              .footer { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 2px solid #e2e8f0; color: #64748b; font-size: 11px; }
              .print-btn { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px; margin: 20px auto; display: block; }
              .print-btn:hover { background: #2563eb; }
              .share-link { background: #f0f9ff; padding: 12px; border-radius: 6px; margin: 20px 0; font-size: 12px; border: 1px solid #3b82f6; }
              .share-link input { width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px; margin-top: 8px; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>Dairy POS Billing Software for Indian Milk Shops</h1>
              <p>${invoiceNo} | ${date}</p>
            </div>
            <div class="info">
              <div><strong>Customer:</strong><br>${customerName}${customer && customer.phone ? `<br>üì± +91${customer.phone}` : ''}</div>
              <div><strong>Payment:</strong><br>${paymentMode} - ‚Çπ${paymentAmount.toFixed(2)}</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th style="text-align:center">Qty</th>
                  <th style="text-align:right">Rate</th>
                  <th style="text-align:right">Amount</th>
                </tr>
              </thead>
              <tbody>
                ${itemsToDisplay.map(item => `
                  <tr>
                    <td>${item.name}</td>
                    <td style="text-align:center">${item.qty}</td>
                    <td style="text-align:right">${formatINR(item.rate)}</td>
                    <td style="text-align:right">${formatINR(item.qty * item.rate)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <div class="total">
              Total: ${formatINR(total)}
            </div>
            <div class="payment">
              <strong>Amount Paid:</strong> ${formatINR(paymentAmount)}<br>
              ${creditAmount > 0 ? `<strong>Credit (Udhar):</strong> ${formatINR(creditAmount)}` : ''}
              ${creditAmount > 0 ? `<br><strong>Remaining Balance:</strong> ${formatINR(creditAmount)}` : ''}
            </div>
            <div class="share-link no-print">
              <strong>üîó Shareable Link:</strong>
              <input type="text" value="${window.location.origin}${window.location.pathname}#invoice/${uuid}" readonly onclick="this.select()" />
              <button onclick="navigator.clipboard.writeText('${window.location.origin}${window.location.pathname}#invoice/${uuid}'); alert('Link copied!')" style="margin-top: 8px; padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üìã Copy Link</button>
            </div>
            <div class="footer">
              <p>Thank you for your business! üôè</p>
              <p>${shopName} | Generated: ${date}</p>
            </div>
            <button class="print-btn no-print" onclick="window.print(); window.close();">üñ®Ô∏è Print Now</button>
          </body>
          </html>
        `;

        // Open in new tab and trigger print (non-blocking - main app continues)
        try {
          const printWindow = window.open('', '_blank');
          if (printWindow) {
            printWindow.document.write(invoiceHTML);
            printWindow.document.close();
            // Auto-print after short delay
            setTimeout(() => {
              printWindow.focus();
              printWindow.print();
              // Don't auto-close - let user close manually if needed
            }, 500);
          }
        } catch (e) {
          console.error('Print failed:', e);
          // Fallback: Just show toast, user can manually print from history
          showToast('üìÑ Invoice generated - Check history to print');
        }
      }
      
      // Open WhatsApp with invoice message
      function openWhatsAppInvoice(customer, paymentAmount, creditAmount, cartItems = null) {
        const customerName = el("activeCust").innerText;
        const date = new Date().toLocaleDateString('en-IN');
        const invoiceNo = 'INV-' + Date.now().toString().slice(-6);
        
        // Use provided cart items OR fall back to global cart
        const itemsToDisplay = cartItems || cart;

        // Build WhatsApp message with emojis
        let message = `üßæ *MilkRecord Invoice*
üìÖ ${date} | üîñ ${invoiceNo}

üë§ *Customer:* ${customerName}

üõí *Items:*
${itemsToDisplay.map(item => `${getEmojiForProduct(item.name)} ${item.name} - ${item.qty} x ${formatINR(item.rate)} = ${formatINR(item.qty * item.rate)}`).join('\n')}

üí∞ *Total:* ${formatINR(total)}
üíµ *Paid:* ${formatINR(paymentAmount)}
${creditAmount > 0 ? `üìí *Credit (Udhar):* ${formatINR(creditAmount)}` : ''}
${creditAmount > 0 ? `‚öñÔ∏è *Balance:* ${formatINR(creditAmount)}` : ''}

üôè Thank you!
üè™ MilkRecord POS`;

        // Encode for WhatsApp
        const encodedMessage = encodeURIComponent(message);

        // Get customer phone or open WhatsApp picker
        let whatsappUrl;
        if (customer && customer.phone) {
          whatsappUrl = `https://wa.me/91${customer.phone.replace(/\D/g, '')}?text=${encodedMessage}`;
        } else {
          whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
        }

        // Open WhatsApp
        window.open(whatsappUrl, '_blank');
        showToast('Opening WhatsApp... üí¨');
      }
      
      // Logic: Persistent Search Dropdown with Keyboard Support
      let selectedDropIndex = -1;
      
      // Load customers from localStorage (offline mode) - USES loadData()!
      function loadCustomers() {
        try {
          // Use loadData() which handles both old and new formats
          const loaded = loadData('mr_pos_customers', []);
          if (Array.isArray(loaded)) {
            customers = loaded;
            console.log('‚úÖ Loaded', customers.length, 'customers (Offline)');
          } else {
            customers = [];
          }
        } catch (error) {
          console.error('‚ö†Ô∏è Customer data corrupted, attempting recovery...');
          customers = [];

          // Try backup 1 - USE loadData() helper
          try {
            const backup1 = loadData('mr_pos_customers_backup', []);
            if (Array.isArray(backup1)) {
              customers = backup1;
              console.log('‚úÖ Recovered', customers.length, 'customers from backup 1!');
            } else {
              throw new Error();
            }
          } catch(e2) {
            // Try backup 2 - USE loadData() helper
            try {
              const backup2 = loadData('mr_pos_customers_backup2', []);
              if (Array.isArray(backup2)) {
                customers = backup2;
                console.log('‚úÖ Recovered', customers.length, 'customers from backup 2!');
              } else {
                throw new Error();
              }
            } catch(e3) {
              console.error('‚ùå All customer backups failed, starting fresh');
              customers = [];
            }
          }
        }

        // FINAL SAFETY: Ensure customers is always an array
        if (!Array.isArray(customers)) {
          console.error('‚ùå Forcing customers to empty array');
          customers = [];
        }

        // ALWAYS create triple backup
        try {
          const dataStr = JSON.stringify(customers);
          localStorage.setItem('mr_pos_customers', dataStr);
          localStorage.setItem('mr_pos_customers_backup', dataStr);
          localStorage.setItem('mr_pos_customers_backup2', dataStr);
        } catch(e) {
          console.error('‚ùå Failed to create customer backup:', e);
        }
      }

      // Load customers on page load
      loadCustomers();

      // Populate advance order customer dropdown after customers are loaded
      setTimeout(() => {
        populateAdvanceOrderCustomers(true); // Auto-select first customer
      }, 500);

      // Frequent buys tracking - stores customer's recent orders
      let frequentBuys = {};
      
      function handleSearch(val) {
          const drop = el("searchDropdown");
          const searchVal = val.trim();

          // Ensure customers array exists
          if (!customers || !Array.isArray(customers)) {
            customers = [];
          }

          console.log('üîç Search:', searchVal, 'Customers loaded:', customers.length);

          // Show ALL customers when search is focused (even if empty)
          // Search in: ID, Name, Phone, Email, Address
          const searchLower = searchVal.toLowerCase();
          const filtered = !searchVal
            ? customers
            : customers.filter(c => {
                const match = (c.id && c.id.toLowerCase().includes(searchLower)) ||
                c.name.toLowerCase().includes(searchLower) ||
                (c.phone && c.phone.includes(searchVal)) ||
                (c.email && c.email.toLowerCase().includes(searchLower)) ||
                (c.address && c.address.toLowerCase().includes(searchLower));
                console.log('  Checking:', c.name, 'Match:', match);
                return match;
              });

          console.log('‚úÖ Filtered results:', filtered.length);

          // Always show dropdown when there's input or focus
          if (searchVal || document.activeElement === el("custSearch")) {
              let html = '';
              selectedDropIndex = -1;

              // Always show "Add New Customer" option at top when typing
              if (searchVal && searchVal.length > 0) {
                  // Check if customer with this name already exists
                  const existingCustomer = customers.find(c => 
                    c.name.toLowerCase() === searchVal.toLowerCase() ||
                    c.phone === searchVal
                  );
                  
                  if (!existingCustomer) {
                      html += `
                        <div class="drop-item add-new" onclick="addCustomerDirect('${escapeHtml(searchVal)}')" data-index="0" style="background:#f0fdf4; border:2px solid #16a34a;">
                          <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:18px;">‚ûï</span>
                            <div>
                              <div style="font-weight:900; color:#166534;">Add Customer: "${escapeHtml(searchVal)}"</div>
                              <div style="font-size:11px; color:#15803d;">Click to create new customer</div>
                            </div>
                          </div>
                        </div>
                      `;
                  }
              }

              // Show matching customers with their frequent buys
              if (filtered.length > 0) {
                  html += filtered.map((c, i) => {
                    // Get customer's frequent buys
                    const custBuys = frequentBuys[c.name] || [];
                    const buysHtml = custBuys.length > 0 ?
                      `<div style="font-size:10px; color:#16a34a; font-weight:700; margin-top:2px;">üîÑ Frequent: ${custBuys.slice(0,3).join(', ')}</div>` : '';

                    // Show customer ID if available
                    const idDisplay = c.id ? `<span style="font-size:10px; color:#3b82f6; font-weight:700; margin-right:6px;">#${c.id}</span>` : '';
                    
                    // Check if customer has phone
                    const hasPhone = c.phone && c.phone.trim().length > 0;
                    const phoneWarning = !hasPhone ? `<span style="font-size:9px; color:#dc2626; font-weight:700;">‚ö†Ô∏è No Phone</span>` : '';

                    return `
                    <div class="drop-item" onclick="selectCust('${c.name}')" data-index="${i + 1}" style="display:flex; justify-content:space-between; align-items:center;">
                      <div style="flex:1;">
                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:2px;">
                          ${idDisplay}
                          <div style="font-weight:700;">${c.name}</div>
                          ${c.phone || c.address ? `<span style="font-size:9px; color:#64748b;">(${c.phone || 'No phone'}${c.address ? ' ‚Ä¢ ' + c.address : ''})</span>` : ''}
                        </div>
                        ${buysHtml}
                      </div>
                      <div style="text-align:right; display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
                        ${c.balance > 0 ? `<div style="font-size:11px; color:#dc2626; font-weight:700;">üìï ${formatINR(c.balance)}</div>` : ''}
                        <div style="font-size:11px; color:var(--muted);">Bal: ${formatINR(c.balance || 0)}</div>
                        <button onclick="event.stopPropagation(); openCustomerRelation('${c.id || c.name}')" style="font-size:9px; padding:2px 6px; background:#7c3aed; color:white; border:none; border-radius:4px; font-weight:700; cursor:pointer;">ü§ù Relation</button>
                      </div>
                    </div>
                  `}).join('');
              } else if (!searchVal) {
                  html += '<div style="padding:15px; text-align:center; color:var(--muted); font-size:12px;">Start typing to search customers</div>';
              }

              drop.innerHTML = html;
              drop.style.display = 'block';
          } else {
            drop.style.display = 'none';
          }
      }
      
      // Track frequent buys when sale is made
      function trackFrequentBuy(customerName, items) {
        if (!frequentBuys[customerName]) frequentBuys[customerName] = [];
        
        items.forEach(item => {
          const itemName = item.name;
          const existingIndex = frequentBuys[customerName].indexOf(itemName);
          if (existingIndex >= 0) {
            // Move to front (most recent)
            frequentBuys[customerName].splice(existingIndex, 1);
          }
          // Add to front
          frequentBuys[customerName].unshift(itemName);
          // Keep only last 5 items
          frequentBuys[customerName] = frequentBuys[customerName].slice(0, 5);
        });
        
        // Save to localStorage
        localStorage.setItem('mr_frequent_buys', JSON.stringify(frequentBuys));
      }
      
      // Load frequent buys from localStorage
      function loadFrequentBuys() {
        try {
          const saved = localStorage.getItem('mr_frequent_buys');
          if (saved) {
            frequentBuys = JSON.parse(saved);
          }
        } catch(e) {
          frequentBuys = {};
        }
      }
      
      // Arrow key navigation for dropdown
      el("custSearch").addEventListener('keydown', function(e) {
        const drop = el("searchDropdown");
        const items = drop.querySelectorAll('.drop-item');

        if (drop.style.display === 'none' || items.length === 0) return;

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedDropIndex = Math.min(selectedDropIndex + 1, items.length - 1);
          updateSelectedDropItem(items);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedDropIndex = Math.max(selectedDropIndex - 1, 0);
          updateSelectedDropItem(items);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          // If no item selected, select first one (skip "Add New Customer")
          if (selectedDropIndex < 0) {
            // Select first actual customer (index 1, skipping "Add New")
            if (items.length > 1) {
              items[1].click();
            } else if (items.length > 0) {
              items[0].click();
            }
          } else {
            items[selectedDropIndex].click();
          }
        } else if (e.key === 'Escape') {
          drop.style.display = 'none';
        }
      });
      
      function updateSelectedDropItem(items) {
        items.forEach((item, i) => {
          if (i === selectedDropIndex) {
            item.classList.add('selected');
            item.scrollIntoView({ block: 'nearest' });
          } else {
            item.classList.remove('selected');
          }
        });
      }
      
      // Add customer directly from dropdown (offline mode)
      function addCustomerDirect(name) {
        if (!name) return;

        // Check if customer already exists
        const existing = customers.find(c => c.name.toLowerCase() === name.toLowerCase());
        if (existing) {
          selectCust(existing.name);
          showToast('Customer selected: ' + name);
          return;
        }

        // Create customer locally (offline mode)
        const newCustomer = {
          id: "cust_" + Date.now(),
          name: name,
          phone: "",
          email: "",
          balance: 0,
          advance: 0,
          monthMilk: 0,
          frequentBuys: [],
          createdAt: Date.now()
        };

        // Add to local array for immediate UI update
        customers.push(newCustomer);
        localStorage.setItem('mr_pos_customers', JSON.stringify(customers));

        // Refresh advance order customer dropdown
        populateAdvanceOrderCustomers();

        selectCust(name);
        el("custSearch").value = name;
        el("searchDropdown").style.display = 'none';
        showToast(name + ' added (Offline) ‚úÖ');
      }
      
      // Show all customers when search is focused
      el("custSearch").addEventListener('focus', function() {
        handleSearch('');
      });
      
      // Generate next customer ID (auto-increment)
      function getNextCustomerId() {
        // Get highest existing ID number
        let maxNum = 0;
        customers.forEach(c => {
          if (c.id) {
            const match = c.id.match(/C(\d+)/);
            if (match) {
              const num = parseInt(match[1]);
              if (num > maxNum) maxNum = num;
            }
          }
        });
        // Return next ID (C001, C002, etc.)
        return 'C' + String(maxNum + 1).padStart(3, '0');
      }
      
      // Add customer with validation
      function addCust() {
        const name = el("newName").value;
        const phone = el("newPhone").value || "";
        const email = el("newEmail").value || "";
        const address = el("newAddress").value || "";
        const custId = el("newCustId").value || getNextCustomerId();

        if(!name) return showToast("Name required!");

        customers.push({
          id: custId,
          name,
          phone,
          email,
          address,
          lastOrder: "No order yet",
          rate: 0,
          qty: 0,
          balance: 0,
          advance: 0
        });
        localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
        // Create backup
        localStorage.setItem('mr_pos_customers_backup', JSON.stringify(customers));
        localStorage.setItem('mr_pos_customers_backup2', JSON.stringify(customers));

        selectCust(name);
        closeModal('addCustModal');
        
        // Reset modal to add mode
        resetCustomerModalToAddMode();
        
        // Clear form
        el("newName").value = "";
        el("newPhone").value = "";
        el("newEmail").value = "";
        el("newAddress").value = "";
        el("newCustId").value = "";
        showToast(`${name} (${custId}) Added!`);

        // Return focus to search
        setTimeout(() => el("custSearch").focus(), 100);
      }

      // Wrapper function for add customer button
      function addNewCustomer() {
        addCust();
      }
      
      // Select customer from search
      function selectCust(name) {
          // Update search input to show selected customer
          const searchInput = el("custSearch");
          searchInput.value = name;
          searchInput.style.borderColor = '#22c55e';
          searchInput.style.background = '#f0fdf4';
          el("searchDropdown").style.display = "none";

          // Update hidden activeCust element for backwards compatibility
          const activeCustEl = el("activeCust");
          if (activeCustEl) activeCustEl.innerText = name;

          // IMPORTANT: Clear cart when switching customers!
          cart = [];
          updateUI();

          showToast("Customer: " + name + " üìù");

          // Auto-fill from customer memory (previous orders)
          loadCustomerMemory(name);

          // Load last 6 items bought from history as frequently bought
          loadLastBoughtItems(name);

          // Auto-fill frequent buys / last invoice from memory
          const customer = customers.find(c => c.name === name);
          if (customer && customer.frequentBuys && customer.frequentBuys.length > 0) {
            // Clear current cart and add frequent buys
            cart = [];
            customer.frequentBuys.forEach(buy => {
              cart.push({
                name: buy.name,
                rate: buy.rate,
                qty: buy.qty,
                emoji: buy.emoji || 'üì¶',
                id: Date.now() + Math.random()
              });
            });
            updateUI();
            showToast(`Loaded ${customer.frequentBuys.length} frequent items ‚úÖ`);
          }

          // Show advance toggle for this customer
          showAdvanceSection(name);
      }

      // Load last 6 items bought from history
      function loadLastBoughtItems(customerName) {
        if (!customerName || customerName === 'Walking Customer') return;

        const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
        const customerHistory = history.filter(h => h.customer === customerName).sort((a, b) => b.createdAt - a.createdAt).slice(0, 6);

        if (customerHistory.length > 0) {
          // Extract unique items from last 6 purchases
          const itemMap = new Map();
          customerHistory.forEach(order => {
            if (order.cartItems && Array.isArray(order.cartItems)) {
              order.cartItems.forEach(item => {
                if (!itemMap.has(item.name)) {
                  itemMap.set(item.name, {
                    name: item.name,
                    rate: item.rate,
                    qty: item.qty,
                    emoji: item.emoji || 'üì¶',
                    lastBought: order.createdAt
                  });
                }
              });
            }
          });

          const lastBoughtItems = Array.from(itemMap.values());

          if (lastBoughtItems.length > 0 && cart.length === 0) {
            // Add last bought items to cart
            lastBoughtItems.forEach(item => {
              cart.push({
                name: item.name,
                rate: item.rate,
                qty: item.qty,
                emoji: item.emoji,
                id: Date.now() + Math.random()
              });
            });
            updateUI();
            showToast(`Loaded ${lastBoughtItems.length} last bought items ‚úÖ`);
          }
        }
      }
      
      // Show advance/cut ledger - ONLY if customer has credit history
      function showAdvanceSection(customerName) {
        const customer = customers.find(c => c.name === customerName);
        if (!customer) {
          return;
        }

        // Initialize advance if not exists
        if (!customer.advance) customer.advance = 0;
        if (!customer.monthMilk) customer.monthMilk = 0;

        el("monthMilk").textContent = customer.monthMilk.toFixed(1) + ' L';
        el("currentAdvance").textContent = formatINR(customer.advance);

        // Update advance button text if customer has unpaid/credit history
        const advanceBtn = el("advanceToggleBtn");
        if (advanceBtn) {
          if (customer.advance > 0) {
            advanceBtn.innerHTML = `üìí Udhar: ${formatINR(customer.advance)}`;
          } else {
            advanceBtn.innerHTML = 'üìí Advance / Udhar';
          }
        }
      }
      
      // Toggle advance section visibility
      function toggleAdvance() {
        const paymentForm = el("paymentForm");
        const advanceForm = el("advanceForm");
        const advanceAmount = el("advanceAmount");

        if (advanceForm.style.display === 'none' || advanceForm.style.display === '') {
          // Show advance form, hide payment form
          paymentForm.style.setProperty('display', 'none', 'important');
          advanceForm.style.setProperty('display', 'flex', 'important');

          // Auto-fill amount from Net Payable
          if (advanceAmount && total > 0) {
            advanceAmount.value = total.toFixed(2);
            advanceAmount.focus();
            advanceAmount.select();
          }

          const customerName = el("activeCust").innerText;
          if (customerName && customerName !== 'Walking Customer') {
            showAdvanceSection(customerName);
          }
        } else {
          // Show payment form, hide advance form
          advanceForm.style.setProperty('display', 'none', 'important');
          paymentForm.style.setProperty('display', 'flex', 'important');
        }
      }

      // Close advance section
      function closeAdvance() {
        toggleAdvance();
      }

      // ========== ADVANCE ORDER FUNCTIONS (POS) ==========
      let posAdvanceOrders = JSON.parse(localStorage.getItem('posAdvanceOrders') || '[]');

      // Populate customer dropdown in advance order form
      function populateAdvanceOrderCustomers(autoSelectFirst = false) {
        const select = document.getElementById('advanceOrderCustomer');
        if (!select) return;
        
        console.log('üîµ Populating advance order customers, count:', customers.length);
        
        // Clear existing options
        select.innerHTML = '<option value="">-- Select Customer --</option>';
        
        // Add all customers with details in brackets
        customers.forEach(c => {
          const option = document.createElement('option');
          option.value = c.name;
          // Show phone and address in brackets
          const details = [];
          if (c.phone) details.push(c.phone);
          if (c.address) details.push(c.address);
          option.textContent = c.name + (details.length > 0 ? ` (${details.join(' ‚Ä¢ ')})` : '');
          select.appendChild(option);
        });
        
        // Auto-select first customer if requested and customers exist
        if (autoSelectFirst && customers.length > 0) {
          select.value = customers[0].name;
          // Trigger location auto-fill
          onAdvanceOrderCustomerChange();
          console.log('‚úÖ Auto-selected first customer:', customers[0].name);
        }
      }

      // Handle customer selection change
      function onAdvanceOrderCustomerChange() {
        const select = document.getElementById('advanceOrderCustomer');
        const locationInput = document.getElementById('advanceOrderLocation');
        const notesInput = document.getElementById('advanceOrderNotes');
        const phoneWarning = document.getElementById('advanceOrderPhoneWarning');
        if (!select || !locationInput) return;

        const selectedName = select.value;
        const customer = customers.find(c => c.name === selectedName);

        // Show/hide phone warning based on customer selection
        if (phoneWarning) {
          if (!selectedName || (customer && (!customer.phone || customer.phone.trim() === ''))) {
            phoneWarning.style.display = 'block';
          } else {
            phoneWarning.style.display = 'none';
          }
        }

        if (customer) {
          // Auto-fill location from customer address
          if (customer.address) {
            locationInput.value = customer.address;
          }

          // Auto-fill notes with customer phone
          if (notesInput && customer.phone) {
            notesInput.value = `Call on ${customer.phone}`;
          }
          
          // AUTO-FILL: Show customer's current balance/advance
          const balanceDisplay = document.getElementById('advanceOrderCustomerBalance');
          if (balanceDisplay) {
            const customerBalance = customer.balance || 0;
            const customerAdvance = customer.advance || 0;
            balanceDisplay.textContent = `Balance: ${formatINR(customerBalance)} | Advance: ${formatINR(customerAdvance)}`;
            balanceDisplay.style.color = customerBalance > 0 ? '#dc2626' : '#16a34a';
            balanceDisplay.style.display = 'block';
            balanceDisplay.style.fontSize = '12px';
            balanceDisplay.style.fontWeight = '700';
            balanceDisplay.style.marginTop = '8px';
          }

          // Check if customer has phone number - ONLY show warning if they have advance orders
          if (!customer.phone || customer.phone.trim() === '') {
            // Check if customer has any advance orders
            const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
            const hasAdvances = history.some(h => h.customer === customer.name && h.method === 'Cash In');

            // Only show phone warning if customer has advance orders
            if (hasAdvances) {
              setTimeout(() => {
                const addMobile = confirm(`‚ö†Ô∏è ${customer.name} doesn't have a phone number.\n\nAdd mobile number now?`);
                if (addMobile) {
                  openEditCustomerForAdvanceOrder(customer);
                }
              }, 300);
            }
          }
        }
      }

      // Open edit customer modal for advance order
      function openEditCustomerForAdvanceOrder(customer) {
        if (!customer) return;

        // Fill in the add customer modal with existing data
        document.getElementById('newCustId').value = customer.id || '';
        document.getElementById('newName').value = customer.name || '';
        document.getElementById('newPhone').value = customer.phone || '';
        document.getElementById('newEmail').value = customer.email || '';
        document.getElementById('newAddress').value = customer.address || '';
        document.getElementById('newUnit').value = customer.unit || 'L';

        // Change modal title
        const modalTitle = document.querySelector('#addCustModal .panelHeader span');
        if (modalTitle) modalTitle.textContent = 'üìù Edit Customer';

        // Change button text
        const addBtn = document.querySelector('#addCustModal .add-btn');
        if (addBtn) {
          addBtn.textContent = 'üíæ Update Customer';
          addBtn.onclick = () => updateCustomerFromAdvanceOrder(customer.id);
        }

        openModal('addCustModal');
      }

      // Open add customer modal for advance order (NEW CUSTOMER)
      function openAddCustomerFromAdvanceOrder() {
        // Clear the add customer modal
        document.getElementById('newCustId').value = '';
        document.getElementById('newName').value = '';
        document.getElementById('newPhone').value = '';
        document.getElementById('newEmail').value = '';
        document.getElementById('newAddress').value = '';
        document.getElementById('newUnit').value = 'L';

        // Change modal title
        const modalTitle = document.querySelector('#addCustModal .panelHeader span');
        if (modalTitle) modalTitle.textContent = '‚ûï Add New Customer';

        // Change button text
        const addBtn = document.querySelector('#addCustModal .add-btn');
        if (addBtn) {
          addBtn.textContent = '‚ûï Add Customer';
          addBtn.onclick = () => addNewCustomerFromAdvanceOrder();
        }

        openModal('addCustModal');
      }

      // Add new customer from advance order context
      function addNewCustomerFromAdvanceOrder() {
        const custId = document.getElementById('newCustId').value.trim() || 'cust_' + Date.now();
        const name = document.getElementById('newName').value.trim();
        const phone = document.getElementById('newPhone').value.trim();
        const email = document.getElementById('newEmail').value.trim();
        const address = document.getElementById('newAddress').value.trim();
        const unit = document.getElementById('newUnit').value.trim() || 'L';

        if (!name) return showToast('Name required!');
        if (!phone) return showToast('Mobile number required for advance orders!');

        // Create new customer
        const newCustomer = {
          id: custId,
          name: name,
          phone: phone,
          email: email || '',
          address: address || '',
          unit: unit,
          balance: 0,
          advance: 0
        };

        customers.push(newCustomer);
        localStorage.setItem('mr_pos_customers', JSON.stringify(customers));

        closeModal('addCustModal');
        showToast(`‚úÖ ${name} added!`);

        // Refresh customer dropdown if it exists
        populateAdvanceOrderCustomers(true);
      }

      // Update customer from advance order context
      function updateCustomerFromAdvanceOrder(customerId) {
        const name = document.getElementById('newName').value.trim();
        const phone = document.getElementById('newPhone').value.trim();
        const email = document.getElementById('newEmail').value.trim();
        const address = document.getElementById('newAddress').value.trim();
        const unit = document.getElementById('newUnit').value.trim();
        
        if (!name) return showToast('Name required!');
        if (!phone) return showToast('Mobile number required for advance orders!');
        
        // Find and update customer
        const customer = customers.find(c => c.id === customerId || c.name === name);
        if (customer) {
          customer.name = name;
          customer.phone = phone;
          customer.email = email || customer.email;
          customer.address = address || customer.address;
          customer.unit = unit || customer.unit;
          
          localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
          
          closeModal('addCustModal');
          
          // Refresh customer dropdown
          populateAdvanceOrderCustomers(true);
          
          // Reset modal back to add mode
          resetCustomerModalToAddMode();
          
          showToast(`‚úÖ ${name}'s details updated!`);
        }
      }

      // Reset customer modal to add mode
      function resetCustomerModalToAddMode() {
        const newCustId = document.getElementById('newCustId');
        const newName = document.getElementById('newName');
        const newPhone = document.getElementById('newPhone');
        const newEmail = document.getElementById('newEmail');
        const newAddress = document.getElementById('newAddress');
        const newUnit = document.getElementById('newUnit');
        
        if (newCustId) newCustId.value = '';
        if (newName) newName.value = '';
        if (newPhone) newPhone.value = '';
        if (newEmail) newEmail.value = '';
        if (newAddress) newAddress.value = '';
        if (newUnit) newUnit.value = 'L';
        
        const modalTitle = document.querySelector('#addCustModal .panelHeader span');
        if (modalTitle) modalTitle.textContent = 'üìù Add/Edit Customer';
        
        const addBtn = document.querySelector('#addCustModal .add-btn');
        if (addBtn) {
          addBtn.textContent = '‚ûï Add Customer';
          addBtn.onclick = addNewCustomer;
        }
      }

      // Toggle advance order section visibility
      function toggleAdvanceOrder() {
        const advanceOrderSection = document.getElementById('advanceOrderSection');
        const paymentForm = el("paymentForm");
        const advanceForm = el("advanceForm");

        if (advanceOrderSection.style.display === 'none' || !advanceOrderSection.style.display) {
          // Hide payment and advance forms, show advance order
          if (paymentForm) paymentForm.style.setProperty('display', 'none', 'important');
          if (advanceForm) advanceForm.style.setProperty('display', 'none', 'important');
          advanceOrderSection.style.setProperty('display', 'flex', 'important');

          // Populate customer dropdown and auto-select first
          populateAdvanceOrderCustomers(true);

          // Sync net payable from total
          const netPayableEl = document.getElementById('advanceOrderNetPayable');
          const advancePaidEl = document.getElementById('advanceOrderPaid');
          if (netPayableEl) netPayableEl.textContent = formatINR(total);
          if (advancePaidEl) {
            advancePaidEl.value = total.toFixed(2); // Auto-fill with total
            calculateAdvanceOrderBalance(); // Calculate balance
          }

          // Set default date to tomorrow
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          document.getElementById('advanceOrderDate').value = tomorrow.toISOString().split('T')[0];
          // Set default time to 10:00 AM
          document.getElementById('advanceOrderTime').value = '10:00';

          // Update count
          updateAdvanceOrderCount();
        } else {
          // Hide advance order, show payment form
          advanceOrderSection.style.setProperty('display', 'none', 'important');
          paymentForm.style.setProperty('display', 'flex', 'important');
        }
      }

      // Calculate advance order balance
      function calculateAdvanceOrderBalance() {
        const netPayableEl = document.getElementById('advanceOrderNetPayable');
        const advancePaidEl = document.getElementById('advanceOrderPaid');
        const balanceEl = document.getElementById('advanceOrderBalance');

        if (!netPayableEl || !advancePaidEl || !balanceEl) return;

        const netPayable = total;
        const advancePaid = parseFloat(advancePaidEl.value) || 0;
        const balance = netPayable - advancePaid;

        balanceEl.textContent = formatINR(balance);
        
        // Change color based on balance
        if (balance > 0) {
          balanceEl.style.color = '#92400e'; // Orange - to collect
        } else if (balance < 0) {
          balanceEl.style.color = '#166534'; // Green - extra paid
        } else {
          balanceEl.style.color = '#166534'; // Green - exact
        }
      }

      // Clear advance order form
      function clearAdvanceOrderForm() {
        document.getElementById('advanceOrderLocation').value = '';
        document.getElementById('advanceOrderNotes').value = '';
        const customerSelect = document.getElementById('advanceOrderCustomer');
        if (customerSelect) customerSelect.value = '';
        const advancePaidEl = document.getElementById('advanceOrderPaid');
        if (advancePaidEl) {
          advancePaidEl.value = total.toFixed(2);
          calculateAdvanceOrderBalance();
        }
        showToast('Form cleared üîÑ');
      }

      // Save advance order
      function saveAdvanceOrder() {
        const customerSelect = document.getElementById('advanceOrderCustomer');
        const location = document.getElementById('advanceOrderLocation').value.trim();
        const date = document.getElementById('advanceOrderDate').value;
        const time = document.getElementById('advanceOrderTime').value;
        const notes = document.getElementById('advanceOrderNotes').value.trim();
        const advancePaidEl = document.getElementById('advanceOrderPaid');

        // Validate customer selection
        if (!customerSelect || !customerSelect.value) {
          showToast('‚ùå Please select a customer');
          return;
        }

        // Validate customer has phone number
        const customerName = customerSelect.value;
        const customer = customers.find(c => c.name === customerName);
        if (!customer || !customer.phone || customer.phone.trim() === '') {
          showToast('‚ùå Customer must have a phone number');
          openAddCustomerFromAdvanceOrder();
          return;
        }

        if (!location || !date || !time) {
          showToast('‚ùå Please fill Location, Date and Time');
          return;
        }

        const advancePaid = advancePaidEl ? (parseFloat(advancePaidEl.value) || 0) : 0;

        // Create advance order object
        const advanceOrder = {
          id: 'ao_' + Date.now(),
          customerName: customerName,
          customerPhone: customer.phone,
          location: location,
          date: date,
          time: time,
          notes: notes,
          cartItems: JSON.parse(JSON.stringify(cart)), // Copy current cart
          netPayable: total,
          advancePaid: advancePaid,
          balanceToCollect: total - advancePaid,
          createdAt: new Date().toISOString(),
          status: 'pending' // pending, completed, cancelled
        };

        // Save to localStorage
        posAdvanceOrders.push(advanceOrder);
        localStorage.setItem('posAdvanceOrders', JSON.stringify(posAdvanceOrders));

        // Clear form and hide section
        clearAdvanceOrderForm();
        toggleAdvanceOrder();

        showToast(`‚úÖ Advance Order Created for ${date} ${time}!`);
        console.log('‚úÖ Advance Order saved:', advanceOrder);

        // Update count
        updateAdvanceOrderCount();
      }

      // View advance orders - Opens full management modal
      function viewAdvanceOrders() {
        openModal('advanceOrdersModal');
        renderAdvanceOrdersList();
        updateAdvanceOrderStats();
      }

      // Render advance orders list with full details
      function renderAdvanceOrdersList(orders = null) {
        const listContainer = document.getElementById('advanceOrdersList');
        if (!listContainer) return;

        const ordersToRender = orders || posAdvanceOrders;

        if (ordersToRender.length === 0) {
          listContainer.innerHTML = `
            <div style="text-align:center; padding:60px 20px; color:#64748b;">
              <div style="font-size:64px; margin-bottom:16px;">üìÖ</div>
              <div style="font-size:18px; font-weight:700; margin-bottom:8px;">No Advance Orders</div>
              <div style="font-size:14px;">Create your first advance order to see it here</div>
            </div>
          `;
          return;
        }

        // Sort by date (earliest first)
        const sortedOrders = [...ordersToRender].sort((a, b) => {
          const dateA = new Date(`${a.date} ${a.time}`);
          const dateB = new Date(`${b.date} ${b.time}`);
          return dateA - dateB;
        });

        listContainer.innerHTML = sortedOrders.map((order, index) => {
          const isPending = order.status === 'pending';
          const daysUntil = Math.ceil((new Date(`${order.date} ${order.time}`) - new Date()) / (1000 * 60 * 60 * 24));

          let statusColor = isPending ? '#f59e0b' : (order.status === 'completed' ? '#22c55e' : '#ef4444');
          let statusText = isPending ? 'Pending' : (order.status === 'completed' ? 'Completed' : 'Cancelled');

          return `
            <div style="background:#fff; border:2px solid ${isPending ? '#f59e0b' : '#e2e8f0'}; border-radius:12px; padding:16px; margin-bottom:12px;">
              <!-- Header: Customer & Status -->
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #f1f5f9;">
                <div>
                  <div style="font-size:16px; font-weight:900; color:#1e293b; margin-bottom:4px;">
                    ${order.customerName} ${order.customerPhone ? `(${order.customerPhone})` : ''}
                  </div>
                  <div style="font-size:12px; color:#64748b;">
                    Order #${order.id.slice(-6)} ‚Ä¢ Created ${new Date(order.createdAt).toLocaleDateString('en-IN')}
                  </div>
                </div>
                <div style="text-align:right;">
                  <div style="font-size:13px; font-weight:700; color:${statusColor}; background:${statusColor}22; padding:6px 12px; border-radius:6px; display:inline-block;">
                    ${statusText}
                  </div>
                  ${isPending && daysUntil <= 1 ? `<div style="font-size:11px; color:#ef4444; font-weight:700; margin-top:4px;">‚ö†Ô∏è Due ${daysUntil <= 0 ? 'TODAY' : 'Tomorrow'}</div>` : ''}
                </div>
              </div>

              <!-- Order Details Grid -->
              <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; margin-bottom:12px;">
                <div style="background:#f8fafc; padding:10px; border-radius:8px;">
                  <div style="font-size:10px; color:#64748b; font-weight:700; margin-bottom:4px;">üìç DELIVERY LOCATION</div>
                  <div style="font-size:13px; font-weight:700; color:#1e293b;">${order.location}</div>
                </div>
                <div style="background:#f8fafc; padding:10px; border-radius:8px;">
                  <div style="font-size:10px; color:#64748b; font-weight:700; margin-bottom:4px;">üìÖ DELIVERY DATE & TIME</div>
                  <div style="font-size:13px; font-weight:700; color:#1e293b;">${new Date(order.date).toLocaleDateString('en-IN')} ‚è∞ ${order.time}</div>
                </div>
              </div>

              <!-- Financial Details -->
              <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-bottom:12px; padding:12px; background:#f0fdf4; border-radius:8px;">
                <div style="text-align:center;">
                  <div style="font-size:10px; color:#64748b; font-weight:700;">Net Payable</div>
                  <div style="font-size:16px; font-weight:900; color:#1e293b;">${formatINR(order.netPayable)}</div>
                </div>
                <div style="text-align:center;">
                  <div style="font-size:10px; color:#64748b; font-weight:700;">Advance Paid</div>
                  <div style="font-size:16px; font-weight:900; color:#22c55e;">${formatINR(order.advancePaid)}</div>
                </div>
                <div style="text-align:center;">
                  <div style="font-size:10px; color:#64748b; font-weight:700;">Balance</div>
                  <div style="font-size:16px; font-weight:900; color:${order.balanceToCollect > 0 ? '#ef4444' : '#22c55e'}">${formatINR(order.balanceToCollect)}</div>
                </div>
                <div style="text-align:center;">
                  <div style="font-size:10px; color:#64748b; font-weight:700;">Items</div>
                  <div style="font-size:16px; font-weight:900; color:#1e293b;">${order.cartItems ? order.cartItems.length : 0}</div>
                </div>
              </div>

              <!-- Cart Items Preview -->
              ${order.cartItems && order.cartItems.length > 0 ? `
                <div style="margin-bottom:12px; padding:10px; background:#f8fafc; border-radius:8px;">
                  <div style="font-size:11px; color:#64748b; font-weight:700; margin-bottom:6px;">üõí ORDER ITEMS (${order.cartItems.length})</div>
                  <div style="display:flex; flex-wrap:wrap; gap:6px;">
                    ${order.cartItems.slice(0, 5).map(item => `
                      <span style="font-size:11px; background:#fff; padding:4px 8px; border-radius:4px; border:1px solid #e2e8f0;">
                        ${item.name || 'Item'} ${item.qty ? `√ó ${item.qty}` : ''}
                      </span>
                    `).join('')}
                    ${order.cartItems.length > 5 ? `<span style="font-size:11px; color:#64748b;">+${order.cartItems.length - 5} more</span>` : ''}
                  </div>
                </div>
              ` : ''}

              <!-- Notes -->
              ${order.notes ? `
                <div style="margin-bottom:12px; padding:10px; background:#fef3c7; border-radius:8px; border-left:3px solid #f59e0b;">
                  <div style="font-size:11px; color:#92400e; font-weight:700; margin-bottom:4px;">üìù NOTES</div>
                  <div style="font-size:12px; color:#78350f;">${order.notes}</div>
                </div>
              ` : ''}

              <!-- Action Buttons -->
              <div style="display:grid; grid-template-columns:repeat(${isPending ? '4' : '2'}, 1fr); gap:8px;">
                ${isPending ? `
                  <button onclick="restoreAdvanceOrder('${order.id}')" style="padding:10px; background:#7c3aed; color:white; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:12px;">üîÑ Restore Order</button>
                  <button onclick="markOrderCompleted('${order.id}')" style="padding:10px; background:#22c55e; color:white; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:12px;">‚úÖ Mark Done</button>
                  <button onclick="sendOrderReminder('${order.id}')" style="padding:10px; background:#3b82f6; color:white; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:12px;">üîî Send Reminder</button>
                  <button onclick="cancelAdvanceOrder('${order.id}')" style="padding:10px; background:#ef4444; color:white; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:12px;">‚ùå Cancel</button>
                ` : `
                  <button onclick="viewOrderDetails('${order.id}')" style="padding:10px; background:#3b82f6; color:white; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:12px;">üìã View Details</button>
                  ${order.status === 'completed' ? `<button onclick="reopenOrder('${order.id}')" style="padding:10px; background:#f59e0b; color:white; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:12px;">üîì Reopen</button>` : ''}
                `}
              </div>
            </div>
          `;
        }).join('');
      }

      // Update advance order statistics
      function updateAdvanceOrderStats() {
        const total = posAdvanceOrders.length;
        const pending = posAdvanceOrders.filter(o => o.status === 'pending').length;
        const totalValue = posAdvanceOrders.reduce((sum, o) => sum + o.netPayable, 0);
        const toCollect = posAdvanceOrders.filter(o => o.status === 'pending').reduce((sum, o) => sum + o.balanceToCollect, 0);

        document.getElementById('aoTotalOrders').textContent = total;
        document.getElementById('aoPendingOrders').textContent = pending;
        document.getElementById('aoTotalValue').textContent = formatINR(totalValue);
        document.getElementById('aoToCollect').textContent = formatINR(toCollect);
      }

      // Filter advance orders
      function filterAdvanceOrders() {
        const searchTerm = document.getElementById('aoSearch')?.value.toLowerCase() || '';
        const statusFilter = document.getElementById('aoFilterStatus')?.value || 'all';
        const typeFilter = document.getElementById('aoFilterType')?.value || 'all';

        let filtered = posAdvanceOrders;

        // Filter by search term
        if (searchTerm) {
          filtered = filtered.filter(o =>
            o.customerName.toLowerCase().includes(searchTerm) ||
            o.location.toLowerCase().includes(searchTerm) ||
            (o.notes && o.notes.toLowerCase().includes(searchTerm))
          );
        }

        // Filter by status
        if (statusFilter !== 'all') {
          filtered = filtered.filter(o => o.status === statusFilter);
        }

        // Filter by type
        if (typeFilter !== 'all') {
          filtered = filtered.filter(o => o.orderType === typeFilter);
        }

        renderAdvanceOrdersList(filtered);
      }

      // Restore advance order (load cart and customer)
      function restoreAdvanceOrder(orderId) {
        const order = posAdvanceOrders.find(o => o.id === orderId);
        if (!order) return;

        if (!confirm(`Restore order for ${order.customerName}? This will load ${order.cartItems.length} items into cart.`)) return;

        // Load cart items
        cart = JSON.parse(JSON.stringify(order.cartItems));
        saveCart();
        renderCart();
        calculateTotal();

        // Select customer
        const customerSelect = document.getElementById('custSearch');
        if (customerSelect && order.customerName) {
          customerSelect.value = order.customerName;
          handleSearch(order.customerName);
        }

        showToast(`‚úÖ Order restored! ${order.cartItems.length} items loaded`);
        closeModal('advanceOrdersModal');
      }

      // Mark order as completed
      function markOrderCompleted(orderId) {
        const order = posAdvanceOrders.find(o => o.id === orderId);
        if (!order) return;

        if (!confirm(`Mark order for ${order.customerName} as completed?`)) return;

        order.status = 'completed';
        order.completedAt = new Date().toISOString();
        localStorage.setItem('posAdvanceOrders', JSON.stringify(posAdvanceOrders));

        renderAdvanceOrdersList();
        updateAdvanceOrderStats();
        updateAdvanceOrderCount();
        showToast('‚úÖ Order marked as completed!');
      }

      // Send order reminder via WhatsApp
      function sendOrderReminder(orderId) {
        const order = posAdvanceOrders.find(o => o.id === orderId);
        if (!order || !order.customerPhone) return;

        const message = `*üìÖ Advance Order Reminder*\n\n` +
          `*Customer:* ${order.customerName}\n` +
          `*Delivery:* ${new Date(order.date).toLocaleDateString('en-IN')} at ${order.time}\n` +
          `*Location:* ${order.location}\n` +
          `*Items:* ${order.cartItems.length}\n` +
          `*Net:* ${formatINR(order.netPayable)}\n` +
          `*Paid:* ${formatINR(order.advancePaid)}\n` +
          `*Balance:* ${formatINR(order.balanceToCollect)}\n\n` +
          `Thank you for your order! üôè`;

        const whatsappUrl = `https://wa.me/91${order.customerPhone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');

        order.reminderSent = true;
        order.reminderSentAt = new Date().toISOString();
        localStorage.setItem('posAdvanceOrders', JSON.stringify(posAdvanceOrders));

        showToast('üîî Reminder sent via WhatsApp!');
      }

      // Cancel advance order
      function cancelAdvanceOrder(orderId) {
        const order = posAdvanceOrders.find(o => o.id === orderId);
        if (!order) return;

        if (!confirm(`Cancel order for ${order.customerName}? This cannot be undone.`)) return;

        order.status = 'cancelled';
        order.cancelledAt = new Date().toISOString();
        localStorage.setItem('posAdvanceOrders', JSON.stringify(posAdvanceOrders));

        renderAdvanceOrdersList();
        updateAdvanceOrderStats();
        updateAdvanceOrderCount();
        showToast('‚ùå Order cancelled');
      }

      // View order details (for completed/cancelled)
      function viewOrderDetails(orderId) {
        const order = posAdvanceOrders.find(o => o.id === orderId);
        if (!order) return;

        alert(`Order Details:\n\n` +
          `Customer: ${order.customerName} (${order.customerPhone})\n` +
          `Status: ${order.status}\n` +
          `Date: ${order.date} ${order.time}\n` +
          `Location: ${order.location}\n` +
          `Type: ${order.orderType}\n` +
          `Net: ${formatINR(order.netPayable)}\n` +
          `Paid: ${formatINR(order.advancePaid)}\n` +
          `Balance: ${formatINR(order.balanceToCollect)}\n` +
          `Items: ${order.cartItems.length}\n` +
          `${order.notes ? `Notes: ${order.notes}` : ''}`);
      }

      // Reopen completed order
      function reopenOrder(orderId) {
        const order = posAdvanceOrders.find(o => o.id === orderId);
        if (!order) return;

        if (!confirm(`Reopen order for ${order.customerName}?`)) return;

        order.status = 'pending';
        delete order.completedAt;
        localStorage.setItem('posAdvanceOrders', JSON.stringify(posAdvanceOrders));

        renderAdvanceOrdersList();
        updateAdvanceOrderStats();
        updateAdvanceOrderCount();
        showToast('üîì Order reopened');
      }

      // Export advance orders to CSV
      function exportAdvanceOrders() {
        if (posAdvanceOrders.length === 0) {
          showToast('üìã No orders to export');
          return;
        }

        const headers = ['Order ID', 'Customer', 'Phone', 'Status', 'Type', 'Date', 'Time', 'Location', 'Net Payable', 'Paid', 'Balance', 'Items', 'Notes', 'Created'];
        const rows = posAdvanceOrders.map(o => [
          o.id,
          o.customerName,
          o.customerPhone || '',
          o.status,
          o.orderType,
          o.date,
          o.time,
          o.location,
          o.netPayable,
          o.advancePaid,
          o.balanceToCollect,
          o.cartItems ? o.cartItems.length : 0,
          o.notes || '',
          new Date(o.createdAt).toLocaleString('en-IN')
        ]);

        const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `advance_orders_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();

        showToast('üìä Exported to CSV!');
      }

      // Update advance order count
      function updateAdvanceOrderCount() {
        const pendingOrders = posAdvanceOrders.filter(o => o.status === 'pending');
        const countBadge = document.getElementById('advanceOrderCount');
        if (countBadge) countBadge.textContent = pendingOrders.length;
      }

      // Load advance orders from localStorage on page load
      function loadPosAdvanceOrders() {
        posAdvanceOrders = JSON.parse(localStorage.getItem('posAdvanceOrders') || '[]');
        updateAdvanceOrderCount();
      }
      
      // Update ledger placeholder based on toggle
      function updateLedgerPlaceholder() {
        const isCredit = document.querySelector('input[name="ledgerType"][value="credit"]').checked;
        const creditToggle = document.getElementById('creditToggle');
        const debitToggle = document.getElementById('debitToggle');

        if (isCredit) {
          creditToggle.style.background = '#f0fdf4';
          creditToggle.style.borderColor = '#22c55e';
          creditToggle.style.color = '#166534';
          debitToggle.style.background = '#fff';
          debitToggle.style.borderColor = '#e2e8f0';
          debitToggle.style.color = '#64748b';
        } else {
          debitToggle.style.background = '#fef2f2';
          debitToggle.style.borderColor = '#ef4444';
          debitToggle.style.color = '#7f1d1d';
          creditToggle.style.background = '#fff';
          creditToggle.style.borderColor = '#e2e8f0';
          creditToggle.style.color = '#64748b';
        }
        
        // Auto-save when toggling (with toast)
        updateAdvance(true);
      }

      // Update advance (give/cut) - auto-saves on amount change or toggle
      function updateAdvance(showToastMsg = false) {
        const customerName = el("activeCust").innerText;
        const amount = parseFloat(el("advanceAmount").value);
        const isCredit = document.querySelector('input[name="ledgerType"][value="credit"]').checked;

        if (!amount || amount <= 0) return;

        const customer = customers.find(c => c.name === customerName);
        if (!customer) return;

        if (!customer.advance) customer.advance = 0;
        
        // Store previous advance to calculate change
        const prevAdvance = customer.advance;

        if (isCredit) {
          customer.advance = amount; // Set to amount (not add)
        } else {
          customer.advance = -amount; // Set to negative (not subtract)
        }

        localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
        showAdvanceSection(customerName);
        
        if (showToastMsg) {
          if (isCredit) {
            showToast(`${formatINR(amount)} Udhar likha ‚úÖ`);
          } else {
            showToast(`${formatINR(amount)} Payment likha ‚úÖ`);
          }
        }
      }
      
      // Send monthly summary via WhatsApp
      function sendMonthlySummary() {
        const customerName = el("activeCust").innerText;
        const customer = customers.find(c => c.name === customerName);
        
        if (!customer) return showToast("Customer not found");
        
        const monthMilk = customer.monthMilk || 0;
        const advance = customer.advance || 0;
        
        const message = `*Monthly Summary - ${customerName}*\n\nü•õ Total Milk: ${monthMilk.toFixed(1)}L\nüí∞ Current Advance: ${formatINR(advance)}\n\nThank you for your business!`;
        
        const phone = customer.phone || "";
        const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
        
        window.open(whatsappUrl, '_blank');
        showToast("Opening WhatsApp...");
      }

      // Existing Code Logic
      let selectedProduct = null; // Track selected product for highlighting

      // Edit Product Function
      function editProduct(cardId) {
        const card = document.getElementById(cardId);
        if (!card) return;
        
        const name = card.getAttribute('data-name');
        const price = card.getAttribute('data-price');
        const unit = card.getAttribute('data-unit');
        
        const newName = prompt("Edit product name:", name);
        if (newName === null) return; // Cancelled
        
        const newPrice = prompt("Edit price (‚Çπ):", price);
        if (newPrice === null) return;
        
        const newUnit = prompt("Edit unit (L, kg, g, etc.):", unit);
        if (newUnit === null) return;
        
        // Update the card
        card.setAttribute('data-name', newName);
        card.setAttribute('data-price', newPrice);
        card.setAttribute('data-unit', newUnit);
        
        // Update display text
        const nameDiv = card.querySelector('div[style*="font-weight: 900"], div[style*="font-weight:700"]');
        const small = card.querySelector('small');
        
        if (nameDiv) nameDiv.textContent = `${newName} ${newUnit}`;
        if (small) small.textContent = `‚Çπ${newPrice}`;
        
        // Update onclick handler with new values
        const onclickAttr = card.getAttribute('onclick');
        if (onclickAttr && onclickAttr.startsWith("tapAdd(")) {
          const newOnclick = `tapAdd('${newName}', ${newPrice}, ${card.getAttribute('data-qty')})`;
          card.setAttribute('onclick', newOnclick);
        }
        
        showToast(`Product updated: ${newName} ‚úÖ`);
      }

      function tapAdd(name, rate, qty, step, emoji) {
        // Validate inputs
        if (!name || !rate || !qty) {
          console.warn('‚ö†Ô∏è tapAdd called with invalid params:', {name, rate, qty});
          return;
        }
        
        // Check if item already exists in cart - match by NAME ONLY (merge Cow Milk regardless of rate)
        const existingItem = cart.find(item => item && item.name === name);
        if (existingItem) {
          // Increase quantity of existing item (merge all Cow Milk together)
          existingItem.qty = Math.round((existingItem.qty + qty) * 10) / 10;
        } else {
          // Add new item with step size and emoji
          cart.push({name, rate, qty, step: step || qty, emoji: emoji || 'üì¶', id: Date.now()});
        }
        selectedProduct = {name, rate}; // Track for highlighting
        updateUI();
        showToast(name + " added");

        // Highlight the clicked card by finding it via onclick attribute
        highlightProductCard(name);
      }
      
      function highlightProductCard(productName) {
        // Remove highlight from all cards
        document.querySelectorAll('.p-card').forEach(card => {
          card.classList.remove('selected');
        });
        
        // Find the card by matching onclick attribute
        document.querySelectorAll('.p-card').forEach(card => {
          const onclick = card.getAttribute('onclick') || '';
          if (onclick.includes(`'${productName}'`)) {
            card.classList.add('selected');
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        });
      }
      // adjustQty removed - use inline quantity editing instead
      function updateUI() {
        const tbody = el("cartItems"); tbody.innerHTML = ""; total = 0;

        // Calculate purchase frequency for each item
        const purchaseCount = {};
        cart.forEach(item => {
          if (item && item.name) {
            purchaseCount[item.name] = (purchaseCount[item.name] || 0) + (item.qty * item.rate);
          }
        });
        const maxAmount = Math.max(...Object.values(purchaseCount), 1);

        cart.forEach((i, index) => {
          // Skip null/invalid items
          if (!i || !i.name) {
            console.warn('‚ö†Ô∏è Skipping invalid cart item at index', index);
            return;
          }
          
          const itemAmount = i.rate * i.qty;
          total += itemAmount;

          // Calculate emoji size based on quantity (scale from 48px to 72px)
          const emojiSize = Math.min(72, Math.max(48, 48 + (i.qty * 4)));

          // Calculate background darkness based on purchase amount (0-0.3 opacity)
          const bgOpacity = (purchaseCount[i.name] / maxAmount) * 0.3;
          const bgColor = `rgba(59, 130, 246, ${bgOpacity})`;

          tbody.innerHTML += `<tr style="border-bottom:1px solid #f1f5f9; background:${bgColor};" draggable="true" ondragstart="handleCartDragStart(event)" ondragover="handleCartDragOver(event)" ondrop="handleCartDrop(event)" ondragend="handleCartDragEnd(event)" data-index="${index}">
            <td style="padding:12px 0;">
              <div style="display:flex; align-items:center; gap:12px;">
                <span style="font-size:${emojiSize}px;">${i.emoji || 'üì¶'}</span>
                <div>
                  <div style="font-weight:900; font-size:20px;">${i.name}</div>
                  <div style="font-size:14px; color:var(--muted); font-weight:700;">‚Çπ${i.rate}/unit</div>
                </div>
              </div>
            </td>
            <td style="padding:12px 4px;">
              <div style="display:flex; align-items:center; gap:4px;">
                <button onclick="decreaseQty(${index})" style="width:40px; height:40px; border:1px solid #e2e8f0; background:#f8fafc; border-radius:8px; font-weight:900; font-size:24px; cursor:pointer; color:#64748b;">‚àí</button>
                <input type="number" value="${i.qty}" min="0.1" step="0.1"
                  onchange="updateItemQty(${index}, this.value)"
                  onblur="updateItemQty(${index}, this.value)"
                  style="width:90px; padding:10px; border:2px solid #3b82f6; border-radius:8px; font-weight:900; text-align:center; font-size:20px;"
                  title="Edit Quantity" />
                <button onclick="increaseQty(${index})" style="width:40px; height:40px; border:1px solid #e2e8f0; background:#f8fafc; border-radius:8px; font-weight:900; font-size:24px; cursor:pointer; color:#16a34a;">+</button>
              </div>
            </td>
            <td style="padding:12px 4px;">
              <div style="display:flex; align-items:center; gap:4px;">
                <button onclick="decreaseAmount(${index})" style="width:40px; height:40px; border:1px solid #e2e8f0; background:#f8fafc; border-radius:8px; font-weight:900; font-size:24px; cursor:pointer; color:#dc2626;" title="Decrease ‚Çπ10">‚àí</button>
                <input type="number" value="${itemAmount.toFixed(2)}"
                  onchange="updateItemAmount(${index}, this.value)"
                  onblur="updateItemAmount(${index}, this.value)"
                  style="width:110px; padding:10px; border:2px solid #16a34a; border-radius:8px; font-weight:900; text-align:right; font-size:20px;"
                  title="Edit Amount (auto-calculates rate)" />
                <button onclick="increaseAmount(${index})" style="width:40px; height:40px; border:1px solid #e2e8f0; background:#f8fafc; border-radius:8px; font-weight:900; font-size:24px; cursor:pointer; color:#16a34a;" title="Increase ‚Çπ10">+</button>
              </div>
            </td>
            <td style="padding:12px 0; text-align:right;">
              <button onclick="removeItem(${index})" style="background:#fecaca; color:#dc2626; border:none; border-radius:8px; padding:10px 16px; cursor:pointer; font-weight:900; font-size:14px;">‚úï Remove</button>
            </td>
          </tr>`;
        });

        // Update total display (if element exists)
        const totalAmt = el("totalAmt");
        if (totalAmt) {
          totalAmt.textContent = formatINR(total);
        }

        // Sync total payable display
        updateTotalPayableDisplay();

        // Update payment amount field - auto-update but keep editable
        const paymentInput = el("paymentAmount");
        if (paymentInput) {
          // Only auto-update if field is empty OR if it matches the previous total
          const currentValue = parseFloat(paymentInput.value) || 0;
          const wasExactMatch = Math.abs(currentValue - (parseFloat(paymentInput.dataset.prevTotal) || 0)) < 0.01;

          if (!paymentInput.value || wasExactMatch || currentValue === total) {
            paymentInput.value = formatIndianNumber(total);
          }
          paymentInput.dataset.prevTotal = total.toFixed(2);
        }

        // Recalculate credit if payment amount exists
        if (paymentInput && paymentInput.value) {
          calculateCredit();
        }

        // Update product card quantity badges
        updateCardBadges();
        
        // Auto-save cart changes
        scheduleAutoSave();
      }
      
      // Indian number formatting (lakhs and crores system)
      function formatIndianNumber(num) {
        if (num === null || num === undefined || isNaN(num)) return '0.00';
        const parts = num.toString().split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{2})+(?!\d)(?=(\d{3})))/g, ',');
        return parts[1] ? parts.join('.') : parts[0] + '.00';
      }
      
      // Format currency in Indian system
      function formatINR(num) {
        return '‚Çπ' + formatIndianNumber(num);
      }
      
      // Get emoji for product name (case-insensitive matching)
      function getEmojiForProduct(name) {
        if (!name) return 'üì¶';
        
        const nameLower = name.toLowerCase();
        
        // Extended emoji mappings for dairy products
        const emojiMap = [
          { keywords: ['cow'], emoji: 'üêÑ' },
          { keywords: ['buff', 'buffalo'], emoji: 'üêÉ' },
          { keywords: ['paneer'], emoji: 'üßÄ' },
          { keywords: ['ghee'], emoji: 'üçØ' },
          { keywords: ['milk cake', 'cake'], emoji: 'üç∞' },
          { keywords: ['curd', 'dahi', 'yogurt'], emoji: 'ü•õ' },
          { keywords: ['milk', 'doodh'], emoji: 'ü•õ' },
          { keywords: ['butter', 'makhan'], emoji: 'üßà' },
          { keywords: ['cream', 'malai'], emoji: 'ü•õ' },
          { keywords: ['lassi'], emoji: 'ü•§' },
          { keywords: ['sweet', 'mithai'], emoji: 'üç¨' },
          { keywords: ['ice cream', 'icecream'], emoji: 'üç¶' },
          { keywords: ['cheese'], emoji: 'üßÄ' },
          { keywords: ['chocolate'], emoji: 'üç´' },
          { keywords: ['cookie', 'biscuit'], emoji: 'üç™' },
          { keywords: ['bread'], emoji: 'üçû' },
          { keywords: ['egg'], emoji: 'ü•ö' },
          { keywords: ['chicken'], emoji: 'üçó' },
          { keywords: ['mutton', 'meat'], emoji: 'ü•©' },
          { keywords: ['fish'], emoji: 'üêü' },
          { keywords: ['rice', 'chawal'], emoji: 'üçö' },
          { keywords: ['roti', 'chapati'], emoji: 'ü´ì' },
          { keywords: ['dal', 'pulse'], emoji: 'ü•ò' },
          { keywords: ['vegetable', 'sabzi', 'veg'], emoji: 'ü•¨' },
          { keywords: ['fruit'], emoji: 'üçé' },
          { keywords: ['juice'], emoji: 'üßÉ' },
          { keywords: ['water'], emoji: 'üíß' },
          { keywords: ['tea', 'chai'], emoji: '‚òï' },
          { keywords: ['coffee'], emoji: '‚òï' },
          { keywords: ['sugar'], emoji: 'üç¨' },
          { keywords: ['salt'], emoji: 'üßÇ' },
          { keywords: ['oil'], emoji: 'ü´ó' },
          { keywords: ['flour', 'atta'], emoji: 'üåæ' },
          { keywords: ['spice', 'masala'], emoji: 'üå∂Ô∏è' }
        ];
        
        // Find matching emoji
        for (const mapping of emojiMap) {
          for (const keyword of mapping.keywords) {
            if (nameLower.includes(keyword)) {
              return mapping.emoji;
            }
          }
        }
        
        return 'üì¶'; // Default
      }
      
      // Get emoji combo link for product name
      function getEmojiComboLink(productName) {
        const searchTerm = productName.toLowerCase().replace(/[^a-z0-9]/g, '-');
        return `https://emojicombos.com/${searchTerm}`;
      }
      
      // Update emoji link when product name changes
      function updateEmojiLink(productName) {
        const link = document.getElementById('emojiComboLink');
        if (link && productName) {
          link.href = getEmojiComboLink(productName);
          link.textContent = `üîó Copy "${productName}" emojis from EmojiCombos`;
        }
      }
      
      // Dairy-related unit suggestions
      const dairyUnits = [
        { value: 'L', label: 'Liter', emoji: 'ü•õ' },
        { value: 'ml', label: 'Milliliter', emoji: 'üß™' },
        { value: 'kg', label: 'Kilogram', emoji: '‚öñÔ∏è' },
        { value: 'g', label: 'Gram', emoji: 'ü•Ñ' },
        { value: 'pcs', label: 'Pieces', emoji: 'üî¢' },
        { value: 'box', label: 'Box', emoji: 'üì¶' },
        { value: 'packet', label: 'Packet', emoji: 'üìÆ' },
        { value: 'bottle', label: 'Bottle', emoji: 'üçº' }
      ];
      
      // Decrease quantity (uses item's step size)
      function decreaseQty(index) {
        const step = cart[index].step || 0.5; // Use item's step or default to 0.5
        const newQty = Math.max(0.1, cart[index].qty - step);
        cart[index].qty = Math.round(newQty * 10) / 10;
        if (cart[index].qty <= 0) {
          removeItem(index);
        } else {
          updateUI();
        }
      }

      // Increase quantity (uses item's step size)
      function increaseQty(index) {
        const step = cart[index].step || 0.5; // Use item's step or default to 0.5
        cart[index].qty = Math.round((cart[index].qty + step) * 10) / 10;
        updateUI();
      }

      // Decrease amount by ‚Çπ10
      function decreaseAmount(index) {
        const newAmount = Math.max(0, cart[index].qty * cart[index].rate - 10);
        cart[index].qty = Math.round((newAmount / cart[index].rate) * 10) / 10;
        if (cart[index].qty <= 0) {
          removeItem(index);
        } else {
          updateUI();
        }
      }

      // Increase amount by ‚Çπ10
      function increaseAmount(index) {
        const newAmount = cart[index].qty * cart[index].rate + 10;
        cart[index].qty = Math.round((newAmount / cart[index].rate) * 10) / 10;
        updateUI();
      }

      // Update quantity badges on product cards
      function updateCardBadges() {
        try {
          // Reset all badges first
          document.querySelectorAll('.qty-badge').forEach(badge => {
            badge.style.display = 'none';
          });

          // Remove all highlights and reset icon sizes
          document.querySelectorAll('.p-card').forEach(card => {
            card.style.boxShadow = '';
            card.style.border = '';
            const emoji = card.querySelector('.emoji');
            if (emoji) {
              // Reset to default size based on card data-qty
              const defaultQty = parseFloat(card.getAttribute('data-qty'));
              if (defaultQty >= 2) {
                emoji.style.fontSize = '56px';
              } else if (defaultQty >= 1) {
                emoji.style.fontSize = '48px';
              } else {
                emoji.style.fontSize = '32px';
              }
            }
          });

          // Update badges for items in cart
          cart.forEach(item => {
            // Skip invalid items
            if (!item || !item.name) {
              console.warn('‚ö†Ô∏è Skipping invalid cart item:', item);
              return;
            }
            
            // Find card by ID based on product name
            let cardId = null;
            if (item.name === 'Cow 1L') cardId = 'prod-cow-1l';
            else if (item.name === 'Cow 0.5L') cardId = 'prod-cow-05l';
            else if (item.name === 'Buff 2L') cardId = 'prod-buff-2l';
            else if (item.name === 'Buff 1L') cardId = 'prod-buff-1l';
            else if (item.name === 'Buff 0.5L') cardId = 'prod-buff-05l';
            else if (item.name === 'Paneer') cardId = 'prod-paneer';
            else if (item.name === 'Ghee') cardId = 'prod-ghee';
            else if (item.name === 'Milk Cake') cardId = 'prod-milkcake';

            if (cardId) {
              const card = document.getElementById(cardId);
              if (card) {
                const badge = card.querySelector('.qty-badge');
                const emoji = card.querySelector('.emoji');
                const nameDiv = card.querySelector('div[style*="font-weight: 900"]');

                if (badge) {
                  // Show badge with quantity
                  badge.textContent = item.qty;
                  badge.style.display = 'block';

                  // Highlight based on quantity
                  if (item.qty >= 2) {
                    card.style.boxShadow = '0 0 0 3px #dc2626';
                    card.style.border = '2px solid #dc2626';
                  } else if (item.qty >= 1) {
                    card.style.boxShadow = '0 0 0 3px #3b82f6';
                    card.style.border = '2px solid #3b82f6';
                  } else {
                    card.style.boxShadow = '0 0 0 3px #16a34a';
                    card.style.border = '2px solid #16a34a';
                  }
                }

                // Update icon size based on cart quantity
                if (emoji) {
                  if (item.qty >= 2) {
                    emoji.style.fontSize = '64px';
                    emoji.style.filter = 'brightness(1.2)';
                  } else if (item.qty >= 1) {
                    emoji.style.fontSize = '52px';
                    emoji.style.filter = 'brightness(1.1)';
                  } else {
                    emoji.style.fontSize = '36px';
                    emoji.style.filter = 'brightness(1)';
                  }
                }

                // Update name to show quantity
                if (nameDiv) {
                  const baseName = item.name;
                  nameDiv.textContent = `${baseName} (${item.qty}x)`;
                }
              }
            }
          });
        } catch (error) {
          console.error('Error updating card badges:', error);
        }
      }
      
      // Load customer memory (previous orders)
      function loadCustomerMemory(customerName) {
        if (!customerName || customerName === 'Walking Customer') return;
        
        const memory = JSON.parse(localStorage.getItem('mr_customer_memory') || '{}');
        const customerMemory = memory[customerName];
        
        if (customerMemory && customerMemory.items && customerMemory.items.length > 0) {
          // Clear current cart
          cart = [];
          
          // Load previous items
          customerMemory.items.forEach(item => {
            cart.push({
              name: item.name,
              rate: item.rate,
              qty: item.qty,
              emoji: item.emoji || 'üì¶'
            });
          });

          updateUI();
          showToast(`Loaded memory: ${customerMemory.items.length} items ‚úÖ`);
        }
      }
      
      // Save customer memory
      function saveCustomerMemory(customerName) {
        if (!customerName || customerName === 'Walking Customer') return;
        
        const memory = JSON.parse(localStorage.getItem('mr_customer_memory') || '{}');
        
        memory[customerName] = {
          items: JSON.parse(JSON.stringify(cart)),
          lastUpdated: Date.now()
        };
        
        localStorage.setItem('mr_customer_memory', JSON.stringify(memory));
      }
      
      // Update item quantity (amount auto-calculates)
      function updateItemQty(index, newQty) {
        const qty = parseFloat(newQty);
        if (qty > 0) {
          cart[index].qty = qty;
          updateUI();
        } else {
          removeItem(index);
        }
      }
      
      // Update item amount (quantity auto-calculates)
      function updateItemAmount(index, newAmount) {
        const amount = parseFloat(newAmount);
        if (amount > 0 && cart[index].rate > 0) {
          cart[index].qty = amount / cart[index].rate;
          updateUI();
        } else {
          removeItem(index);
        }
      }
      
      // Remove item from cart
      function removeItem(index) {
        cart.splice(index, 1);
        updateUI();
        showToast("Item removed");
      }

      // Save entry - FULLY OFFLINE MODE
      async function saveEntry(mode) {
        if(total === 0) return showToast("Cart empty");

        const custName = el("activeCust").innerText;
        const customer = customers.find(c => c.name === custName);
        const customerPhone = customer?.phone;
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const itemsDetail = cart.map(i => `${i.qty}x ${i.name}`).join(" | ");

        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Saving...';

        try {
          // 1. Find or create customer (offline)
          let customerId = null;
          let existingCustomer = customers.find(c => c.name.toLowerCase() === custName.toLowerCase());

          if (!existingCustomer && custName !== "Walking Customer") {
            // Create new customer locally
            customerId = "cust_" + Date.now();
            const newCustomer = {
              id: customerId,
              name: custName,
              phone: "",
              balance: 0,
              advance: 0,
              monthMilk: 0,
              createdAt: Date.now()
            };
            customers.push(newCustomer);
            localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
          } else if (existingCustomer) {
            customerId = existingCustomer.id;
          }

          // 2. Calculate credit amount
          const paymentAmount = parseFloat(el("paymentAmount").value) || total;
          const creditAmount = mode === 'Credit' ? total : Math.max(0, total - paymentAmount);

          // 3. Save sale locally (offline mode)
          const saleData = {
            id: "sale_" + Date.now(),
            customer_id: customerId,
            customer_name: custName,
            items: JSON.parse(JSON.stringify(cart)),
            total_amount: total,
            paid_amount: paymentAmount,
            credit_amount: creditAmount,
            payment_mode: mode.toLowerCase(),
            createdAt: Date.now()
          };

          // Save to localStorage
          const sales = JSON.parse(localStorage.getItem('mr_pos_sales') || '[]');
          sales.push(saleData);
          localStorage.setItem('mr_pos_sales', JSON.stringify(sales));

          console.log('‚úÖ Sale saved locally:', saleData);

          // 4. Update customer balance if credit (offline)
          if (creditAmount > 0 && customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
              customer.balance = (customer.balance || 0) + creditAmount;
              localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
            }
          }

          // Save customer memory (for auto-fill next time)
          saveCustomerMemory(custName);

          // 5. Update local history for immediate UI
          const invoiceId = "INV-" + Date.now().toString().slice(-6);
          const newSale = {
            date: new Date().toLocaleDateString(),
            time,
            customer: custName,
            products: itemsDetail,
            amount: total.toFixed(2),
            method: mode,
            paidAmount: paymentAmount.toFixed(2),
            creditAmount: creditAmount.toFixed(2),
            cartItems: JSON.parse(JSON.stringify(cart)),
            invoiceId: invoiceId,
            createdAt: Date.now()
          };

          exportHistory.push(newSale);
          localStorage.setItem('mr_sales_history', JSON.stringify(exportHistory));

          // 6. Update UI
          const entry = `<div class="cardRow" style="flex-direction:column; align-items:flex-start; gap:4px; cursor:pointer;" onclick="loadOrderFromHistory('${custName}', ${JSON.stringify(cart).replace(/"/g, '&quot;')})">
            <div style="width:100%; display:flex; justify-content:space-between;">
              <b>${custName}</b><b>${formatINR(total)}</b>
            </div>
            <div style="font-size:11px; color:var(--muted); font-weight:700;">
              ${time} ‚Ä¢ üõí ${itemsDetail} ‚Ä¢ ${modeIcon(mode)} ${mode}
              ${creditAmount > 0 ? `<span style="color:#dc2626; font-weight:700;"> ‚Ä¢ üìï ${formatINR(creditAmount)} Udhar</span>` : ''}
              <span style="color:var(--blue); font-weight:700; margin-left:8px;">üîÅ Click to reload</span>
            </div>
          </div>`;
          el("historyToday").innerHTML = entry + el("historyToday").innerHTML;

          // 7. Auto-print invoice (silent, no user interaction)
          generateInvoice(custName, paymentAmount, mode, creditAmount);

          // 8. Play success sound
          playSuccessSound();

          // 9. Show success message with clear feedback
          if (creditAmount > 0) {
            showToast(`üìí Udhar: ${formatINR(creditAmount)} added to ledger! ‚úÖ`);
          } else {
            showToast(`üíµ Paid: ${formatINR(paymentAmount)} received! ‚úÖ`);
          }

          // 10. Reset cart and prepare for next customer
          resetCart();
          
          // 10b. Check onboarding progress (first invoice created!)
          checkOnboardingProgress();

          // 11. If customer has phone and it's credit mode, offer WhatsApp
          if (creditAmount > 0 && customerPhone && customerPhone.length >= 10) {
            setTimeout(() => {
              if (confirm(`Send WhatsApp reminder to ${custName}?`)) {
                sendWhatsAppReminder(custName, customerPhone, creditAmount, total);
              }
            }, 1000);
          }

        } catch (error) {
          console.error('Error saving sale:', error);
          showToast('‚ùå Failed to save: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }
      
      // Auto-download invoice (SILENT - no print dialog, no focus change)
      function downloadInvoiceAuto(customerName, paymentAmount, paymentMode, creditAmount, invoiceId) {
        const date = new Date();
        const dateStr = date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
        const timeStr = date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        const invoiceNo = `INV-${invoiceId ? invoiceId.substring(0,8).toUpperCase() : Date.now().toString().substring(5)}`;
        
        // Get shop name from session
        const session = localStorage.getItem('MilkRecord_session');
        const shopName = session ? JSON.parse(session).shop_name : 'MilkRecord POS';
        
        // Create simple text invoice for download
        let invoiceText = `${shopName}\n`;
        invoiceText += `${invoiceNo} | ${dateStr} ${timeStr}\n`;
        invoiceText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
        invoiceText += `Customer: ${customerName}\n`;
        invoiceText += `Payment: ${paymentMode} - ${formatINR(paymentAmount)}\n\n`;
        invoiceText += `ITEMS:\n`;
        cart.forEach(item => {
          invoiceText += `  ${item.name} x${item.qty} @ ‚Çπ${item.rate} = ‚Çπ${(item.qty * item.rate).toFixed(2)}\n`;
        });
        invoiceText += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        invoiceText += `TOTAL: ${formatINR(total)}\n`;
        if (creditAmount > 0) {
          invoiceText += `CREDIT (Udhar): ${formatINR(creditAmount)}\n`;
        }
        invoiceText += `\nThank you! üôè\n`;
        invoiceText += `${shopName}\n`;
        
        // Create blob and download SILENTLY (no print, no focus)
        const blob = new Blob([invoiceText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Invoice-${invoiceNo}.txt`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // No console log, no alert - completely silent
      }
      
      // Send WhatsApp reminder for credit
      function sendWhatsAppReminder(customerName, phone, creditAmount, total) {
        const session = localStorage.getItem('MilkRecord_session');
        const shopName = session ? JSON.parse(session).shop_name : 'MilkRecord POS';
        const date = new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
        
        let message = `*${shopName}*\n`;
        message += `üìÖ ${date}\n\n`;
        message += `Hi ${customerName},\n`;
        message += `Your credit balance: *${formatINR(creditAmount)}*\n`;
        message += `Total purchase: ${formatINR(total)}\n\n`;
        message += `Items:\n`;
        cart.forEach(item => {
          message += `‚Ä¢ ${item.name} (${item.qty}) - ${formatINR(item.qty * item.rate)}\n`;
        });
        message += `\nPlease settle soon. Thank you! üôè`;
        
        const whatsappUrl = `https://wa.me/91${phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
      }

// Get payment mode icon
function modeIcon(mode) {
    if (mode === 'Credit' || mode === 'Udhar') return 'üìï';
    if (mode === 'UPI') return 'üì±';
    return 'üíµ';
}

// Load order from history (clickable history items)
function loadOrderFromHistory(customerName, cartItems) {
  // Set customer
  el("activeCust").innerText = customerName;
  el("custSearch").value = customerName;
  
  // Load cart items
  cart = cartItems.map(item => ({...item, id: Date.now() + Math.random()}));
  
  // Update UI
  updateUI();
  closeModal('historyModal');
  showToast(`Loaded order for ${customerName}`);
}

// Switch history tab (today/all)
function switchHistoryTab(tab) {
  const todayDiv = el("historyToday");
  const allDiv = el("historyWeekly"); // Reusing same div for all history
  const tabToday = el("tabToday");
  const tabAll = el("tabAll");
  
  if (tab === 'today') {
    todayDiv.style.display = 'block';
    allDiv.style.display = 'none';
    tabToday.style.borderBottomColor = 'var(--blue)';
    tabAll.style.borderBottomColor = 'transparent';
    loadHistoryOnStart();
  } else {
    todayDiv.style.display = 'none';
    allDiv.style.display = 'block';
    tabToday.style.borderBottomColor = 'transparent';
    tabAll.style.borderBottomColor = 'var(--blue)';
    renderAllHistory();
  }
}

// Render ALL history (no date limit) - Shows Sales + Cash In/Out + Credit/Debit
function renderAllHistory() {
  const container = el("historyWeekly");

  if (exportHistory.length === 0) {
    container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted);">No sales history yet</div>';
    return;
  }

  // Show ALL history, newest first
  const allHistory = [...exportHistory].reverse();

  container.innerHTML = allHistory.map((sale, i) => {
    // Get payment mode icon
    let modeIcon = 'üíµ';
    let modeText = sale.method;
    let cardStyle = '';
    
    if (sale.method === 'Credit' || sale.method === 'Udhar') {
      modeIcon = 'üìí';
      modeText = 'Credit';
      cardStyle = 'border-left: 4px solid #dc2626;';
    } else if (sale.method === 'UPI') {
      modeIcon = 'üì±';
    } else if (sale.method === 'Cash In') {
      modeIcon = 'üí∞';
      modeText = 'Cash In';
      cardStyle = 'border-left: 4px solid #16a34a; background: #f0fdf4;';
    } else if (sale.method === 'Cash Out') {
      modeIcon = 'üí∏';
      modeText = 'Cash Out';
      cardStyle = 'border-left: 4px solid #f59e0b; background: #fffbeb;';
    }

    // Show items list
    const itemsList = (sale.cartItems && sale.cartItems.length > 0) ? 
      (sale.cartItems || []).map(item =>
        `${getEmojiForProduct(item.name)} ${item.name} (${item.qty} √ó ‚Çπ${item.rate})`
      ).join('<br>') : 
      (sale.products || 'Cash Transaction');

    const isCashFlow = sale.method === 'Cash In' || sale.method === 'Cash Out';

    return `
    <div class="cardRow" style="cursor:pointer; padding:12px; ${cardStyle}" onclick="${isCashFlow ? '' : `loadOrderFromHistory('${sale.customer.replace(/'/g, "\\'")}', ${JSON.stringify(sale.cartItems || []).replace(/"/g, '&quot;')})`}">
      <div style="flex:1">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <b style="font-size:15px;">${sale.customer}</b>
          <b style="color:var(--blue); font-size:16px;">‚Çπ${sale.amount}</b>
        </div>
        <div style="margin:6px 0; font-size:13px; color:#64748b;">
          ${itemsList}
        </div>
        <div style="display:flex; gap:12px; font-size:12px; color:#94a3b8; font-weight:700; align-items:center;">
          <span>üìÖ ${sale.date} ${sale.time}</span>
          <span>${modeIcon} ${modeText}</span>
          ${sale.creditAmount > 0 ? `<span style="color:#dc2626; font-weight:900;">üìí Due: ${formatINR(sale.creditAmount)}</span>` : ''}
          ${sale.creditAmount === 0 && !isCashFlow ? `<span style="color:#16a34a; font-weight:700;">‚úÖ Paid</span>` : ''}
        </div>
      </div>
    </div>
  `}).join('');

  // Update count
  const todayCount = exportHistory.filter(s => s.date === new Date().toLocaleDateString()).length;
  el("historyCount").textContent = `${todayCount} today ‚Ä¢ ${exportHistory.length} total`;
}

// Update history count (for Cash In/Out)
function updateHistoryCount() {
  const todayCount = exportHistory.filter(s => s.date === new Date().toLocaleDateString()).length;
  el("historyCount").textContent = `${todayCount} today ‚Ä¢ ${exportHistory.length} total`;
}

// Export history to Excel - Includes Sales + Cash In/Out + Credit/Debit
function downloadHistoryExcel() {
  if (exportHistory.length === 0) return showToast("No history to export!");

  const today = new Date().toISOString().split('T')[0];
  
  // Create Excel-compatible HTML table
  let html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid black; padding: 8px; text-align: left; }
    th { background-color: #4CAF50; color: white; font-weight: bold; }
    tr:nth-child(even) { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <h2>MilkRecord POS - Sales History (${today})</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Time</th>
        <th>Invoice No</th>
        <th>Customer</th>
        <th>Items</th>
        <th>Qty</th>
        <th>Total Amount</th>
        <th>Paid</th>
        <th>Payment Method</th>
        <th>Credit/Udhar</th>
      </tr>
    </thead>
    <tbody>
`;

  exportHistory.forEach(r => {
    const items = (r.cartItems || []).map(i => `${i.name}`).join(", ") || r.products || "Cash Transaction";
    const qty = (r.cartItems || []).reduce((sum, i) => sum + (i.qty || 0), 0) || 0;
    const paid = r.method === 'Credit' ? 0 : (r.amount - (r.credit || 0));
    
    html += `
      <tr>
        <td>${r.date || ''}</td>
        <td>${r.time || ''}</td>
        <td>${r.invoiceId || ''}</td>
        <td>${r.customer.replace(/"/g, "'") || ''}</td>
        <td>${items.replace(/"/g, "'")}</td>
        <td style="text-align:center;">${qty}</td>
        <td style="text-align:right;">‚Çπ${r.amount || 0}</td>
        <td style="text-align:right;">‚Çπ${paid}</td>
        <td>${r.method || ''}</td>
        <td style="text-align:right; color: ${r.credit ? 'red' : 'black'};">${r.credit ? '‚Çπ' + r.credit : ''}</td>
      </tr>
    `;
  });

  html += `
    </tbody>
  </table>
  <p style="margin-top: 20px; font-size: 12px; color: #666;">
    Generated: ${new Date().toLocaleString()} | Total Records: ${exportHistory.length}
  </p>
</body>
</html>`;

  const blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8;' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.setAttribute("href", url);
  a.setAttribute("download", `MilkRecord_Sales_History_${today}.xls`);
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  showToast("Excel Exported! üìä‚úÖ");
}

// Export history to PDF
function downloadHistoryPDF() {
  if (exportHistory.length === 0) return showToast("No history to export!");

  const today = new Date().toISOString().split('T')[0];
  
  // Create print-friendly HTML
  let html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dairy POS Billing Software India - Free POS System for Milk Shops | MilkRecord</title>
  <style>
    @media print {
      @page { margin: 1cm; size: A4 landscape; }
      body { font-family: Arial, sans-serif; font-size: 11px; }
      .no-print { display: none; }
    }
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 10px; }
    th { background-color: #4CAF50; color: white; font-weight: bold; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .amount { text-align: right; }
    .credit { color: red; font-weight: bold; }
    .summary { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>Dairy POS Billing Software for Indian Milk Shops</h1>
  <div class="summary">
    <strong>Date:</strong> ${today} | 
    <strong>Total Records:</strong> ${exportHistory.length} |
    <strong>Generated:</strong> ${new Date().toLocaleString()}
  </div>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Time</th>
        <th>Invoice</th>
        <th>Customer</th>
        <th>Items</th>
        <th class="amount">Amount</th>
        <th class="amount">Paid</th>
        <th>Method</th>
        <th class="amount">Credit</th>
      </tr>
    </thead>
    <tbody>
`;

  let totalAmount = 0, totalPaid = 0, totalCredit = 0;
  
  exportHistory.forEach(r => {
    const items = (r.cartItems || []).map(i => `${i.name} (${i.qty})`).join(", ") || r.products || '-';
    const paid = r.method === 'Credit' ? 0 : (parseFloat(r.amount) - (parseFloat(r.credit) || 0));
    const credit = parseFloat(r.credit) || 0;
    
    totalAmount += parseFloat(r.amount) || 0;
    totalPaid += paid;
    totalCredit += credit;
    
    html += `
      <tr>
        <td>${r.date || '-'}</td>
        <td>${r.time || '-'}</td>
        <td>${r.invoiceId || '-'}</td>
        <td>${(r.customer || '').replace(/"/g, "'")}</td>
        <td>${items.replace(/"/g, "'")}</td>
        <td class="amount">‚Çπ${r.amount || 0}</td>
        <td class="amount">‚Çπ${paid.toFixed(2)}</td>
        <td>${r.method || '-'}</td>
        <td class="amount ${credit ? 'credit' : ''}">${credit ? '‚Çπ' + credit.toFixed(2) : '-'}</td>
      </tr>
    `;
  });

  html += `
      <tr style="background: #e8f5e9; font-weight: bold;">
        <td colspan="5">TOTAL</td>
        <td class="amount">‚Çπ${totalAmount.toFixed(2)}</td>
        <td class="amount">‚Çπ${totalPaid.toFixed(2)}</td>
        <td></td>
        <td class="amount credit">‚Çπ${totalCredit.toFixed(2)}</td>
      </tr>
    </tbody>
  </table>
  <div class="no-print" style="margin-top: 20px;">
    <button onclick="window.print()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">üñ®Ô∏è Print / Save as PDF</button>
  </div>
</body>
</html>`;

  const printWindow = window.open('', '_blank');
  printWindow.document.write(html);
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => {
    printWindow.print();
    printWindow.close();
  }, 500);
}

// Record Cash In transaction - NO customer needed
function recordCashIn(amount, note = "") {
  if (!amount || amount <= 0) return showToast("Enter valid amount!");

  const newTransaction = {
    id: "cashin_" + Date.now(),
    date: new Date().toLocaleDateString(),
    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
    customer: "üí∞ Cash In",
    products: note || "Cash received",
    amount: parseFloat(amount),
    method: "Cash In",
    creditAmount: 0,
    cartItems: [],
    type: "cash_flow" // Mark as cash flow transaction
  };

  exportHistory.push(newTransaction);
  localStorage.setItem('mr_sales_history', JSON.stringify(exportHistory));
  localStorage.setItem('mr_sales_history_backup', JSON.stringify(exportHistory));
  localStorage.setItem('mr_sales_history_backup2', JSON.stringify(exportHistory));

  renderAllHistory();
  updateHistoryCount();
  showToast(`üí∞ Cash In: ${formatINR(amount)} recorded!`);
}

// Record Cash Out transaction - NO customer needed
function recordCashOut(amount, note = "") {
  if (!amount || amount <= 0) return showToast("Enter valid amount!");

  const newTransaction = {
    id: "cashout_" + Date.now(),
    date: new Date().toLocaleDateString(),
    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
    customer: "üí∏ Cash Out",
    products: note || "Cash paid",
    amount: parseFloat(amount),
    method: "Cash Out",
    creditAmount: 0,
    cartItems: [],
    type: "cash_flow" // Mark as cash flow transaction
  };

  exportHistory.push(newTransaction);
  localStorage.setItem('mr_sales_history', JSON.stringify(exportHistory));
  localStorage.setItem('mr_sales_history_backup', JSON.stringify(exportHistory));
  localStorage.setItem('mr_sales_history_backup2', JSON.stringify(exportHistory));

  renderAllHistory();
  updateHistoryCount();
  showToast(`üí∏ Cash Out: ${formatINR(amount)} recorded!`);
}

// Quick Cash In - Direct entry without prompts
function quickCashIn() {
  const amount = prompt("üí∞ Enter Cash In Amount (‚Çπ):", "");
  if (!amount || isNaN(amount) || parseFloat(amount) <= 0) return showToast("Invalid amount!");
  const note = prompt("üìù Purpose (optional):", "Cash received") || "Cash received";
  recordCashIn(parseFloat(amount), note);
}

// Quick Cash Out - Direct entry without prompts
function quickCashOut() {
  const amount = prompt("üí∏ Enter Cash Out Amount (‚Çπ):", "");
  if (!amount || isNaN(amount) || parseFloat(amount) <= 0) return showToast("Invalid amount!");
  const note = prompt("üìù Purpose (optional):", "Cash paid") || "Cash paid";
  recordCashOut(parseFloat(amount), note);
}

// Clear today's history
function clearTodayHistory() {
  const today = new Date().toLocaleDateString();
  if (!confirm(`Clear all ${today} sales? This cannot be undone!`)) return;

  exportHistory = exportHistory.filter(sale => sale.date !== today);
  localStorage.setItem('mr_sales_history', JSON.stringify(exportHistory));
  loadHistoryOnStart();
  renderAllHistory();
  showToast("Today's history cleared! üóëÔ∏è");
}

      function exportDetailedExcel() {
    // 1. Check if history exists
    if(exportHistory.length === 0) return showToast("No sales to export!");

    // 2. CSV Header (Point 21: Institutional Export)
    let csv = "Date,Time,Customer,Products,Amount,Payment Method\n";

    // 3. Row Logic
    exportHistory.forEach(r => {
        // Customer ya Product name mein agar comma ho toh use clean karna
        let safeCust = r.customer.replace(/,/g, "");
        let safeProd = r.products.replace(/,/g, " | "); // Comma handling
        
        csv += `${r.date},${r.time},${safeCust},"${safeProd}",${r.amount},${r.method}\n`;
    });

    // --- ‚úÖ 4. ADDED: File Creation & Auto-Download Logic ---
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    
    // File name format (e.g., MilkRecord_Report_2026-02-16.csv)
    const fileName = `MilkRecord_Report_${new Date().toISOString().split('T')[0]}.csv`;
    
    a.setAttribute("href", url);
    a.setAttribute("download", fileName);
    document.body.appendChild(a); // Temporary addition
    a.click(); // Trigger click to download
    document.body.removeChild(a); // Cleanup

    showToast("Excel Exported! üìä‚úÖ");
}

      // Update customer display in summary panel
      function updateCustomerDisplay() {
        const customerName = el("activeCust").innerText;
        const phoneDisplay = el("customerPhoneDisplay");
        const customer = customers.find(c => c.name === customerName);
        
        if (customer && customer.phone) {
          phoneDisplay.innerHTML = `üì± +91${customer.phone} <span style="color:#22c55e; font-weight:900;" title="Invoice will be sent to WhatsApp">‚úì</span>`;
        } else if (customer && customer.email) {
          phoneDisplay.innerHTML = `‚úâÔ∏è ${customer.email} <span style="color:#22c55e; font-weight:900;" title="Invoice will be sent to Email">‚úì</span>`;
        } else {
          phoneDisplay.innerHTML = '';
        }
      }

      function renderMemory() {
    const list = el("memoryList");
    list.innerHTML = "";
    customers.forEach(c => {
        list.innerHTML += `
        <div class="cardRow">
            <div style="flex:1">
                <b>${c.name}</b><br>
                <small>Last: ${c.lastOrder} ${c.sub > 0 ? '| Subscribed: '+c.sub+'L' : ''}</small>
            </div>
            <button class="pillbtn primary" onclick="repeatOrder('${c.name}', '${c.lastProductName || 'Cow Milk'}', ${c.rate || 64}, ${c.qty || 1})">Repeat</button>
        </div>`;
    });
    openModal('memoryModal');
}

      function repeatOrder(name, productName, rate, qty) {
        el("activeCust").innerText = name;
        if(rate > 0) {
          // Add the actual product from customer's last order
          cart = [{name: productName, rate: parseFloat(rate) || 64, qty: parseFloat(qty) || 1, id: Date.now()}];
          updateUI();
        }
        closeModal('memoryModal');
      }
      function resetCart() { cart = []; updateUI(); el("activeCust").innerText = "Walking Customer"; el("custSearch").value = ""; el("advanceForm").style.display = 'none'; el("paymentForm").style.display = 'flex'; }
      
      // Hold cart functionality
      function holdCart() {
        if (cart.length === 0) return showToast("Cart is empty!");
        const customerName = el("activeCust").innerText;
        const holdId = Date.now();
        
        heldCarts.push({
          id: holdId,
          customer: customerName,
          cart: [...cart],
          total: total,
          timestamp: new Date().toISOString()
        });
        
        localStorage.setItem('mr_held_carts', JSON.stringify(heldCarts));
        cart = [];
        updateUI();
        showToast(`Order held for ${customerName} ‚úÖ`);
        updateHoldButton();
      }
      
      // Retrieve held cart
      function retrieveHoldCart(holdId) {
        const holdIndex = heldCarts.findIndex(h => h.id === holdId);
        if (holdIndex === -1) return;
        
        const heldCart = heldCarts[holdIndex];
        cart = heldCart.cart;
        total = heldCart.total;
        el("activeCust").innerText = heldCart.customer;
        
        heldCarts.splice(holdIndex, 1);
        localStorage.setItem('mr_held_carts', JSON.stringify(heldCarts));
        
        updateUI();
        updateHoldButton();
        showToast(`Order retrieved for ${heldCart.customer} ‚úÖ`);
      }
      
      // Update hold button display
      function updateHoldButton() {
        const holdBtn = document.querySelector('button[onclick*="holdCart"]');
        const heldCountEl = document.getElementById('heldCount');
        
        if (holdBtn && heldCarts.length > 0) {
          holdBtn.innerHTML = `üü° HOLD <span class="subnote">${heldCarts.length} saved</span>`;
        } else if (holdBtn) {
          holdBtn.innerHTML = `üü° HOLD <span class="subnote">save</span>`;
        }

        if (heldCountEl) {
          heldCountEl.textContent = heldCarts.length;
        }
        
        // Sync mobile footer count
        const heldCountMobile = document.getElementById('heldCountMobile');
        if (heldCountMobile) {
          heldCountMobile.textContent = heldCarts.length;
        }
      }
      
      // Show held carts modal
      function showHeldCarts() {
        if (heldCarts.length === 0) return showToast("No held orders");
        
        const modal = document.getElementById('heldCartsModal');
        const list = document.getElementById('heldCartsList');
        
        list.innerHTML = heldCarts.map(h => `
          <div class="cardRow" style="cursor:pointer;" onclick="retrieveHoldCart(${h.id})">
            <div>
              <b>${h.customer}</b>
              <div style="font-size:11px; color:var(--muted);">${new Date(h.timestamp).toLocaleString()}</div>
            </div>
            <b>${formatINR(h.total)}</b>
          </div>
        `).join('');
        
        openModal('heldCartsModal');
      }
      
      function openModal(id) {
        const modal = el(id);
        if (modal) {
          modal.style.display = "flex";
          // Focus first input in modal
          const firstInput = modal.querySelector('input, select, textarea');
          if (firstInput) setTimeout(() => firstInput.focus(), 100);

          // Load shop settings when opening settings modal
          if (id === 'settingsModal') {
            loadShopSettings();
          }

          // Reset step inputs when opening Add Product modal
          if (id === 'addProductModal') {
            stepCount = 3;
            const container = document.getElementById('stepInputsContainer');
            if (container) {
              container.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:4px;">
                  <label style="font-size:10px; font-weight:700; color:var(--muted); text-align:center;">Step 1</label>
                  <input type="number" class="pStep" value="1" step="0.1" style="padding:8px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-align:center; width:100%; box-sizing:border-box;" />
                </div>
                <div style="display:flex; flex-direction:column; gap:4px;">
                  <label style="font-size:10px; font-weight:700; color:var(--muted); text-align:center;">Step 2</label>
                  <input type="number" class="pStep" value="2" step="0.1" style="padding:8px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-align:center; width:100%; box-sizing:border-box;" />
                </div>
                <div style="display:flex; flex-direction:column; gap:4px;">
                  <label style="font-size:10px; font-weight:700; color:var(--muted); text-align:center;">Step 3</label>
                  <input type="number" class="pStep" value="5" step="0.1" style="padding:8px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-align:center; width:100%; box-sizing:border-box;" />
                </div>
              `;
              container.style.gridTemplateColumns = 'repeat(3, 1fr)';
              document.getElementById('addStepBtn').style.display = 'block';
            }
          }
        }
      }
      function closeModal(id) {
        const modal = el(id);
        if (modal) modal.style.display = "none";
      }

      // Note: Modals can ONLY be closed via X button - prevents accidental data loss
      // Close modal when clicking on overlay (outside modal content) - DISABLED for safety
      // document.querySelectorAll('.overlay').forEach(overlay => {
      //   overlay.addEventListener('click', (e) => {
      //     if (e.target === overlay) {
      //       overlay.style.display = 'none';
      //     }
      //   });
      // });

      function showToast(msg) { const t = el("toast"); t.textContent = msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 1500); }

      // Play success sound
      function playSuccessSound() {
        try {
          const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();
          oscillator.connect(gainNode);
          gainNode.connect(audioCtx.destination);
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
          gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
          oscillator.start(audioCtx.currentTime);
          oscillator.stop(audioCtx.currentTime + 0.1);
        } catch(e) {
          console.log('Sound not played:', e);
        }
      }

      // Drag and Drop for Product Cards
      let draggedCard = null;
      let draggedCardId = null;

      function handleDragStart(e) {
        draggedCard = this;
        draggedCardId = this.id;
        this.style.opacity = '0.4';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.id);
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.style.background = '#eff6ff';
        this.style.border = '2px dashed #3b82f6';
        return false;
      }

      function handleDragEnd(e) {
        this.style.opacity = '1';
        // Reset all card styles
        document.querySelectorAll('.p-card').forEach(card => {
          if (!card.onclick?.toString().includes('addProductModal') && !card.onclick?.toString().includes('openEdit')) {
            card.style.background = '';
            card.style.border = '';
          }
        });
        draggedCard = null;
        draggedCardId = null;
      }

      function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Reset style
        const cards = document.querySelectorAll('.p-card');
        cards.forEach(card => {
          if (!card.onclick?.toString().includes('addProductModal') && !card.onclick?.toString().includes('openEdit')) {
            card.style.background = '';
            card.style.border = '';
          }
        });
        
        if (draggedCard && this !== draggedCard) {
          const grid = document.getElementById('productGrid');
          const cards = Array.from(grid.querySelectorAll('.p-card:not([onclick*="addProduct"]):not([onclick*="openEdit"])'));
          const draggedIndex = cards.indexOf(draggedCard);
          const dropIndex = cards.indexOf(this);

          if (draggedIndex < dropIndex) {
            grid.insertBefore(draggedCard, this.nextSibling);
          } else {
            grid.insertBefore(draggedCard, this);
          }

          // Save card order to localStorage
          saveCardOrder();
          
          // Visual feedback
          showToast('‚úÖ Product order saved!');
        }
        if (draggedCard) {
          draggedCard.style.opacity = '1';
          draggedCard = null;
        }
        return false;
      }

      function saveCardOrder() {
        const grid = document.getElementById('productGrid');
        const cards = grid.querySelectorAll('.p-card:not([onclick*="addProduct"]):not([onclick*="openEdit"])');
        const order = Array.from(cards).map(card => card.id);
        localStorage.setItem('mr_pos_card_order', JSON.stringify(order));
      }

      function loadCardOrder() {
        const order = JSON.parse(localStorage.getItem('mr_pos_card_order') || 'null');
        if (!order) return;

        const grid = document.getElementById('productGrid');
        const addBtn = grid.querySelector('.p-card[onclick*="addProductModal"]');

        order.forEach(id => {
          const card = document.getElementById(id);
          if (card && addBtn) {
            grid.insertBefore(card, addBtn);
          }
        });
      }

      // Drag and Drop for Cart Items
      let draggedCartItem = null;
      let draggedCartIndex = null;

      function handleCartDragStart(e) {
        draggedCartItem = this;
        draggedCartIndex = parseInt(this.getAttribute('data-index'));
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedCartIndex);
      }

      function handleCartDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        e.dataTransfer.dropEffect = 'move';
        
        // Find the row being dragged over
        const row = e.target.closest('tr');
        if (row && row !== draggedCartItem) {
          // Remove highlight from all rows
          document.querySelectorAll('#cartItems tr').forEach(r => r.style.borderTop = '');
          // Add highlight to this row
          row.style.borderTop = '3px solid #3b82f6';
        }
        return false;
      }

      function handleCartDragEnd(e) {
        this.classList.remove('dragging');
        // Remove all border highlights
        document.querySelectorAll('#cartItems tr').forEach(tr => {
          tr.style.borderTop = '';
          tr.classList.remove('dragging');
        });
      }

      function handleCartDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Find the row being dropped on
        const targetRow = e.target.closest('tr');
        
        // Remove all border highlights
        document.querySelectorAll('#cartItems tr').forEach(tr => {
          tr.style.borderTop = '';
          tr.classList.remove('dragging');
        });
        
        if (!targetRow || !draggedCartItem || targetRow === draggedCartItem) {
          draggedCartItem = null;
          draggedCartIndex = null;
          return false;
        }
        
        const dropIndex = parseInt(targetRow.getAttribute('data-index'));

        // Reorder cart array
        const draggedItem = cart[draggedCartIndex];
        cart.splice(draggedCartIndex, 1);
        cart.splice(dropIndex, 0, draggedItem);

        updateUI();
        
        draggedCartItem = null;
        draggedCartIndex = null;
        return false;
      }

      // Handlers for tbody
      function handleCartDragOverTbody(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
      }

      function handleCartDropTbody(e) {
        e.preventDefault();
        // Let the row's drop handler deal with it
        return false;
      }

      // Drag product to cart (add to cart)
      function handleProductDragToCart(e) {
        e.preventDefault();
        if (!draggedCard || !(draggedCard instanceof Element)) {
          draggedCard = null;
          return false;
        }
        const onclick = draggedCard.getAttribute('onclick');
        if (onclick) {
          const match = onclick.match(/tapAdd\('([^']+)',\s*([\d.]+),\s*([\d.]+),\s*([\d.]+)\)/);
          if (match) {
            const name = match[1];
            const rate = parseFloat(match[2]);
            const step = parseFloat(match[3]);
            const qty = parseFloat(match[4]) || step;
            tapAdd(name, rate, qty, step);
          }
        }
        draggedCard = null;
        return false;
      }

      // Drag cart item out to remove
      function handleCartDragOut(e) {
        e.preventDefault();
        if (draggedCartItem) {
          const index = parseInt(draggedCartItem.getAttribute('data-index'));
          removeItem(index);
          showToast('Item removed');
        }
        return false;
      }

      window.onload = () => {
    updateShift();
    loadHistoryOnStart();
    loadCustomProducts();
    loadCardOrder(); // Load saved card order
    loadFrequentBuys(); // Load customer frequent buys

    // Load cart from robust storage
    const savedCart = loadData('mr_pos_cart', []);
    if (savedCart && savedCart.length > 0) {
      cart = savedCart;
      updateUI();
      console.log('üîÑ Restored cart from previous session');
    }

    setInterval(updateShift, 60000);
    
    // Show data status
    showDataStatus();
    
    // ESC key closes all modals
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.overlay[style*="display: flex"]').forEach(modal => {
          modal.style.display = 'none';
        });
        const searchDrop = document.getElementById('searchDropdown');
        if (searchDrop) searchDrop.style.display = 'none';
      }
    });
    
    // Arrow key navigation for products
    let productFocusIndex = -1;
    const productGrid = document.getElementById('productGrid');
    
    if (productGrid) {
      // Update focus on product cards
      function updateProductFocus() {
        const cards = Array.from(productGrid.querySelectorAll('.p-card'));
        cards.forEach((card, i) => {
          if (i === productFocusIndex) {
            card.classList.add('focused');
            card.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          } else {
            card.classList.remove('focused');
          }
        });
      }
      
      productGrid.addEventListener('keydown', function(e) {
        const cards = Array.from(productGrid.querySelectorAll('.p-card'));
        if (cards.length === 0) return;
        
        const cols = 5; // 5 columns in grid
        
        if (e.key === 'ArrowRight') {
          e.preventDefault();
          productFocusIndex = Math.min(productFocusIndex + 1, cards.length - 1);
          updateProductFocus();
        } else if (e.key === 'ArrowLeft') {
          e.preventDefault();
          productFocusIndex = Math.max(productFocusIndex - 1, 0);
          updateProductFocus();
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          productFocusIndex = Math.min(productFocusIndex + cols, cards.length - 1);
          updateProductFocus();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          productFocusIndex = Math.max(productFocusIndex - cols, 0);
          updateProductFocus();
        } else if (e.key === 'Enter' || e.key === 'Tab') {
          if (productFocusIndex >= 0 && cards[productFocusIndex]) {
            e.preventDefault();
            cards[productFocusIndex].click();
            // Move focus to payment amount field
            setTimeout(() => {
              const paymentInput = document.getElementById('paymentAmount');
              if (paymentInput) {
                paymentInput.value = total.toFixed(2);
                paymentInput.focus();
                paymentInput.select();
                calculateCredit();
              }
            }, 100);
          }
        }
      });
      
      // Click handler updates focus index
      productGrid.addEventListener('click', function(e) {
        const cards = Array.from(productGrid.querySelectorAll('.p-card'));
        cards.forEach((card, i) => {
          if (card.contains(e.target)) {
            productFocusIndex = i;
            updateProductFocus();
          }
        });
      });
    }
}

function loadHistoryOnStart() {
    const historyContainer = document.getElementById("historyToday");
    if(!historyContainer) return;
    historyContainer.innerHTML = "";
    
    const today = new Date().toLocaleDateString();
    const todaySales = exportHistory.filter(s => s.date === today);
    
    // Render today's history with clickable items and payment mode
    todaySales.forEach(sale => {
        // Get payment mode icon
        let modeIcon = 'üíµ';
        if (sale.method === 'Credit' || sale.method === 'Udhar') modeIcon = 'üìï';
        else if (sale.method === 'UPI') modeIcon = 'üì±';
        
        const entry = `<div class="cardRow" style="flex-direction:column; align-items:flex-start; gap:4px; cursor:pointer;" onclick="loadOrderFromHistory('${sale.customer.replace(/'/g, "\\'")}', ${JSON.stringify(sale.cartItems || []).replace(/"/g, '&quot;')})">
            <div style="width:100%; display:flex; justify-content:space-between;">
              <b>${sale.customer}</b><b>‚Çπ${sale.amount}</b>
            </div>
            <small style="color:var(--muted); font-weight:700;">
              ${sale.time} ‚Ä¢ ${sale.products} ‚Ä¢ ${modeIcon} ${sale.method}
              <span style="color:var(--blue); font-weight:700; margin-left:8px;">üîÅ Click to reload</span>
            </small>
          </div>`;
        historyContainer.insertAdjacentHTML('afterbegin', entry);
    });
    
    // Update count
    const totalCount = exportHistory.length;
    el("historyCount").textContent = `${todaySales.length} today ‚Ä¢ ${totalCount} total`;
}

function toggleGaps() { el("gapsPanel").classList.toggle("open"); }

// Convert milk to product
function convertMilkToProduct() {
  const milkQty = parseFloat(el("convQty").value);
  const productData = el("convProduct").value.split(',');
  const productName = productData[0];
  const rate = parseFloat(productData[1]);
  const milkRatio = parseFloat(productData[2]) || 1;
  
  if (!milkQty || milkQty <= 0) return showToast("Enter valid milk quantity");
  
  // Check if override is active
  const overrideDiv = document.getElementById('overrideInput');
  let productQty;
  let productUnit;
  
  if (overrideDiv && overrideDiv.style.display !== 'none') {
    // Use override value
    productQty = parseFloat(el('actualProductQty').value) || 0;
    productUnit = 'kg';
  } else {
    // Calculate product quantity based on ratio
    if (productName.includes('Paneer') || productName.includes('Ghee')) {
      // For paneer/ghee: milkQty / ratio = product kg
      productQty = milkQty / milkRatio;
      productUnit = 'kg';
    } else {
      // For milk/curd: 1:1 ratio
      productQty = milkQty;
      productUnit = productName.includes('Milk') ? 'L' : 'kg';
    }
  }
  
  if (productQty <= 0) return showToast("Invalid conversion");

  // Add to cart
  const existingItem = cart.find(item => item.name === productName && item.rate === rate);
  if (existingItem) {
    existingItem.qty += productQty;
  } else {
    cart.push({name: productName, rate, qty: productQty, emoji: getEmojiForProduct(productName), id: Date.now(), unit: productUnit});
  }
  updateUI();
  closeModal('convertModal');
  el("convQty").value = "";
  
  // Reset override
  if (overrideDiv) {
    overrideDiv.style.display = 'none';
    el('actualProductQty').value = '0';
  }
  
  showToast(`‚úÖ Converted ${milkQty}L milk to ${productQty.toFixed(2)}${productUnit} ${productName}`);
}

// Update conversion ratio display when product changes
function updateConversionRatio() {
  const productValue = el("convProduct").value;
  const ratioDisplay = document.getElementById('ratioDisplay');
  const customInputs = document.getElementById('customRatioInputs');
  
  if (productValue === 'custom') {
    ratioDisplay.style.display = 'none';
    customInputs.style.display = 'block';
  } else {
    customInputs.style.display = 'none';
    const productData = productValue.split(',');
    const productName = productData[0];
    const milkRatio = parseFloat(productData[2]) || 1;
    
    if (milkRatio > 1) {
      ratioDisplay.style.display = 'block';
      document.getElementById('ratioText').textContent = `${milkRatio}L Milk ‚Üí 1${productName.includes('Paneer') || productName.includes('Ghee') ? 'kg' : 'L'} ${productName}`;
    } else {
      ratioDisplay.style.display = 'block';
      document.getElementById('ratioText').textContent = `1L Milk ‚Üí 1${productName.includes('Curd') ? 'kg' : 'L'} ${productName}`;
    }
  }
  
  updateConversionPreview();
}

// Update custom ratio
function updateCustomRatio() {
  updateConversionPreview();
}

// Update conversion preview when qty or product changes
function updateConversionPreview() {
  const milkQty = parseFloat(el("convQty").value);
  const productValue = el("convProduct").value;
  
  if (productValue === 'custom') {
    const milkRatio = parseFloat(el("customMilkRatio").value) || 1;
    const productRatio = parseFloat(el("customProductRatio").value) || 1;
    const productQty = milkQty ? (milkQty / milkRatio) * productRatio : 0;
    
    updateOutputDisplay(productQty, 'kg/L');
    updatePreviewDisplay(milkQty, 'Custom', productValue.split(',')[1] || 100, productQty);
  } else {
    const productData = productValue.split(',');
    const productName = productData[0];
    const milkRatio = parseFloat(productData[2]) || 1;
    
    let productQty;
    let productUnit;
    
    if (productName.includes('Paneer') || productName.includes('Ghee')) {
      productQty = milkQty ? milkQty / milkRatio : 0;
      productUnit = 'kg';
    } else {
      productQty = milkQty || 0;
      productUnit = productName.includes('Milk') ? 'L' : 'kg';
    }
    
    updateOutputDisplay(productQty, productUnit);
    updatePreviewDisplay(milkQty, productName, productData[1] || 0, productQty);
  }
}

// Update output display
function updateOutputDisplay(qty, unit) {
  // Check if override is active
  const overrideDiv = document.getElementById('overrideInput');
  if (overrideDiv && overrideDiv.style.display !== 'none') {
    // Override is active, use manual value
    const actualQty = parseFloat(el('actualProductQty').value) || 0;
    document.getElementById('outputQty').textContent = actualQty.toFixed(2);
  } else {
    // Use calculated value
    document.getElementById('outputQty').textContent = qty.toFixed(2);
  }
  document.getElementById('outputUnit').textContent = unit;
}

// Toggle override mode
function toggleOverride() {
  const overrideDiv = document.getElementById('overrideInput');
  const calcQty = document.getElementById('outputQty').textContent;
  
  if (overrideDiv.style.display === 'none') {
    // Show override input
    overrideDiv.style.display = 'block';
    el('actualProductQty').value = calcQty;
    el('actualProductQty').focus();
    el('actualProductQty').select();
  } else {
    // Hide override input
    overrideDiv.style.display = 'none';
    updateConversionPreview();
  }
}

// Update when override value changes
function updateOverride() {
  const actualQty = parseFloat(el('actualProductQty').value) || 0;
  document.getElementById('outputQty').textContent = actualQty.toFixed(2);
  updateConversionPreview();
}

// Update preview display
function updatePreviewDisplay(milkQty, productName, rate, productQty) {
  const preview = document.getElementById('convPreview');
  if (milkQty && milkQty > 0) {
    preview.style.display = 'block';
    document.getElementById('previewQty').textContent = milkQty;
    document.getElementById('previewProduct').textContent = productName;
    document.getElementById('previewValue').textContent = (productQty * rate).toFixed(2);
  } else {
    preview.style.display = 'none';
  }
}

// Get emoji for product name
function getEmojiForProduct(productName) {
  const emojis = {
    'Cow Milk': 'ü•õ',
    'Buff Milk': 'ü•õ',
    'Paneer': 'üßÄ',
    'Ghee': 'üßà',
    'Curd': 'ü•£',
    'Lassi': 'ü•£',
    'Sweets': 'üç¨',
    'Bakery': 'ü•ê'
  };
  return emojis[productName] || 'üì¶';
}

// Update milk stock display when modal opens
function updateMilkStockDisplay() {
  // Read directly from cart array for accurate quantities
  let cowQty = 0;
  let buffQty = 0;
  
  // Sum up milk quantities from cart
  if (typeof cart !== 'undefined' && Array.isArray(cart)) {
    cart.forEach(item => {
      if (item && item.name) {
        const nameLower = item.name.toLowerCase();
        if (nameLower.includes('cow') && nameLower.includes('milk')) {
          cowQty += item.qty || 0;
        } else if ((nameLower.includes('buff') || nameLower.includes('buffalo')) && nameLower.includes('milk')) {
          buffQty += item.qty || 0;
        }
      }
    });
  }
  
  // Update display
  const stockDisplay = document.getElementById('milkStockDisplay');
  if (stockDisplay) {
    if (cowQty === 0 && buffQty === 0) {
      // No milk in cart - show helpful message
      stockDisplay.innerHTML = `
        <div style="padding:12px; text-align:center; color:#dc2626; font-size:11px; font-weight:700;">
          ‚ö†Ô∏è No milk in cart<br/>
          <span style="color:#64748b; font-weight:500; font-size:10px;">Add milk products to cart first, then convert</span>
        </div>
      `;
    } else {
      // Show quantities
      stockDisplay.innerHTML = `
        <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #bbf7d0;">
          <span>ü•õ Cow Milk:</span>
          <span style="font-weight:700;">${cowQty.toFixed(1)} L</span>
        </div>
        <div style="display:flex; justify-content:space-between; padding:4px 0;">
          <span>üêÉ Buff Milk:</span>
          <span style="font-weight:700;">${buffQty.toFixed(1)} L</span>
        </div>
      `;
    }
  }
}

// Format date as YYYY-MM-DD
function fmtDate(d) {
  if (!d) return new Date().toISOString().split('T')[0];
  return new Date(d).toISOString().split('T')[0];
}

// Open convert modal and update stock display - PRODUCTION MODULE
const originalOpenModal = window.openModal;
window.openModal = function(modalId) {
  if (modalId === 'convertModal') {
    // Load today's collection from localStorage
    loadTodayMilkForProduction();
    // Generate batch ID
    document.getElementById('batchIdDisplay').textContent = 'BATCH-' + new Date().toISOString().split('T')[0].replace(/-/g,'') + '-' + String(Date.now()).slice(-3);
  }
  if (originalOpenModal) originalOpenModal(modalId);
};

// Load today's milk collection for Production Module
function loadTodayMilkForProduction() {
  // Try both localStorage keys (Collection page uses milkapp_entries_v2)
  let entries = [];
  
  // Try Collection page key first
  try {
    const collectionEntries = localStorage.getItem('milkapp_entries_v2');
    if (collectionEntries) {
      entries = JSON.parse(collectionEntries);
      console.log('‚úÖ Loaded', entries.length, 'entries from milkapp_entries_v2');
    }
  } catch (e) {
    console.error('Error loading collection entries:', e);
  }
  
  // Also try POS key
  try {
    const posEntries = localStorage.getItem('mr_milk_entries');
    if (posEntries) {
      const posData = JSON.parse(posEntries);
      entries = entries.concat(posData);
      console.log('‚úÖ Loaded', posData.length, 'entries from mr_milk_entries');
    }
  } catch (e) {
    console.error('Error loading POS entries:', e);
  }
  
  const today = fmtDate(new Date());

  let cowMilk = 0, cowAmount = 0, buffMilk = 0, buffAmount = 0;

  entries.forEach(e => {
    if (e.day === today) {
      const qty = parseFloat(e.qty) || 0;
      const amount = parseFloat(e.amount) || 0;
      if (e.animal === 'cow') {
        cowMilk += qty;
        cowAmount += amount;
      } else if (e.animal === 'buffalo') {
        buffMilk += qty;
        buffAmount += amount;
      }
    }
  });

  console.log('üìä Today\'s milk:', cowMilk.toFixed(1) + 'L cow,', buffMilk.toFixed(1) + 'L buff');

  // Update today's collection display
  const el = (id) => document.getElementById(id);
  if (el('todayCowMilk')) el('todayCowMilk').textContent = cowMilk.toFixed(1);
  if (el('todayCowAmount')) el('todayCowAmount').textContent = cowAmount.toFixed(0);
  if (el('todayBuffMilk')) el('todayBuffMilk').textContent = buffMilk.toFixed(1);
  if (el('todayBuffAmount')) el('todayBuffAmount').textContent = buffAmount.toFixed(0);
  if (el('todayTotalMilk')) el('todayTotalMilk').textContent = (cowMilk + buffMilk).toFixed(1);
  if (el('todayTotalAmount')) el('todayTotalAmount').textContent = (cowAmount + buffAmount).toFixed(0);

  // Update available for production
  if (el('availableCow')) el('availableCow').textContent = cowMilk.toFixed(1);
  if (el('availableBuff')) el('availableBuff').textContent = buffMilk.toFixed(1);

  // Show warning if no milk collected
  const noMilkWarning = document.getElementById('noMilkWarning');
  const createBatchBtn = document.getElementById('createBatchBtn');
  const createBatchDisabled = document.getElementById('createBatchDisabled');

  if (noMilkWarning) {
    if (cowMilk === 0 && buffMilk === 0) {
      noMilkWarning.style.display = 'block';
      if (createBatchBtn) createBatchBtn.disabled = true;
      if (createBatchDisabled) createBatchDisabled.style.display = 'block';
    } else {
      noMilkWarning.style.display = 'none';
      if (createBatchBtn) createBatchBtn.disabled = false;
      if (createBatchDisabled) createBatchDisabled.style.display = 'none';
    }
  }

  window.todayMilk = { cow: cowMilk, buff: buffMilk, total: cowMilk + buffMilk };
  
  // Show auto-suggestion if milk available
  const autoSuggestion = document.getElementById('autoSuggestion');
  if (autoSuggestion) {
    if (cowMilk + buffMilk > 50) {
      autoSuggestion.style.display = 'block';
    } else {
      autoSuggestion.style.display = 'none';
    }
  }
  
  // Load recent batches
  loadRecentBatches();
  
  // Load ledger summary
  loadLedgerSummary();
  
  // Focus on Milk Used input for better UX
  setTimeout(() => {
    const milkInput = document.getElementById('prodMilkQty');
    if (milkInput) {
      milkInput.focus();
    }
  }, 300);
}

// Apply production suggestion
function applySuggestion() {
  document.getElementById('prodMilkQty').value = '150';
  document.getElementById('prodProduct').value = 'paneer,400,5';
  updateProductionRatio();
  updateProductionPreview();
  showToast('üí° Suggestion applied: 150L ‚Üí Paneer');
}

// Load ledger summary for display
function loadLedgerSummary() {
  // This would load from localStorage or API
  // For now, show placeholder
  console.log('Ledger summary loaded');
}

// Show specific ledger
function showLedger(ledgerType) {
  let entries = [];

  try {
    if (ledgerType === 'milk') {
      // Try Collection page key first
      const collectionEntries = localStorage.getItem('milkapp_entries_v2');
      if (collectionEntries) {
        entries = JSON.parse(collectionEntries);
      }
    } else if (ledgerType === 'production') {
      entries = JSON.parse(localStorage.getItem('mr_production_batches') || '[]');
    } else if (ledgerType === 'inventory') {
      entries = JSON.parse(localStorage.getItem('mr_inventory_movements') || '[]');
    } else if (ledgerType === 'sales') {
      entries = JSON.parse(localStorage.getItem('mr_pos_history') || '[]');
    } else if (ledgerType === 'cash') {
      entries = []; // Would come from sales with payment mode
    }
  } catch (e) {
    console.error('Error loading ledger:', e);
    entries = [];
  }

  // Ensure entries is an array and get last 10
  if (!Array.isArray(entries)) {
    entries = [];
  }
  const recentEntries = entries.slice(-10);

  const ledgers = {
    milk: 'ü•õ Milk Ledger',
    production: 'üè≠ Production Ledger',
    inventory: 'üì¶ Inventory Ledger',
    sales: 'üí∞ Sales Ledger',
    cash: 'üíµ Cash/Credit Ledger'
  };

  const ledgerTitle = ledgers[ledgerType];

  // Create modal with ledger entries
  const html = `
    <div class="overlay" id="ledgerOverlay" style="display:flex;align-items:center;justify-content:center;z-index:99999;">
      <div class="modal" style="width:600px;max-height:80vh;overflow-y:auto;">
        <div class="panelHeader" style="background:#1e293b;color:white;">
          <span>${ledgerTitle}</span>
          <button onclick="document.getElementById('ledgerOverlay').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;color:white;">‚úñ</button>
        </div>
        <div style="padding:20px;">
          ${recentEntries.length === 0 ?
            '<div style="text-align:center;color:#94a3b8;padding:40px;">No entries yet</div>' :
            recentEntries.map(e => {
              let displayData = '';
              if (ledgerType === 'inventory') {
                // Inventory movement display
                displayData = `${e.direction} ${e.quantity}${e.unit} ${e.item_type} (${e.movement_type})`;
                if (e.notes) displayData += ` - ${e.notes}`;
              } else if (e.farmerName) {
                displayData = `${e.farmerName} - ${e.qty}L @ ‚Çπ${e.rate}/L = ‚Çπ${e.amount}`;
              } else if (e.batch_number) {
                displayData = `${e.batch_number}: ${e.milk_quantity}L ‚Üí ${e.product_quantity}kg ${e.product_type}`;
              } else if (e.customer_name) {
                displayData = `${e.customer_name}: ‚Çπ${e.total_amount} (${e.payment_mode})`;
              } else {
                displayData = JSON.stringify(e).substring(0, 150);
              }
              return `
                <div style="background:#f8fafc;padding:12px;border-radius:8px;margin-bottom:8px;border-left:3px solid #3b82f6;">
                  <div style="font-size:11px;font-weight:700;color:#475569;">${e.batch_number || e.farmerName || e.customer_name || e.item_type || 'Entry'}</div>
                  <div style="font-size:11px;color:#64748b;margin-top:4px;">${displayData}</div>
                  <div style="font-size:10px;color:#94a3b8;margin-top:4px;">${e.created_at ? new Date(e.created_at).toLocaleString() : ''}</div>
                </div>
              `;
            }).join('')
          }
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', html);
}

// Load recent production batches
function loadRecentBatches() {
  const batches = JSON.parse(localStorage.getItem('mr_production_batches') || '[]');
  const today = fmtDate(new Date());
  
  // Filter today's batches
  const todayBatches = batches.filter(b => b.created_at && b.created_at.startsWith(today));
  
  const listEl = document.getElementById('recentBatchesList');
  if (!listEl) return;
  
  if (todayBatches.length === 0) {
    listEl.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:12px; font-size:12px;">No batches created today</div>';
    return;
  }
  
  // Show last 5 batches
  const recent = todayBatches.slice(-5).reverse();
  
  listEl.innerHTML = recent.map(b => `
    <div style="background:#f8fafc; padding:10px; border-radius:6px; margin-bottom:8px; border-left:3px solid #7c3aed;">
      <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:700; color:#475569;">
        <span>${b.batch_number || 'BATCH'}</span>
        <span>${b.product_type.toUpperCase()}</span>
      </div>
      <div style="font-size:11px; color:#64748b; margin-top:4px;">
        ${b.milk_quantity.toFixed(1)}L ‚Üí ${b.product_quantity.toFixed(2)}kg (${b.conversion_ratio}:1)
      </div>
    </div>
  `).join('');
}

// Update production ratio
function updateProductionRatio() {
  const select = document.getElementById('prodProduct');
  const selectedOption = select.options[select.selectedIndex];
  const ratio = selectedOption.getAttribute('data-ratio') || 5;
  
  const ratioDisplay = document.getElementById('prodRatioDisplay');
  const ratioText = document.getElementById('prodRatioText');
  
  if (ratioDisplay && ratioText && selectedOption.value) {
    ratioDisplay.style.display = 'block';
    ratioText.textContent = ratio + 'L Milk ‚Üí 1kg ' + selectedOption.text.split(' ')[1];
  }
  
  updateProductionPreview();
}

// Update production preview
function updateProductionPreview() {
  const milkQty = parseFloat(document.getElementById('prodMilkQty').value) || 0;
  const productValue = document.getElementById('prodProduct').value;
  
  if (!milkQty || !productValue) {
    document.getElementById('prodPreview').style.display = 'none';
    return;
  }
  
  const productData = productValue.split(',');
  const milkRatio = parseFloat(productData[2]) || 5;
  
  // Calculate output
  const productQty = milkQty / milkRatio;
  
  // Show preview
  const preview = document.getElementById('prodPreview');
  preview.style.display = 'block';
  document.getElementById('previewProdMilk').textContent = milkQty.toFixed(1);
  document.getElementById('previewProdOutput').textContent = productQty.toFixed(2);
  document.getElementById('previewEfficiency').textContent = '100';
  
  // Update calculated quantity display (span, not input)
  document.getElementById('prodProductQty').textContent = productQty.toFixed(2);
  
  // Check if exceeds available
  const milkSource = document.querySelector('input[name="milkSource"]:checked').value;
  let available = window.todayMilk ? window.todayMilk.total : 0;
  if (milkSource === 'cow') available = window.todayMilk ? window.todayMilk.cow : 0;
  if (milkSource === 'buff') available = window.todayMilk ? window.todayMilk.buff : 0;
  
  const warning = document.getElementById('prodMilkWarning');
  if (warning) {
    warning.style.display = (milkQty > available && available > 0) ? 'block' : 'none';
  }
}

// Toggle production override
function toggleProdOverride() {
  const overrideSection = document.getElementById('prodOverrideSection');
  const calculatedDisplay = document.getElementById('prodCalculatedQty');
  const actualInput = document.getElementById('prodActualQty');
  
  if (overrideSection.style.display === 'none') {
    // Show override
    overrideSection.style.display = 'block';
    calculatedDisplay.style.display = 'none';
    actualInput.value = document.getElementById('prodProductQty').textContent;
    actualInput.focus();
    actualInput.select();
  } else {
    // Hide override
    overrideSection.style.display = 'none';
    calculatedDisplay.style.display = 'block';
  }
}

// Update production actual quantity
function updateProdActual() {
  const actualQty = parseFloat(document.getElementById('prodActualQty').value) || 0;
  console.log('Actual quantity:', actualQty);
}

// Confirm production batch
function confirmProduction() {
  const milkQty = parseFloat(document.getElementById('prodMilkQty').value) || 0;
  const productValue = document.getElementById('prodProduct').value;
  const milkSource = document.querySelector('input[name="milkSource"]:checked').value;
  const shift = document.getElementById('prodShift').value;
  const batchId = document.getElementById('batchIdDisplay').textContent;
  const notes = document.getElementById('prodNotes').value;

  if (!milkQty || !productValue) {
    showToast('‚ö†Ô∏è Please enter milk quantity and select product');
    return;
  }

  const productData = productValue.split(',');
  const productType = productData[0];
  const rate = parseFloat(productData[1]);
  const milkRatio = parseFloat(productData[2]) || 5;

  // Get product quantity (with override if active)
  let productQty;
  const overrideSection = document.getElementById('prodOverrideSection');
  if (overrideSection && overrideSection.style.display !== 'none') {
    productQty = parseFloat(document.getElementById('prodActualQty').value) || 0;
  } else {
    productQty = milkQty / milkRatio;
  }

  // Create production batch
  const batch = {
    batch_number: batchId,
    shift: shift,
    milk_source: milkSource,
    milk_quantity: milkQty,
    product_type: productType,
    product_quantity: productQty,
    conversion_ratio: milkRatio,
    notes: notes,
    created_at: new Date().toISOString()
  };

  // Save to localStorage
  const batches = JSON.parse(localStorage.getItem('mr_production_batches') || '[]');
  batches.push(batch);
  localStorage.setItem('mr_production_batches', JSON.stringify(batches));
  
  // Check yield variance (auto-alert if high variance)
  if (window.YieldCalculator) {
    const milkType = milkSource === 'cow' ? 'cow' : 'buffalo';
    // Get average fat from today's collections
    const collections = JSON.parse(localStorage.getItem('milkapp_entries_v2') || '[]');
    const today = new Date().toISOString().split('T')[0];
    const todayMilk = collections.filter(e => e.day === today && e.animal === milkType);
    const avgFat = todayMilk.length > 0 ? todayMilk.reduce((sum, e) => sum + (parseFloat(e.fat) || 0), 0) / todayMilk.length : (milkType === 'cow' ? 4.0 : 6.0);
    const avgSnf = todayMilk.length > 0 ? todayMilk.reduce((sum, e) => sum + (parseFloat(e.snf) || 0), 0) / todayMilk.length : (milkType === 'cow' ? 8.5 : 9.0);
    
    const alertData = YieldCalculator.checkYieldVariance(productType, milkType, avgFat, avgSnf, milkQty, productQty);
    if (alertData) {
      YieldCalculator.showYieldAlert(alertData, productType);
    }
  }

  // Create inventory movements (for Inventory Ledger)
  const movements = JSON.parse(localStorage.getItem('mr_inventory_movements') || '[]');
  
  // OUT movement for milk
  movements.push({
    id: 'mov_' + Date.now(),
    movement_type: 'conversion_out',
    direction: 'OUT',
    item_type: milkSource === 'cow' ? 'milk_cow' : (milkSource === 'buff' ? 'milk_buff' : 'milk_mixed'),
    quantity: milkQty,
    unit: 'L',
    reference_type: 'production_batch',
    reference_id: batchId,
    batch_number: batchId,
    notes: `Converted to ${productQty}kg ${productType}`,
    created_at: new Date().toISOString()
  });
  
  // IN movement for product
  movements.push({
    id: 'mov_' + (Date.now() + 1),
    movement_type: 'conversion_in',
    direction: 'IN',
    item_type: productType,
    quantity: productQty,
    unit: 'kg',
    reference_type: 'production_batch',
    reference_id: batchId,
    batch_number: batchId,
    notes: `Produced from ${milkQty}L ${milkSource} milk`,
    created_at: new Date().toISOString()
  });
  
  localStorage.setItem('mr_inventory_movements', JSON.stringify(movements));

  // Add to cart (for POS integration)
  cart.push({
    name: productType.charAt(0).toUpperCase() + productType.slice(1),
    rate: rate,
    qty: productQty,
    emoji: getEmojiForProduct(productType),
    id: Date.now(),
    unit: 'kg',
    isProduction: true,
    batchId: batchId
  });

  updateUI();
  closeModal('convertModal');
  showToast(`‚úÖ Production batch created: ${batchId} (${milkQty}L ‚Üí ${productQty}kg ${productType})`);
  
  // Refresh recent batches display
  loadRecentBatches();
}

// Suggest appropriate quantities based on unit selected
function suggestQuantitiesForUnit() {
  const unit = document.getElementById('pUnit').value.toLowerCase();
  const qtyInputs = document.querySelectorAll('.pQty');
  
  // Suggested quantities for different units
  const suggestions = {
    'g': [100, 250, 500],      // Grams: 100g, 250g, 500g
    'ml': [100, 250, 500],     // Milliliters: 100ml, 250ml, 500ml
    'kg': [0.5, 1, 2],         // Kilograms: 0.5kg, 1kg, 2kg
    'l': [0.5, 1, 2],          // Liters: 0.5L, 1L, 2L
    'pcs': [1, 5, 10],         // Pieces: 1, 5, 10
    'box': [1, 5, 10],         // Boxes: 1, 5, 10
    'packet': [1, 5, 10],      // Packets: 1, 5, 10
    'bottle': [1, 5, 10]       // Bottles: 1, 5, 10
  };
  
  // Get suggested values or use defaults
  const values = suggestions[unit] || [1, 2, 5];
  
  // Update quantity inputs with suggestions
  qtyInputs.forEach((input, index) => {
    if (values[index]) {
      input.value = values[index];
    }
  });
  
  // Show visual feedback
  const tipDiv = document.querySelector('#qtyInputsContainer').previousElementSibling;
  if (tipDiv) {
    tipDiv.style.background = '#dcfce7';
    tipDiv.style.borderColor = '#16a34a';
    setTimeout(() => {
      tipDiv.style.background = '#eff6ff';
      tipDiv.style.borderColor = '#3b82f6';
    }, 1000);
  }
}

// Dairy Emoji Picker Functions
let lastSelectedEmoji = 'üì¶';
let allDairyEmojis = [];

// Initialize dairy emojis
function initDairyEmojis() {
  allDairyEmojis = [
    { emoji: 'ü•õ', keywords: ['milk', 'glass', 'drink', 'dairy'] },
    { emoji: 'üßÄ', keywords: ['cheese', 'paneer', 'dairy'] },
    { emoji: 'üßà', keywords: ['butter', 'ghee', 'dairy'] },
    { emoji: 'üç¶', keywords: ['ice cream', 'dessert', 'dairy'] },
    { emoji: 'üßÅ', keywords: ['cupcake', 'cake', 'bakery'] },
    { emoji: 'üç∞', keywords: ['cake', 'slice', 'bakery'] },
    { emoji: 'üéÇ', keywords: ['birthday', 'cake', 'bakery'] },
    { emoji: 'ü•ê', keywords: ['croissant', 'bakery', 'bread'] },
    { emoji: 'ü•ñ', keywords: ['bread', 'baguette', 'bakery'] },
    { emoji: 'üçû', keywords: ['bread', 'loaf', 'bakery'] },
    { emoji: 'ü•û', keywords: ['pancakes', 'breakfast', 'dairy'] },
    { emoji: 'ü•ö', keywords: ['egg', 'breakfast', 'protein'] },
    { emoji: '‚òï', keywords: ['coffee', 'hot', 'beverage', 'cafe'] },
    { emoji: 'üçµ', keywords: ['tea', 'green', 'beverage', 'chai'] },
    { emoji: 'üßÉ', keywords: ['juice', 'beverage', 'drink'] },
    { emoji: 'ü•§', keywords: ['soda', 'drink', 'beverage'] },
    { emoji: 'üçº', keywords: ['baby', 'bottle', 'milk'] },
    { emoji: 'üêÑ', keywords: ['cow', 'cattle', 'milk', 'dairy'] },
    { emoji: 'üêÉ', keywords: ['buffalo', 'water buffalo', 'milk'] },
    { emoji: 'üêÆ', keywords: ['cow face', 'cattle', 'milk'] },
    { emoji: 'üêê', keywords: ['goat', 'milk', 'animal'] },
    { emoji: 'üçï', keywords: ['pizza', 'cheese', 'food'] },
    { emoji: 'ü•£', keywords: ['bowl', 'curd', 'yogurt', 'breakfast'] },
    { emoji: 'üè™', keywords: ['store', 'shop', 'convenience'] },
    { emoji: 'üõí', keywords: ['cart', 'shopping', 'trolley'] },
    { emoji: 'üí∞', keywords: ['money', 'cash', 'payment'] },
    { emoji: 'üì¶', keywords: ['package', 'box', 'parcel', 'default'] },
    { emoji: '‚öñÔ∏è', keywords: ['scale', 'weight', 'measure'] },
    { emoji: '‚ú®', keywords: ['sparkles', 'fresh', 'new'] },
    { emoji: '‚≠ê', keywords: ['star', 'favorite', 'rating'] },
    { emoji: '‚úÖ', keywords: ['check', 'done', 'complete'] },
    { emoji: 'üìã', keywords: ['clipboard', 'list', 'order'] },
    { emoji: 'üìù', keywords: ['memo', 'note', 'edit'] },
    { emoji: 'üìù', keywords: ['pencil', 'edit', 'write'] },
    { emoji: 'üî•', keywords: ['fire', 'hot', 'trending'] },
    { emoji: '‚ùÑÔ∏è', keywords: ['snowflake', 'cold', 'frozen'] },
  ];
  allDairyEmojis.sort((a, b) => {
    const dairy = ['milk', 'dairy', 'cheese', 'paneer', 'butter', 'ghee', 'curd', 'cow', 'buffalo'];
    const aIs = dairy.some(k => a.keywords.some(kw => kw.includes(k)));
    const bIs = dairy.some(k => b.keywords.some(kw => kw.includes(k)));
    if (aIs && !bIs) return -1;
    if (!aIs && bIs) return 1;
    return 0;
  });
}

function openEmojiPicker() {
  initDairyEmojis();
  renderEmojis(allDairyEmojis);
  openModal('emojiPickerModal');
  document.getElementById('emojiSearchInput').focus();
}

function renderEmojis(emojis) {
  const grid = document.getElementById('emojiGrid');
  if (!grid) return;
  grid.innerHTML = emojis.map(item => `<button onclick="selectEmoji('${item.emoji}')" style="font-size:32px;padding:8px;background:white;border:2px solid #e2e8f0;border-radius:8px;cursor:pointer;" onmouseover="this.style.borderColor='#3b82f6';this.style.transform='scale(1.1)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.transform='scale(1)'" title="${item.keywords.join(', ')}">${item.emoji}</button>`).join('');
  const lastDiv = document.getElementById('lastSelectedEmoji');
  const lastBtn = document.getElementById('lastEmojiBtn');
  if (lastDiv && lastBtn) {
    if (lastSelectedEmoji && lastSelectedEmoji !== 'üì¶') {
      lastDiv.style.display = 'block';
      lastBtn.textContent = lastSelectedEmoji;
    } else {
      lastDiv.style.display = 'none';
    }
  }
}

function filterEmojis() {
  const query = document.getElementById('emojiSearchInput').value.toLowerCase().trim();
  if (!query) { renderEmojis(allDairyEmojis); return; }
  const filtered = allDairyEmojis.filter(item => item.keywords.some(k => k.includes(query)));
  
  if (filtered.length === 0) {
    // Show message with link to find emojis
    const grid = document.getElementById('emojiGrid');
    if (grid) {
      const searchWithoutSpace = query.replace(/\s+/g, '');
      grid.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px;">
          <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
          <div style="font-size: 14px; font-weight: 700; color: #64748b; margin-bottom: 8px;">
            No emojis found for "${query}"
          </div>
          <div style="font-size: 12px; color: #94a3b8; margin-bottom: 16px;">
            Find and copy emojis from
          </div>
          <a href="https://emojicombos.com/${searchWithoutSpace}" target="_blank" 
             style="display: inline-block; padding: 10px 20px; background: linear-gradient(135deg, #7c3aed, #6d28d9); color: white; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 13px; transition: all 0.2s;"
             onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            üé≠ Open EmojiCombos ‚Üí
          </a>
          <div style="font-size: 11px; color: #64748b; margin-top: 12px;">
            Click link ‚Üí Copy emoji ‚Üí Paste in field
          </div>
        </div>
      `;
    }
    const lastDiv = document.getElementById('lastSelectedEmoji');
    if (lastDiv) lastDiv.style.display = 'block';
  } else {
    renderEmojis(filtered);
  }
}

function selectEmoji(emoji) {
  lastSelectedEmoji = emoji;
  const emojiInput = document.getElementById('pEmoji');
  if (emojiInput) {
    emojiInput.value = emoji;
    emojiInput.style.borderColor = '#16a34a';
    emojiInput.style.background = '#f0fdf4';
    setTimeout(() => { emojiInput.style.borderColor = '#3b82f6'; emojiInput.style.background = 'white'; }, 500);
  }
  closeModal('emojiPickerModal');
  showToast(`‚úÖ Emoji ${emoji} selected!`);
}

function useLastEmoji() {
  if (lastSelectedEmoji) selectEmoji(lastSelectedEmoji);
}

// Customer Emoji Picker Functions
let customerLastEmoji = 'üë§';
const customerEmojis = [
  { emoji: 'üë§', keywords: ['person', 'silhouette', 'customer'] },
  { emoji: 'üë•', keywords: ['people', 'group', 'customers'] },
  { emoji: 'üë®', keywords: ['man', 'male', 'person'] },
  { emoji: 'üë©', keywords: ['woman', 'female', 'person'] },
  { emoji: 'üë¶', keywords: ['boy', 'child', 'young'] },
  { emoji: 'üëß', keywords: ['girl', 'child', 'young'] },
  { emoji: 'üßë', keywords: ['person', 'adult', 'neutral'] },
  { emoji: 'üë¥', keywords: ['old', 'man', 'elderly', 'senior'] },
  { emoji: 'üëµ', keywords: ['old', 'woman', 'elderly', 'senior'] },
  { emoji: 'üë®‚Äçüíº', keywords: ['business', 'man', 'professional', 'office'] },
  { emoji: 'üë©‚Äçüíº', keywords: ['business', 'woman', 'professional', 'office'] },
  { emoji: 'üë®‚Äçüåæ', keywords: ['farmer', 'man', 'agriculture'] },
  { emoji: 'üë©‚Äçüåæ', keywords: ['farmer', 'woman', 'agriculture'] },
  { emoji: 'üë®‚Äçüç≥', keywords: ['cook', 'chef', 'man'] },
  { emoji: 'üë©‚Äçüç≥', keywords: ['cook', 'chef', 'woman'] },
  { emoji: 'üë®‚Äçüîß', keywords: ['mechanic', 'worker', 'man'] },
  { emoji: 'üë©‚Äçüîß', keywords: ['mechanic', 'worker', 'woman'] },
  { emoji: 'üë®‚Äçüè≠', keywords: ['factory', 'worker', 'man', 'industrial'] },
  { emoji: 'üë©‚Äçüè≠', keywords: ['factory', 'worker', 'woman', 'industrial'] },
  { emoji: 'üë®‚Äçüíª', keywords: ['technology', 'coder', 'man', 'developer'] },
  { emoji: 'üë©‚Äçüíª', keywords: ['technology', 'coder', 'woman', 'developer'] },
  { emoji: 'üë®‚Äçüéì', keywords: ['student', 'graduate', 'man'] },
  { emoji: 'üë©‚Äçüéì', keywords: ['student', 'graduate', 'woman'] },
  { emoji: 'üë®‚Äçüé§', keywords: ['singer', 'performer', 'man'] },
  { emoji: 'üë©‚Äçüé§', keywords: ['singer', 'performer', 'woman'] },
  { emoji: 'üë®‚Äç‚öïÔ∏è', keywords: ['doctor', 'health', 'man', 'nurse'] },
  { emoji: 'üë©‚Äç‚öïÔ∏è', keywords: ['doctor', 'health', 'woman', 'nurse'] },
  { emoji: 'üë®‚Äçüè´', keywords: ['teacher', 'professor', 'man'] },
  { emoji: 'üë©‚Äçüè´', keywords: ['teacher', 'professor', 'woman'] },
  { emoji: 'üë®‚Äç‚öñÔ∏è', keywords: ['judge', 'law', 'man'] },
  { emoji: 'üë©‚Äç‚öñÔ∏è', keywords: ['judge', 'law', 'woman'] },
  { emoji: 'üë®‚ÄçüöÄ', keywords: ['astronaut', 'space', 'man'] },
  { emoji: 'üë©‚ÄçüöÄ', keywords: ['astronaut', 'space', 'woman'] },
  { emoji: 'üë®‚Äçüöí', keywords: ['firefighter', 'fire', 'man'] },
  { emoji: 'üë©‚Äçüöí', keywords: ['firefighter', 'fire', 'woman'] },
  { emoji: 'üëÆ', keywords: ['police', 'officer', 'law'] },
  { emoji: 'üëÆ‚Äç‚ôÇÔ∏è', keywords: ['police', 'officer', 'man', 'law'] },
  { emoji: 'üëÆ‚Äç‚ôÄÔ∏è', keywords: ['police', 'officer', 'woman', 'law'] },
  { emoji: 'üïµÔ∏è', keywords: ['detective', 'spy', 'investigator'] },
  { emoji: 'üïµÔ∏è‚Äç‚ôÇÔ∏è', keywords: ['detective', 'spy', 'man'] },
  { emoji: 'üïµÔ∏è‚Äç‚ôÄÔ∏è', keywords: ['detective', 'spy', 'woman'] },
  { emoji: 'üíÇ', keywords: ['guard', 'royal', 'british'] },
  { emoji: 'üíÇ‚Äç‚ôÇÔ∏è', keywords: ['guard', 'man', 'royal'] },
  { emoji: 'üíÇ‚Äç‚ôÄÔ∏è', keywords: ['guard', 'woman', 'royal'] },
  { emoji: 'üë∑', keywords: ['construction', 'worker', 'builder'] },
  { emoji: 'üë∑‚Äç‚ôÇÔ∏è', keywords: ['construction', 'worker', 'man'] },
  { emoji: 'üë∑‚Äç‚ôÄÔ∏è', keywords: ['construction', 'worker', 'woman'] },
  { emoji: 'ü§¥', keywords: ['prince', 'royal', 'king'] },
  { emoji: 'üë∏', keywords: ['princess', 'royal', 'queen'] },
  { emoji: 'ü§µ', keywords: ['tuxedo', 'formal', 'waiter'] },
  { emoji: 'üë∞', keywords: ['bride', 'wedding', 'marriage'] },
  { emoji: 'ü§∞', keywords: ['pregnant', 'woman', 'expecting'] },
  { emoji: 'ü§±', keywords: ['breastfeeding', 'mother', 'baby'] },
  { emoji: 'üëº', keywords: ['angel', 'baby', 'heaven'] },
  { emoji: 'üéÖ', keywords: ['santa', 'christmas', 'father'] },
  { emoji: 'ü§∂', keywords: ['mrs', 'claus', 'christmas'] },
  { emoji: 'ü¶∏', keywords: ['superhero', 'hero', 'power'] },
  { emoji: 'ü¶∏‚Äç‚ôÇÔ∏è', keywords: ['superhero', 'man', 'hero'] },
  { emoji: 'ü¶∏‚Äç‚ôÄÔ∏è', keywords: ['superhero', 'woman', 'hero'] },
  { emoji: 'ü¶π', keywords: ['supervillain', 'villain', 'evil'] },
  { emoji: 'ü¶π‚Äç‚ôÇÔ∏è', keywords: ['supervillain', 'man', 'villain'] },
  { emoji: 'ü¶π‚Äç‚ôÄÔ∏è', keywords: ['supervillain', 'woman', 'villain'] },
  { emoji: 'üßô', keywords: ['wizard', 'mage', 'magic'] },
  { emoji: 'üßô‚Äç‚ôÇÔ∏è', keywords: ['wizard', 'man', 'magic'] },
  { emoji: 'üßô‚Äç‚ôÄÔ∏è', keywords: ['wizard', 'woman', 'magic'] },
  { emoji: 'üßö', keywords: ['fairy', 'wings', 'magical'] },
  { emoji: 'üßö‚Äç‚ôÇÔ∏è', keywords: ['fairy', 'man', 'wings'] },
  { emoji: 'üßö‚Äç‚ôÄÔ∏è', keywords: ['fairy', 'woman', 'wings'] },
  { emoji: 'üßõ', keywords: ['vampire', 'dracula', 'undead'] },
  { emoji: 'üßõ‚Äç‚ôÇÔ∏è', keywords: ['vampire', 'man', 'dracula'] },
  { emoji: 'üßõ‚Äç‚ôÄÔ∏è', keywords: ['vampire', 'woman', 'dracula'] },
  { emoji: 'üßú', keywords: ['merperson', 'mermaid', 'ocean'] },
  { emoji: 'üßú‚Äç‚ôÇÔ∏è', keywords: ['merman', 'man', 'ocean'] },
  { emoji: 'üßú‚Äç‚ôÄÔ∏è', keywords: ['mermaid', 'woman', 'ocean'] },
  { emoji: 'üßù', keywords: ['elf', 'magical', 'pointed'] },
  { emoji: 'üßù‚Äç‚ôÇÔ∏è', keywords: ['elf', 'man', 'magical'] },
  { emoji: 'üßù‚Äç‚ôÄÔ∏è', keywords: ['elf', 'woman', 'magical'] },
  { emoji: 'üßû', keywords: ['genie', 'djinn', 'magical'] },
  { emoji: 'üßû‚Äç‚ôÇÔ∏è', keywords: ['genie', 'man', 'magical'] },
  { emoji: 'üßû‚Äç‚ôÄÔ∏è', keywords: ['genie', 'woman', 'magical'] },
  { emoji: 'üßü', keywords: ['zombie', 'undead', 'walking'] },
  { emoji: 'üßü‚Äç‚ôÇÔ∏è', keywords: ['zombie', 'man', 'undead'] },
  { emoji: 'üßü‚Äç‚ôÄÔ∏è', keywords: ['zombie', 'woman', 'undead'] },
];

function openCustomerEmojiPicker() {
  renderCustomerEmojis(customerEmojis);
  openModal('customerEmojiPickerModal');
  document.getElementById('customerEmojiSearchInput').focus();
}

function renderCustomerEmojis(emojis) {
  const grid = document.getElementById('customerEmojiGrid');
  if (!grid) return;
  grid.innerHTML = emojis.map(item => `
    <button onclick="selectCustomerEmoji('${item.emoji}')"
            style="font-size: 32px; padding: 8px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
            onmouseover="this.style.borderColor='#3b82f6'; this.style.transform='scale(1.1)'"
            onmouseout="this.style.borderColor='#e2e8f0'; this.style.transform='scale(1)'"
            title="${item.keywords.join(', ')}">
      ${item.emoji}
    </button>
  `).join('');
  const lastDiv = document.getElementById('customerLastSelectedEmoji');
  const lastBtn = document.getElementById('customerLastEmojiBtn');
  if (lastDiv && lastBtn) {
    if (customerLastEmoji && customerLastEmoji !== 'üë§') {
      lastDiv.style.display = 'block';
      lastBtn.textContent = customerLastEmoji;
    } else {
      lastDiv.style.display = 'none';
    }
  }
}

function filterCustomerEmojis() {
  const query = document.getElementById('customerEmojiSearchInput').value.toLowerCase().trim();
  if (!query) { renderCustomerEmojis(customerEmojis); return; }
  const filtered = customerEmojis.filter(item => item.keywords.some(k => k.includes(query)));
  if (filtered.length === 0) {
    const grid = document.getElementById('customerEmojiGrid');
    if (grid) {
      const searchWithoutSpace = query.replace(/\s+/g, '');
      grid.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px;">
          <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
          <div style="font-size: 14px; font-weight: 700; color: #64748b; margin-bottom: 8px;">
            No emojis found for "${query}"
          </div>
          <div style="font-size: 12px; color: #94a3b8; margin-bottom: 16px;">
            Find and copy emojis from
          </div>
          <a href="https://emojicombos.com/${searchWithoutSpace}" target="_blank" 
             style="display: inline-block; padding: 10px 20px; background: linear-gradient(135deg, #7c3aed, #6d28d9); color: white; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 13px; transition: all 0.2s;"
             onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            üé≠ Open EmojiCombos ‚Üí
          </a>
          <div style="font-size: 11px; color: #64748b; margin-top: 12px;">
            Click link ‚Üí Copy emoji ‚Üí Paste in field
          </div>
        </div>
      `;
    }
    const lastDiv = document.getElementById('customerLastSelectedEmoji');
    if (lastDiv) lastDiv.style.display = 'block';
  } else {
    renderCustomerEmojis(filtered);
  }
}

function selectCustomerEmoji(emoji) {
  customerLastEmoji = emoji;
  const emojiInput = document.getElementById('newCustEmoji');
  if (emojiInput) {
    emojiInput.value = emoji;
    emojiInput.style.borderColor = '#16a34a';
    emojiInput.style.background = '#f0fdf4';
    setTimeout(() => { emojiInput.style.borderColor = '#3b82f6'; emojiInput.style.background = 'white'; }, 500);
  }
  closeModal('customerEmojiPickerModal');
  showToast(`‚úÖ Customer emoji ${emoji} selected!`);
}

function useCustomerLastEmoji() {
  if (customerLastEmoji) selectCustomerEmoji(customerLastEmoji);
}

// Add quantity input field in Add Product modal
let qtyCount = 3;
function addQtyInput() {
  if (qtyCount >= 5) return;

  qtyCount++;
  const container = document.getElementById('qtyInputsContainer');
  const defaults = [10, 20];
  const qtyNum = qtyCount;
  const defaultValue = defaults[qtyCount - 4] || 10;

  const newDiv = document.createElement('div');
  newDiv.style.cssText = 'display:flex; flex-direction:column; gap:4px;';
  newDiv.innerHTML = `
    <label style="font-size:10px; font-weight:700; color:var(--muted); text-align:center;">Qty ${qtyNum}</label>
    <input type="number" class="pQty" value="${defaultValue}" step="any" onkeydown="handleQtyEnter(event)" style="padding:8px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-align:center; width:100%; box-sizing:border-box;" />
  `;
  container.appendChild(newDiv);

  // Update grid columns
  container.style.gridTemplateColumns = `repeat(${qtyCount}, 1fr)`;

  // Hide button if max reached
  if (qtyCount >= 5) {
    document.getElementById('addQtyBtn').style.display = 'none';
  }

  // Focus the new input
  const newInput = newDiv.querySelector('input');
  if (newInput) {
    newInput.focus();
    newInput.select();
  }
}

// Handle Enter key in quantity inputs - move to next or submit
function handleQtyEnter(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    const container = document.getElementById('qtyInputsContainer');
    const inputs = Array.from(container.querySelectorAll('input'));
    const currentIndex = inputs.indexOf(e.target);

    if (currentIndex < inputs.length - 1) {
      // Move to next input
      inputs[currentIndex + 1].focus();
      inputs[currentIndex + 1].select();
    } else {
      // Last input - submit form
      const form = container.closest('form');
      if (form) form.requestSubmit();
    }
  }
}

// Handle Enter key in product fields - move to next field
function handleProductFieldEnter(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    const form = e.target.closest('form');
    const inputs = Array.from(form.querySelectorAll('input:not([type="hidden"])'));
    const currentIndex = inputs.indexOf(e.target);
    
    if (currentIndex < inputs.length - 1) {
      // Move to next input
      inputs[currentIndex + 1].focus();
      if (inputs[currentIndex + 1].type !== 'number') {
        inputs[currentIndex + 1].select();
      }
    }
  }
}

// Add new product card from modal - creates multiple cards for each quantity
function addNewProductFromModal() {
  // Capitalize first letter of each word in product name
  const capitalizeName = (str) => {
    return str.replace(/\b\w/g, c => c.toUpperCase());
  };
  
  const name = capitalizeName(el("pName").value.trim());
  const price = parseFloat(el("pPrice").value);
  const unit = el("pUnit").value.trim() || 'unit';
  const emoji = el("pEmoji").value.trim() || 'üì¶';

  // Get all quantity values
  const qtyInputs = document.querySelectorAll('.pQty');
  const qtys = Array.from(qtyInputs).map(input => parseFloat(input.value) || 0);

  if (!name || !price) return showToast("Name and Price required!");

  const grid = el("productGrid");
  const addCardBtn = grid.querySelector('.p-card[onclick*="addProductModal"]');

  // Calculate ranks for new quantities - USE loadData() to get unwrapped data
  let customProducts = loadData('mr_pos_custom_products', []);

  // Ensure customProducts is always an array
  if (!Array.isArray(customProducts)) {
    console.error('‚ùå customProducts is not an array, forcing empty array');
    customProducts = [];
  }

  const allQtys = [...new Set([...customProducts.map(p => p.qty), ...qtys.filter(q => q !== 0)])].sort((a, b) => a - b);
  const qtyToRank = {};
  const rankQty = Math.ceil(allQtys.length / 5);
  allQtys.forEach((qty, idx) => {
    qtyToRank[qty] = Math.min(5, Math.floor(idx / rankQty) + 1);
  });

  // Create a card for each non-zero quantity
  qtys.forEach(qty => {
    if (qty === 0) return; // Skip zero quantities

    const rank = qtyToRank[qty] || 3;
    const newCard = document.createElement('div');
    newCard.className = 'p-card';
    newCard.setAttribute('data-qty', '1');
    newCard.setAttribute('data-qty-val', qty);
    newCard.setAttribute('data-rank', rank);
    newCard.setAttribute('draggable', 'true');
    newCard.ondragstart = handleDragStart;
    newCard.ondragend = handleDragEnd;
    newCard.onclick = function() { tapAdd(name, price, qty, emoji); };

    // Format quantity display - show exact quantity with unit (with fallback)
    const safeUnit = unit || 'unit';
    const qtyDisplay = `${qty}${safeUnit}`;
    const nameDisplay = `${name} (${qtyDisplay})`;

    newCard.innerHTML = `
      <span class="emoji">${emoji}</span>
      <div style="font-weight: 900; margin-top: 2px;">${nameDisplay}</div>
      <span class="price-tag">‚Çπ${price}/${safeUnit}</span>
      <button class="edit-prod-btn" onclick="event.stopPropagation(); editProductCard(this)" title="Edit Product" style="position: absolute; top: 4px; left: 4px; background: rgba(255,255,255,0.9); border: none; border-radius: 4px; cursor: pointer; font-size: 14px; padding: 2px; opacity: 0; transition: opacity 0.2s;">üìù</button>
      <div class="qty-badge" style="position: absolute; top: 4px; right: 4px; background: #dc2626; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center; display: none;">0</div>
    `;

    grid.insertBefore(newCard, addCardBtn);
  });

  // Save to localStorage (IMMEDIATE - works offline)
  qtys.forEach(qty => {
    if (qty !== 0) {
      customProducts.push({name, price, unit: unit || 'unit', emoji, qty});
    }
  });

  // Create TRIPLE backup
  try {
    const dataStr = JSON.stringify(customProducts);
    localStorage.setItem('mr_pos_custom_products', dataStr);
    localStorage.setItem('mr_pos_custom_products_backup', dataStr);
    localStorage.setItem('mr_pos_custom_products_backup2', dataStr);
  } catch(e) {
    console.error('‚ùå Failed to save products:', e);
  }

  // Queue for API sync (HYBRID SYNC - syncs when online)
  qtys.forEach(qty => {
    if (qty !== 0) {
      addToSyncQueue('save_product', {name, price, unit: unit || 'unit', emoji, qty});
    }
  });

  // Close modal and clear
  closeModal('addProductModal');
  el("pName").value = "";
  el("pPrice").value = "";
  el("pUnit").value = "";
  el("pEmoji").value = "";
  document.querySelectorAll('.pStep').forEach((input, i) => {
    input.value = [1, 2, 5, 10, 20][i];
  });

  const stepInputs = document.querySelectorAll('.pStep');
  const steps = Array.from(stepInputs).map(input => parseFloat(input.value) || 0);
  showToast(`Created ${steps.filter(s => s !== 0).length} product cards for ${name}`);
}

// Edit individual product card
function editProductCard(btn) {
  const card = btn.closest('.p-card');
  const nameDiv = card.querySelector('div[style*="font-weight: 900"]');
  const small = card.querySelector('small');
  
  const newName = prompt("Edit product name:", nameDiv.textContent.replace(/\s*\([^)]*\)\s*$/, ''));
  if (!newName) return;
  
  const newPrice = prompt("Edit price (‚Çπ):", small.textContent.replace('‚Çπ', '').split('/')[0]);
  if (!newPrice) return;
  
  // Update card
  nameDiv.textContent = newName + nameDiv.textContent.match(/\s*\([^)]*\)\s*$/)[0];
  small.textContent = `‚Çπ${parseFloat(newPrice)}/${small.textContent.split('/')[1]}`;
  
  // Update onclick handler
  const step = card.getAttribute('data-step');
  card.onclick = function() { tapAdd(newName, parseFloat(newPrice), parseFloat(step)); };
  
  showToast("Product updated ‚úÖ");
}

// Filter products by search
function filterProducts(query) {
  const search = query.toLowerCase().trim();
  const grid = document.getElementById("productGrid");
  const cards = grid.querySelectorAll('.p-card');

  let visibleCount = 0;
  let hasAddCard = grid.querySelector('.p-card.add-new-product');

  cards.forEach(card => {
    // Skip the "Add New Product" card
    if (card.classList.contains('add-new-product')) {
      return;
    }

    const text = card.textContent.toLowerCase();
    if (search === '' || text.includes(search)) {
      card.style.display = 'flex';
      visibleCount++;
    } else {
      card.style.display = 'none';
    }
  });

  // Show "Add New Product" card if search has no results
  if (search !== '' && visibleCount === 0) {
    if (!hasAddCard) {
      // Create "Add New Product" card
      const addCard = document.createElement('div');
      addCard.className = 'p-card add-new-product';
      addCard.style.background = '#f0fdf4';
      addCard.style.borderColor = '#16a34a';
      addCard.innerHTML = `
        <div style="font-size:48px; color:#16a34a; font-weight:900;">‚ûï</div>
        <div style="font-weight:900; color:#16a34a; font-size:10px; margin-top:4px;">Add "${escapeHtml(search)}"</div>
        <small style="color:#15803d; font-size:9px;">Click to create</small>
      `;
      addCard.onclick = function() {
        openModal('addProductModal');
        setTimeout(() => {
          el("newProdName").value = search.charAt(0).toUpperCase() + search.slice(1);
          el("newProdPrice").focus();
        }, 300);
      };

      // Insert before the regular "Add" button
      const regularAddBtn = grid.querySelector('.p-card[onclick*="addProductModal"]');
      if (regularAddBtn) {
        grid.insertBefore(addCard, regularAddBtn);
      }
    } else {
      hasAddCard.style.display = 'flex';
      hasAddCard.querySelector('div:nth-child(2)').innerHTML = `Add "${escapeHtml(search)}"`;
    }
  } else if (hasAddCard) {
    hasAddCard.style.display = 'none';
  }
}

// Filter products by category
let currentCategory = 'all';
function filterProductsByCategory(category) {
  currentCategory = category;
  const grid = document.getElementById("productGrid");
  const cards = grid.querySelectorAll('.p-card:not(.add-new-product)');
  const buttons = document.querySelectorAll('.category-btn');
  
  // Update button styles
  buttons.forEach(btn => {
    if (btn.onclick.toString().includes(`'${category}'`)) {
      btn.style.background = '#3b82f6';
      btn.style.color = 'white';
    } else {
      btn.style.background = 'white';
      btn.style.color = '#475569';
    }
  });
  
  // Category keywords mapping
  const categoryKeywords = {
    'all': [],
    'milk': ['milk', 'doodh', 'cow', 'buff', 'cream', 'lact'],
    'paneer': ['paneer', 'cheese', 'chhena'],
    'ghee': ['ghee', 'clarified butter', 'ghrit'],
    'curd': ['curd', 'dahi', 'yogurt', 'lassi'],
    'sweets': ['sweet', 'mithai', 'cake', 'barfi', 'ladoo', 'jalebi', 'rasgulla', 'peda', 'kalakand'],
    'bakery': ['bakery', 'bread', 'bun', 'pav', 'toast', 'rusk', 'biscuit', 'cookie', 'khari']
  };
  
  const keywords = categoryKeywords[category] || [];
  
  cards.forEach(card => {
    const text = card.textContent.toLowerCase();
    const name = card.getAttribute('data-name') || '';
    
    if (category === 'all' || keywords.some(kw => text.includes(kw) || name.toLowerCase().includes(kw))) {
      card.style.display = 'flex';
    } else {
      card.style.display = 'none';
    }
  });
  
  showToast(`üì¶ Showing ${category === 'all' ? 'All Products' : category.charAt(0).toUpperCase() + category.slice(1)} category`);
}

// Close customer search dropdown
function closeSearchDropdown() {
  const dropdown = el("searchDropdown");
  if (dropdown) dropdown.style.display = 'none';
}

// Add new product card (legacy function)
function addNewProduct() {
  addNewProductFromModal();
}

// Load custom products on page load - USES loadData()!
function loadCustomProducts() {
  // Check if localStorage has been initialized
  const hasInitialized = localStorage.getItem('mr_pos_initialized');
  
  // Use loadData() which handles both old and new formats
  let customProducts = loadData('mr_pos_custom_products', []);
  
  // If loadData failed, try backups using loadData()
  if (!Array.isArray(customProducts) || customProducts.length === 0) {
    customProducts = loadData('mr_pos_custom_products_backup', []);
    if (Array.isArray(customProducts) && customProducts.length > 0) {
      console.log('‚úÖ Recovered', customProducts.length, 'products from backup 1!');
    } else {
      customProducts = loadData('mr_pos_custom_products_backup2', []);
      if (Array.isArray(customProducts) && customProducts.length > 0) {
        console.log('‚úÖ Recovered', customProducts.length, 'products from backup 2!');
      }
    }
  }
  
  if (Array.isArray(customProducts)) {
    console.log('‚úÖ Loaded', customProducts.length, 'products');
  }
  
  // ALWAYS create BOTH backups immediately if we have valid data
  if (Array.isArray(customProducts) && customProducts.length > 0) {
    try {
      const dataStr = JSON.stringify(customProducts);
      localStorage.setItem('mr_pos_custom_products', dataStr);
      localStorage.setItem('mr_pos_custom_products_backup', dataStr);
      localStorage.setItem('mr_pos_custom_products_backup2', dataStr);
      console.log('‚úÖ Created triple backup of', customProducts.length, 'products');
    } catch(e) {
      console.error('‚ùå Failed to create backup:', e);
    }
  }

  // FINAL SAFETY: Ensure customProducts is always an array
  if (!Array.isArray(customProducts)) {
    console.error('‚ùå customProducts is still not an array, forcing empty array');
    customProducts = [];
  }

  // If no custom products AND never initialized, create defaults (first-time setup)
  if (customProducts.length === 0 && !hasInitialized) {
    createDefaultProducts();
    localStorage.setItem('mr_pos_initialized', 'true');
    return;
  }

  // If products exist but not initialized, mark as initialized
  if (customProducts.length > 0 && !hasInitialized) {
    localStorage.setItem('mr_pos_initialized', 'true');
  }

  const grid = el("productGrid");
  if (!grid) return;

  // Clear existing product cards (keep Add and Edit buttons)
  const existingCards = grid.querySelectorAll('.p-card:not([onclick*="addProductModal"]):not([onclick*="openEdit"])');
  existingCards.forEach(card => card.remove());

  // Get the Add button to insert before it
  const addCardBtn = grid.querySelector('.p-card[onclick*="addProductModal"]');
  if (!addCardBtn) return;

  // Group products by name - FINAL SAFETY CHECK
  const productGroups = {};
  if (Array.isArray(customProducts)) {
    customProducts.forEach(p => {
      if (!productGroups[p.name]) {
        productGroups[p.name] = {
          name: p.name,
          emoji: p.emoji || 'üì¶',
          price: p.price,
          unit: p.unit || 'unit',
          qtys: []
        };
      }
      productGroups[p.name].qtys.push(p.qty);
    });
  } else {
    console.error('‚ùå customProducts is not an array, using empty array');
  }

  let products = Object.values(productGroups);

  // Apply saved product order if exists - USE loadData()
  let productOrder = loadData('mr_pos_product_order', []);
  if (!Array.isArray(productOrder)) productOrder = [];

  if (productOrder.length > 0) {
    products.sort((a, b) => {
      const indexA = productOrder.indexOf(a.name);
      const indexB = productOrder.indexOf(b.name);
      return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
    });
  }

  // Sort quantities within each product (step-wise: smallest to largest)
  products.forEach(p => {
    if (Array.isArray(p.qtys)) {
      p.qtys.sort((a, b) => a - b); // Sort ascending: 0.5, 1, 2
    }
  });

  // Count total product cards
  const totalCards = products.reduce((sum, p) => sum + (p.qtys?.length || 0), 0);
  
  // Auto-enable features based on product count
  const enableCompact = totalCards > 30;
  const hidePrices = totalCards > 50;
  const hideEmoji = totalCards > 40;  // Hide emoji before prices

  // Calculate quantity ranks (1-5 based on relative quantity sizes) - SAFETY CHECK
  const allQtys = Array.isArray(customProducts)
    ? [...new Set(customProducts.map(p => p.qty))].sort((a, b) => a - b)
    : [];
  const qtyToRank = {};
  const rankQty = Math.ceil(allQtys.length / 5);
  allQtys.forEach((qty, idx) => {
    qtyToRank[qty] = Math.min(5, Math.floor(idx / rankQty) + 1);
  });

  products.forEach(p => {
    if (Array.isArray(p.qtys)) {
      p.qtys.forEach(qty => {
        const rank = qtyToRank[qty] || 3;
        const safeUnit = p.unit || 'unit';
        const safeQty = qty || 1;
        const safePrice = p.price || 0;

        const newCard = document.createElement('div');
        newCard.className = 'p-card';
        
        // Add classes based on product count (emoji hides first!)
        if (enableCompact) newCard.classList.add('compact');
        if (hideEmoji) newCard.classList.add('no-emoji');  // Hide emoji first
        if (hidePrices) newCard.classList.add('no-price');  // Then hide prices
        
        newCard.setAttribute('data-qty', '1');
        newCard.setAttribute('data-qty-val', safeQty);
        newCard.setAttribute('data-rank', rank);
        newCard.setAttribute('draggable', 'true');
        newCard.ondragstart = handleDragStart;
        newCard.ondragend = handleDragEnd;
        newCard.onclick = function() { tapAdd(p.name, safePrice, safeQty); };

        const qtyDisplay = `${safeQty}${safeUnit}`;
        const nameDisplay = `${p.name} (${qtyDisplay})`;

        newCard.innerHTML = `
          <span class="emoji">${p.emoji || 'üì¶'}</span>
          <div style="font-weight: 900;" title="${nameDisplay}">${nameDisplay}</div>
          <span class="price-tag">‚Çπ${safePrice}/${safeUnit}</span>
          <button class="edit-prod-btn" onclick="event.stopPropagation(); editProductCard(this)" title="Edit Product" style="position: absolute; top: 4px; left: 4px; background: rgba(255,255,255,0.9); border: none; border-radius: 4px; cursor: pointer; font-size: 14px; padding: 2px; opacity: 0; transition: opacity 0.2s;">üìù</button>
          <div class="qty-badge" style="position: absolute; top: 4px; right: 4px; background: #dc2626; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center; display: none;">0</div>
        `;
        grid.insertBefore(newCard, addCardBtn);
      });
    }
  });
  
  // Log mode
  if (enableCompact) console.log('üì¶ Compact mode enabled (' + totalCards + ' products)');
  if (hideEmoji) console.log('üé≠ Emoji hidden (' + totalCards + ' products)');
  if (hidePrices) console.log('üí∞ Prices hidden (' + totalCards + ' products)');
  
  // Always move action buttons to last row
  moveActionButtonsToLastRow();
}

// Move action buttons (Create, Edit, Convert) to always be in the last row
function moveActionButtonsToLastRow() {
  const grid = document.getElementById('productGrid');
  if (!grid) return;
  
  // Find action button cards
  const createActionCard = grid.querySelector('.p-card[onclick*="addProductModal"]');
  const editActionCard = grid.querySelector('.p-card[onclick*="openEditInventory"]');
  const convertActionCard = grid.querySelector('.p-card[onclick*="convertModal"]');
  
  if (!createActionCard || !editActionCard || !convertActionCard) return;
  
  // Get all product cards (excluding action buttons)
  const productCards = Array.from(grid.querySelectorAll('.p-card:not([onclick*="addProductModal"]):not([onclick*="openEditInventory"]):not([onclick*="convertModal"])'));
  
  if (productCards.length === 0) return;
  
  // Calculate how many cards fit per row (based on grid-template-columns)
  const gridStyle = window.getComputedStyle(grid);
  const templateColumns = gridStyle.gridTemplateColumns;
  const cardsPerRow = templateColumns.split(' ').length || 4;
  
  // Calculate how many cards needed to fill second-to-last row
  const remainingCards = productCards.length % cardsPerRow;
  const cardsNeeded = remainingCards === 0 ? 0 : cardsPerRow - remainingCards;
  
  // Move action buttons to end
  if (cardsNeeded > 0) {
    // Add spacer cards if needed to fill second-to-last row
    for (let i = 0; i < cardsNeeded; i++) {
      const spacer = document.createElement('div');
      spacer.className = 'p-card';
      spacer.style.visibility = 'hidden';
      spacer.style.pointerEvents = 'none';
      grid.insertBefore(spacer, createActionCard);
    }
  }
  
  // Ensure action buttons are at the end
  grid.appendChild(createActionCard);
  grid.appendChild(editActionCard);
  grid.appendChild(convertActionCard);
}

// Create default products on first-time setup
function createDefaultProducts() {
  const defaultProducts = [
    // Cow Milk - Step wise quantities
    { name: 'Cow Milk', emoji: 'üêÑ', price: 64, unit: 'L', qty: 0.5 },
    { name: 'Cow Milk', emoji: 'üêÑ', price: 64, unit: 'L', qty: 1 },
    { name: 'Cow Milk', emoji: 'üêÑ', price: 64, unit: 'L', qty: 2 },
    // Buffalo Milk - Step wise quantities
    { name: 'Buff Milk', emoji: 'üêÉ', price: 100, unit: 'L', qty: 0.5 },
    { name: 'Buff Milk', emoji: 'üêÉ', price: 100, unit: 'L', qty: 1 },
    { name: 'Buff Milk', emoji: 'üêÉ', price: 100, unit: 'L', qty: 2 },
    // Paneer - Step wise quantities
    { name: 'Paneer', emoji: 'üßÄ', price: 320, unit: 'kg', qty: 0.25 },
    { name: 'Paneer', emoji: 'üßÄ', price: 320, unit: 'kg', qty: 0.5 },
    { name: 'Paneer', emoji: 'üßÄ', price: 320, unit: 'kg', qty: 1 },
    // Ghee - Step wise quantities
    { name: 'Ghee', emoji: 'üßà', price: 800, unit: 'kg', qty: 0.25 },
    { name: 'Ghee', emoji: 'üßà', price: 800, unit: 'kg', qty: 0.5 },
    { name: 'Ghee', emoji: 'üßà', price: 800, unit: 'kg', qty: 1 },
    // Milk Cake - Step wise quantities
    { name: 'Milk Cake', emoji: 'üç∞', price: 400, unit: 'kg', qty: 0.5 },
    { name: 'Milk Cake', emoji: 'üç∞', price: 400, unit: 'kg', qty: 1 },
    // Curd - Step wise quantities
    { name: 'Curd', emoji: 'ü•£', price: 120, unit: 'kg', qty: 0.5 },
    { name: 'Curd', emoji: 'ü•£', price: 120, unit: 'kg', qty: 1 },
  ];

  try {
    const dataStr = JSON.stringify(defaultProducts);
    localStorage.setItem('mr_pos_custom_products', dataStr);
    localStorage.setItem('mr_pos_custom_products_backup', dataStr);
    localStorage.setItem('mr_pos_custom_products_backup2', dataStr);
    console.log('‚úÖ Created ' + defaultProducts.length + ' default products with triple backup');
  } catch(e) {
    console.error('‚ùå Failed to create default products:', e);
  }

  // Load the newly created products
  loadCustomProducts();
}

// Edit Products Modal - shows custom products from localStorage
function openEditInventory() {
  const list = el("editInventoryList");

  // Get custom products from localStorage - USE loadData()
  const customProducts = loadData('mr_pos_custom_products', []);
  
  // Ensure customProducts is always an array
  if (!Array.isArray(customProducts)) {
    console.error('‚ùå customProducts is not an array, using empty array');
    localStorage.setItem('mr_pos_custom_products', JSON.stringify([]));
    return;
  }

  // Group by product name (since each product can have multiple quantity cards)
  const productGroups = {};
  customProducts.forEach(p => {
    if (!productGroups[p.name]) {
      productGroups[p.name] = {
        name: p.name,
        emoji: p.emoji || 'üì¶',
        rate: p.price,
        unit: p.unit || 'unit',
        qtys: []
      };
    }
    productGroups[p.name].qtys.push(p.qty);
  });

  let products = Object.values(productGroups);

  // Apply saved product order if exists - USE loadData()
  const productOrder = loadData('mr_pos_product_order', []);
  if (productOrder.length > 0) {
    products.sort((a, b) => {
      const indexA = productOrder.indexOf(a.name);
      const indexB = productOrder.indexOf(b.name);
      // If not in order, put at end
      return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
    });
  }

  if (products.length === 0) {
    list.innerHTML = `
      <div style="padding:30px; text-align:center;">
        <div style="font-size:48px; margin-bottom:15px;">üì¶</div>
        <h3 style="margin:0 0 10px 0; color:#1e293b;">No products yet</h3>
        <p style="color:#64748b; font-size:13px; margin:0 0 20px 0;">Add your first product to get started</p>
        <button onclick="closeModal('editInventoryModal'); setTimeout(() => openModal('addProductModal'), 300);" style="padding:12px 24px; background:#3b82f6; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer;">‚ûï Add Product</button>
      </div>
    `;
    openModal('editInventoryModal');
    return;
  }

  list.innerHTML = products.map((p, i) => `
    <div style="padding:12px; background:#f8fafc; border-radius:10px; border:1px solid var(--line); cursor:grab;" draggable="true" ondragstart="handleProductOrderDragStart(event)" ondragover="handleProductOrderDragOver(event)" ondragleave="handleProductOrderDragLeave(event)" ondrop="handleProductOrderDrop(event)" ondragend="handleProductOrderDragEnd(event)" data-index="${i}">
      <div style="display:grid; grid-template-columns: 30px 36px 1fr 70px 55px; gap:8px; align-items:center; margin-bottom:10px;">
        <div style="font-size:18px; color:#94a3b8; cursor:grab;" title="Drag to reorder">‚ãÆ‚ãÆ</div>
        <div style="font-size:20px;">${p.emoji}</div>
        <input type="text" id="editName_${i}" value="${p.name}" style="padding:8px; border:2px solid #e2e8f0; border-radius:6px; font-weight:700; font-size:12px; min-width:0;" />
        <input type="number" id="editRate_${i}" value="${p.rate}" style="padding:8px; border:2px solid #e2e8f0; border-radius:6px; font-weight:700; text-align:center; font-size:12px;" />
        <input type="text" id="editUnit_${i}" value="${p.unit}" style="padding:8px; border:2px solid #e2e8f0; border-radius:6px; font-weight:700; text-align:center; font-size:12px;" />
      </div>

      <div style="font-size:10px; font-weight:700; color:var(--muted); margin-bottom:8px; display:flex; align-items:center; gap:6px;">
        <span>‚ö°</span> Quantities (edit or set 0 to disable):
      </div>
      <div style="display:grid; grid-template-columns: repeat(4, 1fr) 80px; gap:6px;">
        <div style="display:flex; flex-direction:column; gap:2px;">
          <label style="font-size:8px; font-weight:700; color:var(--muted); text-align:center;">1</label>
          <input type="number" id="editQty_${i}_0" value="${p.qtys[0] || ''}" step="any" style="padding:6px; border:1px solid #e2e8f0; border-radius:4px; font-weight:700; text-align:center; font-size:11px; width:100%; box-sizing:border-box;" />
        </div>
        <div style="display:flex; flex-direction:column; gap:2px;">
          <label style="font-size:8px; font-weight:700; color:var(--muted); text-align:center;">2</label>
          <input type="number" id="editQty_${i}_1" value="${p.qtys[1] || ''}" step="any" style="padding:6px; border:1px solid #e2e8f0; border-radius:4px; font-weight:700; text-align:center; font-size:11px; width:100%; box-sizing:border-box;" />
        </div>
        <div style="display:flex; flex-direction:column; gap:2px;">
          <label style="font-size:8px; font-weight:700; color:var(--muted); text-align:center;">3</label>
          <input type="number" id="editQty_${i}_2" value="${p.qtys[2] || ''}" step="any" style="padding:6px; border:1px solid #e2e8f0; border-radius:4px; font-weight:700; text-align:center; font-size:11px; width:100%; box-sizing:border-box;" />
        </div>
        <div style="display:flex; flex-direction:column; gap:2px;">
          <label style="font-size:8px; font-weight:700; color:var(--muted); text-align:center;">4</label>
          <input type="number" id="editQty_${i}_3" value="${p.qtys[3] || ''}" step="any" style="padding:6px; border:1px solid #e2e8f0; border-radius:4px; font-weight:700; text-align:center; font-size:11px; width:100%; box-sizing:border-box;" />
        </div>
        <div style="display:flex; flex-direction:column; gap:2px; justify-content:flex-end;">
          <button onclick="removeProduct('${p.name}')" style="padding:6px; background:#fecaca; color:#dc2626; border:1px solid #ef4444; border-radius:4px; font-weight:700; text-align:center; font-size:10px; cursor:pointer; width:100%; height:28px;" title="Remove this product">üóëÔ∏è Remove</button>
        </div>
      </div>

      <button onclick="updateProductWithQty(${i}, '${p.name}')" style="margin-top:10px; padding:8px 16px; background:#22c55e; color:white; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:12px; width:100%;">üíæ Update Product</button>
    </div>
  `).join('');

  openModal('editInventoryModal');
}

function updateProductWithQty(index, oldName) {
  const newName = el(`editName_${index}`).value;
  const newRate = parseFloat(el(`editRate_${index}`).value);
  const newUnit = el(`editUnit_${index}`).value;

  // Get 4 quantity values
  const newQtys = [
    parseFloat(el(`editQty_${index}_0`).value) || 0,
    parseFloat(el(`editQty_${index}_1`).value) || 0,
    parseFloat(el(`editQty_${index}_2`).value) || 0,
    parseFloat(el(`editQty_${index}_3`).value) || 0
  ];

  if (!newName || !newRate || newRate <= 0) return showToast('Invalid name or rate!');

  // Update in localStorage (for custom products) - USE loadData()
  let customProducts = loadData('mr_pos_custom_products', []);

  // Ensure customProducts is always an array
  if (!Array.isArray(customProducts)) {
    console.error('‚ùå customProducts is not an array, using empty array');
    customProducts = [];
  }

  // Remove old product cards for this product
  const filteredProducts = customProducts.filter(p => p.name !== oldName);

  // Add new product cards for each non-zero quantity
  newQtys.forEach(qty => {
    if (qty !== 0) {
      filteredProducts.push({
        name: newName,
        price: newRate,
        unit: newUnit,
        qty: qty
      });
    }
  });

  // Create TRIPLE backup
  try {
    const dataStr = JSON.stringify(filteredProducts);
    localStorage.setItem('mr_pos_custom_products', dataStr);
    localStorage.setItem('mr_pos_custom_products_backup', dataStr);
    localStorage.setItem('mr_pos_custom_products_backup2', dataStr);
  } catch(e) {
    console.error('‚ùå Failed to save:', e);
  }

  const activeQtys = newQtys.filter(q => q !== 0);
  showToast(`${newName} updated! ‚Çπ${newRate}/${newUnit} (${activeQtys.length} quantities: ${activeQtys.join(', ')}) ‚úÖ`);
  closeModal('editInventoryModal');

  // Reload page to apply changes
  setTimeout(() => location.reload(), 1000);
}

function removeProduct(productName) {
  if (!confirm(`Remove "${productName}" from product list?`)) return;

  // USE loadData() to get unwrapped data
  let customProducts = loadData('mr_pos_custom_products', []);

  // Ensure customProducts is always an array
  if (!Array.isArray(customProducts)) {
    console.error('‚ùå customProducts is not an array, using empty array');
    customProducts = [];
  }

  const filteredProducts = customProducts.filter(p => p.name !== productName);

  // Create TRIPLE backup
  try {
    const dataStr = JSON.stringify(filteredProducts);
    localStorage.setItem('mr_pos_custom_products', dataStr);
    localStorage.setItem('mr_pos_custom_products_backup', dataStr);
    localStorage.setItem('mr_pos_custom_products_backup2', dataStr);
  } catch(e) {
    console.error('‚ùå Failed to save:', e);
  }

  showToast(`${productName} removed ‚úÖ`);
  closeModal('editInventoryModal');

  // Reload page to apply changes
  setTimeout(() => location.reload(), 1000);
}

// Drag and drop for product order in Edit Products modal
let draggedProductIndex = null;

function handleProductOrderDragStart(e) {
  draggedProductIndex = parseInt(this.getAttribute('data-index'));
  this.style.opacity = '0.6';
  this.style.background = '#e0f2fe';
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', draggedProductIndex);
  console.log('üîµ Drag started:', draggedProductIndex);
}

function handleProductOrderDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  this.style.borderLeft = '4px solid #3b82f6';
  this.style.background = '#f0f9ff';
  return false;
}

function handleProductOrderDragLeave(e) {
  this.style.borderLeft = '';
  this.style.background = '#f8fafc';
}

function handleProductOrderDrop(e) {
  e.preventDefault();
  e.stopPropagation();

  const dropIndex = parseInt(this.getAttribute('data-index'));

  // Remove border highlights
  document.querySelectorAll('#editInventoryList > div').forEach(div => {
    div.style.borderLeft = '';
    div.style.background = '#f8fafc';
    div.style.opacity = '1';
  });

  if (draggedProductIndex === null || draggedProductIndex === dropIndex) {
    draggedProductIndex = null;
    return false;
  }

  console.log('üîµ Drop:', draggedProductIndex, '‚Üí', dropIndex);

  // Get current product order from localStorage - USE loadData()
  let productOrder = loadData('mr_pos_product_order', []);
  if (!Array.isArray(productOrder)) productOrder = [];

  // Get all products from localStorage - USE loadData()
  const customProducts = loadData('mr_pos_custom_products', []);
  // Ensure customProducts is always an array
  if (!Array.isArray(customProducts)) {
    console.error('‚ùå customProducts is not an array, using empty array');
    draggedProductIndex = null;
    return false;
  }

  // If productOrder is empty, initialize it with current order
  if (productOrder.length === 0) {
    // Group products by name
    const productGroups = {};
    customProducts.forEach(p => {
      if (!productGroups[p.name]) {
        productGroups[p.name] = {
          name: p.name,
          emoji: p.emoji || 'üì¶',
          rate: p.price,
          unit: p.unit || 'unit',
          qtys: []
        };
      }
      productGroups[p.name].qtys.push(p.qty);
    });
    productOrder = Object.keys(productGroups);
  }

  // Reorder
  const draggedName = productOrder[draggedProductIndex];
  productOrder.splice(draggedProductIndex, 1);
  productOrder.splice(dropIndex, 0, draggedName);

  // Save new order - USE saveData() for consistency
  saveData('mr_pos_product_order', productOrder, 'order_update');

  showToast('‚úÖ Product order updated');
  draggedProductIndex = null;

  // Reload modal to show new order
  setTimeout(() => {
    openEditInventory();
  }, 300);

  return false;
}

function handleProductOrderDragEnd(e) {
  this.style.opacity = '1';
  this.style.background = '#f8fafc';
  draggedProductIndex = null;
  // Remove any remaining highlights
  document.querySelectorAll('#editInventoryList > div').forEach(div => {
    div.style.borderLeft = '';
    div.style.background = '#f8fafc';
  });
}

function updateBooth() {
  const booth = el("boothSelect").value;
  const boothNames = {
    'main': 'Main Booth',
    'village-a': 'Village A Booth',
    'village-b': 'Village B Booth',
    'market': 'Market Booth'
  };
  localStorage.setItem('MilkRecord_booth', booth);
  localStorage.setItem('MilkRecord_shop_name', boothNames[booth]);
  showToast(`Booth: ${boothNames[booth]}`);
}

// Check if account exists with email/phone
async function checkAccountExists(email, phone) {
  try {
    // Check local storage first
    const existingEmail = localStorage.getItem('MilkRecord_account_email');
    const existingPhone = localStorage.getItem('MilkRecord_account_phone');
    
    if (existingEmail && email && existingEmail.toLowerCase() === email.toLowerCase()) {
      return { exists: true, type: 'email', message: 'Account with this email already exists' };
    }
    
    if (existingPhone && phone && existingPhone === phone) {
      return { exists: true, type: 'phone', message: 'Account with this phone already exists' };
    }
    
    // If Supabase is available, check there too
    if (typeof supabase !== 'undefined') {
      const { data, error } = await supabase
        .from('dairy_shops')
        .select('id')
        .or(`email.eq.${email},phone.eq.${phone}`)
        .limit(1);
      
      if (data && data.length > 0) {
        return { exists: true, type: 'supabase', message: 'Account already exists in cloud' };
      }
    }
    
    return { exists: false };
  } catch (error) {
    console.error('Error checking account:', error);
    return { exists: false, error: error.message };
  }
}

// Create account with shop details
async function createAccount(shopData) {
  try {
    // Create account object
    const account = {
      email: shopData.email,
      phone: shopData.phone,
      shopName: shopData.shopName,
      createdAt: new Date().toISOString(),
      verified: false
    };
    
    // Save to local storage
    localStorage.setItem('MilkRecord_account_email', shopData.email || '');
    localStorage.setItem('MilkRecord_account_phone', shopData.phone || '');
    localStorage.setItem('MilkRecord_session', JSON.stringify({
      email: shopData.email,
      phone: shopData.phone,
      shop_name: shopData.shopName,
      created_at: account.createdAt
    }));
    
    // Try to sync with Supabase if available
    if (typeof supabase !== 'undefined') {
      const { data, error } = await supabase
        .from('dairy_shops')
        .insert([{
          email: shopData.email,
          phone: shopData.phone,
          shop_name: shopData.shopName,
          shop_phone: shopData.shopPhone,
          shop_address: shopData.shopAddress,
          shop_city: shopData.shopCity,
          shop_pincode: shopData.shopPincode,
          created_at: new Date().toISOString()
        }]);
      
      if (error) {
        console.warn('Supabase sync failed:', error.message);
      } else {
        console.log('‚úÖ Account synced with Supabase');
      }
    }
    
    return { success: true, account };
  } catch (error) {
    console.error('Error creating account:', error);
    return { success: false, error: error.message };
  }
}

// Sync all data with Supabase
async function syncAllData() {
  try {
    if (typeof supabase === 'undefined') {
      console.log('‚ö†Ô∏è Supabase not available, using local storage only');
      return { success: true, type: 'local' };
    }
    
    const session = localStorage.getItem('MilkRecord_session');
    if (!session) {
      return { success: false, error: 'No session found' };
    }
    
    const sessionData = JSON.parse(session);
    
    // Sync customers
    const customers = JSON.parse(localStorage.getItem('mr_pos_customers') || '[]');
    if (customers.length > 0) {
      const { error: customerError } = await supabase
        .from('customers')
        .upsert(customers.map(c => ({ ...c, shop_email: sessionData.email })));
      if (customerError) console.warn('Customer sync failed:', customerError.message);
    }
    
    // Sync products
    const products = JSON.parse(localStorage.getItem('mr_pos_custom_products') || '[]');
    if (products.length > 0) {
      const { error: productError } = await supabase
        .from('products')
        .upsert(products.map(p => ({ ...p, shop_email: sessionData.email })));
      if (productError) console.warn('Product sync failed:', productError.message);
    }
    
    // Sync history
    const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
    if (history.length > 0) {
      const { error: historyError } = await supabase
        .from('sales_history')
        .upsert(history.map(h => ({ ...h, shop_email: sessionData.email })));
      if (historyError) console.warn('History sync failed:', historyError.message);
    }
    
    console.log('‚úÖ All data synced with Supabase');
    return { success: true, type: 'supabase' };
  } catch (error) {
    console.error('Sync error:', error);
    return { success: false, error: error.message };
  }
}

// Load shop settings from API when modal opens
async function loadShopSettings() {
  const el = (id) => document.getElementById(id);
  
  // FIRST: Load from localStorage (fast, always works)
  console.log('üìÇ Loading shop settings from localStorage...');
  
  if (el('shopNameInput')) el('shopNameInput').value = localStorage.getItem('MilkRecord_shop_name') || '';
  if (el('shopPhoneInput')) el('shopPhoneInput').value = localStorage.getItem('MilkRecord_shop_phone') || '';
  if (el('shopProprietorInput')) el('shopProprietorInput').value = localStorage.getItem('MilkRecord_shop_proprietor') || '';
  if (el('shopEmailInput')) el('shopEmailInput').value = localStorage.getItem('MilkRecord_shop_email') || '';
  if (el('shopAddressInput')) el('shopAddressInput').value = localStorage.getItem('MilkRecord_shop_address') || '';
  if (el('shopCityInput')) el('shopCityInput').value = localStorage.getItem('MilkRecord_shop_city') || '';
  if (el('shopPincodeInput')) el('shopPincodeInput').value = localStorage.getItem('MilkRecord_shop_pincode') || '';
  if (el('shopGstInput')) el('shopGstInput').value = localStorage.getItem('MilkRecord_shop_gst') || '';
  if (el('shopPanInput')) el('shopPanInput').value = localStorage.getItem('MilkRecord_shop_pan') || '';
  if (el('shopUpiInput')) el('shopUpiInput').value = localStorage.getItem('MilkRecord_shop_upi') || '';
  if (el('shopBankInput')) el('shopBankInput').value = localStorage.getItem('MilkRecord_shop_bank') || '';
  if (el('shopAccountInput')) el('shopAccountInput').value = localStorage.getItem('MilkRecord_shop_account') || '';
  if (el('shopIfscInput')) el('shopIfscInput').value = localStorage.getItem('MilkRecord_shop_ifsc') || '';
  if (el('shopAccountNameInput')) el('shopAccountNameInput').value = localStorage.getItem('MilkRecord_shop_account_name') || '';
  
  console.log('‚úÖ Shop settings loaded from localStorage');
  
  // THEN: Try to load from Supabase (will overwrite if available)
  try {
    const response = await fetch('/api/shop-settings');
    const result = await response.json();

    if (result.success && result.settings) {
      const s = result.settings;
      // Save shop_id to localStorage if returned
      if (result.shop_id) {
        localStorage.setItem('MilkRecord_shop_id', result.shop_id);
        console.log('‚úÖ Shop ID saved to localStorage:', result.shop_id);
      }
      // Fill form fields from Supabase
      if (s.shop_name) el('shopNameInput').value = s.shop_name;
      if (s.shop_phone) el('shopPhoneInput').value = s.shop_phone;
      if (s.shop_proprietor) el('shopProprietorInput').value = s.shop_proprietor;
      if (s.shop_email) el('shopEmailInput').value = s.shop_email;
      if (s.shop_address) el('shopAddressInput').value = s.shop_address;
      if (s.shop_city) el('shopCityInput').value = s.shop_city;
      if (s.shop_pincode) el('shopPincodeInput').value = s.shop_pincode;
      if (s.shop_gst) el('shopGstInput').value = s.shop_gst;
      if (s.shop_pan) el('shopPanInput').value = s.shop_pan;
      if (s.shop_upi) el('shopUpiInput').value = s.shop_upi;
      if (s.shop_bank) el('shopBankInput').value = s.shop_bank;
      if (s.shop_account) el('shopAccountInput').value = s.shop_account;
      if (s.shop_ifsc) el('shopIfscInput').value = s.shop_ifsc;
      if (s.shop_account_name) el('shopAccountNameInput').value = s.shop_account_name;

      // Also save to localStorage for backup
      localStorage.setItem('MilkRecord_shop_name', s.shop_name || '');
      localStorage.setItem('MilkRecord_shop_phone', s.shop_phone || '');
      localStorage.setItem('MilkRecord_shop_proprietor', s.shop_proprietor || '');
      localStorage.setItem('MilkRecord_shop_email', s.shop_email || '');
      localStorage.setItem('MilkRecord_shop_address', s.shop_address || '');
      localStorage.setItem('MilkRecord_shop_city', s.shop_city || '');
      localStorage.setItem('MilkRecord_shop_pincode', s.shop_pincode || '');
      localStorage.setItem('MilkRecord_shop_gst', s.shop_gst || '');
      localStorage.setItem('MilkRecord_shop_pan', s.shop_pan || '');
      localStorage.setItem('MilkRecord_shop_upi', s.shop_upi || '');
      localStorage.setItem('MilkRecord_shop_bank', s.shop_bank || '');
      localStorage.setItem('MilkRecord_shop_account', s.shop_account || '');
      localStorage.setItem('MilkRecord_shop_ifsc', s.shop_ifsc || '');
      localStorage.setItem('MilkRecord_shop_account_name', s.shop_account_name || '');

      console.log('‚úÖ Shop settings loaded from Supabase');
      
      // Show sync status confirmation
      showSyncStatusConfirmation();
    }
  } catch (error) {
    console.log('‚ö†Ô∏è Using localStorage (Supabase not available)');
  }
}

// Show sync status confirmation message
function showSyncStatusConfirmation() {
  const shopId = localStorage.getItem('MilkRecord_shop_id');
  const shopName = localStorage.getItem('MilkRecord_shop_name') || 'Your Shop';
  const shopEmail = localStorage.getItem('MilkRecord_shop_email') || '';
  const shopPhone = localStorage.getItem('MilkRecord_shop_phone') || '';
  
  if (shopId) {
    const confirmationHtml = `
      <div style="background:#f0fdf4; border:2px solid #16a34a; border-radius:12px; padding:16px; margin:16px 0;">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
          <div style="width:40px; height:40px; background:#16a34a; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:20px;">‚úÖ</div>
          <div>
            <div style="font-size:14px; font-weight:900; color:#15803d;">üéâ Sync Enabled & Active!</div>
            <div style="font-size:11px; color:#166534;">Your data is backed up to Supabase</div>
          </div>
        </div>
        <div style="background:white; border-radius:8px; padding:12px; font-size:12px; color:#475569;">
          <div style="margin-bottom:8px;"><strong>üè™ Shop:</strong> ${escapeHtml(shopName)}</div>
          <div style="margin-bottom:8px;"><strong>üìß Email:</strong> ${escapeHtml(shopEmail) || 'Not set'}</div>
          <div style="margin-bottom:8px;"><strong>üì± Phone:</strong> ${escapeHtml(shopPhone) || 'Not set'}</div>
          <div style="margin-top:12px; padding:8px; background:#fef3c7; border-radius:6px; font-size:11px; color:#92400e;">
            ‚ö†Ô∏è <strong>Important:</strong> Keep your email and phone updated! This is how you access your data on new devices.
          </div>
        </div>
      </div>
    `;
    
    // Insert after settings form
    const settingsForm = document.querySelector('#settingsModal form');
    if (settingsForm && !document.getElementById('syncStatusConfirmation')) {
      const div = document.createElement('div');
      div.id = 'syncStatusConfirmation';
      div.innerHTML = confirmationHtml;
      settingsForm.insertBefore(div, settingsForm.firstChild);
    }
  }
}

// Save shop settings with 3-tier sync model
async function saveShopSettings() {
  console.log('üü¢ LEVEL 1: Shop Registration/Update');
  
  // Capitalize first letter of each word for names
  const capitalizeName = (str) => {
    return str.replace(/\b\w/g, c => c.toUpperCase());
  };

  const shopName = capitalizeName(el("shopNameInput").value.trim());
  const shopPhone = el("shopPhoneInput").value.trim();
  const shopProprietor = capitalizeName(el("shopProprietorInput").value.trim());
  const shopAddress = el("shopAddressInput").value.trim();
  const shopCity = capitalizeName(el("shopCityInput").value.trim());
  const shopPincode = el("shopPincodeInput").value.trim();
  const shopGst = el("shopGstInput").value.trim().toUpperCase();
  const shopPan = el("shopPanInput").value.trim().toUpperCase();

  // Shop payment details
  const shopUpi = el("shopUpiInput") ? el("shopUpiInput").value.trim().toLowerCase() : '';
  const shopBank = el("shopBankInput") ? el("shopBankInput").value.trim() : '';
  const shopAccount = el("shopAccountInput") ? el("shopAccountInput").value.trim() : '';
  const shopIfsc = el("shopIfscInput") ? el("shopIfscInput").value.trim().toUpperCase() : '';
  const shopAccountName = el("shopAccountNameInput") ? el("shopAccountNameInput").value.trim() : '';

  // Get email if provided
  const shopEmail = el("shopEmailInput") ? el("shopEmailInput").value.trim().toLowerCase() : '';

  if (!shopName) {
    showToast('‚ö†Ô∏è Shop name required!');
    return;
  }

  if (!shopPhone) {
    showToast('‚ö†Ô∏è Shop phone required!');
    return;
  }

  // Prepare shop data
  const shopData = {
    shop_name: shopName,
    shop_phone: shopPhone,
    shop_email: shopEmail || '',
    shop_address: shopAddress || '',
    shop_city: shopCity || '',
    shop_pincode: shopPincode || '',
    shop_gst: shopGst || '',
    shop_pan: shopPan || '',
    shop_upi: shopUpi || '',
    shop_bank: shopBank || '',
    shop_account: shopAccount || '',
    shop_ifsc: shopIfsc || '',
    shop_account_name: shopAccountName || ''
  };

  console.log('üìä Shop Data:', shopData);

  // Check if this is first-time activation (LEVEL 0 ‚Üí LEVEL 1)
  const existingShopId = localStorage.getItem('MilkRecord_shop_id');

  if (!existingShopId) {
    // FIRST TIME ACTIVATION - Use syncEngine.activateShop()
    console.log('üü¢ LEVEL 1: First-time shop activation');
    showToast('‚è≥ Activating shop...');

    const result = await window.syncEngine.activateShop(shopData);

    if (result.success) {
      console.log('‚úÖ Shop activated!');
      console.log('üÜî Shop ID:', result.shopId);
      showToast('‚úÖ Shop activated! Cloud sync enabled');

      // Save to localStorage as backup
      localStorage.setItem('MilkRecord_shop_id', result.shopId);
      localStorage.setItem('MilkRecord_shop_name', shopName);
      localStorage.setItem('MilkRecord_shop_phone', shopPhone);

      // Update UI
      const profileName = document.getElementById('profileName');
      if (profileName) {
        profileName.textContent = shopName;
      }
    } else {
      console.error('‚ùå Activation failed:', result.error);
      showToast('‚ö†Ô∏è Saved locally. Will sync when online');
    }
  } else {
    // ALREADY ACTIVATED - Just update settings
    console.log('üîµ Shop already activated - updating settings');

    // Save locally
    localStorage.setItem('MilkRecord_shop_name', shopName);
    localStorage.setItem('MilkRecord_shop_phone', shopPhone);
    if (shopProprietor) localStorage.setItem('MilkRecord_shop_proprietor', shopProprietor);
    if (shopAddress) localStorage.setItem('MilkRecord_shop_address', shopAddress);
    if (shopCity) localStorage.setItem('MilkRecord_shop_city', shopCity);
    if (shopUpi) localStorage.setItem('MilkRecord_shop_upi', shopUpi);
    if (shopBank) localStorage.setItem('MilkRecord_shop_bank', shopBank);
    if (shopAccount) localStorage.setItem('MilkRecord_shop_account', shopAccount);
    if (shopIfsc) localStorage.setItem('MilkRecord_shop_ifsc', shopIfsc);
    if (shopAccountName) localStorage.setItem('MilkRecord_shop_account_name', shopAccountName);
    if (shopEmail) localStorage.setItem('MilkRecord_shop_email', shopEmail);
    
    console.log('‚úÖ Settings saved locally');

    // Reload sync engine state (shop_id may have been set)
    if (window.syncEngine) {
      await window.syncEngine.loadState();
      
      // If no longer in trial mode, queue for sync
      if (!window.syncEngine.isTrialMode) {
        await window.syncEngine.queue('save_shop_settings', shopData, 'normal');
        console.log('üü¢ Sync enabled - data will sync to cloud');
      } else {
        console.log('üîµ Still in trial mode - data saved locally only');
      }
    }

    showToast('‚úÖ Settings saved!' + (window.syncEngine && !window.syncEngine.isTrialMode ? ' ‚òÅÔ∏è Syncing to cloud...' : ''));
    
    // Update UI
    const profileName = document.getElementById('profileName');
    if (profileName) {
      profileName.textContent = shopName;
    }
  }

  closeModal('settingsModal');
}

// Copy to clipboard utility
function copyToClipboard(elementId) {
  const el = document.getElementById(elementId);
  if (el && el.value) {
    navigator.clipboard.writeText(el.value).then(() => {
      showToast('üìã Copied!');
    }).catch(() => {
      showToast('‚ö†Ô∏è Copy failed');
    });
  } else {
    showToast('‚ö†Ô∏è Nothing to copy');
  }
}

// Copy all shop payment details
function copyShopPaymentDetails() {
  const upi = el('shopUpiInput')?.value || '';
  const bank = el('shopBankInput')?.value || '';
  const account = el('shopAccountInput')?.value || '';
  const ifsc = el('shopIfscInput')?.value || '';
  const accountName = el('shopAccountNameInput')?.value || '';
  
  let details = 'üí≥ Shop Payment Details\n';
  details += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
  if (upi) details += `üì± UPI: ${upi}\n`;
  if (bank) details += `üè¶ Bank: ${bank}\n`;
  if (account) details += `üî¢ Account: ${account}\n`;
  if (ifsc) details += `üîë IFSC: ${ifsc}\n`;
  if (accountName) details += `üë§ Name: ${accountName}\n`;
  
  if (details.split('\n').length > 2) {
    navigator.clipboard.writeText(details).then(() => {
      showToast('üìã All details copied!');
    }).catch(() => {
      showToast('‚ö†Ô∏è Copy failed');
    });
  } else {
    showToast('‚ö†Ô∏è No details to copy');
  }
}

// Load saved booth on startup
window.addEventListener('DOMContentLoaded', function() {
  const savedBooth = localStorage.getItem('MilkRecord_booth');
  if (savedBooth && el('boothSelect')) {
    el('boothSelect').value = savedBooth;
    // Also set shop name from booth
    const boothNames = {
      'main': 'Main Booth',
      'village-a': 'Village A Booth',
      'village-b': 'Village B Booth',
      'market': 'Market Booth'
    };
    if (!localStorage.getItem('MilkRecord_shop_name')) {
      localStorage.setItem('MilkRecord_shop_name', boothNames[savedBooth]);
    }
  }

  // Load shop settings if opening settings modal
  const settingsModal = document.getElementById('settingsModal');
  if (settingsModal) {
    settingsModal.addEventListener('click', function(e) {
      if (e.target === settingsModal) {
        // Load current settings
        if (el('shopNameInput')) el('shopNameInput').value = localStorage.getItem('MilkRecord_shop_name') || '';
        if (el('shopPhoneInput')) el('shopPhoneInput').value = localStorage.getItem('MilkRecord_shop_phone') || '';
        if (el('shopProprietorInput')) el('shopProprietorInput').value = localStorage.getItem('MilkRecord_shop_proprietor') || '';
        if (el('shopAddressInput')) el('shopAddressInput').value = localStorage.getItem('MilkRecord_shop_address') || '';
        if (el('shopCityInput')) el('shopCityInput').value = localStorage.getItem('MilkRecord_shop_city') || '';
        if (el('shopPincodeInput')) el('shopPincodeInput').value = localStorage.getItem('MilkRecord_shop_pincode') || '';
        if (el('shopGstInput')) el('shopGstInput').value = localStorage.getItem('MilkRecord_shop_gst') || '';
        if (el('shopPanInput')) el('shopPanInput').value = localStorage.getItem('MilkRecord_shop_pan') || '';
        // Load shop payment details
        if (el('shopUpiInput')) el('shopUpiInput').value = localStorage.getItem('MilkRecord_shop_upi') || '';
        if (el('shopBankInput')) el('shopBankInput').value = localStorage.getItem('MilkRecord_shop_bank') || '';
        if (el('shopAccountInput')) el('shopAccountInput').value = localStorage.getItem('MilkRecord_shop_account') || '';
        if (el('shopIfscInput')) el('shopIfscInput').value = localStorage.getItem('MilkRecord_shop_ifsc') || '';
        if (el('shopAccountNameInput')) el('shopAccountNameInput').value = localStorage.getItem('MilkRecord_shop_account_name') || '';
      }
    });
  }
  
  // Show mobile footer on small screens
  function checkMobileFooter() {
    const mobileFooter = document.getElementById('mobileFooter');
    const desktopFooter = document.querySelector('.bottom');
    if (window.innerWidth <= 768) {
      if (mobileFooter) mobileFooter.style.display = 'block';
      if (desktopFooter) desktopFooter.style.display = 'none';
    } else {
      if (mobileFooter) mobileFooter.style.display = 'none';
      if (desktopFooter) desktopFooter.style.display = 'flex';
    }
  }
  
  // Check on load and resize
  checkMobileFooter();
  window.addEventListener('resize', checkMobileFooter);

  // Load advance orders
  loadPosAdvanceOrders();
});

// Keyboard Navigation - Full End-to-End Invoice Creation
document.addEventListener('keydown', function(e) {
  // Auto-focus product search when typing (if no other focus)
  if (e.key && e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
    const activeElement = document.activeElement;
    const isInputFocused = activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA';
    
    if (!isInputFocused) {
      e.preventDefault();
      const productSearch = document.getElementById('productSearch');
      if (productSearch) {
        productSearch.focus();
        productSearch.value = e.key;
      }
      return;
    }
  }
  
  // F1 = New Customer
  if (e.key === 'F1') {
    e.preventDefault();
    openModal('addCustModal');
    setTimeout(() => el("newName").focus(), 100);
    return;
  }
  
  // Enter key handling
  if (e.key === 'Enter') {
    e.preventDefault(); // Prevent default form submission
    
    // In search box - select first result or current customer
    if (document.activeElement === el("custSearch")) {
      const firstResult = document.querySelector('.drop-item');
      if (firstResult) {
        firstResult.click();
      }
      // Move focus to product grid (first product)
      const firstProduct = document.querySelector('.p-card:not([onclick*="addProduct"])');
      if (firstProduct) firstProduct.focus();
      return;
    }

    // In add customer modal - navigate fields
    if (el("addCustModal") && el("addCustModal").style.display === 'flex') {
      if (document.activeElement === el("newName")) {
        el("subQty").focus();
        el("subQty").select();
      } else if (document.activeElement === el("subQty")) {
        addCust();
      }
      return;
    }

    // In cart quantity/amount fields - move to next
    if (document.activeElement.tagName === 'INPUT' &&
        document.activeElement.type === 'number' &&
        document.activeElement.closest('.recent-table')) {
      const inputs = Array.from(document.querySelectorAll('.recent-table input[type="number"]'));
      if (inputs && inputs.length > 0) {
        const currentIndex = inputs.indexOf(document.activeElement);
        if (currentIndex >= 0 && currentIndex < inputs.length - 1) {
          inputs[currentIndex + 1].focus();
          inputs[currentIndex + 1].select();
        }
      }
      return;
    }
    
    // In payment amount field - save invoice
    if (document.activeElement === el("paymentAmount")) {
      saveAndInvoice();
      return;
    }
  }
  
  // Escape - clear search
  if (e.key === 'Escape') {
    if (document.activeElement === el("custSearch")) {
      el("custSearch").value = "";
      el("searchDropdown").style.display = "none";
    }
    // Don't close modals on Escape - user might be typing
    return;
  }
  
  // Number keys 1-9 when product grid focused - quick add
  if (document.activeElement.classList.contains('p-card')) {
    const num = parseInt(e.key);
    if (num >= 1 && num <= 9) {
      const products = document.querySelectorAll('.p-card:not([onclick*="addProduct"])');
      if (products[num - 1]) {
        products[num - 1].click();
      }
    }
  }
});

// Make product cards focusable for keyboard navigation
document.querySelectorAll('.p-card').forEach(card => {
  card.setAttribute('tabindex', '0');
  card.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      this.click();
    }
  });
});

// Focus product search on page load (not customer search)
setTimeout(() => {
  const productSearch = el("productSearch");
  if (productSearch) {
    productSearch.focus();
    productSearch.select();
  }
}, 300);

// ========== RATE LIST FUNCTIONS ==========

// Open rate list modal
function openRateListModal() {
  const modal = document.getElementById('rateListModal');
  if (!modal) return;
  
  // Set shop name and date
  const shopName = localStorage.getItem('MilkRecord_shop_name') || 'Gopal Dairy Shop';
  document.getElementById('rateListShopName').textContent = 'üè™ ' + shopName;
  document.getElementById('rateListCurrentDate').textContent = new Date().toLocaleDateString('en-IN', { 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  
  // Load and display products
  renderRateListProducts();
  
  // Open modal
  openModal('rateListModal');
}

// ========== CUSTOMER RELATION FUNCTIONS ==========

// Open customer relation modal
function openCustomerRelation(customerId) {
  const modal = document.getElementById('customerRelationModal');
  if (!modal) {
    console.error('‚ùå customerRelationModal not found!');
    return;
  }

  // Get customer name from activeCust if no ID provided
  const activeCustEl = document.getElementById('activeCust');
  if (!customerId || customerId === 'Walking Customer' || !customerId) {
    if (activeCustEl) {
      customerId = activeCustEl.innerText.trim();
    } else {
      console.error('‚ùå activeCust element not found!');
      return showToast('‚ö†Ô∏è Customer element not found!');
    }
  }

  if (!customerId || customerId === '' || customerId === 'Walking Customer') {
    return showToast('‚ö†Ô∏è Select a customer first!');
  }

  console.log('üîç Looking for customer:', customerId, 'Available:', customers.map(c => c.name));

  // Find customer by name (case-insensitive) or ID
  let customer = customers.find(c =>
    c.id === customerId ||
    c.name.toLowerCase() === customerId.toLowerCase() ||
    c.name.toLowerCase().includes(customerId.toLowerCase())
  );

  if (!customer) {
    // Try to find by partial match
    customer = customers.find(c => customerId.toLowerCase().includes(c.name.toLowerCase()));
  }

  if (!customer) {
    console.error('‚ùå Customer not found:', customerId, 'Available:', customers.map(c => c.name));
    return showToast('‚ùå Customer not found! Select from search dropdown.');
  }

  console.log('‚úÖ Customer found:', customer.name);

  // Set customer name
  const relationCustomerNameEl = document.getElementById('relationCustomerName');
  if (relationCustomerNameEl) {
    relationCustomerNameEl.textContent = customer.name + (customer.serial ? ` (#${customer.serial})` : '');
  }

  // Load customer details
  loadCustomerRelationData(customer);

  // Open modal
  openModal('customerRelationModal');
}

// Load customer relation data
function loadCustomerRelationData(customer) {
  const container = document.getElementById('relationContent');
  if (!container) return;

  // Get all entries for this customer
  const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
  const customerEntries = history.filter(h => h.customer === customer.name);

  // Calculate totals
  const totalPurchases = customerEntries.filter(e => e.method !== 'Cash In' && e.method !== 'Cash Out').reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
  const totalPaid = customerEntries.filter(e => e.method === 'Cash' || e.method === 'UPI').reduce((sum, e) => sum + parseFloat(e.paidAmount || e.amount || 0), 0);
  const totalCredit = customerEntries.filter(e => e.method === 'Credit' || e.method === 'Udhar').reduce((sum, e) => sum + parseFloat(e.creditAmount || 0), 0);
  const cashIn = customerEntries.filter(e => e.method === 'Cash In').reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
  const cashOut = customerEntries.filter(e => e.method === 'Cash Out').reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);

  // Calculate purchase streak
  let currentStreak = 0;
  let longestStreak = 0;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  if (customerEntries.length > 0) {
    // Sort entries by date
    const sortedEntries = [...customerEntries].sort((a, b) => new Date(b.createdAt || Date.now()) - new Date(a.createdAt || Date.now()));
    
    // Calculate current streak
    let lastDate = new Date(sortedEntries[0].createdAt || Date.now());
    lastDate.setHours(0, 0, 0, 0);
    
    const daysDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
    if (daysDiff <= 1) {
      currentStreak = 1;
      for (let i = 1; i < sortedEntries.length; i++) {
        const currentDate = new Date(sortedEntries[i].createdAt || Date.now());
        currentDate.setHours(0, 0, 0, 0);
        const diff = Math.floor((lastDate - currentDate) / (1000 * 60 * 60 * 24));
        if (diff === 1) {
          currentStreak++;
          lastDate = currentDate;
        } else if (diff > 1) {
          break;
        }
      }
    }
    
    // Calculate longest streak
    let tempStreak = 1;
    longestStreak = 1;
    let prevDate = new Date(sortedEntries[0].createdAt || Date.now());
    prevDate.setHours(0, 0, 0, 0);
    
    for (let i = 1; i < sortedEntries.length; i++) {
      const currentDate = new Date(sortedEntries[i].createdAt || Date.now());
      currentDate.setHours(0, 0, 0, 0);
      const diff = Math.floor((prevDate - currentDate) / (1000 * 60 * 60 * 24));
      if (diff === 1) {
        tempStreak++;
        longestStreak = Math.max(longestStreak, tempStreak);
      } else {
        tempStreak = 1;
      }
      prevDate = currentDate;
    }
  }
  
  const streakEmoji = currentStreak >= 7 ? 'üî•' : currentStreak >= 3 ? 'üí™' : '‚ú®';

  // Generate transactions list
  let transactionsHTML = '';
  if (customerEntries.length === 0) {
    transactionsHTML = '<div style="padding:40px; text-align:center; color:#64748b;"><div style="font-size:48px; margin-bottom:16px;">üìã</div><div>No transactions yet</div></div>';
  } else {
    // Sort by date (newest first)
    customerEntries.sort((a, b) => new Date(b.createdAt || Date.now()) - new Date(a.createdAt || Date.now()));

    transactionsHTML = customerEntries.map(e => {
      const date = new Date(e.createdAt || Date.now());
      const isCredit = e.method === 'Credit' || e.method === 'Udhar';
      const isCashFlow = e.method === 'Cash In' || e.method === 'Cash Out';

      let icon = 'ü•õ';
      let amountColor = '#dc2626';
      let amountPrefix = '-';

      if (isCashFlow) {
        icon = e.method === 'Cash In' ? 'üí∞' : 'üí∏';
        amountColor = e.method === 'Cash In' ? '#16a34a' : '#f59e0b';
        amountPrefix = e.method === 'Cash In' ? '+' : '';
      } else if (isCredit) {
        icon = 'üìí';
      }

      return `
        <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #f1f5f9;">
          <div style="flex:1;">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
              <span style="font-size:16px;">${icon}</span>
              <div>
                <div style="font-weight:700; font-size:13px;">${e.products || e.method}</div>
                <div style="font-size:11px; color:#64748b;">üìÖ ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
              </div>
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:900; color:${amountColor}; font-size:14px;">${amountPrefix}${formatINR(parseFloat(e.amount || 0))}</div>
            ${e.creditAmount > 0 ? `<div style="font-size:10px; color:#dc2626;">Credit: ${formatINR(e.creditAmount)}</div>` : ''}
          </div>
        </div>
      `;
    }).join('');
  }

  container.innerHTML = `
    <!-- Customer Info Card -->
    <div style="background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding:16px; border-radius:12px; margin-bottom:16px; border:2px solid #0284c7;">
      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
        <div>
          <div style="font-size:18px; font-weight:900; color:#0c4a6e; margin-bottom:4px;">${customer.name}</div>
          <div style="font-size:12px; color:#0369a1;">${customer.phone || 'üì± No phone'} ${customer.address ? '‚Ä¢ üìç ' + customer.address : ''}</div>
        </div>
        <button onclick="editCustomerFromRelation('${customer.id || customer.name}')" style="padding:8px 12px; background:#0284c7; color:white; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:12px;">üìù Edit Details</button>
      </div>
      <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;">
        <div style="background:white; padding:12px; border-radius:8px; text-align:center;">
          <div style="font-size:11px; color:#64748b; font-weight:700;">TOTAL PURCHASES</div>
          <div style="font-size:20px; font-weight:900; color:#1e293b;">${formatINR(totalPurchases)}</div>
        </div>
        <div style="background:white; padding:12px; border-radius:8px; text-align:center;">
          <div style="font-size:11px; color:#64748b; font-weight:700;">TOTAL PAID</div>
          <div style="font-size:20px; font-weight:900; color:#16a34a;">${formatINR(totalPaid + cashIn)}</div>
        </div>
        <div style="background:white; padding:12px; border-radius:8px; text-align:center;">
          <div style="font-size:11px; color:#64748b; font-weight:700;">CURRENT BALANCE</div>
          <div style="font-size:20px; font-weight:900; color:${customer.balance > 0 ? '#dc2626' : '#16a34a'};">${formatINR(customer.balance || 0)}</div>
          <div style="font-size:9px; font-weight:700; margin-top:4px; color:${customer.balance > 0 ? '#dc2626' : '#16a34a'};">${customer.balance > 0 ? '‚¨ÜÔ∏è Customer se lena hai' : customer.balance < 0 ? '‚¨áÔ∏è Customer ko dene hai' : '‚úÖ Settled'}</div>
        </div>
      </div>
    </div>

    <!-- Purchase Streak -->
    <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding:16px; border-radius:12px; margin-bottom:16px; border:2px solid #f59e0b;">
      <div style="display:flex; justify-content:space-around; align-items:center;">
        <div>
          <div style="font-size:32px; font-weight:900; color:#dc2626;">${streakEmoji} ${currentStreak}</div>
          <div style="font-size:10px; color:#92400e; font-weight:700;">CURRENT STREAK</div>
        </div>
        <div style="border-left:2px solid #f59e0b; height:40px;"></div>
        <div>
          <div style="font-size:32px; font-weight:900; color:#f59e0b;">üèÜ ${longestStreak}</div>
          <div style="font-size:10px; color:#92400e; font-weight:700;">LONGEST STREAK</div>
        </div>
      </div>
      ${currentStreak >= 7 ? '<div style="margin-top:12px; font-size:11px; color:#dc2626; font-weight:700; text-align:center;">üéâ Amazing! Keep it up!</div>' : ''}
    </div>

    <!-- Quick Actions -->
    <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; margin-bottom:16px;">
      <button onclick="sendWishesCustomer('${customer.name}', '${customer.phone || ''}')" style="padding:12px; background:#ec4899; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:12px;">üíê Send Wishes</button>
      <button onclick="copyCustomerDetails('${customer.id || customer.name}')" style="padding:12px; background:#e0f2fe; color:#0369a1; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:12px;">üìã Copy Details</button>
    </div>
    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-bottom:16px;">
      <button onclick="quickCashInFromRelation('${customer.name}')" style="padding:12px; background:#dcfce7; color:#166534; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:12px;">üí∞ Cash In</button>
      <button onclick="quickCashOutFromRelation('${customer.name}')" style="padding:12px; background:#fef3c7; color:#92400e; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:12px;">üí∏ Cash Out</button>
      <button onclick="openAdvanceLedger('${customer.id || customer.name}')" style="padding:12px; background:#ede9fe; color:#7c3aed; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:12px;">üìí Advance/Udhari</button>
      <button onclick="sendWhatsAppSummary('${customer.name}', '${customer.phone || ''}')" style="padding:12px; background:#25d366; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:12px;">üí¨ WhatsApp</button>
    </div>

    <!-- Transactions Header -->
    <div style="background:#f8fafc; padding:12px; border-radius:8px; margin-bottom:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size:14px; font-weight:900; color:#1e293b;">üìä Transaction History (${customerEntries.length})</div>
        <div style="font-size:12px; color:#64748b;">All Time</div>
      </div>
    </div>

    <!-- Transactions List -->
    <div style="max-height:400px; overflow-y:auto; background:white; border-radius:8px; border:1px solid #e2e8f0;">
      ${transactionsHTML}
    </div>
  `;
}

// Edit customer from relation modal
function editCustomerFromRelation(customerId) {
  const customer = customers.find(c => c.id === customerId || c.name === customerId);
  if (!customer) return;

  // Fill in the add customer modal
  document.getElementById('newCustId').value = customer.id || '';
  document.getElementById('newName').value = customer.name;
  document.getElementById('newPhone').value = customer.phone || '';
  document.getElementById('newEmail').value = customer.email || '';
  document.getElementById('newAddress').value = customer.address || '';

  // Change modal to edit mode
  const modalTitle = document.querySelector('#addCustModal .panelHeader span');
  if (modalTitle) modalTitle.textContent = 'üìù Edit Customer';

  const addBtn = document.querySelector('#addCustModal .add-btn');
  if (addBtn) {
    addBtn.textContent = 'üíæ Update Customer';
    addBtn.onclick = () => {
      updateCustomerFromRelation(customer.id || customer.name);
    };
  }

  closeModal('customerRelationModal');
  openModal('addCustModal');
}

// Update customer from relation context
function updateCustomerFromRelation(customerId) {
  const name = document.getElementById('newName').value.trim();
  const phone = document.getElementById('newPhone').value.trim();
  const email = document.getElementById('newEmail').value.trim();
  const address = document.getElementById('newAddress').value.trim();
  
  if (!name) return showToast('Name required!');
  
  const customer = customers.find(c => c.id === customerId || c.name === customerId);
  if (customer) {
    customer.name = name;
    customer.phone = phone;
    customer.email = email;
    customer.address = address;
    
    localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
    
    closeModal('addCustModal');
    showToast(`‚úÖ ${name}'s details updated!`);
    
    // Re-open relation modal with updated data
    setTimeout(() => {
      openCustomerRelation(customerId);
    }, 300);
  }
}

// Quick Cash In from relation
function quickCashInFromRelation(customerName) {
  const amount = prompt(`üí∞ Enter Cash In Amount for ${customerName}:`, '');
  if (!amount || isNaN(amount) || parseFloat(amount) <= 0) return showToast('Invalid amount!');
  
  const note = prompt('üìù Purpose (optional):', 'Cash received') || 'Cash received';
  
  // Record cash in
  const newTransaction = {
    id: 'cashin_' + Date.now(),
    date: new Date().toLocaleDateString(),
    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
    customer: customerName,
    products: note,
    amount: parseFloat(amount),
    method: 'Cash In',
    creditAmount: 0,
    cartItems: [],
    createdAt: Date.now()
  };
  
  const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
  history.push(newTransaction);
  localStorage.setItem('mr_sales_history', JSON.stringify(history));
  
  // Update customer balance
  const customer = customers.find(c => c.name === customerName);
  if (customer) {
    customer.balance = (customer.balance || 0) - parseFloat(amount);
    localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
  }
  
  showToast(`üí∞ ${formatINR(amount)} received from ${customerName}!`);
  
  // Refresh relation view
  setTimeout(() => {
    openCustomerRelation(customerName);
  }, 300);
}

// Quick Cash Out from relation
function quickCashOutFromRelation(customerName) {
  const amount = prompt(`üí∏ Enter Cash Out Amount for ${customerName}:`, '');
  if (!amount || isNaN(amount) || parseFloat(amount) <= 0) return showToast('Invalid amount!');
  
  const note = prompt('üìù Purpose (optional):', 'Cash paid') || 'Cash paid';
  
  // Record cash out
  const newTransaction = {
    id: 'cashout_' + Date.now(),
    date: new Date().toLocaleDateString(),
    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
    customer: customerName,
    products: note,
    amount: parseFloat(amount),
    method: 'Cash Out',
    creditAmount: 0,
    cartItems: [],
    createdAt: Date.now()
  };
  
  const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
  history.push(newTransaction);
  localStorage.setItem('mr_sales_history', JSON.stringify(history));
  
  // Update customer balance
  const customer = customers.find(c => c.name === customerName);
  if (customer) {
    customer.balance = (customer.balance || 0) + parseFloat(amount);
    localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
  }
  
  showToast(`üí∏ ${formatINR(amount)} paid to ${customerName}!`);

  // Refresh relation view
  setTimeout(() => {
    openCustomerRelation(customerName);
  }, 300);
}

// Copy customer details to clipboard
function copyCustomerDetails(customerId) {
  const customer = customers.find(c => c.id === customerId || c.name === customerId);
  if (!customer) return showToast('‚ö†Ô∏è Customer not found');

  const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
  const customerEntries = history.filter(h => h.customer === customer.name);

  // Calculate totals
  const totalPurchases = customerEntries.filter(e => e.method !== 'Cash In' && e.method !== 'Cash Out').reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
  const totalPaid = customerEntries.filter(e => e.method === 'Cash' || e.method === 'UPI').reduce((sum, e) => sum + parseFloat(e.paidAmount || e.amount || 0), 0);
  const cashIn = customerEntries.filter(e => e.method === 'Cash In').reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
  const cashOut = customerEntries.filter(e => e.method === 'Cash Out').reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);

  const shopName = localStorage.getItem('MilkRecord_shop_name') || 'Gopal Dairy Shop';

  let details = `*${shopName}*\n`;
  details += `üë§ *Customer Details*\n\n`;
  details += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  details += `*Name:* ${customer.name}\n`;
  if (customer.phone) details += `*Phone:* ${customer.phone}\n`;
  if (customer.address) details += `*Address:* ${customer.address}\n`;
  details += `\n`;
  details += `*üí∞ Financial Summary*\n`;
  details += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  details += `*Total Purchases:* ${formatINR(totalPurchases)}\n`;
  details += `*Total Paid:* ${formatINR(totalPaid + cashIn)}\n`;
  details += `*Cash In:* ${formatINR(cashIn)}\n`;
  details += `*Cash Out:* ${formatINR(cashOut)}\n`;
  details += `*Current Balance:* ${formatINR(customer.balance || 0)}\n`;
  details += `*Transactions:* ${customerEntries.length}\n`;
  details += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  details += `üôè Thank you!`;

  navigator.clipboard.writeText(details).then(() => {
    showToast('üìã Customer details copied!');
  }).catch(() => {
    showToast('‚ö†Ô∏è Copy failed');
  });
}

// Send wishes to customer
function sendWishesCustomer(customerName, phone) {
  if (!phone) {
    showToast('‚ö†Ô∏è No phone number!');
    return;
  }
  
  const today = new Date();
  const day = today.toLocaleDateString('en-IN', { weekday: 'long' });
  const date = today.toLocaleDateString('en-IN', { day: 'numeric', month: 'long' });
  
  const wishes = [
    `üåÖ Good Morning ${customerName}!\n\nHave a wonderful ${day} ahead! May your day be filled with happiness and prosperity.\n\nüôè Gopal Dairy Shop`,
    `üéâ Happy ${date}!\n\nDear ${customerName}, wishing you a day full of joy and success. Thank you for being a valued customer!\n\nüôè Gopal Dairy Shop`,
    `üíê Best Wishes!\n\nDear ${customerName}, may success and happiness always be yours. Thank you for your continued trust in us!\n\nüôè Gopal Dairy Shop`
  ];
  
  const wish = wishes[Math.floor(Math.random() * wishes.length)];
  const wpUrl = `https://wa.me/91${phone.replace(/\D/g, '')}?text=${encodeURIComponent(wish)}`;
  window.open(wpUrl, '_blank');
  showToast('üíê Wishes sent!');
}

// Send WhatsApp summary to customer
function sendWhatsAppSummary(customerName, phone) {
  if (!phone) {
    showToast('‚ö†Ô∏è No phone number!');
    return;
  }
  
  const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
  const customerEntries = history.filter(h => h.customer === customerName);
  
  const totalPurchases = customerEntries.filter(e => e.method !== 'Cash In' && e.method !== 'Cash Out').reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
  const totalPaid = customerEntries.filter(e => e.method === 'Cash' || e.method === 'UPI').reduce((sum, e) => sum + parseFloat(e.paidAmount || e.amount || 0), 0);
  
  const shopName = localStorage.getItem('MilkRecord_shop_name') || 'Gopal Dairy Shop';
  
  let msg = `*${shopName}*\n`;
  msg += `üìä *Account Summary*\n\n`;
  msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  msg += `*Customer:* ${customerName}\n`;
  msg += `*Total Purchases:* ${formatINR(totalPurchases)}\n`;
  msg += `*Total Paid:* ${formatINR(totalPaid)}\n`;
  msg += `*Transactions:* ${customerEntries.length}\n`;
  msg += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  msg += `üôè Thank you for your business!`;
  
  const wpUrl = `https://wa.me/91${phone.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`;
  window.open(wpUrl, '_blank');
  showToast('üí¨ WhatsApp opened!');
}

// ========== ADVANCE/UDHARI LEDGER FUNCTIONS ==========

let currentLedgerCustomer = null;
let currentLedgerTab = 'advance';

// Open advance ledger
function openAdvanceLedger(customerId) {
  const customer = customers.find(c => c.id === customerId || c.name === customerId);
  if (!customer) return showToast('‚ùå Customer not found!');
  
  currentLedgerCustomer = customer;
  currentLedgerTab = 'advance';
  
  // Set customer name
  document.getElementById('ledgerCustomerName').textContent = customer.name;
  
  // Load ledger data
  loadLedgerData();
  
  // Open modal
  openModal('advanceLedgerModal');
}

// Switch ledger tab
function switchLedgerTab(tab) {
  currentLedgerTab = tab;
  
  // Update tab styles
  const tabAdvance = document.getElementById('tabAdvance');
  const tabUdhari = document.getElementById('tabUdhari');
  const btnAddAdvance = document.getElementById('btnAddAdvance');
  
  if (tab === 'advance') {
    tabAdvance.style.background = '#ede9fe';
    tabAdvance.style.borderBottomColor = '#7c3aed';
    tabAdvance.style.color = '#7c3aed';
    tabUdhari.style.background = '#f8fafc';
    tabUdhari.style.borderBottomColor = 'transparent';
    tabUdhari.style.color = '#64748b';
    btnAddAdvance.style.display = 'block';
  } else {
    tabUdhari.style.background = '#fef2f2';
    tabUdhari.style.borderBottomColor = '#dc2626';
    tabUdhari.style.color = '#dc2626';
    tabAdvance.style.background = '#f8fafc';
    tabAdvance.style.borderBottomColor = 'transparent';
    tabAdvance.style.color = '#64748b';
    btnAddAdvance.style.display = 'none';
  }
  
  // Reload data
  loadLedgerData();
}

// Load ledger data
function loadLedgerData() {
  const container = document.getElementById('ledgerContent');
  if (!container || !currentLedgerCustomer) return;
  
  const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
  const customerEntries = history.filter(h => h.customer === currentLedgerCustomer.name);
  
  if (currentLedgerTab === 'advance') {
    // Show advance deposits
    const advances = customerEntries.filter(e => e.method === 'Cash In' || (e.advanceAmount && e.advanceAmount > 0));
    
    if (advances.length === 0) {
      container.innerHTML = `
        <div style="padding:60px; text-align:center; color:#64748b;">
          <div style="font-size:64px; margin-bottom:16px;">üì•</div>
          <div style="font-size:18px; font-weight:700; margin-bottom:8px;">No Advance Deposits</div>
          <div style="font-size:14px;">Click "New Advance" to add</div>
        </div>
      `;
      return;
    }
    
    // Group by delivery date
    const advancesByDate = {};
    advances.forEach(a => {
      const date = new Date(a.createdAt || Date.now()).toLocaleDateString('en-IN');
      if (!advancesByDate[date]) advancesByDate[date] = [];
      advancesByDate[date].push(a);
    });
    
    let html = `
      <div style="background:#f0f9ff; padding:16px; border-radius:12px; margin-bottom:16px; border:2px solid #0284c7;">
        <div style="font-size:14px; font-weight:900; color:#0369a1; margin-bottom:8px;">üìä Advance Summary</div>
        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;">
          <div style="background:white; padding:12px; border-radius:8px;">
            <div style="font-size:11px; color:#64748b; font-weight:700;">TOTAL ADVANCE</div>
            <div style="font-size:20px; font-weight:900; color:#16a34a;">${formatINR(advances.reduce((sum, a) => sum + parseFloat(a.amount || 0), 0))}</div>
          </div>
          <div style="background:white; padding:12px; border-radius:8px;">
            <div style="font-size:11px; color:#64748b; font-weight:700;">ENTRIES</div>
            <div style="font-size:20px; font-weight:900; color:#0284c7;">${advances.length}</div>
          </div>
        </div>
      </div>
    `;
    
    Object.keys(advancesByDate).sort((a, b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-'))).forEach(date => {
      html += `
        <div style="background:#f8fafc; padding:12px; border-radius:8px; margin-bottom:12px;">
          <div style="font-size:14px; font-weight:900; color:#1e293b; margin-bottom:8px;">üìÖ ${date}</div>
      `;
      
      advancesByDate[date].forEach(a => {
        html += `
          <div style="display:flex; justify-content:space-between; padding:12px; background:white; border-radius:6px; margin-bottom:8px; border:1px solid #e2e8f0;">
            <div style="flex:1;">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                <span style="font-size:18px;">üí∞</span>
                <div>
                  <div style="font-weight:700; font-size:13px;">${a.products || 'Advance Deposit'}</div>
                  <div style="font-size:11px; color:#64748b;">üìÖ ${new Date(a.createdAt || Date.now()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                  ${a.deliveryAddress ? `<div style="font-size:11px; color:#0284c7; margin-top:2px;">üìç ${a.deliveryAddress}</div>` : ''}
                  ${a.deliveryDate ? `<div style="font-size:11px; color:#0284c7;">üìÜ Delivery: ${new Date(a.deliveryDate).toLocaleDateString('en-IN')}</div>` : ''}
                </div>
              </div>
            </div>
            <div style="text-align:right;">
              <div style="font-weight:900; color:#16a34a; font-size:16px;">+${formatINR(parseFloat(a.amount || 0))}</div>
              <button onclick="sendAdvanceReceipt('${a.id}')" style="font-size:9px; padding:2px 6px; background:#25d366; color:white; border:none; border-radius:4px; font-weight:700; cursor:pointer; margin-top:4px;">üì± Receipt</button>
            </div>
          </div>
        `;
      });
      
      html += `</div>`;
    });
    
    container.innerHTML = html;
    
  } else {
    // Show udhari (credit)
    const udharis = customerEntries.filter(e => e.method === 'Credit' || e.method === 'Udhar' || (e.creditAmount && e.creditAmount > 0));
    
    if (udharis.length === 0) {
      container.innerHTML = `
        <div style="padding:60px; text-align:center; color:#64748b;">
          <div style="font-size:64px; margin-bottom:16px;">‚úÖ</div>
          <div style="font-size:18px; font-weight:700; margin-bottom:8px;">No Udhari (Credit)</div>
          <div style="font-size:14px;">Customer has no pending credit</div>
        </div>
      `;
      return;
    }
    
    // Sort by date
    udharis.sort((a, b) => new Date(b.createdAt || Date.now()) - new Date(a.createdAt || Date.now()));
    
    const totalUdhari = udharis.reduce((sum, u) => sum + parseFloat(u.creditAmount || u.amount || 0), 0);
    
    let html = `
      <div style="background:#fef2f2; padding:16px; border-radius:12px; margin-bottom:16px; border:2px solid #dc2626;">
        <div style="font-size:14px; font-weight:900; color:#991b1b; margin-bottom:8px;">üìí Udhari Summary</div>
        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;">
          <div style="background:white; padding:12px; border-radius:8px;">
            <div style="font-size:11px; color:#64748b; font-weight:700;">TOTAL UDHARI</div>
            <div style="font-size:20px; font-weight:900; color:#dc2626;">${formatINR(totalUdhari)}</div>
          </div>
          <div style="background:white; padding:12px; border-radius:8px;">
            <div style="font-size:11px; color:#64748b; font-weight:700;">ENTRIES</div>
            <div style="font-size:20px; font-weight:900; color:#991b1b;">${udharis.length}</div>
          </div>
        </div>
      </div>
    `;
    
    udharis.forEach(u => {
      const date = new Date(u.createdAt || Date.now());
      html += `
        <div style="display:flex; justify-content:space-between; padding:12px; background:${u.creditAmount > 1000 ? '#fef2f2' : 'white'}; border-radius:8px; margin-bottom:8px; border:1px solid #fca5a5;">
          <div style="flex:1;">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
              <span style="font-size:18px;">üìí</span>
              <div>
                <div style="font-weight:700; font-size:13px;">${u.products || 'Credit Sale'}</div>
                <div style="font-size:11px; color:#64748b;">üìÖ ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
              </div>
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:900; color:#dc2626; font-size:16px;">-${formatINR(parseFloat(u.creditAmount || u.amount || 0))}</div>
            <button onclick="sendUdhariReceipt('${u.id || Date.now()}')" style="font-size:9px; padding:2px 6px; background:#dc2626; color:white; border:none; border-radius:4px; font-weight:700; cursor:pointer; margin-top:4px;">üì± Receipt</button>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }
}

// Add new advance
function addNewAdvance() {
  if (!currentLedgerCustomer) return;
  
  const amount = prompt(`üí∞ Enter Advance Amount for ${currentLedgerCustomer.name}:`, '');
  if (!amount || isNaN(amount) || parseFloat(amount) <= 0) return showToast('Invalid amount!');
  
  const purpose = prompt('üìù Purpose/Note (optional):', 'Advance deposit') || 'Advance deposit';
  
  const deliveryDate = prompt('üìÖ Delivery Date (DD/MM/YYYY):', new Date().toLocaleDateString('en-GB'));
  const deliveryAddress = prompt('üìç Delivery Address:', currentLedgerCustomer.address || '') || '';
  
  // Record advance
  const newAdvance = {
    id: 'advance_' + Date.now(),
    date: new Date().toLocaleDateString(),
    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
    customer: currentLedgerCustomer.name,
    products: purpose,
    amount: parseFloat(amount),
    method: 'Cash In',
    advanceAmount: parseFloat(amount),
    deliveryDate: deliveryDate,
    deliveryAddress: deliveryAddress,
    creditAmount: 0,
    cartItems: [],
    createdAt: Date.now()
  };
  
  const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
  history.push(newAdvance);
  localStorage.setItem('mr_sales_history', JSON.stringify(history));
  
  // Update customer balance (advance reduces balance)
  currentLedgerCustomer.balance = (currentLedgerCustomer.balance || 0) - parseFloat(amount);
  localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
  
  showToast(`üí∞ ${formatINR(amount)} advance received!`);
  
  // Refresh ledger
  setTimeout(() => {
    loadLedgerData();
  }, 300);
}

// Send advance receipt via WhatsApp
function sendAdvanceReceipt(advanceId) {
  const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
  const advance = history.find(h => h.id === advanceId);
  
  if (!advance || !currentLedgerCustomer) return showToast('Advance not found!');
  
  const shopName = localStorage.getItem('MilkRecord_shop_name') || 'Gopal Dairy Shop';
  const date = new Date(advance.createdAt || Date.now()).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });
  
  let message = `*${shopName}*\n`;
  message += `üßæ *Advance Receipt*\n\n`;
  message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  message += `*Customer:* ${currentLedgerCustomer.name}\n`;
  message += `*Date:* ${date}\n`;
  message += `*Amount:* ${formatINR(parseFloat(advance.amount || 0))}\n`;
  message += `*Purpose:* ${advance.products || 'Advance Deposit'}\n`;
  
  if (advance.deliveryDate) {
    message += `*Delivery Date:* ${new Date(advance.deliveryDate).toLocaleDateString('en-IN')}\n`;
  }
  if (advance.deliveryAddress) {
    message += `*Delivery Address:* ${advance.deliveryAddress}\n`;
  }
  
  message += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  message += `üôè Thank you for your advance payment!`;
  
  if (currentLedgerCustomer.phone) {
    const whatsappUrl = `https://wa.me/91${currentLedgerCustomer.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
  } else {
    // No phone - just show message to copy
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
  }
  
  showToast('üì± Opening WhatsApp...');
}

// Send udhari receipt via WhatsApp
function sendUdhariReceipt(entryId) {
  const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
  const entry = history.find(h => h.id === entryId || (h.creditAmount > 0 && h.customer === currentLedgerCustomer.name));
  
  if (!entry || !currentLedgerCustomer) return showToast('Entry not found!');
  
  const shopName = localStorage.getItem('MilkRecord_shop_name') || 'Gopal Dairy Shop';
  const date = new Date(entry.createdAt || Date.now()).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });
  
  let message = `*${shopName}*\n`;
  message += `üìí *Udhari (Credit) Receipt*\n\n`;
  message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  message += `*Customer:* ${currentLedgerCustomer.name}\n`;
  message += `*Date:* ${date}\n`;
  message += `*Credit Amount:* ${formatINR(parseFloat(entry.creditAmount || entry.amount || 0))}\n`;
  message += `*Items:* ${entry.products || 'N/A'}\n`;
  message += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  message += `üìû Please clear your udhari soon!`;
  
  if (currentLedgerCustomer.phone) {
    const whatsappUrl = `https://wa.me/91${currentLedgerCustomer.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
  } else {
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
  }
  
  showToast('üì± Opening WhatsApp...');
}

// Send ledger summary via WhatsApp
function sendLedgerWhatsApp() {
  if (!currentLedgerCustomer) return;
  
  const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
  const customerEntries = history.filter(h => h.customer === currentLedgerCustomer.name);
  
  const advances = customerEntries.filter(e => e.method === 'Cash In');
  const udharis = customerEntries.filter(e => e.method === 'Credit' || e.method === 'Udhar' || (e.creditAmount && e.creditAmount > 0));
  
  const totalAdvance = advances.reduce((sum, a) => sum + parseFloat(a.amount || 0), 0);
  const totalUdhari = udharis.reduce((sum, u) => sum + parseFloat(u.creditAmount || u.amount || 0), 0);
  
  const shopName = localStorage.getItem('MilkRecord_shop_name') || 'Gopal Dairy Shop';
  
  let message = `*${shopName}*\n`;
  message += `üìí *Account Summary*\n\n`;
  message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
  message += `*Customer:* ${currentLedgerCustomer.name}\n`;
  message += `*Date:* ${new Date().toLocaleDateString('en-IN')}\n\n`;
  
  if (currentLedgerTab === 'advance') {
    message += `*üì• ADVANCE DEPOSITS*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `*Total Advance:* ${formatINR(totalAdvance)}\n`;
    message += `*Entries:* ${advances.length}\n\n`;
    
    advances.slice(0, 5).forEach(a => {
      const date = new Date(a.createdAt || Date.now()).toLocaleDateString('en-IN');
      message += `‚Ä¢ ${date}: ${formatINR(parseFloat(a.amount || 0))}\n`;
    });
    
    if (advances.length > 5) {
      message += `‚Ä¢ ... and ${advances.length - 5} more\n`;
    }
  } else {
    message += `*üìí UDHARI (CREDIT)*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `*Total Udhari:* ${formatINR(totalUdhari)}\n`;
    message += `*Entries:* ${udharis.length}\n\n`;
    
    udharis.slice(0, 5).forEach(u => {
      const date = new Date(u.createdAt || Date.now()).toLocaleDateString('en-IN');
      message += `‚Ä¢ ${date}: ${formatINR(parseFloat(u.creditAmount || u.amount || 0))}\n`;
    });
    
    if (udharis.length > 5) {
      message += `‚Ä¢ ... and ${udharis.length - 5} more\n`;
    }
  }
  
  message += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  message += `üôè Thank you!`;
  
  if (currentLedgerCustomer.phone) {
    const whatsappUrl = `https://wa.me/91${currentLedgerCustomer.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
  } else {
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
  }
  
  showToast('üì± Opening WhatsApp...');
}

// ========== CUSTOMER LEDGER FUNCTIONS ==========

let customerLedgerView = 'all';

// Open customer ledger
function openCustomerLedger() {
  openModal('customerLedgerModal');
  loadCustomerLedger();
}

// Show Shift Reconciliation
function showShiftReconciliation() {
  if (window.ShiftReconciliation) {
    const today = new Date().toISOString().split('T')[0];
    const hour = new Date().getHours();
    const shift = (hour >= 4 && hour < 16) ? 'Morning' : 'Evening';
    ShiftReconciliation.showReconciliation(today, shift);
  } else {
    showToast('‚ö†Ô∏è Shift Reconciliation not loaded');
  }
}

// Open FSSAI Screen
function openFSSAIScreen() {
  window.location.href = '/fssai-compliance-screen';
}

// Show QR Traceability
function showQRTraceability() {
  if (window.QRTraceability) {
    // Get latest production batch
    const batches = JSON.parse(localStorage.getItem('mr_production_batches') || '[]');
    if (batches.length > 0) {
      const latestBatch = batches[batches.length - 1];
      QRTraceability.showQRLabel(latestBatch);
    } else {
      showToast('üì± No production batches found. Create one first!');
    }
  } else {
    showToast('‚ö†Ô∏è QR Traceability not loaded');
  }
}

// Show Production Report
function showProductionReport() {
  const batches = JSON.parse(localStorage.getItem('mr_production_batches') || '[]');
  
  let html = '<div style="padding:20px;">';
  html += '<h3 style="margin-bottom:16px;">üè≠ Production Batches</h3>';
  
  if (batches.length === 0) {
    html += '<div style="padding:40px; text-align:center; color:#94a3b8;">No production batches yet</div>';
  } else {
    batches.slice(-10).reverse().forEach(b => {
      html += `
        <div style="background:#f8fafc; padding:12px; border-radius:8px; margin-bottom:8px; border-left:4px solid #7c3aed;">
          <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
            <span style="font-weight:700; color:#1e293b;">${b.batch_number}</span>
            <span style="font-size:11px; color:#64748b;">${b.product_type.toUpperCase()}</span>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; font-size:12px;">
            <div>ü•õ Milk: ${b.milk_quantity}L</div>
            <div>üì¶ Product: ${b.product_quantity}kg</div>
            <div>üìä Ratio: ${b.conversion_ratio}:1</div>
            <div>üìÖ ${new Date(b.created_at).toLocaleDateString()}</div>
          </div>
        </div>
      `;
    });
  }
  
  html += '</div>';
  
  // Show in modal
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  overlay.id = 'productionReportOverlay';
  overlay.innerHTML = `
    <div class="modal" style="width:95vw; max-width:500px; max-height:80vh; overflow-y:auto;">
      <div class="panelHeader">
        <span>üè≠ Production Report</span>
        <button onclick="document.getElementById('productionReportOverlay').remove()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b;">‚úñ</button>
      </div>
      ${html}
    </div>
  `;
  document.body.appendChild(overlay);
}

// Load customer ledger data
function loadCustomerLedger() {
  const content = document.getElementById('customerLedgerContent');
  if (!content) return;
  
  const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
  const custData = JSON.parse(localStorage.getItem('mr_pos_customers') || '[]');
  
  // Get today's date for filtering
  const today = new Date().toLocaleDateString();
  
  // Calculate summary statistics
  const totalCustomers = custData.length;
  const advances = history.filter(h => h.method === 'Cash In');
  // Detect credit: method is Credit/Udhar OR creditAmount exists and > 0
  const credits = history.filter(h => 
    h.method === 'Credit' || 
    h.method === 'Udhar' || 
    (h.creditAmount && parseFloat(h.creditAmount) > 0) ||
    (h.credit && parseFloat(h.credit) > 0)  // Backward compatibility
  );
  const cashCollected = history.filter(h => 
    (h.method === 'Cash' || h.method === 'UPI') && 
    (!h.creditAmount || parseFloat(h.creditAmount) <= 0)
  );
  const todaySales = history.filter(h => h.date === today);

  const totalAdvance = advances.reduce((sum, a) => sum + parseFloat(a.amount || 0), 0);
  const totalCredit = credits.reduce((sum, c) => sum + parseFloat(c.creditAmount || c.credit || c.amount || 0), 0);
  const totalCash = cashCollected.reduce((sum, c) => sum + parseFloat(c.paidAmount || c.amount || 0), 0);
  const todayTotal = todaySales.reduce((sum, s) => sum + parseFloat(s.amount || 0), 0);
  
  // Update summary cards
  document.getElementById('sumTotalCustomers').textContent = totalCustomers;
  document.getElementById('sumTotalAdvance').textContent = formatINR(totalAdvance);
  document.getElementById('sumTotalCredit').textContent = formatINR(totalCredit);
  document.getElementById('sumCashCollected').textContent = formatINR(totalCash);
  document.getElementById('sumTodaySales').textContent = formatINR(todayTotal);
  
  // Load based on current view
  switchCustomerLedgerView();
}

// Switch customer ledger view
function switchCustomerLedgerView() {
  customerLedgerView = document.getElementById('ledgerView').value;
  filterCustomerLedger();
}

// Filter customer ledger
function filterCustomerLedger() {
  const content = document.getElementById('customerLedgerContent');
  if (!content) return;

  const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
  
  // Load customers - handle multiple possible formats
  let custData = [];
  try {
    const stored = localStorage.getItem('mr_pos_customers');
    if (stored) {
      const parsed = JSON.parse(stored);
      if (Array.isArray(parsed)) {
        custData = parsed;
      } else if (typeof parsed === 'object') {
        // Handle object format - convert to array
        custData = Object.values(parsed);
      }
    }
  } catch(e) {
    console.error('‚ùå Failed to parse custData:', e);
    custData = [];
  }
  
  // Debug logging
  console.log('üìä Customer Ledger - Customers loaded:', custData.length);
  console.log('üìä Customer Ledger - History entries:', history.length);

  const searchTerm = document.getElementById('ledgerSearch').value.toLowerCase();
  const fromDate = document.getElementById('ledgerFromDate').value;
  const toDate = document.getElementById('ledgerToDate').value;

  let filteredHistory = history;

  // Filter by date range
  if (fromDate) {
    const from = new Date(fromDate);
    filteredHistory = filteredHistory.filter(h => {
      const hDate = new Date(h.createdAt || Date.now());
      return hDate >= from;
    });
  }
  if (toDate) {
    const to = new Date(toDate);
    to.setHours(23, 59, 59, 999);
    filteredHistory = filteredHistory.filter(h => {
      const hDate = new Date(h.createdAt || Date.now());
      return hDate <= to;
    });
  }

  // Filter by search term (search in customer name/phone)
  let filteredCustomers = custData;
  if (searchTerm) {
    filteredCustomers = custData.filter(c =>
      c.name.toLowerCase().includes(searchTerm) ||
      (c.phone && c.phone.includes(searchTerm))
    );
    // Also filter history by matching customers
    filteredHistory = filteredHistory.filter(h =>
      h.customer.toLowerCase().includes(searchTerm)
    );
  }
  
  console.log('üìä Filtered customers:', filteredCustomers.length);

  let html = '';

  if (customerLedgerView === 'all') {
    // Show all customers with their summary
    html += '<h3 style="font-size:14px; font-weight:700; color:#1e293b; margin-bottom:12px;">üìã All Customers Master List</h3>';
    html += '<div style="display:grid; gap:12px;">';

    if (filteredCustomers.length === 0) {
      html += '<div style="padding:40px; text-align:center; color:#64748b;">üìã No customers found</div>';
    } else {
      filteredCustomers.forEach(cust => {
        const custHistory = filteredHistory.filter(h => h.customer === cust.name);
        const custAdvances = custHistory.filter(h => h.method === 'Cash In');
        // Detect credit by method OR creditAmount field
        const custCredits = custHistory.filter(h =>
          h.method === 'Credit' ||
          h.method === 'Udhar' ||
          (h.creditAmount && parseFloat(h.creditAmount) > 0) ||
          (h.credit && parseFloat(h.credit) > 0)
        );
        const custCash = custHistory.filter(h =>
          (h.method === 'Cash' || h.method === 'UPI') &&
          (!h.creditAmount || parseFloat(h.creditAmount) <= 0)
        );

        const totalAdv = custAdvances.reduce((sum, a) => sum + parseFloat(a.amount || 0), 0);
        const totalCred = custCredits.reduce((sum, c) => sum + parseFloat(c.creditAmount || c.credit || c.amount || 0), 0);
        const totalCashCust = custCash.reduce((sum, c) => sum + parseFloat(c.paidAmount || c.amount || 0), 0);

        // Get latest sale for this customer
        const latestSale = custHistory.filter(h => h.cartItems && h.cartItems.length > 0).pop();

        html += `
          <div style="background:white; padding:16px; border-radius:8px; border:1px solid #e2e8f0; ${latestSale ? 'cursor:pointer;' : ''}" ${latestSale ? `onclick="restoreCartFromLedger('${cust.name}', ${JSON.stringify(latestSale.cartItems || []).replace(/"/g, '&quot;')})" title="Click to restore last order"` : ''}>
            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
              <div>
                <div style="font-size:16px; font-weight:900; color:#1e293b;">${cust.name}</div>
                <div style="font-size:12px; color:#64748b;">${cust.phone || 'üì± No phone'}${cust.address ? ' ‚Ä¢ üìç ' + cust.address : ''}</div>
              </div>
              <div style="text-align:right;">
                <div style="font-size:18px; font-weight:900; color:${cust.balance > 0 ? '#dc2626' : '#16a34a'};">${formatINR(cust.balance || 0)}</div>
                <div style="font-size:11px; color:#64748b;">Balance</div>
              </div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; padding-top:12px; border-top:1px solid #f1f5f9;">
              <div style="text-align:center;">
                <div style="font-size:11px; color:#64748b;">Advance</div>
                <div style="font-size:14px; font-weight:700; color:#16a34a;">${formatINR(totalAdv)}</div>
              </div>
              <div style="text-align:center;">
                <div style="font-size:11px; color:#64748b;">Credit</div>
                <div style="font-size:14px; font-weight:700; color:#dc2626;">${formatINR(totalCred)}</div>
              </div>
              <div style="text-align:center;">
                <div style="font-size:11px; color:#64748b;">Cash Paid</div>
                <div style="font-size:14px; font-weight:700; color:#16a34a;">${formatINR(totalCashCust)}</div>
              </div>
            </div>
            ${latestSale ? `<div style="font-size:9px; color:#64748b; margin-top:8px; text-align:center;">üîÅ Click to restore last order</div>` : ''}
          </div>
        `;
      });
    }

    html += '</div>';
    
  } else if (customerLedgerView === 'advances') {
    // Show advance deposits
    html += '<h3 style="font-size:14px; font-weight:700; color:#1e293b; margin-bottom:12px;">üí∞ Advance Deposits</h3>';
    html += '<div style="display:grid; gap:8px;">';
    
    const advances = filteredHistory.filter(h => h.method === 'Cash In');
    
    if (advances.length === 0) {
      html += '<div style="padding:40px; text-align:center; color:#64748b;">üì• No advance deposits found</div>';
    } else {
      advances.forEach(a => {
        const date = new Date(a.createdAt || Date.now());
        html += `
          <div style="background:#f0f9ff; padding:12px; border-radius:8px; border-left:4px solid #0284c7;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="font-weight:700; color:#0369a1;">${a.customer}</div>
                <div style="font-size:11px; color:#64748b;">üìÖ ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                ${a.products ? `<div style="font-size:12px; color:#0369a1;">üìù ${a.products}</div>` : ''}
              </div>
              <div style="text-align:right;">
                <div style="font-size:18px; font-weight:900; color:#16a34a;">+${formatINR(parseFloat(a.amount || 0))}</div>
                <div style="font-size:11px; color:#64748b;">Advance</div>
              </div>
            </div>
          </div>
        `;
      });
    }
    
    html += '</div>';
    
  } else if (customerLedgerView === 'credits') {
    // Show credit/udhari - detect by method OR creditAmount field
    html += '<h3 style="font-size:14px; font-weight:700; color:#1e293b; margin-bottom:12px;">üìí Credit/Udhari (Date-wise)</h3>';
    html += '<div style="display:grid; gap:8px;">';

    const credits = filteredHistory.filter(h => 
      h.method === 'Credit' || 
      h.method === 'Udhar' || 
      (h.creditAmount && parseFloat(h.creditAmount) > 0) ||
      (h.credit && parseFloat(h.credit) > 0)
    );

    if (credits.length === 0) {
      html += '<div style="padding:40px; text-align:center; color:#64748b;">‚úÖ No credit/udhari found</div>';
    } else {
      credits.forEach(c => {
        const date = new Date(c.createdAt || Date.now());
        const creditAmt = parseFloat(c.creditAmount || c.credit || c.amount || 0);
        const totalAmt = parseFloat(c.amount || 0);
        
        // Parse cart items for better display
        let itemsHtml = '';
        if (c.cartItems && Array.isArray(c.cartItems)) {
          itemsHtml = c.cartItems.map(item => 
            `<div style="font-size:11px; color:#991b1b;">‚Ä¢ ${item.name || 'Item'} (${item.qty || 0}x ‚Çπ${item.rate || 0})</div>`
          ).join('');
        } else if (c.products) {
          itemsHtml = `<div style="font-size:12px; color:#991b1b;">üìù ${c.products}</div>`;
        }

        html += `
          <div style="background:#fef2f2; padding:12px; border-radius:8px; border-left:4px solid #dc2626; cursor:pointer;" onclick="restoreCartFromLedger('${c.customer}', ${JSON.stringify(c.cartItems || []).replace(/"/g, '&quot;')})" title="Click to restore cart">
            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
              <div style="flex:1;">
                <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                  <div style="font-weight:700; color:#991b1b; font-size:14px;">${c.customer}</div>
                  <span style="font-size:9px; background:#dc2626; color:white; padding:2px 6px; border-radius:4px; font-weight:700;">üìí UDHA RI</span>
                </div>
                <div style="font-size:10px; color:#64748b;">üìÖ ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
              </div>
              <div style="text-align:right;">
                <div style="font-size:20px; font-weight:900; color:#dc2626;">${formatINR(totalAmt)}</div>
                <div style="font-size:9px; color:#dc2626; font-weight:700;">Due: ${formatINR(creditAmt)}</div>
                <div style="font-size:9px; color:#64748b;">Credit Sale</div>
              </div>
            </div>
            ${itemsHtml ? `<div style="border-top:1px solid #fecaca; padding-top:8px; margin-top:8px;">${itemsHtml}</div>` : ''}
            <div style="font-size:9px; color:#64748b; margin-top:6px; text-align:center;">üîÅ Click to restore cart</div>
          </div>
        `;
      });
    }
    
    html += '</div>';
    
  } else if (customerLedgerView === 'today') {
    // Show today's sales (ALL - including credit)
    html += '<h3 style="font-size:14px; font-weight:700; color:#1e293b; margin-bottom:12px;">üìÖ Today\'s Sales</h3>';
    html += '<div style="display:grid; gap:8px;">';

    const today = new Date().toLocaleDateString();
    const todayData = filteredHistory.filter(h => h.date === today && h.method !== 'Cash In' && h.method !== 'Cash Out');

    if (todayData.length === 0) {
      html += '<div style="padding:40px; text-align:center; color:#64748b;">üìä No sales today yet</div>';
    } else {
      todayData.forEach(s => {
        const date = new Date(s.createdAt || Date.now());
        const isCredit = s.method === 'Credit' || s.method === 'Udhar' || (s.creditAmount && parseFloat(s.creditAmount) > 0);
        const totalAmount = parseFloat(s.amount || 0);
        const paidAmount = parseFloat(s.paidAmount || 0);
        const creditAmount = parseFloat(s.creditAmount || 0);

        // Determine card color and border based on payment status
        const bgColor = isCredit ? '#fef2f2' : '#dcfce7';
        const borderColor = isCredit ? '#dc2626' : '#16a34a';
        const textColor = isCredit ? '#991b1b' : '#166534';
        const statusLabel = isCredit ? 'Credit' : s.method;

        // Parse cart items for better display
        let itemsHtml = '';
        if (s.cartItems && Array.isArray(s.cartItems)) {
          itemsHtml = s.cartItems.map(item => 
            `<div style="font-size:11px; color:${textColor};">‚Ä¢ ${item.name || 'Item'} (${item.qty || 0}x ‚Çπ${item.rate || 0})</div>`
          ).join('');
        } else if (s.products) {
          itemsHtml = `<div style="font-size:12px; color:${textColor};">üìù ${s.products}</div>`;
        }

        html += `
          <div style="background:${bgColor}; padding:12px; border-radius:8px; border-left:4px solid ${borderColor}; cursor:pointer;" onclick="restoreCartFromLedger('${s.customer}', ${JSON.stringify(s.cartItems || []).replace(/"/g, '&quot;')})" title="Click to restore cart">
            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
              <div style="flex:1;">
                <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                  <div style="font-weight:700; color:${textColor}; font-size:14px;">${s.customer}</div>
                  ${isCredit ? '<span style="font-size:9px; background:#dc2626; color:white; padding:2px 6px; border-radius:4px; font-weight:700;">üìí CREDIT</span>' : ''}
                </div>
                <div style="font-size:10px; color:#64748b;">üìÖ ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
              </div>
              <div style="text-align:right;">
                <div style="font-size:20px; font-weight:900; color:${isCredit ? '#dc2626' : '#16a34a'};">${formatINR(totalAmount)}</div>
                ${isCredit && creditAmount > 0 ? `<div style="font-size:9px; color:#dc2626; font-weight:700;">Due: ${formatINR(creditAmount)}</div>` : ''}
                <div style="font-size:9px; color:#64748b;">${statusLabel}${!isCredit ? ` ‚Ä¢ Paid: ${formatINR(paidAmount)}` : ''}</div>
              </div>
            </div>
            ${itemsHtml ? `<div style="border-top:1px solid ${isCredit ? '#fecaca' : '#bbf7d0'}; padding-top:8px; margin-top:8px;">${itemsHtml}</div>` : ''}
            ${isCredit ? `<div style="font-size:9px; color:#64748b; margin-top:6px; text-align:center;">üîÅ Click to restore cart</div>` : ''}
          </div>
        `;
      });
    }

    html += '</div>';
  }
  
  content.innerHTML = html;
}

// Export customer ledger to Excel
function exportCustomerLedgerExcel() {
  showToast('üìä Exporting to Excel...');
  // Implementation for Excel export
}

// Print customer ledger
function printCustomerLedger() {
  showToast('üñ®Ô∏è Printing report...');
  // Implementation for print
}

// Restore cart from ledger entry
function restoreCartFromLedger(customerName, cartItems) {
  if (!cartItems || cartItems.length === 0) {
    showToast('‚ùå No items to restore');
    return;
  }

  // Set customer
  const activeCust = document.getElementById('activeCust');
  if (activeCust) {
    activeCust.innerText = customerName;
  }

  // Restore cart items
  cart = JSON.parse(JSON.stringify(cartItems));
  
  // Update UI
  updateUI();
  
  showToast(`üõí Restored ${cartItems.length} items for ${customerName}!`);
  
  // Close modal
  closeModal('customerLedgerModal');
}

// ========== RATE LIST FUNCTIONS ==========
function renderRateListProducts() {
  const container = document.getElementById('rateListProducts');
  if (!container) return;

  // Load products from localStorage
  const customProducts = loadData('mr_pos_custom_products', []);

  if (!Array.isArray(customProducts) || customProducts.length === 0) {
    container.innerHTML = `
      <div style="text-align:center; padding:60px 20px; color:#64748b;">
        <div style="font-size:64px; margin-bottom:16px;">üì¶</div>
        <div style="font-size:18px; font-weight:700; margin-bottom:8px;">No Products</div>
        <div style="font-size:14px;">Add products to see them in the rate list</div>
      </div>
    `;
    return;
  }

  // Group products by name to show each product only ONCE
  const uniqueProducts = {};
  customProducts.forEach(p => {
    if (!uniqueProducts[p.name]) {
      uniqueProducts[p.name] = {
        name: p.name,
        emoji: p.emoji || 'üì¶',
        price: parseFloat(p.price) || 0,
        unit: p.unit || 'unit'
      };
    }
  });

  // Group products by category based on keywords in name
  const categories = {
    'ü•õ Milk & Dairy': ['milk', 'cow', 'buff', 'curd', 'dahi', 'lassi', 'paneer', 'cheese'],
    'üßà Ghee & Butter': ['ghee', 'butter', 'makhan'],
    'üç¨ Sweets': ['sweet', 'mithai', 'cake', 'barfi', 'ladoo', 'jalebi', 'rasgulla', 'peda', 'kalakand', 'milk cake'],
    'ü•ê Bakery': ['bakery', 'bread', 'bun', 'pav', 'toast', 'rusk', 'biscuit', 'cookie', 'khari'],
    'üì¶ Others': []
  };

  const categorizedProducts = {};
  Object.keys(categories).forEach(cat => {
    categorizedProducts[cat] = [];
  });

  Object.values(uniqueProducts).forEach(p => {
    const nameLower = p.name.toLowerCase();
    let assigned = false;
    
    for (const [category, keywords] of Object.entries(categories)) {
      if (category === 'üì¶ Others') continue;
      
      if (keywords.some(kw => nameLower.includes(kw))) {
        categorizedProducts[category].push(p);
        assigned = true;
        break;
      }
    }
    
    if (!assigned) {
      categorizedProducts['üì¶ Others'].push(p);
    }
  });

  // Generate HTML with category headers
  let html = '';

  for (const [category, products] of Object.entries(categorizedProducts)) {
    if (products.length === 0) continue;
    
    html += `
      <div style="margin-bottom:20px;">
        <h3 style="font-size:16px; font-weight:700; color:#1e293b; margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid #e2e8f0;">${category}</h3>
        <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:12px;">
    `;

    products.forEach(p => {
      const safeUnit = p.unit || 'unit';
      html += `
        <div style="display:flex; align-items:center; gap:12px; padding:12px; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0;">
          <div style="font-size:32px;">${p.emoji}</div>
          <div style="flex:1;">
            <div style="font-weight:700; color:#1e293b; font-size:14px;">${p.name}</div>
            <div style="font-size:12px; color:#64748b;">Per ${safeUnit}</div>
          </div>
          <div style="font-weight:900; color:#16a34a; font-size:16px;">${formatINR(p.price)}</div>
        </div>
      `;
    });

    html += `
        </div>
      </div>
    `;
  }

  container.innerHTML = html;
}

// Send rate list via WhatsApp - WITH CATEGORIES
function sendRateListWhatsApp() {
  const customProducts = loadData('mr_pos_custom_products', []);

  if (!Array.isArray(customProducts) || customProducts.length === 0) {
    return showToast('üìã No products to send!');
  }

  // Get unique products only
  const uniqueProducts = {};
  customProducts.forEach(p => {
    if (!uniqueProducts[p.name]) {
      uniqueProducts[p.name] = {
        name: p.name,
        emoji: p.emoji || 'üì¶',
        price: parseFloat(p.price) || 0,
        unit: p.unit || 'unit'
      };
    }
  });

  // Group by category
  const categories = {
    'ü•õ Milk & Dairy': ['milk', 'cow', 'buff', 'curd', 'dahi', 'lassi', 'paneer', 'cheese'],
    'üßà Ghee & Butter': ['ghee', 'butter', 'makhan'],
    'üç¨ Sweets': ['sweet', 'mithai', 'cake', 'barfi', 'ladoo', 'jalebi', 'rasgulla', 'peda', 'kalakand', 'milk cake'],
    'ü•ê Bakery': ['bakery', 'bread', 'bun', 'pav', 'toast', 'rusk', 'biscuit', 'cookie', 'khari'],
    'üì¶ Others': []
  };

  const categorizedProducts = {};
  Object.keys(categories).forEach(cat => {
    categorizedProducts[cat] = [];
  });

  Object.values(uniqueProducts).forEach(p => {
    const nameLower = p.name.toLowerCase();
    let assigned = false;
    
    for (const [category, keywords] of Object.entries(categories)) {
      if (category === 'üì¶ Others') continue;
      
      if (keywords.some(kw => nameLower.includes(kw))) {
        categorizedProducts[category].push(p);
        assigned = true;
        break;
      }
    }
    
    if (!assigned) {
      categorizedProducts['üì¶ Others'].push(p);
    }
  });

  const shopName = localStorage.getItem('MilkRecord_shop_name') || 'Gopal Dairy Shop';
  const date = new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });

  // Build WhatsApp message - WITH CATEGORIES
  let message = `*${shopName}*\n`;
  message += `üìã *Product Rate List*\n`;
  message += `üìÖ ${date}\n\n`;
  message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

  for (const [category, products] of Object.entries(categorizedProducts)) {
    if (products.length === 0) continue;
    
    message += `*${category}*\n`;
    message += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
    
    products.forEach(p => {
      message += `${p.emoji} ${p.name} - ${formatINR(p.price)}/${p.unit}\n`;
    });
    
    message += `\n`;
  }

  message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  message += `üìû Contact us for orders!\n`;
  message += `üôè Thank you!`;

  // Open WhatsApp
  const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
  window.open(whatsappUrl, '_blank');

  showToast('üì± Opening WhatsApp...');
}

// Copy rate list to clipboard - WITH CATEGORIES
function copyRateList() {
  const customProducts = loadData('mr_pos_custom_products', []);

  if (!Array.isArray(customProducts) || customProducts.length === 0) {
    return showToast('üìã No products to copy!');
  }

  // Get unique products only
  const uniqueProducts = {};
  customProducts.forEach(p => {
    if (!uniqueProducts[p.name]) {
      uniqueProducts[p.name] = {
        name: p.name,
        emoji: p.emoji || 'üì¶',
        price: parseFloat(p.price) || 0,
        unit: p.unit || 'unit'
      };
    }
  });

  // Group by category
  const categories = {
    'ü•õ Milk & Dairy': ['milk', 'cow', 'buff', 'curd', 'dahi', 'lassi', 'paneer', 'cheese'],
    'üßà Ghee & Butter': ['ghee', 'butter', 'makhan'],
    'üç¨ Sweets': ['sweet', 'mithai', 'cake', 'barfi', 'ladoo', 'jalebi', 'rasgulla', 'peda', 'kalakand', 'milk cake'],
    'ü•ê Bakery': ['bakery', 'bread', 'bun', 'pav', 'toast', 'rusk', 'biscuit', 'cookie', 'khari'],
    'üì¶ Others': []
  };

  const categorizedProducts = {};
  Object.keys(categories).forEach(cat => {
    categorizedProducts[cat] = [];
  });

  Object.values(uniqueProducts).forEach(p => {
    const nameLower = p.name.toLowerCase();
    let assigned = false;
    
    for (const [category, keywords] of Object.entries(categories)) {
      if (category === 'üì¶ Others') continue;
      
      if (keywords.some(kw => nameLower.includes(kw))) {
        categorizedProducts[category].push(p);
        assigned = true;
        break;
      }
    }
    
    if (!assigned) {
      categorizedProducts['üì¶ Others'].push(p);
    }
  });

  const shopName = localStorage.getItem('MilkRecord_shop_name') || 'Gopal Dairy Shop';
  const date = new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });

  let message = `*${shopName}*\n`;
  message += `üìã *Product Rate List*\n`;
  message += `üìÖ ${date}\n\n`;
  message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

  for (const [category, products] of Object.entries(categorizedProducts)) {
    if (products.length === 0) continue;
    
    message += `*${category}*\n`;
    message += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
    
    products.forEach(p => {
      message += `${p.emoji} ${p.name} - ${formatINR(p.price)}/${p.unit}\n`;
    });
    
    message += `\n`;
  }

  message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  message += `üìû Contact us for orders!\n`;
  message += `üôè Thank you!`;

  navigator.clipboard.writeText(message).then(() => {
    showToast('üìã Rate list copied!');
  }).catch(() => {
    showToast('‚ö†Ô∏è Copy failed');
  });
}

// Print rate list
function printRateList() {
  const customProducts = loadData('mr_pos_custom_products', []);

  if (!Array.isArray(customProducts) || customProducts.length === 0) {
    return showToast('üìã No products to print!');
  }

  // Get unique products only
  const uniqueProducts = {};
  customProducts.forEach(p => {
    if (!uniqueProducts[p.name]) {
      uniqueProducts[p.name] = {
        name: p.name,
        emoji: p.emoji || 'üì¶',
        price: parseFloat(p.price) || 0,
        unit: p.unit || 'unit'
      };
    }
  });

  const shopName = localStorage.getItem('MilkRecord_shop_name') || 'Gopal Dairy Shop';
  const date = new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });

  // Generate print HTML - Simple table without categories
  let productsHTML = `
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background:#7c3aed; color:white;">
          <th style="padding:12px; text-align:left; font-size:13px;">Product</th>
          <th style="padding:12px; text-align:left; font-size:13px;">Unit</th>
          <th style="padding:12px; text-align:right; font-size:13px;">Price</th>
        </tr>
      </thead>
      <tbody>
  `;

  const productList = Object.values(uniqueProducts);
  productList.forEach((p, index) => {
    const safeUnit = p.unit || 'unit';
    productsHTML += `
      <tr style="${index % 2 === 0 ? 'background:#f8fafc' : 'background:white'}">
        <td style="padding:10px; border:1px solid #e2e8f0; font-size:13px;">${p.emoji} ${p.name}</td>
        <td style="padding:10px; border:1px solid #e2e8f0; font-size:13px;">Per ${safeUnit}</td>
        <td style="padding:10px; border:1px solid #e2e8f0; font-size:13px; text-align:right; font-weight:bold; color:#16a34a;">${formatINR(p.price)}</td>
      </tr>
    `;
  });

  productsHTML += `
      </tbody>
    </table>
  `;

  const printHTML = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Dairy POS Billing Software India - Free POS System for Milk Shops | MilkRecord</title>
      <style>
        @media print {
          body { padding: 10mm; }
          .no-print { display: none; }
          @page { margin: 10mm; }
        }
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .header { text-align: center; border-bottom: 3px solid #7c3aed; padding-bottom: 15px; margin-bottom: 20px; }
        .header h1 { color: #1e293b; margin: 0; font-size: 24px; }
        .header p { color: #64748b; margin: 5px 0; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th { background: #f8fafc; padding: 10px; text-align: left; font-weight: bold; border: 1px solid #e2e8f0; font-size: 13px; }
        td { padding: 10px; border: 1px solid #e2e8f0; font-size: 13px; }
        .footer { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 2px solid #e2e8f0; color: #64748b; font-size: 12px; }
        .print-btn { background: #7c3aed; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; margin: 20px auto; display: block; }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>Dairy POS Billing Software for Indian Milk Shops</h1>
        <p>Product Rate List | ${date}</p>
      </div>
      ${productsHTML}
      <div class="footer">
        <p>üìû Contact us for orders! | üôè Thank you!</p>
        <p>Generated: ${new Date().toLocaleString('en-IN')}</p>
      </div>
      <button class="print-btn no-print" onclick="window.print(); window.close();">üñ®Ô∏è Print Now</button>
    </body>
    </html>
  `;

  // Open print window
  const printWindow = window.open('', '_blank');
  if (printWindow) {
    printWindow.document.write(printHTML);
    printWindow.document.close();
    setTimeout(() => {
      printWindow.focus();
      printWindow.print();
    }, 500);
  }
}
    </script>
    
    <!-- Mobile Sidebar -->
    <script src="../js/mobile-sidebar.js"></script>
    <script src="../js/shift-reconciliation-engine.js"></script>
    <script src="../js/yield-calculator.js"></script>
    <script src="../js/fssai-compliance.js"></script>
    <script src="../js/qr-traceability.js"></script>
    <script>
      // Initialize mobile header
      document.addEventListener('DOMContentLoaded', function() {
        const shopName = localStorage.getItem('MilkRecord_shop_name') || 'Your Dairy';
        const shopEl = document.getElementById('mobileHeaderShop');
        if (shopEl) shopEl.textContent = shopName;
        if (window.SidebarManager) SidebarManager.setActive('pos');
      });
      
      // Quick shift close button
      function quickShiftClose() {
        const today = new Date().toISOString().split('T')[0];
        const hour = new Date().getHours();
        const shift = (hour >= 4 && hour < 16) ? 'Morning' : 'Evening';
        ShiftReconciliation.showReconciliation(today, shift);
      }
    </script>
    
    <!-- Mobile Fixed Payment Bar -->
    <div class="mobile-payment-bar mobile-only" id="mobilePaymentBar" style="display:none;">
      <div class="total-section">
        <div class="total-label">NET PAYABLE</div>
        <div class="total-amount" id="mobileTotalAmount">‚Çπ0.00</div>
      </div>
      <button class="action-btn hold-btn" onclick="holdCart()">üü° HOLD</button>
      <button class="action-btn pay-btn" onclick="showPaymentModal()">üí≥ PAY</button>
    </div>
    
    <!-- Mobile Payment Bar Script -->
    <script>
      // Update mobile payment bar total
      function updateMobilePaymentBar() {
        const mobileBar = document.getElementById('mobilePaymentBar');
        const mobileTotal = document.getElementById('mobileTotalAmount');
        
        if (mobileBar && mobileTotal) {
          if (cart.length > 0) {
            mobileBar.style.display = 'flex';
            mobileTotal.textContent = '‚Çπ' + total.toFixed(2);
          } else {
            mobileBar.style.display = 'none';
          }
        }
      }
      
      // Hold cart
      function holdCart() {
        if (cart.length === 0) {
          showToast('‚ö†Ô∏è Cart is empty!');
          return;
        }
        
        const customerName = document.getElementById('activeCust')?.textContent || 'Walking Customer';
        holdOrder(customerName);
      }
      
      // Show payment modal
      function showPaymentModal() {
        if (cart.length === 0) {
          showToast('‚ö†Ô∏è Cart is empty!');
          return;
        }
        
        openModal('paymentModal');
      }
      
      // Hook into existing updateUI function
      const originalUpdateUI = window.updateUI;
      window.updateUI = function() {
        if (originalUpdateUI) originalUpdateUI();
        updateMobilePaymentBar();
      };
      
      // Initialize
      updateMobilePaymentBar();
    </script>
  </body>
</html>