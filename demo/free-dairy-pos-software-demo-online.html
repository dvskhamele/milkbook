<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1"
    />

    <style>
      :root {
        --bg: #f4f7fb;
        --panel: #ffffff;
        --line: #e5e7eb;
        --text: #0f172a;
        --muted: #64748b;

        --blue: #2563eb;
        --blue2: #1d4ed8;

        --green: #16a34a;
        --red: #dc2626;
        --yellow: #f59e0b;

        --soft-green: #ecfdf5;
        --soft-yellow: #fffbeb;
        --soft-blue: #eff6ff;
        --soft-pink: #fff1f2;

        --shadow: 0 12px 26px rgba(0, 0, 0, 0.08);
        --r: 18px;

        --tile: 78px;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial;
      }
      body {
        background: var(--bg);
        color: var(--text);
        overflow: hidden;
      } /* no scroll */

      /* APP FRAME */
      .app {
        height: 100%;
        display: grid;
        grid-template-rows: 70px 1fr 96px;
        gap: 14px;
        padding: 14px;
      }

      /* HEADER */
      .topbar {
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 22px;
        box-shadow: var(--shadow);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 70px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 260px;
      }
      .logo {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg, #e0f2fe, #dbeafe);
        border: 1px solid #c7d2fe;
        font-weight: 1000;
      }
      .brand .title {
        font-weight: 1000;
        font-size: 16px;
        line-height: 1.1;
      }
      .brand .sub {
        font-weight: 800;
        color: var(--muted);
        font-size: 12px;
        margin-top: 2px;
      }
      .hdr-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .pillbtn {
        height: 44px;
        padding: 0 16px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 900;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
      }
      .pillbtn.primary {
        background: var(--blue);
        color: #fff;
        border-color: transparent;
      }
      .pillbtn.warn {
        background: #fbbf24;
        color: #78350f;
        border-color: transparent;
      }
      .pillbtn:active {
        transform: translateY(1px);
      }

      .hdr-right {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 14px;
      }
      .timer {
        height: 44px;
        padding: 0 14px;
        border-radius: 14px;
        border: 1px dashed #cbd5e1;
        background: #fff;
        font-weight: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 120px;
      }
      .iconbtn {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        font-size: 18px;
      }
      .iconbtn:active {
        transform: translateY(1px);
      }

      /* CORE */
      .core {
        height: 100%;
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 14px;
        overflow: hidden;
        min-height: 0;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 22px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      .panelHeader {
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--line);
        font-weight: 1000;
        background: #fff;
      }
      .panelHeader small {
        color: var(--muted);
        font-weight: 900;
      }

      /* LEFT BODY */
      .actionBody {
        display: flex;
        flex-direction: column;
        gap: 16px;

        max-height: calc(100vh - 140px); /* header ke baad fit */
        overflow-y: auto; /* üëà MAIN SCROLL */
        padding-right: 6px;
      }

      /* FARMER PICK */
      .farmerPick {
        display: flex;
        flex-direction: column;
        gap: 12px; /* sabke beech gap */
      }

      .farmerTop {
        position: static !important; /* ‚ùó absolute / sticky cancel */
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap; /* chhoti screen pe break ho sake */
      }

      .searchBox {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 10px;
        border: 1px solid var(--line);
        border-radius: 16px;
        background: #fff;
        padding: 10px 12px;
        height: 48px;
      }
      .searchBox input {
        width: 100%;
        border: none;
        outline: none;
        font-size: 16px;
        font-weight: 900;
        color: var(--text);
        background: transparent;
      }
      .addNewBtn {
        height: 48px;
        padding: 0 16px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #eef2ff;
        font-weight: 1000;
        cursor: pointer;
      }
      .miniTag {
        height: 48px;
        min-width: 92px;
        padding: 0 12px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 1000;
        color: var(--muted);
      }
      .farmerGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;

        max-height: 240px; /* üëà yahin se scroll start */
        overflow-y: auto;
        padding-right: 6px;

        position: relative;
      }

      .fcard {
        height: var(--tile);
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }
      .fcard:active {
        transform: translateY(1px);
      }
      .fimg {
        width: 52px;
        height: 52px;
        border-radius: 14px;
        background: #f1f5f9;
        border: 1px solid var(--line);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex: 0 0 auto;
        overflow: hidden;
      }
      .fimg img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .fname {
        font-weight: 1000;
        font-size: 16px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 180px;
      }
      .fsub {
        color: var(--muted);
        font-weight: 900;
        font-size: 12px;
        margin-top: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 210px;
      }
      .fsel {
        outline: 3px solid rgba(22, 163, 74, 0.45);
        box-shadow: 0 0 0 6px rgba(22, 163, 74, 0.1);
      }
      .badge {
        position: absolute;
        right: 8px;
        top: 8px;
        padding: 6px 8px;
        border-radius: 12px;
        background: rgba(22, 163, 74, 0.12);
        border: 1px solid rgba(22, 163, 74, 0.25);
        font-weight: 1000;
        color: #166534;
        font-size: 12px;
      }
      .farmerNav {
        display: flex;
        justify-content: center;
        gap: 10px;
      }

      .navBtn {
        width: 48%;
        height: 44px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1000;
        cursor: pointer;
      }
      .navBtn:active {
        transform: translateY(1px);
      }
      .navBtn[disabled] {
        opacity: 0.45;
        cursor: not-allowed;
      }

      /* INPUTS GRID */
      .inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .control {
        border-radius: 18px;
        border: 1px solid var(--line);
        padding: 12px;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 10px;
        min-height: 154px;
      }
      .control.green {
        background: var(--soft-green);
      }
      .control.yellow {
        background: var(--soft-yellow);
      }
      .control.blue {
        background: var(--soft-blue);
      }
      .ctrlTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 1000;
      }
      .ctrlTop .muted {
        color: var(--muted);
        font-weight: 900;
      }
      .numBig {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 44px;
        font-weight: 1100;
        letter-spacing: 0.3px;
        color: #334155;
      }

      .numInput {
        width: 100%;
        text-align: center;
        font-size: 44px;
        font-weight: 1100;
        border: none;
        outline: none;
        background: transparent;
        color: #334155;
      }
      .numInput::-webkit-outer-spin-button,
      .numInput::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .pmRow {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .pm {
        height: 50px;
        border: none;
        border-radius: 16px;
        background: #fff;
        border: 1px solid var(--line);
        font-size: 26px;
        font-weight: 1100;
        cursor: pointer;
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.06);
      }
      .pm:active {
        transform: translateY(1px);
      }

      /* ANIMAL + RATE MODE ROW */
      .row3 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .animalCard {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 18px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 96px;
      }
      .animalCard label {
        font-weight: 1000;
        color: var(--muted);
        font-size: 12px;
        letter-spacing: 0.3px;
      }
      .animalCard select {
        height: 52px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1000;
        font-size: 16px;
        padding: 0 12px;
        outline: none;
      }

      .rateCard {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 18px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 96px;
      }
      .modeRow {
        display: flex;
        gap: 10px;
      }
      .modeBtn {
        flex: 1;
        height: 52px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #f1f5f9;
        font-weight: 1100;
        cursor: pointer;
      }
      .modeBtn.active {
        background: #fef3c7;
        border-color: #fcd34d;
      }
      .modeBtn:active {
        transform: translateY(1px);
      }

      /* MANUAL RATE OVERRIDE */
      .manualOverride {
        border: 2px dashed #cbd5e1;
        background: #f8fafc;
        border-radius: 18px;
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .manualOverride .left {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 1000;
        color: var(--muted);
      }
      .manualRateRow {
        display: none;
        gap: 10px;
        grid-template-columns: 1fr auto;
        align-items: center;
      }
      .manualRateRow input {
        height: 52px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
        font-size: 20px;
        padding: 0 12px;
        outline: none;
        width: 220px;
      }
      .manualRateRow button {
        height: 52px;
        width: 68px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
        cursor: pointer;
      }

      /* RIGHT BODY */
      .trustBody {
        padding: 14px;
        display: grid;
        grid-template-rows: auto auto 1fr;
        gap: 14px;
        min-height: 0;
      }
      .amountBox {
        background: linear-gradient(180deg, var(--blue), var(--blue2));
        border-radius: 26px;
        padding: 22px;
        color: #fff;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }
      .amountBox .label {
        opacity: 0.8;
        font-weight: 1000;
        letter-spacing: 0.3px;
        font-size: 12px;
      }
      .amountBox .amt {
        font-size: 66px;
        font-weight: 1200;
        line-height: 1;
        margin-top: 10px;
        letter-spacing: 0.5px;
      }
      .amountBox .sub {
        margin-top: 12px;
        display: inline-flex;
        gap: 10px;
        align-items: center;
        padding: 10px 14px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.15);
        font-weight: 1000;
      }

      .balances {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .balCard {
        border-radius: 18px;
        padding: 16px;
        border: 1px solid var(--line);
        font-weight: 1100;
      }
      .balCard .t {
        font-size: 12px;
        font-weight: 1000;
        color: var(--muted);
      }
      .balCard .v {
        font-size: 26px;
        font-weight: 1200;
        margin-top: 6px;
      }
      .balOld {
        background: var(--soft-pink);
        color: #991b1b;
      }
      .balNew {
        background: var(--soft-green);
        color: #166534;
      }

      .recent {
        border: 1px solid var(--line);
        border-radius: 18px;
        background: #fff;
        overflow: hidden;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }
      .recentHead {
        padding: 12px 14px;
        border-bottom: 1px solid var(--line);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 1100;
      }
      .recentHead .muted {
        color: var(--muted);
        font-weight: 1000;
        font-size: 12px;
      }
      .tableWrap {
        padding: 10px 14px 14px;
        min-height: 0;
        overflow: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        border-bottom: 1px solid var(--line);
        padding: 10px 6px;
        text-align: left;
        vertical-align: middle;
        white-space: nowrap;
      }
      th {
        color: var(--muted);
        font-weight: 1100;
        font-size: 12px;
      }
      tr:last-child td {
        border-bottom: none;
      }
      .tag {
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 1000;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .tag.cow {
        background: #dbeafe;
        color: #1d4ed8;
      }
      .tag.buff {
        background: #ede9fe;
        color: #6d28d9;
      }
      .rtag {
        padding: 5px 8px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #f8fafc;
        font-weight: 1100;
        font-size: 12px;
        color: var(--muted);
      }

      /* FOOTER BUTTONS */
      .bottom {
        display: grid;
        grid-template-columns: 1fr 1.4fr 1fr;
        gap: 12px;
        height: 96px;
      }
      .panicBtn {
        border: none;
        border-radius: 22px;
        font-size: 22px;
        font-weight: 1200;
        cursor: pointer;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        letter-spacing: 0.3px;
      }
      .panicBtn:active {
        transform: translateY(1px);
      }
      .hold {
        background: #fde68a;
        color: #78350f;
      }
      .save {
        background: #22c55e;
        color: #064e3b;
        font-size: 30px;
      }
      .undo {
        background: #fecaca;
        color: #7f1d1d;
      }
      .subnote {
        font-size: 12px;
        font-weight: 1100;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.06);
      }

      /* TOAST */
      .toast {
        position: fixed;
        left: 50%;
        bottom: 116px;
        transform: translateX(-50%);
        background: rgba(15, 23, 42, 0.92);
        color: #fff;
        padding: 12px 14px;
        border-radius: 16px;
        font-weight: 1100;
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.22);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.18s ease;
        max-width: 92vw;
        text-align: center;
        z-index: 70;
      }
      .toast.show {
        opacity: 1;
      }

      /* MODALS */
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 14px;
        z-index: 60;
      }
      .modal {
        width: min(980px, 98vw);
        height: min(640px, 92vh);
        border-radius: 22px;
        border: 1px solid var(--line);
        background: #fff;
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
        overflow: hidden;
        display: grid;
        grid-template-rows: 62px 1fr 72px;
      }
      .modalHead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-bottom: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
      }
      .modalHead .left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .closeBtn {
        width: 52px;
        height: 52px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        cursor: pointer;
        font-size: 18px;
        font-weight: 1100;
      }
      .modalBody {
        padding: 12px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        min-height: 0;
      }
      .modalBody.onecol {
        grid-template-columns: 1fr;
      }
      .modalCol {
        border: 1px solid var(--line);
        border-radius: 18px;
        background: #f8fafc;
        padding: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      .modalCol h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        font-weight: 1200;
        color: #0f172a;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .listArea {
        flex: 1;
        min-height: 0;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 10px;
      }
      .pageInfo {
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: var(--muted);
        font-weight: 1000;
        font-size: 12px;
      }
      .pageBtns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .pageBtns button {
        height: 50px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
        cursor: pointer;
      }
      .pageBtns button[disabled] {
        opacity: 0.45;
        cursor: not-allowed;
      }
      .cardRow {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 16px;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        min-height: 64px;
      }
      .cardRow .title {
        font-weight: 1200;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 70%;
      }
      .cardRow .meta {
        color: var(--muted);
        font-weight: 1000;
        font-size: 12px;
        margin-top: 4px;
      }
      .cardRow .val {
        font-weight: 1200;
        font-size: 14px;
        white-space: nowrap;
        color: #0f172a;
      }

      .modalFoot {
        padding: 10px 12px;
        border-top: 1px solid var(--line);
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        background: #fff;
      }
      .footBtn {
        height: 50px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
        cursor: pointer;
        padding: 0 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .footBtn.good {
        background: #dcfce7;
        border-color: #bbf7d0;
        color: #14532d;
      }
      .footBtn.warn {
        background: #fef3c7;
        border-color: #fde68a;
        color: #78350f;
      }
      .footBtn.bad {
        background: #fee2e2;
        border-color: #fecaca;
        color: #7f1d1d;
      }

      /* FORMS */
      .formGrid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .field {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 16px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .field label {
        color: var(--muted);
        font-weight: 1100;
        font-size: 12px;
        letter-spacing: 0.3px;
      }
      .field input,
      .field textarea,
      .field select {
        border: none;
        outline: none;
        background: transparent;
        color: var(--text);
        font-size: 16px;
        font-weight: 1100;
        resize: none;
      }
      .field textarea {
        min-height: 84px;
      }
      .field.full {
        grid-column: 1/-1;
      }

      .receiptBox {
        border: 2px dashed #cbd5e1;
        background: #fff;
        border-radius: 18px;
        padding: 12px;
        font-weight: 1100;
        line-height: 1.35;
        white-space: pre-wrap;
        min-height: 0;
        color: #0f172a;
      }

      /* Small screens */
      @media (max-width: 980px) {
        body {
          overflow: auto;
        } /* allow in small */
        .app {
          overflow: auto;
          height: auto;
          min-height: 100%;
        }
        .core {
          grid-template-columns: 1fr;
        }
        .bottom {
          grid-template-columns: 1fr 1fr 1fr;
        }
        .save {
          font-size: 22px;
        }
        .modalBody {
          grid-template-columns: 1fr;
        }
        .amountBox .amt {
          font-size: 54px;
        }
        .manualRateRow input {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <div class="app">
      <!-- HEADER -->
      <div class="topbar">
        <div class="brand">
          <div class="logo">üíß</div>
          <div>
            <div class="title" id="shopTitle">Gopal Dairy Shop</div>
            <div class="sub" id="todayLabel">‚Äî</div>
          </div>
        </div>

        <div style="display: flex; align-items: center; gap: 10px">
          <div class="hdr-actions">
            <button class="pillbtn" id="btnHistoryMain">üßæ History</button>
            <button class="pillbtn" id="langSwitch" style="background: #f1f5f9">
              üåê HI/EN
            </button>
          </div>

          <div class="hdr-right">
            <div class="timer" id="timerBox">‚è± 00:00</div>
            <button class="iconbtn" id="btnLeader" title="Leader (Weekly)">
              üèÜ
            </button>
            <button class="iconbtn" id="btnSettings" title="Settings">
              ‚öôÔ∏è
            </button>
          </div>
        </div>
      </div>

      <!-- CORE -->
      <div class="core">
        <!-- LEFT -->
        <div class="panel">
          <div class="panelHeader">
            <div id="stationTitle">Milk Intake Station</div>
            <small id="holdBadge"></small>
          </div>

          <div class="actionBody">
            <!-- Farmer selection -->
            <div class="farmerPick">
              <div class="farmerTop">
                <div class="searchBox">
                  üîé
                  <input
                    id="searchInput"
                    inputmode="search"
                    autocomplete="off"
                    placeholder="Search name‚Ä¶"
                  />
                </div>
                <button class="addNewBtn" id="btnAddFarmerMain">
                  Ôºã Add New
                </button>
                <div class="miniTag" id="farmerCount">0 üë§</div>
              </div>

              <div class="farmerGrid" id="farmerGrid"></div>

              <div class="farmerNav">
                <button class="navBtn" id="prevFarmers">‚¨ÖÔ∏è</button>
                <button class="navBtn" id="nextFarmers">‚û°Ô∏è</button>
              </div>
            </div>

            <!-- Inputs -->
            <div class="inputs">
              <div class="control green">
                <div class="ctrlTop">
                  <div id="qtyLabel">2. Liters (L)</div>
                  <div class="muted" id="qtyStep">¬±0.5</div>
                </div>
                <div class="numBig">
                  <input
                    id="qtyInput"
                    class="numInput"
                    type="number"
                    step="0.1"
                    value="0.0"
                  />
                </div>
                <div class="pmRow">
                  <button class="pm" id="qtyMinus">‚àí</button>
                  <button class="pm" id="qtyPlus">+</button>
                </div>
              </div>

              <div class="control yellow">
                <div class="ctrlTop">
                  <div id="fatLabel">3. Fat %</div>
                  <div class="muted" id="fatStep">¬±0.1</div>
                </div>
                <div class="numBig">
                  <input
                    id="fatInput"
                    class="numInput"
                    type="number"
                    step="0.1"
                    value="0.0"
                  />
                </div>
                <div class="pmRow">
                  <button class="pm" id="fatMinus">‚àí</button>
                  <button class="pm" id="fatPlus">+</button>
                </div>
              </div>

              <div class="control blue">
                <div class="ctrlTop">
                  <div id="snfLabel">4. SNF</div>
                  <div class="muted" id="snfStep">¬±0.1</div>
                </div>
                <div class="numBig">
                  <input
                    id="snfInput"
                    class="numInput"
                    type="number"
                    step="0.1"
                    value="0.0"
                  />
                </div>
                <div class="pmRow">
                  <button class="pm" id="snfMinus">‚àí</button>
                  <button class="pm" id="snfPlus">+</button>
                </div>
              </div>

              <div class="row3" style="grid-column: 1/-1">
                <div class="animalCard">
                  <label>5. Animal Type</label>
                  <select id="animalSelect">
                    <option value="cow">üêÑ Cow</option>
                    <option value="buffalo">üêÉ Buffalo</option>
                  </select>
                </div>

                <div class="rateCard">
                  <label>Rate Mode</label>
                  <div class="modeRow">
                    <button class="modeBtn active" id="btnRateModeAuto">
                      üí∞ Auto
                    </button>
                    <button class="modeBtn" id="btnRateModeManual">
                      ‚úçÔ∏è Manual
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Manual Rate Override -->
            <div class="manualOverride">
              <div class="left">üì∑ Manual Rate Override</div>
              <div style="display: flex; align-items: center; gap: 12px">
                <div class="rtag" id="rateTypeLabel">Rate: Auto</div>
                <div class="manualRateRow" id="manualRateRow">
                  <input
                    id="manualRateInput"
                    inputmode="decimal"
                    placeholder="Rate/L"
                  />
                  <button id="manualRateApply">‚úîÔ∏è</button>
                </div>
              </div>
            </div>

            <div style="flex: 1"></div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="panel">
          <div class="panelHeader">
            <div>Summary</div>
            <small id="selectedName">‚Äî</small>
          </div>

          <div class="trustBody">
            <div class="amountBox">
              <div class="label" id="amtLabel">TOTAL AMOUNT</div>
              <div class="amt" id="amountView">‚Çπ0.00</div>
              <div class="sub" id="trailMini">0.0 L √ó ‚Çπ0.00/L</div>
            </div>

            <div class="balances">
              <div class="balCard balOld">
                <div class="t" id="oldBalLabel">OLD BALANCE</div>
                <div class="v" id="balBefore">‚Çπ0.00</div>
              </div>
              <div class="balCard balNew">
                <div class="t" id="newBalLabel">NEW BALANCE</div>
                <div class="v" id="balAfter">‚Çπ0.00</div>
              </div>
            </div>

            <div class="recent">
              <div class="recentHead">
                <div class="t" id="newBalLabel">NEW BALANCE</div>
                <div class="muted" id="recentMeta">0 records</div>
              </div>
              <div class="tableWrap">
                <table>
                  <thead>
                    <tr>
                      <th>DATE</th>
                      <th>FARMER</th>
                      <th>SESSION</th>
                      <th>TYPE</th>
                      <th>QTY</th>
                      <th>FAT</th>
                      <th>SNF</th>
                      <th>AMT</th>
                    </tr>
                  </thead>
                  <tbody id="recentTbody">
                    <tr>
                      <td
                        colspan="8"
                        style="color: var(--muted); font-weight: 1100"
                      >
                        No records recorded today
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- hidden trail values (logic keeps) -->
            <div style="display: none">
              <span id="rateView"></span>
              <span id="trailQF"></span>
              <span id="trailRateType"></span>
              <span id="trailFormula"></span>
              <span id="trailTime"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="bottom">
        <button class="panicBtn hold" id="btnHold">
          üü° HOLD <span class="subnote">pause</span>
        </button>
        <button class="panicBtn save" id="btnSave">üü¢ SAVE ENTRY</button>
        <button class="panicBtn undo" id="btnUndo">
          üî¥ UNDO <span class="subnote">last</span>
        </button>
      </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!-- HISTORY MODAL -->
    <div class="overlay" id="overlayHistory">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayHistory">‚úñ</button>
            <div>üßæ History (Today + Weekly)</div>
          </div>
          <div class="muted" id="historyTitleRight">‚Äî</div>
        </div>

        <div class="modalBody">
          <div class="modalCol">
            <h3>üìÖ Today</h3>
            <div class="listArea">
              <div class="pageInfo">
                <span id="todayPageInfo">‚Äî</span>
                <span class="muted">No scroll ‚Ä¢ Pages</span>
              </div>
              <div
                id="todayList"
                style="display: grid; gap: 10px; align-content: start"
              ></div>
              <div class="pageBtns">
                <button id="todayPrev">‚¨ÖÔ∏è</button>
                <button id="todayNext">‚û°Ô∏è</button>
              </div>
            </div>
          </div>

          <div class="modalCol">
            <h3>üóìÔ∏è Weekly</h3>
            <div class="listArea">
              <div class="pageInfo">
                <span id="weekPageInfo">‚Äî</span>
                <span class="muted">Last 7 days</span>
              </div>
              <div
                id="weekList"
                style="display: grid; gap: 10px; align-content: start"
              ></div>
              <div class="pageBtns">
                <button id="weekPrev">‚¨ÖÔ∏è</button>
                <button id="weekNext">‚û°Ô∏è</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn warn" id="btnReceipt">üì© Receipt</button>
          <div style="display: flex; gap: 10px">
            <button class="footBtn" id="btnExport">‚¨áÔ∏è Export</button>
            <button class="footBtn bad" id="btnClearToday">
              üóëÔ∏è Clear Today
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- LEADER MODAL -->
    <div class="overlay" id="overlayLeader">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayLeader">‚úñ</button>
            <div>üèÜ Weekly Leader</div>
          </div>
          <div class="muted" id="leaderRight">‚Äî</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>Top Farmers (7 days)</h3>
            <div class="listArea">
              <div class="pageInfo">
                <span id="leaderPageInfo">‚Äî</span>
                <span class="muted">By Amount</span>
              </div>
              <div
                id="leaderList"
                style="display: grid; gap: 10px; align-content: start"
              ></div>
              <div class="pageBtns">
                <button id="leaderPrev">‚¨ÖÔ∏è</button>
                <button id="leaderNext">‚û°Ô∏è</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn" id="btnLeaderByAmt">üí∞ Amount</button>
          <button class="footBtn" id="btnLeaderByLit">ü•õ Liters</button>
          <button class="footBtn" id="btnLeaderByCount">üßæ Entries</button>
        </div>
      </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="overlay" id="overlaySettings">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlaySettings">‚úñ</button>
            <div>‚öôÔ∏è Settings</div>
          </div>
          <div class="muted">Offline ‚Ä¢ Saved</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>üí∞ Rate Formula (Simple, Visible)</h3>
            <div class="formGrid">
              <div class="field">
                <label>üêÑ Cow Base (‚Çπ)</label>
                <input id="setCowBase" inputmode="decimal" />
              </div>
              <div class="field">
                <label>üêÑ Cow Factor (‚Çπ per Fat)</label>
                <input id="setCowFactor" inputmode="decimal" />
              </div>
              <div class="field">
                <label>üêÉ Buffalo Base (‚Çπ)</label>
                <input id="setBuffBase" inputmode="decimal" />
              </div>
              <div class="field">
                <label>üêÉ Buffalo Factor (‚Çπ per Fat)</label>
                <input id="setBuffFactor" inputmode="decimal" />
              </div>

              <div class="field">
                <label>Qty Step (L)</label>
                <input id="setQtyStep" inputmode="decimal" />
              </div>
              <div class="field">
                <label>Fat Step (%)</label>
                <input id="setFatStep" inputmode="decimal" />
              </div>

              <div class="field">
                <label>SNF Step</label>
                <input id="setSnfStep" inputmode="decimal" />
              </div>
              <div class="field">
                <label>UI Session Switch Hour</label>
                <input id="setSessionHour" inputmode="numeric" />
              </div>

              <div class="field full">
                <label>Formula Preview (Auto)</label>
                <div
                  style="font-weight: 1100; font-size: 15px; padding: 6px 0"
                  id="formulaPreview"
                >
                  ‚Äî
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn good" id="btnSaveSettings">‚úÖ Save</button>
          <button class="footBtn warn" id="btnResetSettings">‚ôªÔ∏è Reset</button>
          <button class="footBtn bad" id="btnFactoryReset">
            üß® Factory Reset
          </button>
        </div>
      </div>
    </div>

    <!-- ADD FARMER MODAL -->
    <div class="overlay" id="overlayFarmer">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayFarmer">‚úñ</button>
            <div>‚ûï Add Farmer</div>
          </div>
          <div class="muted">Photo optional</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>üë§ Farmer Form</h3>
            <div class="formGrid">
              <div class="field">
                <label>üë§ Name</label>
                <input id="fName" autocomplete="off" />
              </div>
              <div class="field">
                <label>üì± Number</label>
                <input id="fPhone" inputmode="tel" autocomplete="off" />
              </div>
              <div class="field full">
                <label>üìç Address</label>
                <textarea id="fAddress"></textarea>
              </div>
              <div class="field full">
                <label>üñºÔ∏è Image</label>
                <input id="fImage" type="file" accept="image/*" />
                <div
                  style="
                    color: var(--muted);
                    font-size: 12px;
                    font-weight: 1000;
                  "
                >
                  Stored offline (small compressed)
                </div>
              </div>
              <div class="field">
                <label>‚Çπ Opening Balance</label>
                <input id="fBalance" inputmode="decimal" value="0" />
              </div>
              <div class="field">
                <label>Status</label>
                <select id="fActive">
                  <option value="1">‚úÖ Active</option>
                  <option value="0">‚õî Inactive</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn good" id="btnCreateFarmer">‚úÖ Create</button>
          <button class="footBtn" id="btnDemoFarmers">üß™ Demo Farmers</button>
        </div>
      </div>
    </div>

    <!-- RECEIPT MODAL -->
    <div class="overlay" id="overlayReceipt">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayReceipt">‚úñ</button>
            <div>üì© Receipt (Locked)</div>
          </div>
          <div class="muted">Copy ‚Ä¢ WhatsApp</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>üßæ Message</h3>
            <div class="receiptBox" id="receiptText">‚Äî</div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn good" id="btnCopyReceipt">üìã Copy</button>
          <button class="footBtn warn" id="btnWhatsApp">üí¨ WhatsApp</button>
          <button class="footBtn" id="btnCloseReceipt">‚úÖ Done</button>
        </div>
      </div>
    </div>

    <script>
      /***********************
       * OFFLINE DATA MODEL  *
       ***********************/
      const LS = {
        farmers: "milkapp_farmers_v2",
        entries: "milkapp_entries_v2",
        settings: "milkapp_settings_v2",
        hold: "milkapp_hold_v2",
        lastUndo: "milkapp_lastundo_v2",
      };

      const defaultSettings = {
        cowBase: 18.0,
        cowFactor: 6.0, // rate/L = base + factor * fat
        buffBase: 22.0,
        buffFactor: 7.0,
        qtyStep: 0.5,
        fatStep: 0.1,
        snfStep: 0.1,
        sessionSwitchHour: 14, // before this -> Morning, after -> Evening
      };

      function loadSettings() {
        try {
          const s = JSON.parse(localStorage.getItem(LS.settings) || "null");
          return { ...defaultSettings, ...(s || {}) };
        } catch (e) {
          return { ...defaultSettings };
        }
      }
      function saveSettings(s) {
        localStorage.setItem(LS.settings, JSON.stringify(s));
      }

      function loadFarmers() {
        try {
          return JSON.parse(localStorage.getItem(LS.farmers) || "[]") || [];
        } catch (e) {
          return [];
        }
      }
      function saveFarmers(arr) {
        localStorage.setItem(LS.farmers, JSON.stringify(arr));
      }

      function loadEntries() {
        try {
          return JSON.parse(localStorage.getItem(LS.entries) || "[]") || [];
        } catch (e) {
          return [];
        }
      }
      function saveEntries(arr) {
        localStorage.setItem(LS.entries, JSON.stringify(arr));
      }

      function uid(prefix = "id") {
        return (
          prefix +
          "_" +
          Math.random().toString(16).slice(2) +
          "_" +
          Date.now().toString(16)
        );
      }

      /***********************
       * TIME + DATE HELPERS *
       ***********************/
      function pad(n) {
        return String(n).padStart(2, "0");
      }
      function fmtTime(d) {
        return pad(d.getHours()) + ":" + pad(d.getMinutes());
      }
      function fmtDate(d) {
        const y = d.getFullYear();
        const m = pad(d.getMonth() + 1);
        const da = pad(d.getDate());
        return `${y}-${m}-${da}`;
      }
      function startOfDay(d) {
        const x = new Date(d);
        x.setHours(0, 0, 0, 0);
        return x;
      }
      function daysAgo(n) {
        const d = new Date();
        d.setDate(d.getDate() - n);
        return startOfDay(d);
      }

      function autoSessionLabel() {
        const h = new Date().getHours();
        return h < settings.sessionSwitchHour ? "Morning" : "Evening";
      }

      /***********************
       * APP STATE           *
       ***********************/
      let settings = loadSettings();
      let farmers = loadFarmers();
      let entries = loadEntries();

      let selectedFarmerId = null;

      let qty = 0.0;
      let fat = 0.0;
      let snf = 0.0;

      let animal = "cow"; // cow | buffalo
      let rateMode = "auto"; // auto | manual
      let manualRate = 0.0;

      // Farmer paging
      const FARMERS_PER_PAGE = 4; // 2x2 grid
      let farmerPage = 0;
      let farmerSearch = "";

      // History paging
      const LIST_PER_PAGE = 6;
      let todayPage = 0,
        weekPage = 0;

      // Leader paging
      const LEADER_PER_PAGE = 8;
      let leaderPage = 0;
      let leaderMode = "amount"; // amount | liters | count

      // Timer
      let timerStart = Date.now();
      let timerInt = null;

      /***********************
       * UI HOOKS            *
       ***********************/
      const el = (id) => document.getElementById(id);

      const farmerGrid = el("farmerGrid");
      const searchInput = el("searchInput");
      const farmerCount = el("farmerCount");

      const amountView = el("amountView");
      const rateView = el("rateView"); // hidden but used
      const selectedName = el("selectedName");

      const balBefore = el("balBefore");
      const balAfter = el("balAfter");

      const manualRateRow = el("manualRateRow");
      const manualRateInput = el("manualRateInput");
      const rateTypeLabel = el("rateTypeLabel");
      const holdBadge = el("holdBadge");
      const toast = el("toast");

      const recentTbody = el("recentTbody");
      const recentMeta = el("recentMeta");
      const trailMini = el("trailMini");

      const animalSelect = el("animalSelect");
      const btnRateModeAuto = el("btnRateModeAuto");
      const btnRateModeManual = el("btnRateModeManual");

      const qtyInput = el("qtyInput");
      const fatInput = el("fatInput");
      const snfInput = el("snfInput");

      /* Manual typing ‚Üí state update */
      qtyInput.addEventListener("input", (e) => {
        qty = Number(e.target.value) || 0;
        renderTrust();
      });
      fatInput.addEventListener("input", (e) => {
        fat = Number(e.target.value) || 0;
        renderTrust();
      });
      snfInput.addEventListener("input", (e) => {
        snf = Number(e.target.value) || 0;
        renderTrust();
      });

      /* + / ‚àí ke baad input sync */
      function syncInputs() {
        qtyInput.value = round2(qty).toFixed(1);
        fatInput.value = round2(fat).toFixed(1);
        snfInput.value = round2(snf).toFixed(1);
      }

      /***********************
       * TOAST               *
       ***********************/
      let toastT = null;
      function showToast(msg) {
        toast.textContent = msg;
        toast.classList.add("show");
        clearTimeout(toastT);
        toastT = setTimeout(() => toast.classList.remove("show"), 1200);
      }

      /***********************
       * FARMER HELPERS      *
       ***********************/
      function getFarmerById(id) {
        return farmers.find((f) => f.id === id) || null;
      }
      function activeFarmers() {
        return farmers.filter((f) => f.active !== false);
      }
      function filterFarmers() {
        const list = activeFarmers();
        if (!farmerSearch.trim()) return list;
        const q = farmerSearch.trim().toLowerCase();
        return list.filter((f) => (f.name || "").toLowerCase().includes(q));
      }
      function ensureSelectedFarmer() {
        const list = activeFarmers();
        if (!selectedFarmerId && list.length) {
          selectedFarmerId = list[0].id;
        } else if (
          selectedFarmerId &&
          !list.some((f) => f.id === selectedFarmerId)
        ) {
          selectedFarmerId = list.length ? list[0].id : null;
        }
      }

      /***********************
       * CALCULATION         *
       ***********************/
      function round2(n) {
        return Math.round((n + Number.EPSILON) * 100) / 100;
      }

      function getAutoRatePerLiter(fatVal, animalType) {
        const f = Number(fatVal) || 0;
        if (animalType === "buffalo") {
          return round2(settings.buffBase + settings.buffFactor * f);
        }
        return round2(settings.cowBase + settings.cowFactor * f);
      }

      function getRatePerLiter() {
        if (rateMode === "manual") {
          return round2(Number(manualRate) || 0);
        }
        return getAutoRatePerLiter(fat, animal);
      }

      function getAmount() {
        const r = getRatePerLiter();
        const q = Number(qty) || 0;
        return round2(q * r);
      }

      function farmerBalanceBefore(farmer) {
        return round2(Number(farmer.balance || 0));
      }

      /***********************
       * RENDER FARMERS      *
       ***********************/
      function escapeHtml(s) {
        return String(s).replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            })[c],
        );
      }

      function renderFarmers() {
        farmerCount.textContent = `${activeFarmers().length} üë§`;

        const list = filterFarmers();
        const maxPage = Math.max(
          0,
          Math.ceil(list.length / FARMERS_PER_PAGE) - 1,
        );
        if (farmerPage > maxPage) farmerPage = maxPage;

        const start = farmerPage * FARMERS_PER_PAGE;
        const pageItems = list.slice(start, start + FARMERS_PER_PAGE);

        farmerGrid.innerHTML = "";

        const toShow = [...pageItems];
        while (toShow.length < FARMERS_PER_PAGE) toShow.push(null);

        toShow.forEach((f) => {
          const card = document.createElement("div");
          card.className = "fcard";

          if (!f) {
            card.style.opacity = 0.4;
            card.innerHTML = `
        <div class="fimg">‚ûï</div>
        <div style="min-width:0;">
          <div class="fname">Add Farmer</div>
          <div class="fsub">Click to create new</div>
        </div>
      `;
            card.addEventListener("click", () => openOverlay("overlayFarmer"));
            farmerGrid.appendChild(card);
            return;
          }

          const isSel = f.id === selectedFarmerId;
          if (isSel) card.classList.add("fsel");

          const imgHTML = f.imageData
            ? `<img alt="" src="${f.imageData}">`
            : `üë§`;

          card.innerHTML = `
      <div class="fimg">${imgHTML}</div>
      <div style="min-width:0;">
        <div class="fname" title="${escapeHtml(f.name || "")}">${escapeHtml(f.name || "")}</div>
        <div class="fsub">${f.phone || ""} ‚Ä¢ ‚Çπ${round2(Number(f.balance || 0)).toFixed(2)}</div>
      </div>
      ${isSel ? `<div class="badge">Selected</div>` : ``}
    `;

          card.addEventListener("click", () => {
            selectedFarmerId = f.id;
            renderAll();
          });

          farmerGrid.appendChild(card);
        });

        el("prevFarmers").disabled = farmerPage <= 0;
        el("nextFarmers").disabled = farmerPage >= maxPage;
      }

      /***********************
       * RENDER RIGHT PANEL  *
       ***********************/
      function renderRecentToday() {
        const today = fmtDate(new Date());
        const todays = entries
          .filter((e) => e.day === today)
          .sort((a, b) => b.createdAt - a.createdAt);

        recentMeta.textContent = `${todays.length} records`;

        if (todays.length === 0) {
          recentTbody.innerHTML = `<tr><td colspan="8" style="color:var(--muted);font-weight:1100;">No records recorded today</td></tr>`;
          return;
        }

        const rows = todays
          .slice(0, 25)
          .map((e) => {
            const typeTag =
              e.animal === "buffalo"
                ? `<span class="tag buff">üêÉ Buffalo</span>`
                : `<span class="tag cow">üêÑ Cow</span>`;

            return `
      <tr>
        <td>${escapeHtml(e.day)}</td>
        <td style="font-weight:1100;">${escapeHtml(e.farmerName || "")}</td>
        <td><span class="rtag">${escapeHtml(e.session || "")}</span></td>
        <td>${typeTag}</td>
        <td style="font-weight:1100;">${Number(e.qty || 0).toFixed(1)} L</td>
        <td>${Number(e.fat || 0).toFixed(1)}%</td>
        <td>${Number(e.snf || 0).toFixed(1)}</td>
        <td style="font-weight:1200; color:#1d4ed8;">‚Çπ${Number(e.amount || 0).toFixed(2)}</td>
      </tr>
    `;
          })
          .join("");

        recentTbody.innerHTML = rows;
      }

      function renderTrust() {
        const farmer = getFarmerById(selectedFarmerId);
        selectedName.textContent = farmer ? farmer.name : "‚Äî";

        const r = getRatePerLiter();
        const a = getAmount();

        rateView.textContent = `‚Çπ${r.toFixed(2)}`;
        amountView.textContent = `‚Çπ${a.toFixed(2)}`;
        trailMini.textContent = `${round2(qty).toFixed(1)} L √ó ‚Çπ${r.toFixed(2)}/L`;

        const before = farmer ? farmerBalanceBefore(farmer) : 0;
        const after = round2(before + a);

        balBefore.textContent = `‚Çπ${before.toFixed(2)}`;
        balAfter.textContent = `‚Çπ${after.toFixed(2)}`;

        // steps + values
        el("qtyStep").textContent = `¬±${settings.qtyStep}`;
        el("fatStep").textContent = `¬±${settings.fatStep}`;
        el("snfStep").textContent = `¬±${settings.snfStep}`;

        // animal dropdown sync
        animalSelect.value = animal;

        // rate mode UI
        btnRateModeAuto.classList.toggle("active", rateMode === "auto");
        btnRateModeManual.classList.toggle("active", rateMode === "manual");

        if (rateMode === "manual") {
          rateTypeLabel.textContent = "Rate: Manual";
          manualRateRow.style.display = "grid";
        } else {
          rateTypeLabel.textContent = "Rate: Auto";
          manualRateRow.style.display = "none";
        }

        // HOLD badge
        const hold = loadHold();
        holdBadge.textContent = hold ? "HOLD ‚úÖ" : "";

        // recent today
        renderRecentToday();

          syncInputs();

      }

      function renderTodayLabel() {
        const d = new Date();
        el("todayLabel").textContent = `${fmtDate(d)} ‚Ä¢ ${autoSessionLabel()}`;
      }

      function renderAll() {
        ensureSelectedFarmer();
        renderFarmers();
        renderTrust();
        renderTodayLabel();
      }

      /***********************
       * HOLD + UNDO         *
       ***********************/
      function loadHold() {
        try {
          return JSON.parse(localStorage.getItem(LS.hold) || "null");
        } catch (e) {
          return null;
        }
      }
      function saveHold(obj) {
        if (!obj) localStorage.removeItem(LS.hold);
        else localStorage.setItem(LS.hold, JSON.stringify(obj));
      }

      function saveUndoToken(token) {
        localStorage.setItem(LS.lastUndo, JSON.stringify(token));
      }
      function loadUndoToken() {
        try {
          return JSON.parse(localStorage.getItem(LS.lastUndo) || "null");
        } catch (e) {
          return null;
        }
      }
      function clearUndoToken() {
        localStorage.removeItem(LS.lastUndo);
      }

      function holdCurrent() {
        const h = {
          selectedFarmerId,
          qty,
          fat,
          snf,
          animal,
          rateMode,
          manualRate,
          at: Date.now(),
        };
        saveHold(h);
        showToast("HOLD saved");
        renderAll();
      }

      function restoreHoldIfAny() {
        const h = loadHold();
        if (!h) return;
        selectedFarmerId = h.selectedFarmerId || selectedFarmerId;
        qty = Number(h.qty) || 0;
        fat = Number(h.fat) || 0;
        snf = Number(h.snf) || 0;
        animal = h.animal || "cow";
        rateMode = h.rateMode || "auto";
        manualRate = Number(h.manualRate) || 0;
        manualRateInput.value = manualRate ? String(manualRate) : "";
        saveHold(null);
        showToast("HOLD restored");
        renderAll();
      }

      /***********************
       * SAVE ENTRY          *
       ***********************/
      function canSave() {
        if (!selectedFarmerId) return false;
        if (qty <= 0) return false;
        if (fat <= 0) return false;
        if (getRatePerLiter() <= 0) return false;
        return true;
      }

      function saveEntry() {
        if (!canSave()) {
          showToast("Need: Farmer + Qty + Fat");
          return;
        }
        const farmer = getFarmerById(selectedFarmerId);
        if (!farmer) {
          showToast("Select farmer");
          return;
        }

        const before = farmerBalanceBefore(farmer);
        const ratePerL = getRatePerLiter();
        const amount = getAmount();
        const after = round2(before + amount);

        const entry = {
          id: uid("e"),
          farmerId: farmer.id,
          farmerName: farmer.name || "",
          qty: round2(qty),
          fat: round2(fat),
          snf: round2(snf),
          animal,
          rateMode,
          ratePerL: round2(ratePerL),
          amount: round2(amount),
          before,
          after,
          session: autoSessionLabel(),
          createdAt: Date.now(),
          day: fmtDate(new Date()),
        };

        // Update farmer balance
        farmer.balance = after;
        saveFarmers(farmers);

        // Save entry
        entries.push(entry);
        saveEntries(entries);

        // Set undo token (only last entry)
        saveUndoToken({
          entryId: entry.id,
          farmerId: farmer.id,
          prevBalance: before,
        });

        // Clear input quickly
        qty = 0;
        fat = 0;
        snf = 0;
        manualRate = 0;
        manualRateInput.value = "";
        showToast("SAVED ‚úÖ");

        autoNextFarmer();
        renderAll();
      }

      function autoNextFarmer() {
        const list = filterFarmers();
        const idx = list.findIndex((f) => f.id === selectedFarmerId);
        if (idx >= 0 && idx < list.length - 1) {
          selectedFarmerId = list[idx + 1].id;
        }
      }

      function undoLast() {
        const token = loadUndoToken();
        if (!token) {
          showToast("Nothing to undo");
          return;
        }

        const idx = entries.findIndex((e) => e.id === token.entryId);
        if (idx < 0) {
          clearUndoToken();
          showToast("Undo not found");
          return;
        }

        // Restore farmer balance
        const farmer = getFarmerById(token.farmerId);
        if (farmer) {
          farmer.balance = round2(Number(token.prevBalance) || 0);
          saveFarmers(farmers);
        }

        // Remove entry
        entries.splice(idx, 1);
        saveEntries(entries);

        clearUndoToken();
        showToast("UNDO ‚úÖ");
        renderAll();
      }

      /***********************
       * HISTORY + EXPORT     *
       ***********************/
      function entriesToday() {
        const today = fmtDate(new Date());
        return entries
          .filter((e) => e.day === today)
          .sort((a, b) => b.createdAt - a.createdAt);
      }
      function entriesWeek() {
        const start = daysAgo(6).getTime();
        return entries
          .filter((e) => e.createdAt >= start)
          .sort((a, b) => b.createdAt - a.createdAt);
      }

      function makeEntryCard(e) {
        const t = fmtTime(new Date(e.createdAt));
        const icon = e.animal === "buffalo" ? "üêÉ" : "üêÑ";
        const rt = e.rateMode === "manual" ? "Manual" : "Auto";
        return `
    <div class="cardRow">
      <div style="min-width:0;">
        <div class="title">${escapeHtml(e.farmerName || "")}</div>
        <div class="meta">${t} ‚Ä¢ ${icon} ‚Ä¢ ${e.qty}L ‚Ä¢ Fat ${e.fat}% ‚Ä¢ SNF ${e.snf} ‚Ä¢ ${rt}</div>
      </div>
      <div class="val">‚Çπ${Number(e.amount || 0).toFixed(2)}</div>
    </div>
  `;
      }

      function renderHistory() {
        const today = entriesToday();
        const week = entriesWeek();

        el("historyTitleRight").textContent =
          `${today.length} today ‚Ä¢ ${week.length} in 7d`;

        const tMax = Math.max(0, Math.ceil(today.length / LIST_PER_PAGE) - 1);
        if (todayPage > tMax) todayPage = tMax;
        const tSlice = today.slice(
          todayPage * LIST_PER_PAGE,
          todayPage * LIST_PER_PAGE + LIST_PER_PAGE,
        );
        el("todayList").innerHTML =
          tSlice.map(makeEntryCard).join("") ||
          `<div style="color:var(--muted);font-weight:1100;">No entries</div>`;
        el("todayPageInfo").textContent =
          `Page ${today.length ? todayPage + 1 : 0}/${today.length ? tMax + 1 : 0}`;
        el("todayPrev").disabled = todayPage <= 0;
        el("todayNext").disabled = todayPage >= tMax;

        const wMax = Math.max(0, Math.ceil(week.length / LIST_PER_PAGE) - 1);
        if (weekPage > wMax) weekPage = wMax;
        const wSlice = week.slice(
          weekPage * LIST_PER_PAGE,
          weekPage * LIST_PER_PAGE + LIST_PER_PAGE,
        );
        el("weekList").innerHTML =
          wSlice.map(makeEntryCard).join("") ||
          `<div style="color:var(--muted);font-weight:1100;">No entries</div>`;
        el("weekPageInfo").textContent =
          `Page ${week.length ? weekPage + 1 : 0}/${week.length ? wMax + 1 : 0}`;
        el("weekPrev").disabled = weekPage <= 0;
        el("weekNext").disabled = weekPage >= wMax;
      }

      function exportJSON() {
        const payload = {
          exportedAt: new Date().toISOString(),
          settings,
          farmers,
          entries,
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `milkapp_export_${fmtDate(new Date())}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast("Exported ‚úÖ");
      }

      function clearToday() {
        const today = fmtDate(new Date());
        const beforeLen = entries.length;
        entries = entries.filter((e) => e.day !== today);
        saveEntries(entries);
        showToast(
          entries.length !== beforeLen ? "Today cleared" : "No entries today",
        );
        renderHistory();
        renderAll();
      }

      /***********************
       * LEADERBOARD         *
       ***********************/
      function buildLeader() {
        const week = entriesWeek();
        const map = new Map();
        week.forEach((e) => {
          const cur = map.get(e.farmerId) || {
            farmerId: e.farmerId,
            name: e.farmerName,
            amount: 0,
            liters: 0,
            count: 0,
          };
          cur.amount = round2(cur.amount + Number(e.amount || 0));
          cur.liters = round2(cur.liters + Number(e.qty || 0));
          cur.count = cur.count + 1;
          map.set(e.farmerId, cur);
        });
        let arr = Array.from(map.values());
        arr.sort((a, b) => {
          if (leaderMode === "amount") return b.amount - a.amount;
          if (leaderMode === "liters") return b.liters - a.liters;
          return b.count - a.count;
        });
        return arr;
      }

      function renderLeader() {
        const leaders = buildLeader();
        const maxPage = Math.max(
          0,
          Math.ceil(leaders.length / LEADER_PER_PAGE) - 1,
        );
        if (leaderPage > maxPage) leaderPage = maxPage;

        const slice = leaders.slice(
          leaderPage * LEADER_PER_PAGE,
          leaderPage * LEADER_PER_PAGE + LEADER_PER_PAGE,
        );

        el("leaderRight").textContent =
          `${leaders.length} farmers ‚Ä¢ sorted by ${leaderMode}`;

        el("leaderPageInfo").textContent =
          `Page ${leaders.length ? leaderPage + 1 : 0}/${leaders.length ? maxPage + 1 : 0}`;

        el("leaderPrev").disabled = leaderPage <= 0;
        el("leaderNext").disabled = leaderPage >= maxPage;

        el("leaderList").innerHTML =
          slice
            .map(
              (l) => `
      <div class="cardRow">
        <div style="min-width:0;">
          <div class="title">${escapeHtml(l.name || "")}</div>
          <div class="meta">
            ‚Çπ${l.amount.toFixed(2)} ‚Ä¢ ${l.liters.toFixed(1)} L ‚Ä¢ ${l.count} entries
          </div>
        </div>
        <div class="val">
          ${
            leaderMode === "amount"
              ? "‚Çπ" + l.amount.toFixed(2)
              : leaderMode === "liters"
                ? l.liters.toFixed(1) + " L"
                : l.count
          }
        </div>
      </div>
    `,
            )
            .join("") ||
          `<div style="color:var(--muted);font-weight:1100;">No data</div>`;
      }

      /***********************
       * OVERLAYS HELPERS    *
       ***********************/
      function openOverlay(id) {
        document.getElementById(id).style.display = "flex";
        if (id === "overlayHistory") renderHistory();
        if (id === "overlayLeader") renderLeader();
      }
      function closeOverlay(id) {
        document.getElementById(id).style.display = "none";
      }

      /***********************
       * EVENTS              *
       ***********************/
      // Farmer search
      searchInput.addEventListener("input", (e) => {
        farmerSearch = e.target.value;
        farmerPage = 0;
        renderFarmers();
      });

      // Paging
      el("prevFarmers").onclick = () => {
        farmerPage--;
        renderFarmers();
      };
      el("nextFarmers").onclick = () => {
        farmerPage++;
        renderFarmers();
      };

      // Qty / Fat / SNF controls
      el("qtyMinus").onclick = () => {
        qty = Math.max(0, qty - settings.qtyStep);
        renderTrust();
      };
      el("qtyPlus").onclick = () => {
        qty += settings.qtyStep;
        renderTrust();
      };

      el("fatMinus").onclick = () => {
        fat = Math.max(0, fat - settings.fatStep);
        renderTrust();
      };
      el("fatPlus").onclick = () => {
        fat += settings.fatStep;
        renderTrust();
      };

      el("snfMinus").onclick = () => {
        snf = Math.max(0, snf - settings.snfStep);
        renderTrust();
      };
      el("snfPlus").onclick = () => {
        snf += settings.snfStep;
        renderTrust();
      };

      // Animal
      animalSelect.onchange = (e) => {
        animal = e.target.value;
        renderTrust();
      };

      // Rate mode
      btnRateModeAuto.onclick = () => {
        rateMode = "auto";
        renderTrust();
      };
      btnRateModeManual.onclick = () => {
        rateMode = "manual";
        renderTrust();
      };
      el("manualRateApply").onclick = () => {
        manualRate = Number(manualRateInput.value) || 0;
        renderTrust();
      };

      // Save / Hold / Undo
      el("btnSave").onclick = saveEntry;
      el("btnHold").onclick = holdCurrent;
      el("btnUndo").onclick = undoLast;

      // History
      el("btnHistoryMain").onclick = () => openOverlay("overlayHistory");
      el("todayPrev").onclick = () => {
        todayPage--;
        renderHistory();
      };
      el("todayNext").onclick = () => {
        todayPage++;
        renderHistory();
      };
      el("weekPrev").onclick = () => {
        weekPage--;
        renderHistory();
      };
      el("weekNext").onclick = () => {
        weekPage++;
        renderHistory();
      };
      el("btnExport").onclick = exportJSON;
      el("btnClearToday").onclick = clearToday;

      // Leader
      el("btnLeader").onclick = () => openOverlay("overlayLeader");
      el("leaderPrev").onclick = () => {
        leaderPage--;
        renderLeader();
      };
      el("leaderNext").onclick = () => {
        leaderPage++;
        renderLeader();
      };

      el("btnLeaderByAmt").onclick = () => {
        leaderMode = "amount";
        leaderPage = 0;
        renderLeader();
      };
      el("btnLeaderByLit").onclick = () => {
        leaderMode = "liters";
        leaderPage = 0;
        renderLeader();
      };
      el("btnLeaderByCount").onclick = () => {
        leaderMode = "count";
        leaderPage = 0;
        renderLeader();
      };

      // Settings
      el("btnSettings").onclick = () => openOverlay("overlaySettings");
      el("btnSaveSettings").onclick = () => {
        settings.cowBase = Number(el("setCowBase").value) || settings.cowBase;
        settings.cowFactor =
          Number(el("setCowFactor").value) || settings.cowFactor;
        settings.buffBase =
          Number(el("setBuffBase").value) || settings.buffBase;
        settings.buffFactor =
          Number(el("setBuffFactor").value) || settings.buffFactor;
        settings.qtyStep = Number(el("setQtyStep").value) || settings.qtyStep;
        settings.fatStep = Number(el("setFatStep").value) || settings.fatStep;
        settings.snfStep = Number(el("setSnfStep").value) || settings.snfStep;
        settings.sessionSwitchHour =
          Number(el("setSessionHour").value) || settings.sessionSwitchHour;
        saveSettings(settings);
        showToast("Settings saved");
        renderAll();
      };

      // Add farmer modal
      el("btnAddFarmerMain").onclick = () => openOverlay("overlayFarmer");
      el("btnCreateFarmer").onclick = () => {
        const f = {
          id: uid("f"),
          name: el("fName").value.trim(),
          phone: el("fPhone").value.trim(),
          address: el("fAddress").value.trim(),
          balance: Number(el("fBalance").value) || 0,
          active: el("fActive").value === "1",
        };
        if (!f.name) {
          showToast("Name required");
          return;
        }
        farmers.push(f);
        saveFarmers(farmers);
        selectedFarmerId = f.id;
        closeOverlay("overlayFarmer");
        renderAll();
      };

      // Close overlays
      document.querySelectorAll("[data-close]").forEach((b) => {
        b.onclick = () => closeOverlay(b.dataset.close);
      });
      //  A. AUTO FOCUS: Load hote hi search par cursor
      window.addEventListener("load", () => {
        if (el("searchInput")) el("searchInput").focus();
      });

      // 1. Translation Map
      const translations = {
        en: {
          station: "Milk Intake Station",
          history: "History",
          liters: "2. Liters (L)",
          fat: "3. Fat %",
          snf: "4. SNF",
          animal: "5. Animal Type",
          summary: "Summary",
          totalAmt: "TOTAL AMOUNT",
          oldBal: "OLD BALANCE",
          newBal: "NEW BALANCE",
          recent: "RECENT TODAY",
          save: "SAVE ENTRY",
          hold: "HOLD",
          undo: "UNDO",
        },
        hi: {
          station: "‡§¶‡•Ç‡§ß ‡§∏‡§Ç‡§ï‡§≤‡§® ‡§∏‡•ç‡§ü‡•á‡§∂‡§®",
          history: "‡§á‡§§‡§ø‡§π‡§æ‡§∏",
          liters: "2. ‡§≤‡•Ä‡§ü‡§∞ (L)",
          fat: "3. ‡§´‡•à‡§ü %",
          snf: "4. SNF",
          animal: "5. ‡§™‡§∂‡•Å ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞",
          summary: "‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂",
          totalAmt: "‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø",
          oldBal: "‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ",
          newBal: "‡§®‡§Ø‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ",
          recent: "‡§Ü‡§ú ‡§ï‡•á ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°",
          save: "‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç",
          hold: "‡§π‡•ã‡§≤‡•ç‡§° ‡§ï‡§∞‡•á‡§Ç",
          undo: "‡§µ‡§æ‡§™‡§∏ (Undo)",
        },
      };

      // 2. Language Toggle Function
      el("langSwitch").onclick = () => {
        currentLang = currentLang === "en" ? "hi" : "en";
        const t = translations[currentLang];
        const isHi = currentLang === "hi";

        // UI Elements Update (Ensure these IDs exist in your HTML)
        if (el("stationTitle")) el("stationTitle").textContent = t.station;
        if (el("btnHistoryMain"))
          el("btnHistoryMain").innerHTML = "üßæ " + t.history;

        // Inputs Section
        if (el("qtyLabel")) el("qtyLabel").textContent = t.liters; // HTML mein <div> ko id="qtyLabel" de dena
        if (el("fatLabel")) el("fatLabel").textContent = t.fat;
        if (el("snfLabel")) el("snfLabel").textContent = t.snf;

        // Summary Section
        if (el("summaryTitle")) el("summaryTitle").textContent = t.summary;
        if (el("amtLabel")) el("amtLabel").textContent = t.totalAmt;
        if (el("oldBalLabel")) el("oldBalLabel").textContent = t.oldBal;
        if (el("newBalLabel")) el("newBalLabel").textContent = t.newBal;
        if (el("recentTitle")) el("recentTitle").textContent = t.recent;

        // Footer Buttons
        if (el("btnSave"))
          el("btnSave").innerHTML = (isHi ? "üü¢ " : "") + t.save;
        if (el("btnHold"))
          el("btnHold").innerHTML =
            (isHi ? "üü° " : "") +
            t.hold +
            ' <span class="subnote">pause</span>';
        if (el("btnUndo"))
          el("btnUndo").innerHTML =
            (isHi ? "üî¥ " : "") + t.undo + ' <span class="subnote">last</span>';

        showToast(isHi ? "‡§≠‡§æ‡§∑‡§æ: ‡§π‡§ø‡§Ç‡§¶‡•Ä" : "Language: English");
      };
      // 1. Language Toggle Logic (Add this fresh)
      let currentLang = "en";

      el("langSwitch").onclick = () => {
        currentLang = currentLang === "en" ? "hi" : "en";
        const isHi = currentLang === "hi";

        // --- 1. Main Labels Update ---
        // (In IDs ko apne HTML tags mein check kar lena, agar nahi hain toh add kar lena)
        if (el("stationTitle"))
          el("stationTitle").textContent = isHi
            ? "‡§¶‡•Ç‡§ß ‡§∏‡§Ç‡§ï‡§≤‡§® ‡§∏‡•ç‡§ü‡•á‡§∂‡§®"
            : "Milk Intake Station";
        if (el("shopTitle"))
          el("shopTitle").textContent = isHi
            ? "‡§ó‡•ã‡§™‡§æ‡§≤ ‡§°‡•á‡§Ø‡§∞‡•Ä ‡§∂‡•â‡§™"
            : "Gopal Dairy Shop";

        // Labels for Inputs
        if (el("qtyLabel"))
          el("qtyLabel").textContent = isHi ? "2. ‡§≤‡•Ä‡§ü‡§∞ (L)" : "2. Liters (L)";
        if (el("fatLabel"))
          el("fatLabel").textContent = isHi ? "3. ‡§´‡•à‡§ü %" : "3. Fat %";
        if (el("snfLabel"))
          el("snfLabel").textContent = isHi ? "4. SNF" : "4. SNF";
        // --- 1. HISTORY MODAL ---
        if (el("historyTitle"))
          el("historyTitle").textContent = isHi
            ? "‡§á‡§§‡§ø‡§π‡§æ‡§∏ (‡§Ü‡§ú + ‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï)"
            : "History (Today + Weekly)";
        document.querySelectorAll("#overlayHistory h3")[0].textContent = isHi
          ? "üìÖ ‡§Ü‡§ú"
          : "üìÖ Today";
        document.querySelectorAll("#overlayHistory h3")[1].textContent = isHi
          ? "üóìÔ∏è ‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï"
          : "üóìÔ∏è Weekly";
        if (el("btnReceipt"))
          el("btnReceipt").innerHTML = isHi ? "üì© ‡§∞‡§∏‡•Ä‡§¶" : "üì© Receipt";
        if (el("btnExport"))
          el("btnExport").innerHTML = isHi ? "‚¨áÔ∏è ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü" : "‚¨áÔ∏è Export";
        if (el("btnClearToday"))
          el("btnClearToday").innerHTML = isHi
            ? "üóëÔ∏è ‡§Ü‡§ú ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç"
            : "üóëÔ∏è Clear Today";

        // --- 2. LEADERBOARD MODAL ---
        if (el("leaderTitle"))
          el("leaderTitle").textContent = isHi
            ? "üèÜ ‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï ‡§≤‡•Ä‡§°‡§∞"
            : "üèÜ Weekly Leader";
        document.querySelector("#overlayLeader h3").textContent = isHi
          ? "‡§ü‡•â‡§™ ‡§ï‡§ø‡§∏‡§æ‡§® (7 ‡§¶‡§ø‡§®)"
          : "Top Farmers (7 days)";
        if (el("btnLeaderByAmt"))
          el("btnLeaderByAmt").innerHTML = isHi ? "üí∞ ‡§∞‡§æ‡§∂‡§ø" : "üí∞ Amount";
        if (el("btnLeaderByLit"))
          el("btnLeaderByLit").innerHTML = isHi ? "ü•õ ‡§≤‡•Ä‡§ü‡§∞" : "ü•õ Liters";
        if (el("btnLeaderByCount"))
          el("btnLeaderByCount").innerHTML = isHi
            ? "üßæ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ"
            : "üßæ Entries";

        // --- 3. SETTINGS MODAL ---
        if (el("settingsTitle"))
          el("settingsTitle").textContent = isHi
            ? "‚öôÔ∏è ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏"
            : "‚öôÔ∏è Settings";
        document.querySelector("#overlaySettings h3").textContent = isHi
          ? "üí∞ ‡§∞‡•á‡§ü ‡§´‡§æ‡§∞‡•ç‡§Æ‡•Ç‡§≤‡§æ"
          : "üí∞ Rate Formula";
        /// --- Animal Selection Translation ---
        const animalOptionCow = document.querySelector('option[value="cow"]');
        const animalOptionBuff = document.querySelector(
          'option[value="buffalo"]',
        );

        if (animalOptionCow) {
          animalOptionCow.textContent = isHi ? "üêÑ ‡§ó‡§æ‡§Ø (Cow)" : "üêÑ Cow";
        }
        if (animalOptionBuff) {
          animalOptionBuff.textContent = isHi
            ? "üêÉ ‡§≠‡•à‡§Ç‡§∏ (Buffalo)"
            : "üêÉ Buffalo";
        }

        // Agar aapne Radio buttons laga liye hain (jo maine pehle bataya tha), toh ye use karein:
        if (el("labelCow"))
          el("labelCow").textContent = isHi ? "üêÑ ‡§ó‡§æ‡§Ø" : "üêÑ Cow";
        if (el("labelBuffalo"))
          el("labelBuffalo").textContent = isHi ? "üêÉ ‡§≠‡•à‡§Ç‡§∏" : "üêÉ Buffalo";

        if (el("btnSaveSettings"))
          el("btnSaveSettings").innerHTML = isHi ? "‚úÖ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç" : "‚úÖ Save";
        if (el("btnResetSettings"))
          el("btnResetSettings").innerHTML = isHi ? "‚ôªÔ∏è ‡§∞‡§ø‡§∏‡•á‡§ü" : "‚ôªÔ∏è Reset";
        if (el("btnFactoryReset"))
          el("btnFactoryReset").innerHTML = isHi
            ? "üß® ‡§´‡•à‡§ï‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§∞‡§ø‡§∏‡•á‡§ü"
            : "üß® Factory Reset";

        // --- 4. ADD FARMER MODAL ---
        if (el("addFarmerTitle"))
          el("addFarmerTitle").textContent = isHi
            ? "‚ûï ‡§ï‡§ø‡§∏‡§æ‡§® ‡§ú‡•ã‡•ú‡•á‡§Ç"
            : "‚ûï Add Farmer";
        document.querySelector("#overlayFarmer h3").textContent = isHi
          ? "üë§ ‡§ï‡§ø‡§∏‡§æ‡§® ‡§´‡•â‡§∞‡•ç‡§Æ"
          : "üë§ Farmer Form";
        const farmerLabels = document.querySelectorAll(
          "#overlayFarmer .field label",
        );
        const farmerHindi = [
          "üë§ ‡§®‡§æ‡§Æ",
          "üì± ‡§®‡§Ç‡§¨‡§∞",
          "üìç ‡§™‡§§‡§æ",
          "üñºÔ∏è ‡§´‡•ã‡§ü‡•ã",
          "‚Çπ ‡§ì‡§™‡§®‡§ø‡§Ç‡§ó ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏",
          "‡§∏‡•ç‡§ü‡•á‡§ü‡§∏",
        ];
        const farmerEng = [
          "üë§ Name",
          "üì± Number",
          "üìç Address",
          "üñºÔ∏è Image",
          "‚Çπ Opening Balance",
          "Status",
        ];
        farmerLabels.forEach(
          (lbl, i) => (lbl.textContent = isHi ? farmerHindi[i] : farmerEng[i]),
        );

        if (el("btnCreateFarmer"))
          el("btnCreateFarmer").innerHTML = isHi ? "‚úÖ ‡§¨‡§®‡§æ‡§è‡§Ç" : "‚úÖ Create";
        if (el("btnDemoFarmers"))
          el("btnDemoFarmers").innerHTML = isHi
            ? "üß™ ‡§°‡•á‡§Æ‡•ã ‡§ï‡§ø‡§∏‡§æ‡§®"
            : "üß™ Demo Farmers";

        // --- 5. RECEIPT MODAL ---
        if (el("receiptTitle"))
          el("receiptTitle").textContent = isHi ? "üì© ‡§∞‡§∏‡•Ä‡§¶" : "üì© Receipt";
        document.querySelector("#overlayReceipt h3").textContent = isHi
          ? "üßæ ‡§∏‡§Ç‡§¶‡•á‡§∂"
          : "üßæ Message";
        if (el("btnCopyReceipt"))
          el("btnCopyReceipt").innerHTML = isHi ? "üìã ‡§ï‡•â‡§™‡•Ä" : "üìã Copy";
        if (el("btnWhatsApp"))
          el("btnWhatsApp").innerHTML = isHi ? "üí¨ ‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™" : "üí¨ WhatsApp";
        if (el("btnCloseReceipt"))
          el("btnCloseReceipt").innerHTML = isHi ? "‚úÖ ‡§™‡•Ç‡§∞‡•ç‡§£" : "‚úÖ Done";

        // Summary Labels
        if (el("amtLabel"))
          el("amtLabel").textContent = isHi ? "‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø" : "TOTAL AMOUNT";
        if (el("oldBalLabel"))
          el("oldBalLabel").textContent = isHi ? "‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ" : "OLD BALANCE";
        if (el("newBalLabel"))
          el("newBalLabel").textContent = isHi ? "‡§®‡§Ø‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ" : "NEW BALANCE";
        if (el("recentTitle"))
          el("recentTitle").textContent = isHi
            ? "‡§Ü‡§ú ‡§ï‡•á ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°"
            : "RECENT TODAY";

        // --- 2. Buttons Update ---
        if (el("btnSave"))
          el("btnSave").innerHTML = isHi
            ? "üü¢ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç"
            : "üü¢ SAVE ENTRY";
        if (el("btnHold"))
          el("btnHold").innerHTML = isHi ? "üü° ‡§π‡•ã‡§≤‡•ç‡§° ‡§ï‡§∞‡•á‡§Ç" : "üü° HOLD";
        if (el("btnUndo"))
          el("btnUndo").innerHTML = isHi ? "üî¥ ‡§µ‡§æ‡§™‡§∏ (Undo)" : "üî¥ UNDO";

        // --- 3. Table Headers Update (Jo tune pucha tha) ---
        const ths = document.querySelectorAll("table thead th");
        if (ths.length >= 8) {
          const hindiHeaders = [
            "‡§§‡§æ‡§∞‡•Ä‡§ñ",
            "‡§ï‡§ø‡§∏‡§æ‡§®",
            "‡§∂‡§ø‡§´‡•ç‡§ü",
            "‡§™‡•ç‡§∞‡§ï‡§æ‡§∞",
            "‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ",
            "‡§´‡•à‡§ü",
            "SNF",
            "‡§∞‡§æ‡§∂‡§ø",
          ];
          const engHeaders = [
            "DATE",
            "FARMER",
            "SESSION",
            "TYPE",
            "QTY",
            "FAT",
            "SNF",
            "AMT",
          ];

          ths.forEach((th, i) => {
            th.textContent = isHi ? hindiHeaders[i] : engHeaders[i];
          });
        }

        showToast(isHi ? "‡§≠‡§æ‡§∑‡§æ: ‡§π‡§ø‡§Ç‡§¶‡•Ä" : "Language: English");
      };

      /***********************
       * INIT                *
       ***********************/
      function init() {
        restoreHoldIfAny();
        renderAll();
        timerInt = setInterval(() => {
          const sec = Math.floor((Date.now() - timerStart) / 1000);
          el("timerBox").textContent =
            `‚è± ${pad(Math.floor(sec / 60))}:${pad(sec % 60)}`;
        }, 1000);
      }

      init();
    </script>
  </body>
</html>
