<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Milk Intake Station UI - MilkRecord</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2563eb",
                        "primary-hover": "#1d4ed8",
                        "background-main": "#f8fafc","surface-white": "#ffffff",
                        "text-main": "#1e293b","text-secondary": "#64748b",
                        "border-subtle": "#e2e8f0",
                        "border-focus": "#2563eb",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    },
                    boxShadow: {
                        "soft": "0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)",
                        "tile": "0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025)",
                        "tile-hover": "0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02)",
                    }
                },
            },
        }
    </script>
    <style>
        /* Custom scrollbar for cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }.input-tile:focus-within {
            border-color: #2563eb;
            border-width: 3px;
            background-color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(37, 99, 235, 0.15), 0 8px 10px -6px rgba(37, 99, 235, 0.15);
            z-index: 10;
        }
        .input-tile {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body {
            background-color: #f8fafc;
            color: #1e293b;
        }
    </style>
</head>
<body class="bg-background-main font-display h-screen flex flex-col overflow-hidden text-text-main selection:bg-primary/20 selection:text-primary">
    <!-- Main Content - No Sidebar for Illiterate-First Design -->
    <main class="flex-1 overflow-y-auto">
        <!-- Header with minimal info -->
        <header class="flex items-center justify-between border-b border-solid border-[#dce3e5] dark:border-gray-800 bg-white dark:bg-background-dark px-6 py-4 sticky top-0 z-50">
            <div class="flex items-center gap-3">
                <div class="size-10 bg-primary flex items-center justify-center rounded-xl text-white shadow-lg shadow-primary/30">
                    <span class="material-symbols-outlined text-2xl">water_drop</span>
                </div>
                <div>
                    <h2 class="text-xl font-extrabold tracking-tight" id="dairyName">Gopal Dairy Shop</h2>
                    <p class="text-xs font-bold text-slate-500" id="currentDate">15 Jan 2025</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 rounded-xl px-3 py-2">
                    <span class="material-symbols-outlined text-amber-600">sync</span>
                    <span class="font-bold text-sm" id="syncStatus">QUARANTINED</span>
                    <span class="bg-amber-500 text-white rounded-full px-2 py-1 text-xs font-bold" id="pendingCount">0</span>
                </div>
                <div class="size-10 rounded-full bg-primary/20 border-2 border-primary overflow-hidden" data-alt="Profile avatar of the shop owner">
                    <img alt="Avatar" class="w-full h-full object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCuf9ughrQNq15i7W0rdKfeX2VJNw5EFzy88vVyJnbImfXeCFoifjQK32iOXC43bLNKrSVh1rORDFRqlRoHtIaWW1qkLnERMw_EuLbffucnGzayRUfM4NrqlcbeEjrhmRZoCR-MOwQiB3UyZz2TEI_PgdwQJCUsP-BgDqWhNQHfzBAmiAAuoOfXdTIf_gdDaq7cmHnkGTM2LLIsqAzfsHbyXfQu9OcSfsL2cnFdTc0Cq5NF4S40FP41OSzpCdX_bf3tUc0-1z3ZJw">
                </div>
            </div>
        </header>
        
        <!-- Content -->
        <div class="flex-1 p-8">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-10">
                    <div>
                        <h1 class="text-4xl font-black tracking-tight uppercase">Milk Intake Station</h1>
                        <p class="text-lg text-slate-500 dark:text-slate-400 mt-2">Record milk collections with automatic rate calculation.</p>
                    </div>
                    <div class="flex gap-3">
                        <button class="px-6 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl font-bold flex items-center gap-2 shadow-sm hover:bg-slate-50 transition-colors">
                            <span class="material-symbols-outlined">history</span>
                            History
                        </button>
                        <button class="px-6 py-3 bg-primary text-white rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-primary/20 hover:bg-primary/90 transition-colors">
                            <span class="material-symbols-outlined">add</span>
                            Today's Entries
                        </button>
                    </div>
                </div>
                
                <!-- Split Screen Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left Side: Input Fields -->
                    <div class="flex flex-col gap-8">
                        <!-- Farmer Selection Card -->
                        <div class="bg-surface-light dark:bg-surface-dark rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm p-6">
                            <div class="flex items-center justify-between gap-3 mb-4">
                                <div class="flex items-center gap-3">
                                    <span class="material-symbols-outlined text-2xl text-primary">person</span>
                                    <h3 class="text-xl font-bold">Select Farmer</h3>
                                </div>
                                <button 
                                    onclick="openAddFarmerModal()"
                                    class="px-4 py-2 bg-primary text-white rounded-lg font-bold flex items-center gap-1 shadow-sm hover:bg-primary/90 transition-colors"
                                >
                                    <span class="material-symbols-outlined text-sm">add</span>
                                    Add
                                </button>
                            </div>
                            <div class="flex gap-4">
                                <select 
                                    id="farmerSelect"
                                    required 
                                    class="flex-1 px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl font-bold focus:ring-2 focus:ring-primary"
                                    onchange="updateCalculatedAmount(); focusNextField(this, 'quantityInput')"
                                >
                                    <option value="">Select Farmer</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Quantity Input with Plus/Minus Controls -->
                        <div class="input-tile group relative flex flex-row items-stretch bg-surface-light dark:bg-surface-dark border border-border-subtle rounded-2xl h-40 shadow-tile">
                            <div class="w-32 bg-slate-50 dark:bg-slate-800 rounded-l-2xl flex items-center justify-center border-r border-border-subtle group-focus-within:bg-primary/10 group-focus-within:border-primary/20 transition-colors">
                                <span class="material-symbols-outlined text-7xl text-primary/80 group-focus-within:text-primary transition-colors">format_list_numbered</span>
                            </div>
                            <label class="flex-1 flex flex-col justify-center px-8 py-4 cursor-text relative">
                                <span class="absolute top-4 left-8 text-xs font-bold text-text-secondary uppercase tracking-widest opacity-50">1</span>
                                <div class="flex items-center gap-4">
                                    <button 
                                        type="button"
                                        class="h-16 w-16 rounded-full bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 flex items-center justify-center text-2xl font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                                        onclick="adjustQuantity(-0.5)"
                                    >
                                        -
                                    </button>
                                    <input 
                                        id="quantityInput"
                                        type="number" 
                                        step="0.01"
                                        required 
                                        class="flex-1 text-7xl font-bold text-text-main placeholder-slate-200 border-none focus:ring-0 p-0 bg-transparent leading-tight tracking-tight mt-2 text-center" 
                                        placeholder="00.0"
                                        oninput="updateCalculatedAmount(); focusNextFieldOnComplete(this, 'fatInput', 2)"
                                        onkeypress="handleInputKeypress(event, 'fatInput')"
                                    />
                                    <button 
                                        type="button"
                                        class="h-16 w-16 rounded-full bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 flex items-center justify-center text-2xl font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                                        onclick="adjustQuantity(0.5)"
                                    >
                                        +
                                    </button>
                                </div>
                            </label>
                            <div class="flex px-6 items-center border-l border-border-subtle">
                                <button 
                                    type="button"
                                    class="h-16 w-16 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 flex items-center justify-center group-focus-within:bg-primary group-focus-within:border-primary group-focus-within:shadow-lg transition-all hover:bg-slate-200 dark:hover:bg-slate-700"
                                    onclick="focusNextField('quantityInput', 'fatInput')"
                                >
                                    <span class="material-symbols-outlined text-4xl text-slate-400 dark:text-slate-400 group-focus-within:text-white">arrow_forward</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Fat Input with Plus/Minus Controls -->
                        <div class="input-tile group relative flex flex-row items-stretch bg-surface-light dark:bg-surface-dark border border-border-subtle rounded-2xl h-40 shadow-tile opacity-90 hover:opacity-100 focus-within:opacity-100 focus-within:ring-0">
                            <div class="w-32 bg-slate-50 dark:bg-slate-800 rounded-l-2xl flex items-center justify-center border-r border-border-subtle group-focus-within:bg-primary/10 group-focus-within:border-primary/20 transition-colors">
                                <span class="material-symbols-outlined text-7xl text-primary/80 group-focus-within:text-primary transition-colors">bolt</span>
                            </div>
                            <label class="flex-1 flex flex-col justify-center px-8 py-4 cursor-text relative">
                                <span class="absolute top-4 left-8 text-xs font-bold text-text-secondary uppercase tracking-widest opacity-50">2</span>
                                <div class="flex items-center gap-4">
                                    <button 
                                        type="button"
                                        class="h-16 w-16 rounded-full bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 flex items-center justify-center text-2xl font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                                        onclick="adjustFat(-0.1)"
                                    >
                                        -
                                    </button>
                                    <input 
                                        id="fatInput"
                                        type="number" 
                                        step="0.01"
                                        required 
                                        class="flex-1 text-7xl font-bold text-text-main placeholder-slate-200 border-none focus:ring-0 p-0 bg-transparent leading-tight tracking-tight mt-2 text-center" 
                                        placeholder="0.0"
                                        oninput="updateCalculatedAmount(); focusNextFieldOnComplete(this, 'animalTypeSelect', 2)"
                                        onkeypress="handleInputKeypress(event, 'animalTypeSelect')"
                                    />
                                    <button 
                                        type="button"
                                        class="h-16 w-16 rounded-full bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 flex items-center justify-center text-2xl font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                                        onclick="adjustFat(0.1)"
                                    >
                                        +
                                    </button>
                                </div>
                            </label>
                            <div class="flex px-6 items-center border-l border-border-subtle">
                                <button 
                                    type="button"
                                    class="h-16 w-16 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 flex items-center justify-center group-focus-within:bg-primary group-focus-within:border-primary group-focus-within:shadow-lg transition-all hover:bg-slate-200 dark:hover:bg-slate-700"
                                    onclick="focusNextField('fatInput', 'animalTypeSelect')"
                                >
                                    <span class="material-symbols-outlined text-4xl text-slate-400 dark:text-slate-400 group-focus-within:text-white">arrow_forward</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Animal Type Selection with Plus/Minus Controls -->
                        <div class="input-tile group relative flex flex-row items-stretch bg-surface-light dark:bg-surface-dark border border-border-subtle rounded-2xl h-40 shadow-tile opacity-90 hover:opacity-100 focus-within:opacity-100 focus-within:ring-0">
                            <div class="w-32 bg-slate-50 dark:bg-slate-800 rounded-l-2xl flex items-center justify-center border-r border-border-subtle group-focus-within:bg-primary/10 group-focus-within:border-primary/20 transition-colors">
                                <span class="material-symbols-outlined text-7xl text-primary/80 group-focus-within:text-primary transition-colors">water_drop</span>
                            </div>
                            <label class="flex-1 flex flex-col justify-center px-8 py-4 cursor-text relative">
                                <span class="absolute top-4 left-8 text-xs font-bold text-text-secondary uppercase tracking-widest opacity-50">3</span>
                                <div class="flex items-center gap-4">
                                    <button 
                                        type="button"
                                        class="h-16 w-16 rounded-full bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 flex items-center justify-center text-2xl font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                                        onclick="switchAnimalType('prev')"
                                    >
                                        -
                                    </button>
                                    <select 
                                        id="animalTypeSelect"
                                        required 
                                        class="flex-1 text-7xl font-bold text-text-main placeholder-slate-200 border-none focus:ring-0 p-0 bg-transparent leading-tight tracking-tight mt-2 text-center"
                                        onchange="focusNextField(this, 'manualRateInput')"
                                    >
                                        <option value="Cow">üêÑ Cow</option>
                                        <option value="Buffalo">üêÉ Buffalo</option>
                                    </select>
                                    <button 
                                        type="button"
                                        class="h-16 w-16 rounded-full bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 flex items-center justify-center text-2xl font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                                        onclick="switchAnimalType('next')"
                                    >
                                        +
                                    </button>
                                </div>
                            </label>
                            <div class="flex px-6 items-center border-l border-border-subtle">
                                <button 
                                    type="button"
                                    class="h-16 w-16 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 flex items-center justify-center group-focus-within:bg-primary group-focus-within:border-primary group-focus-within:shadow-lg transition-all hover:bg-slate-200 dark:hover:bg-slate-700"
                                    onclick="focusNextField('animalTypeSelect', 'manualRateInput')"
                                >
                                    <span class="material-symbols-outlined text-4xl text-slate-400 dark:text-slate-400 group-focus-within:text-white">arrow_forward</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Manual Rate Override with Plus/Minus Controls -->
                        <div class="input-tile group relative flex flex-row items-stretch bg-surface-light dark:bg-surface-dark border border-border-subtle rounded-2xl h-40 shadow-tile opacity-90 hover:opacity-100 focus-within:opacity-100 focus-within:ring-0">
                            <div class="w-32 bg-amber-50 dark:bg-amber-900/30 rounded-l-2xl flex items-center justify-center border-r border-border-subtle group-focus-within:bg-amber-100 group-focus-within:border-amber-200 transition-colors">
                                <span class="material-symbols-outlined text-7xl text-amber-600 group-focus-within:text-amber-700 transition-colors">edit_note</span>
                            </div>
                            <label class="flex-1 flex flex-col justify-center px-8 py-4 cursor-text relative">
                                <span class="absolute top-4 left-8 text-xs font-bold text-text-secondary uppercase tracking-widest opacity-50">4</span>
                                <div class="flex items-center gap-4">
                                    <button 
                                        type="button"
                                        class="h-16 w-16 rounded-full bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 flex items-center justify-center text-2xl font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                                        onclick="adjustRate(-1)"
                                    >
                                        -
                                    </button>
                                    <input 
                                        id="manualRateInput"
                                        type="number" 
                                        step="0.01"
                                        class="flex-1 text-7xl font-bold text-amber-600 placeholder-slate-200 border-none focus:ring-0 p-0 bg-transparent leading-tight tracking-tight mt-2 text-center" 
                                        placeholder="0.00"
                                        oninput="updateCalculatedAmount(); focusNextFieldOnComplete(this, 'recordEntryBtn', 3)"
                                        onkeypress="handleInputKeypress(event, 'recordEntryBtn')"
                                    />
                                    <button 
                                        type="button"
                                        class="h-16 w-16 rounded-full bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 flex items-center justify-center text-2xl font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                                        onclick="adjustRate(1)"
                                    >
                                        +
                                    </button>
                                </div>
                            </label>
                            <div class="flex px-6 items-center border-l border-border-subtle">
                                <button 
                                    type="button"
                                    id="recordEntryBtn"
                                    class="h-16 w-16 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 flex items-center justify-center group-focus-within:bg-amber-600 group-focus-within:border-amber-600 group-focus-within:shadow-lg transition-all hover:bg-slate-200 dark:hover:bg-slate-700"
                                    onclick="recordCollection()"
                                >
                                    <span class="material-symbols-outlined text-4xl text-slate-400 dark:text-slate-400 group-focus-within:text-white">arrow_forward</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex gap-4 mt-6">
                            <button 
                                onclick="undoLastEntry()" 
                                class="flex-1 py-6 bg-slate-100 hover:bg-slate-200 active:bg-slate-300 text-slate-700 rounded-3xl p-6 shadow-sm transition-all flex items-center justify-center gap-2 h-40"
                            >
                                <div class="flex flex-col items-center">
                                    <span class="material-symbols-outlined text-6xl mb-2">undo</span>
                                    <span class="text-sm font-bold uppercase tracking-wider">Undo Last Entry</span>
                                </div>
                            </button>
                            
                            <button 
                                onclick="holdCurrentEntry()" 
                                class="flex-1 py-6 bg-amber-100 hover:bg-amber-200 active:bg-amber-300 text-amber-700 rounded-3xl p-6 shadow-sm transition-all flex items-center justify-center gap-2 h-40"
                            >
                                <div class="flex flex-col items-center">
                                    <span class="material-symbols-outlined text-6xl mb-2">pause_circle</span>
                                    <span class="text-sm font-bold uppercase tracking-wider">Hold Entry</span>
                                </div>
                            </button>
                            
                            <button 
                                onclick="recordCollection()" 
                                class="flex-1 py-6 bg-emerald-500 hover:bg-emerald-600 active:bg-emerald-700 text-white rounded-3xl p-6 shadow-lg shadow-emerald-200 transition-all transform hover:-translate-y-1 flex items-center justify-center gap-2 h-40"
                            >
                                <div class="flex flex-col items-center">
                                    <span class="material-symbols-outlined text-6xl mb-2">done_all</span>
                                    <span class="text-sm font-bold uppercase tracking-wider">Save Entry</span>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Right Side: Calculation Display -->
                    <div class="flex flex-col gap-8">
                        <div class="relative bg-gradient-to-br from-primary to-blue-600 rounded-3xl p-8 text-white overflow-hidden group shadow-xl shadow-blue-200 flex flex-col items-center justify-center text-center h-40">
                            <div class="absolute inset-0 opacity-20 mix-blend-overlay" style="background-image: radial-gradient(#ffffff 1px, transparent 1px); background-size: 20px 20px;"></div>
                            <div class="absolute top-0 right-0 -mt-8 -mr-8 h-32 w-32 bg-white blur-3xl opacity-20 rounded-full group-hover:opacity-30 transition-opacity"></div>
                            <span class="material-symbols-outlined text-6xl mb-2 text-blue-100 opacity-80">currency_rupee</span>
                            <div class="relative z-10 flex items-baseline gap-1 justify-center w-full">
                                <span class="text-7xl lg:text-8xl font-bold tracking-tight text-white drop-shadow-sm leading-none" id="calculatedAmountDisplay">0.00</span>
                            </div>
                        </div>
                        
                        <div class="bg-surface-light dark:bg-surface-dark rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm p-6">
                            <h3 class="text-xl font-bold mb-4">Calculation Trail</h3>
                            <div class="text-3xl font-bold text-slate-700 dark:text-slate-300 mb-4" id="calculationTrail">0.0 L √ó 0.0% ‚Üí ‚Çπ0.00/L = ‚Çπ0.00</div>
                            <p class="text-sm text-slate-500 dark:text-slate-400" id="rateMethod">Rate: Base + Fat adjustment</p>
                        </div>
                        
                        <div class="bg-surface-light dark:bg-surface-dark rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm p-6">
                            <h3 class="text-xl font-bold mb-4">Farmer Balance</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="flex flex-col">
                                    <span class="text-sm font-bold text-slate-500 uppercase tracking-widest">Before</span>
                                    <span class="text-3xl font-black text-red-600" id="balanceBefore">‚Çπ0.00</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-sm font-bold text-slate-500 uppercase tracking-widest">After</span>
                                    <span class="text-3xl font-black text-emerald-600" id="balanceAfter">‚Çπ0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-surface-light dark:bg-surface-dark rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm">
                            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between">
                                <h3 class="text-xl font-bold">Recent Collections</h3>
                                <button class="text-sm font-bold text-primary hover:underline flex items-center gap-1">
                                    <span class="material-symbols-outlined text-xs">download</span>
                                    View All
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-slate-50/50 dark:bg-slate-900/50 text-slate-500 text-xs uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4 font-bold">Time</th>
                                            <th class="px-6 py-4 font-bold">Farmer</th>
                                            <th class="px-6 py-4 font-bold">Qty</th>
                                            <th class="px-6 py-4 font-bold">Fat%</th>
                                            <th class="px-6 py-4 font-bold text-right">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentCollections">
                                        <tr>
                                            <td colSpan="5" className="py-8 text-center text-slate-500">No collections recorded today</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="print:hidden text-center py-4 text-slate-500 text-sm border-t bg-slate-50">
        Designed by <span class="font-bold text-slate-700">signimus</span>
    </footer>

    <!-- Add Farmer Modal -->
    <div id="addFarmerModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold">Add New Farmer</h3>
                <button onclick="closeAddFarmerModal()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-500 mb-2">Farmer Name</label>
                    <input 
                        id="newFarmerName"
                        type="text" 
                        class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl font-bold focus:ring-2 focus:ring-primary" 
                        placeholder="Enter name"
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-slate-500 mb-2">Mobile Number</label>
                    <input 
                        id="newFarmerMobile"
                        type="tel" 
                        class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl font-bold focus:ring-2 focus:ring-primary" 
                        placeholder="Enter mobile"
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-slate-500 mb-2">Animal Type</label>
                    <select 
                        id="newFarmerType"
                        class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl font-bold focus:ring-2 focus:ring-primary"
                    >
                        <option value="Cow">Cow</option>
                        <option value="Buffalo">Buffalo</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-slate-500 mb-2">Address</label>
                    <input 
                        id="newFarmerAddress"
                        type="text" 
                        class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl font-bold focus:ring-2 focus:ring-primary" 
                        placeholder="Enter address"
                    />
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button 
                    onclick="closeAddFarmerModal()" 
                    class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold"
                >
                    Cancel
                </button>
                <button 
                    onclick="addNewFarmer()" 
                    class="flex-1 py-3 bg-primary hover:bg-primary/90 text-white rounded-xl font-bold"
                >
                    Save Farmer
                </button>
            </div>
        </div>
    </div>

    <script src="state.js"></script>
    <script src="db.js"></script>
    <script src="utils.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Update header information
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-IN');
        
        // Check authentication
        const session = sessionStorage.getItem('MilkRecord_session');
        if (!session) {
            window.location.href = 'index.html';
        }
        
        // Load state from localStorage
        const STORAGE_KEY = 'MilkRecord_data';
        const INITIAL_STATE = {
            auth: { 
                isAuthenticated: true, 
                user: { name: 'Ramesh Kumar', mobile: '9876543210', role: 'owner' },
                role: 'owner'
            },
            currentScreen: 'collection',
            dairyInfo: { 
                name: 'Gopal Dairy Shop', 
                owner: 'Ramesh Kumar', 
                mobile: '9876543210', 
                address: '', 
                rateType: 'Fat_SNF', 
                language: 'EN' 
            },
            farmers: [],
            milkEntries: [],
            rates: {
                cow: { base: 40, fatRef: 3.5, snfRef: 8.5 },
                buffalo: { base: 60, fatRef: 6.0, snfRef: 9.0 }
            },
            payments: [],
            sales: [],
            inventory: [],
            evidenceRecords: [], // For MilkLedger Transparent functionality
            settings: { 
                backupEnabled: true, 
                lastBackup: null, 
                printerName: 'Default',
                syncState: 'QUARANTINED', // 'QUARANTINED' | 'SYNCED'
                lastServerSync: null,
                pendingRecords: 0,
                lastSyncTime: null,
                localRecordsToday: 0
            }
        };
        
        let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || JSON.stringify(INITIAL_STATE));
        
        // Ensure state structure is correct
        if (!state.farmers) state.farmers = [];
        if (!state.milkEntries) state.milkEntries = [];
        if (!state.payments) state.payments = [];
        if (!state.sales) state.sales = [];
        if (!state.inventory) state.inventory = [];
        if (!state.evidenceRecords) state.evidenceRecords = [];
        if (!state.settings) state.settings = INITIAL_STATE.settings;
        
        // Update header info
        document.getElementById('dairyName').textContent = state.dairyInfo?.name || 'Milk Collection Center';
        document.getElementById('syncStatus').textContent = state.settings?.syncState || 'QUARANTINED';
        document.getElementById('pendingCount').textContent = state.settings?.pendingRecords || 0;
        
        // Auto-detect shift based on time of day
        const currentHour = new Date().getHours();
        let shift = 'Morning';
        if (currentHour >= 17 && currentHour <= 22) {
            shift = 'Evening';
        } else if (currentHour >= 5 && currentHour <= 11) {
            shift = 'Morning';
        }

        // Initialize Lucide icons if available
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Initialize state after all DOM elements are loaded
        let state;
        const STORAGE_KEY = 'MilkRecord_data';
        const INITIAL_STATE = {
            auth: {
                isAuthenticated: true,
                user: { name: 'Ramesh Kumar', mobile: '9876543210', role: 'owner' },
                role: 'owner'
            },
            currentScreen: 'collection',
            dairyInfo: {
                name: 'Gopal Dairy Shop',
                owner: 'Ramesh Kumar',
                mobile: '9876543210',
                address: '',
                rateType: 'Fat_SNF',
                language: 'EN'
            },
            farmers: [],
            milkEntries: [],
            rates: {
                cow: { base: 40, fatRef: 3.5, snfRef: 8.5 },
                buffalo: { base: 60, fatRef: 6.0, snfRef: 9.0 }
            },
            payments: [],
            sales: [],
            inventory: [],
            evidenceRecords: [], // For MilkLedger Transparent functionality
            settings: {
                backupEnabled: true,
                lastBackup: null,
                printerName: 'Default',
                syncState: 'QUARANTINED', // 'QUARANTINED' | 'SYNCED'
                lastServerSync: null,
                pendingRecords: 0,
                lastSyncTime: null,
                localRecordsToday: 0
            }
        };

        state = JSON.parse(localStorage.getItem(STORAGE_KEY) || JSON.stringify(INITIAL_STATE));

        // Ensure state structure is correct
        if (!state.farmers) state.farmers = [];
        if (!state.milkEntries) state.milkEntries = [];
        if (!state.payments) state.payments = [];
        if (!state.sales) state.sales = [];
        if (!state.inventory) state.inventory = [];
        if (!state.evidenceRecords) state.evidenceRecords = [];
        if (!state.settings) state.settings = INITIAL_STATE.settings;
        
        // Populate farmer dropdown
        const farmerSelect = document.getElementById('farmerSelect');
        if (farmerSelect) {
            farmerSelect.innerHTML = '<option value="">Select Farmer</option>';
            state.farmers.filter(f => f.active !== false).forEach(farmer => {
                const option = document.createElement('option');
                option.value = farmer.id;
                option.textContent = farmer.name;
                farmerSelect.appendChild(option);
            });
        }
        
        // Function to adjust quantity
        function adjustQuantity(change) {
            const qtyInput = document.getElementById('quantityInput');
            let currentValue = parseFloat(qtyInput.value) || 0;
            currentValue = Math.max(0, currentValue + change); // Prevent negative values
            qtyInput.value = currentValue.toFixed(2);
            updateCalculatedAmount();
        }
        
        // Function to adjust fat percentage
        function adjustFat(change) {
            const fatInput = document.getElementById('fatInput');
            let currentValue = parseFloat(fatInput.value) || 0;
            currentValue = Math.max(0, currentValue + change); // Prevent negative values
            fatInput.value = currentValue.toFixed(2);
            updateCalculatedAmount();
        }
        
        // Function to adjust rate
        function adjustRate(change) {
            const rateInput = document.getElementById('manualRateInput');
            let currentValue = parseFloat(rateInput.value) || 0;
            currentValue = Math.max(0, currentValue + change); // Prevent negative values
            rateInput.value = currentValue.toFixed(2);
            updateCalculatedAmount();
        }
        
        // Function to switch animal type
        function switchAnimalType(direction) {
            const animalSelect = document.getElementById('animalTypeSelect');
            const options = animalSelect.options;
            let currentIndex = animalSelect.selectedIndex;
            
            if (direction === 'next') {
                currentIndex = (currentIndex + 1) % options.length;
            } else if (direction === 'prev') {
                currentIndex = (currentIndex - 1 + options.length) % options.length;
            }
            
            animalSelect.selectedIndex = currentIndex;
            focusNextField('animalTypeSelect', 'manualRateInput');
        }
        
        // Focus next field function
        function focusNextField(currentFieldId, nextFieldId) {
            const currentField = typeof currentFieldId === 'string' ? document.getElementById(currentFieldId) : currentFieldId;
            const nextField = document.getElementById(nextFieldId);
            
            if (nextField) {
                nextField.focus();
                nextField.select && nextField.select();
            }
        }
        
        // Focus next field on complete function
        function focusNextFieldOnComplete(input, nextFieldId, minLength) {
            if (input.value.length >= minLength) {
                setTimeout(() => {
                    const nextField = document.getElementById(nextFieldId);
                    if (nextField) {
                        nextField.focus();
                        nextField.select && nextField.select();
                    }
                }, 100);
            }
        }
        
        // Handle input keypress function
        function handleInputKeypress(event, nextFieldId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const nextField = document.getElementById(nextFieldId);
                if (nextField) {
                    nextField.focus();
                    nextField.select && nextField.select();
                }
            }
        }
        
        // Update calculated amount when inputs change
        function updateCalculatedAmount() {
            const qty = parseFloat(document.getElementById('quantityInput').value) || 0;
            const fat = parseFloat(document.getElementById('fatInput').value) || 0;
            const snf = parseFloat(document.getElementById('snfInput').value) || 0;
            const manualRate = parseFloat(document.getElementById('manualRateInput').value) || null;
            const farmerId = document.getElementById('farmerSelect').value;
            
            if (qty > 0 && fat > 0 && farmerId) {
                let calculatedRate, amount;
                
                if (manualRate) {
                    // Use manual rate override
                    calculatedRate = manualRate;
                    amount = (qty * manualRate).toFixed(2);
                } else {
                    // Calculate automatically based on fat/SNF
                    const farmer = state.farmers.find(f => f.id === farmerId);
                    const type = farmer?.type || 'Cow'; // Default to Cow if not specified
                    
                    const calc = calculateMilkAmount(
                        qty,
                        fat,
                        snf,
                        state.dairyInfo.rateType,
                        state.rates,
                        type
                    );
                    calculatedRate = calc.rate;
                    amount = calc.amount;
                }
                
                // Update display
                document.getElementById('calculatedAmountDisplay').textContent = amount;
                
                // Update calculation trail
                const rateType = manualRate ? 'Manual Rate' : 'Auto-Calculated';
                document.getElementById('calculationTrail').textContent = `${qty.toFixed(1)} L √ó ${fat.toFixed(1)}% ‚Üí ‚Çπ${calculatedRate}/L = ‚Çπ${amount}`;
                document.getElementById('rateMethod').textContent = `Rate: ${rateType}`;
                
                // Update farmer balance display
                updateFarmerBalance(farmerId, amount);
            } else {
                document.getElementById('calculatedAmountDisplay').textContent = '0.00';
                document.getElementById('calculationTrail').textContent = '0.0 L √ó 0.0% ‚Üí ‚Çπ0.00/L = ‚Çπ0.00';
                document.getElementById('rateMethod').textContent = 'Rate: Base + Fat adjustment';
                document.getElementById('balanceBefore').textContent = '‚Çπ0.00';
                document.getElementById('balanceAfter').textContent = '‚Çπ0.00';
            }
        }
        
        // Calculate milk amount function
        function calculateMilkAmount(qty, fat, snf, rateType, rates, type) {
            const baseRate = type === 'Cow' ? rates.cow.base : rates.buffalo.base;
            const fatRef = type === 'Cow' ? rates.cow.fatRef : rates.buffalo.fatRef;
            const snfRef = type === 'Cow' ? rates.cow.snfRef : rates.buffalo.snfRef;

            let calculatedRate = Number(baseRate);
            if (rateType === 'Fat_SNF') {
                const fatDiff = (fat - fatRef) * 2;
                const snfDiff = (snf - snfRef) * 1.5;
                calculatedRate = Number(baseRate) + fatDiff + snfDiff;
            } else if (rateType === 'Fat') {
                calculatedRate = (baseRate / fatRef) * fat;
            }

            return {
                rate: Math.max(calculatedRate, 10).toFixed(2),
                amount: (qty * Math.max(calculatedRate, 10)).toFixed(2)
            };
        }
        
        // Update farmer balance function
        function updateFarmerBalance(farmerId, amount) {
            const farmer = state.farmers.find(f => f.id === farmerId);
            if (farmer) {
                // Calculate current balance based on previous entries
                const previousEntries = state.milkEntries.filter(e => e.farmerId === farmerId);
                const previousAmount = previousEntries.reduce((sum, entry) => sum + parseFloat(entry.amount || 0), 0);

                const payments = state.payments.filter(p => p.farmerId === farmerId && p.type === 'Payment');
                const paidAmount = payments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);

                const currentBalance = previousAmount - paidAmount;
                const newBalance = parseFloat(currentBalance) + parseFloat(amount || 0);

                document.getElementById('balanceBefore').textContent = `‚Çπ${currentBalance.toFixed(2)}`;
                document.getElementById('balanceAfter').textContent = `‚Çπ${newBalance.toFixed(2)}`;
            }
        }
        
        // Add new farmer function
        function addNewFarmer() {
            const form = {
                name: document.getElementById('newFarmerName').value,
                mobile: document.getElementById('newFarmerMobile').value,
                type: document.getElementById('newFarmerType').value,
                address: document.getElementById('newFarmerAddress').value,
                active: true,
                id: Date.now().toString(),
                createdAt: new Date().toISOString(),
                syncState: 'QUARANTINED', // Mark as quarantined until synced to server
                syncedAtServer: null,
                inputSource: 'keyboard',
                deviceId: navigator.userAgent,
                operatorId: state.auth.user?.id || 'current_user'
            };

            // Validate required fields
            if (!form.name || !form.mobile) {
                alert('Please enter farmer name and mobile number');
                return;
            }

            // Add to state
            state.farmers.push(form);
            localStorage.setItem('MilkRecord_data', JSON.stringify(state));

            // Update pending records count
            state.settings.pendingRecords = (state.settings.pendingRecords || 0) + 1;
            localStorage.setItem('MilkRecord_data', JSON.stringify(state));

            // Update pending count display
            document.getElementById('pendingCount').textContent = state.settings.pendingRecords;

            // Add to farmer dropdown
            const farmerSelect = document.getElementById('farmerSelect');
            if (farmerSelect) {
                const option = document.createElement('option');
                option.value = form.id;
                option.textContent = form.name;
                farmerSelect.appendChild(option);

                // Select the newly added farmer
                farmerSelect.value = form.id;
            }

            // Show notification
            alert(`‚úì Farmer ${form.name} added successfully with ID: #${form.id.substring(0, 4)}`);

            // Clear form
            document.getElementById('newFarmerName').value = '';
            document.getElementById('newFarmerMobile').value = '';
            document.getElementById('newFarmerAddress').value = '';

            // Close modal
            closeAddFarmerModal();

            // Update all farmer dropdowns across the application
            updateFarmerDropdowns(state);
        }
        
        // Update farmer dropdowns function
        function updateFarmerDropdowns(newState) {
            // Update dropdowns on current page if they exist
            const farmerDropdowns = document.querySelectorAll('select[id*="farmer"], select[id*="Farmer"], select[name*="farmer"], select[name*="Farmer"]');
            
            farmerDropdowns.forEach(dropdown => {
                // Save current selection if possible
                const currentSelection = dropdown.value;
                
                // Clear existing options except the first placeholder
                dropdown.innerHTML = '<option value="">Select Farmer</option>';
                
                // Add all active farmers
                (newState?.farmers || []).filter(f => f.active !== false).forEach(farmer => {
                    const option = document.createElement('option');
                    option.value = farmer.id;
                    option.textContent = farmer.name;
                    dropdown.appendChild(option);
                });
                
                // Restore previous selection if it still exists
                if (currentSelection) {
                    dropdown.value = currentSelection;
                }
            });
            
            // Also update farmer dropdowns in other open tabs/windows using storage event
            localStorage.setItem('MilkRecord_data', JSON.stringify(newState));
        }
        
        // Record collection function
        function recordCollection() {
            // Auto-detect shift based on time of day
            const currentHour = new Date().getHours();
            let detectedShift = 'Morning';
            if (currentHour >= 17 && currentHour <= 22) {
                detectedShift = 'Evening';
            } else if (currentHour >= 5 && currentHour <= 11) {
                detectedShift = 'Morning';
            }

            const form = {
                farmerId: document.getElementById('farmerSelect').value,
                date: new Date().toISOString().split('T')[0],
                shift: detectedShift, // Auto-detected from time
                type: document.getElementById('animalTypeSelect').value,
                qty: parseFloat(document.getElementById('quantityInput').value) || 0,
                fat: parseFloat(document.getElementById('fatInput').value) || 0,
                snf: parseFloat(document.getElementById('snfInput').value) || 0,
                manualRate: parseFloat(document.getElementById('manualRateInput').value) || null,
                syncState: 'QUARANTINED', // Mark as quarantined until synced to server
                createdAtLocal: new Date().toISOString(),
                syncedAtServer: null,
                isManual: true,
                inputSource: 'keyboard',
                deviceId: navigator.userAgent,
                operatorId: state.auth.user?.id || 'current_user',
                id: Date.now().toString()
            };
            
            // Validate required fields
            if (!form.farmerId || form.qty <= 0 || form.fat <= 0) {
                alert('Please fill all required fields');
                return;
            }
            
            // Calculate amount based on either manual rate or automatic calculation
            let calculatedRate, amount;
            if (form.manualRate) {
                // Use manual rate override
                calculatedRate = form.manualRate;
                amount = (form.qty * form.manualRate).toFixed(2);
            } else {
                // Calculate automatically based on fat/SNF
                const farmer = state.farmers.find(f => f.id === form.farmerId);
                const type = farmer?.type || 'Cow'; // Default to Cow if not specified
                
                const calc = calculateMilkAmount(
                    form.qty,
                    form.fat,
                    form.snf,
                    state.dairyInfo.rateType,
                    state.rates,
                    type
                );
                calculatedRate = calc.rate;
                amount = calc.amount;
            }
            
            const newEntry = {
                ...form,
                rate: calculatedRate,
                amount: amount
            };
            
            // Add to state
            state.milkEntries.push(newEntry);
            localStorage.setItem('MilkRecord_data', JSON.stringify(state));
            
            // Update pending records count
            state.settings.pendingRecords = (state.settings.pendingRecords || 0) + 1;
            localStorage.setItem('MilkRecord_data', JSON.stringify(state));
            
            // Update pending count display
            document.getElementById('pendingCount').textContent = state.settings.pendingRecords;
            
            // Show notification
            const farmer = state.farmers.find(f => f.id === form.farmerId);
            const rateType = form.manualRate ? '(Manual Rate)' : '(Auto-Calculated)';
            const calculatedRateValue = form.manualRate ? form.manualRate : calculateMilkAmount(form.qty, form.fat, form.snf, state.dairyInfo.rateType, state.rates, 'Cow').rate;
            alert(`‚úì Collection recorded for ${farmer?.name || 'Farmer'} - ${form.qty}L at ${form.fat}% fat. Rate: ‚Çπ${calculatedRateValue}/L ${rateType}. Amount: ‚Çπ${amount}`);
            
            // Reset form
            document.getElementById('quantityInput').value = '';
            document.getElementById('fatInput').value = '';
            document.getElementById('snfInput').value = '';
            document.getElementById('manualRateInput').value = '';
            
            // Update calculated amount display
            document.getElementById('calculatedAmountDisplay').textContent = '0.00';
            document.getElementById('calculationTrail').textContent = '0.0 L √ó 0.0% ‚Üí ‚Çπ0.00/L = ‚Çπ0.00';
            document.getElementById('rateMethod').textContent = 'Rate: Base + Fat adjustment';
            document.getElementById('balanceBefore').textContent = '‚Çπ0.00';
            document.getElementById('balanceAfter').textContent = '‚Çπ0.00';
            
            // Update all farmer dropdowns across the application
            updateFarmerDropdowns(state);
            
            // Update recent collections display
            updateRecentCollections();
        }
        
        // Undo last entry function
        function undoLastEntry() {
            if (state.milkEntries.length > 0) {
                const lastEntry = state.milkEntries.pop();
                localStorage.setItem('MilkRecord_data', JSON.stringify(state));
                
                // Update pending records count
                state.settings.pendingRecords = Math.max((state.settings.pendingRecords || 0) - 1, 0);
                localStorage.setItem('MilkRecord_data', JSON.stringify(state));
                
                // Update pending count display
                document.getElementById('pendingCount').textContent = state.settings.pendingRecords;
                
                const farmer = state.farmers.find(f => f.id === lastEntry?.farmerId);
                alert(`Last entry for ${farmer?.name || 'Farmer'} removed`);
                
                // Update recent collections display
                updateRecentCollections();
            } else {
                alert('No entries to undo');
            }
        }
        
        // Hold current entry function
        function holdCurrentEntry() {
            alert('Entry held temporarily. Will be saved when ready.');
        }
        
        // Update recent collections display
        function updateRecentCollections() {
            const today = new Date().toISOString().split('T')[0];
            const todayEntries = state.milkEntries.filter(e => e.date === today);

            const recentCollections = document.getElementById('recentCollections');
            if (recentCollections) {
                recentCollections.innerHTML = '';
                
                if (todayEntries.length > 0) {
                    todayEntries.slice(0, 10).forEach(entry => {
                        const farmer = state.farmers.find(f => f.id === entry.farmerId);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 font-bold text-slate-500">${entry.date}</td>
                            <td class="px-6 py-4 font-black">${farmer?.name || 'Unknown'}</td>
                            <td class="px-6 py-4 font-bold text-slate-500">${entry.qty} L</td>
                            <td class="px-6 py-4 font-bold text-amber-600">${entry.fat}%</td>
                            <td class="px-6 py-4 text-right font-bold text-blue-600">‚Çπ${entry.amount}</td>
                        `;
                        recentCollections.appendChild(row);
                    });
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colSpan="5" className="py-8 text-center text-slate-500">No collections recorded today</td>';
                    recentCollections.appendChild(row);
                }
            }
        }
        
        // Function to adjust quantity
        function adjustQuantity(change) {
            const qtyInput = document.getElementById('quantityInput');
            if (!qtyInput) {
                console.error('quantityInput element not found');
                return;
            }
            let currentValue = parseFloat(qtyInput.value) || 0;
            currentValue = Math.max(0, currentValue + change); // Prevent negative values
            qtyInput.value = currentValue.toFixed(2);
            updateCalculatedAmount();
        }

        // Function to adjust fat percentage
        function adjustFat(change) {
            const fatInput = document.getElementById('fatInput');
            if (!fatInput) {
                console.error('fatInput element not found');
                return;
            }
            let currentValue = parseFloat(fatInput.value) || 0;
            currentValue = Math.max(0, currentValue + change); // Prevent negative values
            fatInput.value = currentValue.toFixed(2);
            updateCalculatedAmount();
        }

        // Function to adjust rate
        function adjustRate(change) {
            const rateInput = document.getElementById('manualRateInput');
            if (!rateInput) {
                console.error('manualRateInput element not found');
                return;
            }
            let currentValue = parseFloat(rateInput.value) || 0;
            currentValue = Math.max(0, currentValue + change); // Prevent negative values
            rateInput.value = currentValue.toFixed(2);
            updateCalculatedAmount();
        }

        // Function to switch animal type
        function switchAnimalType(direction) {
            const animalSelect = document.getElementById('animalTypeSelect');
            const options = animalSelect.options;
            let currentIndex = animalSelect.selectedIndex;

            if (direction === 'next') {
                currentIndex = (currentIndex + 1) % options.length;
            } else if (direction === 'prev') {
                currentIndex = (currentIndex - 1 + options.length) % options.length;
            }

            animalSelect.selectedIndex = currentIndex;
            focusNextField('animalTypeSelect', 'manualRateInput');
        }

        // Focus next field function
        function focusNextField(currentFieldId, nextFieldId) {
            const currentField = typeof currentFieldId === 'string' ? document.getElementById(currentFieldId) : currentFieldId;
            const nextField = document.getElementById(nextFieldId);

            if (nextField) {
                nextField.focus();
                nextField.select && nextField.select();
            }
        }

        // Focus next field on complete function
        function focusNextFieldOnComplete(input, nextFieldId, minLength) {
            if (input.value.length >= minLength) {
                setTimeout(() => {
                    const nextField = document.getElementById(nextFieldId);
                    if (nextField) {
                        nextField.focus();
                        nextField.select && nextField.select();
                    }
                }, 100);
            }
        }

        // Handle input keypress function
        function handleInputKeypress(event, nextFieldId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const nextField = document.getElementById(nextFieldId);
                if (nextField) {
                    nextField.focus();
                    nextField.select && nextField.select();
                }
            }
        }

        // Update calculated amount function
        function updateCalculatedAmount() {
            const qtyInput = document.getElementById('quantityInput');
            const fatInput = document.getElementById('fatInput');
            const snfInput = document.getElementById('snfInput');
            const manualRateInput = document.getElementById('manualRateInput');
            const farmerSelect = document.getElementById('farmerSelect');
            const calculatedAmountDisplay = document.getElementById('calculatedAmountDisplay');
            const calculationTrail = document.getElementById('calculationTrail');
            const rateMethod = document.getElementById('rateMethod');
            const balanceBefore = document.getElementById('balanceBefore');
            const balanceAfter = document.getElementById('balanceAfter');

            if (!qtyInput || !fatInput || !farmerSelect || !calculatedAmountDisplay) {
                console.error('Required elements not found for calculation');
                return;
            }

            const qty = parseFloat(qtyInput.value) || 0;
            const fat = parseFloat(fatInput.value) || 0;
            const snf = parseFloat(snfInput?.value || 0);
            const manualRate = parseFloat(manualRateInput?.value || null);
            const farmerId = farmerSelect.value;

            if (qty > 0 && fat > 0 && farmerId) {
                let calculatedRate, amount;

                if (manualRate) {
                    // Use manual rate override
                    calculatedRate = manualRate;
                    amount = (qty * manualRate).toFixed(2);
                } else {
                    // Calculate automatically based on fat/SNF
                    const farmer = state.farmers.find(f => f.id === farmerId);
                    const type = farmer?.type || 'Cow'; // Default to Cow if not specified

                    const calc = calculateMilkAmount(
                        qty,
                        fat,
                        snf,
                        state.dairyInfo.rateType,
                        state.rates,
                        type
                    );
                    calculatedRate = calc.rate;
                    amount = calc.amount;
                }

                // Update display
                calculatedAmountDisplay.textContent = amount;

                // Update calculation trail
                const rateType = manualRate ? 'Manual Rate' : 'Auto-Calculated';
                calculationTrail.textContent = `${qty.toFixed(1)} L √ó ${fat.toFixed(1)}% ‚Üí ‚Çπ${calculatedRate}/L = ‚Çπ${amount}`;
                rateMethod.textContent = `Rate: ${rateType}`;

                // Update farmer balance display
                updateFarmerBalance(farmerId, amount);
            } else {
                calculatedAmountDisplay.textContent = '0.00';
                calculationTrail.textContent = '0.0 L √ó 0.0% ‚Üí ‚Çπ0.00/L = ‚Çπ0.00';
                rateMethod.textContent = 'Rate: Base + Fat adjustment';
                if (balanceBefore) balanceBefore.textContent = '‚Çπ0.00';
                if (balanceAfter) balanceAfter.textContent = '‚Çπ0.00';
            }
        }

        // Calculate milk amount function
        function calculateMilkAmount(qty, fat, snf, rateType, rates, type) {
            const baseRate = type === 'Cow' ? rates.cow.base : rates.buffalo.base;
            const fatRef = type === 'Cow' ? rates.cow.fatRef : rates.buffalo.fatRef;
            const snfRef = type === 'Cow' ? rates.cow.snfRef : rates.buffalo.snfRef;

            let calculatedRate = Number(baseRate);
            if (rateType === 'Fat_SNF') {
                const fatDiff = (fat - fatRef) * 2;
                const snfDiff = (snf - snfRef) * 1.5;
                calculatedRate = Number(baseRate) + fatDiff + snfDiff;
            } else if (rateType === 'Fat') {
                calculatedRate = (baseRate / fatRef) * fat;
            }

            return {
                rate: Math.max(calculatedRate, 10).toFixed(2),
                amount: (qty * Math.max(calculatedRate, 10)).toFixed(2)
            };
        }

        // Update farmer balance function
        function updateFarmerBalance(farmerId, amount) {
            const farmer = state.farmers.find(f => f.id === farmerId);
            if (farmer) {
                // Calculate current balance based on previous entries
                const previousEntries = state.milkEntries.filter(e => e.farmerId === farmerId);
                const previousAmount = previousEntries.reduce((sum, entry) => sum + parseFloat(entry.amount || 0), 0);

                const payments = state.payments.filter(p => p.farmerId === farmerId && p.type === 'Payment');
                const paidAmount = payments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);

                const currentBalance = previousAmount - paidAmount;
                const newBalance = parseFloat(currentBalance) + parseFloat(amount || 0);

                document.getElementById('balanceBefore').textContent = `‚Çπ${currentBalance.toFixed(2)}`;
                document.getElementById('balanceAfter').textContent = `‚Çπ${newBalance.toFixed(2)}`;
            }
        }

        // Record collection function
        function recordCollection() {
            // Auto-detect shift based on time of day
            const currentHour = new Date().getHours();
            let detectedShift = 'Morning';
            if (currentHour >= 17 && currentHour <= 22) {
                detectedShift = 'Evening';
            } else if (currentHour >= 5 && currentHour <= 11) {
                detectedShift = 'Morning';
            }

            const form = {
                farmerId: document.getElementById('farmerSelect').value,
                date: new Date().toISOString().split('T')[0],
                shift: detectedShift, // Auto-detected from time
                type: document.getElementById('animalTypeSelect').value,
                qty: parseFloat(document.getElementById('quantityInput').value) || 0,
                fat: parseFloat(document.getElementById('fatInput').value) || 0,
                snf: parseFloat(document.getElementById('snfInput').value) || 0,
                manualRate: parseFloat(document.getElementById('manualRateInput').value) || null,
                syncState: 'QUARANTINED', // Mark as quarantined until synced to server
                createdAtLocal: new Date().toISOString(),
                syncedAtServer: null,
                isManual: true,
                inputSource: 'keyboard',
                deviceId: navigator.userAgent,
                operatorId: state.auth.user?.id || 'current_user',
                id: Date.now().toString()
            };

            // Validate required fields
            if (!form.farmerId || form.qty <= 0 || form.fat <= 0) {
                alert('Please fill all required fields');
                return;
            }

            // Calculate amount based on either manual rate or automatic calculation
            let calculatedRate, amount;
            if (form.manualRate) {
                // Use manual rate override
                calculatedRate = form.manualRate;
                amount = (form.qty * form.manualRate).toFixed(2);
            } else {
                // Calculate automatically based on fat/SNF
                const farmer = state.farmers.find(f => f.id === form.farmerId);
                const type = farmer?.type || 'Cow'; // Default to Cow if not specified

                const calc = calculateMilkAmount(
                    form.qty,
                    form.fat,
                    form.snf,
                    state.dairyInfo.rateType,
                    state.rates,
                    type
                );
                calculatedRate = calc.rate;
                amount = calc.amount;
            }

            const newEntry = {
                ...form,
                rate: calculatedRate,
                amount: amount
            };

            // Add to state
            state.milkEntries.push(newEntry);
            localStorage.setItem('MilkRecord_data', JSON.stringify(state));

            // Update pending records count
            state.settings.pendingRecords = (state.settings.pendingRecords || 0) + 1;
            localStorage.setItem('MilkRecord_data', JSON.stringify(state));

            // Update pending count display
            document.getElementById('pendingCount').textContent = state.settings.pendingRecords;

            // Show notification
            const farmer = state.farmers.find(f => f.id === form.farmerId);
            const rateType = form.manualRate ? '(Manual Rate)' : '(Auto-Calculated)';
            const calculatedRateValue = form.manualRate ? form.manualRate : calculateMilkAmount(form.qty, form.fat, form.snf, state.dairyInfo.rateType, state.rates, 'Cow').rate;
            alert(`‚úì Collection recorded for ${farmer?.name || 'Farmer'} - ${form.qty}L at ${form.fat}% fat. Rate: ‚Çπ${calculatedRateValue}/L ${rateType}. Amount: ‚Çπ${amount}`);

            // Reset form
            document.getElementById('quantityInput').value = '';
            document.getElementById('fatInput').value = '';
            document.getElementById('snfInput').value = '';
            document.getElementById('manualRateInput').value = '';

            // Update calculated amount display
            document.getElementById('calculatedAmountDisplay').textContent = '0.00';
            document.getElementById('calculationTrail').textContent = '0.0 L √ó 0.0% ‚Üí ‚Çπ0.00/L = ‚Çπ0.00';
            document.getElementById('rateMethod').textContent = 'Rate: Base + Fat adjustment';
            document.getElementById('balanceBefore').textContent = '‚Çπ0.00';
            document.getElementById('balanceAfter').textContent = '‚Çπ0.00';

            // Update all farmer dropdowns across the application
            updateFarmerDropdowns(state);

            // Update recent collections display
            updateRecentCollections();
        }

        // Undo last entry function
        function undoLastEntry() {
            if (state.milkEntries.length > 0) {
                const lastEntry = state.milkEntries.pop();
                localStorage.setItem('MilkRecord_data', JSON.stringify(state));

                // Update pending records count
                state.settings.pendingRecords = Math.max((state.settings.pendingRecords || 0) - 1, 0);
                localStorage.setItem('MilkRecord_data', JSON.stringify(state));

                // Update pending count display
                document.getElementById('pendingCount').textContent = state.settings.pendingRecords;

                const farmer = state.farmers.find(f => f.id === lastEntry?.farmerId);
                alert(`Last entry for ${farmer?.name || 'Farmer'} removed`);

                // Update recent collections display
                updateRecentCollections();
            } else {
                alert('No entries to undo');
            }
        }

        // Hold current entry function
        function holdCurrentEntry() {
            alert('Entry held temporarily. Will be saved when ready.');
        }

        // Update farmer dropdowns function
        function updateFarmerDropdowns(newState) {
            // Update dropdowns on current page if they exist
            const farmerDropdowns = document.querySelectorAll('select[id*="farmer"], select[id*="Farmer"], select[name*="farmer"], select[name*="Farmer"]');

            farmerDropdowns.forEach(dropdown => {
                // Save current selection if possible
                const currentSelection = dropdown.value;

                // Clear existing options except the first placeholder
                dropdown.innerHTML = '<option value="">Select Farmer</option>';

                // Add all active farmers
                (newState?.farmers || []).filter(f => f.active !== false).forEach(farmer => {
                    const option = document.createElement('option');
                    option.value = farmer.id;
                    option.textContent = farmer.name;
                    dropdown.appendChild(option);
                });

                // Restore previous selection if it still exists
                if (currentSelection) {
                    dropdown.value = currentSelection;
                }
            });

            // Also update farmer dropdowns in other open tabs/windows using storage event
            localStorage.setItem('MilkRecord_data', JSON.stringify(newState));
        }

        // Update recent collections function
        function updateRecentCollections() {
            const today = new Date().toISOString().split('T')[0];
            const todayEntries = state.milkEntries.filter(e => e.date === today);

            const recentCollections = document.getElementById('recentCollections');
            if (recentCollections) {
                recentCollections.innerHTML = '';

                if (todayEntries.length > 0) {
                    todayEntries.slice(0, 10).forEach(entry => {
                        const farmer = state.farmers.find(f => f.id === entry.farmerId);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 font-bold text-slate-500">${entry.date}</td>
                            <td class="px-6 py-4 font-black">${farmer?.name || 'Unknown'}</td>
                            <td class="px-6 py-4 font-bold text-slate-500">${entry.qty} L</td>
                            <td class="px-6 py-4 font-bold text-amber-600">${entry.fat}%</td>
                            <td class="px-6 py-4 text-right font-bold text-blue-600">‚Çπ${entry.amount}</td>
                        `;
                        recentCollections.appendChild(row);
                    });
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colSpan="5" className="py-8 text-center text-slate-500">No collections recorded today</td>';
                    recentCollections.appendChild(row);
                }
            }
        }

        // Initial updates
        updateRecentCollections();

        // Update recent collections every 30 seconds
        setInterval(updateRecentCollections, 30000);
    </script>
</body>
</html>