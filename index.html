<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <style>
      :root {
        --bg: #f4f7fb;
        --panel: #ffffff;
        --line: #e5e7eb;
        --text: #0f172a;
        --muted: #64748b;

        --blue: #2563eb;
        --blue2: #1d4ed8;

        --green: #16a34a;
        --red: #dc2626;
        --yellow: #f59e0b;

        --soft-green: #ecfdf5;
        --soft-yellow: #fffbeb;
        --soft-blue: #eff6ff;
        --soft-pink: #fff1f2;

        --shadow: 0 12px 26px rgba(0, 0, 0, 0.08);
        --r: 18px;

        --tile: 78px;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
      }
      html, body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        position: fixed;
      }
      body {
        background: var(--bg);
        color: var(--text);
        touch-action: manipulation;
      }

      /* APP FRAME */
      .app {
        height: 100%;
        width: 100%;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 10px;
        padding: 8px;
        box-sizing: border-box;
      }

      /* HEADER */
      .topbar {
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 8px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 48px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 200px;
      }
      .logo {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg, #e0f2fe, #dbeafe);
        border: 1px solid #c7d2fe;
        font-weight: 1000;
      }
      .brand .title {
        font-weight: 1000;
        font-size: 16px;
        line-height: 1.1;
      }
      .brand .sub {
        font-weight: 800;
        color: var(--muted);
        font-size: 12px;
        margin-top: 2px;
      }
      .hdr-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .pillbtn {
        height: 44px;
        padding: 0 16px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 900;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
      }
      .pillbtn.primary {
        background: var(--blue);
        color: #fff;
        border-color: transparent;
      }
      .pillbtn.warn {
        background: #fbbf24;
        color: #78350f;
        border-color: transparent;
      }
      .pillbtn:active {
        transform: translateY(1px);
      }

      .hdr-right {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 14px;
      }
      .timer {
        height: 44px;
        padding: 0 14px;
        border-radius: 14px;
        border: 1px dashed #cbd5e1;
        background: #fff;
        font-weight: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 120px;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .iconbtn {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        font-size: 18px;
      }
      .iconbtn:active {
        transform: translateY(1px);
      }

      /* CORE - Desktop Default (Side by Side) */
      .core {
        height: 100%;
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 14px;
        overflow: hidden;
        min-height: 0;
        width: 100%;
      }

      /* Tablet (768px - 1024px): Side by side with adjusted heights */
      @media (min-width: 768px) and (max-width: 1024px) {
        .core {
          grid-template-columns: 1fr 1fr !important;
          gap: 10px;
        }
        .panel {
          max-height: calc(100vh - 160px);
          overflow-y: auto;
        }
        .actionBody {
          max-height: calc(100vh - 120px);
        }
        .trustBody {
          max-height: calc(100vh - 160px);
        }
      }

      /* Desktop (1024px+): Full side by side */
      @media (min-width: 1025px) {
        .core {
          grid-template-columns: 1fr 1fr !important;
        }
        .panel {
          max-height: calc(100vh - 180px);
          overflow-y: auto;
        }
      }

      /* Mobile: Stack panels vertically (portrait) */
      @media (max-width: 767px) {
        html, body {
          position: relative;
          overflow: auto;
          height: auto;
          min-height: 100%;
          width: 100%;
        }
        .app {
          padding: 8px;
          gap: 10px;
          height: auto;
          min-height: 100vh;
          display: flex;
          flex-direction: column;
        }
        .core {
          grid-template-columns: 1fr !important;
          grid-template-rows: auto auto;
          overflow-y: visible;
          height: auto;
          min-height: auto;
          gap: 10px;
          flex: 0 0 auto;
          display: flex;
          flex-direction: column;
        }
        .panel {
          max-height: none !important;
          height: auto;
          min-height: auto;
          border-radius: 16px;
          flex-shrink: 0;
        }
        .panelHeader {
          flex-wrap: wrap;
          gap: 8px;
        }
        .searchBox {
          order: 1;
          max-width: 100% !important;
          flex: 1 1 100%;
        }
        #btnAddFarmerMain {
          order: 2;
        }
        #farmerCount {
          order: 3;
        }
        .actionBody {
          max-height: none !important;
          overflow-y: visible !important;
          padding-right: 4px;
          height: auto;
        }
        .trustBody {
          overflow-y: visible !important;
          max-height: none !important;
          height: auto;
        }
        /* Compact inputs on mobile */
        .control {
          padding: 8px;
        }
        .numBig input {
          font-size: 24px;
        }
        .amountBox {
          padding: 15px;
        }
        .amountBox .amt {
          font-size: 42px;
        }
        /* Bottom buttons full width on mobile */
        .bottom {
          grid-template-columns: 1fr !important;
          gap: 8px;
          height: auto;
          flex-shrink: 0;
          position: sticky;
          bottom: 0;
          background: var(--bg);
          padding: 8px 0;
        }
        .panicBtn {
          height: 50px;
          font-size: 16px;
        }
      }

      /* Extra small mobile (320px - 480px) */
      @media (max-width: 480px) {
        .topbar {
          padding: 6px 8px;
        }
        .brand .title {
          font-size: 14px;
        }
        .pillbtn {
          height: 38px;
          padding: 0 10px;
          font-size: 11px;
        }
        .farmerGrid {
          grid-template-columns: repeat(2, 1fr) !important;
        }
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 22px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
        height: 100%;
      }
      .panelHeader {
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--line);
        font-weight: 1000;
        background: #fff;
      }
      .panelHeader small {
        color: var(--muted);
        font-weight: 900;
      }

      /* LEFT BODY */
      .actionBody {
        display: flex;
        flex-direction: column;
        gap: 16px;

        max-height: calc(100vh - 140px); /* header ke baad fit */
        overflow-y: auto; /* üëà MAIN SCROLL */
        padding-right: 6px;
      }

      /* FARMER PICK */
      .farmerPick {
        display: flex;
        flex-direction: column;
        gap: 12px; /* sabke beech gap */
      }

      .searchBox {
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #fff;
        padding: 6px 10px;
        height: 36px;
      }
      .searchBox input {
        width: 100%;
        border: none;
        outline: none;
        font-size: 14px;
        font-weight: 900;
        color: var(--text);
        background: transparent;
      }
      .addNewBtn {
        height: 36px;
        padding: 0 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #eef2ff;
        font-weight: 1000;
        cursor: pointer;
        font-size: 13px;
      }
      .miniTag {
        height: 36px;
        min-width: 70px;
        padding: 0 10px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 1000;
        color: var(--muted);
        font-size: 13px;
      }
      .farmerGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 8px;

        max-height: 200px;
        overflow-y: auto;
        padding-right: 6px;

        position: relative;
      }

      .fcard {
        height: 60px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #fff;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }
      .fcard:active {
        transform: translateY(1px);
      }
      .fimg {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: #f1f5f9;
        border: 1px solid var(--line);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex: 0 0 auto;
        overflow: hidden;
      }
      .fimg img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .fname {
        font-weight: 1000;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
      }
      .fsub {
        color: var(--muted);
        font-weight: 900;
        font-size: 11px;
        margin-top: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 210px;
      }
      .editFarmerBtn {
        opacity: 0;
        transition: opacity 0.2s;
      }
      .fcard:hover .editFarmerBtn {
        opacity: 0.7;
      }
      .editFarmerBtn:hover {
        opacity: 1 !important;
      }
      .fsel {
        outline: 3px solid rgba(22, 163, 74, 0.45);
        box-shadow: 0 0 0 6px rgba(22, 163, 74, 0.1);
      }
      .badge {
        position: absolute;
        right: 8px;
        top: 8px;
        padding: 6px 8px;
        border-radius: 12px;
        background: rgba(22, 163, 74, 0.12);
        border: 1px solid rgba(22, 163, 74, 0.25);
        font-weight: 1000;
        color: #166534;
        font-size: 12px;
      }
      .farmerNav {
        display: flex;
        justify-content: center;
        gap: 10px;
      }

      .navBtn {
        width: 48%;
        height: 44px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1000;
        cursor: pointer;
      }
      .navBtn:active {
        transform: translateY(1px);
      }
      .navBtn[disabled] {
        opacity: 0.45;
        cursor: not-allowed;
      }

      /* INPUTS GRID */
      .inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .control {
        border-radius: 18px;
        border: 1px solid var(--line);
        padding: 12px;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 10px;
        min-height: 154px;
      }
      .control.green {
        background: var(--soft-green);
      }
      .control.yellow {
        background: var(--soft-yellow);
      }
      .control.blue {
        background: var(--soft-blue);
      }
      .ctrlTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 1000;
      }
      .ctrlTop .muted {
        color: var(--muted);
        font-weight: 900;
      }
      .numBig {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 44px;
        font-weight: 1100;
        letter-spacing: 0.3px;
        color: #334155;
      }

      .numInput {
        width: 100%;
        text-align: center;
        font-size: 44px;
        font-weight: 1100;
        border: none;
        outline: none;
        background: transparent;
        color: #334155;
      }
      .numInput::-webkit-outer-spin-button,
      .numInput::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .pmRow {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .pm {
        height: 50px;
        border: none;
        border-radius: 16px;
        background: #fff;
        border: 1px solid var(--line);
        font-size: 26px;
        font-weight: 1100;
        cursor: pointer;
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.06);
      }
      .pm:active {
        transform: translateY(1px);
      }

      /* ANIMAL + RATE MODE ROW */
      .row3 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .animalCard {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 18px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 96px;
      }
      .animalCard label {
        font-weight: 1000;
        color: var(--muted);
        font-size: 12px;
        letter-spacing: 0.3px;
      }
      .animalCard select {
        height: 52px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1000;
        font-size: 16px;
        padding: 0 12px;
        outline: none;
      }

      .rateCard {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 18px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 96px;
      }
      .modeRow {
        display: flex;
        gap: 10px;
      }
      .modeBtn {
        flex: 1;
        height: 52px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #f1f5f9;
        font-weight: 1100;
        cursor: pointer;
      }
      .modeBtn.active {
        background: #fef3c7;
        border-color: #fcd34d;
      }
      .modeBtn:active {
        transform: translateY(1px);
      }

      /* MANUAL RATE OVERRIDE */
      .manualOverride {
        border: 2px dashed #cbd5e1;
        background: #f8fafc;
        border-radius: 18px;
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .manualOverride .left {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 1000;
        color: var(--muted);
      }
      .manualRateRow {
        display: none;
        gap: 10px;
        grid-template-columns: 1fr auto;
        align-items: center;
      }
      .manualRateRow input {
        height: 52px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
        font-size: 20px;
        padding: 0 12px;
        outline: none;
        width: 220px;
      }
      .manualRateRow button {
        height: 52px;
        width: 68px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
        cursor: pointer;
      }

      /* RIGHT BODY */
      .trustBody {
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 14px;
        overflow-y: auto;
        max-height: calc(100vh - 180px);
      }
      .amountBox {
        background: linear-gradient(180deg, var(--blue), var(--blue2));
        border-radius: 26px;
        padding: 22px;
        color: #fff;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }
      .amountBox .label {
        opacity: 0.8;
        font-weight: 1000;
        letter-spacing: 0.3px;
        font-size: 12px;
      }
      .amountBox .amt {
        font-size: 66px;
        font-weight: 1200;
        line-height: 1;
        margin-top: 10px;
        letter-spacing: 0.5px;
      }
      .amountBox .sub {
        margin-top: 12px;
        display: inline-flex;
        gap: 10px;
        align-items: center;
        padding: 10px 14px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.15);
        font-weight: 1000;
      }

      .balances {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      
      .balCard {
        border-radius: 18px;
        padding: 16px;
        border: 1px solid var(--line);
        font-weight: 1100;
      }
      .balCard .t {
        font-size: 12px;
        font-weight: 1000;
        color: var(--muted);
      }
      .balCard .v {
        font-size: 26px;
        font-weight: 1200;
        margin-top: 6px;
      }
      .balOld {
        background: var(--soft-pink);
        color: #991b1b;
      }
      .balNew {
        background: var(--soft-green);
        color: #166534;
      }

      .recent {
        border: 1px solid var(--line);
        border-radius: 18px;
        background: #fff;
        overflow: hidden;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }
      .recentHead {
        padding: 12px 14px;
        border-bottom: 1px solid var(--line);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 1100;
      }
      .recentHead .muted {
        color: var(--muted);
        font-weight: 1000;
        font-size: 12px;
      }
      .tableWrap {
        padding: 10px 14px 14px;
        min-height: 0;
        overflow: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        border-bottom: 1px solid var(--line);
        padding: 10px 6px;
        text-align: left;
        vertical-align: middle;
        white-space: nowrap;
      }
      th {
        color: var(--muted);
        font-weight: 1100;
        font-size: 12px;
      }
      tr:last-child td {
        border-bottom: none;
      }
      .tag {
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 1000;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .tag.cow {
        background: #dbeafe;
        color: #1d4ed8;
      }
      .tag.buff {
        background: #ede9fe;
        color: #6d28d9;
      }
      .rtag {
        padding: 5px 8px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #f8fafc;
        font-weight: 1100;
        font-size: 12px;
        color: var(--muted);
      }

      /* FOOTER BUTTONS */
      .bottom {
        display: grid;
        grid-template-columns: 1fr 1.4fr 1fr;
        gap: 12px;
        height: 96px;
      }
      .panicBtn {
        border: none;
        border-radius: 22px;
        font-size: 22px;
        font-weight: 1200;
        cursor: pointer;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        letter-spacing: 0.3px;
      }
      .panicBtn:active {
        transform: translateY(1px);
      }
      .hold {
        background: #fde68a;
        color: #78350f;
      }
      .save {
        background: #22c55e;
        color: #064e3b;
        font-size: 30px;
      }
      .undo {
        background: #fecaca;
        color: #7f1d1d;
      }
      .subnote {
        font-size: 12px;
        font-weight: 1100;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.06);
      }

      /* TOAST */
      .toast {
        position: fixed;
        left: 50%;
        bottom: 116px;
        transform: translateX(-50%);
        background: rgba(15, 23, 42, 0.92);
        color: #fff;
        padding: 12px 14px;
        border-radius: 16px;
        font-weight: 1100;
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.22);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.18s ease;
        max-width: 92vw;
        text-align: center;
        z-index: 70;
      }
      .toast.show {
        opacity: 1;
      }

      /* MODALS */
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 14px;
        z-index: 60;
      }
      .modal {
        width: min(980px, 98vw);
        height: min(640px, 92vh);
        border-radius: 22px;
        border: 1px solid var(--line);
        background: #fff;
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
        overflow: hidden;
        display: grid;
        grid-template-rows: 62px 1fr 72px;
      }
      .modalHead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-bottom: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
      }
      .modalHead .left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .closeBtn {
        width: 52px;
        height: 52px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        cursor: pointer;
        font-size: 18px;
        font-weight: 1100;
      }
      .modalBody {
        padding: 12px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        min-height: 0;
        overflow-y: auto;
      }
      .modalBody.onecol {
        grid-template-columns: 1fr;
        overflow-y: auto;
      }
      .modalCol {
        border: 1px solid var(--line);
        border-radius: 18px;
        background: #f8fafc;
        padding: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      .modalCol h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        font-weight: 1200;
        color: #0f172a;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .listArea {
        flex: 1;
        min-height: 0;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 10px;
      }
      .pageInfo {
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: var(--muted);
        font-weight: 1000;
        font-size: 12px;
      }
      .pageBtns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .pageBtns button {
        height: 50px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
        cursor: pointer;
      }
      .pageBtns button[disabled] {
        opacity: 0.45;
        cursor: not-allowed;
      }
      .cardRow {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 16px;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        min-height: 64px;
      }
      .cardRow .title {
        font-weight: 1200;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 70%;
      }
      .cardRow .meta {
        color: var(--muted);
        font-weight: 1000;
        font-size: 12px;
        margin-top: 4px;
      }
      .cardRow .val {
        font-weight: 1200;
        font-size: 14px;
        white-space: nowrap;
        color: #0f172a;
      }

      .modalFoot {
        padding: 10px 12px;
        border-top: 1px solid var(--line);
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        background: #fff;
      }
      .footBtn {
        height: 50px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
        cursor: pointer;
        padding: 0 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .footBtn.good {
        background: #dcfce7;
        border-color: #bbf7d0;
        color: #14532d;
      }
      .footBtn.warn {
        background: #fef3c7;
        border-color: #fde68a;
        color: #78350f;
      }
      .footBtn.bad {
        background: #fee2e2;
        border-color: #fecaca;
        color: #7f1d1d;
      }

      /* Center Summary Cards */
      .center-summary-card {
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 18px;
        padding: 20px;
      }
      .center-summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--line);
      }
      .center-summary-title {
        font-size: 18px;
        font-weight: 1100;
        color: #0f172a;
      }
      .center-summary-date {
        font-size: 13px;
        color: var(--muted);
        font-weight: 700;
      }
      .center-summary-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }
      .center-summary-stat {
        background: #f8fafc;
        border-radius: 12px;
        padding: 15px;
        text-align: center;
      }
      .center-summary-stat-label {
        font-size: 11px;
        color: var(--muted);
        font-weight: 700;
        margin-bottom: 8px;
      }
      .center-summary-stat-value {
        font-size: 24px;
        font-weight: 1200;
        color: #0f172a;
      }
      .dispatch-action {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .dispatch-action-btn {
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 12px;
        padding: 14px;
        font-weight: 700;
        cursor: pointer;
      }
      .whatsapp-share-btn {
        background: #25D366;
        color: white;
        border: none;
        border-radius: 12px;
        padding: 14px;
        font-weight: 700;
        cursor: pointer;
      }

      /* FORMS */
      .formGrid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .field {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 12px;
        padding: 6px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .field label {
        color: var(--muted);
        font-weight: 1100;
        font-size: 11px;
        letter-spacing: 0.3px;
      }
      .field input,
      .field textarea,
      .field select {
        border: none;
        outline: none;
        background: transparent;
        color: var(--text);
        font-size: 14px;
        font-weight: 1100;
        resize: none;
        padding: 8px;
      }
      .field textarea {
        min-height: 60px;
      }
      .field.full {
        grid-column: 1/-1;
      }

      .receiptBox {
        border: 2px dashed #cbd5e1;
        background: #fff;
        border-radius: 18px;
        padding: 12px;
        font-weight: 1100;
        line-height: 1.35;
        white-space: pre-wrap;
        min-height: 0;
        color: #0f172a;
      }

      /* Small screens */
      @media (max-width: 980px) {
        body {
          overflow: auto;
        } /* allow in small */
        .app {
          overflow: auto;
          height: auto;
          min-height: 100%;
        }
        .core {
          grid-template-columns: 1fr;
        }
        .bottom {
          grid-template-columns: 1fr 1fr 1fr;
        }
        .save {
          font-size: 22px;
        }
        .modalBody {
          grid-template-columns: 1fr;
        }
        .amountBox .amt {
          font-size: 54px;
        }
        .manualRateRow input {
          width: 100%;
        }
      }
      /* 1. Main Screen aur Form ke sabhi bade dabbe (Boxes) */
.field:focus-within, .fcard:focus {
    outline: none !important;
    /* background-color: #fff9c4 !important; Mast Peela Background */
    border: 3px solid #000000 !important; /* Moti Kaali Border */
    box-shadow: 0 6px 15px rgba(0,0,0,0.2) !important; /* Halka shadow taaki box utha hua dikhe */
    transition: all 0.15s ease-in-out;
    transform: translateY(-2px); /* Box thoda upar uthega focus hone par */
}

/* 2. Farmer Card (Kisan ka dabba) jab keyboard se select ho */
.fcard:focus {
    /* background-color: #fff9c4 !important; */
    border: 3px solid #000000 !important;
}

/* 3. Andar ke input boxes ko clean rakhein taaki background poora dikhe */
.field:focus-within input, 
.field:focus-within textarea, 
.field:focus-within select {
    background: transparent !important;
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
}
/* Entry Save hone par Green Flash effect */
.flash-success {
    animation: flashGreen 0.6s ease-out;
}

@keyframes flashGreen {
    0% { background-color: transparent; }
    30% { background-color: rgba(37, 211, 102, 0.4); } /* WhatsApp Green color */
    100% { background-color: transparent; }
}
/* Edit Button Style in Table */
.edit-btn {
    padding: 4px 8px;
    background: #f1f5f9;
    border: 1px solid var(--line);
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    margin-left: 8px;
    transition: all 0.2s;
}
.edit-btn:hover { background: #e2e8f0; }

/* Edit Note Style */
.edit-note {
    font-size: 10px;
    color: var(--muted);
    font-style: italic;
    display: block;
    margin-top: 2px;
}
.hdr-actions { display: flex; align-items: center; gap: 10px; }
/* Right Panel ko scrollable banane ke liye */
.panel:has(.trustBody) {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.trustBody {
    flex: 1;
    overflow-y: auto; /* üëà Right panel mein scroll add ho jayega */
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* Har section ka size fix rahega */
.amountBox, .balances, #dailySummaryWrapper, .recent, #eodSnapshot, .pay-mode-container {
    flex-shrink: 0; 
}

/* Table area thoda chota rakhenge taaki baki cheezein dikhein */
.tableWrap {
    max-height: 200px;
    overflow-y: auto;
}
.orange-dot {
    height: 8px; width: 8px; background-color: #f97316;
    border-radius: 50%; display: inline-block; margin-left: 5px;
    box-shadow: 0 0 5px #f97316;
}
    </style>
  </head>
  <div class="overlay" id="overlayFarmerDetail">
  <div class="modal" style="height: auto; align-self: flex-end; border-bottom-left-radius: 0; border-bottom-right-radius: 0;">
    <div class="modalHead">
      <div class="left">
        <button class="closeBtn" data-close="overlayFarmerDetail">‚úñ</button>
        <div id="detailFarmerName" style="font-weight: 1200;">Farmer Name</div>
      </div>
      <div class="muted">Advance Management</div>
    </div>
    <div class="modalBody onecol" style="padding: 20px;">
        <div class="balances" style="margin-bottom: 15px;">
            <div class="balCard balNew" style="background:#eff6ff; color:#1e40af;">
                <div style="font-size:12px;">TOTAL MILK (MONTH)</div>
                <div class="v" id="detailMonthlyMilk">0.0 L</div>
            </div>
            <div class="balCard balOld" style="background:#fff7ed; color:#9a3412;">
                <div style="font-size:12px;">CURRENT ADVANCE</div>
                <div class="v" id="detailAdvance">‚Çπ0.00</div>
            </div>
        </div>
        <div class="formGrid">
            <div class="field">
                <label>Amount (‚Çπ)</label>
                <input id="advAmount" type="number" placeholder="Enter Amount" class="numInput" style="font-size: 24px; text-align: left;">
            </div>
            <div class="field">
                <label>Action</label>
                <div class="modeRow" style="gap: 10px;">
                    <button class="footBtn good" id="btnAddAdv" style="flex:1; height: 50px;">‚ûï Give</button>
                    <button class="footBtn bad" id="btnCutAdv" style="flex:1; height: 50px;">‚ûñ Cut</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modalFoot">
        <button class="pillbtn primary" id="btnDetailWhatsApp" style="width:100%; justify-content: center;">üí¨ Send Monthly Summary</button>
    </div>
  </div>
</div>
  <body>
    <div class="app">
      <!-- HEADER -->
      <div class="topbar">
        <div class="brand">
          <div class="logo">
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="20" cy="20" r="18" fill="#3B82F6" opacity="0.1"/>
              <path d="M20 8C20 8 12 18 12 24C12 28.4 15.6 32 20 32C24.4 32 28 28.4 28 24C28 18 20 8 20 8Z" fill="#3B82F6"/>
              <circle cx="20" cy="24" r="6" fill="white" opacity="0.3"/>
            </svg>
          </div>
          <div>
            <div class="title" id="shopTitle">Gopal Dairy Shop</div>
            <div class="sub" id="todayLabel">‚Äî</div>
          </div>
        </div>
        <div class="hdr-actions" style="flex: 1; justify-content: flex-end;">
          <!-- Switch to POS -->
          <button class="pillbtn primary" onclick="location.href='pos-demo.html'" style="background:#2563eb; border-color:#2563eb;">
            üõí POS
          </button>

          <!-- Booth/Collection Point Selector -->
          <div style="display: flex; flex-direction: column; margin: 0 10px;">
            <label style="font-size: 11px; font-weight: 700; color: var(--muted); margin-bottom: 4px;">Booth:</label>
            <select id="collectionPointSelect" onchange="updateCollectionPoint()" style="padding: 8px 12px; border: 1px solid var(--line); border-radius: 8px; font-weight: 700; font-size: 13px; min-width: 180px; background: white;">
              <option value="DEFAULT">Default Booth</option>
              <option value="VILLAGE_A">Village A Booth</option>
              <option value="VILLAGE_B">Village B Booth</option>
              <option value="VILLAGE_C">Village C Booth</option>
              <option value="MAIN_MARKET">Main Market Booth</option>
              <option value="GANDHI_CHOWK">Gandhi Chowk Booth</option>
            </select>
          </div>

          <!-- Hardware Indicator -->
          <div style="font-size: 12px; font-weight: 900; color: #64748b; display: flex; align-items: center; gap: 4px; margin: 0 10px; white-space: nowrap;">
            <span style="color: #9ca3af;">‚óè</span> Reading: Manual
          </div>

          <!-- Rate Pill Container -->
          <div id="ratePillContainer" style="display: flex; align-items: center; gap: 8px; margin: 0 10px;">
    <div id="ratePill" onclick="openRateEditor()" style="background: #e3f2fd; color: #1565c0; padding: 8px 16px; border-radius: 999px; font-weight: 1000; cursor: pointer; border: 1px solid #bbdefb; font-size: 14px; display: flex; align-items: center; gap: 6px;">
        <span id="rateDisplay">Rate: ‚Çπ0.00</span>
        <span style="font-size: 10px; opacity: 0.6;">‚úèÔ∏è</span>
    </div>

    <div id="rateEditor" style="display: none; align-items: center; gap: 8px; background: #fff; padding: 4px; border-radius: 12px; border: 1px solid var(--blue); box-shadow: var(--shadow);">
        <input id="newRateInput" type="number" step="0.1" style="width: 80px; border: none; outline: none; font-weight: bold; padding: 4px 8px; font-size: 16px;" placeholder="‚Çπ0.00">
        <button onclick="updateActiveRate()" style="background: var(--blue); color: #fff; border: none; border-radius: 8px; padding: 6px 10px; cursor: pointer; font-weight: bold;">Set</button>
        <button onclick="closeRateEditor()" style="background: #f1f5f9; border: none; border-radius: 8px; padding: 6px 10px; cursor: pointer;">‚úñ</button>
    </div>
</div>
<button onclick="openRateTable()" style="background: #f1f5f9; border: 1px solid var(--line); padding: 8px 12px; border-radius: 999px; font-weight: 1000; cursor: pointer; font-size: 12px; margin-left: 10px; color: var(--muted);">
    üìã ‡§∞‡•á‡§ü ‡§≤‡§ø‡§∏‡•ç‡§ü (Chart)
</button>

<div id="rateTableOverlay" class="overlay" style="display:none; align-items: center; justify-content: center;">
    <div class="modal" style="width: 400px; height: auto; max-height: 80vh; overflow: hidden;">
        <div class="modalHead">
            <div class="left">‡§Ü‡§ú ‡§ï‡•Ä ‡§∞‡•á‡§ü ‡§≤‡§ø‡§∏‡•ç‡§ü (‚Çπ<span id="chartBaseRate">0</span>)</div>
            <button class="closeBtn" onclick="closeRateTable()">‚úñ</button>
        </div>
        <div class="modalBody onecol" style="overflow-y: auto; padding: 15px;">
            <table style="width: 100%; border-collapse: collapse; text-align: center;">
                <thead style="position: sticky; top: 0; background: #fff;">
                    <tr style="background: #f8fafc;">
                        <th style="padding: 10px; border: 1px solid #e2e8f0;">FAT %</th>
                        <th style="padding: 10px; border: 1px solid #e2e8f0;">RATE (‚Çπ/L)</th>
                    </tr>
                </thead>
                <tbody id="rateTableBody">
                    </tbody>
            </table>
        </div>
        <div class="modalFoot">
            <button class="pillbtn primary" onclick="sendRateChartWhatsApp()" style="width: 100%; justify-content: center;">
                üí¨ WhatsApp ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç
            </button>
        </div>
    </div>
</div>

          <!-- Profile Dropdown (Top Right) -->
          <div style="position: relative; display: inline-block; margin-left: 10px;">
            <button class="pillbtn" onclick="toggleProfileDropdown()" style="background:#f8fafc; border-color:#e2e8f0;">
              üë§ <span id="profileName">User</span> ‚ñº
            </button>
            <div id="profileDropdown" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 8px; background: white; border: 1px solid var(--line); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000;">
              <div style="padding: 12px; border-bottom: 1px solid var(--line);">
                <div style="font-weight: 700; font-size: 13px;" id="dropdownEmail">user@email.com</div>
                <div style="font-size: 11px; color: var(--muted);" id="dropdownShop">Shop Name</div>
              </div>
              <button onclick="openRateEditor(); toggleProfileDropdown()" style="width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text);">üìã Rate Chart</button>
              <button onclick="openOverlay('overlayHistory'); toggleProfileDropdown()" style="width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text);">üßæ History</button>
              <button onclick="toggleLanguage(); toggleProfileDropdown()" style="width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text);">üåê HI/EN</button>
              <div style="border-top: 1px solid var(--line); margin: 4px 0;"></div>
              <button onclick="logout(); toggleProfileDropdown()" style="width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: #dc2626;">üö™ Logout</button>
            </div>
          </div>
        </div>
      </div>

      <!-- CORE -->
      <div class="core">
        <!-- LEFT -->
        <div class="panel">
          <div class="panelHeader">
            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
              <div id="stationTitle">Milk Intake Station</div>
              <div class="searchBox" style="flex: 1; max-width: 300px;">
                üîé
                <input
                  id="searchInput"
                  inputmode="search"
                  autocomplete="off"
                  placeholder="Search name‚Ä¶"
                />
              </div>
              <button class="addNewBtn" id="btnAddFarmerMain" style="padding: 8px 16px; font-size: 13px;" onclick="openOverlay('overlayFarmer'); return false;">
                Ôºã Farmer
              </button>
            </div>
            <small id="holdBadge"></small>
            <div class="miniTag" id="farmerCount" style="margin-left: 8px;">0 üë§</div>
          </div>

          <div class="actionBody">
            <!-- Farmer selection -->
            <div class="farmerPick">
              <div class="farmerGrid" id="farmerGrid"></div>

              <div class="farmerNav">
                <button class="navBtn" id="prevFarmers">‚¨ÖÔ∏è</button>
                <button class="navBtn" id="nextFarmers">‚û°Ô∏è</button>
              </div>
            </div>

            <!-- Inputs -->
            <div class="inputs">
              <div class="control green">
                <div class="ctrlTop">
                  <div id="qtyLabel">2. Liters (L)</div>
                  <!-- <div class="muted" id="qtyStep">¬±0.5</div> -->
                </div>
                <div class="numBig">
                  <input
                    id="qtyInput"
                    class="numInput"
                    type="number"
                    step="0.1"
                    placeholder="0"
                  />
                </div>
                <!-- <div class="pmRow">
                  <button class="pm" id="qtyMinus">‚àí</button>
                  <button class="pm" id="qtyPlus">+</button>
                </div> -->
              </div>
              
              <!-- Quantity Threshold Nudge -->
              <div id="qtyThresholdNudge" style="display: none; grid-column: 1/-1; background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 8px; font-size: 11px; color: #1e40af; font-weight: 700;">
                ‚ÑπÔ∏è Bulk collection detected<br>
                <span style="font-weight: 500; color: #64748b;">Institutional systems track source, quality & settlement for this volume.</span>
                <span style="color: #3b82f6; cursor: pointer; margin-left: 8px; text-decoration: underline;" onclick="showWhatMissing()">What's missing?</span>
              </div>

              <div class="control yellow">
                <div class="ctrlTop">
  <div id="fatLabel">3. Fat %</div>

  <label for="fImageEntry" style="cursor:pointer; font-size: 1.2rem; margin-left: auto;" title="Capture Proof">
    üì∑
  </label>
  <input type="file" id="fImageEntry" accept="image/*" capture="camera" style="display:none;">

  <div class="muted" id="fatStep" style="margin-left: 10px;">¬±0.1</div>
</div>
<div class="numBig">
  <input
    id="fatInput"
    class="numInput"
    type="number"
    step="0.1"
    placeholder="0"
  />
</div>
<div style="text-align:center; margin-top: 4px;" title="Analyzer-linked readings are required for verifiable quality records.">
  <span style="font-size: 16px; cursor: help;">‚ö†Ô∏è</span>
</div>
                <!-- <div class="pmRow">
                  <button class="pm" id="fatMinus">‚àí</button>
                  <button class="pm" id="fatPlus">+</button>
                </div> -->
              </div>
              <div class="control blue" style="background: #fdf2f8; border-color: #fbcfe8;">
  <div class="ctrlTop">
    <div id="densityLabel">Density (CLR)</div>
  </div>
  <div class="numBig">
    <input id="densityInput" class="numInput" type="number" step="any" placeholder="0">
  </div>
</div>

              <div class="control blue">
                <div class="ctrlTop">
                  <div id="snfLabel">4. SNF</div>
                  <div class="muted" id="snfStep">¬±0.1</div>
                </div>
                <div class="numBig">
                  <input
                    id="snfInput"
                    class="numInput"
                    type="number"
                    step="0.1"
                    placeholder="0"
                  />
                </div>
                <div style="text-align:center; margin-top: 4px;" title="Analyzer-linked readings are required for verifiable quality records.">
  <span style="font-size: 16px; cursor: help;">‚ö†Ô∏è</span>
</div>
                <!-- <div class="pmRow">
                  <button class="pm" id="snfMinus">‚àí</button>
                  <button class="pm" id="snfPlus">+</button>
                </div> -->
              </div>

              <div class="row3" style="grid-column: 1/-1">
                <div class="animalCard">
                  <label>5. Animal Type</label>
                  <select id="animalSelect">
                    <option value="cow">üêÑ Cow</option>
                    <option value="buffalo">üêÉ Buffalo</option>
                  </select>
                </div>

                <!-- Manual Rate Override -->
                <div class="manualOverride">
                  <div class="left">üì∑ Manual Rate Override</div>
                  <div style="display: flex; align-items: center; gap: 12px">
                    <div class="rtag" id="rateTypeLabel">Rate: Auto</div>
                    <div class="manualRateRow" id="manualRateRow">
                      <input
                        id="manualRateInput"
                        inputmode="decimal"
                        placeholder="Rate/L"
                      />
                      <button id="manualRateApply">‚úîÔ∏è</button>
                    </div>
                  </div>
                </div>

                <div style="flex: 1"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="panel">
          <div class="panelHeader">
            <div>Summary</div>
            <small id="selectedName">‚Äî</small>
          </div>

          <div class="trustBody">
            <div class="amountBox">
              <div class="label" id="amtLabel">TOTAL AMOUNT</div>
              <div class="amt" id="amountView">‚Çπ0.00</div>
              <div class="sub" id="trailMini">0.0 L √ó ‚Çπ0.00/L</div>
            </div>

            <!-- Inline Cow/Buff Quantity Tracker -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div style="background: #dcfce7; border: 2px solid #16a34a; border-radius: 12px; padding: 12px; text-align: center;">
                <div style="font-size: 11px; font-weight: 700; color: #166534; margin-bottom: 4px;">üêÑ COW (L)</div>
                <div style="font-size: 24px; font-weight: 900; color: #166534;" id="cowQtyInline">0.0</div>
              </div>
              <div style="background: #fee2e2; border: 2px solid #dc2626; border-radius: 12px; padding: 12px; text-align: center;">
                <div style="font-size: 11px; font-weight: 700; color: #7f1d1d; margin-bottom: 4px;">üêÉ BUFF (L)</div>
                <div style="font-size: 24px; font-weight: 900; color: #7f1d1d;" id="buffQtyInline">0.0</div>
              </div>
            </div>

            <div class="balances">
              <div class="balCard balOld">
                <div class="t" id="oldBalLabel">OLD BALANCE</div>
                <div class="v" id="balBefore">‚Çπ0.00</div>
              </div>
              <div class="balCard balNew">
                <div class="t" id="newBalLabel">NEW BALANCE</div>
                <div class="v" id="balAfter">‚Çπ0.00</div>
              </div>
              <div style="padding: 12px; background: #f8fafc; border-radius: 18px; margin: 10px 0; border: 1px solid var(--line);">
    <div style="font-weight: 1000; font-size: 11px; color: var(--muted); margin-bottom: 8px; letter-spacing: 0.5px;">‡§≠‡•Å‡§ó‡§§‡§æ‡§® (PAYMENT MODE)</div>
    <div style="display: flex; gap: 8px;">
        <label style="flex: 1; cursor: pointer;">
            <input type="radio" name="payMode" value="Cash" checked style="display: none;" onchange="updatePayUI()">
            <div id="optCash" style="text-align: center; padding: 12px; border-radius: 12px; border: 2px solid var(--green); background: var(--soft-green); font-weight: 1000; font-size: 14px; transition: 0.2s;">‡§Ü‡§ú ‡§®‡§ï‡§¶</div>
        </label>
        <label style="flex: 1; cursor: pointer;">
            <input type="radio" name="payMode" value="Credit" style="display: none;" onchange="updatePayUI()">
            <div id="optCredit" style="text-align: center; padding: 12px; border-radius: 12px; border: 1px solid var(--line); background: #fff; font-weight: 1000; font-size: 14px; transition: 0.2s;">‡§â‡§ß‡§æ‡§∞</div>
        </label>
    </div>
    <div style="text-align: center; margin-top: 8px;" title="Settlement traceability & deductions tracking available in collection center system.">
      <span style="font-size: 16px; cursor: help;">‚ö†Ô∏è</span>
    </div>
</div>
            </div>
            <div id="dailySummaryWrapper" style="display: none; margin-top: 15px;">
        <button class="pillbtn" id="btnDailySummary" style="width: 100%; background: #25d366; color: white; border: none; font-weight: bold; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
             üí¨ Send Today's Summary
        </button>
        <div style="text-align: center; margin-top: 8px;" title="This summary is suitable for farmer communication. Not valid for institutional audit or dispute resolution.">
          <span style="font-size: 16px; cursor: help;">‚ö†Ô∏è</span>
        </div>
    </div>
            <div class="recent">
              <div class="recentHead">
                <div class="t" id="newBalLabel">NEW BALANCE</div>
                <div class="muted" id="recentMeta">0 records</div>
              </div>
              <div class="tableWrap">
                <table>
                  <thead>
                    <tr>
                      <th>DATE</th>
                      <th>FARMER</th>
                      <th>SESSION</th>
                      <th>TYPE</th>
                      <th>QTY</th>
                      <th>FAT</th>
                      <th>SNF</th>
                      <th>AMT</th>
                      <th style="font-size: 10px;">Verified</th>
                    </tr>
                  </thead>
                  <tbody id="recentTbody">
                    <tr>
                      <td
                        colspan="9"
                        style="color: var(--muted); font-weight: 1100"
                      >
                        No records recorded today
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- hidden trail values (logic keeps) -->
            <div style="display: block">
              <span id="rateView"></span>
              <span id="trailQF"></span>
              <span id="trailRateType"></span>
              <span id="trailFormula"></span>
              <span id="trailTime"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="bottom">
        <button class="panicBtn hold" id="btnHold">
          üü° HOLD <span class="subnote">pause</span>
        </button>
        <button class="panicBtn save" id="btnSave">üü¢ SAVE ENTRY</button>
        <button class="panicBtn undo" id="btnUndo">
          üî¥ UNDO <span class="subnote">last</span>
        </button>
      </div>
    </div>
    

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!-- Backend -->
    <script src="simple-backend.js"></script>
    <script>
      console.log('üöÄ Collection Page Loading...');
      
      // Debug: Check if backend loaded
      window.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ DOM Loaded');
        console.log('Backend available:', !!window.MilkBookDB);
        
        // Test backend
        if (window.MilkBookDB) {
          window.MilkBookDB.farmers.getAll().then(result => {
            console.log('‚úÖ Backend working! Farmers:', result.farmers.length);
          }).catch(err => {
            console.error('‚ùå Backend error:', err);
          });
        }
      });
    </script>

    <!-- HISTORY MODAL -->
    <div class="overlay" id="overlayHistory">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayHistory">‚úñ</button>
            <div>üßæ History (Today + Weekly)</div>
          </div>
          <div class="muted" id="historyTitleRight">‚Äî</div>
        </div>

        <div class="modalBody">
          <div class="modalCol">
            <h3>üìÖ Today</h3>
            <div class="listArea">
              <div class="pageInfo">
                <span id="todayPageInfo">‚Äî</span>
                <span class="muted">No scroll ‚Ä¢ Pages</span>
              </div>
              <div
                id="todayList"
                style="display: grid; gap: 10px; align-content: start"
              ></div>
              <div class="pageBtns">
                <button id="todayPrev">‚¨ÖÔ∏è</button>
                <button id="todayNext">‚û°Ô∏è</button>
              </div>
            </div>
          </div>

          <div class="modalCol">
            <h3>üóìÔ∏è Weekly</h3>
            <div class="listArea">
              <div class="pageInfo">
                <span id="weekPageInfo">‚Äî</span>
                <span class="muted">Last 7 days</span>
              </div>
              <div
                id="weekList"
                style="display: grid; gap: 10px; align-content: start"
              ></div>
              <div class="pageBtns">
                <button id="weekPrev">‚¨ÖÔ∏è</button>
                <button id="weekNext">‚û°Ô∏è</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn warn" id="btnReceipt">üì© Receipt</button>
          <div style="display: flex; gap: 10px">
            <button class="footBtn" id="btnExport">‚¨áÔ∏è Export</button>
            <button class="footBtn bad" id="btnClearToday">
              üóëÔ∏è Clear Today
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- LEADER MODAL -->
    <div class="overlay" id="overlayLeader">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayLeader">‚úñ</button>
            <div>üèÜ Weekly Leader</div>
          </div>
          <div class="muted" id="leaderRight">‚Äî</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>Top Farmers (7 days)</h3>
            <div class="listArea">
              <div class="pageInfo">
                <span id="leaderPageInfo">‚Äî</span>
                <span class="muted">By Amount</span>
              </div>
              <div
                id="leaderList"
                style="display: grid; gap: 10px; align-content: start"
              ></div>
              <div class="pageBtns">
                <button id="leaderPrev">‚¨ÖÔ∏è</button>
                <button id="leaderNext">‚û°Ô∏è</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn" id="btnLeaderByAmt">üí∞ Amount</button>
          <button class="footBtn" id="btnLeaderByLit">ü•õ Liters</button>
          <button class="footBtn" id="btnLeaderByCount">üßæ Entries</button>
        </div>
      </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="overlay" id="overlaySettings">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlaySettings">‚úñ</button>
            <div>‚öôÔ∏è Settings</div>
          </div>
          <div class="muted">Offline ‚Ä¢ Saved</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>üí∞ Rate Formula (Simple, Visible)</h3>
            <div class="formGrid">
              <div class="field">
                <label>üêÑ Cow Base (‚Çπ)</label>
                <input id="setCowBase" inputmode="decimal" />
              </div>
              <div class="field">
                <label>üêÑ Cow Factor (‚Çπ per Fat)</label>
                <input id="setCowFactor" inputmode="decimal" />
              </div>
              <div class="field">
                <label>üêÉ Buffalo Base (‚Çπ)</label>
                <input id="setBuffBase" inputmode="decimal" />
              </div>
              <div class="field">
                <label>üêÉ Buffalo Factor (‚Çπ per Fat)</label>
                <input id="setBuffFactor" inputmode="decimal" />
              </div>

              <div class="field">
                <label>Qty Step (L)</label>
                <input id="setQtyStep" inputmode="decimal" />
              </div>
              <div class="field">
                <label>Fat Step (%)</label>
                <input id="setFatStep" inputmode="decimal" />
              </div>

              <div class="field">
                <label>SNF Step</label>
                <input id="setSnfStep" inputmode="decimal" />
              </div>
              <div class="field">
                <label>UI Session Switch Hour</label>
                <input id="setSessionHour" inputmode="numeric" />
              </div>

              <div class="field full">
                <label>Formula Preview (Auto)</label>
                <div
                  style="font-weight: 1100; font-size: 15px; padding: 6px 0"
                  id="formulaPreview"
                >
                  ‚Äî
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn good" id="btnSaveSettings">‚úÖ Save</button>
          <button class="footBtn warn" id="btnResetSettings">‚ôªÔ∏è Reset</button>
          <button class="footBtn bad" id="btnFactoryReset">
            üß® Factory Reset
          </button>
        </div>
      </div>
    </div>

    <!-- CENTER SUMMARY MODAL -->
    <div class="overlay" id="overlayCenterSummary">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayCenterSummary">‚úñ</button>
            <div>üìä Center Summary</div>
          </div>
          <div class="muted" id="centerSummaryTitle">‚Äî</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <div class="center-summary-card">
              <div class="center-summary-header">
                <div class="center-summary-title">Collection Summary</div>
                <div class="center-summary-date" id="centerSummaryDate">Center: ‚Äî</div>
              </div>

              <div class="center-summary-stats">
                <div class="center-summary-stat">
                  <div class="center-summary-stat-label">Entries</div>
                  <div class="center-summary-stat-value" id="summaryEntries">0</div>
                </div>
                <div class="center-summary-stat">
                  <div class="center-summary-stat-label">Total Milk (L)</div>
                  <div class="center-summary-stat-value" id="summaryMilk">0.0</div>
                </div>
                <div class="center-summary-stat">
                  <div class="center-summary-stat-label">Fat Range</div>
                  <div class="center-summary-stat-value" id="summaryFat">‚Äî</div>
                </div>
                <div class="center-summary-stat">
                  <div class="center-summary-stat-label">Total Amount</div>
                  <div class="center-summary-stat-value" id="summaryAmount">‚Çπ0</div>
                </div>
              </div>

              <div class="dispatch-action">
                <button class="dispatch-action-btn" id="btnMarkDispatch">Mark Milk Sent to Dairy</button>
                <button class="whatsapp-share-btn" id="btnShareCenterSummary">üì§ Send Center Summary (WhatsApp)</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn" id="btnCloseCenterSummary">‚úÖ Close</button>
        </div>
      </div>
    </div>

    <!-- DISPATCH MODAL -->
    <div class="overlay" id="overlayDispatch">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayDispatch">‚úñ</button>
            <div>üöõ Mark Milk Dispatch</div>
          </div>
          <div class="muted">Fill Cane Record</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>Dispatch Information</h3>
            <div class="formGrid">
              <div class="field">
                <label>Total Milk Sent (L)</label>
                <input id="dispatchMilkQty" inputmode="decimal" placeholder="Enter quantity" />
              </div>
              <div class="field">
                <label>Destination</label>
                <select id="dispatchDestination">
                  <option value="dairy">Dairy</option>
                  <option value="bmc">BMC</option>
                </select>
              </div>
              <div class="field full">
                <label>Notes</label>
                <textarea id="dispatchNotes" placeholder="Additional information"></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn good" id="btnSaveDispatch">‚úÖ Save Dispatch</button>
          <button class="footBtn" id="btnCancelDispatch">‚ùå Cancel</button>
        </div>
      </div>
    </div>

    <!-- BMC RECONCILIATION MODAL -->
    <div class="overlay" id="overlayBMCReconcile">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayBMCReconcile">‚úñ</button>
            <div>‚öñÔ∏è BMC Reconciliation</div>
          </div>
          <div class="muted">Compare Records</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>Reconciliation Details</h3>
            <div class="formGrid">
              <div class="field">
                <label>Our Records (L)</label>
                <input id="reconcileOurRecords" inputmode="decimal" readonly />
              </div>
              <div class="field">
                <label>BMC Records (L)</label>
                <input id="reconcileBMCRecords" inputmode="decimal" placeholder="Enter BMC quantity" />
              </div>
              <div class="field">
                <label>Difference (L)</label>
                <input id="reconcileDifference" inputmode="decimal" readonly />
              </div>
              <div class="field">
                <label>Status</label>
                <select id="reconcileStatus">
                  <option value="matched">‚úÖ Matched</option>
                  <option value="variance">‚ö†Ô∏è Variance</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn good" id="btnSaveReconcile">‚úÖ Save Reconciliation</button>
          <button class="footBtn" id="btnCancelBMCReconcile">‚ùå Cancel</button>
        </div>
      </div>
    </div>

    <!-- PAYMENT OBLIGATION MODAL -->
    <div class="overlay" id="overlayPaymentObligation">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayPaymentObligation">‚úñ</button>
            <div>üí∞ Payment Obligation</div>
          </div>
          <div class="muted">Monthly Summary</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>Payment Summary</h3>
            <div class="center-summary-stats">
              <div class="center-summary-stat">
                <div class="center-summary-stat-label">Total Milk Purchased</div>
                <div class="center-summary-stat-value" id="paymentTotalMilk">0.0 L</div>
              </div>
              <div class="center-summary-stat">
                <div class="center-summary-stat-label">Total Amount Due</div>
                <div class="center-summary-stat-value" id="paymentTotalAmount">‚Çπ0</div>
              </div>
              <div class="center-summary-stat">
                <div class="center-summary-stat-label">Advances Given</div>
                <div class="center-summary-stat-value" id="paymentAdvancesGiven">‚Çπ0</div>
              </div>
              <div class="center-summary-stat">
                <div class="center-summary-stat-label">Net Payable</div>
                <div class="center-summary-stat-value" id="paymentNetPayable">‚Çπ0</div>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn" id="btnClosePaymentObligation">‚úÖ Close</button>
        </div>
      </div>
    </div>

    <!-- ADD FARMER MODAL -->
    <div class="overlay" id="overlayFarmer">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayFarmer">‚úñ</button>
            <div>‚ûï Add Farmer</div>
          </div>
          <div class="muted">Photo optional</div>
        </div>

        <div class="modalBody onecol" style="overflow-y: auto; max-height: 60vh;">
          <div class="modalCol">
            <h3>üë§ Farmer Form</h3>
            <div class="formGrid">
              <div class="field" style="padding: 6px;">
                <label style="font-size: 11px;">üë§ Name</label>
                <input id="fName" autocomplete="off" style="font-size: 14px; padding: 8px;" />
              </div>
              <div class="field" style="padding: 6px;">
                <label style="font-size: 11px;">üì± Number</label>
                <input id="fPhone" inputmode="tel" autocomplete="off" style="font-size: 14px; padding: 8px;" />
              </div>
              <div class="field full" style="padding: 6px;">
                <label style="font-size: 11px;">üìç Address</label>
                <textarea id="fAddress" style="font-size: 14px; padding: 8px; min-height: 60px;"></textarea>
              </div>
              <div class="field full" style="padding: 6px;">
                <label style="font-size: 11px;">üè¢ GST No. (B2B)</label>
                <input id="fGst" autocomplete="off" placeholder="Optional for B2B customers" style="font-size: 14px; padding: 8px;" />
              </div>
              <div class="field full" style="padding: 6px;">
                <label style="font-size: 11px;">üñºÔ∏è Image</label>
                <input id="fImage" type="file" accept="image/*" style="font-size: 13px;" />
                <div style="color: var(--muted); font-size: 11px; font-weight: 1000;">
                  Stored offline (small compressed)
                </div>
              </div>
              <div class="field" style="padding: 6px;">
                <label style="font-size: 11px;">‚Çπ Opening Balance</label>
                <input id="fBalance" inputmode="decimal" value="0" style="font-size: 14px; padding: 8px;" />
              </div>
              <div class="field" style="padding: 6px;">
  <label style="font-size: 11px;">ü•õ Milk Type</label>
  <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px;">
    <button type="button" onclick="selectAnimalType('cow')" id="animalCow" style="padding:8px; border:2px solid var(--line); border-radius:6px; background:white; cursor:pointer; font-weight:700; font-size: 12px;">üêÑ Cow</button>
    <button type="button" onclick="selectAnimalType('buffalo')" id="animalBuffalo" style="padding:8px; border:2px solid var(--line); border-radius:6px; background:white; cursor:pointer; font-weight:700; font-size: 12px;">üêÉ Buffalo</button>
    <button type="button" onclick="selectAnimalType('both')" id="animalBoth" style="padding:8px; border:2px solid var(--line); border-radius:6px; background:white; cursor:pointer; font-weight:700; font-size: 12px;">üîÑ Both</button>
  </div>
  <input type="hidden" id="fAnimalType" value="cow" />
</div>
              <div class="field" style="padding: 6px;">
                <label style="font-size: 11px;">Status</label>
                <select id="fActive" style="font-size: 14px; padding: 8px;">
                  <option value="1">‚úÖ Active</option>
                  <option value="0">‚õî Inactive</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn good" id="btnCreateFarmer">‚úÖ Create</button>
          <button class="footBtn" id="btnDemoFarmers">üß™ Demo Farmers</button>
        </div>
      </div>
    </div>

    <!-- RECEIPT MODAL -->
    <div class="overlay" id="overlayReceipt">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayReceipt">‚úñ</button>
            <div>üì© Receipt (Locked)</div>
          </div>
          <div class="muted">Copy ‚Ä¢ WhatsApp</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>üßæ Message</h3>
            <div class="receiptBox" id="receiptText">‚Äî</div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn good" id="btnCopyReceipt">üìã Copy</button>
          <button class="footBtn warn" id="btnWhatsApp">üí¨ WhatsApp</button>
          <button class="footBtn" id="btnCloseReceipt">‚úÖ Done</button>
        </div>
      </div>
    </div>
    <div class="overlay" id="overlayEntryDetail">
  <div class="modal" style="height: auto; align-self: flex-end; border-bottom-left-radius: 0; border-bottom-right-radius: 0;">
    <div class="modalHead">
      <div class="left">
        <button class="closeBtn" data-close="overlayEntryDetail">‚úñ</button>
        <div style="font-weight: 1200;">Entry Detail & Proof</div>
      </div>
    </div>
    <div class="modalBody onecol" id="entryDetailContent" style="padding: 20px; font-weight: 900;">
        </div>
    <div class="modalFoot">
        <button class="pillbtn primary" id="btnSendSingleProof" style="width:100%; justify-content: center;">üì© Send Entry Proof (WhatsApp)</button>
    </div>
  </div>
</div>

<!-- Farmer Transaction History Modal -->
<div class="overlay" id="overlayFarmerTransactions">
  <div class="modal" style="height: auto; max-height: 80vh;">
    <div class="modalHead">
      <div class="left">
        <button class="closeBtn" data-close="overlayFarmerTransactions">‚úñ</button>
        <div>üìï <span id="transFarmerName">Farmer Name</span> - Advance Management</div>
      </div>
      <div class="muted" id="transDateRange">‚Äî</div>
    </div>
    <div class="modalBody onecol" style="overflow-y: auto; padding: 0;">
      <!-- Summary Cards -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #fef3c7; border-bottom: 1px solid #f59e0b;">
        <div style="background: white; padding: 15px; border-radius: 12px; text-align: center;">
          <div style="font-size: 11px; color: #64748b; font-weight: 700;">TOTAL MILK (MONTH)</div>
          <div style="font-size: 24px; font-weight: 900; color: #1e293b;" id="transTotalMilk">0.0 L</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 12px; text-align: center;">
          <div style="font-size: 11px; color: #64748b; font-weight: 700;">CURRENT ADVANCE</div>
          <div style="font-size: 24px; font-weight: 900; color: #166534;" id="transCurrentAdvance">‚Çπ0.00</div>
        </div>
      </div>
      
      <!-- Transaction List -->
      <div style="padding: 15px;">
        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 700; color: #1e293b;">üìä Transaction History</h4>
        <div id="transList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;"></div>
      </div>
      
      <!-- Quick Actions -->
      <div style="padding: 0 15px 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <input type="number" id="transAmount" placeholder="Amount (‚Çπ)" style="padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; font-weight: 700; font-size: 14px;" />
        <select id="transAction" style="padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; font-weight: 700; font-size: 14px;">
          <option value="give">‚ûï Give Advance</option>
          <option value="cut">‚ûñ Cut Advance</option>
        </select>
      </div>
      <div style="padding: 0 15px 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button onclick="updateFarmerAdvance()" style="padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">Update Advance</button>
        <button onclick="sendFarmerSummary()" style="padding: 12px; background: #25D366; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">üí¨ Send Summary</button>
      </div>
    </div>
  </div>
</div>

<div id="kitchenOverlay" class="overlay" style="display:none; align-items: center; justify-content: center;">
    <div class="modal" style="width: 350px;">
        <div class="modalHead">
            <div class="left">Yield Calculator (Paneer/Dahi)</div>
            <button class="closeBtn" onclick="closeKitchen()">‚úñ</button>
        </div>
        <div class="modalBody onecol" style="padding: 20px;">
            <label>Kitna Doodh Use Hua? (Liters)</label>
            <input id="kQty" type="number" oninput="calcYield()" placeholder="0.0" class="numInput" style="width:100%; font-size:24px; margin-bottom:15px;">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div style="background:#f0f9ff; padding:10px; border-radius:10px; text-align:center;">
                    <div style="font-size:12px; color:#0369a1;">Buffalo Paneer</div>
                    <div id="buffPaneer" style="font-size:20px; font-weight:1000; color:#0369a1;">0.00 kg</div>
                </div>
                <div style="background:#fff7ed; padding:10px; border-radius:10px; text-align:center;">
                    <div style="font-size:12px; color:#9a3412;">Cow Paneer</div>
                    <div id="cowPaneer" style="font-size:20px; font-weight:1000; color:#9a3412;">0.00 kg</div>
                </div>
            </div>
            <p style="font-size:11px; color:var(--muted); margin-top:15px; line-height:1.4;">
                *Standard Yield: Buffalo (22%), Cow (15%). Agar isse kam paneer nikal raha hai toh check karein.
            </p>
        </div>
    </div>
</div>
    <script>
      // Point 2.6: Success Sound Feedback Logic
function playSuccessSound() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    oscillator.type = 'sine'; // Soft sound
    oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // Pitch (High Note)
    
    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.1);
}
      /***********************
       * OFFLINE DATA MODEL  *
       ***********************/
      const LS = {
        farmers: "milkapp_farmers_v2",
        entries: "milkapp_entries_v2",
        settings: "milkapp_settings_v2",
        hold: "milkapp_hold_v2",
        lastUndo: "milkapp_lastundo_v2",
      };

      const defaultSettings = {
        cowBase: 18.0,
        cowFactor: 6.0, // rate/L = base + factor * fat
        buffBase: 22.0,
        buffFactor: 7.0,
        qtyStep: 0.5,
        fatStep: 0.1,
        snfStep: 0.1,
        sessionSwitchHour: 14, // before this -> Morning, after -> Evening
      };

      function loadSettings() {
        try {
          const s = JSON.parse(localStorage.getItem(LS.settings) || "null");
          return { ...defaultSettings, ...(s || {}) };
        } catch (e) {
          return { ...defaultSettings };
        }
      }
      function saveSettings(s) {
        localStorage.setItem(LS.settings, JSON.stringify(s));
      }

      function loadFarmers() {
        try {
          return JSON.parse(localStorage.getItem(LS.farmers) || "[]") || [];
        } catch (e) {
          return [];
        }
      }
      function saveFarmers(arr) {
        localStorage.setItem(LS.farmers, JSON.stringify(arr));
      }

      function loadEntries() {
        try {
          return JSON.parse(localStorage.getItem(LS.entries) || "[]") || [];
        } catch (e) {
          return [];
        }
      }
      function saveEntries(arr) {
        localStorage.setItem(LS.entries, JSON.stringify(arr));
      }

      function uid(prefix = "id") {
        return (
          prefix +
          "_" +
          Math.random().toString(16).slice(2) +
          "_" +
          Date.now().toString(16)
        );
      }

      /***********************
       * TIME + DATE HELPERS *
       ***********************/
      function pad(n) {
        return String(n).padStart(2, "0");
      }
      function fmtTime(d) {
        return pad(d.getHours()) + ":" + pad(d.getMinutes());
      }
      function fmtDate(d) {
        const y = d.getFullYear();
        const m = pad(d.getMonth() + 1);
        const da = pad(d.getDate());
        return `${y}-${m}-${da}`;
      }
      function startOfDay(d) {
        const x = new Date(d);
        x.setHours(0, 0, 0, 0);
        return x;
      }
      function daysAgo(n) {
        const d = new Date();
        d.setDate(d.getDate() - n);
        return startOfDay(d);
      }

      function autoSessionLabel() {
    const h = new Date().getHours();
    // settings.sessionSwitchHour humne 14 (2 PM) rakha hai
    // Agar ghanta 14 se kam hai toh Morning, varna Evening
    return h < settings.sessionSwitchHour ? "Morning" : "Evening"; 
}

      /***********************
       * APP STATE           *
       ***********************/
      let settings = loadSettings();
      let farmers = loadFarmers();
      let entries = loadEntries();

      let selectedFarmerId = null;
      let selectedCollectionPointId = "DEFAULT";

      let qty = 0.0;
      let fat = 0.0;
      let snf = 0.0;
      let clr = 0.0; // Naya variable CLR ke liye

      let animal = "cow"; // cow | buffalo
      let rateMode = "auto"; // auto | manual
      let manualRate = 0.0;

      // Farmer paging
      const FARMERS_PER_PAGE = 4; // 2x2 grid
      let farmerPage = 0;
      let farmerSearch = "";

      // History paging
      const LIST_PER_PAGE = 6;
      let todayPage = 0,
        weekPage = 0;

      // Leader paging
      const LEADER_PER_PAGE = 8;
      let leaderPage = 0;
      let leaderMode = "amount"; // amount | liters | count

      // Timer
      let timerStart = Date.now();
      let timerInt = null;

      /***********************
       * UI HOOKS            *
       ***********************/
      const el = (id) => document.getElementById(id);

      const farmerGrid = el("farmerGrid");
      const searchInput = el("searchInput");
      const farmerCount = el("farmerCount");

      const amountView = el("amountView");
      const rateView = el("rateView"); // hidden but used
      const selectedName = el("selectedName");

      const balBefore = el("balBefore");
      const balAfter = el("balAfter");

      const manualRateRow = el("manualRateRow");
      const manualRateInput = el("manualRateInput");
      const rateTypeLabel = el("rateTypeLabel");
      const holdBadge = el("holdBadge");
      const toast = el("toast");

      const recentTbody = el("recentTbody");
      const recentMeta = el("recentMeta");
      const trailMini = el("trailMini");

      const animalSelect = el("animalSelect");
      const manualRateApply = el("manualRateApply");

      const qtyInput = el("qtyInput");
      const fatInput = el("fatInput");
      const snfInput = el("snfInput");

      /* Manual typing ‚Üí state update */
      qtyInput.addEventListener("input", (e) => {
        qty = Number(e.target.value) || 0;
        renderTrust();
      });
      fatInput.addEventListener("input", (e) => {
        fat = Number(e.target.value) || 0;
        renderTrust();
      });
      snfInput.addEventListener("input", (e) => {
        snf = Number(e.target.value) || 0;
        renderTrust();
      });

      /* + / ‚àí ke baad input sync */
      function syncInputs() {
  // Check karein: User jis dabba mein type kar raha hai, use refresh mat karo
  if (document.activeElement !== el("qtyInput")) {
    el("qtyInput").value = round2(qty).toFixed(1);
  }
  if (document.activeElement !== el("fatInput")) {
    el("fatInput").value = round2(fat).toFixed(1);
  }
  if (document.activeElement !== el("snfInput")) {
    el("snfInput").value = round2(snf).toFixed(1);
  }
  // Iske andar density update add karein
  if (document.activeElement !== el("densityInput")) {
    el("densityInput").value = clr;
  }
  
  // Manual rate input ko current rate se pre-fill karo
  if (manualRateInput && document.activeElement !== manualRateInput) {
    if (!manualRate || manualRate === 0) {
      // Auto mode: Current rate se pre-fill
      manualRateInput.value = settings.cowBase ? Number(settings.cowBase).toFixed(2) : "";
    } else {
      // Manual mode: User ka entered value dikhao
      manualRateInput.value = manualRate.toFixed(2);
    }
  }
}
  function calculateSNFFromCLR() {
  if (clr > 0) {
    // Ye formula apne aap SNF calculate karke update kar dega
    snf = round2((clr / 4) + (fat * 0.21) + 0.36);
  }
}
      /***********************
       * TOAST               *
       ***********************/
      let toastT = null;
      function showToast(msg) {
        toast.textContent = msg;
        toast.classList.add("show");
        clearTimeout(toastT);
        toastT = setTimeout(() => toast.classList.remove("show"), 1200);
      }

      /***********************
       * FARMER HELPERS      *
       ***********************/
      function getFarmerById(id) {
        return farmers.find((f) => f.id === id) || null;
      }
      function activeFarmers() {
        return farmers.filter((f) => f.active !== false);
      }
      function filterFarmers() {
        let list = activeFarmers();

        // Filter by selected booth/collection point (show farmers from selected booth first)
        if (selectedCollectionPointId && selectedCollectionPointId !== 'DEFAULT') {
          // Sort: Farmers from selected booth first, then others
          list = list.sort((a, b) => {
            const aBooth = a.collectionPoint || 'DEFAULT';
            const bBooth = b.collectionPoint || 'DEFAULT';
            if (aBooth === selectedCollectionPointId && bBooth !== selectedCollectionPointId) return -1;
            if (aBooth !== selectedCollectionPointId && bBooth === selectedCollectionPointId) return 1;
            return 0;
          });
        }

        if (!farmerSearch.trim()) return list;
        const q = farmerSearch.trim().toLowerCase();
        return list.filter((f) => (f.name || "").toLowerCase().includes(q));
      }

      // Edit farmer name
      function editFarmerName(farmerId) {
        const farmer = getFarmerById(farmerId);
        if (!farmer) return;
        
        const newName = prompt("Edit farmer name:", farmer.name);
        if (newName && newName.trim() !== "" && newName !== farmer.name) {
          farmer.name = newName.trim();
          saveFarmers(farmers);
          renderFarmers();
          renderAll();
          showToast(`Name updated: ${farmer.name} ‚úÖ`);
        }
      }

      function ensureSelectedFarmer() {
        const list = activeFarmers();
        if (!selectedFarmerId && list.length) {
          selectedFarmerId = list[0].id;
        } else if (
          selectedFarmerId &&
          !list.some((f) => f.id === selectedFarmerId)
        ) {
          selectedFarmerId = list.length ? list[0].id : null;
        }
      }
      function openKitchen() { el("kitchenOverlay").style.display = "flex"; el("kQty").focus(); }
function closeKitchen() { el("kitchenOverlay").style.display = "none"; }

function calcYield() {
    const qty = Number(el("kQty").value) || 0;
    // Standard Math: Buff 22%, Cow 15%
    el("buffPaneer").textContent = (qty * 0.22).toFixed(2) + " kg";
    el("cowPaneer").textContent = (qty * 0.15).toFixed(2) + " kg";
}
      /***********************
       * CALCULATION         *
       ***********************/
      function round2(n) {
        return Math.round((n + Number.EPSILON) * 100) / 100;
      }

      function getAutoRatePerLiter(fatVal, animalType) {
        const f = Number(fatVal) || 0;
        if (animalType === "buffalo") {
          return round2(settings.buffBase + settings.buffFactor * f);
        }
        return round2(settings.cowBase + settings.cowFactor * f);
      }

      function getRatePerLiter() {
    // Check if manual rate override has a value
    const mInput = el("manualRateInput").value;
    if (mInput && Number(mInput) > 0) {
        return round2(Number(mInput));
    }

    // Auto calculate from fat
    const f = Number(el("fatInput").value) || 0;
    const a = el("animalSelect").value;
    if (a === "buffalo") {
        return round2(settings.buffBase + (settings.buffFactor * f));
    }
    return round2(settings.cowBase + (settings.cowFactor * f));
}
      function getAmount() {
        const r = getRatePerLiter();
        const q = Number(qty) || 0;
        return round2(q * r);
      }

      function farmerBalanceBefore(farmer) {
        return round2(Number(farmer.balance || 0));
      }

      /***********************
       * RENDER FARMERS      *
       ***********************/
      function escapeHtml(s) {
        return String(s).replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            })[c],
        );
      }

      // Global variable photo store karne ke liye
let currentEntryImage = null;

// Photo khinchne par use capture karein
document.getElementById("fImageEntry").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            currentEntryImage = event.target.result; // Photo data tayyar hai
            showToast("Photo Attached! üì∑ ‚úÖ");
        };
        reader.readAsDataURL(file);
    }
});

      function renderFarmers() {
    const activeCount = activeFarmers().length;
    farmerCount.textContent = `${activeCount} üë§`;

    // Debug logging
    console.log('Farmers:', farmers.length, 'Active:', activeCount);

    const list = filterFarmers();
    const maxPage = Math.max(0, Math.ceil(list.length / FARMERS_PER_PAGE) - 1);
    if (farmerPage > maxPage) farmerPage = maxPage;

    const start = farmerPage * FARMERS_PER_PAGE;
    const pageItems = list.slice(start, start + FARMERS_PER_PAGE);

    farmerGrid.innerHTML = "";

    const toShow = [...pageItems];
    while (toShow.length < FARMERS_PER_PAGE) toShow.push(null);

    toShow.forEach((f, index) => {
        const card = document.createElement("div");
        card.className = "fcard";

        if (f) {
            // --- 1. Focus & Double Click Support (NAYA) ---
            card.setAttribute("tabindex", "0");

            // Double Click logic: Yahan kisan ke card par double tap karne se dabba khulega
            card.ondblclick = (e) => {
                e.stopPropagation();
                openFarmerDetail(f.id);
            };
            // ----------------------------------------------

            const isSel = f.id === selectedFarmerId;
            if (isSel) card.classList.add("fsel");

            const imgHTML = f.imageData ? `<img alt="" src="${f.imageData}">` : `üë§`;

            card.innerHTML = `
                <div class="fimg">${imgHTML}</div>
                <div style="min-width:0; flex: 1;">
                    <div class="fname" title="${escapeHtml(f.name || "")}">${escapeHtml(f.name || "")}</div>
                    <div class="fsub">${f.phone || ""} ‚Ä¢ ‚Çπ${round2(Number(f.balance || 0)).toFixed(2)}</div>
                </div>
                <button class="editFarmerBtn" onclick="event.stopPropagation(); editFarmerName('${f.id}')" title="Edit Name" style="background:none; border:none; cursor:pointer; font-size:16px; padding:4px 8px; opacity:0.6;">‚úèÔ∏è</button>
                ${isSel ? `<div class="badge">Selected</div>` : ``}
            `;

            card.addEventListener("click", () => {
                selectedFarmerId = f.id;
                //  ‚úÖ SOUND UNLOCK LOGIC
    // Jab operator kisan ko touch karega, browser sound bajane ki permission de dega
    const dummyCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (dummyCtx.state === 'suspended') dummyCtx.resume();
    // ----------------------------
                
                // Auto-fill from previous entry for this farmer
                loadFarmerMemory(f.id);
                
                renderAll();
                el("qtyInput").focus();
                el("qtyInput").select();
            });

            // Double-click to view transaction history
            card.addEventListener("dblclick", (e) => {
                e.stopPropagation();
                openFarmerTransactions(f.id);
            });

        } else if (index === 0 && farmerSearch && list.length === 0) {
            // "Add New Farmer" card when search has no results
            card.style.opacity = 1;
            card.style.background = '#f0fdf4';
            card.style.borderColor = '#16a34a';
            card.innerHTML = `
                <div class="fimg" style="font-size: 32px;">‚ûï</div>
                <div style="min-width:0;">
                    <div class="fname" style="color: #16a34a;">Add "${escapeHtml(farmerSearch)}"</div>
                    <div class="fsub">Click to create new farmer</div>
                </div>
            `;
            card.addEventListener("click", () => {
                // Open farmer modal and pre-fill name
                openOverlay("overlayFarmer");
                setTimeout(() => {
                    el("fName").value = farmerSearch;
                    el("fPhone").focus();
                }, 300);
            });
        } else {
            // Empty slot
            card.style.opacity = 0.4;
            card.innerHTML = `
                <div class="fimg">‚ûï</div>
                <div style="min-width:0;">
                  <div class="fname">Add Farmer</div>
                  <div class="fsub">Click to create new</div>
                </div>
            `;
            card.addEventListener("click", () => openOverlay("overlayFarmer"));
        }

        farmerGrid.appendChild(card);
    });

    el("prevFarmers").disabled = farmerPage <= 0;
    el("nextFarmers").disabled = farmerPage >= maxPage;
}

      // Rate Editor kholne ke liye
function openRateEditor() {
    el("ratePill").style.display = "none";
    el("rateEditor").style.display = "flex";
    el("newRateInput").value = settings.cowBase; // Default current rate dikhao
    el("newRateInput").focus();
    el("newRateInput").select();
}

// Editor band karne ke liye
function closeRateEditor() {
    el("ratePill").style.display = "flex";
    el("rateEditor").style.display = "none";
}

// üéØ ACTIVE RATE UPDATE LOGIC
function updateActiveRate() {
    const val = Number(el("newRateInput").value);
    if (val <= 0) {
        showToast("Invalid Rate!");
        return;
    }

    // Settings mein update (Sirf Base Rate badlega, deduction rules same rahenge)
    settings.cowBase = val;
    settings.buffBase = val + 5; // Buffalo rate hamesha Cow se thoda zyada (Dairy logic)
    
    saveSettings(settings);
    
    // UI Update
    refreshRatePill();
    renderTrust(); // Right panel turant refresh hoga
    closeRateEditor();
    
    showToast(`Naya Rate Set: ‚Çπ${val.toFixed(2)} ‚úÖ`);
}

// Pill par rate dikhane ke liye
function refreshRatePill() {
    if (el("rateDisplay")) {
        el("rateDisplay").textContent = `Rate: ‚Çπ${Number(settings.cowBase).toFixed(2)}`;
    }
}

       /***********************
       * RENDER RIGHT PANEL  *
       ***********************/
      function renderRecentToday() {
        const today = fmtDate(new Date());
        const todays = entries
          .filter((e) => e.day === today)
          .sort((a, b) => b.createdAt - a.createdAt);

        recentMeta.textContent = `${todays.length} records`;

        if (todays.length === 0) {
          recentTbody.innerHTML = `<tr><td colspan="9" style="color:var(--muted);font-weight:1100;">No records recorded today</td></tr>`;
          return;
        }

        const rows = todays
          .slice(0, 25)
          .map((e) => {
            const typeTag =
              e.animal === "buffalo"
                ? `<span class="tag buff">üêÉ Buffalo</span>`
                : `<span class="tag cow">üêÑ Cow</span>`;
            // Photo icon with null check
            const photoIcon = (e.images && Array.isArray(e.images) && e.images.length > 0)
    ? ` <span onclick="viewProof('${e.images[0]}')" style="cursor:pointer;">üì∏</span>`
    : '';
            const f = getFarmerById(e.farmerId);
            const phone = (f && f.phone) ? f.phone : "";

            const msg = `*Milk Receipt* ü•õ\nDate: ${e.day} (${e.session})\nQty: ${e.qty}L | Fat: ${e.fat}\n*Amount: ‚Çπ${Number(e.amount).toFixed(2)}*\nGopal Dairy Shop`;
            const wpLink = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;

            // --- Point 7: Audit Trail & Edit UI logic ---
            // renderRecentToday function ke andar rows loop mein ye paste karein:
return `
  <tr onclick="showAuditProof('${e.id}')" style="cursor:pointer;">
    <td>${escapeHtml(e.day)}</td>
    <td style="font-weight:1100;">
        ${escapeHtml(e.farmerName || "")}
        ${photoIcon} ${e.edited ? `<br><small class="edit-note" style="color:var(--muted); font-weight:normal; font-size:10px;">‚úèÔ∏è Sudhara gaya: ${fmtTime(new Date(e.editedAt))}</small>` : ''}
    </td>
    <td><span class="rtag">${escapeHtml(e.session || "")}</span></td>
    <td>${typeTag}</td>
    <td style="font-weight:1100;">${Number(e.qty || 0).toFixed(1)} L</td>
    <td>${Number(e.fat || 0).toFixed(1)}%</td>
    <td>${Number(e.snf || 0).toFixed(1)}</td>
    <td style="color:var(--muted); font-size:11px;">
        ‚Çπ${Number(e.rateSnapshot || e.ratePerL || 0).toFixed(2)}
    </td>
    <td style="font-weight:1200; color:#1d4ed8; display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
        ‚Çπ${Number(e.amount || 0).toFixed(2)}
        <button onclick="event.stopPropagation(); editEntry('${e.id}')" title="Edit" style="border:none; background:transparent; cursor:pointer; font-size:14px;">‚úèÔ∏è</button>
        ${phone ? `<a href="${wpLink}" target="_blank" onclick="event.stopPropagation();" title="Send WhatsApp" style="text-decoration:none; font-size:16px;">üü¢</a>` : ''}
    </td>
    <td style="text-align: center;" title="Retail entry. Source & quality verification not recorded.">‚ùå Retail</td>
  </tr>
`;
          })
          .join("");

        recentTbody.innerHTML = rows;
        
        // Update inline quantities
        updateInlineQuantities();
      }
      
      // Update inline cow/buff quantities for today
      function updateInlineQuantities() {
        const today = fmtDate(new Date());
        const todays = entries.filter(e => e.day === today && e.farmerId === selectedFarmerId);
        
        let cowQty = 0;
        let buffQty = 0;
        
        todays.forEach(e => {
          if (e.animal === 'cow') {
            cowQty += Number(e.qty || 0);
          } else if (e.animal === 'buffalo') {
            buffQty += Number(e.qty || 0);
          }
        });
        
        if (el('cowQtyInline')) el('cowQtyInline').textContent = cowQty.toFixed(1);
        if (el('buffQtyInline')) el('buffQtyInline').textContent = buffQty.toFixed(1);
      }
      function viewProof(imgData) {
    if(!imgData) return;
    const w = window.open("");
    w.document.write(`<img src="${imgData}" style="max-width:100%;">`);
}

      function editEntry(id) {
    const entry = entries.find(e => e.id === id);
    if (!entry) return;

    // 1. Confirm karein (Trust Safe)
    if (!confirm("Do you want to edit this entry? It will update farmer balance.")) return;

    // 2. Pehle purani entry ka asar khatam karein (Balance reverse)
    const farmer = getFarmerById(entry.farmerId);
    if (farmer) {
        farmer.balance = round2(farmer.balance - entry.amount);
    }

    // 3. Data ko wapas form mein load karein
    selectedFarmerId = entry.farmerId;
    qty = entry.qty;
    fat = entry.fat;
    snf = entry.snf;
    animal = entry.animal;
    
    // 4. Entry ko mark karein taaki save hone par naya record na bane, purana update ho
    // (Simple rasta: purani entry delete karke naya form bhardein)
    entries = entries.filter(e => e.id !== id);
    saveEntries(entries);
    saveFarmers(farmers);

    renderAll();
    showToast("Editing: " + entry.farmerName + " ‚úèÔ∏è");
    el("qtyInput").focus();
}

      // Load farmer memory (previous values)
      function loadFarmerMemory(farmerId) {
        if (!farmerId) return;
        
        const memory = JSON.parse(localStorage.getItem('mr_farmer_memory') || '{}');
        const farmerMemory = memory[farmerId];
        
        if (farmerMemory) {
          // Auto-fill previous values
          if (farmerMemory.animal) animal = farmerMemory.animal;
          if (farmerMemory.fat) {
            fat = farmerMemory.fat;
            if (fatInput) fatInput.value = fat.toFixed(1);
          }
          if (farmerMemory.snf) {
            snf = farmerMemory.snf;
            if (snfInput) snfInput.value = snf.toFixed(1);
          }
          if (farmerMemory.rate) {
            if (manualRateInput) manualRateInput.value = farmerMemory.rate;
          }
          
          console.log('‚úÖ Loaded farmer memory:', farmerMemory);
        }
      }
      
      // Save farmer memory
      function saveFarmerMemory(farmerId) {
        if (!farmerId) return;
        
        const memory = JSON.parse(localStorage.getItem('mr_farmer_memory') || '{}');
        
        memory[farmerId] = {
          animal: animal,
          fat: fat,
          snf: snf,
          rate: manualRateInput && manualRateInput.value ? Number(manualRateInput.value) : 0,
          lastUpdated: Date.now()
        };
        
        localStorage.setItem('mr_farmer_memory', JSON.stringify(memory));
      }

      function renderTrust() {
    const farmer = getFarmerById(selectedFarmerId);
    // ‚úÖ AUTO SELECT LOGIC:
  if (farmer && farmer.animalType) {
    if (farmer.animalType !== "both") {
      animal = farmer.animalType; // Cow ya Buffalo fix ho jayega
    }
    // Note: Agar 'both' hai toh purana selection hi rahega
  }

    // --- YE WALA BLOCK UPDATE KIYA HAI ---
    if (farmer) {
        const stdSNF = 8.5;
        // 1. Kisan ka naam aur uska type (Cow/Buffalo) dikhao
        const typeIcon = farmer.animalType === 'cow' ? 'üêÑ' : 'üêÉ';
        const typeText = farmer.animalType === 'both' ? 'üîÑ Both' : (farmer.animalType === 'cow' ? 'Cow' : 'Buffalo');

        let nameHTML = `${farmer.name} <small style="color:var(--muted)">(${typeIcon} ${typeText})</small>`;

        // 2. Agar Pani hai toh wo bhi dikhao
        if (snf > 0 && snf < stdSNF) {
            const waterPercent = round2(((stdSNF - snf) / stdSNF) * 100);
            nameHTML += `<br><span style="color:red; font-size:11px; font-weight:bold;">‚ö†Ô∏è Pani: ${waterPercent}%</span>`;
        }

        el("selectedName").innerHTML = nameHTML;
    } else {
        el("selectedName").textContent = "‚Äî";
    }
    // --------------------------------------

    const r = getRatePerLiter();
    const a = getAmount();

    rateView.textContent = `‚Çπ${r.toFixed(2)}`;
    amountView.textContent = `‚Çπ${a.toFixed(2)}`;
    trailMini.textContent = `${round2(qty).toFixed(1)} L √ó ‚Çπ${r.toFixed(2)}/L (Fat: ${fat.toFixed(1)}%)`;

    // Update inline cow/buff quantities
    updateInlineQuantities();

    const before = farmer ? farmerBalanceBefore(farmer) : 0;
    const after = round2(before + a);

    balBefore.textContent = `‚Çπ${before.toFixed(2)}`;
    balAfter.textContent = `‚Çπ${after.toFixed(2)}`;

    // steps + values
    if (el("qtyStep")) el("qtyStep").textContent = `¬±${settings.qtyStep}`;
    if (el("fatStep")) el("fatStep").textContent = `¬±${settings.fatStep}`;
    if (el("snfStep")) el("snfStep").textContent = `¬±${settings.snfStep}`;

    // Density Sync (Agar density dabba add kiya hai toh ye line add karein)
    if (el("densityInput") && document.activeElement !== el("densityInput")) {
        el("densityInput").value = clr;
    }

    // animal dropdown sync
    animalSelect.value = animal;

    // Manual rate UI - always show, pre-fill with current rate
    if (!manualRate || manualRate === 0) {
        rateTypeLabel.textContent = "Rate: Auto";
        // Auto mode: Pre-fill with current base rate
        if (manualRateInput) {
            manualRateInput.value = settings.cowBase ? Number(settings.cowBase).toFixed(2) : "";
        }
    } else {
        rateTypeLabel.textContent = "Rate: Manual";
        // Manual mode: Show user's entered value
        if (manualRateInput) {
            manualRateInput.value = manualRate.toFixed(2);
        }
    }
    manualRateRow.style.display = "flex";

    // HOLD badge
    const hold = loadHold();
    holdBadge.textContent = hold ? "HOLD ‚úÖ" : "";

    // recent today
    renderRecentToday();

    syncInputs();
    updateDailySummaryButton();
}

      function renderTodayLabel() {
        const d = new Date();
        el("todayLabel").textContent = `${fmtDate(d)} ‚Ä¢ ${autoSessionLabel()}`;
      }

      function renderAll() {
        ensureSelectedFarmer();
        renderFarmers();
        renderTrust();
        renderTodayLabel();
      }

      /***********************
       * HOLD + UNDO         *
       ***********************/
      function loadHold() {
        try {
          return JSON.parse(localStorage.getItem(LS.hold) || "null");
        } catch (e) {
          return null;
        }
      }
      function saveHold(obj) {
        if (!obj) localStorage.removeItem(LS.hold);
        else localStorage.setItem(LS.hold, JSON.stringify(obj));
      }

      function saveUndoToken(token) {
        localStorage.setItem(LS.lastUndo, JSON.stringify(token));
      }
      function loadUndoToken() {
        try {
          return JSON.parse(localStorage.getItem(LS.lastUndo) || "null");
        } catch (e) {
          return null;
        }
      }
      function clearUndoToken() {
        localStorage.removeItem(LS.lastUndo);
      }
      // Rate Chart kholne ka logic
function openRateTable() {
    const base = Number(settings.cowBase);
    el("chartBaseRate").textContent = base.toFixed(2);
    const tbody = el("rateTableBody");
    tbody.innerHTML = "";

    // FAT 4.0 se 9.0 tak ki list (0.1 ke gap par)
    for (let f = 4.0; f <= 9.0; f = round2(f + 0.1)) {
        const r = getAutoRatePerLiter(f, "cow"); // Default Cow rate dikhate hain chart mein
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td style="padding: 8px; border: 1px solid #f1f5f9; font-weight: bold;">${f.toFixed(1)}</td>
            <td style="padding: 8px; border: 1px solid #f1f5f9; color: var(--blue2); font-weight: 1000;">‚Çπ${r.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
    }
    el("rateTableOverlay").style.display = "flex";
}

function closeRateTable() {
    el("rateTableOverlay").style.display = "none";
}

// üéØ WHATSAPP PLAIN TEXT LOGIC
function sendRateChartWhatsApp() {
    const base = Number(settings.cowBase);
    let msg = `*ü•õ ‡§Ü‡§ú ‡§ï‡•Ä ‡§∞‡•á‡§ü ‡§≤‡§ø‡§∏‡•ç‡§ü - ‡§ó‡•ã‡§™‡§æ‡§≤ ‡§°‡•á‡§Ø‡§∞‡•Ä*\n`;
    msg += `Base Rate: ‚Çπ${base.toFixed(2)}\n`;
    msg += `---------------------------\n`;
    msg += `*FAT%* |   *RATE (‚Çπ/L)*\n`;
    msg += `---------------------------\n`;

    // Sirf main points bhejte hain taaki message zyada lamba na ho
    for (let f = 4.0; f <= 8.5; f = round2(f + 0.5)) {
        const r = getAutoRatePerLiter(f, "cow");
        msg += `${f.toFixed(1)} fat   ->   ‚Çπ${r.toFixed(2)}\n`;
    }

    msg += `---------------------------\n`;
    msg += `*‡§Ø‡§π ‡§∞‡•á‡§ü ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§ú‡§®‡§∞‡•á‡§ü‡•á‡§° ‡§π‡•à*`;

    const wpUrl = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(wpUrl, '_blank');
}
      function holdCurrent() {
        const h = {
          selectedFarmerId,
          qty,
          fat,
          snf,
          animal,
          rateMode,
          manualRate,
          at: Date.now(),
        };
        saveHold(h);
        showToast("HOLD saved");
        renderAll();
      }

      function restoreHoldIfAny() {
        const h = loadHold();
        if (!h) return;
        selectedFarmerId = h.selectedFarmerId || selectedFarmerId;
        qty = Number(h.qty) || 0;
        fat = Number(h.fat) || 0;
        snf = Number(h.snf) || 0;
        animal = h.animal || "cow";
        rateMode = h.rateMode || "auto";
        manualRate = Number(h.manualRate) || 0;
        manualRateInput.value = manualRate ? String(manualRate) : "";
        saveHold(null);
        showToast("HOLD restored");
        renderAll();
      }

      /***********************
       * SAVE ENTRY          *
       ***********************/
      function canSave() {
        if (!selectedFarmerId) return false;
        if (qty <= 0) return false;
        if (fat <= 0) return false;
        if (getRatePerLiter() <= 0) return false;
        return true;
      }
      // Point 2.6: Success Sound Feedback (No external file needed)
function playSuccessSound() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.type = 'sine'; 
    oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime); 
    gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.15);
}
      let isSaving = false; // Prevent double-save
      function saveEntry() {
    if (isSaving) {
        showToast("Already saving...");
        return;
    }
    if (!canSave()) {
        showToast("Need: Farmer + Qty + Fat");
        return;
    }
    const farmer = getFarmerById(selectedFarmerId);
    if (!farmer) {
        showToast("Select farmer");
        return;
    }

    isSaving = true; // Lock save

    const before = farmerBalanceBefore(farmer);
    const ratePerL = getRatePerLiter();
    const amount = getAmount();
    const after = round2(before + amount);

    // --- ‚úÖ POINT 3.4: GET PAYMENT MODE FROM UI ---
    const selectedPayMode = document.querySelector('input[name="payMode"]:checked').value;

    const currentRate = getRatePerLiter(); // üëà Usi second ka active rate uthao
    const currentAmount = getAmount();

    const entry = {
        id: uid("e"),
        farmerId: farmer.id,
        farmerName: farmer.name || "",
        qty: round2(qty),
        fat: round2(fat),
        snf: round2(snf),
        paymentMode: document.querySelector('input[name="payMode"]:checked').value,

        // üéØ SNAPSHOT LOGIC: Rate ko value ki tarah chipka do
        rateSnapshot: round2(currentRate),
        amount: round2(currentAmount),

        // Audit Metadata
        rateMode: rateMode, // auto ya manual
        animal: animal,
        session: autoSessionLabel(),
        createdAt: Date.now(),
        day: fmtDate(new Date()),
        deviceId: navigator.userAgent.slice(0, 40)
    };
    // --- DATA SAVING ---
    farmer.balance = after;
    saveFarmers(farmers);

    entries.push(entry);
    saveEntries(entries);
    
    // Save to backend if API mode is enabled
    if (window.USE_API && window.MilkBookAPI) {
      window.MilkBookAPI.milkEntries.create({
        farmer_id: farmer.id,
        day: entry.day,
        session: entry.session,
        animal: entry.animal,
        quantity: entry.qty,
        fat: entry.fat,
        snf: entry.snf,
        rate_per_l: entry.rateSnapshot,
        amount: entry.amount,
        reading_mode: 'manual',
        images: entry.images || []
      }).catch(error => {
        console.error('Failed to save to backend:', error);
      });
    }
    
    playSuccessSound();
    saveUndoToken({
        entryId: entry.id,
        farmerId: farmer.id,
        prevBalance: before,
    });

    // --- ‚úÖ RESET LOGIC FOR NEXT FARMER ---
    // Save farmer memory BEFORE reset
    saveFarmerMemory(farmer.id);
    
    qty = 0;
    fat = 0;
    snf = 0;
    manualRate = 0;
    if (el("manualRateInput")) el("manualRateInput").value = ""; 
    
    // Toggle ko wapas 'Cash' (‡§Ü‡§ú ‡§®‡§ï‡§¶) par le aao
    document.querySelector('input[name="payMode"][value="Cash"]').checked = true;
    if (typeof updatePayUI === "function") updatePayUI(); 

    currentEntryImage = null; 
    const imgInput = document.getElementById("fImageEntry");
    if(imgInput) imgInput.value = ""; 
    
    autoNextFarmer();
    renderAll();
    playSuccessSound(); // üîä Ye bajega har save par
    // --- ‚úÖ FEEDBACK ---
    if (typeof playSuccessSound === "function") playSuccessSound(); // üîä Ting!
    
    document.body.classList.add("flash-success");
    setTimeout(() => {
        document.body.classList.remove("flash-success");
    }, 600);

    // Snapshot update (‡§Ü‡§ú ‡§ï‡§æ ‡§π‡§ø‡§∏‡§æ‡§¨)
    if (typeof updateSnapshotData === "function") updateSnapshotData();

    updateDailySummaryButton();
    showToast(`Entry Saved (${selectedPayMode === 'Cash' ? '‡§®‡§ï‡§¶' : '‡§â‡§ß‡§æ‡§∞'}) ‚úÖ`);
    
    isSaving = false; // Unlock save
}
// Isse kisi bhi purani entry ka metadata check kar sakte hain
function showAuditProof(entryId) {
    const e = entries.find(x => x.id === entryId);
    if(!e) return;

    const content = el("entryDetailContent");
    const isEdited = e.edited ? "Yes" : "No";
    
    content.innerHTML = `
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:14px;">
            <div>Farmer: <br><span style="color:var(--blue)">${e.farmerName}</span></div>
            <div>Amount: <br><span style="color:var(--green)">‚Çπ${e.amount}</span></div>
            <hr style="grid-column: 1/-1; width:100%; opacity:0.2;">
            <div>Qty: ${e.qty} L</div>
            <div>Fat: ${e.fat}%</div>
            <div>SNF: ${e.snf}</div>
            <div>Rate Mode: ${e.rateMode.toUpperCase()}</div>
            <hr style="grid-column: 1/-1; width:100%; opacity:0.2;">
            <div style="font-size:11px; color:var(--muted);">Recorded: ${new Date(e.createdAt).toLocaleString()}</div>
            <div style="font-size:11px; color:var(--muted);">Source: ${e.entrySource}</div>
            <div style="font-size:11px; color:var(--muted);">Device ID: ${e.deviceId}</div>
            <div style="font-size:11px; color:var(--muted);">Edited: ${isEdited}</div>
        </div>
        ${e.images && e.images.length > 0 ? `<div style="margin-top:15px;"><label>Photo Proof:</label><img src="${e.images[0]}" style="width:100%; border-radius:10px; margin-top:5px;"></div>` : ''}
    `;

    // WhatsApp Button Logic for this single entry
    el("btnSendSingleProof").onclick = () => {
        const f = getFarmerById(e.farmerId);
        const msg = `*Milk Entry Proof* ü•õ\nFarmer: ${e.farmerName}\nQty: ${e.qty}L | Fat: ${e.fat}%\nAmount: ‚Çπ${e.amount}\nTime: ${new Date(e.createdAt).toLocaleString()}\nSource: ${e.entrySource}\nGopal Dairy Shop`;
        window.open(`https://wa.me/${f.phone}?text=${encodeURIComponent(msg)}`, '_blank');
    };

    openOverlay("overlayEntryDetail");
}
      function autoNextFarmer() {
        const list = filterFarmers();
        const idx = list.findIndex((f) => f.id === selectedFarmerId);
        if (idx >= 0 && idx < list.length - 1) {
          selectedFarmerId = list[idx + 1].id;
        }
      }

      function undoLast() {
        const token = loadUndoToken();
        if (!token) {
          showToast("Nothing to undo");
          return;
        }

        const idx = entries.findIndex((e) => e.id === token.entryId);
        if (idx < 0) {
          clearUndoToken();
          showToast("Undo not found");
          return;
        }

        // Restore farmer balance
        const farmer = getFarmerById(token.farmerId);
        if (farmer) {
          farmer.balance = round2(Number(token.prevBalance) || 0);
          saveFarmers(farmers);
        }

        // Remove entry
        entries.splice(idx, 1);
        saveEntries(entries);

        clearUndoToken();
        showToast("UNDO ‚úÖ");
        renderAll();
      }

      /***********************
       * HISTORY + EXPORT     *
       ***********************/
      function entriesToday() {
        const today = fmtDate(new Date());
        return entries
          .filter((e) => e.day === today)
          .sort((a, b) => b.createdAt - a.createdAt);
      }
      function entriesWeek() {
        const start = daysAgo(6).getTime();
        return entries
          .filter((e) => e.createdAt >= start)
          .sort((a, b) => b.createdAt - a.createdAt);
      }

      function makeEntryCard(e) {
        const t = fmtTime(new Date(e.createdAt));
        const icon = e.animal === "buffalo" ? "üêÉ" : "üêÑ";
        const rt = e.rateMode === "manual" ? "Manual" : "Auto";
        return `
    <div class="cardRow">
      <div style="min-width:0; flex: 1;">
        <div class="title">${escapeHtml(e.farmerName || "")}</div>
        <div class="meta">${t} ‚Ä¢ ${icon} <strong style="color: #16a34a; font-size: 15px;">${e.qty} L</strong> ‚Ä¢ Fat ${e.fat}% ‚Ä¢ SNF ${e.snf} ‚Ä¢ ${rt}</div>
      </div>
      <div class="val">‚Çπ${Number(e.amount || 0).toFixed(2)}</div>
    </div>
  `;
      }

      function renderHistory() {
        const today = entriesToday();
        const week = entriesWeek();

        el("historyTitleRight").textContent =
          `${today.length} today ‚Ä¢ ${week.length} in 7d`;

        const tMax = Math.max(0, Math.ceil(today.length / LIST_PER_PAGE) - 1);
        if (todayPage > tMax) todayPage = tMax;
        const tSlice = today.slice(
          todayPage * LIST_PER_PAGE,
          todayPage * LIST_PER_PAGE + LIST_PER_PAGE,
        );
        el("todayList").innerHTML =
          tSlice.map(makeEntryCard).join("") ||
          `<div style="color:var(--muted);font-weight:1100;">No entries</div>`;
        el("todayPageInfo").textContent =
          `Page ${today.length ? todayPage + 1 : 0}/${today.length ? tMax + 1 : 0}`;
        el("todayPrev").disabled = todayPage <= 0;
        el("todayNext").disabled = todayPage >= tMax;

        const wMax = Math.max(0, Math.ceil(week.length / LIST_PER_PAGE) - 1);
        if (weekPage > wMax) weekPage = wMax;
        const wSlice = week.slice(
          weekPage * LIST_PER_PAGE,
          weekPage * LIST_PER_PAGE + LIST_PER_PAGE,
        );
        el("weekList").innerHTML =
          wSlice.map(makeEntryCard).join("") ||
          `<div style="color:var(--muted);font-weight:1100;">No entries</div>`;
        el("weekPageInfo").textContent =
          `Page ${week.length ? weekPage + 1 : 0}/${week.length ? wMax + 1 : 0}`;
        el("weekPrev").disabled = weekPage <= 0;
        el("weekNext").disabled = weekPage >= wMax;
      }

      function exportJSON() {
        const payload = {
          exportedAt: new Date().toISOString(),
          settings,
          farmers,
          entries,
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `milkapp_export_${fmtDate(new Date())}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast("Exported ‚úÖ");
      }

      function clearToday() {
        const today = fmtDate(new Date());
        const beforeLen = entries.length;
        entries = entries.filter((e) => e.day !== today);
        saveEntries(entries);
        showToast(
          entries.length !== beforeLen ? "Today cleared" : "No entries today",
        );
        renderHistory();
        renderAll();
      }

      /***********************
       * LEADERBOARD         *
       ***********************/
      function buildLeader() {
        const week = entriesWeek();
        const map = new Map();
        week.forEach((e) => {
          const cur = map.get(e.farmerId) || {
            farmerId: e.farmerId,
            name: e.farmerName,
            amount: 0,
            liters: 0,
            count: 0,
          };
          cur.amount = round2(cur.amount + Number(e.amount || 0));
          cur.liters = round2(cur.liters + Number(e.qty || 0));
          cur.count = cur.count + 1;
          map.set(e.farmerId, cur);
        });
        let arr = Array.from(map.values());
        arr.sort((a, b) => {
          if (leaderMode === "amount") return b.amount - a.amount;
          if (leaderMode === "liters") return b.liters - a.liters;
          return b.count - a.count;
        });
        return arr;
      }

      function renderLeader() {
        const leaders = buildLeader();
        const maxPage = Math.max(
          0,
          Math.ceil(leaders.length / LEADER_PER_PAGE) - 1,
        );
        if (leaderPage > maxPage) leaderPage = maxPage;

        const slice = leaders.slice(
          leaderPage * LEADER_PER_PAGE,
          leaderPage * LEADER_PER_PAGE + LEADER_PER_PAGE,
        );

        el("leaderRight").textContent =
          `${leaders.length} farmers ‚Ä¢ sorted by ${leaderMode}`;

        el("leaderPageInfo").textContent =
          `Page ${leaders.length ? leaderPage + 1 : 0}/${leaders.length ? maxPage + 1 : 0}`;

        el("leaderPrev").disabled = leaderPage <= 0;
        el("leaderNext").disabled = leaderPage >= maxPage;

        el("leaderList").innerHTML =
          slice
            .map(
              (l) => `
      <div class="cardRow">
        <div style="min-width:0;">
          <div class="title">${escapeHtml(l.name || "")}</div>
          <div class="meta">
            ‚Çπ${l.amount.toFixed(2)} ‚Ä¢ ${l.liters.toFixed(1)} L ‚Ä¢ ${l.count} entries
          </div>
        </div>
        <div class="val">
          ${
            leaderMode === "amount"
              ? "‚Çπ" + l.amount.toFixed(2)
              : leaderMode === "liters"
                ? l.liters.toFixed(1) + " L"
                : l.count
          }
        </div>
      </div>
    `,
            )
            .join("") ||
          `<div style="color:var(--muted);font-weight:1100;">No data</div>`;
      }

      /***********************
       * OVERLAYS HELPERS    *
       ***********************/
      function openOverlay(id) {
        document.getElementById(id).style.display = "flex";
        if (id === "overlayHistory") renderHistory();
        if (id === "overlayLeader") renderLeader();
      }
      function closeOverlay(id) {
        document.getElementById(id).style.display = "none";
      }

      /***********************
       * EVENTS              *
       ***********************/
      // Farmer search
      searchInput.addEventListener("input", (e) => {
        farmerSearch = e.target.value;
        farmerPage = 0;
        renderFarmers();
      });

      // Paging
      el("prevFarmers").onclick = () => {
        farmerPage--;
        renderFarmers();
      };
      el("nextFarmers").onclick = () => {
        farmerPage++;
        renderFarmers();
      };

      // Qty / Fat / SNF controls
      // };// Manual Typing Listener: Jaise hi dabba mein likhoge, summary badal jayegi
el("qtyInput").oninput = (e) => { qty = Number(e.target.value) || 0; renderTrust(); };
el("fatInput").oninput = (e) => { fat = Number(e.target.value) || 0; renderTrust(); };
el("snfInput").oninput = (e) => { snf = Number(e.target.value) || 0; renderTrust(); };
// --- YAHAN PASTE KAREIN ---
el("qtyInput").oninput = (e) => {
  qty = Number(e.target.value) || 0;
  renderTrust();
};

// Density (CLR) Input Listener
el("densityInput").oninput = (e) => {
  clr = Number(e.target.value) || 0;
  calculateSNFFromCLR(); // Ye SNF nikalega
  renderTrust(); 
};

// Fat Input Listener
el("fatInput").oninput = (e) => {
  fat = Number(e.target.value) || 0;
  calculateSNFFromCLR(); // Fat badla toh SNF bhi apne aap badlega
  renderTrust();
};

el("snfInput").oninput = (e) => {
  snf = Number(e.target.value) || 0;
  renderTrust();
};

      // Animal
      animalSelect.onchange = (e) => {
        animal = e.target.value;
        renderTrust();
      };

      // Manual rate override
      el("manualRateApply").onclick = () => {
        manualRate = Number(manualRateInput.value) || 0;
        renderTrust();
      };
      
      // Clear manual rate on farmer change
      function clearManualRate() {
        manualRate = 0;
        if (manualRateInput) manualRateInput.value = '';
      }

      // Save / Hold / Undo
      el("btnSave").onclick = saveEntry;
      el("btnHold").onclick = holdCurrent;
      el("btnUndo").onclick = undoLast;

      // History (if button exists)
      if (el("btnHistoryMain")) {
        el("btnHistoryMain").onclick = () => openOverlay("overlayHistory");
      }
      el("todayPrev").onclick = () => {
        todayPage--;
        renderHistory();
      };
      el("todayNext").onclick = () => {
        todayPage++;
        renderHistory();
      };
      el("weekPrev").onclick = () => {
        weekPage--;
        renderHistory();
      };
      el("weekNext").onclick = () => {
        weekPage++;
        renderHistory();
      };
      el("btnExport").onclick = exportJSON;
      el("btnClearToday").onclick = clearToday;
      
      // Logout function
      function logout() {
          if (confirm('Are you sure you want to logout?')) {
              // Clear session
              localStorage.removeItem('milkbook_session');

              showToast('Logged out successfully!');

              // Redirect to login page
              setTimeout(() => {
                  window.location.href = 'login.html';
              }, 500);
          }
      }
      
      // Toggle profile dropdown
      function toggleProfileDropdown() {
          const dropdown = document.getElementById('profileDropdown');
          dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
          
          // Load user info
          const session = localStorage.getItem('milkbook_session');
          if (session) {
              const data = JSON.parse(session);
              document.getElementById('profileName').textContent = data.shop_name || 'User';
              document.getElementById('dropdownEmail').textContent = data.email || 'user@email.com';
              document.getElementById('dropdownShop').textContent = data.shop_name || 'Shop';
          }
      }
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
          const dropdown = document.getElementById('profileDropdown');
          const button = e.target.closest('button');
          if (dropdown && (!button || !button.onclick?.toString().includes('toggleProfileDropdown'))) {
              dropdown.style.display = 'none';
          }
      });

      // Leader
      el("btnLeader").onclick = () => openOverlay("overlayLeader");
      el("leaderPrev").onclick = () => {
        leaderPage--;
        renderLeader();
      };
      el("leaderNext").onclick = () => {
        leaderPage++;
        renderLeader();
      };

      el("btnLeaderByAmt").onclick = () => {
        leaderMode = "amount";
        leaderPage = 0;
        renderLeader();
      };
      el("btnLeaderByLit").onclick = () => {
        leaderMode = "liters";
        leaderPage = 0;
        renderLeader();
      };
      el("btnLeaderByCount").onclick = () => {
        leaderMode = "count";
        leaderPage = 0;
        renderLeader();
      };

      // Settings
      el("btnSettings").onclick = () => openOverlay("overlaySettings");
      el("btnSaveSettings").onclick = () => {
        settings.cowBase = Number(el("setCowBase").value) || settings.cowBase;
        settings.cowFactor =
          Number(el("setCowFactor").value) || settings.cowFactor;
        settings.buffBase =
          Number(el("setBuffBase").value) || settings.buffBase;
        settings.buffFactor =
          Number(el("setBuffFactor").value) || settings.buffFactor;
        settings.qtyStep = Number(el("setQtyStep").value) || settings.qtyStep;
        settings.fatStep = Number(el("setFatStep").value) || settings.fatStep;
        settings.snfStep = Number(el("setSnfStep").value) || settings.snfStep;
        settings.sessionSwitchHour =
          Number(el("setSessionHour").value) || settings.sessionSwitchHour;
        saveSettings(settings);
        showToast("Settings saved");
        renderAll();
      };

      // Add farmer modal
      window.addEventListener('DOMContentLoaded', function() {
        const addBtn = el("btnAddFarmerMain");
        if (addBtn) {
          addBtn.onclick = () => openOverlay("overlayFarmer");
          console.log('‚úÖ + Farmer button initialized');
        } else {
          console.error('‚ùå + Farmer button not found!');
        }
      });
      
      el("btnCreateFarmer").onclick = async () => {
        const f = {
          name: el("fName").value.trim(),
          phone: el("fPhone").value.trim(),
          address: el("fAddress").value.trim(),
          balance: Number(el("fBalance").value) || 0,
          active: el("fActive").value === "1",
          animalType: el("fAnimalType").value
        };
        if (!f.name) {
          showToast("Name required");
          console.error('‚ùå Farmer creation failed: Name is required');
          return;
        }

        const btn = el("btnCreateFarmer");
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Creating...';

        try {
          // Create farmer via API
          const response = await fetch('/api/farmers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(f)
          });

          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.message || 'Failed to create farmer');
          }

          console.log('‚úÖ Farmer created in Supabase:', result.farmer.id);

          // Also save locally for immediate UI
          const localFarmer = {
            id: result.farmer.id,
            ...f
          };
          farmers.push(localFarmer);
          saveFarmers(farmers);

          selectedFarmerId = localFarmer.id;
          closeOverlay("overlayFarmer");
          renderAll();
          showToast("Farmer created in Supabase! ‚úÖ");

        } catch (error) {
          console.error('Error creating farmer:', error);
          showToast('‚ùå Failed: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = '‚úÖ Create';
        }
      };

      // Close overlays
      document.querySelectorAll("[data-close]").forEach((b) => {
        b.onclick = () => closeOverlay(b.dataset.close);
      });
      //  A. AUTO FOCUS: Load hote hi search par cursor
      window.addEventListener("load", () => {
        if (el("searchInput")) el("searchInput").focus();
      });

      // 1. Translation Map
      const translations = {
        en: {
          station: "Milk Intake Station",
          history: "History",
          liters: "2. Liters (L)",
          fat: "3. Fat %",
          snf: "4. SNF",
          animal: "5. Animal Type",
          summary: "Summary",
          totalAmt: "TOTAL AMOUNT",
          oldBal: "OLD BALANCE",
          newBal: "NEW BALANCE",
          recent: "RECENT TODAY",
          save: "SAVE ENTRY",
          hold: "HOLD",
          undo: "UNDO",
        },
        hi: {
          station: "‡§¶‡•Ç‡§ß ‡§∏‡§Ç‡§ï‡§≤‡§® ‡§∏‡•ç‡§ü‡•á‡§∂‡§®",
          history: "‡§á‡§§‡§ø‡§π‡§æ‡§∏",
          liters: "2. ‡§≤‡•Ä‡§ü‡§∞ (L)",
          fat: "3. ‡§´‡•à‡§ü %",
          snf: "4. SNF",
          animal: "5. ‡§™‡§∂‡•Å ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞",
          summary: "‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂",
          totalAmt: "‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø",
          oldBal: "‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ",
          newBal: "‡§®‡§Ø‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ",
          recent: "‡§Ü‡§ú ‡§ï‡•á ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°",
          save: "‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç",
          hold: "‡§π‡•ã‡§≤‡•ç‡§° ‡§ï‡§∞‡•á‡§Ç",
          undo: "‡§µ‡§æ‡§™‡§∏ (Undo)",
        },
      };

      // 2. Language Toggle Function
      el("langSwitch").onclick = () => {
        currentLang = currentLang === "en" ? "hi" : "en";
        const t = translations[currentLang];
        const isHi = currentLang === "hi";
         el("btnIntakeText").textContent = t.intake;
        // UI Elements Update (Ensure these IDs exist in your HTML)
        if (el("stationTitle")) el("stationTitle").textContent = t.station;
        if (el("btnHistoryMain"))
          el("btnHistoryMain").innerHTML = "üßæ " + t.history;

        // Inputs Section
        if (el("qtyLabel")) el("qtyLabel").textContent = t.liters; // HTML mein <div> ko id="qtyLabel" de dena
        if (el("fatLabel")) el("fatLabel").textContent = t.fat;
        if (el("snfLabel")) el("snfLabel").textContent = t.snf;

        // Summary Section
        if (el("summaryTitle")) el("summaryTitle").textContent = t.summary;
        if (el("amtLabel")) el("amtLabel").textContent = t.totalAmt;
        if (el("oldBalLabel")) el("oldBalLabel").textContent = t.oldBal;
        if (el("newBalLabel")) el("newBalLabel").textContent = t.newBal;
        if (el("recentTitle")) el("recentTitle").textContent = t.recent;

        // Footer Buttons
        if (el("btnSave"))
          el("btnSave").innerHTML = (isHi ? "üü¢ " : "") + t.save;
        if (el("btnHold"))
          el("btnHold").innerHTML =
            (isHi ? "üü° " : "") +
            t.hold +
            ' <span class="subnote">pause</span>';
        if (el("btnUndo"))
          el("btnUndo").innerHTML =
            (isHi ? "üî¥ " : "") + t.undo + ' <span class="subnote">last</span>';

        showToast(isHi ? "‡§≠‡§æ‡§∑‡§æ: ‡§π‡§ø‡§Ç‡§¶‡•Ä" : "Language: English");
      };
      // 1. Language Toggle Logic (Add this fresh)
      let currentLang = "en";

      el("langSwitch").onclick = () => {
        currentLang = currentLang === "en" ? "hi" : "en";
        const isHi = currentLang === "hi";

        // --- 1. Main Labels Update ---
        // (In IDs ko apne HTML tags mein check kar lena, agar nahi hain toh add kar lena)
        if (el("stationTitle"))
          el("stationTitle").textContent = isHi
            ? "‡§¶‡•Ç‡§ß ‡§∏‡§Ç‡§ï‡§≤‡§® ‡§∏‡•ç‡§ü‡•á‡§∂‡§®"
            : "Milk Intake Station";
        if (el("shopTitle"))
          el("shopTitle").textContent = isHi
            ? "‡§ó‡•ã‡§™‡§æ‡§≤ ‡§°‡•á‡§Ø‡§∞‡•Ä ‡§∂‡•â‡§™"
            : "Gopal Dairy Shop";

        // Labels for Inputs
        if (el("qtyLabel"))
          el("qtyLabel").textContent = isHi ? "2. ‡§≤‡•Ä‡§ü‡§∞ (L)" : "2. Liters (L)";
        if (el("fatLabel"))
          el("fatLabel").textContent = isHi ? "3. ‡§´‡•à‡§ü %" : "3. Fat %";
        if (el("snfLabel"))
          el("snfLabel").textContent = isHi ? "4. SNF" : "4. SNF";
        // --- 1. HISTORY MODAL ---
        if (el("historyTitle"))
          el("historyTitle").textContent = isHi
            ? "‡§á‡§§‡§ø‡§π‡§æ‡§∏ (‡§Ü‡§ú + ‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï)"
            : "History (Today + Weekly)";
        document.querySelectorAll("#overlayHistory h3")[0].textContent = isHi
          ? "üìÖ ‡§Ü‡§ú"
          : "üìÖ Today";
        document.querySelectorAll("#overlayHistory h3")[1].textContent = isHi
          ? "üóìÔ∏è ‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï"
          : "üóìÔ∏è Weekly";
        if (el("btnReceipt"))
          el("btnReceipt").innerHTML = isHi ? "üì© ‡§∞‡§∏‡•Ä‡§¶" : "üì© Receipt";
        if (el("btnExport"))
          el("btnExport").innerHTML = isHi ? "‚¨áÔ∏è ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü" : "‚¨áÔ∏è Export";
        if (el("btnClearToday"))
          el("btnClearToday").innerHTML = isHi
            ? "üóëÔ∏è ‡§Ü‡§ú ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç"
            : "üóëÔ∏è Clear Today";

        // --- 2. LEADERBOARD MODAL ---
        if (el("leaderTitle"))
          el("leaderTitle").textContent = isHi
            ? "üèÜ ‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï ‡§≤‡•Ä‡§°‡§∞"
            : "üèÜ Weekly Leader";
        document.querySelector("#overlayLeader h3").textContent = isHi
          ? "‡§ü‡•â‡§™ ‡§ï‡§ø‡§∏‡§æ‡§® (7 ‡§¶‡§ø‡§®)"
          : "Top Farmers (7 days)";
        if (el("btnLeaderByAmt"))
          el("btnLeaderByAmt").innerHTML = isHi ? "üí∞ ‡§∞‡§æ‡§∂‡§ø" : "üí∞ Amount";
        if (el("btnLeaderByLit"))
          el("btnLeaderByLit").innerHTML = isHi ? "ü•õ ‡§≤‡•Ä‡§ü‡§∞" : "ü•õ Liters";
        if (el("btnLeaderByCount"))
          el("btnLeaderByCount").innerHTML = isHi
            ? "üßæ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ"
            : "üßæ Entries";

        // --- 3. SETTINGS MODAL ---
        if (el("settingsTitle"))
          el("settingsTitle").textContent = isHi
            ? "‚öôÔ∏è ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏"
            : "‚öôÔ∏è Settings";
        document.querySelector("#overlaySettings h3").textContent = isHi
          ? "üí∞ ‡§∞‡•á‡§ü ‡§´‡§æ‡§∞‡•ç‡§Æ‡•Ç‡§≤‡§æ"
          : "üí∞ Rate Formula";
        /// --- Animal Selection Translation ---
        const animalOptionCow = document.querySelector('option[value="cow"]');
        const animalOptionBuff = document.querySelector(
          'option[value="buffalo"]',
        );

        if (animalOptionCow) {
          animalOptionCow.textContent = isHi ? "üêÑ ‡§ó‡§æ‡§Ø (Cow)" : "üêÑ Cow";
        }
        if (animalOptionBuff) {
          animalOptionBuff.textContent = isHi
            ? "üêÉ ‡§≠‡•à‡§Ç‡§∏ (Buffalo)"
            : "üêÉ Buffalo";
        }

        // Agar aapne Radio buttons laga liye hain (jo maine pehle bataya tha), toh ye use karein:
        if (el("labelCow"))
          el("labelCow").textContent = isHi ? "üêÑ ‡§ó‡§æ‡§Ø" : "üêÑ Cow";
        if (el("labelBuffalo"))
          el("labelBuffalo").textContent = isHi ? "üêÉ ‡§≠‡•à‡§Ç‡§∏" : "üêÉ Buffalo";

        if (el("btnSaveSettings"))
          el("btnSaveSettings").innerHTML = isHi ? "‚úÖ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç" : "‚úÖ Save";
        if (el("btnResetSettings"))
          el("btnResetSettings").innerHTML = isHi ? "‚ôªÔ∏è ‡§∞‡§ø‡§∏‡•á‡§ü" : "‚ôªÔ∏è Reset";
        if (el("btnFactoryReset"))
          el("btnFactoryReset").innerHTML = isHi
            ? "üß® ‡§´‡•à‡§ï‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§∞‡§ø‡§∏‡•á‡§ü"
            : "üß® Factory Reset";

        // --- 4. ADD FARMER MODAL ---
        if (el("addFarmerTitle"))
          el("addFarmerTitle").textContent = isHi
            ? "‚ûï ‡§ï‡§ø‡§∏‡§æ‡§® ‡§ú‡•ã‡•ú‡•á‡§Ç"
            : "‚ûï Add Farmer";
        document.querySelector("#overlayFarmer h3").textContent = isHi
          ? "üë§ ‡§ï‡§ø‡§∏‡§æ‡§® ‡§´‡•â‡§∞‡•ç‡§Æ"
          : "üë§ Farmer Form";
        const farmerLabels = document.querySelectorAll(
          "#overlayFarmer .field label",
        );
        const farmerHindi = [
          "üë§ ‡§®‡§æ‡§Æ",
          "üì± ‡§®‡§Ç‡§¨‡§∞",
          "üìç ‡§™‡§§‡§æ",
          "üñºÔ∏è ‡§´‡•ã‡§ü‡•ã",
          "‚Çπ ‡§ì‡§™‡§®‡§ø‡§Ç‡§ó ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏",
          "‡§∏‡•ç‡§ü‡•á‡§ü‡§∏",
        ];
        const farmerEng = [
          "üë§ Name",
          "üì± Number",
          "üìç Address",
          "üñºÔ∏è Image",
          "‚Çπ Opening Balance",
          "Status",
        ];
        farmerLabels.forEach(
          (lbl, i) => (lbl.textContent = isHi ? farmerHindi[i] : farmerEng[i]),
        );

        if (el("btnCreateFarmer"))
          el("btnCreateFarmer").innerHTML = isHi ? "‚úÖ ‡§¨‡§®‡§æ‡§è‡§Ç" : "‚úÖ Create";
        if (el("btnDemoFarmers"))
          el("btnDemoFarmers").innerHTML = isHi
            ? "üß™ ‡§°‡•á‡§Æ‡•ã ‡§ï‡§ø‡§∏‡§æ‡§®"
            : "üß™ Demo Farmers";

        // --- 5. RECEIPT MODAL ---
        if (el("receiptTitle"))
          el("receiptTitle").textContent = isHi ? "üì© ‡§∞‡§∏‡•Ä‡§¶" : "üì© Receipt";
        document.querySelector("#overlayReceipt h3").textContent = isHi
          ? "üßæ ‡§∏‡§Ç‡§¶‡•á‡§∂"
          : "üßæ Message";
        if (el("btnCopyReceipt"))
          el("btnCopyReceipt").innerHTML = isHi ? "üìã ‡§ï‡•â‡§™‡•Ä" : "üìã Copy";
        if (el("btnWhatsApp"))
          el("btnWhatsApp").innerHTML = isHi ? "üí¨ ‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™" : "üí¨ WhatsApp";
        if (el("btnCloseReceipt"))
          el("btnCloseReceipt").innerHTML = isHi ? "‚úÖ ‡§™‡•Ç‡§∞‡•ç‡§£" : "‚úÖ Done";

        // Summary Labels
        if (el("amtLabel"))
          el("amtLabel").textContent = isHi ? "‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø" : "TOTAL AMOUNT";
        if (el("oldBalLabel"))
          el("oldBalLabel").textContent = isHi ? "‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ" : "OLD BALANCE";
        if (el("newBalLabel"))
          el("newBalLabel").textContent = isHi ? "‡§®‡§Ø‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ" : "NEW BALANCE";
        if (el("recentTitle"))
          el("recentTitle").textContent = isHi
            ? "‡§Ü‡§ú ‡§ï‡•á ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°"
            : "RECENT TODAY";

        // --- 2. Buttons Update ---
        if (el("btnSave"))
          el("btnSave").innerHTML = isHi
            ? "üü¢ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç"
            : "üü¢ SAVE ENTRY";
        if (el("btnHold"))
          el("btnHold").innerHTML = isHi ? "üü° ‡§π‡•ã‡§≤‡•ç‡§° ‡§ï‡§∞‡•á‡§Ç" : "üü° HOLD";
        if (el("btnUndo"))
          el("btnUndo").innerHTML = isHi ? "üî¥ ‡§µ‡§æ‡§™‡§∏ (Undo)" : "üî¥ UNDO";

        // --- 3. Table Headers Update (Jo tune pucha tha) ---
        const ths = document.querySelectorAll("table thead th");
        if (ths.length >= 8) {
          const hindiHeaders = [
            "‡§§‡§æ‡§∞‡•Ä‡§ñ",
            "‡§ï‡§ø‡§∏‡§æ‡§®",
            "‡§∂‡§ø‡§´‡•ç‡§ü",
            "‡§™‡•ç‡§∞‡§ï‡§æ‡§∞",
            "‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ",
            "‡§´‡•à‡§ü",
            "SNF",
            "‡§∞‡§æ‡§∂‡§ø",
          ];
          const engHeaders = [
            "DATE",
            "FARMER",
            "SESSION",
            "TYPE",
            "QTY",
            "FAT",
            "SNF",
            "AMT",
          ];

          ths.forEach((th, i) => {
            th.textContent = isHi ? hindiHeaders[i] : engHeaders[i];
          });
        }

        showToast(isHi ? "‡§≠‡§æ‡§∑‡§æ: ‡§π‡§ø‡§Ç‡§¶‡•Ä" : "Language: English");
      };


  // --- MASTER NAVIGATION: Arrows & Enter (Main Screen + Form) ---
document.addEventListener('keydown', (e) => {
    const active = document.activeElement;
    const isFarmerModalOpen = el("overlayFarmer").style.display === "flex";

    // 1. ADD FARMER FORM LOGIC (Sirf tab chalega jab Form khula ho)
    if (isFarmerModalOpen) {
        const formOrder = ["fName", "fPhone", "fAddress", "fImage", "fBalance", "fAnimalType", "fActive", "btnCreateFarmer"];
        const curIdx = formOrder.indexOf(active.id);

        if (e.key === "Enter") {
            e.preventDefault();
            
            // On fBalance ‚Üí Move to Animal Type selection
            if (active.id === "fBalance") {
                el("fAnimalType").focus();
                return;
            }
            
            // On fAnimalType or fActive ‚Üí Create farmer
            if (active.id === "fAnimalType" || active.id === "fActive") {
                el("btnCreateFarmer").click();
                setTimeout(() => {
                  el("searchInput").focus();
                }, 150);
                return;
            }
            
            // On Create button ‚Üí Create farmer
            if (active.id === "btnCreateFarmer") {
                el("btnCreateFarmer").click();
                setTimeout(() => {
                  el("searchInput").focus();
                }, 150);
                return;
            }
            
            // Move to next field
            if (curIdx !== -1 && curIdx < formOrder.length - 1) {
                el(formOrder[curIdx + 1]).focus();
                if (el(formOrder[curIdx + 1]).tagName === "INPUT") el(formOrder[curIdx + 1]).select();
            }
        }

        if (e.key === "ArrowRight" || e.key === "ArrowLeft") {
            if (active.id === "fAddress") return; // Textarea mein typing ke liye arrows chhod do
            e.preventDefault();
            if (e.key === "ArrowRight" && curIdx < formOrder.length - 1) {
                el(formOrder[curIdx + 1]).focus();
            } else if (e.key === "ArrowLeft" && curIdx > 0) {
                el(formOrder[curIdx - 1]).focus();
            }
        }
        return; // Modal ka kaam khatam, niche wala main screen code nahi chalega
    }

    // 2. MAIN SCREEN LOGIC (Sirf tab chalega jab Form BAND ho)
    if (e.key === "ArrowRight" || e.key === "ArrowLeft") {
        if (active.classList.contains("fcard")) {
            e.preventDefault();
            const cards = Array.from(el("farmerGrid").children);
            const list = filterFarmers();
            const idx = cards.indexOf(active);
            let nextIdx = e.key === "ArrowRight" ? idx + 1 : idx - 1;
            
            if (nextIdx >= 0 && nextIdx < cards.length && list[nextIdx]) {
                cards[nextIdx].focus();
                selectedFarmerId = list[nextIdx].id;
                renderTrust(); 
            }
        }
        // --- QTY INPUT PAR SHIFT + ENTER KA LOGIC ---
else if (active.id === "qtyInput") {
    // Agar Shift + Enter dabayein toh seedha Advance modal khule
    if (e.shiftKey && e.key === "Enter") {
        e.preventDefault();
        if (selectedFarmerId) {
            openFarmerDetail(selectedFarmerId);
        }
    } 
    // Normal Enter se agle field (Fat) par jaye
    else if (e.key === "Enter") {
        e.preventDefault();
        el("fatInput").focus();
    }
}
    }

    if (e.key === "Enter") {
        e.preventDefault();
        if (active.id === "searchInput") {
            const firstCard = el("farmerGrid").querySelector('.fcard');
            if (firstCard) firstCard.focus();
        } 
        else if (active.classList.contains("fcard")) {
            const list = filterFarmers();
            const cards = Array.from(el("farmerGrid").children);
            const idx = cards.indexOf(active);
            if (list[idx]) {
                selectedFarmerId = list[idx].id;
                renderAll(); 
                setTimeout(() => {
                    el("qtyInput").focus();
                    el("qtyInput").select();
                }, 50); 
            }
        }
        else if (active.id === "qtyInput") el("fatInput").focus();
        else if (active.id === "fatInput") el("densityInput").focus();
        else if (active.id === "densityInput") el("snfInput").focus();
        else if (active.id === "snfInput") el("btnRateModeAuto").focus();
        else if (active.id === "btnRateModeAuto" || active.id === "btnRateModeManual") el("btnSave").focus();
        else if (active.id === "btnSave") {
            saveEntry();
            el("searchInput").focus(); 
            el("searchInput").value = "";
        }
    }
});

// --- FINANCIAL TRUST: ADVANCE LOGIC ---
function openFarmerDetail(fId) {
    const f = getFarmerById(fId);
    if (!f) return;
    selectedFarmerId = fId;
    el("detailFarmerName").textContent = f.name;
    el("detailAdvance").textContent = `‚Çπ${round2(f.advance || 0).toFixed(2)}`;

    const now = new Date();
    const monthEntries = entries.filter(e => e.farmerId === fId && new Date(e.createdAt).getMonth() === now.getMonth());
    const totalL = monthEntries.reduce((sum, e) => sum + Number(e.qty || 0), 0);
    el("detailMonthlyMilk").textContent = `${totalL.toFixed(1)} L`;
    openOverlay("overlayFarmerDetail");
}

// Open farmer transaction history (double-click)
function openFarmerTransactions(fId) {
    const f = getFarmerById(fId);
    if (!f) return;
    
    selectedFarmerId = fId;
    el("transFarmerName").textContent = f.name;
    
    // Calculate monthly milk
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthEntries = entries.filter(e => e.farmerId === fId && new Date(e.createdAt) >= monthStart);
    const totalMilk = monthEntries.reduce((sum, e) => sum + Number(e.qty || 0), 0);
    el("transTotalMilk").textContent = `${totalMilk.toFixed(1)} L`;
    el("transCurrentAdvance").textContent = `‚Çπ${round2(f.advance || 0).toFixed(2)}`;
    
    // Generate transaction list
    const transList = el("transList");
    const transactions = [];
    
    // Add milk entries as debit transactions
    monthEntries.forEach(e => {
        transactions.push({
            date: new Date(e.createdAt),
            type: 'milk',
            description: `Milk: ${e.qty}L @ ‚Çπ${e.ratePerL}`,
            amount: Number(e.amount),
            balance: 0
        });
    });
    
    // Sort by date
    transactions.sort((a, b) => b.date - a.date);
    
    // Calculate running balance
    let balance = f.balance || 0;
    transactions.forEach(t => {
        t.balance = balance;
        balance -= t.amount;
    });
    
    if (transactions.length === 0) {
        transList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted);">No transactions this month</div>';
    } else {
        transList.innerHTML = transactions.map(t => `
          <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e2e8f0; font-size: 13px;">
            <div>
              <div style="font-weight: 700;">${t.description}</div>
              <div style="color: var(--muted); font-size: 11px;">${t.date.toLocaleDateString()}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 700; color: #dc2626;">-‚Çπ${t.amount.toFixed(2)}</div>
              <div style="color: var(--muted); font-size: 11px;">Bal: ‚Çπ${t.balance.toFixed(2)}</div>
            </div>
          </div>
        `).join('');
    }
    
    openOverlay("overlayFarmerTransactions");
}

function updateFarmerAdvance() {
    const amt = Number(el("transAmount").value);
    const action = el("transAction").value;
    const f = getFarmerById(selectedFarmerId);
    if (!f || amt <= 0) return showToast("Invalid amount");
    
    if (action === 'give') {
        f.advance = (f.advance || 0) + amt;
        showToast(`‚Çπ${amt} advance given ‚úÖ`);
    } else {
        if ((f.advance || 0) < amt) return showToast("Insufficient advance");
        f.advance = (f.advance || 0) - amt;
        showToast(`‚Çπ${amt} advance cut ‚úÖ`);
    }
    
    saveFarmers(farmers);
    el("transAmount").value = "";
    openFarmerTransactions(selectedFarmerId); // Refresh
}

function sendFarmerSummary() {
    const f = getFarmerById(selectedFarmerId);
    if (!f) return;
    
    const totalMilk = el("transTotalMilk").textContent;
    const currentAdv = el("transCurrentAdvance").textContent;
    const currentBal = `‚Çπ${round2(f.balance || 0).toFixed(2)}`;
    const monthName = new Date().toLocaleString('default', { month: 'long' });
    
    const msg = `*Milk Summary - ${monthName}*
---------------------------
*Kisan:* ${f.name}
*Total Milk:* ${totalMilk}
*Current Advance:* ${currentAdv}
*Net Balance:* ${currentBal}
---------------------------
Gopal Dairy Shop`;
    
    const wpUrl = f.phone ? `https://wa.me/${f.phone}?text=${encodeURIComponent(msg)}` : `https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(wpUrl, '_blank');
    showToast("Summary sent üí¨");
}

el("btnAddAdv").onclick = () => handleAdvanceChange(true);
el("btnCutAdv").onclick = () => handleAdvanceChange(false);

function handleAdvanceChange(isAdding) {
    const amt = Number(el("advAmount").value);
    if (amt <= 0) return showToast("Enter valid amount");
    const f = getFarmerById(selectedFarmerId);
    if (!f) return;

    if (isAdding) {
        f.advance = (f.advance || 0) + amt;
        f.balance = (f.balance || 0) - amt;
        showToast(`‚Çπ${amt} Advance Added ‚úÖ`);
    } else {
        if ((f.advance || 0) < amt) return showToast("Not enough advance");
        f.advance = (f.advance || 0) - amt;
        f.balance = (f.balance || 0) + amt;
        showToast(`‚Çπ${amt} Advance Cut ‚úÇÔ∏è`);
    }
    saveFarmers(farmers);
    el("advAmount").value = "";
    closeOverlay("overlayFarmerDetail");
    renderAll();
}
// ... upar openFarmerDetail wala function khatam hone ke baad ...

// --- WHATSAPP MONTHLY SUMMARY LOGIC (Yahan Paste Karein) ---
el("btnDetailWhatsApp").onclick = () => {
    const f = getFarmerById(selectedFarmerId);
    if (!f) return;

    // 1. Mahine ka data taiyar karein
    const now = new Date();
    const monthName = now.toLocaleString('default', { month: 'long' });
    const totalMilk = el("detailMonthlyMilk").textContent;
    const currentAdv = el("detailAdvance").textContent;
    const currentBal = `‚Çπ${round2(f.balance || 0).toFixed(2)}`;

    // 2. Message ka format (Plain Hindi + Numbers jaisa document mein likha hai)
    const msg = `*Milk Summary - ${monthName}*
---------------------------
*Kisan:* ${f.name}
*Total Milk:* ${totalMilk}
*Current Advance:* ${currentAdv}
*Net Balance:* ${currentBal}
---------------------------
Gopal Dairy Shop`;

    // 3. WhatsApp link generate karein aur open karein
    const wpUrl = `https://wa.me/${f.phone}?text=${encodeURIComponent(msg)}`;
    window.open(wpUrl, '_blank');
    
    showToast("Monthly Summary Sent üí¨");
};
// --- WHATSAPP DAILY SUMMARY LOGIC ---
el("btnDailySummary").onclick = () => {
    const today = fmtDate(new Date());
    const todays = entries.filter(e => e.day === today);
    
    if (todays.length === 0) {
        showToast("No entries for today!");
        return;
    }

    // Aaj ka poora calculations
    const totalMilk = todays.reduce((sum, e) => sum + Number(e.qty || 0), 0);
    const totalAmt = todays.reduce((sum, e) => sum + Number(e.amount || 0), 0);
    const session = autoSessionLabel(); // Morning ya Evening automatic lega

    // Message ka format (Professional Dairy Look)
    const msg = `*ü•õ Daily Milk Summary*
*Date:* ${today} (${session})
---------------------------
‚úÖ *Total Entries:* ${todays.length}
‚úÖ *Total Milk:* ${totalMilk.toFixed(1)} L
‚úÖ *Total Amount:* ‚Çπ${totalAmt.toFixed(2)}
---------------------------
*Gopal Dairy Shop*`;

    // WhatsApp par share karne ka link
    const wpUrl = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(wpUrl, '_blank');
};
function sendDailySummary() {
    const today = fmtDate(new Date());
    // Aaj ki saari entries filter karein
    const todays = entries.filter(e => e.day === today && e.farmerId === selectedFarmerId);

    if (todays.length === 0) {
        showToast("No records found for this farmer today!");
        return;
    }

    // Total ka calculation karein
    let totalQty = 0;
    let totalAmt = 0;
    let detailMsg = "";

    todays.forEach((e, index) => {
        totalQty += Number(e.qty);
        totalAmt += Number(e.amount);
        detailMsg += `\n${index + 1}. ${e.session}: ${e.qty}L | ‚Çπ${e.amount}`;
    });

    const farmer = getFarmerById(selectedFarmerId);
    const phone = farmer ? farmer.phone : "";

    // Naya Summary Message Template
    const summaryMsg = `*DAIRY DAILY SUMMARY* üìä\n` +
                       `Date: ${today}\n` +
                       `Farmer: ${farmer.name}\n` +
                       `--------------------------` +
                       `${detailMsg}\n` +
                       `--------------------------\n` +
                       `*Total Milk: ${totalQty.toFixed(1)} L*\n` +
                       `*Total Amount: ‚Çπ${totalAmt.toFixed(2)}*\n\n` +
                       `Gopal Dairy Shop üôè`;

    if (phone) {
        const wpLink = `https://wa.me/${phone}?text=${encodeURIComponent(summaryMsg)}`;
        window.open(wpLink, '_blank');
        showToast("Summary Sent! üìä‚úÖ");
    } else {
        showToast("Farmer phone number missing!");
    }
}
function updatePayUI() {
    // 1. Check karo kaunsa radio button select hua hai
    const isCash = document.querySelector('input[name="payMode"]:checked').value === 'Cash';
    
    const cashDiv = el("optCash");
    const creditDiv = el("optCredit");

    if (isCash) {
        // Cash select hone par Green
        cashDiv.style.border = "2px solid var(--green)";
        cashDiv.style.background = "var(--soft-green)";
        creditDiv.style.border = "1px solid var(--line)";
        creditDiv.style.background = "#fff";
        showToast("Mode: ‡§®‡§ï‡§¶ (Cash) üí∞");
    } else {
        // Udhaar select hone par Red
        creditDiv.style.border = "2px solid var(--red)";
        creditDiv.style.background = "var(--soft-pink)";
        cashDiv.style.border = "1px solid var(--line)";
        cashDiv.style.background = "#fff";
        showToast("Mode: ‡§â‡§ß‡§æ‡§∞ (Credit) ‚úçÔ∏è");
    }
}
// Button ko tabhi dikhana jab koi entry ho
function updateDailySummaryButton() {
    const today = fmtDate(new Date());
    const hasEntries = entries.some(e => e.day === today);
    const wrapper = el("dailySummaryWrapper");
    if (wrapper) {
        wrapper.style.display = hasEntries ? "block" : "none";
    }
}
// ... iske niche init(); function hona chahiye ...

// Animal Type Toggle Function
function selectAnimalType(type) {
  // Reset all buttons
  ['animalCow', 'animalBuffalo', 'animalBoth'].forEach(id => {
    const btn = el(id);
    if (btn) {
      btn.style.borderColor = 'var(--line)';
      btn.style.background = 'white';
    }
  });
  
  // Set selected
  el("fAnimalType").value = type;
  const selectedBtn = el("animal" + type.charAt(0).toUpperCase() + type.slice(1));
  if (selectedBtn) {
    selectedBtn.style.borderColor = 'var(--blue)';
    selectedBtn.style.background = '#eff6ff';
  }
}

// ESC Key Handler for ALL Modals
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    // Method 1: Close using closeOverlay function
    const overlays = [
      'overlayFarmer', 
      'overlayFarmerDetail', 
      'overlayReceipt', 
      'overlayEntryDetail', 
      'overlayPayment',
      'overlayHold',
      'overlayRateEditor',
      'overlayHistory',
      'overlayLeader',
      'overlaySettings',
      'overlayCenterSummary',
      'overlayDispatch',
      'overlayBMCReconcile',
      'overlayPaymentObligation'
    ];
    
    overlays.forEach(id => {
      const overlay = document.getElementById(id);
      if (overlay && overlay.style.display === 'flex') {
        if (typeof closeOverlay === 'function') {
          closeOverlay(id);
        }
      }
    });
    
    // Method 2: Click any visible close button with data-close attribute
    document.querySelectorAll('[data-close]').forEach(btn => {
      const overlayId = btn.getAttribute('data-close');
      const overlay = document.getElementById(overlayId);
      if (overlay && overlay.style.display === 'flex' && btn.offsetParent !== null) {
        btn.click();
      }
    });
    
    // Method 3: Fallback - hide any visible overlay
    document.querySelectorAll('.overlay[style*="display: flex"]').forEach(overlay => {
      overlay.style.display = 'none';
    });
  }
});

// Collection Point (Booth) Functions
const defaultCollectionPoints = [
  { id: "DEFAULT", name: "Default Booth" },
  { id: "VILLAGE_A", name: "Village A Booth" },
  { id: "VILLAGE_B", name: "Village B Booth" },
  { id: "VILLAGE_C", name: "Village C Booth" },
  { id: "MAIN_MARKET", name: "Main Market Booth" },
  { id: "GANDHI_CHOWK", name: "Gandhi Chowk Booth" }
];

function updateCollectionPoint() {
  const select = document.getElementById('collectionPointSelect');
  selectedCollectionPointId = select.value;
  localStorage.setItem('milkbook_collection_point', selectedCollectionPointId);
  const selectedName = select.options[select.selectedIndex].text;
  showToast(`Booth: ${selectedName}`);
  
  // Re-render farmers list to show booth-filtered results
  farmerPage = 0;
  renderFarmers();
}

// Load saved collection point on init
function loadSavedCollectionPoint() {
  const saved = localStorage.getItem('milkbook_collection_point');
  if (saved) {
    const select = document.getElementById('collectionPointSelect');
    if (select) {
      select.value = saved;
      selectedCollectionPointId = saved;
    }
  }
}

// Keyboard Navigation - Auto Focus Flow
let keyboardMode = 'search'; // 'search' -> 'liters' -> 'fat' -> 'snf' -> 'save'

function setupKeyboardNavigation() {
  document.addEventListener('keydown', function(e) {
    // ESC key - Close any open modal/overlay
    if (e.key === 'Escape') {
      // Close all overlays
      document.querySelectorAll('.overlay[style*="display: flex"]').forEach(overlay => {
        overlay.style.display = 'none';
      });
      // Also click any visible close buttons
      document.querySelectorAll('[data-close]').forEach(btn => {
        const overlayId = btn.getAttribute('data-close');
        const overlay = document.getElementById(overlayId);
        if (overlay && overlay.style.display === 'flex' && btn.offsetParent !== null) {
          btn.click();
        }
      });
      keyboardMode = 'search';
      el('searchInput').focus();
      return;
    }

    // Only activate Enter when not in modal
    if (document.querySelector('.overlay[style*="display: flex"]')) return;

    if (e.key === 'Enter') {
      e.preventDefault();

      if (keyboardMode === 'search') {
        // Enter in search ‚Üí Select first farmer and focus liters
        const firstFarmer = document.querySelector('.fcard');
        if (firstFarmer) {
          firstFarmer.click();
          keyboardMode = 'liters';
          setTimeout(() => el('qtyInput').focus(), 100);
        }
      } else if (keyboardMode === 'liters') {
        // Enter in liters ‚Üí Focus fat
        console.log('Enter in Liters ‚Üí Moving to Fat');
        keyboardMode = 'fat';
        const fatInput = el('fatInput');
        if (fatInput) {
          fatInput.focus();
          fatInput.select();
        }
      } else if (keyboardMode === 'fat') {
        // Enter in fat ‚Üí Focus SNF
        console.log('Enter in Fat ‚Üí Moving to SNF');
        keyboardMode = 'snf';
        const snfInput = el('snfInput');
        if (snfInput) {
          snfInput.focus();
          snfInput.select();
        }
      } else if (keyboardMode === 'snf') {
        // Enter in SNF ‚Üí Save entry
        console.log('Enter in SNF ‚Üí Saving');
        el('btnSave').click();
        keyboardMode = 'search';
        setTimeout(() => el('searchInput').focus(), 100);
      }
    }
  });

  // Focus search on page load
  setTimeout(() => {
    el('searchInput').focus();
  }, 500);

  // Track focus changes - Enhanced with blur handling
  const inputModes = {
    'searchInput': 'search',
    'qtyInput': 'liters',
    'fatInput': 'fat',
    'snfInput': 'snf'
  };

  Object.keys(inputModes).forEach(id => {
    const input = el(id);
    if (input) {
      // On focus - set mode
      input.addEventListener('focus', function() {
        keyboardMode = inputModes[id];
        console.log('Focus:', id, '‚Üí Mode:', keyboardMode);
      });
      
      // On blur - keep mode for a short time
      input.addEventListener('blur', function() {
        setTimeout(() => {
          const newlyFocused = document.activeElement;
          if (!Object.keys(inputModes).includes(newlyFocused.id)) {
            // If focus moved outside inputs, reset to search
            keyboardMode = 'search';
          }
        }, 100);
      });
    }
  });

  // Prevent Enter on Add New button
  const addNewBtn = document.getElementById('btnAddFarmerMain');
  if (addNewBtn) {
    addNewBtn.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        e.stopPropagation();
        // Move to next farmer or field instead
        const firstFarmer = document.querySelector('.fcard');
        if (firstFarmer) {
          firstFarmer.click();
          keyboardMode = 'liters';
          setTimeout(() => el('qtyInput').focus(), 100);
        }
      }
    });
  }
}

// Show "What's missing?" panel
function showWhatMissing() {
  const msg = `Institutional systems track:
  
‚ùå Shift locking
‚ùå Analyzer linkage  
‚ùå Audit trail
‚ùå Settlement logic

These are required for procurement-grade accountability.`;
  alert(msg);
}

// Quantity threshold nudge logic (wrapped to avoid duplicate declaration)
(function() {
  const qtyInputLocal = el('qtyInput');
  if (qtyInputLocal) {
    qtyInputLocal.addEventListener('input', function() {
      const qty = parseFloat(this.value) || 0;
      const nudge = el('qtyThresholdNudge');
      if (nudge) {
        nudge.style.display = qty > 20 ? 'block' : 'none';
      }
    });
  }
})();

// Balance risk marker logic - add to renderTrust
const originalRenderTrust = window.renderTrust || function() {};
window.renderTrust = function() {
  originalRenderTrust();
  
  // Add balance risk marker
  const farmer = getFarmerById(selectedFarmerId);
  const balanceEl = el('balAfter');
  if (farmer && balanceEl) {
    const balance = farmer.balance || 0;
    if (balance > 10000) {
      balanceEl.innerHTML = `‚Çπ${balance.toFixed(2)} <span style="color: #f59e0b;" title="Large outstanding balance. Settlement traceability & deductions tracking available in collection center system.">‚ö†Ô∏è</span>`;
    }
  }
};

      /***********************
       * INIT                *
       ***********************/
      function init() {
        // --- SIRF YE 2 LINE SABSE UPAR JODO ---
    const today = fmtDate(new Date());
    if (el("todayLabel")) el("todayLabel").textContent = `${today} | ${autoSessionLabel()}`;
    // --------------------------------------
    // --- YE 3 LINE BHI JODO ---
    renderRecentToday();
    updateDailySummaryButton();
    loadSavedCollectionPoint(); // Load saved booth
    setupKeyboardNavigation(); // Enable keyboard-only workflow
    // --------------------------------------------------
        restoreHoldIfAny();
        renderAll();
        refreshRatePill();
        // timerInt = setInterval(() => {
        //   const sec = Math.floor((Date.now() - timerStart) / 1000);
        //   el("timerBox").textContent =
        //     `‚è± ${pad(Math.floor(sec / 60))}:${pad(sec % 60)}`;
        // }, 1000);
      }

      init();
    </script>
  </body>
</html>
