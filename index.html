<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MilkBook - Automatic Milk Collection & Dairy Accounting - Designed by signimus</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM via CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        body { 
            font-family: 'Inter', sans-serif; 
        }

        /* ERP Style Scrollbars */
        ::-webkit-scrollbar { 
            width: 8px; 
            height: 8px; 
        }
        ::-webkit-scrollbar-track { 
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 4px; 
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: #94a3b8; 
        }

        /* Print Optimization */
        @media print {
            .print-hidden { 
                display: none !important; 
            }
            .print-only { 
                display: block !important; 
            }
            body { 
                background: white; 
                color: black; 
                font-size: 10pt; 
            }
            .card { 
                border: none !important; 
                box-shadow: none !important; 
            }
            table { 
                width: 100% !important; 
                border-collapse: collapse !important; 
            }
            th, td { 
                border: 1px solid #ddd !important; 
                padding: 4pt !important; 
                text-align: left !important; 
            }
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Constants and helpers
        const STORAGE_KEY = 'dairy_mgmt_state_v1';
        const INITIAL_STATE = {
            auth: { isAuthenticated: false, user: null },
            currentScreen: 'login',
            dairyInfo: { name: '', owner: '', mobile: '', address: '', rateType: 'Fat_SNF', language: 'EN' },
            farmers: [],
            milkEntries: [],
            rates: {
                cow: { base: 40, fatRef: 3.5, snfRef: 8.5 },
                buffalo: { base: 60, fatRef: 6.0, snfRef: 9.0 }
            },
            payments: [],
            sales: [],
            inventory: [],
            settings: { backupEnabled: true, lastBackup: null, printerName: 'Default' }
        };

        // Format currency
        const formatCurrency = (val) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(val || 0);
        const formatDate = (date) => new Date(date).toLocaleDateString('en-IN');

        // Calculate milk amount
        const calculateMilkAmount = (qty, fat, snf, rateType, rates, type) => {
            const baseRate = type === 'Cow' ? rates.cow.base : rates.buffalo.base;
            const fatRef = type === 'Cow' ? rates.cow.fatRef : rates.buffalo.fatRef;
            const snfRef = type === 'Cow' ? rates.cow.snfRef : rates.buffalo.snfRef;

            let calculatedRate = Number(baseRate);
            if (rateType === 'Fat_SNF') {
                const fatDiff = (fat - fatRef) * 2;
                const snfDiff = (snf - snfRef) * 1.5;
                calculatedRate = Number(baseRate) + fatDiff + snfDiff;
            } else if (rateType === 'Fat') {
                calculatedRate = (baseRate / fatRef) * fat;
            }

            return {
                rate: Math.max(calculatedRate, 10).toFixed(2),
                amount: (qty * Math.max(calculatedRate, 10)).toFixed(2)
            };
        };

        // Icon component
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, []);

            return React.createElement('i', { 
                'data-lucide': name, 
                style: { width: size, height: size }, 
                className: className
            });
        };

        // Card component
        const Card = ({ title, children, extra, noPadding = false }) => (
            <div className="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden mb-6 transition-all hover:shadow-md">
                {(title || extra) && (
                    <div className="px-6 py-4 border-b flex justify-between items-center bg-slate-50/30">
                        {title && <h2 className="text-lg font-bold text-slate-800">{title}</h2>}
                        {extra && <div>{extra}</div>}
                    </div>
                )}
                <div className={noPadding ? '' : 'p-6'}>{children}</div>
            </div>
        );

        // Stat Card component
        const StatCard = ({ label, value, iconName, color }) => {
            const colors = {
                blue: 'bg-blue-50 text-blue-600',
                green: 'bg-green-50 text-green-600',
                amber: 'bg-amber-50 text-amber-600',
                rose: 'bg-rose-50 text-rose-600'
            };
            return (
                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-5">
                    <div className={`p-4 rounded-xl ${colors[color] || colors.blue}`}>
                        <Icon name={iconName} size={24} />
                    </div>
                    <div>
                        <p className="text-sm font-semibold text-slate-500 uppercase tracking-wider">{label}</p>
                        <p className="text-2xl font-black text-slate-800">{value}</p>
                    </div>
                </div>
            );
        };

        // Login Screen Component
        const LoginScreen = ({ state, setState, notify, navigate }) => {
            const [formData, setFormData] = useState({ mobile: '', password: '' });
            
            const handleLogin = (e) => {
                e.preventDefault();
                const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
                if (saved?.auth?.user?.mobile === formData.mobile && saved?.auth?.user?.password === formData.password) {
                    setState(prev => ({ ...prev, auth: { isAuthenticated: true, user: saved.auth.user }, currentScreen: saved.dairyInfo.name ? 'dashboard' : 'setup' }));
                    notify('Logged in');
                } else notify('Invalid credentials', 'error');
            };
            
            return (
                <div className="min-h-screen w-full flex items-center justify-center bg-slate-900 p-4">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden">
                        <div className="bg-blue-600 p-10 text-white text-center">
                            <Icon name="droplet" size={64} className="mx-auto mb-4 text-white" />
                            <h2 className="text-4xl font-black tracking-tighter">MilkBook</h2>
                            <p className="opacity-70 text-sm font-bold uppercase tracking-widest">Automatic Milk Collection & Dairy Accounting</p>
                        </div>
                        <form onSubmit={handleLogin} className="p-10 space-y-6">
                            <div>
                                <label className="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2">Mobile Number</label>
                                <input 
                                    type="text" 
                                    required 
                                    className="w-full p-4 bg-slate-50 border rounded-xl font-bold" 
                                    value={formData.mobile} 
                                    onChange={e => setFormData({...formData, mobile: e.target.value})} 
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2">Password</label>
                                <input 
                                    type="password" 
                                    required 
                                    className="w-full p-4 bg-slate-50 border rounded-xl font-bold" 
                                    value={formData.password} 
                                    onChange={e => setFormData({...formData, password: e.target.value})} 
                                />
                            </div>
                            <button type="submit" className="w-full py-5 bg-blue-600 text-white rounded-xl font-black text-lg hover:bg-blue-700 transition-all shadow-xl shadow-blue-200">LOGIN SYSTEM</button>
                            <div className="text-center">
                                <button type="button" onClick={() => navigate('register')} className="text-blue-600 font-black text-sm hover:underline uppercase tracking-tighter">Register New Dairy Center</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // Register Screen Component
        const RegisterScreen = ({ setState, notify, navigate }) => {
            const [form, setForm] = useState({ dairyName: '', ownerName: '', mobile: '', password: '', confirm: '' });
            
            const handleRegister = (e) => {
                e.preventDefault();
                if (form.password !== form.confirm) return notify("Passwords mismatch", 'error');
                const user = { name: form.ownerName, mobile: form.mobile, password: form.password };
                setState(prev => ({ ...prev, auth: { isAuthenticated: true, user }, dairyInfo: { ...prev.dairyInfo, name: form.dairyName, owner: form.ownerName, mobile: form.mobile }, currentScreen: 'setup' }));
                notify("Registered");
            };
            
            return (
                <div className="min-h-screen w-full flex items-center justify-center bg-slate-900 p-4">
                    <div className="w-full max-w-2xl bg-white rounded-2xl shadow-2xl p-12">
                        <h2 className="text-3xl font-black text-slate-800 mb-2 tracking-tighter uppercase">Register Center</h2>
                        <p className="text-slate-500 font-bold mb-8">Setup your digital procurement system.</p>
                        <form onSubmit={handleRegister} className="grid grid-cols-2 gap-6">
                            <div className="col-span-2">
                                <label className="block text-xs font-black text-slate-500 uppercase mb-1">Dairy Name</label>
                                <input 
                                    required 
                                    className="w-full p-4 bg-slate-50 border rounded-xl font-bold" 
                                    value={form.dairyName} 
                                    onChange={e => setForm({...form, dairyName: e.target.value})} 
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-500 uppercase mb-1">Owner Name</label>
                                <input 
                                    required 
                                    className="w-full p-4 bg-slate-50 border rounded-xl font-bold" 
                                    value={form.ownerName} 
                                    onChange={e => setForm({...form, ownerName: e.target.value})} 
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-500 uppercase mb-1">Mobile</label>
                                <input 
                                    required 
                                    className="w-full p-4 bg-slate-50 border rounded-xl font-bold" 
                                    value={form.mobile} 
                                    onChange={e => setForm({...form, mobile: e.target.value})} 
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-500 uppercase mb-1">Password</label>
                                <input 
                                    type="password" 
                                    required 
                                    className="w-full p-4 bg-slate-50 border rounded-xl" 
                                    value={form.password} 
                                    onChange={e => setForm({...form, password: e.target.value})} 
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-500 uppercase mb-1">Confirm</label>
                                <input 
                                    type="password" 
                                    required 
                                    className="w-full p-4 bg-slate-50 border rounded-xl" 
                                    value={form.confirm} 
                                    onChange={e => setForm({...form, confirm: e.target.value})} 
                                />
                            </div>
                            <button type="submit" className="col-span-2 py-5 bg-blue-600 text-white rounded-xl font-black text-xl hover:bg-blue-700">INITIALIZE DAIRY SYSTEM</button>
                        </form>
                    </div>
                </div>
            );
        };

        // Dashboard Screen Component
        const DashboardScreen = ({ state, navigate }) => {
            const today = new Date().toISOString().split('T')[0];
            const todayEntries = state.milkEntries.filter(e => e.date === today);
            const totalQty = todayEntries.reduce((acc, curr) => acc + Number(curr.qty), 0);
            const totalAmt = todayEntries.reduce((acc, curr) => acc + Number(curr.amount), 0);
            const avgFat = todayEntries.length > 0 ? (todayEntries.reduce((acc, curr) => acc + Number(curr.fat), 0) / todayEntries.length).toFixed(1) : 0;

            return (
                <div className="space-y-8">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <StatCard label="Today's Milk" value={`${totalQty.toFixed(1)} L`} iconName="droplets" color="blue" />
                        <StatCard label="Today's Value" value={formatCurrency(totalAmt)} iconName="indian-rupee" color="green" />
                        <StatCard label="Avg. Fat" value={`${avgFat}%`} iconName="check-circle" color="amber" />
                        <StatCard label="Total Farmers" value={state.farmers.filter(f => f.active).length} iconName="users" color="rose" />
                    </div>
                    
                    <Card title="Recent Collections">
                        <table className="w-full text-left">
                            <thead className="border-b text-[10px] font-black text-slate-400 uppercase">
                                <tr>
                                    <th className="pb-4">Farmer</th>
                                    <th className="pb-4">Time</th>
                                    <th className="pb-4">Qty</th>
                                    <th className="pb-4">Fat%</th>
                                    <th className="pb-4 text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {todayEntries.slice(0, 5).map(entry => {
                                    const farmer = state.farmers.find(f => f.id === entry.farmerId);
                                    return (
                                        <tr key={entry.id}>
                                            <td className="py-4 font-black">{farmer?.name || 'Unknown'}</td>
                                            <td className="py-4 font-bold text-slate-500">{entry.time}</td>
                                            <td className="py-4 font-black text-slate-700">{entry.qty} L</td>
                                            <td className="py-4 font-black text-amber-600">{entry.fat}</td>
                                            <td className="py-4 text-right font-black text-blue-600">{formatCurrency(entry.amount)}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </Card>
                </div>
            );
        };

        // Setup Wizard Component
        const SetupWizard = ({ state, setState, notify, navigate }) => {
            const [step, setStep] = useState(1);
            const [dairy, setDairy] = useState(state.dairyInfo);

            const complete = () => {
                setState(prev => ({ ...prev, dairyInfo: dairy, currentScreen: 'dashboard' }));
                notify("Setup Complete");
            };

            return (
                <div className="min-h-screen w-full flex items-center justify-center bg-slate-50 p-4">
                    <div className="w-full max-w-2xl bg-white rounded-2xl shadow-xl border overflow-hidden">
                        <div className="flex bg-slate-100 border-b">
                            {[1, 2, 3].map(i => 
                                <div key={i} className={`flex-1 py-4 text-center text-xs font-black uppercase tracking-widest ${
                                    step === i ? 'bg-white text-blue-600 border-b-4 border-blue-600' : 'text-slate-400'
                                }`}>Step {i}</div>
                            )}
                        </div>
                        <div className="p-12 space-y-8 text-center">
                            {step === 1 && (
                                <div>
                                    <Icon name="map-pin" size={48} className="mx-auto text-blue-600" />
                                    <h3 className="text-3xl font-black tracking-tight uppercase">Location Details</h3>
                                    <textarea 
                                        className="w-full p-4 border rounded-xl min-h-[120px] font-bold" 
                                        value={dairy.address} 
                                        onChange={e => setDairy({...dairy, address: e.target.value})} 
                                        placeholder="Dairy Address (Village, District...)" 
                                    ></textarea>
                                    <button onClick={() => setStep(2)} className="w-full py-5 bg-blue-600 text-white rounded-xl font-black text-xl hover:bg-blue-700">Continue Setup</button>
                                </div>
                            )}
                            {step === 2 && (
                                <div>
                                    <Icon name="percent" size={48} className="mx-auto text-blue-600" />
                                    <h3 className="text-3xl font-black tracking-tight uppercase">Rate Calculation</h3>
                                    <div className="grid grid-cols-1 gap-4">
                                        {[
                                            { id: 'Fat_SNF', title: 'Fat + SNF Based', desc: 'Standard calculation based on Fat and Solids-Not-Fat' },
                                            { id: 'Fat', title: 'Fat Only', desc: 'Rate calculated purely on Fat percentage' },
                                            { id: 'CLR', title: 'CLR Method', desc: 'Used for traditional quality testing' }
                                        ].map(opt => 
                                            <label key={opt.id} className={`p-5 border-2 rounded-2xl cursor-pointer flex items-center justify-between transition-all ${
                                                dairy.rateType === opt.id ? 'border-blue-600 bg-blue-50' : 'border-slate-100 hover:border-slate-200'
                                            }`}>
                                                <div>
                                                    <p className="font-bold text-slate-800">{opt.title}</p>
                                                    <p className="text-sm text-slate-500 font-medium">{opt.desc}</p>
                                                </div>
                                                <input 
                                                    type="radio" 
                                                    checked={dairy.rateType === opt.id} 
                                                    onChange={() => setDairy({ ...dairy, rateType: opt.id })} 
                                                />
                                            </label>
                                        )}
                                    </div>
                                    <div className="flex gap-4">
                                        <button onClick={() => setStep(1)} className="flex-1 py-4 bg-slate-100 font-bold rounded-xl">Back</button>
                                        <button onClick={() => setStep(3)} className="flex-1 py-4 bg-blue-600 text-white font-bold rounded-xl">Continue</button>
                                    </div>
                                </div>
                            )}
                            {step === 3 && (
                                <div>
                                    <Icon name="check-circle" size={48} className="mx-auto text-green-600" />
                                    <h3 className="text-3xl font-black tracking-tight uppercase">Ready to Start</h3>
                                    <div className="bg-amber-50 p-6 rounded-2xl border border-amber-200 text-left">
                                        <p className="text-amber-800 font-bold mb-2 flex items-center gap-2">
                                            <Icon name="alert-circle" size={18} /> Review Details
                                        </p>
                                        <ul className="text-sm space-y-1 text-amber-700 font-medium">
                                            <li>Dairy: {dairy.name}</li>
                                            <li>Rate: {dairy.rateType}</li>
                                            <li>Backup: Enabled (Browser Storage)</li>
                                        </ul>
                                    </div>
                                    <div className="flex gap-4">
                                        <button onClick={() => setStep(2)} className="flex-1 py-4 bg-slate-100 font-bold rounded-xl">Back</button>
                                        <button onClick={complete} className="flex-1 py-4 bg-blue-600 text-white font-bold rounded-xl">Complete Setup</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Milk Entry Screen Component with keyboard-first UX and instant processing
        const MilkEntryScreen = ({ state, setState, notify }) => {
            const [form, setForm] = useState({
                farmerId: '', date: new Date().toISOString().split('T')[0], shift: 'Morning',
                type: 'Cow', qty: '', fat: '', snf: '', rate: '', amount: '',
                advance: '', feedDeduction: '', otherDeduction: '', netAmount: '',
                selectedFarmer: ''
            });
            const [importModalOpen, setImportModalOpen] = useState(false);
            const [quickAdd, setQuickAdd] = useState(false); // For rapid entry mode
            const [autoSaveEnabled, setAutoSaveEnabled] = useState(true); // Auto-save enabled by default

            // Calculate farmer's balance
            const getFarmerBalance = (farmerId) => {
                if (!farmerId) return 0;

                const entries = state.milkEntries.filter(entry => entry.farmerId === farmerId);
                const payments = state.payments.filter(payment => payment.farmerId === farmerId);

                const totalMilkValue = entries.reduce((sum, entry) => sum + parseFloat(entry.netAmount || entry.amount), 0);
                const totalPayments = payments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);

                return totalMilkValue - totalPayments;
            };

            // Enhanced rate calculation based on matrix
            const calculateAmount = (qty, fat, snf, type) => {
                const rates = state.rates;
                const baseRate = type === 'Cow' ? rates.cow.base : rates.buffalo.base;
                const fatRef = type === 'Cow' ? rates.cow.fatRef : rates.buffalo.fatRef;
                const snfRef = type === 'Cow' ? rates.cow.snfRef : rates.buffalo.snfRef;

                let calculatedRate = Number(baseRate);

                // Matrix-based rate calculation
                if (state.dairyInfo.rateType === 'Fat_SNF') {
                    // Both fat and SNF based
                    const fatPoints = Math.max(0, (fat - fatRef) * 2); // 2 rupees per 1% fat above reference
                    const snfPoints = Math.max(0, (snf - snfRef) * 1.5); // 1.5 rupees per 1% SNF above reference
                    calculatedRate = Number(baseRate) + fatPoints + snfPoints;
                } else if (state.dairyInfo.rateType === 'Fat') {
                    // Fat only based
                    calculatedRate = (baseRate / fatRef) * fat;
                } else if (state.dairyInfo.rateType === 'SNF') {
                    // SNF only based
                    calculatedRate = (baseRate / snfRef) * snf;
                }

                const grossAmount = qty * Math.max(calculatedRate, 10);

                // Apply deductions
                const advance = parseFloat(form.advance) || 0;
                const feedDeduction = parseFloat(form.feedDeduction) || 0;
                const otherDeduction = parseFloat(form.otherDeduction) || 0;
                const totalDeductions = advance + feedDeduction + otherDeduction;

                const netAmount = grossAmount - totalDeductions;

                return {
                    rate: Math.max(calculatedRate, 10).toFixed(2),
                    grossAmount: grossAmount.toFixed(2),
                    netAmount: Math.max(netAmount, 0).toFixed(2)
                };
            };

            // Handle input changes
            const handleInputChange = (field, value) => {
                setForm(prev => ({ ...prev, [field]: value }));

                // Auto-calculate amount when qty, fat, or snf changes
                if (['qty', 'fat', 'snf', 'advance', 'feedDeduction', 'otherDeduction'].includes(field)) {
                    if (form.qty && form.fat) {
                        const calc = calculateAmount(form.qty, form.fat, form.snf || 0, form.type);
                        setForm(prev => ({ ...prev, rate: calc.rate, amount: calc.grossAmount, netAmount: calc.netAmount }));
                    }
                }
            };

            // Play audible feedback
            const playBeep = () => {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';

                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (e) {
                    // If audio context is not supported, skip beep
                    console.log("Beep sound played");
                }
            };

            // Handle form submission without confirmation
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!form.farmerId || !form.qty || !form.fat) {
                    notify("Please fill required fields", 'error');
                    return;
                }

                const calc = calculateAmount(form.qty, form.fat, form.snf || 0, form.type);

                const newEntry = {
                    id: Date.now().toString(),
                    ...form,
                    rate: calc.rate,
                    grossAmount: calc.grossAmount,
                    netAmount: calc.netAmount,
                    advance: parseFloat(form.advance) || 0,
                    feedDeduction: parseFloat(form.feedDeduction) || 0,
                    otherDeduction: parseFloat(form.otherDeduction) || 0
                };

                setState(prev => ({
                    ...prev,
                    milkEntries: [...prev.milkEntries, newEntry]
                }));

                // Update farmer's ledger
                setState(prev => ({
                    ...prev,
                    ledgers: [
                        ...prev.ledgers,
                        {
                            id: Date.now().toString(),
                            farmerId: form.farmerId,
                            date: form.date,
                            type: 'Milk Collection',
                            description: `Milk collection: ${form.qty}L at ${form.fat}% fat`,
                            debit: parseFloat(calc.grossAmount),
                            credit: 0,
                            balance: 0
                        },
                        ...(parseFloat(form.advance) > 0 ? [{
                            id: (Date.now() + 1).toString(),
                            farmerId: form.farmerId,
                            date: form.date,
                            type: 'Advance Adjustment',
                            description: `Advance adjustment`,
                            debit: 0,
                            credit: parseFloat(form.advance),
                            balance: 0
                        }] : []),
                        ...(parseFloat(form.feedDeduction) > 0 ? [{
                            id: (Date.now() + 2).toString(),
                            farmerId: form.farmerId,
                            date: form.date,
                            type: 'Feed Deduction',
                            description: `Feed deduction`,
                            debit: 0,
                            credit: parseFloat(form.feedDeduction),
                            balance: 0
                        }] : []),
                        ...(parseFloat(form.otherDeduction) > 0 ? [{
                            id: (Date.now() + 3).toString(),
                            farmerId: form.farmerId,
                            date: form.date,
                            type: 'Other Deduction',
                            description: `Other deduction`,
                            debit: 0,
                            credit: parseFloat(form.otherDeduction),
                            balance: 0
                        }] : [])
                    ]
                }));

                // Play audible feedback
                playBeep();

                notify(`Entry added for ${state.farmers.find(f => f.id === form.farmerId)?.name || 'Farmer'}. Amount: â‚¹${calc.netAmount}`);

                // Reset form but keep farmer selected in quick mode
                if (quickAdd) {
                    setForm({
                        ...form, // Keep farmer selected
                        date: new Date().toISOString().split('T')[0],
                        shift: form.shift, // Keep same shift
                        type: form.type, // Keep same type
                        qty: '',
                        fat: '',
                        snf: '',
                        rate: '',
                        amount: '',
                        advance: '',
                        feedDeduction: '',
                        otherDeduction: '',
                        netAmount: ''
                    });
                    // Focus on quantity field for next entry
                    setTimeout(() => {
                        const qtyInput = document.querySelector('input[name="qty"]');
                        if (qtyInput) qtyInput.focus();
                    }, 100);
                } else {
                    setForm({
                        farmerId: '', date: new Date().toISOString().split('T')[0], shift: 'Morning',
                        type: 'Cow', qty: '', fat: '', snf: '', rate: '', amount: '',
                        advance: '', feedDeduction: '', otherDeduction: '', netAmount: '',
                        selectedFarmer: ''
                    });
                }
            };

            // Keyboard shortcuts
            useEffect(() => {
                const handleKeyDown = (e) => {
                    // Ctrl+Enter to submit
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        handleSubmit(new Event('submit'));
                    }

                    // Tab to move between fields
                    if (e.key === 'Tab') {
                        // Handle tab navigation if needed
                    }
                };

                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, [form]);

            // Handle file import
            const handleFileImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    try {
                        // Try to parse as CSV first
                        let entries = parseCSV(content);
                        if (entries.length === 0) {
                            // If CSV parsing fails, try other formats
                            entries = parseTextFile(content);
                        }

                        if (entries.length > 0) {
                            // Map the entries to our format
                            const mappedEntries = entries.map(entry => {
                                // Find farmer by name if available in the entry
                                let farmerId = '';
                                if (entry.farmerName) {
                                    const farmer = state.farmers.find(f => f.name.toLowerCase().includes(entry.farmerName.toLowerCase()));
                                    if (farmer) farmerId = farmer.id;
                                }

                                return {
                                    id: (Date.now() + Math.random()).toString(), // Generate unique ID
                                    farmerId: farmerId,
                                    date: entry.date || new Date().toISOString().split('T')[0],
                                    shift: entry.shift || 'Morning',
                                    type: entry.type || 'Cow',
                                    qty: entry.weight || entry.qty || entry.quantity || entry.volume || '',
                                    fat: entry.fat || entry.fatPercentage || entry.fatPercent || '',
                                    snf: entry.snf || entry.snfPercentage || entry.snfPercent || '',
                                    rate: '',
                                    amount: ''
                                };
                            });

                            // Calculate amounts for each entry and add to payments
                            const processedEntries = mappedEntries.map(entry => {
                                const rates = state.rates;
                                const calc = calculateMilkAmount(entry.qty, entry.fat, entry.snf, state.dairyInfo.rateType, rates, entry.type);

                                // Add to payments as pending
                                setState(prev => ({
                                    ...prev,
                                    payments: [
                                        ...prev.payments,
                                        {
                                            id: (Date.now() + Math.random()).toString(),
                                            farmerId: entry.farmerId,
                                            amount: parseFloat(calc.amount),
                                            date: entry.date,
                                            mode: 'Pending',
                                            notes: `Milk collection for ${entry.qty}L at ${entry.fat}% fat`,
                                            type: 'Milk Payment'
                                        }
                                    ]
                                }));

                                return {
                                    ...entry,
                                    rate: calc.rate,
                                    amount: calc.amount
                                };
                            });

                            // Add to milk entries
                            setState(prev => ({
                                ...prev,
                                milkEntries: [...prev.milkEntries, ...processedEntries]
                            }));

                            notify(`Imported ${processedEntries.length} entries from ${file.name}. Payments added to pending.`);
                            setImportModalOpen(false);
                        } else {
                            notify('Could not parse the file. Please check the format.', 'error');
                        }
                    } catch (error) {
                        notify('Error parsing file: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };

            // Parse CSV content
            const parseCSV = (content) => {
                const lines = content.split(/\r?\n/);
                if (lines.length < 2) return [];

                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                const entries = [];

                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue; // Skip empty lines

                    const values = lines[i].split(',');
                    if (values.length !== headers.length) continue;

                    const entry = {};
                    headers.forEach((header, idx) => {
                        entry[header] = values[idx].trim();
                    });
                    entries.push(entry);
                }

                return entries;
            };

            // Parse text file content
            const parseTextFile = (content) => {
                // This is a basic implementation - would need to be customized based on actual machine output format
                const lines = content.split(/\r?\n/);
                const entries = [];

                // Look for common patterns in machine output
                for (const line of lines) {
                    if (!line.trim()) continue; // Skip empty lines

                    // Example: Try to match patterns like "Weight: 1.23kg Fat: 3.45% SNF: 8.76%"
                    const weightMatch = line.match(/(?:weight|wt|w|vol|volume|qty|quantity):\s*(\d+\.?\d*)/i);
                    const fatMatch = line.match(/(?:fat|f):\s*(\d+\.?\d*)/i);
                    const snfMatch = line.match(/(?:snf|s):\s*(\d+\.?\d*)/i);

                    if (weightMatch || fatMatch || snfMatch) {
                        const entry = {};
                        if (weightMatch) entry.weight = parseFloat(weightMatch[1]).toFixed(2);
                        if (fatMatch) entry.fat = parseFloat(fatMatch[1]).toFixed(2);
                        if (snfMatch) entry.snf = parseFloat(snfMatch[1]).toFixed(2);

                        if (entry.weight || entry.fat || entry.snf) {
                            entries.push(entry);
                        }
                    }
                }

                return entries;
            };

            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex justify-between items-center mb-6 print:hidden">
                        <h2 className="text-2xl font-black tracking-tighter uppercase">Milk Collection</h2>
                        <button
                            onClick={() => setImportModalOpen(true)}
                            className="px-6 py-3 bg-green-600 text-white rounded-xl font-black text-sm hover:bg-green-700 flex items-center gap-2"
                        >
                            <Icon name="upload" size={18} />
                            Import Readings
                        </button>
                    </div>

                    <div className="flex justify-between items-center mb-6 print:hidden">
                        <h2 className="text-2xl font-black tracking-tighter uppercase">Milk Collection</h2>
                        <div className="flex items-center gap-4">
                            <button
                                onClick={() => setQuickAdd(!quickAdd)}
                                className={`px-4 py-2 rounded-xl font-black text-xs uppercase tracking-widest ${
                                    quickAdd ? 'bg-green-600 text-white' : 'bg-slate-200 text-slate-700'
                                }`}
                            >{quickAdd ? 'RAPID MODE ON' : 'RAPID MODE OFF'}</button>
                            <button
                                onClick={() => setImportModalOpen(true)}
                                className="px-4 py-2 bg-green-600 text-white rounded-xl font-black text-xs uppercase tracking-widest"
                            >Import Readings</button>
                        </div>
                    </div>

                    <Card title="New Milk Collection">
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Farmer</label>
                                <select
                                    required
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                    value={form.farmerId}
                                    onChange={e => handleInputChange('farmerId', e.target.value)}
                                >
                                    <option value="">Select Farmer</option>
                                    {state.farmers.filter(f => f.active).map(farmer =>
                                        <option key={farmer.id} value={farmer.id}>{farmer.name}</option>
                                    )}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Date</label>
                                <input
                                    type="date"
                                    required
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                    value={form.date}
                                    onChange={e => handleInputChange('date', e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Shift</label>
                                <select
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                    value={form.shift}
                                    onChange={e => handleInputChange('shift', e.target.value)}
                                >
                                    <option value="Morning">Morning</option>
                                    <option value="Evening">Evening</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Milk Type</label>
                                <select
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                    value={form.type}
                                    onChange={e => handleInputChange('type', e.target.value)}
                                >
                                    <option value="Cow">Cow</option>
                                    <option value="Buffalo">Buffalo</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Quantity (L)</label>
                                <input
                                    name="qty"
                                    type="number"
                                    step="0.01"
                                    required
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold text-blue-600"
                                    value={form.qty}
                                    onChange={e => handleInputChange('qty', e.target.value)}
                                    autoFocus
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Fat %</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    required
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold text-blue-600"
                                    value={form.fat}
                                    onChange={e => handleInputChange('fat', e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">SNF %</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold text-slate-600"
                                    value={form.snf}
                                    onChange={e => handleInputChange('snf', e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Advance</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold text-rose-600"
                                    value={form.advance}
                                    onChange={e => handleInputChange('advance', e.target.value)}
                                    placeholder="0.00"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Feed Deduction</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold text-rose-600"
                                    value={form.feedDeduction}
                                    onChange={e => handleInputChange('feedDeduction', e.target.value)}
                                    placeholder="0.00"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Other Deduction</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold text-rose-600"
                                    value={form.otherDeduction}
                                    onChange={e => handleInputChange('otherDeduction', e.target.value)}
                                    placeholder="0.00"
                                />
                            </div>
                            <div className="flex items-end">
                                <button type="submit" className="w-full py-4 bg-blue-600 text-white rounded-xl font-black hover:bg-blue-700">Record Collection</button>
                            </div>
                        </form>
                    </Card>

                    {/* Quick Entry Controls */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 print:hidden">
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-bold text-slate-500 uppercase tracking-wider">Quick Mode</p>
                                    <p className="text-xs text-slate-400 font-medium">Keep farmer selected between entries</p>
                                </div>
                                <button
                                    onClick={() => setQuickAdd(!quickAdd)}
                                    className={`relative inline-flex h-6 w-11 items-center rounded-full ${
                                        quickAdd ? 'bg-blue-600' : 'bg-slate-200'
                                    }`}
                                >
                                    <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition ${
                                        quickAdd ? 'translate-x-6' : 'translate-x-1'
                                    }`} />
                                </button>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-bold text-slate-500 uppercase tracking-wider">Auto-Save</p>
                                    <p className="text-xs text-slate-400 font-medium">Save entries immediately</p>
                                </div>
                                <button
                                    onClick={() => setAutoSaveEnabled(!autoSaveEnabled)}
                                    className={`relative inline-flex h-6 w-11 items-center rounded-full ${
                                        autoSaveEnabled ? 'bg-blue-600' : 'bg-slate-200'
                                    }`}
                                >
                                    <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition ${
                                        autoSaveEnabled ? 'translate-x-6' : 'translate-x-1'
                                    }`} />
                                </button>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center justify-center">
                            <button
                                onClick={() => window.print()}
                                className="flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-xl font-black text-sm hover:bg-green-700"
                            >
                                <Icon name="printer" size={18} />
                                Print Receipt
                            </button>
                        </div>
                    </div>
                    <Card title="Recent Entries">
                        <table className="w-full text-left">
                            <thead className="border-b text-[10px] font-black text-slate-400 uppercase">
                                <tr>
                                    <th className="pb-4">Farmer</th>
                                    <th className="pb-4">Date</th>
                                    <th className="pb-4">Shift</th>
                                    <th className="pb-4">Type</th>
                                    <th className="pb-4">Qty</th>
                                    <th className="pb-4">Fat%</th>
                                    <th className="pb-4 text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {state.milkEntries.slice(0, 10).map(entry => {
                                    const farmer = state.farmers.find(f => f.id === entry.farmerId);
                                    return (
                                        <tr key={entry.id}>
                                            <td className="py-4 font-black">{farmer?.name || 'Unknown'}</td>
                                            <td className="py-4 font-bold text-slate-500">{entry.date}</td>
                                            <td className="py-4 font-bold text-slate-500">{entry.shift}</td>
                                            <td className="py-4 font-black">{entry.type}</td>
                                            <td className="py-4 font-black text-slate-700">{entry.qty} L</td>
                                            <td className="py-4 font-black text-amber-600">{entry.fat}</td>
                                            <td className="py-4 text-right font-black text-blue-600">{formatCurrency(entry.amount)}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </Card>

                    {/* Farmer Passbook Section */}
                    <Card title="Farmer Passbook">
                        <div className="mb-4">
                            <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Select Farmer</label>
                            <select
                                className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                value={form.selectedFarmer || ''}
                                onChange={e => setForm({...form, selectedFarmer: e.target.value})}
                            >
                                <option value="">Select Farmer to View Passbook</option>
                                {state.farmers.filter(f => f.active).map(farmer =>
                                    <option key={farmer.id} value={farmer.id}>{farmer.name}</option>
                                )}
                            </select>
                        </div>
                        {form.selectedFarmer && (
                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="border-b text-[10px] font-black text-slate-400 uppercase">
                                        <tr>
                                            <th className="pb-4">Date</th>
                                            <th className="pb-4">Description</th>
                                            <th className="pb-4 text-right">Debit</th>
                                            <th className="pb-4 text-right">Credit</th>
                                            <th className="pb-4 text-right">Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {state.ledgers
                                            .filter(ledger => ledger.farmerId === form.selectedFarmer)
                                            .sort((a, b) => new Date(b.date) - new Date(a.date))
                                            .slice(0, 10)
                                            .map(ledger => (
                                                <tr key={ledger.id}>
                                                    <td className="py-4 font-bold text-slate-500">{ledger.date}</td>
                                                    <td className="py-4 font-bold text-slate-500">{ledger.description}</td>
                                                    <td className="py-4 text-right font-black text-green-600">{ledger.debit > 0 ? formatCurrency(ledger.debit) : '-'}</td>
                                                    <td className="py-4 text-right font-black text-red-600">{ledger.credit > 0 ? formatCurrency(ledger.credit) : '-'}</td>
                                                    <td className="py-4 text-right font-black text-slate-800">{formatCurrency(getFarmerBalance(form.selectedFarmer))}</td>
                                                </tr>
                                            ))}
                                    </tbody>
                                </table>
                                <div className="mt-4 pt-4 border-t flex justify-between">
                                    <span className="font-bold text-slate-700">Current Balance:</span>
                                    <span className="font-black text-xl text-slate-800">{formatCurrency(getFarmerBalance(form.selectedFarmer))}</span>
                                </div>
                            </div>
                        )}
                    </Card>

                    {/* Import Modal */}
                    {importModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                                <div className="p-6 border-b flex justify-between items-center">
                                    <h3 className="text-xl font-black uppercase tracking-tighter">Import Machine Readings</h3>
                                    <button
                                        onClick={() => setImportModalOpen(false)}
                                        className="p-2 hover:bg-slate-100 rounded-lg"
                                    >
                                        <Icon name="x" size={20} />
                                    </button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <div className="bg-amber-50 p-6 rounded-2xl border border-amber-200">
                                        <p className="font-black text-amber-800 mb-2 flex items-center gap-2">
                                            <Icon name="info" size={18} />
                                            How It Works
                                        </p>
                                        <ul className="text-sm space-y-1 text-amber-700 font-medium">
                                            <li>â€¢ Export data from your milk testing machine (CSV/TXT)</li>
                                            <li>â€¢ Auto-maps Weight, Fat%, SNF% fields</li>
                                            <li>â€¢ Works with standard machine formats</li>
                                            <li>â€¢ Reduces manual entry work</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Select Machine Data File</label>
                                        <input
                                            type="file"
                                            accept=".csv,.txt"
                                            onChange={handleFileImport}
                                            className="w-full p-4 bg-slate-50 border rounded-xl font-bold border-dashed border-slate-300"
                                        />
                                        <p className="text-xs text-slate-500 mt-2">Supports CSV and TXT files from milk testing machines</p>
                                    </div>
                                    <div className="flex gap-4">
                                        <button
                                            onClick={() => setImportModalOpen(false)}
                                            className="flex-1 py-4 bg-slate-100 font-black rounded-xl hover:bg-slate-200"
                                        >Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Farmer Management Screen Component
        const FarmerManagementScreen = ({ state, setState, notify }) => {
            const [form, setForm] = useState({ name: '', mobile: '', address: '', advance: '' });
            const [editingId, setEditingId] = useState(null);

            const handleSubmit = (e) => {
                e.preventDefault();
                const newFarmer = {
                    id: editingId || Date.now().toString(),
                    ...form,
                    active: true
                };

                if (editingId) {
                    setState(prev => ({
                        ...prev,
                        farmers: prev.farmers.map(f => f.id === editingId ? newFarmer : f)
                    }));
                    notify("Farmer updated");
                } else {
                    setState(prev => ({
                        ...prev,
                        farmers: [...prev.farmers, newFarmer]
                    }));
                    notify("New farmer added");
                }

                setForm({ name: '', mobile: '', address: '', advance: '' });
                setEditingId(null);
            };

            const handleEdit = (farmer) => {
                setForm({
                    name: farmer.name,
                    mobile: farmer.mobile,
                    address: farmer.address,
                    advance: farmer.advance
                });
                setEditingId(farmer.id);
            };

            const handleDelete = (id) => {
                if (confirm("Are you sure you want to delete this farmer?")) {
                    setState(prev => ({
                        ...prev,
                        farmers: prev.farmers.map(f => f.id === id ? { ...f, active: false } : f)
                    }));
                    notify("Farmer deactivated");
                }
            };

            return (
                <div className="max-w-6xl mx-auto">
                    <Card title="Farmer Registration">
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Name</label>
                                <input 
                                    type="text" 
                                    required 
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold" 
                                    value={form.name} 
                                    onChange={e => setForm({...form, name: e.target.value})} 
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Mobile</label>
                                <input 
                                    type="text" 
                                    required 
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold" 
                                    value={form.mobile} 
                                    onChange={e => setForm({...form, mobile: e.target.value})} 
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Address</label>
                                <input 
                                    type="text" 
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold" 
                                    value={form.address} 
                                    onChange={e => setForm({...form, address: e.target.value})} 
                                />
                            </div>
                            <div className="flex items-end">
                                <button 
                                    type="submit" 
                                    className="w-full py-4 bg-blue-600 text-white rounded-xl font-black hover:bg-blue-700"
                                >{editingId ? "Update Farmer" : "Add Farmer"}</button>
                            </div>
                        </form>
                    </Card>
                    <Card title="Active Farmers">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="border-b text-[10px] font-black text-slate-400 uppercase">
                                    <tr>
                                        <th className="pb-4">Name</th>
                                        <th className="pb-4">Mobile</th>
                                        <th className="pb-4">Address</th>
                                        <th className="pb-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {state.farmers.filter(f => f.active).map(farmer => 
                                        <tr key={farmer.id}>
                                            <td className="py-4 font-black">{farmer.name}</td>
                                            <td className="py-4 font-bold text-slate-500">{farmer.mobile}</td>
                                            <td className="py-4 font-bold text-slate-500">{farmer.address}</td>
                                            <td className="py-4 text-right space-x-3">
                                                <button 
                                                    onClick={() => handleEdit(farmer)}
                                                    className="text-blue-600 font-bold hover:underline text-sm"
                                                >Edit</button>
                                                <button 
                                                    onClick={() => handleDelete(farmer.id)}
                                                    className="text-red-600 font-bold hover:underline text-sm"
                                                >Delete</button>
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            );
        };

        // Ledger Screen Component
        const LedgerScreen = ({ state }) => {
            const [selectedFarmer, setSelectedFarmer] = useState('');
            const [dateRange, setDateRange] = useState({ start: '', end: '' });

            const filteredEntries = state.milkEntries.filter(entry => {
                const matchesFarmer = selectedFarmer ? entry.farmerId === selectedFarmer : true;
                const entryDate = new Date(entry.date);
                const startDate = dateRange.start ? new Date(dateRange.start) : null;
                const endDate = dateRange.end ? new Date(dateRange.end) : null;
                
                const matchesDate = (!startDate || entryDate >= startDate) && (!endDate || entryDate <= endDate);
                return matchesFarmer && matchesDate;
            });

            const totalAmount = filteredEntries.reduce((sum, entry) => sum + parseFloat(entry.amount), 0);
            const totalQty = filteredEntries.reduce((sum, entry) => sum + parseFloat(entry.qty), 0);

            return (
                <div className="max-w-6xl mx-auto">
                    <Card title="Milk Collection Ledger">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Filter by Farmer</label>
                                <select 
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold" 
                                    value={selectedFarmer} 
                                    onChange={e => setSelectedFarmer(e.target.value)} 
                                >
                                    <option value="">All Farmers</option>
                                    {state.farmers.filter(f => f.active).map(farmer => 
                                        <option key={farmer.id} value={farmer.id}>{farmer.name}</option>
                                    )}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Start Date</label>
                                <input 
                                    type="date" 
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold" 
                                    value={dateRange.start} 
                                    onChange={e => setDateRange({...dateRange, start: e.target.value})} 
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">End Date</label>
                                <input 
                                    type="date" 
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold" 
                                    value={dateRange.end} 
                                    onChange={e => setDateRange({...dateRange, end: e.target.value})} 
                                />
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-slate-50 p-4 rounded-xl">
                            <div className="text-center p-4 bg-white rounded-xl border">
                                <p className="text-sm font-bold text-slate-500 uppercase">Total Quantity</p>
                                <p className="text-2xl font-black text-slate-800">{totalQty.toFixed(2)} L</p>
                            </div>
                            <div className="text-center p-4 bg-white rounded-xl border">
                                <p className="text-sm font-bold text-slate-500 uppercase">Total Amount</p>
                                <p className="text-2xl font-black text-slate-800">{formatCurrency(totalAmount)}</p>
                            </div>
                            <div className="text-center p-4 bg-white rounded-xl border">
                                <p className="text-sm font-bold text-slate-500 uppercase">Total Entries</p>
                                <p className="text-2xl font-black text-slate-800">{filteredEntries.length}</p>
                            </div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="border-b text-[10px] font-black text-slate-400 uppercase">
                                    <tr>
                                        <th className="pb-4">Date</th>
                                        <th className="pb-4">Farmer</th>
                                        <th className="pb-4">Shift</th>
                                        <th className="pb-4">Type</th>
                                        <th className="pb-4">Qty</th>
                                        <th className="pb-4">Fat%</th>
                                        <th className="pb-4 text-right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {filteredEntries.map(entry => {
                                        const farmer = state.farmers.find(f => f.id === entry.farmerId);
                                        return (
                                            <tr key={entry.id}>
                                                <td className="py-4 font-bold text-slate-500">{entry.date}</td>
                                                <td className="py-4 font-black">{farmer?.name || 'Unknown'}</td>
                                                <td className="py-4 font-bold text-slate-500">{entry.shift}</td>
                                                <td className="py-4 font-black">{entry.type}</td>
                                                <td className="py-4 font-black text-slate-700">{entry.qty} L</td>
                                                <td className="py-4 font-black text-amber-600">{entry.fat}</td>
                                                <td className="py-4 text-right font-black text-blue-600">{formatCurrency(entry.amount)}</td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            );
        };

        // Payments Screen Component
        const PaymentsScreen = ({ state, setState, notify }) => {
            const [form, setForm] = useState({ farmerId: '', amount: '', date: new Date().toISOString().split('T')[0], mode: 'Cash', notes: '' });

            const handleSubmit = (e) => {
                e.preventDefault();
                const newPayment = {
                    id: Date.now().toString(),
                    ...form,
                    amount: parseFloat(form.amount)
                };

                setState(prev => ({
                    ...prev,
                    payments: [...prev.payments, newPayment]
                }));

                notify(`Payment of ${formatCurrency(form.amount)} recorded`);
                setForm({ farmerId: '', amount: '', date: new Date().toISOString().split('T')[0], mode: 'Cash', notes: '' });
            };

            // Calculate farmer balances considering all transactions
            const farmerBalances = state.farmers.map(farmer => {
                // Calculate total milk value from milk entries
                const totalMilkValue = state.milkEntries
                    .filter(entry => entry.farmerId === farmer.id)
                    .reduce((sum, entry) => sum + parseFloat(entry.amount), 0);

                // Calculate total payments made (excluding deductions)
                const totalPayments = state.payments
                    .filter(payment => payment.farmerId === farmer.id && payment.type !== 'Deduction')
                    .reduce((sum, payment) => sum + parseFloat(payment.amount), 0);

                // Calculate total deductions
                const totalDeductions = state.payments
                    .filter(payment => payment.farmerId === farmer.id && payment.type === 'Deduction')
                    .reduce((sum, payment) => sum + parseFloat(payment.amount), 0);

                // Calculate total bonuses
                const totalBonuses = state.payments
                    .filter(payment => payment.farmerId === farmer.id && payment.type === 'Bonus')
                    .reduce((sum, payment) => sum + parseFloat(payment.amount), 0);

                return {
                    ...farmer,
                    totalMilkValue,
                    totalPayments,
                    totalDeductions,
                    totalBonuses,
                    balance: totalMilkValue - totalPayments + totalBonuses - totalDeductions
                };
            });

            return (
                <div className="max-w-6xl mx-auto space-y-8">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-5">
                            <div className="p-4 rounded-xl bg-blue-50 text-blue-600">
                                <Icon name="indian-rupee" size={24} />
                            </div>
                            <div>
                                <p className="text-sm font-semibold text-slate-500 uppercase tracking-wider">Total Pending</p>
                                <p className="text-2xl font-black text-slate-800">
                                    {formatCurrency(
                                        state.milkEntries.reduce((sum, entry) => sum + parseFloat(entry.amount), 0) -
                                        state.payments
                                            .filter(p => p.type !== 'Deduction' && p.type !== 'Bonus')
                                            .reduce((sum, payment) => sum + parseFloat(payment.amount), 0)
                                    )}
                                </p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-5">
                            <div className="p-4 rounded-xl bg-green-50 text-green-600">
                                <Icon name="trending-up" size={24} />
                            </div>
                            <div>
                                <p className="text-sm font-semibold text-slate-500 uppercase tracking-wider">Total Paid</p>
                                <p className="text-2xl font-black text-slate-800">
                                    {formatCurrency(
                                        state.payments
                                            .filter(p => p.type === 'Payment' && p.status === 'Completed')
                                            .reduce((sum, payment) => sum + parseFloat(payment.amount), 0)
                                    )}
                                </p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-5">
                            <div className="p-4 rounded-xl bg-amber-50 text-amber-600">
                                <Icon name="users" size={24} />
                            </div>
                            <div>
                                <p className="text-sm font-semibold text-slate-500 uppercase tracking-wider">Active Farmers</p>
                                <p className="text-2xl font-black text-slate-800">{state.farmers.filter(f => f.active).length}</p>
                            </div>
                        </div>
                    </div>

                    <Card title="Record Payment">
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                            <div className="lg:col-span-2">
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Farmer</label>
                                <select
                                    required
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                    value={form.farmerId}
                                    onChange={e => setForm({...form, farmerId: e.target.value})}
                                >
                                    <option value="">Select Farmer</option>
                                    {state.farmers.filter(f => f.active).map(farmer =>
                                        <option key={farmer.id} value={farmer.id}>{farmer.name}</option>
                                    )}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Amount</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    required
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold text-blue-600"
                                    value={form.amount}
                                    onChange={e => setForm({...form, amount: e.target.value})}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Date</label>
                                <input
                                    type="date"
                                    required
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                    value={form.date}
                                    onChange={e => setForm({...form, date: e.target.value})}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Mode</label>
                                <select
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                    value={form.mode}
                                    onChange={e => setForm({...form, mode: e.target.value})}
                                >
                                    <option value="Cash">Cash</option>
                                    <option value="Bank">Bank Transfer</option>
                                    <option value="Cheque">Cheque</option>
                                </select>
                            </div>
                            <div className="flex items-end">
                                <button
                                    type="submit"
                                    className="w-full py-4 bg-blue-600 text-white rounded-xl font-black hover:bg-blue-700"
                                >Record Payment</button>
                            </div>
                        </form>
                    </Card>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Card title="Add Bonus">
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                const newBonus = {
                                    id: Date.now().toString(),
                                    farmerId: form.farmerId,
                                    amount: parseFloat(form.amount),
                                    date: form.date,
                                    type: 'Bonus',
                                    notes: form.notes,
                                    status: 'Completed'
                                };

                                setState(prev => ({
                                    ...prev,
                                    payments: [...prev.payments, newBonus]
                                }));

                                notify(`Bonus of ${formatCurrency(form.amount)} added for ${state.farmers.find(f => f.id === form.farmerId)?.name}`);
                                setForm({ farmerId: '', amount: '', date: new Date().toISOString().split('T')[0], mode: 'Cash', notes: '' });
                            }} className="space-y-4">
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Farmer</label>
                                    <select
                                        required
                                        className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                        value={form.farmerId}
                                        onChange={e => setForm({...form, farmerId: e.target.value})}
                                    >
                                        <option value="">Select Farmer</option>
                                        {state.farmers.filter(f => f.active).map(farmer =>
                                            <option key={farmer.id} value={farmer.id}>{farmer.name}</option>
                                        )}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Amount</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        required
                                        className="w-full p-3 bg-slate-50 border rounded-xl font-bold text-green-600"
                                        value={form.amount}
                                        onChange={e => setForm({...form, amount: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Date</label>
                                    <input
                                        type="date"
                                        required
                                        className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                        value={form.date}
                                        onChange={e => setForm({...form, date: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Notes</label>
                                    <input
                                        type="text"
                                        className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                        value={form.notes}
                                        onChange={e => setForm({...form, notes: e.target.value})}
                                    />
                                </div>
                                <button
                                    type="submit"
                                    className="w-full py-4 bg-green-600 text-white rounded-xl font-black hover:bg-green-700"
                                >Add Bonus</button>
                            </form>
                        </Card>

                        <Card title="Record Deduction">
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                const newDeduction = {
                                    id: Date.now().toString(),
                                    farmerId: form.farmerId,
                                    amount: parseFloat(form.amount),
                                    date: form.date,
                                    type: 'Deduction',
                                    notes: form.notes,
                                    status: 'Completed'
                                };

                                setState(prev => ({
                                    ...prev,
                                    payments: [...prev.payments, newDeduction]
                                }));

                                notify(`Deduction of ${formatCurrency(form.amount)} recorded for ${state.farmers.find(f => f.id === form.farmerId)?.name}`);
                                setForm({ farmerId: '', amount: '', date: new Date().toISOString().split('T')[0], mode: 'Cash', notes: '' });
                            }} className="space-y-4">
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Farmer</label>
                                    <select
                                        required
                                        className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                        value={form.farmerId}
                                        onChange={e => setForm({...form, farmerId: e.target.value})}
                                    >
                                        <option value="">Select Farmer</option>
                                        {state.farmers.filter(f => f.active).map(farmer =>
                                            <option key={farmer.id} value={farmer.id}>{farmer.name}</option>
                                        )}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Amount</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        required
                                        className="w-full p-3 bg-slate-50 border rounded-xl font-bold text-red-600"
                                        value={form.amount}
                                        onChange={e => setForm({...form, amount: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Date</label>
                                    <input
                                        type="date"
                                        required
                                        className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                        value={form.date}
                                        onChange={e => setForm({...form, date: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Notes</label>
                                    <input
                                        type="text"
                                        className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                        value={form.notes}
                                        onChange={e => setForm({...form, notes: e.target.value})}
                                    />
                                </div>
                                <button
                                    type="submit"
                                    className="w-full py-4 bg-red-600 text-white rounded-xl font-black hover:bg-red-700"
                                >Record Deduction</button>
                            </form>
                        </Card>
                    </div>

                    <Card title="Farmer Balances">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="border-b text-[10px] font-black text-slate-400 uppercase">
                                    <tr>
                                        <th className="pb-4">Farmer</th>
                                        <th className="pb-4">Milk Value</th>
                                        <th className="pb-4">Payments</th>
                                        <th className="pb-4">Bonuses</th>
                                        <th className="pb-4">Deductions</th>
                                        <th className="pb-4 text-right">Balance Due</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {farmerBalances.filter(fb => fb.active).map(farmer => {
                                        // Calculate bonuses and deductions separately
                                        const bonuses = state.payments
                                            .filter(p => p.farmerId === farmer.id && p.type === 'Bonus')
                                            .reduce((sum, p) => sum + parseFloat(p.amount), 0);
                                        const deductions = state.payments
                                            .filter(p => p.farmerId === farmer.id && p.type === 'Deduction')
                                            .reduce((sum, p) => sum + parseFloat(p.amount), 0);

                                        return (
                                            <tr key={farmer.id}>
                                                <td className="py-4 font-black">{farmer.name}</td>
                                                <td className="py-4 font-black text-green-600">{formatCurrency(farmer.totalMilkValue)}</td>
                                                <td className="py-4 font-black text-blue-600">{formatCurrency(farmer.totalPayments)}</td>
                                                <td className="py-4 font-black text-green-600">{formatCurrency(bonuses)}</td>
                                                <td className="py-4 font-black text-red-600">{formatCurrency(deductions)}</td>
                                                <td className={`py-4 text-right font-black ${farmer.balance > 0 ? 'text-amber-600' : 'text-slate-600'}`}>
                                                    {formatCurrency(farmer.balance)}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </Card>

                    <Card title="Recent Transactions">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="border-b text-[10px] font-black text-slate-400 uppercase">
                                    <tr>
                                        <th className="pb-4">Date</th>
                                        <th className="pb-4">Farmer</th>
                                        <th className="pb-4">Type</th>
                                        <th className="pb-4">Amount</th>
                                        <th className="pb-4">Mode</th>
                                        <th className="pb-4 text-right">Status</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {state.payments.slice(0, 15).map(payment => {
                                        const farmer = state.farmers.find(f => f.id === payment.farmerId);
                                        const isDeduction = payment.type === 'Deduction';
                                        const isBonus = payment.type === 'Bonus';

                                        return (
                                            <tr key={payment.id}>
                                                <td className="py-4 font-bold text-slate-500">{payment.date}</td>
                                                <td className="py-4 font-black">{farmer?.name || 'Unknown'}</td>
                                                <td className="py-4 font-bold text-slate-500">{payment.type}</td>
                                                <td className={`py-4 font-black ${isDeduction ? 'text-red-600' : isBonus ? 'text-green-600' : 'text-blue-600'}`}>
                                                    {isDeduction ? '-' : ''}{formatCurrency(payment.amount)}
                                                </td>
                                                <td className="py-4 font-bold text-slate-500">{payment.mode || 'N/A'}</td>
                                                <td className="py-4 text-right font-black text-green-600">{payment.status || 'Completed'}</td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            );
        };

        // Sales Screen Component
        const SalesScreen = ({ state, setState, notify }) => {
            const [form, setForm] = useState({
                buyer: '', date: new Date().toISOString().split('T')[0],
                qty: '', rate: '', amount: '', mode: 'Cash', productType: 'Milk'
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                const newSale = {
                    id: Date.now().toString(),
                    ...form,
                    amount: (parseFloat(form.qty) * parseFloat(form.rate)).toFixed(2)
                };

                setState(prev => ({
                    ...prev,
                    sales: [...prev.sales, newSale]
                }));

                notify(`Sale of ${formatCurrency(newSale.amount)} recorded for ${form.productType}`);
                setForm({
                    buyer: '', date: new Date().toISOString().split('T')[0],
                    qty: '', rate: '', amount: '', mode: 'Cash', productType: 'Milk'
                });
            };

            const totalSales = state.sales.reduce((sum, sale) => sum + parseFloat(sale.amount), 0);
            const totalQtySold = state.sales.reduce((sum, sale) => sum + parseFloat(sale.qty), 0);

            // Group sales by product type
            const salesByProduct = {
                Milk: state.sales.filter(s => s.productType === 'Milk'),
                Feed: state.sales.filter(s => s.productType === 'Feed'),
                Ghee: state.sales.filter(s => s.productType === 'Ghee'),
                Other: state.sales.filter(s => s.productType === 'Other')
            };

            return (
                <div className="max-w-4xl mx-auto">
                    <Card title="Record Product Sale">
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                            <div className="lg:col-span-2">
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Buyer</label>
                                <input
                                    type="text"
                                    required
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                    value={form.buyer}
                                    onChange={e => setForm({...form, buyer: e.target.value})}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Product</label>
                                <select
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                    value={form.productType}
                                    onChange={e => setForm({...form, productType: e.target.value})}
                                >
                                    <option value="Milk">Milk</option>
                                    <option value="Feed">Feed</option>
                                    <option value="Ghee">Ghee</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Date</label>
                                <input
                                    type="date"
                                    required
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                    value={form.date}
                                    onChange={e => setForm({...form, date: e.target.value})}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Quantity</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    required
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold text-blue-600"
                                    value={form.qty}
                                    onChange={e => setForm({...form, qty: e.target.value})}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Rate</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    required
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold text-blue-600"
                                    value={form.rate}
                                    onChange={e => setForm({...form, rate: e.target.value})}
                                />
                            </div>
                            <div className="flex items-end">
                                <button
                                    type="submit"
                                    className="w-full py-4 bg-blue-600 text-white rounded-xl font-black hover:bg-blue-700"
                                >Record Sale</button>
                            </div>
                        </form>
                    </Card>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-5">
                            <div className="p-4 rounded-xl bg-blue-50 text-blue-600">
                                <Icon name="shopping-bag" size={24} />
                            </div>
                            <div>
                                <p className="text-sm font-semibold text-slate-500 uppercase tracking-wider">Total Sales</p>
                                <p className="text-2xl font-black text-slate-800">{formatCurrency(totalSales)}</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-5">
                            <div className="p-4 rounded-xl bg-green-50 text-green-600">
                                <Icon name="droplets" size={24} />
                            </div>
                            <div>
                                <p className="text-sm font-semibold text-slate-500 uppercase tracking-wider">Milk Volume</p>
                                <p className="text-2xl font-black text-slate-800">{salesByProduct.Milk.reduce((sum, s) => sum + parseFloat(s.qty), 0).toFixed(2)} L</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-5">
                            <div className="p-4 rounded-xl bg-amber-50 text-amber-600">
                                <Icon name="package" size={24} />
                            </div>
                            <div>
                                <p className="text-sm font-semibold text-slate-500 uppercase tracking-wider">Feed Sales</p>
                                <p className="text-2xl font-black text-slate-800">{salesByProduct.Feed.reduce((sum, s) => sum + parseFloat(s.qty), 0).toFixed(2)} Bags</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-5">
                            <div className="p-4 rounded-xl bg-rose-50 text-rose-600">
                                <Icon name="coffee" size={24} />
                            </div>
                            <div>
                                <p className="text-sm font-semibold text-slate-500 uppercase tracking-wider">Ghee Sales</p>
                                <p className="text-2xl font-black text-slate-800">{salesByProduct.Ghee.reduce((sum, s) => sum + parseFloat(s.qty), 0).toFixed(2)} Kg</p>
                            </div>
                        </div>
                    </div>
                    <div className="space-y-8">
                        {Object.entries(salesByProduct).map(([product, sales]) => {
                            if (sales.length === 0) return null;
                            return (
                                <Card key={product} title={`${product} Sales`}>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left">
                                            <thead className="border-b text-[10px] font-black text-slate-400 uppercase">
                                                <tr>
                                                    <th className="pb-4">Date</th>
                                                    <th className="pb-4">Buyer</th>
                                                    <th className="pb-4">Qty</th>
                                                    <th className="pb-4">Rate</th>
                                                    <th className="pb-4 text-right">Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y">
                                                {sales.slice(0, 10).map(sale =>
                                                    <tr key={sale.id}>
                                                        <td className="py-4 font-bold text-slate-500">{sale.date}</td>
                                                        <td className="py-4 font-black">{sale.buyer}</td>
                                                        <td className="py-4 font-black text-slate-700">{sale.qty} {product === 'Milk' ? 'L' : product === 'Feed' ? 'Bags' : product === 'Ghee' ? 'Kg' : 'Units'}</td>
                                                        <td className="py-4 font-black text-blue-600">{formatCurrency(parseFloat(sale.rate))}</td>
                                                        <td className="py-4 text-right font-black text-green-600">{formatCurrency(sale.amount)}</td>
                                                    </tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </Card>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // Inventory Screen Component
        const InventoryScreen = ({ state, setState, notify }) => {
            const [form, setForm] = useState({
                item: 'Feed',
                type: 'Purchase',
                qty: '',
                date: new Date().toISOString().split('T')[0],
                supplier: '',
                rate: '',
                amount: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                const newEntry = {
                    id: Date.now().toString(),
                    ...form,
                    qty: parseFloat(form.qty),
                    rate: parseFloat(form.rate) || 0,
                    amount: (parseFloat(form.qty) * (parseFloat(form.rate) || 0)).toFixed(2)
                };

                setState(prev => ({
                    ...prev,
                    inventory: [...prev.inventory, newEntry]
                }));

                notify(`${form.type} of ${form.qty} ${form.item} recorded`);
                setForm({
                    item: 'Feed',
                    type: 'Purchase',
                    qty: '',
                    date: new Date().toISOString().split('T')[0],
                    supplier: '',
                    rate: '',
                    amount: ''
                });
            };

            // Calculate stock levels
            const stockLevels = ['Feed', 'Ghee', 'Other'].map(itemType => {
                const purchases = state.inventory
                    .filter(inv => inv.item === itemType && inv.type === 'Purchase')
                    .reduce((sum, inv) => sum + parseFloat(inv.qty), 0);

                const sales = state.inventory
                    .filter(inv => inv.item === itemType && inv.type === 'Sale')
                    .reduce((sum, inv) => sum + parseFloat(inv.qty), 0);

                const totalValue = state.inventory
                    .filter(inv => inv.item === itemType && inv.type === 'Purchase')
                    .reduce((sum, inv) => sum + parseFloat(inv.amount), 0);

                return {
                    item: itemType,
                    totalIn: purchases,
                    totalOut: sales,
                    currentStock: purchases - sales,
                    totalValue
                };
            });

            // Calculate inventory value
            const totalInventoryValue = stockLevels.reduce((sum, item) => sum + item.totalValue, 0);

            return (
                <div className="max-w-6xl mx-auto">
                    <Card title="Inventory Management">
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-4 items-end">
                            <div className="lg:col-span-2">
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Item</label>
                                <select
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                    value={form.item}
                                    onChange={e => setForm({...form, item: e.target.value})}
                                >
                                    <option value="Feed">Animal Feed</option>
                                    <option value="Ghee">Ghee/Butter</option>
                                    <option value="Other">Other Products</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Action</label>
                                <select
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                    value={form.type}
                                    onChange={e => setForm({...form, type: e.target.value})}
                                >
                                    <option value="Purchase">Purchase</option>
                                    <option value="Sale">Sale</option>
                                    <option value="Consumption">Consumption</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Supplier</label>
                                <input
                                    type="text"
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                    value={form.supplier}
                                    onChange={e => setForm({...form, supplier: e.target.value})}
                                    placeholder="Supplier name"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Quantity</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    required
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold"
                                    value={form.qty}
                                    onChange={e => setForm({...form, qty: e.target.value})}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Rate</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    className="w-full p-3 bg-slate-50 border rounded-xl font-bold text-blue-600"
                                    value={form.rate}
                                    onChange={e => setForm({...form, rate: e.target.value})}
                                    placeholder="Rate per unit"
                                />
                            </div>
                            <div className="flex items-end">
                                <button
                                    type="submit"
                                    className="w-full py-4 bg-slate-900 text-white rounded-xl font-black uppercase text-xs tracking-widest"
                                >Update Stock</button>
                            </div>
                        </form>
                    </Card>

                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-5">
                            <div className="p-4 rounded-xl bg-blue-50 text-blue-600">
                                <Icon name="package" size={24} />
                            </div>
                            <div>
                                <p className="text-sm font-semibold text-slate-500 uppercase tracking-wider">Total Items</p>
                                <p className="text-2xl font-black text-slate-800">{state.inventory.length}</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-5">
                            <div className="p-4 rounded-xl bg-green-50 text-green-600">
                                <Icon name="trending-up" size={24} />
                            </div>
                            <div>
                                <p className="text-sm font-semibold text-slate-500 uppercase tracking-wider">Inventory Value</p>
                                <p className="text-2xl font-black text-slate-800">{formatCurrency(totalInventoryValue)}</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-5">
                            <div className="p-4 rounded-xl bg-amber-50 text-amber-600">
                                <Icon name="box" size={24} />
                            </div>
                            <div>
                                <p className="text-sm font-semibold text-slate-500 uppercase tracking-wider">Feed Stock</p>
                                <p className="text-2xl font-black text-slate-800">{stockLevels.find(s => s.item === 'Feed')?.currentStock || 0} Bags</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-5">
                            <div className="p-4 rounded-xl bg-rose-50 text-rose-600">
                                <Icon name="coffee" size={24} />
                            </div>
                            <div>
                                <p className="text-sm font-semibold text-slate-500 uppercase tracking-wider">Ghee Stock</p>
                                <p className="text-2xl font-black text-slate-800">{stockLevels.find(s => s.item === 'Ghee')?.currentStock || 0} Kg</p>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        {stockLevels.map(stock =>
                            <Card key={stock.item} title={`${stock.item} Status`}>
                                <div className="space-y-4">
                                    <div className="flex justify-between">
                                        <span className="font-bold text-slate-600">Purchased:</span>
                                        <span className="font-black text-slate-800">{stock.totalIn} {stock.item === 'Feed' ? 'Bags' : stock.item === 'Ghee' ? 'Kg' : 'Units'}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="font-bold text-slate-600">Sold/Consumed:</span>
                                        <span className="font-black text-slate-800">{stock.totalOut} {stock.item === 'Feed' ? 'Bags' : stock.item === 'Ghee' ? 'Kg' : 'Units'}</span>
                                    </div>
                                    <div className="flex justify-between pt-2 border-t">
                                        <span className="font-bold text-slate-600">Current Stock:</span>
                                        <span className={`font-black text-xl ${stock.currentStock > 10 ? 'text-green-600' : 'text-amber-600'}`}>
                                            {stock.currentStock} {stock.item === 'Feed' ? 'Bags' : stock.item === 'Ghee' ? 'Kg' : 'Units'}
                                        </span>
                                    </div>
                                    <div className="flex justify-between pt-2 border-t">
                                        <span className="font-bold text-slate-600">Value:</span>
                                        <span className="font-black text-slate-800">{formatCurrency(stock.totalValue)}</span>
                                    </div>
                                </div>
                            </Card>
                        )}
                    </div>

                    <Card title="Inventory Transactions">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="border-b text-[10px] font-black text-slate-400 uppercase">
                                    <tr>
                                        <th className="pb-4">Date</th>
                                        <th className="pb-4">Item</th>
                                        <th className="pb-4">Type</th>
                                        <th className="pb-4">Qty</th>
                                        <th className="pb-4">Rate</th>
                                        <th className="pb-4 text-right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {state.inventory.slice(0, 15).map(transaction =>
                                        <tr key={transaction.id}>
                                            <td className="py-4 font-bold text-slate-500">{transaction.date}</td>
                                            <td className="py-4 font-black">{transaction.item}</td>
                                            <td className="py-4 font-bold text-slate-500">{transaction.type}</td>
                                            <td className="py-4 font-black text-slate-700">{transaction.qty} {transaction.item === 'Feed' ? 'Bags' : transaction.item === 'Ghee' ? 'Kg' : 'Units'}</td>
                                            <td className="py-4 font-black text-blue-600">{transaction.rate ? formatCurrency(parseFloat(transaction.rate)) : 'N/A'}</td>
                                            <td className="py-4 text-right font-black text-green-600">{transaction.amount ? formatCurrency(parseFloat(transaction.amount)) : 'N/A'}</td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            );
        };

        // Define ReportsScreen inside the App component to ensure access to React hooks
        const ReportsScreen = ({ state }) => {
            const stats = useMemo(() => {
                const totalL = state.milkEntries.reduce((a,b) => a + Number(b.qty), 0);
                const totalCost = state.milkEntries.reduce((a,b) => a + Number(b.amount), 0);
                const avgRate = totalL > 0 ? (totalCost / totalL).toFixed(2) : 0;

                // Monthly breakdown
                const monthlyData = {};
                state.milkEntries.forEach(entry => {
                    const month = entry.date.substring(0, 7); // YYYY-MM
                    if (!monthlyData[month]) {
                        monthlyData[month] = { qty: 0, amount: 0, count: 0 };
                    }
                    monthlyData[month].qty += parseFloat(entry.qty);
                    monthlyData[month].amount += parseFloat(entry.amount);
                    monthlyData[month].count += 1;
                });

                return { totalL, totalCost, avgRate, monthlyData: Object.entries(monthlyData).slice(0, 12) };
            }, [state.milkEntries]);

            return (
                <div className="space-y-8 print:p-0">
                    <div className="flex justify-between items-center print:hidden">
                        <h2 className="text-3xl font-black tracking-tighter uppercase">Audit Reports</h2>
                        <button
                            onClick={() => window.print()}
                            className="px-6 py-4 bg-white border border-slate-200 rounded-xl font-black text-xs uppercase tracking-widest shadow-sm"
                        >Export PDF</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-slate-900 text-white p-10 rounded-3xl shadow-2xl">
                            <p className="text-[10px] font-black opacity-40 uppercase tracking-widest mb-2">Total Procurement</p>
                            <p className="text-4xl font-black tracking-tighter">{stats.totalL.toFixed(1)} <span className="text-sm font-bold opacity-50">LTRS</span></p>
                        </div>
                        <div className="bg-blue-600 text-white p-10 rounded-3xl shadow-2xl">
                            <p className="text-[10px] font-black opacity-40 uppercase tracking-widest mb-2">Acquisition Cost</p>
                            <p className="text-4xl font-black tracking-tighter">{formatCurrency(stats.totalCost)}</p>
                        </div>
                        <div className="bg-white border p-10 rounded-3xl shadow-sm">
                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Efficiency Index</p>
                            <p className="text-4xl font-black tracking-tighter text-slate-800">â‚¹{stats.avgRate}<span className="text-xs">/L</span></p>
                        </div>
                    </div>
                    <Card title="Monthly Collection Trend">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="border-b text-[10px] font-black text-slate-400 uppercase">
                                    <tr>
                                        <th className="pb-4">Month</th>
                                        <th className="pb-4">Collections</th>
                                        <th className="pb-4">Volume</th>
                                        <th className="pb-4 text-right">Value</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {stats.monthlyData.map(([month, data]) =>
                                        <tr key={month}>
                                            <td className="py-4 font-black">{month}</td>
                                            <td className="py-4 font-bold text-slate-500">{data.count} collections</td>
                                            <td className="py-4 font-black text-slate-700">{data.qty.toFixed(1)} L</td>
                                            <td className="py-4 text-right font-black text-blue-600">{formatCurrency(data.amount)}</td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                    <Card title="Shift-wise Efficiency Analysis">
                        <table className="w-full text-left">
                            <thead className="border-b text-[10px] font-black text-slate-400 uppercase">
                                <tr>
                                    <th className="pb-4">Shift</th>
                                    <th className="pb-4">Collections</th>
                                    <th className="pb-4">Volume</th>
                                    <th className="pb-4 text-right">Investment</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {['Morning', 'Evening'].map(shift => {
                                    const entries = state.milkEntries.filter(e => e.shift === shift);
                                    const totalQty = entries.reduce((a,b) => a + Number(b.qty), 0);
                                    const totalAmount = entries.reduce((a,b) => a + Number(b.amount), 0);

                                    return (
                                        <tr key={shift}>
                                            <td className="py-4 font-black">{shift}</td>
                                            <td className="py-4 font-bold text-slate-500">{entries.length} units</td>
                                            <td className="py-4 font-black text-slate-700">{totalQty.toFixed(1)} L</td>
                                            <td className="py-4 text-right font-black text-blue-600">{formatCurrency(totalAmount)}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </Card>
                </div>
            );
        };

        // Backup Screen Component
        const BackupScreen = ({ state, setState, notify }) => {
            const backup = () => { 
                localStorage.setItem('milkbook_backup_v1', JSON.stringify(state)); 
                setState(p => ({...p, settings: {...p.settings, lastBackup: new Date()}})); 
                notify("Backup Secured Locally"); 
            };
            const restore = () => { 
                const data = localStorage.getItem('milkbook_backup_v1'); 
                if (data && confirm("Wipe current data and restore?")) { 
                    setState(JSON.parse(data)); 
                    notify("Restored"); 
                } 
            };
            
            return (
                <div className="max-w-2xl mx-auto space-y-8">
                    <Card title="Disaster Recovery & Sync">
                        <div className="space-y-8">
                            <div className="flex items-center gap-6 bg-blue-50/50 p-8 rounded-3xl border-2 border-dashed border-blue-200">
                                <Icon name="database" size={48} className="text-blue-600" />
                                <div>
                                    <p className="font-black text-xl uppercase tracking-tighter">Persistence Engine</p>
                                    <p className="text-sm font-bold text-slate-400 italic">Latest snapshot: {state.settings.lastBackup ? formatDate(state.settings.lastBackup) : 'No snapshot found'}</p>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-6">
                                <button 
                                    onClick={backup} 
                                    className="py-6 bg-blue-600 text-white rounded-2xl font-black text-lg hover:bg-blue-700"
                                >Secure Backup</button>
                                <button 
                                    onClick={restore} 
                                    className="py-6 bg-slate-900 text-white rounded-2xl font-black text-lg hover:bg-slate-800"
                                >Restore Data</button>
                            </div>
                        </div>
                    </Card>
                    <Card title="Export Data">
                        <div className="space-y-6">
                            <button 
                                onClick={() => {
                                    const dataStr = JSON.stringify(state, null, 2);
                                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                                    const exportFileDefaultName = 'milkbook_data_export.json';
                                    const linkElement = document.createElement('a');
                                    linkElement.setAttribute('href', dataUri);
                                    linkElement.setAttribute('download', exportFileDefaultName);
                                    linkElement.click();
                                }}
                                className="w-full py-5 bg-green-600 text-white rounded-xl font-black text-lg hover:bg-green-700"
                            >Export All Data (JSON)</button>
                            <div className="bg-amber-50 p-6 rounded-2xl border border-amber-200">
                                <p className="font-black text-amber-800 mb-2 flex items-center gap-2">
                                    <Icon name="alert-circle" size={18} />
                                    Important Note
                                </p>
                                <ul className="text-sm space-y-1 text-amber-700 font-medium">
                                    <li>Data is stored in your browser. Clearing browser data may cause loss</li>
                                    <li>Always maintain external backups of critical data</li>
                                    <li>Export data regularly to prevent accidental loss</li>
                                </ul>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };

        // Settings Screen Component
        const SettingsScreen = ({ state, setState, notify }) => {
            const [rates, setRates] = useState(state.rates);
            const [pricingPlan, setPricingPlan] = useState('annual'); // 'annual' or 'lifetime'

            const save = () => {
                setState(p => ({ ...p, rates }));
                notify("System Updated");
            };

            return (
                <div className="max-w-6xl mx-auto space-y-8">
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <Card title="Pricing Architecture">
                            <div className="space-y-6">
                                <div className="space-y-6">
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b pb-2">Cow Milk Protocol</p>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase">Base Rate</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                className="w-full p-4 border rounded-xl font-black text-blue-600"
                                                value={rates.cow.base}
                                                onChange={e => setRates({...rates, cow: {...rates.cow, base: e.target.value}})}
                                            />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase">Ref Fat</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                className="w-full p-4 border rounded-xl font-black text-slate-600"
                                                value={rates.cow.fatRef}
                                                onChange={e => setRates({...rates, cow: {...rates.cow, fatRef: e.target.value}})}
                                            />
                                        </div>
                                    </div>
                                </div>
                                <div className="space-y-6">
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b pb-2">Buffalo Milk Protocol</p>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase">Base Rate</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                className="w-full p-4 border rounded-xl font-black text-blue-600"
                                                value={rates.buffalo.base}
                                                onChange={e => setRates({...rates, buffalo: {...rates.buffalo, base: e.target.value}})}
                                            />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase">Ref Fat</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                className="w-full p-4 border rounded-xl font-black text-slate-600"
                                                value={rates.buffalo.fatRef}
                                                onChange={e => setRates({...rates, buffalo: {...rates.buffalo, fatRef: e.target.value}})}
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button
                                onClick={save}
                                className="w-full mt-6 py-5 bg-blue-600 text-white rounded-2xl font-black text-lg shadow-xl shadow-blue-100 uppercase tracking-tighter"
                            >Recalibrate System Rates</button>
                        </Card>

                        <Card title="Hardware Integration">
                            <div className="space-y-6">
                                <div className="bg-blue-50 p-6 rounded-2xl border border-blue-200">
                                    <p className="font-black text-blue-800 mb-2 flex items-center gap-2">
                                        <Icon name="cpu" size={18} />
                                        Milk Analyzer Connection
                                    </p>
                                    <p className="text-sm text-blue-700 font-medium mb-4">
                                        Connect your EkoMilk, Lactoscan, or other milk analyzers directly to MilkBook
                                    </p>
                                    <button
                                        onClick={() => alert("Hardware connection requires browser with Serial API support (Chrome/Edge on Android). Connect your analyzer via USB-OTG cable.")}
                                        className="w-full py-4 bg-blue-600 text-white rounded-xl font-black flex items-center justify-center gap-2 hover:bg-blue-700"
                                    >
                                        <Icon name="zap" size={20} />
                                        Connect Hardware
                                    </button>
                                    <p className="text-xs text-blue-600 mt-3">
                                        Requires USB-Serial adapter and OTG cable for mobile devices
                                    </p>
                                </div>

                                <div className="bg-amber-50 p-6 rounded-2xl border border-amber-200">
                                    <p className="font-black text-amber-800 mb-2 flex items-center gap-2">
                                        <Icon name="smartphone" size={18} />
                                        Bring Your Own Device
                                    </p>
                                    <ul className="text-sm space-y-1 text-amber-700 font-medium">
                                        <li>â€¢ Existing Analyzer: â‚¹0 (Sunk Cost)</li>
                                        <li>â€¢ Android Tablet/Phone: â‚¹8,000</li>
                                        <li>â€¢ USB Adapter: â‚¹500</li>
                                        <li>â€¢ MilkBook Subscription: â‚¹2,500</li>
                                        <li className="font-black text-amber-800">Total CAPEX: ~â‚¹11,000</li>
                                        <li className="font-bold text-amber-900">vs â‚¹70,000 for integrated systems</li>
                                    </ul>
                                </div>
                            </div>
                        </Card>
                    </div>

                    <Card title="Subscription Plans">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className={`bg-white border-2 rounded-2xl p-6 ${pricingPlan === 'lifetime' ? 'border-blue-600 ring-2 ring-blue-100' : 'border-slate-200'}`}>
                                <div className="text-center">
                                    <p className="font-black text-slate-800 text-xl uppercase tracking-tighter">LIFETIME LICENSE</p>
                                    <p className="text-3xl font-black text-slate-800 mt-2">â‚¹7,999</p>
                                    <p className="text-sm text-slate-500 font-medium">One-time payment</p>
                                    <ul className="mt-6 space-y-3 text-left">
                                        <li className="flex items-start gap-2">
                                            <Icon name="check-circle" size={18} className="text-green-600" />
                                            <span>Manual entry, ledger, reports</span>
                                        </li>
                                        <li className="flex items-start gap-2">
                                            <Icon name="check-circle" size={18} className="text-green-600" />
                                            <span>Local backup/export</span>
                                        </li>
                                        <li className="flex items-start gap-2">
                                            <Icon name="check-circle" size={18} className="text-green-600" />
                                            <span>Offline forever</span>
                                        </li>
                                        <li className="flex items-start gap-2 text-slate-400">
                                            <Icon name="x-circle" size={18} />
                                            <span>No machine integration</span>
                                        </li>
                                        <li className="flex items-start gap-2 text-slate-400">
                                            <Icon name="x-circle" size={18} />
                                            <span>No cloud backup</span>
                                        </li>
                                    </ul>
                                    <button
                                        className="w-full mt-6 py-4 bg-slate-100 text-slate-700 rounded-xl font-black"
                                    >SELECT PLAN</button>
                                </div>
                            </div>

                            <div className={`bg-white border-2 rounded-2xl p-6 ${pricingPlan === 'annual' ? 'border-blue-600 ring-2 ring-blue-100' : 'border-slate-200'}`}>
                                <div className="text-center">
                                    <p className="font-black text-slate-800 text-xl uppercase tracking-tighter">ANNUAL PRO</p>
                                    <p className="text-3xl font-black text-slate-800 mt-2">â‚¹2,499</p>
                                    <p className="text-sm text-slate-500 font-medium">Per year</p>
                                    <ul className="mt-6 space-y-3 text-left">
                                        <li className="flex items-start gap-2">
                                            <Icon name="check-circle" size={18} className="text-green-600" />
                                            <span>All Lifetime features</span>
                                        </li>
                                        <li className="flex items-start gap-2">
                                            <Icon name="check-circle" size={18} className="text-green-600" />
                                            <span>Machine integration</span>
                                        </li>
                                        <li className="flex items-start gap-2">
                                            <Icon name="check-circle" size={18} className="text-green-600" />
                                            <span>WhatsApp receipts</span>
                                        </li>
                                        <li className="flex items-start gap-2">
                                            <Icon name="check-circle" size={18} className="text-green-600" />
                                            <span>Cloud backup</span>
                                        </li>
                                        <li className="flex items-start gap-2">
                                            <Icon name="check-circle" size={18} className="text-green-600" />
                                            <span>Priority support</span>
                                        </li>
                                    </ul>
                                    <button
                                        className="w-full mt-6 py-4 bg-slate-100 text-slate-700 rounded-xl font-black"
                                    >SELECT PLAN</button>
                                </div>
                            </div>

                            <div className="bg-white border-2 border-slate-200 rounded-2xl p-6">
                                <div className="text-center">
                                    <p className="font-black text-slate-800 text-xl uppercase tracking-tighter">TECHNICIAN PARTNER</p>
                                    <p className="text-3xl font-black text-slate-800 mt-2">â‚¹500</p>
                                    <p className="text-sm text-slate-500 font-medium">Per successful referral</p>
                                    <ul className="mt-6 space-y-3 text-left">
                                        <li className="flex items-start gap-2">
                                            <Icon name="user-check" size={18} className="text-green-600" />
                                            <span>Authorized partner program</span>
                                        </li>
                                        <li className="flex items-start gap-2">
                                            <Icon name="smartphone" size={18} className="text-green-600" />
                                            <span>Install during service visits</span                                        </li>
                                        <li className="flex items-start gap-2">
                                            <Icon name="rupee" size={18} className="text-green-600" />
                                            <span>Earn â‚¹500 per successful conversion</span>
                                        </li>
                                        <li className="flex items-start gap-2">
                                            <Icon name="shield-check" size={18} className="text-green-600" />
                                            <span>Trusted by dairy owners</span>
                                        </li>
                                        <li className="flex items-start gap-2">
                                            <Icon name="trending-up" size={18} className="text-green-600" />
                                            <span>Turn service calls into sales</span>
                                        </li>
                                    </ul>
                                    <button
                                        onClick={() => {
                                            const message = "Become a MilkBook authorized partner and earn â‚¹500 per successful referral. Contact us for partnership details.";
                                            const encodedMessage = encodeURIComponent(message);
                                            window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
                                        }}
                                        className="w-full mt-6 py-4 bg-green-600 text-white rounded-xl font-black"
                                    >REFER NOW</button>
                                </div>
                            </div>
                        </div>
                    </Card>

                    <div className="flex justify-between items-center p-8 bg-rose-50 border-2 border-rose-100 rounded-3xl">
                        <div className="pr-12">
                            <p className="font-black text-rose-800 uppercase tracking-tighter text-xl">Factory Reset</p>
                            <p className="text-sm font-bold text-rose-600 opacity-80 uppercase tracking-widest">Permanent erasure of all centers, farmers, and logs.</p>
                        </div>
                        <button
                            onClick={() => {
                                if(confirm("ABSOLUTE WIPE?")) {
                                    localStorage.clear();
                                    window.location.reload();
                                }
                            }}
                            className="px-8 py-4 bg-rose-600 text-white rounded-xl font-black uppercase text-xs tracking-widest"
                        >Execute Wipe</button>
                    </div>
                </div>
            );
        };

        // Main App Component with enhanced features
        function App() {
            const [state, setState] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? JSON.parse(saved) : INITIAL_STATE;
            });
            const [isSidebarOpen, setSidebarOpen] = useState(true);
            const [notif, setNotif] = useState(null);
            const [serialPort, setSerialPort] = useState(null);
            const [isConnected, setIsConnected] = useState(false);

            // Persistence
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            }, [state]);

            // Serial port connection for hardware integration
            const connectHardware = async () => {
                if ('serial' in navigator) {
                    try {
                        const port = await navigator.serial.requestPort();
                        await port.open({ baudRate: 9600 });
                        setSerialPort(port);
                        setIsConnected(true);

                        // Start reading data
                        const reader = port.readable.getReader();
                        readSerialData(reader);

                        notify("Hardware connected successfully");
                    } catch (error) {
                        notify("Failed to connect hardware: " + error.message, 'error');
                    }
                } else {
                    notify("Serial API not supported in this browser", 'error');
                }
            };

            // Read serial data from connected device
            const readSerialData = async (reader) => {
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;

                        const textDecoder = new TextDecoder();
                        const dataString = textDecoder.decode(value);

                        // Parse data from analyzer (e.g., "M 1234 F 04.50 S 08.50 W 02.00")
                        const fatMatch = dataString.match(/F\s*(\d+\.?\d*)/);
                        const snfMatch = dataString.match(/S\s*(\d+\.?\d*)/);
                        const waterMatch = dataString.match(/W\s*(\d+\.?\d*)/);

                        if (fatMatch && snfMatch) {
                            // This would update the form in the milk entry screen
                            // For now, we'll just show a notification
                            notify(`Analyzer reading: Fat ${fatMatch[1]}%, SNF ${snfMatch[1]}%`);
                        }
                    }
                } catch (error) {
                    console.error("Error reading serial data:", error);
                } finally {
                    reader.releaseLock();
                }
            };

            const notify = (msg, type = 'success') => {
                setNotif({ msg, type });
                setTimeout(() => setNotif(null), 3000);
            };

            const navigate = (screen) => setState(prev => ({ ...prev, currentScreen: screen }));
            const logout = () => setState(prev => ({ ...prev, auth: { isAuthenticated: false, user: null }, currentScreen: 'login' }));

            // Generate PDF reports with vernacular support
            const generatePDFReport = (reportType) => {
                // This would use @react-pdf/renderer with proper font support
                // For now, we'll simulate the functionality
                const data = {
                    title: reportType,
                    date: new Date().toLocaleDateString('en-IN'),
                    content: "Detailed report content would be generated here with proper Indic script support"
                };

                // Create a blob and download
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `milkbook_${reportType.toLowerCase()}_report_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                notify(`${reportType} report generated`);
            };

            // WhatsApp sharing functionality
            const shareViaWhatsApp = (message) => {
                const encodedMessage = encodeURIComponent(message);
                window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
            };

            // Serial port connection for hardware integration
            const connectHardware = async () => {
                if ('serial' in navigator) {
                    try {
                        const port = await navigator.serial.requestPort();
                        await port.open({ baudRate: 9600 });
                        setSerialPort(port);
                        setIsConnected(true);

                        // Start reading data
                        const reader = port.readable.getReader();
                        readSerialData(reader);

                        notify("Hardware connected successfully");
                    } catch (error) {
                        notify("Failed to connect hardware: " + error.message, 'error');
                    }
                } else {
                    notify("Serial API not supported in this browser", 'error');
                }
            };

            // Read serial data from connected device
            const readSerialData = async (reader) => {
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;

                        const textDecoder = new TextDecoder();
                        const dataString = textDecoder.decode(value);

                        // Parse data from analyzer (e.g., "M 1234 F 04.50 S 08.50 W 02.00")
                        const fatMatch = dataString.match(/F\s*(\d+\.?\d*)/);
                        const snfMatch = dataString.match(/S\s*(\d+\.?\d*)/);
                        const waterMatch = dataString.match(/W\s*(\d+\.?\d*)/);

                        if (fatMatch && snfMatch) {
                            // This would update the form in the milk entry screen
                            // For now, we'll just show a notification
                            notify(`Analyzer reading: Fat ${fatMatch[1]}%, SNF ${snfMatch[1]}%`);
                        }
                    }
                } catch (error) {
                    console.error("Error reading serial data:", error);
                } finally {
                    reader.releaseLock();
                }
            };

            // Simple render function
            const renderScreen = () => {
                switch (state.currentScreen) {
                    case 'login':
                        return <LoginScreen state={state} setState={setState} notify={notify} navigate={navigate} />;
                    case 'register':
                        return <RegisterScreen setState={setState} notify={notify} navigate={navigate} />;
                    case 'dashboard':
                        return <DashboardScreen state={state} navigate={navigate} />;
                    case 'setup':
                        return <SetupWizard state={state} setState={setState} notify={notify} navigate={navigate} />;
                    case 'milkEntry':
                        return <MilkEntryScreen state={state} setState={setState} notify={notify} />;
                    case 'farmers':
                        return <FarmerManagementScreen state={state} setState={setState} notify={notify} />;
                    case 'ledger':
                        return <LedgerScreen state={state} />;
                    case 'payments':
                        return <PaymentsScreen state={state} setState={setState} notify={notify} />;
                    case 'sales':
                        return <SalesScreen state={state} setState={setState} notify={notify} />;
                    case 'inventory':
                        return <InventoryScreen state={state} setState={setState} notify={notify} />;
                    case 'reports':
                        return <ReportsScreen state={state} />;
                    case 'backup':
                        return <BackupScreen state={state} setState={setState} notify={notify} />;
                    case 'settings':
                        return <SettingsScreen state={state} setState={setState} notify={notify} />;
                    default:
                        return <div className="p-8 text-center">Screen not implemented yet: {state.currentScreen}</div>;
                }
            };

            // Reports Screen Component (moved inside App to ensure access to React hooks)
            const ReportsScreen = ({ state }) => {
                const stats = useMemo(() => {
                    const totalL = state.milkEntries.reduce((a,b) => a + Number(b.qty), 0);
                    const totalCost = state.milkEntries.reduce((a,b) => a + Number(b.amount), 0);
                    const avgRate = totalL > 0 ? (totalCost / totalL).toFixed(2) : 0;

                    // Monthly breakdown
                    const monthlyData = {};
                    state.milkEntries.forEach(entry => {
                        const month = entry.date.substring(0, 7); // YYYY-MM
                        if (!monthlyData[month]) {
                            monthlyData[month] = { qty: 0, amount: 0, count: 0 };
                        }
                        monthlyData[month].qty += parseFloat(entry.qty);
                        monthlyData[month].amount += parseFloat(entry.amount);
                        monthlyData[month].count += 1;
                    });

                    return { totalL, totalCost, avgRate, monthlyData: Object.entries(monthlyData).slice(0, 12) };
                }, [state.milkEntries]);

                return (
                    <div className="space-y-8 print:p-0">
                        <div className="flex justify-between items-center print:hidden">
                            <h2 className="text-3xl font-black tracking-tighter uppercase">Audit Reports</h2>
                            <button
                                onClick={() => window.print()}
                                className="px-6 py-4 bg-white border border-slate-200 rounded-xl font-black text-xs uppercase tracking-widest shadow-sm"
                            >Export PDF</button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="bg-slate-900 text-white p-10 rounded-3xl shadow-2xl">
                                <p className="text-[10px] font-black opacity-40 uppercase tracking-widest mb-2">Total Procurement</p>
                                <p className="text-4xl font-black tracking-tighter">{stats.totalL.toFixed(1)} <span className="text-sm font-bold opacity-50">LTRS</span></p>
                            </div>
                            <div className="bg-blue-600 text-white p-10 rounded-3xl shadow-2xl">
                                <p className="text-[10px] font-black opacity-40 uppercase tracking-widest mb-2">Acquisition Cost</p>
                                <p className="text-4xl font-black tracking-tighter">{formatCurrency(stats.totalCost)}</p>
                            </div>
                            <div className="bg-white border p-10 rounded-3xl shadow-sm">
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Efficiency Index</p>
                                <p className="text-4xl font-black tracking-tighter text-slate-800">â‚¹{stats.avgRate}<span className="text-xs">/L</span></p>
                            </div>
                        </div>
                        <Card title="Monthly Collection Trend">
                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="border-b text-[10px] font-black text-slate-400 uppercase">
                                        <tr>
                                            <th className="pb-4">Month</th>
                                            <th className="pb-4">Collections</th>
                                            <th className="pb-4">Volume</th>
                                            <th className="pb-4 text-right">Value</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {stats.monthlyData.map(([month, data]) =>
                                            <tr key={month}>
                                                <td className="py-4 font-black">{month}</td>
                                                <td className="py-4 font-bold text-slate-500">{data.count} collections</td>
                                                <td className="py-4 font-black text-slate-700">{data.qty.toFixed(1)} L</td>
                                                <td className="py-4 text-right font-black text-blue-600">{formatCurrency(data.amount)}</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </Card>
                        <Card title="Shift-wise Efficiency Analysis">
                            <table className="w-full text-left">
                                <thead className="border-b text-[10px] font-black text-slate-400 uppercase">
                                    <tr>
                                        <th className="pb-4">Shift</th>
                                        <th className="pb-4">Collections</th>
                                        <th className="pb-4">Volume</th>
                                        <th className="pb-4 text-right">Investment</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {['Morning', 'Evening'].map(shift => {
                                        const entries = state.milkEntries.filter(e => e.shift === shift);
                                        const totalQty = entries.reduce((a,b) => a + Number(b.qty), 0);
                                        const totalAmount = entries.reduce((a,b) => a + Number(b.amount), 0);

                                        return (
                                            <tr key={shift}>
                                                <td className="py-4 font-black">{shift}</td>
                                                <td className="py-4 font-bold text-slate-500">{entries.length} units</td>
                                                <td className="py-4 font-black text-slate-700">{totalQty.toFixed(1)} L</td>
                                                <td className="py-4 text-right font-black text-blue-600">{formatCurrency(totalAmount)}</td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </Card>
                    </div>
                );
            };

            const needsAuth = !['login', 'register'].includes(state.currentScreen);

            if (needsAuth && !state.auth.isAuthenticated) {
                return <LoginScreen state={state} setState={setState} notify={notify} navigate={navigate} />;
            }

            return (
                <div className="min-h-screen bg-slate-50 flex overflow-hidden">
                    {notif && (
                        <div className={`fixed top-6 right-6 z-[100] px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 animate-bounce border-l-4 bg-white ${
                            notif.type === 'success' ? 'border-green-500 text-green-700' : 'border-red-500 text-red-700'
                        }`}>
                            <Icon name={notif.type === 'success' ? 'check-circle' : 'alert-circle'} size={20} />
                            <span className="font-bold">{notif.msg}</span>
                        </div>
                    )}

                    <>
                        {/* Sidebar */}
                        <aside className={`${isSidebarOpen ? 'w-64' : 'w-20'} bg-slate-900 text-white flex flex-col transition-all duration-300 print:hidden shrink-0`}>
                            <div className="p-6 flex items-center gap-3 border-b border-slate-800">
                                <div className="bg-blue-600 p-2 rounded-lg">
                                    <Icon name="droplet" className="text-white" size={20} />
                                </div>
                                {isSidebarOpen && <span className="font-bold text-xl uppercase tracking-tighter">MilkBook</span>}
                            </div>
                            <nav className="flex-1 mt-4 px-3 space-y-1">
                                <button onClick={() => navigate('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
                                    state.currentScreen === 'dashboard' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                                }`}>
                                    <Icon name="layout-dashboard" size={20} className="shrink-0" />
                                    {!isSidebarOpen || <span className="font-bold text-sm tracking-tight">Dashboard</span>}
                                </button>
                                <button onClick={() => navigate('milkEntry')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
                                    state.currentScreen === 'milkEntry' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                                }`}>
                                    <Icon name="droplets" size={20} className="shrink-0" />
                                    {!isSidebarOpen || <span className="font-bold text-sm tracking-tight">Milk Collection</span>}
                                </button>
                                <button onClick={() => navigate('farmers')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
                                    state.currentScreen === 'farmers' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                                }`}>
                                    <Icon name="users" size={20} className="shrink-0" />
                                    {!isSidebarOpen || <span className="font-bold text-sm tracking-tight">Farmers</span>}
                                </button>
                                <button onClick={() => navigate('ledger')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
                                    state.currentScreen === 'ledger' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                                }`}>
                                    <Icon name="book-open" size={20} className="shrink-0" />
                                    {!isSidebarOpen || <span className="font-bold text-sm tracking-tight">Ledger</span>}
                                </button>
                                <button onClick={() => navigate('payments')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
                                    state.currentScreen === 'payments' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                                }`}>
                                    <Icon name="indian-rupee" size={20} className="shrink-0" />
                                    {!isSidebarOpen || <span className="font-bold text-sm tracking-tight">Payments</span>}
                                </button>
                                <button onClick={() => navigate('sales')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
                                    state.currentScreen === 'sales' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                                }`}>
                                    <Icon name="shopping-bag" size={20} className="shrink-0" />
                                    {!isSidebarOpen || <span className="font-bold text-sm tracking-tight">Milk Sales</span>}
                                </button>
                                <button onClick={() => navigate('inventory')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
                                    state.currentScreen === 'inventory' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                                }`}>
                                    <Icon name="warehouse" size={20} className="shrink-0" />
                                    {!isSidebarOpen || <span className="font-bold text-sm tracking-tight">Inventory</span>}
                                </button>
                                <button onClick={() => navigate('reports')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
                                    state.currentScreen === 'reports' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                                }`}>
                                    <Icon name="bar-chart-3" size={20} className="shrink-0" />
                                    {!isSidebarOpen || <span className="font-bold text-sm tracking-tight">Reports</span>}
                                </button>
                                <div className="pt-6 border-t border-slate-800 mt-6 space-y-1">
                                    <button onClick={() => navigate('backup')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
                                        state.currentScreen === 'backup' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                                    }`}>
                                        <Icon name="database" size={20} className="shrink-0" />
                                        {!isSidebarOpen || <span className="font-bold text-sm tracking-tight">Backup</span>}
                                    </button>
                                    <button onClick={() => navigate('settings')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
                                        state.currentScreen === 'settings' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                                    }`}>
                                        <Icon name="settings" size={20} className="shrink-0" />
                                        {!isSidebarOpen || <span className="font-bold text-sm tracking-tight">Settings</span>}
                                    </button>
                                    <button onClick={logout} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
                                        'text-slate-400 hover:bg-slate-800 hover:text-white'
                                    }`}>
                                        <Icon name="log-out" size={20} className="shrink-0" />
                                        {!isSidebarOpen || <span className="font-bold text-sm tracking-tight">Logout</span>}
                                    </button>
                                </div>
                            </nav>
                            <button 
                                onClick={() => setSidebarOpen(!isSidebarOpen)} 
                                className="p-4 hover:bg-slate-800 flex items-center justify-center transition-colors"
                            >
                                <Icon name={isSidebarOpen ? "x" : "menu"} size={20} />
                            </button>
                        </aside>

                        {/* Main */}
                        <main className="flex-1 flex flex-col min-w-0">
                            <header className="h-16 bg-white border-b flex items-center justify-between px-8 shrink-0 print:hidden shadow-sm">
                                <div className="flex items-center gap-4">
                                    <h1 className="text-xl font-bold text-slate-800 uppercase tracking-wide truncate max-w-[300px]">{state.dairyInfo.name || 'Milk Collection Center'}</h1>
                                    <span className="text-xs px-3 py-1 bg-blue-50 text-blue-700 rounded-full font-bold flex items-center gap-1">
                                        <Icon name="clock" size={14} /> {formatDate(new Date())}
                                    </span>
                                </div>
                                <div className="flex items-center gap-6">
                                    <div className="flex items-center gap-2">
                                        <span className={`w-2.5 h-2.5 rounded-full ${state.settings.backupEnabled ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></span>
                                        <span className="text-[10px] font-black text-slate-400 uppercase tracking-tighter">System Healthy</span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div className="text-right">
                                            <p className="text-sm font-bold text-slate-700">{state.auth.user?.name}</p>
                                            <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Administrator</p>
                                        </div>
                                        <div className="w-10 h-10 bg-slate-200 rounded-lg flex items-center justify-center font-black text-slate-600 border shadow-inner">
                                            {state.auth.user?.name?.charAt(0) || 'U'}
                                        </div>
                                    </div>
                                </div>
                            </header>
                            <div className="flex-1 overflow-y-auto p-8 bg-slate-50/50">
                                {renderScreen()}
                            </div>
                        </main>
                    </>

                    {/* Footer with designer attribution */}
                    <footer className="print:hidden text-center py-4 text-slate-500 text-sm border-t bg-slate-50">
                        Designed by <span className="font-bold text-slate-700">signimus</span>
                    </footer>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>