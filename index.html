<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="logo.jpg">
    
    <title>MilkRecord - Dairy Management</title>

    <style>
      :root {
        --bg: #f4f7fb;
        --panel: #ffffff;
        --line: #e5e7eb;
        --text: #0f172a;
        --muted: #64748b;

        --blue: #2563eb;
        --blue2: #1d4ed8;

        --green: #16a34a;
        --red: #dc2626;
        --yellow: #f59e0b;

        --soft-green: #ecfdf5;
        --soft-yellow: #fffbeb;
        --soft-blue: #eff6ff;
        --soft-pink: #fff1f2;

        --shadow: 0 12px 26px rgba(0, 0, 0, 0.08);
        --r: 18px;

        --tile: 78px;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
      }
      body {
        background: var(--bg);
        color: var(--text);
        touch-action: manipulation;
      }

      /* APP FRAME */
      .app {
        height: 100vh;
        width: 100%;
        display: grid;
        grid-template-rows: auto 1fr;
        gap: 8px;
        padding: 6px;
        box-sizing: border-box;
        margin: 0;
      }

      /* HEADER */
      .topbar {
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 4px;
        box-shadow: var(--shadow);
        padding: 4px 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 32px;
        flex-shrink: 0;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 3px;
        min-width: 80px;
      }
      .logo {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg, #2563eb, #1d4ed8);
        border: 2px solid #1e40af;
        font-weight: 1000;
        font-size: 24px;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
      }
      .brand .title {
        font-weight: 1000;
        font-size: 14px;
        line-height: 1.1;
      }
      .brand .sub {
        font-weight: 800;
        color: var(--muted);
        font-size: 10px;
        margin-top: 2px;
      }
      .hdr-actions {
        display: flex;
        align-items: center;
        gap: 3px;
      }
      .pillbtn {
        height: 12px;
        padding: 0 4px;
        border-radius: 3px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 900;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 2px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        font-size: 7px;
      }
      .pillbtn.primary {
        background: var(--blue);
        color: #fff;
        border-color: transparent;
      }
      .pillbtn.warn {
        background: #fbbf24;
        color: #78350f;
        border-color: transparent;
      }
      .pillbtn:active {
        transform: translateY(1px);
      }

      .hdr-right {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 14px;
      }
      .timer {
        height: 44px;
        padding: 0 14px;
        border-radius: 14px;
        border: 1px dashed #cbd5e1;
        background: #fff;
        font-weight: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 120px;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .iconbtn {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        font-size: 18px;
      }
      .iconbtn:active {
        transform: translateY(1px);
      }

      /* CORE - Desktop Default (Side by Side) */
      .core {
        height: 100%;
        min-height: 0;
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 14px;
        overflow: hidden;
        width: 100%;
      }
      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 22px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
        height: 100%;
      }
      /* Tablet (768px - 1024px): Side by side with adjusted heights */
      @media (min-width: 768px) and (max-width: 1024px) {
        .core {
          grid-template-columns: 1fr 1fr !important;
          gap: 10px;
        }
        .panel {
          max-height: none;
          overflow-y: auto;
        }
        .actionBody {
          max-height: none;
        }
        .trustBody {
          max-height: none;
        }
      }
      /* Desktop (1024px+): Full side by side */
      @media (min-width: 1025px) {
        .core {
          grid-template-columns: 1fr 1fr !important;
        }
        .panel {
          max-height: none;
          overflow-y: auto;
        }
      }

      /* Mobile: Stack panels vertically (portrait) */
      @media (max-width: 767px) {
        html, body {
          position: fixed;
          overflow: hidden;
          height: 100%;
          width: 100%;
        }
        .app {
          padding: 8px;
          gap: 10px;
          height: 100vh;
          height: 100%;
          display: flex;
          flex-direction: column;
        }
        .core {
          grid-template-columns: 1fr !important;
          grid-template-rows: auto 1fr;
          overflow-y: hidden;
          height: 100%;
          min-height: 0;
          gap: 10px;
          flex: 1 1 auto;
          display: flex;
          flex-direction: column;
        }
        .panel {
          max-height: none !important;
          height: 100%;
          min-height: 0;
          border-radius: 16px;
          flex-shrink: 0;
        }
        .panelHeader {
          flex-wrap: wrap;
          gap: 8px;
        }
        .searchBox {
          order: 1;
          max-width: 100% !important;
          flex: 1 1 100%;
        }
        #btnAddFarmerMain {
          order: 2;
        }
        #farmerCount {
          order: 3;
        }
        .actionBody {
          max-height: none !important;
          overflow-y: auto !important;
          padding-right: 4px;
          height: 100%;
          flex: 1;
        }
        .trustBody {
          overflow-y: auto !important;
          max-height: none !important;
          height: 100%;
          flex: 1;
        }
        /* Compact inputs on mobile */
        .control {
          padding: 8px;
        }
        .numBig input {
          font-size: 24px;
        }
        .amountBox {
          padding: 15px;
        }
        .amountBox .amt {
          font-size: 42px;
        }
        /* Bottom buttons full width on mobile */
        .bottom {
          grid-template-columns: 1fr !important;
          gap: 8px;
          height: auto;
          flex-shrink: 0;
          position: sticky;
          bottom: 0;
          background: var(--bg);
          padding: 8px 0;
        }
        .panicBtn {
          height: 50px;
          font-size: 16px;
        }
      }

      /* Extra small mobile (320px - 480px) */
      @media (max-width: 480px) {
        .topbar {
          padding: 6px 8px;
        }
        .brand .title {
          font-size: 14px;
        }
        .pillbtn {
          height: 38px;
          padding: 0 10px;
          font-size: 11px;
        }
        .farmerGrid {
          grid-template-columns: repeat(2, 1fr) !important;
        }
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 22px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
        height: 100%;
      }
      .panelHeader {
        padding: 8px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--line);
        font-weight: 1000;
        background: #fff;
        flex-shrink: 0;
      }
      .panelHeader small {
        color: var(--muted);
        font-weight: 900;
      }

      /* LEFT BODY */
      .actionBody {
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex: 1;
        overflow-y: auto;
        padding-right: 6px;
        min-height: 0;
      }

      /* FARMER PICK */
      .farmerPick {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 0 0 200px;
        min-height: 200px;
        max-height: 200px;
      }

      .searchBox {
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #fff;
        padding: 6px 10px;
        height: 36px;
      }
      .searchBox input {
        width: 100%;
        border: none;
        outline: none;
        font-size: 14px;
        font-weight: 900;
        color: var(--text);
        background: transparent;
      }
      .addNewBtn {
        height: 36px;
        padding: 0 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #eef2ff;
        font-weight: 1000;
        cursor: pointer;
        font-size: 13px;
      }
      .miniTag {
        height: 36px;
        min-width: 70px;
        padding: 0 10px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 1000;
        color: var(--muted);
        font-size: 13px;
      }
      .farmerGrid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 4px;

        max-height: 220px;
        overflow-y: auto;
        overflow-x: auto;
        padding: 4px;

        position: relative;
        flex: 1 1 auto;
        min-height: 200px;
      }
      .farmerGrid::-webkit-scrollbar { width: 6px; height: 6px; }
      .farmerGrid::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

      .fcard {
        height: auto;
        min-height: 16px;
        border-radius: 3px;
        border: 1px solid var(--line);
        background: #fff;
        display: flex;
        align-items: center;
        gap: 2px;
        padding: 2px;
        cursor: pointer;
        position: relative;
        overflow: visible;
      }
      .fcard:active {
        transform: translateY(1px);
      }
      .fimg {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        background: #f1f5f9;
        border: 1px solid var(--line);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
        flex: 0 0 14px;
        overflow: hidden;
      }
      .fimg img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .fname {
        font-weight: 900;
        font-size: 16px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        line-height: 1.2;
        flex: 1 1 auto;
        min-width: 0;
      }
      .fsub {
        color: var(--muted);
        font-weight: 900;
        font-size: 11px;
        margin-top: 3px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }
      .editFarmerBtn {
        opacity: 0;
        transition: opacity 0.2s;
        flex: 0 0 auto;
        font-size: 14px;
        padding: 4px;
      }
      .fcard:hover .editFarmerBtn {
        opacity: 0.7;
      }
      .editFarmerBtn:hover {
        opacity: 1 !important;
      }
      .fsel {
        outline: 3px solid rgba(22, 163, 74, 0.45);
        box-shadow: 0 0 0 6px rgba(22, 163, 74, 0.1);
      }
      .badge {
        position: absolute;
        right: 3px;
        top: 3px;
        padding: 2px 4px;
        border-radius: 6px;
        background: rgba(22, 163, 74, 0.12);
        border: 1px solid rgba(22, 163, 74, 0.25);
        font-weight: 1000;
        color: #166534;
        font-size: 6px;
      }
      
      /* Mobile Optimization for Farmer Cards */
      @media (max-width: 768px) {
        .fcard {
          padding: 10px;
          gap: 10px;
          min-height: 70px;
        }
        .fimg {
          width: 50px;
          height: 50px;
          font-size: 22px;
        }
        .fname {
          font-size: 15px;
        }
        .fsub {
          font-size: 12px;
        }
        .editFarmerBtn {
          opacity: 0.5;
          font-size: 18px;
        }
        .badge {
          font-size: 10px;
          padding: 4px 6px;
          top: 4px;
          right: 4px;
        }
      }
      
      /* Extra Small Mobile */
      @media (max-width: 480px) {
        .fcard {
          padding: 8px;
          gap: 6px;
        }
        .fimg {
          width: 40px;
          height: 40px;
          font-size: 18px;
        }
        .fname {
          font-size: 13px;
        }
        .fsub {
          font-size: 11px;
        }
        .editFarmerBtn {
          opacity: 0.4;
          font-size: 16px;
          padding: 2px 4px;
        }
      }
      .farmerNav {
        display: flex;
        justify-content: center;
        gap: 10px;
      }

      .navBtn {
        width: 48%;
        height: 44px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1000;
        cursor: pointer;
      }
      .navBtn:active {
        transform: translateY(1px);
      }
      .navBtn[disabled] {
        opacity: 0.45;
        cursor: not-allowed;
      }

      /* INPUTS GRID */
      .inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .control {
        border-radius: 18px;
        border: 2px solid var(--line);
        padding: 12px;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 4px;
        min-height: 110px;
        background: #fff;
        transition: all 0.2s;
      }
      .control:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      }
      .control.green {
        background: var(--soft-green);
        border-color: #86efac;
      }
      .control.yellow {
        background: var(--soft-yellow);
        border-color: #fcd34d;
      }
      .control.blue {
        background: var(--soft-blue);
        border-color: #93c5fd;
      }
      .ctrlTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 900;
        font-size: 11px;
        color: #1e293b;
      }
      .ctrlTop .muted {
        color: #64748b;
        font-weight: 700;
        font-size: 9px;
      }
      .numBig {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 900;
        letter-spacing: 0.3px;
        color: #1e293b;
      }

      .numInput {
        width: 100%;
        text-align: center;
        font-size: 24px;
        font-weight: 900;
        border: none;
        outline: none;
        background: transparent;
        color: #1e293b;
      }
      .numInput:focus {
        text-align: center;
        background: rgba(255,255,255,0.5);
        border-radius: 8px;
      }
      .numInput::-webkit-outer-spin-button,
      .numInput::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .pmRow {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .pm {
        height: 50px;
        border: none;
        border-radius: 16px;
        background: #fff;
        border: 1px solid var(--line);
        font-size: 26px;
        font-weight: 1100;
        cursor: pointer;
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.06);
      }
      .pm:active {
        transform: translateY(1px);
      }

      /* ANIMAL + RATE MODE ROW */
      .row3 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .animalCard {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 18px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-height: 96px;
      }
      .animalCard label {
        font-weight: 1000;
        color: var(--muted);
        font-size: 12px;
        letter-spacing: 0.3px;
      }
      .animalCard button {
        transition: all 0.2s;
        cursor: pointer;
      }
      .animalCard button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
      .animalCard button:active {
        transform: translateY(0);
      }
      .animalCard button.selected {
        border-color: #2563eb !important;
        background: #dbeafe !important;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2) !important;
        transform: scale(1.02);
      }

      .rateCard {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 18px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 96px;
      }
      .modeRow {
        display: flex;
        gap: 10px;
      }
      .modeBtn {
        flex: 1;
        height: 52px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #f1f5f9;
        font-weight: 1100;
        cursor: pointer;
      }
      .modeBtn.active {
        background: #fef3c7;
        border-color: #fcd34d;
      }
      .modeBtn:active {
        transform: translateY(1px);
      }

      /* MANUAL RATE OVERRIDE */
      .manualOverride {
        border: 2px dashed #cbd5e1;
        background: #f8fafc;
        border-radius: 18px;
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .manualOverride .left {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 1000;
        color: var(--muted);
      }
      .manualRateRow {
        display: flex !important;
        gap: 10px;
        grid-template-columns: 1fr auto;
        align-items: center;
      }
      .manualRateRow input {
        height: 52px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
        font-size: 20px;
        padding: 0 12px;
        outline: none;
        width: 220px;
      }
      .manualRateRow button {
        height: 52px;
        width: 68px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
        cursor: pointer;
      }

      /* RIGHT BODY */
      .trustBody {
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        overflow-y: auto;
        flex: 1;
        min-height: 0;
      }
      .amountBox {
        background: linear-gradient(180deg, var(--blue), var(--blue2));
        border-radius: 12px;
        padding: 20px;
        color: #fff;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
        margin-bottom: 12px;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .amountBox .label {
        opacity: 0.95;
        font-weight: 1000;
        letter-spacing: 1px;
        font-size: 14px;
        text-transform: uppercase;
      }
      .amountBox .amt {
        font-size: 48px;
        font-weight: 1200;
        line-height: 1.3;
        margin-top: 8px;
        letter-spacing: 2px;
      }
      .amountBox .sub {
        margin-top: 10px;
        display: inline-flex;
        gap: 8px;
        align-items: center;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.15);
        font-weight: 1000;
        font-size: 12px;
      }

      .balances {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 3px;
      }

      .balCard {
        border-radius: 4px;
        padding: 3px;
        border: 1px solid var(--line);
        font-weight: 1100;
      }
      .balCard .t {
        font-size: 5px;
        font-weight: 1000;
        color: var(--muted);
      }
      .balCard .v {
        font-size: 8px;
        font-weight: 1200;
        margin-top: 1px;
      }
      .balOld {
        background: var(--soft-pink);
        color: #991b1b;
      }
      .balNew {
        background: var(--soft-green);
        color: #166534;
      }

      .recent {
        border: 1px solid var(--line);
        border-radius: 18px;
        background: #fff;
        overflow: hidden;
        min-height: 0;
        display: flex;
        flex-direction: column;
        flex: 1;
      }
      .recentHead {
        padding: 10px 14px;
        border-bottom: 1px solid var(--line);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 1100;
      }
      .recentHead .muted {
        color: var(--muted);
        font-weight: 1000;
        font-size: 12px;
      }
      .tableWrap {
        padding: 6px 8px 8px;
        min-height: 0;
        overflow: auto;
        flex: 1;
        max-height: none;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }
      th,
      td {
        border-bottom: 1px solid var(--line);
        padding: 6px 4px;
        text-align: left;
        vertical-align: middle;
        white-space: nowrap;
      }
      th {
        color: var(--muted);
        font-weight: 1100;
        font-size: 10px;
        position: sticky;
        top: 0;
        background: #f8fafc;
        z-index: 10;
      }
      tr:last-child td {
        border-bottom: none;
      }
      .tag {
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 1000;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .tag.cow {
        background: #dbeafe;
        color: #1d4ed8;
      }
      .tag.buff {
        background: #ede9fe;
        color: #6d28d9;
      }
      .rtag {
        padding: 5px 8px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #f8fafc;
        font-weight: 1100;
        font-size: 12px;
        color: var(--muted);
      }

      /* FOOTER BUTTONS */
      .bottom {
        display: grid;
        grid-template-columns: 1fr 1.4fr 1fr;
        gap: 12px;
        height: 96px;
      }
      .panicBtn {
        border: none;
        border-radius: 22px;
        font-size: 22px;
        font-weight: 1200;
        cursor: pointer;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        letter-spacing: 0.3px;
      }
      .panicBtn:active {
        transform: translateY(1px);
      }
      .hold {
        background: #fde68a;
        color: #78350f;
      }
      .save {
        background: #22c55e;
        color: #064e3b;
        font-size: 30px;
      }
      .undo {
        background: #fecaca;
        color: #7f1d1d;
      }
      .subnote {
        font-size: 12px;
        font-weight: 1100;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.06);
      }

      /* TOAST */
      .toast {
        position: fixed;
        left: 50%;
        bottom: 116px;
        transform: translateX(-50%);
        background: rgba(15, 23, 42, 0.92);
        color: #fff;
        padding: 12px 14px;
        border-radius: 16px;
        font-weight: 1100;
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.22);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.18s ease;
        max-width: 92vw;
        text-align: center;
        z-index: 70;
      }
      .toast.show {
        opacity: 1;
      }

      /* MODALS */
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 14px;
        z-index: 60;
      }
      .modal {
        width: min(1100px, 96vw);
        height: min(750px, 94vh);
        border-radius: 22px;
        border: 1px solid var(--line);
        background: #fff;
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
        overflow: hidden;
        display: grid;
        grid-template-rows: 70px 1fr 80px;
        min-height: 0;
      }
      .modalHead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-bottom: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
      }
      .modalHead .left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .closeBtn {
        width: 52px;
        height: 52px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        cursor: pointer;
        font-size: 18px;
        font-weight: 1100;
      }
      .modalBody {
        padding: 12px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        min-height: 0;
        overflow-y: auto;
        overflow-x: hidden;
        scrollbar-width: thin;
        scrollbar-color: var(--blue) #f1f5f9;
        -webkit-overflow-scrolling: touch;
      }
      .modalBody.onecol {
        grid-template-columns: 1fr;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        scrollbar-width: thin !important;
        scrollbar-color: var(--blue) #f1f5f9 !important;
        -webkit-overflow-scrolling: touch !important;
        max-height: calc(94vh - 150px) !important;
        padding: 12px !important;
      }
      /* Webkit scrollbar styling */
      .modalBody::-webkit-scrollbar {
        width: 8px;
      }
      .modalBody::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }
      .modalBody::-webkit-scrollbar-thumb {
        background: var(--blue);
        border-radius: 4px;
      }
      .modalBody::-webkit-scrollbar-thumb:hover {
        background: var(--blue2);
      }
      /* Mobile optimization */
      @media (max-width: 768px) {
        .modalBody {
          padding: 8px;
        }
        .modalBody .formGrid {
          grid-template-columns: 1fr !important;
          gap: 12px !important;
        }
        .modal {
          width: min(100vw, 98vw) !important;
          height: min(100vh, 95vh) !important;
          grid-template-rows: 60px 1fr 70px !important;
          border-radius: 16px;
        }
        .modalHead {
          padding: 8px 10px !important;
        }
        .modalFoot {
          padding: 10px !important;
        }
      }
      .modalCol {
        border: 1px solid var(--line);
        border-radius: 18px;
        background: #f8fafc;
        padding: 12px;
        display: block;
      }
      .modalCol h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        font-weight: 1200;
        color: #0f172a;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .listArea {
        flex: 1;
        min-height: 0;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 10px;
      }
      .pageInfo {
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: var(--muted);
        font-weight: 1000;
        font-size: 12px;
      }
      .pageBtns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .pageBtns button {
        height: 50px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
        cursor: pointer;
      }
      .pageBtns button[disabled] {
        opacity: 0.45;
        cursor: not-allowed;
      }
      .cardRow {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 16px;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        min-height: 64px;
      }
      .cardRow .title {
        font-weight: 1200;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 70%;
      }
      .cardRow .meta {
        color: var(--muted);
        font-weight: 1000;
        font-size: 12px;
        margin-top: 4px;
      }
      .cardRow .val {
        font-weight: 1200;
        font-size: 14px;
        white-space: nowrap;
        color: #0f172a;
      }

      .modalFoot {
        padding: 10px 12px;
        border-top: 1px solid var(--line);
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        background: #fff;
      }
      .footBtn {
        height: 50px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 1100;
        cursor: pointer;
        padding: 0 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .footBtn.good {
        background: #dcfce7;
        border-color: #bbf7d0;
        color: #14532d;
      }
      .footBtn.warn {
        background: #fef3c7;
        border-color: #fde68a;
        color: #78350f;
      }
      .footBtn.bad {
        background: #fee2e2;
        border-color: #fecaca;
        color: #7f1d1d;
      }

      /* Center Summary Cards */
      .center-summary-card {
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 18px;
        padding: 20px;
      }
      .center-summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--line);
      }
      .center-summary-title {
        font-size: 18px;
        font-weight: 1100;
        color: #0f172a;
      }
      .center-summary-date {
        font-size: 13px;
        color: var(--muted);
        font-weight: 700;
      }
      .center-summary-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }
      .center-summary-stat {
        background: #f8fafc;
        border-radius: 12px;
        padding: 15px;
        text-align: center;
      }
      .center-summary-stat-label {
        font-size: 11px;
        color: var(--muted);
        font-weight: 700;
        margin-bottom: 8px;
      }
      .center-summary-stat-value {
        font-size: 24px;
        font-weight: 1200;
        color: #0f172a;
      }
      .dispatch-action {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .dispatch-action-btn {
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 12px;
        padding: 14px;
        font-weight: 700;
        cursor: pointer;
      }
      .whatsapp-share-btn {
        background: #25D366;
        color: white;
        border: none;
        border-radius: 12px;
        padding: 14px;
        font-weight: 700;
        cursor: pointer;
      }

      /* FORMS */
      .formGrid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .field {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 12px;
        padding: 6px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .field label {
        color: var(--muted);
        font-weight: 1100;
        font-size: 11px;
        letter-spacing: 0.3px;
      }
      .field input,
      .field textarea,
      .field select {
        border: none;
        outline: none;
        background: transparent;
        color: var(--text);
        font-size: 14px;
        font-weight: 1100;
        resize: none;
        padding: 8px;
      }
      .field textarea {
        min-height: 60px;
      }
      .field.full {
        grid-column: 1/-1;
      }

      .receiptBox {
        border: 2px dashed #cbd5e1;
        background: #fff;
        border-radius: 18px;
        padding: 12px;
        font-weight: 1100;
        line-height: 1.35;
        white-space: pre-wrap;
        min-height: 0;
        color: #0f172a;
      }

      /* Small screens */
      @media (max-width: 980px) {
        body {
          overflow: hidden;
        }
        .app {
          overflow: hidden;
          height: 100vh;
          height: 100%;
        }
        .core {
          grid-template-columns: 1fr;
          height: 100%;
          min-height: 0;
        }
        .bottom {
          grid-template-columns: 1fr 1fr 1fr;
        }
        .save {
          font-size: 22px;
        }
        .modalBody {
          grid-template-columns: 1fr;
        }
        .amountBox .amt {
          font-size: 54px;
        }
        .manualRateRow input {
          width: 100%;
        }
      }
      /* 1. Main Screen aur Form ke sabhi bade dabbe (Boxes) */
.field:focus-within, .fcard:focus {
    outline: none !important;
    /* background-color: #fff9c4 !important; Mast Peela Background */
    border: 3px solid #000000 !important; /* Moti Kaali Border */
    box-shadow: 0 6px 15px rgba(0,0,0,0.2) !important; /* Halka shadow taaki box utha hua dikhe */
    transition: all 0.15s ease-in-out;
    transform: translateY(-2px); /* Box thoda upar uthega focus hone par */
}

/* 2. Farmer Card (Kisan ka dabba) jab keyboard se select ho */
.fcard:focus {
    /* background-color: #fff9c4 !important; */
    border: 3px solid #000000 !important;
}

/* 3. Andar ke input boxes ko clean rakhein taaki background poora dikhe */
.field:focus-within input, 
.field:focus-within textarea, 
.field:focus-within select {
    background: transparent !important;
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
}
/* Entry Save hone par Green Flash effect */
.flash-success {
    animation: flashGreen 0.6s ease-out;
}

@keyframes flashGreen {
    0% { background-color: transparent; }
    30% { background-color: rgba(37, 211, 102, 0.4); } /* WhatsApp Green color */
    100% { background-color: transparent; }
}
/* Edit Button Style in Table */
.edit-btn {
    padding: 4px 8px;
    background: #f1f5f9;
    border: 1px solid var(--line);
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    margin-left: 8px;
    transition: all 0.2s;
}
.edit-btn:hover { background: #e2e8f0; }

/* Edit Note Style */
.edit-note {
    font-size: 10px;
    color: var(--muted);
    font-style: italic;
    display: block;
    margin-top: 2px;
}
.hdr-actions { display: flex; align-items: center; gap: 10px; }
/* Right Panel ko scrollable banane ke liye */
.panel:has(.trustBody) {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.trustBody {
    flex: 1;
    overflow-y: auto; /* üëà Right panel mein scroll add ho jayega */
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* Har section ka size fix rahega */
.amountBox, .balances, #dailySummaryWrapper, .recent, #eodSnapshot, .pay-mode-container {
    flex-shrink: 0; 
}

/* Table area thoda chota rakhenge taaki baki cheezein dikhein */
.tableWrap {
    max-height: 200px;
    overflow-y: auto;
}
.orange-dot {
    height: 8px; width: 8px; background-color: #f97316;
    border-radius: 50%; display: inline-block; margin-left: 5px;
    box-shadow: 0 0 5px #f97316;
}
    </style>
  </head>
  <div class="overlay" id="overlayFarmerDetail">
  <div class="modal" style="width: min(900px, 95vw); height: min(85vh, 90vh); display: flex; flex-direction: column;">
    <div class="modalHead" style="flex-shrink: 0;">
      <div class="left">
        <button class="closeBtn" data-close="overlayFarmerDetail">‚úñ</button>
        <div id="detailFarmerName" style="font-weight: 1200; font-size: 16px;">Farmer Name</div>
      </div>
      <div class="muted">üìä Complete Farmer Profile</div>
    </div>

    <!-- Farmer Info Cards - Scrollable -->
    <div style="padding: 16px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; flex-shrink: 0; overflow-y: auto; max-height: 200px;">
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 12px;">
        <div style="background: white; padding: 12px; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s;" onclick="showDetailTab('edit')" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='white'">
          <div style="font-size: 11px; color: #64748b; font-weight: 700; margin-bottom: 4px;">üì± PHONE <span style="font-size: 9px;">(Click to edit)</span></div>
          <div style="font-size: 16px; font-weight: 900; color: #1e293b;" id="detailPhone">‚Äî</div>
        </div>
        <div style="background: white; padding: 12px; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s;" onclick="showDetailTab('edit')" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='white'">
          <div style="font-size: 11px; color: #64748b; font-weight: 700; margin-bottom: 4px;">üè∑Ô∏è SERIAL <span style="font-size: 9px;">(Click to edit)</span></div>
          <div style="font-size: 16px; font-weight: 900; color: #1e293b;" id="detailSerial">‚Äî</div>
        </div>
        <div style="background: white; padding: 12px; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s;" onclick="showDetailTab('edit')" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='white'">
          <div style="font-size: 11px; color: #64748b; font-weight: 700; margin-bottom: 4px;">ü•õ ANIMAL <span style="font-size: 9px;">(Click to edit)</span></div>
          <div style="font-size: 16px; font-weight: 900; color: #1e293b;" id="detailAnimal">‚Äî</div>
        </div>
        <div style="background: white; padding: 12px; border-radius: 8px; border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s;" onclick="showDetailTab('edit')" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='white'">
          <div style="font-size: 11px; color: #64748b; font-weight: 700; margin-bottom: 4px;">üìç ADDRESS <span style="font-size: 9px;">(Click to edit)</span></div>
          <div style="font-size: 14px; font-weight: 700; color: #1e293b;" id="detailAddress">‚Äî</div>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
        <div class="balCard balNew" style="background:#eff6ff; color:#1e40af; padding: 12px;">
          <div style="font-size:11px; font-weight: 700;">üìä TOTAL MILK (MONTH)</div>
          <div style="font-size: 24px; font-weight: 900;" id="detailMonthlyMilk">0.0 L</div>
        </div>
        <div class="balCard" style="background:#fef3c7; color:#92400e; padding: 12px;">
          <div style="font-size:11px; font-weight: 700;">üí∞ CURRENT BALANCE</div>
          <div style="font-size: 24px; font-weight: 900;" id="detailBalance">‚Çπ0.00</div>
          <div style="font-size: 9px; font-weight: 700; margin-top: 4px; color: #64748b;" id="detailBalanceLabel">‚Äî</div>
        </div>
        <div class="balCard balOld" style="background:#fff7ed; color:#9a3412; padding: 12px;">
          <div style="font-size:11px; font-weight: 700;">üìí ADVANCE</div>
          <div style="font-size: 24px; font-weight: 900;" id="detailAdvance">‚Çπ0.00</div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div style="display: flex; border-bottom: 2px solid #e2e8f0; flex-shrink: 0;">
      <button onclick="showDetailTab('transactions')" id="tabTransactions" style="flex: 1; padding: 12px; background: #f1f5f9; border: none; border-bottom: 3px solid #3b82f6; font-weight: 700; font-size: 13px; cursor: pointer; color: #1e293b;">üìã Transactions</button>
      <button onclick="showDetailTab('edit')" id="tabEdit" style="flex: 1; padding: 12px; background: white; border: none; border-bottom: 3px solid transparent; font-weight: 600; font-size: 13px; cursor: pointer; color: #64748b;">‚úèÔ∏è Edit Details</button>
      <button onclick="showDetailTab('advance')" id="tabAdvance" style="flex: 1; padding: 12px; background: white; border: none; border-bottom: 3px solid transparent; font-weight: 600; font-size: 13px; cursor: pointer; color: #64748b;">üí∞ Advance Mgmt</button>
      <button onclick="showDetailTab('relations')" id="tabRelations" style="flex: 1; padding: 12px; background: white; border: none; border-bottom: 3px solid transparent; font-weight: 600; font-size: 13px; cursor: pointer; color: #64748b;">üíù Relations</button>
    </div>
    
    <!-- Tab Content -->
    <div class="modalBody onecol" style="flex: 1; overflow-y: auto; padding: 0;">
      <!-- Transactions Tab -->
      <div id="detailTransactions" style="padding: 16px;">
        <div style="background: #f0f9ff; padding: 12px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #0284c7;">
          <div style="display: flex; justify-content: space-between; font-size: 13px;">
            <span style="font-weight: 700; color: #0369a1;">üìä Summary:</span>
            <span style="color: #0369a1;" id="detailTransactionSummary">0 entries | Total: ‚Çπ0.00</span>
          </div>
        </div>
        <div id="detailTransactionList"></div>
      </div>
      
      <!-- Edit Tab -->
      <div id="detailEdit" style="padding: 16px; display: none;">
        <div class="formGrid" style="grid-template-columns: repeat(2, 1fr); gap: 16px;">
          <div class="field">
            <label style="font-size: 12px; font-weight: 700;">üë§ Name</label>
            <input id="editName" type="text" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;" />
          </div>
          <div class="field">
            <label style="font-size: 12px; font-weight: 700;">üì± Phone</label>
            <input id="editPhone" type="tel" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;" />
          </div>
          <div class="field">
            <label style="font-size: 12px; font-weight: 700;">üè∑Ô∏è Serial No.</label>
            <input id="editSerial" type="text" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;" />
          </div>
          <div class="field">
            <label style="font-size: 12px; font-weight: 700;">ü•õ Animal Type</label>
            <select id="editAnimal" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
              <option value="cow">üêÑ Cow</option>
              <option value="buffalo">üêÉ Buffalo</option>
              <option value="both">üîÑ Both</option>
            </select>
          </div>
          <div class="field" style="grid-column: 1 / -1;">
            <label style="font-size: 12px; font-weight: 700;">üìç Address</label>
            <input id="editAddress" type="text" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;" />
          </div>
          <div class="field">
            <label style="font-size: 12px; font-weight: 700;">üèôÔ∏è City</label>
            <input id="editCity" type="text" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;" />
          </div>
          <div class="field">
            <label style="font-size: 12px; font-weight: 700;">üìÆ Pincode</label>
            <input id="editPincode" type="text" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;" />
          </div>
          
          <!-- Payment Details Section -->
          <div style="grid-column: 1 / -1; margin-top: 16px; padding: 12px; background: #eff6ff; border: 2px solid #3b82f6; border-radius: 8px;">
            <label style="font-size: 12px; font-weight: 800; color: #1e40af; display: block; margin-bottom: 12px;">üí≥ Payment Details (For UPI/Account Payments)</label>
            <div class="formGrid" style="grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <div class="field">
                <label style="font-size: 11px; font-weight: 700;">üì± UPI ID / VPA</label>
                <input id="editUPI" type="text" placeholder="e.g., 9876543210@paytm" style="width: 100%; padding: 8px; border: 2px solid #3b82f6; border-radius: 6px; font-size: 13px;" />
              </div>
              <div class="field">
                <label style="font-size: 11px; font-weight: 700;">üè¶ Bank Name</label>
                <input id="editBankName" type="text" placeholder="e.g., State Bank" style="width: 100%; padding: 8px; border: 2px solid #3b82f6; border-radius: 6px; font-size: 13px;" />
              </div>
              <div class="field">
                <label style="font-size: 11px; font-weight: 700;">üî¢ Account Number</label>
                <input id="editAccountNo" type="text" placeholder="Account number" style="width: 100%; padding: 8px; border: 2px solid #3b82f6; border-radius: 6px; font-size: 13px;" />
              </div>
              <div class="field">
                <label style="font-size: 11px; font-weight: 700;">üîë IFSC Code</label>
                <input id="editIFSC" type="text" placeholder="e.g., SBIN0001234" style="width: 100%; padding: 8px; border: 2px solid #3b82f6; border-radius: 6px; font-size: 13px; text-transform: uppercase;" />
              </div>
              <div class="field" style="grid-column: 1 / -1;">
                <label style="font-size: 11px; font-weight: 700;">üë§ Account Holder Name</label>
                <input id="editAccountName" type="text" placeholder="Name as per bank" style="width: 100%; padding: 8px; border: 2px solid #3b82f6; border-radius: 6px; font-size: 13px;" />
              </div>
            </div>
          </div>
        </div>
        <button onclick="saveFarmerDetails()" style="width: 100%; margin-top: 16px; padding: 12px; background: #22c55e; color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer;">‚úÖ Save Changes</button>
      </div>
      
      <!-- Advance Management Tab -->
      <div id="detailAdvanceTab" style="padding: 16px; display: none;">
        <div class="formGrid">
          <div class="field">
            <label style="font-size: 12px; font-weight: 700;">Amount (‚Çπ)</label>
            <input id="advAmount" type="number" placeholder="Enter Amount" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 16px; font-weight: 700;" />
          </div>
          <div class="field">
            <label style="font-size: 12px; font-weight: 700;">Action</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <button onclick="updateFarmerAdvance('give')" style="padding: 12px; background: #22c55e; color: white; border: none; border-radius: 6px; font-weight: 700; font-size: 14px; cursor: pointer;">‚ûï Give Advance</button>
              <button onclick="updateFarmerAdvance('cut')" style="padding: 12px; background: #dc2626; color: white; border: none; border-radius: 6px; font-weight: 700; font-size: 14px; cursor: pointer;">‚ûñ Cut Advance</button>
            </div>
          </div>
        </div>
        <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
          <div style="font-size: 13px; font-weight: 700; color: #92400e;">üí° Tip:</div>
          <div style="font-size: 12px; color: #78350f; margin-top: 4px;">Give advance when farmer needs money. Cut advance when farmer pays in cash.</div>
        </div>
        
        <!-- Advance History Ledger -->
        <div style="margin-top: 24px;">
          <h3 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            üìí Advance Ledger (‡§ï‡§ø‡§∏‡§æ‡§® ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§≤‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ advance ‡§î‡§∞ ‡§ï‡§ü‡•å‡§§‡•Ä)
          </h3>
          <div id="advanceHistoryList"></div>
        </div>
      </div>

      <!-- Customer Relations Tab -->
      <div id="detailRelations" style="padding: 16px; display: none;">
        <!-- Purchase Streak -->
        <div style="margin-bottom: 20px;">
          <h3 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">üî• Purchase Streak</h3>
          <div id="purchaseStreak" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 16px; text-align: center;"></div>
        </div>

        <!-- Give Advance -->
        <div style="margin-bottom: 20px;">
          <h3 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">üí∞ Give Advance</h3>
          <div style="display: flex; gap: 8px; align-items: flex-end;">
            <div style="flex: 1;">
              <label style="font-size: 11px; font-weight: 700; color: #64748b; display: block; margin-bottom: 4px;">Amount (‚Çπ)</label>
              <input type="number" id="relationsAdvanceAmount" placeholder="Enter amount" style="width: 100%; padding: 10px; border: 2px solid #f59e0b; border-radius: 8px; font-weight: 700; font-size: 14px;" />
            </div>
            <button onclick="giveAdvanceFromRelations()" style="padding: 10px 20px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 13px; white-space: nowrap;">‚ûï Give Advance</button>
          </div>
          <div style="font-size: 10px; color: #64748b; margin-top: 6px;">üí° Advance will be added to farmer's balance</div>
        </div>

        <!-- Purchase History -->
        <div style="margin-bottom: 20px;">
          <h3 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">üìä Last 5 Purchases</h3>
          <div id="last5Purchases" style="background: #f8fafc; border-radius: 8px; padding: 12px;"></div>
        </div>

        <!-- Frequent Purchase Pattern -->
        <div>
          <h3 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">üìà Purchase Pattern</h3>
          <div id="purchasePattern" style="background: #f0f9ff; border-radius: 8px; padding: 12px; font-size: 13px;"></div>
        </div>
      </div>
    </div>
    
    <div class="modalFoot" style="flex-shrink: 0; display: flex; gap: 8px;">
      <button onclick="sendFarmerWhatsAppSummary()" style="flex: 1; padding: 12px; background: #25d366; color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer;">üí¨ WhatsApp Summary</button>
      <button onclick="printFarmerStatement()" style="flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer;">üñ®Ô∏è Print Statement</button>
    </div>
  </div>
</div>

<!-- COMPREHENSIVE LEDGER MANAGEMENT MODAL -->
<div class="overlay" id="overlayLedgerManagement">
  <div class="modal" style="width: min(1200px, 98vw); height: min(90vh, 95vh);">
    <div class="modalHead">
      <div class="left">
        <button class="closeBtn" data-close="overlayLedgerManagement">‚úñ</button>
        <div>üìí Complete Ledger Management</div>
      </div>
      <div class="muted">All Farmers ‚Ä¢ Advances ‚Ä¢ Credits ‚Ä¢ Receipts</div>
    </div>

    <!-- Main Content Area -->
    <div class="modalBody onecol" style="padding: 0; overflow-y: auto;">
      <!-- Filters & Summary -->
      <div style="padding: 16px; background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 12px;">
          <div>
            <label style="font-size: 11px; font-weight: 700; color: #64748b; display: block; margin-bottom: 4px;">üîç Search Farmer</label>
            <input id="ledgerSearch" type="text" placeholder="Name, Phone, Serial..." style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px;" oninput="filterLedger()" />
          </div>
          <div>
            <label style="font-size: 11px; font-weight: 700; color: #64748b; display: block; margin-bottom: 4px;">üìä View Type</label>
            <select id="ledgerView" onchange="switchLedgerView()" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px; font-weight: 700;">
              <option value="all">üìã All Farmers</option>
              <option value="advances">üí∞ Advances Given</option>
              <option value="credits">üìí Credit (Udhari)</option>
              <option value="today">üìÖ Today's Collection</option>
            </select>
          </div>
          <div>
            <label style="font-size: 11px; font-weight: 700; color: #64748b; display: block; margin-bottom: 4px;">üìÖ From Date</label>
            <input id="ledgerFromDate" type="date" onchange="filterLedger()" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px;" />
          </div>
          <div>
            <label style="font-size: 11px; font-weight: 700; color: #64748b; display: block; margin-bottom: 4px;">üìÖ To Date</label>
            <input id="ledgerToDate" type="date" onchange="filterLedger()" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px;" />
          </div>
        </div>

        <!-- Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
          <div style="background: white; padding: 12px; border-radius: 8px; border: 2px solid #e2e8f0;">
            <div style="font-size: 11px; color: #64748b; font-weight: 700;">ü§ù TOTAL FARMERS</div>
            <div style="font-size: 20px; font-weight: 900; color: #1e293b;" id="sumTotalFarmers">0</div>
          </div>
          <div style="background: #eff6ff; padding: 12px; border-radius: 8px; border: 2px solid #3b82f6;">
            <div style="font-size: 11px; color: #1e40af; font-weight: 700;">üí∞ TOTAL ADVANCE</div>
            <div style="font-size: 20px; font-weight: 900; color: #1e40af;" id="sumTotalAdvance">‚Çπ0</div>
          </div>
          <div style="background: #fef3c7; padding: 12px; border-radius: 8px; border: 2px solid #f59e0b;">
            <div style="font-size: 11px; color: #92400e; font-weight: 700;">üìí TOTAL CREDIT</div>
            <div style="font-size: 20px; font-weight: 900; color: #92400e;" id="sumTotalCredit">‚Çπ0</div>
          </div>
          <div style="background: #dcfce7; padding: 12px; border-radius: 8px; border: 2px solid #16a34a;">
            <div style="font-size: 11px; color: #166534; font-weight: 700;">üíµ CASH COLLECTED</div>
            <div style="font-size: 20px; font-weight: 900; color: #166534;" id="sumCashCollected">‚Çπ0</div>
          </div>
          <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; border: 2px solid #0284c7;">
            <div style="font-size: 11px; color: #0369a1; font-weight: 700;">üìä TODAY'S MILK</div>
            <div style="font-size: 20px; font-weight: 900; color: #0369a1;" id="sumTodayMilk">0 L</div>
          </div>
        </div>
      </div>

      <!-- Advances List -->
      <div id="advancesList" style="display: none; padding: 16px;">
        <h3 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
          üí∞ Advance Deposits (‡§ï‡§ø‡§∏‡§æ‡§® ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§≤‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ advance)
        </h3>
        <div id="advancesTable"></div>
      </div>

      <!-- Credits List -->
      <div id="creditsList" style="display: none; padding: 16px;">
        <h3 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
          üìí Credit/Udhari (‡§â‡§ß‡§æ‡§∞‡•Ä - date-wise)
        </h3>
        <div id="creditsTable"></div>
      </div>

      <!-- All Farmers List -->
      <div id="allFarmersList" style="display: block; padding: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="font-size: 14px; font-weight: 700; color: #1e293b;">üìã All Farmers Master List</h3>
          <div style="display: flex; gap: 8px;">
            <button onclick="exportLedgerExcel()" style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 6px; font-weight: 700; font-size: 12px; cursor: pointer;">üìä Export Excel</button>
            <button onclick="printLedgerReport()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 700; font-size: 12px; cursor: pointer;">üñ®Ô∏è Print Report</button>
          </div>
        </div>
        <div id="farmersTable"></div>
      </div>

      <!-- Today's Collection -->
      <div id="todayList" style="display: none; padding: 16px;">
        <h3 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">üìÖ Today's Collection</h3>
        <div id="todayTable"></div>
      </div>
    </div>

    <div class="modalFoot" style="display: flex; gap: 8px;">
      <button onclick="sendBulkWhatsApp()" style="flex: 1; padding: 12px; background: #25d366; color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer;">üí¨ Bulk WhatsApp</button>
      <button onclick="closeOverlay('overlayLedgerManagement')" style="padding: 12px 24px; background: #f1f5f9; color: #64748b; border: none; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer;">Close</button>
    </div>
  </div>
</div>

  <body>
    <div class="app">
      <!-- HEADER -->
      <div class="topbar">
        <div class="brand">
          <div class="logo" style="background: linear-gradient(180deg, #2563eb, #1d4ed8); border-color: #1e40af;">
            <img src="logo.jpg" alt="M" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;" onerror="this.style.display='none'; this.parentElement.innerHTML='M'">
          </div>
          <div>
            <div class="title" style="font-size: 14px;">MilkRecord</div>
            <div class="sub" id="todayLabel">‚Äî</div>
          </div>
        </div>
        <div class="hdr-actions" style="flex: 1; justify-content: flex-end; display: flex; align-items: center; gap: 8px;">
          <!-- Rate Pill -->
          <div id="ratePill" onclick="openRateTable()" style="background: #e3f2fd; color: #1565c0; padding: 8px 12px; border-radius: 999px; font-weight: 700; cursor: pointer; border: 2px solid #bbdefb; font-size: 12px; display: flex; align-items: center; gap: 6px; margin-right: 3px;">
            <span id="rateDisplay">Rate: ‚Çπ64.00</span>
            <span style="font-size: 14px; opacity: 0.6;">üìã</span>
          </div>
          <!-- Switch to POS -->
          <button class="pillbtn primary" onclick="location.href='pos-demo.html'" style="background:#2563eb; border-color:#2563eb; font-size:14px; padding:10px 16px; font-weight:700; cursor: pointer; border: 2px solid #1e40af;">
            üõí POS
          </button>

          <!-- Ledger Management -->
          <button class="pillbtn" onclick="openLedgerManagement()" style="background:#fef3c7; border-color:#f59e0b; font-size:14px; padding:10px 16px; font-weight:700; cursor: pointer; border: 2px solid #f59e0b; color: #92400e;">
            üìí Ledger
          </button>

          <!-- User Dropdown with Booth, Settings -->
          <div style="position: relative; display: inline-block; margin-left: 6px;">
            <button class="pillbtn" onclick="toggleHeaderDropdown()" style="background:#f8fafc; border-color:#e2e8f0; font-size:14px; padding:10px 14px; font-weight:700; cursor: pointer; border: 2px solid #cbd5e1; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">
              üè™ <span id="headerUserName">Default Booth</span> <span style="font-size:10px; margin-left:4px; opacity:0.6;">‚ñº</span>
            </button>
            <div id="headerDropdown" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 6px; background: white; border: 2px solid #e2e8f0; border-radius: 12px; box-shadow: 0 12px 40px rgba(0,0,0,0.15); min-width: 260px; z-index: 1001; overflow: hidden;">
              <!-- User Info Section -->
              <div style="padding: 16px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-bottom: 2px solid #e2e8f0;">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
                  <div style="width:40px; height:40px; background:#3b82f6; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:20px; font-weight:900;">üë§</div>
                  <div>
                    <div style="font-weight: 700; font-size: 15px; color:#1e293b;" id="headerDropdownEmail">user@milkrecord.in</div>
                    <div style="font-size: 11px; color: #64748b;" id="headerDropdownShop">milkrecord.in</div>
                  </div>
                </div>
              </div>
              
              <!-- Booth Selector -->
              <div style="padding: 14px 16px; border-bottom: 1px solid #f1f5f9;">
                <label style="font-size: 11px; font-weight: 700; color: #64748b; display: block; margin-bottom: 6px; text-transform:uppercase; letter-spacing:0.5px;">üè™ Collection Booth</label>
                <select id="collectionPointSelect" onchange="updateCollectionPoint(); toggleHeaderDropdown()" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-weight: 700; font-size: 13px; background: white; cursor: pointer; transition: border-color 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                  <option value="DEFAULT">üìç Default Booth</option>
                  <option value="VILLAGE_A">üèòÔ∏è Village A</option>
                  <option value="VILLAGE_B">üèòÔ∏è Village B</option>
                  <option value="MAIN_MARKET">üè™ Main Market</option>
                </select>
              </div>
              
              <!-- Reading Mode -->
              <div style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9; background:#f8fafc;">
                <div style="font-size: 11px; font-weight: 700; color: #64748b; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px;">üìä Reading Mode</div>
                <div style="display:flex; align-items:center; gap:8px; font-size:13px; color:#475569; font-weight:700;">
                  <span style="width:8px; height:8px; background:#22c55e; border-radius:50%; display:inline-block;"></span>
                  Manual Entry
                </div>
              </div>
              
              <!-- Quick Actions -->
              <div style="padding: 8px 16px; border-bottom: 1px solid #f1f5f9;">
                <div style="font-size: 11px; font-weight: 700; color: #64748b; margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px;">‚ö° Quick Actions</div>
                <button onclick="openOverlay('overlayHistory'); toggleHeaderDropdown()" style="width: 100%; padding: 10px 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: #475569; margin-bottom:6px; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'; this.style.borderColor='#cbd5e1'" onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">üßæ History</button>
                <button onclick="openOverlay('overlaySettings'); toggleHeaderDropdown()" style="width: 100%; padding: 10px 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: #475569; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'; this.style.borderColor='#cbd5e1'" onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">‚öôÔ∏è Settings</button>
              </div>
              
              <!-- Language Toggle -->
              <button onclick="toggleLanguage(); toggleHeaderDropdown()" style="width: 100%; padding: 12px 16px; background: none; border: none; border-bottom: 1px solid #f1f5f9; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: #475569; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">üåê Language: <span id="headerLangDisplay">English</span></button>
              
              <!-- Logout -->
              <button onclick="logout(); toggleHeaderDropdown()" style="width: 100%; padding: 12px 16px; background: #fef2f2; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 700; color: #dc2626; transition: background 0.2s;" onmouseover="this.style.background='#fee2e2'" onmouseout="this.style.background='#fef2f2'">üö™ Logout</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Initialize dropdown function immediately -->
      <script>
        // Define toggleHeaderDropdown immediately so it's available for onclick
        window.toggleHeaderDropdown = function() {
          const dropdown = document.getElementById('headerDropdown');
          console.log('üîµ toggleHeaderDropdown called, dropdown:', dropdown);
          if (dropdown) {
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';
            console.log('üîµ Header dropdown toggled:', isVisible ? 'closed' : 'opened');
          }
        }
      </script>

      <!-- CORE -->
      <div class="core">
        <!-- LEFT -->
        <div class="panel">
          <div class="panelHeader">
            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
              <div id="stationTitle">Milk Intake Station</div>
              <div class="searchBox" style="flex: 1; max-width: 300px;">
                üîé
                <input
                  id="searchInput"
                  inputmode="search"
                  autocomplete="off"
                  placeholder="Search name‚Ä¶"
                />
              </div>
              <button class="addNewBtn" id="btnAddFarmerMain" style="padding: 8px 16px; font-size: 13px;" onclick="openOverlay('overlayFarmer'); return false;">
                Ôºã Farmer
              </button>
            </div>
            <small id="holdBadge"></small>
            <div class="miniTag" id="farmerCount" style="margin-left: 8px;">0 üë§</div>
            <!-- Kitna Collection - Today's Summary -->
            <div style="margin-left: 8px; background: #dcfce7; border: 2px solid #16a34a; border-radius: 6px; padding: 4px 8px; font-size: 10px; font-weight: 700; color: #166534; white-space: nowrap;">
              üìä Today: <span id="todayMilk">0</span>L | <span id="todayAmount">‚Çπ0</span> | <span id="todayEntries">0</span>
            </div>
          </div>

          <div class="actionBody">
            <!-- Farmer selection -->
            <div class="farmerPick">
              <div class="farmerGrid" id="farmerGrid"></div>

              <div class="farmerNav">
                <button class="navBtn" id="prevFarmers">‚¨ÖÔ∏è</button>
                <button class="navBtn" id="nextFarmers">‚û°Ô∏è</button>
              </div>
            </div>

            <!-- Inputs -->
            <div class="inputs">
              <div class="control green">
                <div class="ctrlTop">
                  <div id="qtyLabel" style="font-weight: 900; font-size: 11px;">2. Quantity (Liters)</div>
                  <div class="muted" id="qtyStep">¬±0.5 L</div>
                </div>
                <div class="numBig">
                  <input
                    id="qtyInput"
                    class="numInput"
                    type="number"
                    step="0.1"
                    placeholder="0.0 L"
                  />
                </div>
              </div>

              <!-- Quantity Threshold Nudge -->
              <div id="qtyThresholdNudge" style="display: none; grid-column: 1/-1; background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 8px; font-size: 11px; color: #1e40af; font-weight: 700;">
                ‚ÑπÔ∏è Bulk collection detected<br>
                <span style="font-weight: 500; color: #64748b;">Institutional systems track source, quality & settlement for this volume.</span>
                <span style="color: #3b82f6; cursor: pointer; margin-left: 8px; text-decoration: underline;" onclick="showWhatMissing()">What's missing?</span>
              </div>

              <div class="control yellow">
                <div class="ctrlTop">
                  <div id="fatLabel" style="font-weight: 900; font-size: 11px;">3. Fat %</div>
                  <label for="fImageEntry" style="cursor:pointer; font-size: 14px; margin-left: auto;" title="Capture Proof">üì∑</label>
                  <input type="file" id="fImageEntry" accept="image/*" capture="camera" style="display:none;">
                  <div class="muted" id="fatStep">¬±0.1%</div>
                </div>
                <div class="numBig">
                  <input id="fatInput" class="numInput" type="number" step="0.1" placeholder="0.0" />
                </div>
              </div>

              <div class="control blue">
                <div class="ctrlTop">
                  <div id="densityLabel" style="font-weight: 900; font-size: 11px;">Density</div>
                  <div class="muted">Auto SNF</div>
                </div>
                <div class="numBig">
                  <input id="densityInput" class="numInput" type="number" step="any" placeholder="0" />
                </div>
              </div>

              <div class="control blue">
                <div class="ctrlTop">
                  <div id="snfLabel" style="font-weight: 900; font-size: 11px;">4. SNF %</div>
                  <div class="muted" id="snfStep">¬±0.1%</div>
                </div>
                <div class="numBig">
                  <input id="snfInput" class="numInput" type="number" step="0.1" placeholder="0.0" />
                </div>
              </div>

              <div class="row3" style="grid-column: 1/-1">
                <div class="animalCard" style="display: flex; flex-direction: column; gap: 4px;">
                  <label style="font-weight: 900; font-size: 14px;">5. Animal Type <span style="font-size: 10px; color: var(--muted);">(Click or Tab+Enter)</span></label>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                    <button type="button" id="animalCow" onclick="selectAnimal('cow'); setTimeout(() => { const likhloBtn = document.getElementById('btnLikhlo'); if(likhloBtn) { likhloBtn.focus(); } }, 100);" onkeydown="if(event.key==='Enter' || event.key===' '){event.preventDefault(); this.click();}" style="padding: 10px; border: 2px solid var(--line); border-radius: 8px; background: white; cursor: pointer; font-weight: 900; font-size: 13px; transition: all 0.2s;" tabindex="0">üêÑ Cow</button>
                    <button type="button" id="animalBuffalo" onclick="selectAnimal('buffalo'); setTimeout(() => { const likhloBtn = document.getElementById('btnLikhlo'); if(likhloBtn) { likhloBtn.focus(); } }, 100);" onkeydown="if(event.key==='Enter' || event.key===' '){event.preventDefault(); this.click();}" style="padding: 10px; border: 2px solid var(--line); border-radius: 8px; background: white; cursor: pointer; font-weight: 900; font-size: 13px; transition: all 0.2s;" tabindex="0">üêÉ Buffalo</button>
                  </div>
                  <input type="hidden" id="animalSelect" value="cow" />
                </div>

                <!-- Manual Rate Override -->
                <div class="manualOverride">
                  <div class="left">üì∑ Manual Rate Override</div>
                  <div style="display: flex; align-items: center; gap: 12px">
                    <div class="rtag" id="rateTypeLabel">Rate: Auto</div>
                    <div class="manualRateRow" id="manualRateRow">
                      <input
                        id="manualRateInput"
                        inputmode="decimal"
                        placeholder="Auto: ‚Çπ64.00"
                        style="min-width: 80px;"
                      />
                      <button id="manualRateApply" title="Apply this rate">‚úîÔ∏è</button>
                    </div>
                  </div>
                </div>

                <div style="flex: 1"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="panel">
          <div class="panelHeader">
            <!-- Summary Info Row - ALL in ONE row: Calc | Cow/Buff | OLD | NEW -->
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px; font-size: 11px; background: #f8fafc; padding: 6px 8px; border-radius: 6px; white-space: nowrap;">
              <div id="summaryCalcText" style="color: #64748b; font-weight: 800; font-size: 12px;">0.0L√ó‚Çπ0.00/L(F:0.0%)</div>
              <div style="display: flex; gap: 6px; color: #64748b; font-weight: 800; font-size: 12px;">
                <span style="color: #16a34a;">üêÑ<span id="cowQtyInline">0.0</span></span>
                <span style="color: #dc2626;">üêÉ<span id="buffQtyInline">0.0</span></span>
              </div>
              <div style="display: flex; gap: 6px;">
                <span style="color: #64748b; font-weight: 800; font-size: 11px;">OLD:</span>
                <span id="balBefore" style="font-weight: 900; color: #0f172a; font-size: 12px;"></span>
                <span style="color: #64748b; font-weight: 800; font-size: 11px; margin-left: 6px;">NEW:</span>
                <span id="balAfter" style="font-weight: 900; color: #16a34a; font-size: 12px;"></span>
              </div>
            </div>
          </div>

          <div class="trustBody">
            <div class="amountBox">
              <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                <div style="flex: 1;">
                  <div class="label" id="amtLabel">TOTAL AMOUNT</div>
                  <div class="amt" id="amountView"></div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 4px;">
                  <!-- Round Input -->
                  <input type="number" id="farmerRoundupInput" placeholder="Round" step="10" style="width: 80px; padding: 6px; border: 2px dashed #3b82f6; border-radius: 4px; font-weight: 700; font-size: 10px; text-align: center; background: #eff6ff;" oninput="applyFarmerRoundup()" title="Round to 10, 50, 100" />
                  <!-- WhatsApp Summary Button -->
                  <button onclick="sendDailySummary()" style="padding: 6px 10px; background: #25d366; color: white; border: none; border-radius: 4px; font-weight: 700; font-size: 10px; cursor: pointer; white-space: nowrap;" title="Send today's summary via WhatsApp">üí¨ Summary</button>
                </div>
              </div>
              <!-- Round Label -->
              <div id="farmerRoundupLabel" style="display: none; font-size: 9px; color: #3b82f6; font-weight: 700; background: #dbeafe; padding: 4px 8px; border-radius: 4px; margin-top: 4px; text-align: center;">üîÑ <span id="farmerRoundupValue">0</span></div>
            </div>

            <div class="recent">
              <div class="recentHead">
                <div class="t">Today's Records</div>
                <div class="muted" id="recentMeta">0 records</div>
              </div>
              <div class="tableWrap">
                <table>
                  <thead>
                    <tr>
                      <th>DATE</th>
                      <th>FARMER</th>
                      <th>SESSION</th>
                      <th>TYPE</th>
                      <th>QTY</th>
                      <th>FAT</th>
                      <th>SNF</th>
                      <th>AMT</th>
                      <th style="font-size: 10px;">Verified</th>
                    </tr>
                  </thead>
                  <tbody id="recentTbody">
                    <tr>
                      <td
                        colspan="9"
                        style="color: var(--muted); font-weight: 1100"
                      >
                        No records recorded today
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="bottom">
        <!-- Advance Management Section (Collapsible) -->
        <div id="footerAdvanceSection" style="display: none; margin-bottom: 6px;">
          <div style="display: flex; gap: 6px;">
            <input type="number" id="footerAdvanceAmount" placeholder="Amount (‚Çπ)" style="flex: 1; padding: 8px; border: 2px solid #f59e0b; border-radius: 6px; font-weight: 700; font-size: 13px;" />
            <button onclick="updateFooterAdvance('give')" style="padding: 8px 12px; background: #22c55e; color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 11px; white-space: nowrap;">‚ûï Give</button>
            <button onclick="updateFooterAdvance('cut')" style="padding: 8px 12px; background: #dc2626; color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 11px; white-space: nowrap;">‚ûñ Cut</button>
          </div>
        </div>

        <!-- Payment Buttons: LIKH LO First, Then CASH, Then Relations -->
        <button class="panicBtn credit" id="btnLikhlo" style="background:#dc2626; color:#fff; flex: 1;">
          üìí LIKHLO <span class="subnote">udhar</span>
        </button>

        <button class="panicBtn save" id="btnSaveCash" style="background: linear-gradient(135deg, #16a34a, #059669); flex: 1;" onclick="saveWithPaymentMode('Cash')" onkeydown="if(event.key==='Enter'){event.preventDefault(); this.click();}">
          üíµ CASH
        </button>

        <button class="panicBtn" id="btnRelations" style="background: linear-gradient(135deg, #7c3aed, #6d28d9); color: #fff; flex: 1;" onclick="openFarmerRelations()">
          ü§ù Relations
        </button>
      </div>
    </div>


    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!-- Backend -->
    <script src="simple-backend.js"></script>
    <!-- Debug script COMMENTED OUT - was causing page load issues -->
    <!--
    <script>
      console.log('üöÄ Collection Page Loading...');

      // Debug: Check if backend loaded
      window.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ DOM Loaded');
        console.log('Backend available:', !!window.MilkRecordDB);

        // Test backend
        if (window.MilkRecordDB) {
          window.MilkRecordDB.farmers.getAll().then(result => {
            console.log('‚úÖ Backend working! Farmers:', result.farmers.length);
          }).catch(err => {
            console.error('‚ùå Backend error:', err);
          });
        }
      });
    </script>
    -->

    <!-- HISTORY MODAL -->
    <div class="overlay" id="overlayHistory">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayHistory">‚úñ</button>
            <div>üßæ History (Today + Weekly)</div>
          </div>
          <div class="muted" id="historyTitleRight">‚Äî</div>
        </div>

        <div class="modalBody">
          <div class="modalCol">
            <h3>üìÖ Today</h3>
            <div class="listArea">
              <div class="pageInfo">
                <span id="todayPageInfo">‚Äî</span>
                <span class="muted">No scroll ‚Ä¢ Pages</span>
              </div>
              <div
                id="todayList"
                style="display: grid; gap: 10px; align-content: start"
              ></div>
              <div class="pageBtns">
                <button id="todayPrev">‚¨ÖÔ∏è</button>
                <button id="todayNext">‚û°Ô∏è</button>
              </div>
            </div>
          </div>

          <div class="modalCol">
            <h3>üóìÔ∏è Weekly</h3>
            <div class="listArea">
              <div class="pageInfo">
                <span id="weekPageInfo">‚Äî</span>
                <span class="muted">Last 7 days</span>
              </div>
              <div
                id="weekList"
                style="display: grid; gap: 10px; align-content: start"
              ></div>
              <div class="pageBtns">
                <button id="weekPrev">‚¨ÖÔ∏è</button>
                <button id="weekNext">‚û°Ô∏è</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn warn" id="btnReceipt">üì© Receipt</button>
          <div style="display: flex; gap: 10px">
            <button class="footBtn" id="btnExport">‚¨áÔ∏è Export</button>
            <button class="footBtn bad" id="btnClearToday">
              üóëÔ∏è Clear Today
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- LEADER MODAL -->
    <div class="overlay" id="overlayLeader">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayLeader">‚úñ</button>
            <div>üèÜ Weekly Leader</div>
          </div>
          <div class="muted" id="leaderRight">‚Äî</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>Top Farmers (7 days)</h3>
            <div class="listArea">
              <div class="pageInfo">
                <span id="leaderPageInfo">‚Äî</span>
                <span class="muted">By Amount</span>
              </div>
              <div
                id="leaderList"
                style="display: grid; gap: 10px; align-content: start"
              ></div>
              <div class="pageBtns">
                <button id="leaderPrev">‚¨ÖÔ∏è</button>
                <button id="leaderNext">‚û°Ô∏è</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn" id="btnLeaderByAmt">üí∞ Amount</button>
          <button class="footBtn" id="btnLeaderByLit">ü•õ Liters</button>
          <button class="footBtn" id="btnLeaderByCount">üßæ Entries</button>
        </div>
      </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="overlay" id="overlaySettings">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlaySettings">‚úñ</button>
            <div>‚öôÔ∏è Settings</div>
          </div>
          <div class="muted">Offline ‚Ä¢ Saved</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>üí∞ Rate Formula Builder</h3>
            <p style="font-size: 12px; color: var(--muted); margin-bottom: 16px;">Select operators for each component to build your custom formula</p>

            <div class="formGrid">
              <!-- Cow Rate Formula -->
              <div class="field full" style="padding: 10px; background: #f0fdf4; border: 2px solid #16a34a; border-radius: 12px; margin-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <label style="font-size: 13px; font-weight: 800; color: #166534;">üêÑ COW RATE FORMULA</label>
                  <div id="cowRatePreview" style="font-size: 18px; font-weight: 900; color: #16a34a; background: white; padding: 6px 12px; border-radius: 8px; border: 2px solid #16a34a;">‚Çπ0.00/L</div>
                </div>
                <div style="font-size: 11px; color: #166534; background: #dcfce7; padding: 6px 8px; border-radius: 6px; margin-bottom: 8px;">
                  üìä Live Preview (Fat: <span id="cowFatDisplay">0</span>% | SNF: <span id="cowSnfDisplay">0</span>%)
                </div>
              </div>

              <div class="field">
                <label>üêÑ Cow Base Rate (‚Çπ)</label>
                <input id="setCowBase" inputmode="decimal" style="font-weight: 700;" oninput="updateLivePreview()" />
              </div>
              <div class="field">
                <label>Cow Base Operator</label>
                <select id="setCowBaseOp" style="font-weight: 600;" onchange="updateLivePreview()">
                  <option value="fixed">Fixed (No Operator)</option>
                  <option value="fat">Based on Fat</option>
                  <option value="snf">Based on SNF</option>
                  <option value="fat_snf">Based on Fat + SNF</option>
                </select>
              </div>

              <div class="field">
                <label>üêÑ Cow Fat Factor (‚Çπ/%Fat)</label>
                <input id="setCowFactor" inputmode="decimal" style="font-weight: 700;" oninput="updateLivePreview()" />
              </div>
              <div class="field">
                <label>Cow Fat Operator</label>
                <select id="setCowFatOp" style="font-weight: 600;" onchange="updateLivePreview()">
                  <option value="multiply">Multiply (Factor √ó Fat%)</option>
                  <option value="add">Add (Factor + Fat%)</option>
                  <option value="disabled">Disabled</option>
                </select>
              </div>

              <div class="field">
                <label>üêÑ Cow SNF Factor (‚Çπ/%SNF)</label>
                <input id="setCowSnfFactor" inputmode="decimal" style="font-weight: 700;" oninput="updateLivePreview()" />
              </div>
              <div class="field">
                <label>Cow SNF Operator</label>
                <select id="setCowSnfOp" style="font-weight: 600;" onchange="updateLivePreview()">
                  <option value="multiply">Multiply (Factor √ó SNF%)</option>
                  <option value="add">Add (Factor + SNF%)</option>
                  <option value="disabled">Disabled</option>
                </select>
              </div>
              
              <!-- Cow Formula Preview -->
              <div class="field full" style="padding: 10px; background: #f0fdf4; border: 2px solid #16a34a; border-radius: 8px; margin-top: 4px;">
                <label style="font-size: 11px; font-weight: 700; color: #166534; display: block; margin-bottom: 6px;">üìù Cow Formula (Updates Live):</label>
                <div id="cowFormulaPreview" style="font-size: 14px; font-weight: 800; color: #16a34a; background: white; padding: 8px; border-radius: 6px; border: 1px solid #16a34a; margin-bottom: 6px;">‚Çπ18 + (‚Çπ6 √ó Fat%) + (‚Çπ3 √ó SNF%)</div>
                <div id="cowCalcBreakdown" style="font-size: 12px; color: #166534; padding: 8px; background: #dcfce7; border-radius: 4px; font-weight: 600;">Example: ‚Çπ18 + (‚Çπ6 √ó 4.0%) + (‚Çπ3 √ó 8.5%) = ‚Çπ67.50/L</div>
              </div>

              <!-- Buffalo Rate Formula -->
              <div class="field full" style="padding: 10px; background: #fef3c7; border: 2px solid #d97706; border-radius: 12px; margin: 12px 0 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <label style="font-size: 13px; font-weight: 800; color: #92400e;">üêÉ BUFFALO RATE FORMULA</label>
                  <div id="buffRatePreview" style="font-size: 18px; font-weight: 900; color: #d97706; background: white; padding: 6px 12px; border-radius: 8px; border: 2px solid #d97706;">‚Çπ0.00/L</div>
                </div>
                <div style="font-size: 11px; color: #92400e; background: #fef3c7; padding: 6px 8px; border-radius: 6px; margin-bottom: 8px;">
                  üìä Live Preview (Fat: <span id="buffFatDisplay">0</span>% | SNF: <span id="buffSnfDisplay">0</span>%)
                </div>
              </div>

              <div class="field">
                <label>üêÉ Buffalo Base Rate (‚Çπ)</label>
                <input id="setBuffBase" inputmode="decimal" style="font-weight: 700;" oninput="updateLivePreview()" />
              </div>
              <div class="field">
                <label>Buffalo Base Operator</label>
                <select id="setBuffBaseOp" style="font-weight: 600;" onchange="updateLivePreview()">
                  <option value="fixed">Fixed (No Operator)</option>
                  <option value="fat">Based on Fat</option>
                  <option value="snf">Based on SNF</option>
                  <option value="fat_snf">Based on Fat + SNF</option>
                </select>
              </div>

              <div class="field">
                <label>üêÉ Buffalo Fat Factor (‚Çπ/%Fat)</label>
                <input id="setBuffFactor" inputmode="decimal" style="font-weight: 700;" oninput="updateLivePreview()" />
              </div>
              <div class="field">
                <label>Buffalo Fat Operator</label>
                <select id="setBuffFatOp" style="font-weight: 600;" onchange="updateLivePreview()">
                  <option value="multiply">Multiply (Factor √ó Fat%)</option>
                  <option value="add">Add (Factor + Fat%)</option>
                  <option value="disabled">Disabled</option>
                </select>
              </div>

              <div class="field">
                <label>üêÉ Buffalo SNF Factor (‚Çπ/%SNF)</label>
                <input id="setBuffSnfFactor" inputmode="decimal" style="font-weight: 700;" oninput="updateLivePreview()" />
              </div>
              <div class="field">
                <label>Buffalo SNF Operator</label>
                <select id="setBuffSnfOp" style="font-weight: 600;" onchange="updateLivePreview()">
                  <option value="multiply">Multiply (Factor √ó SNF%)</option>
                  <option value="add">Add (Factor + SNF%)</option>
                  <option value="disabled">Disabled</option>
                </select>
              </div>
              
              <!-- Buffalo Formula Preview -->
              <div class="field full" style="padding: 10px; background: #fef3c7; border: 2px solid #d97706; border-radius: 8px; margin-top: 4px;">
                <label style="font-size: 11px; font-weight: 700; color: #92400e; display: block; margin-bottom: 6px;">üìù Buffalo Formula (Updates Live):</label>
                <div id="buffFormulaPreview" style="font-size: 14px; font-weight: 800; color: #d97706; background: white; padding: 8px; border-radius: 6px; border: 1px solid #d97706; margin-bottom: 6px;">‚Çπ22 + (‚Çπ7 √ó Fat%) + (‚Çπ3.5 √ó SNF%)</div>
                <div id="buffCalcBreakdown" style="font-size: 12px; color: #92400e; padding: 8px; background: #fef3c7; border-radius: 4px; font-weight: 600;">Example: ‚Çπ22 + (‚Çπ7 √ó 4.0%) + (‚Çπ3.5 √ó 8.5%) = ‚Çπ79.75/L</div>
              </div>

              <!-- Other Settings -->
              <div class="field full" style="padding: 10px; background: #f3f4f6; border: 2px solid #6b7280; border-radius: 12px; margin: 12px 0 8px;">
                <label style="font-size: 13px; font-weight: 800; color: #374151; display: block; margin-bottom: 8px;">‚öôÔ∏è OTHER SETTINGS</label>
              </div>

              <div class="field">
                <label>Qty Step (L)</label>
                <input id="setQtyStep" inputmode="decimal" />
              </div>
              <div class="field">
                <label>Fat Step (%)</label>
                <input id="setFatStep" inputmode="decimal" />
              </div>

              <div class="field">
                <label>SNF Step</label>
                <input id="setSnfStep" inputmode="decimal" />
              </div>
              <div class="field">
                <label>Session Switch Hour</label>
                <input id="setSessionHour" inputmode="numeric" />
              </div>

              <div class="field full">
                <label>Formula Preview</label>
                <div style="font-weight: 700; font-size: 13px; padding: 10px; background: #fff; border: 2px solid #3b82f6; border-radius: 8px;" id="formulaPreview">
                  ‚Äî
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn good" id="btnSaveSettings">‚úÖ Save</button>
          <button class="footBtn warn" id="btnResetSettings">‚ôªÔ∏è Reset</button>
          <button class="footBtn bad" id="btnFactoryReset">
            üß® Factory Reset
          </button>
        </div>
      </div>
    </div>

    <!-- RATE EDITOR MODAL -->
    <div class="overlay" id="overlayRateEditor">
      <div class="modal" style="height: auto; max-height: 80vh; display: flex; flex-direction: column;">
        <div class="modalHead" style="flex-shrink: 0;">
          <div class="left">
            <button class="closeBtn" data-close="overlayRateEditor">‚úñ</button>
            <div>üìã Rate List (Chart)</div>
          </div>
          <div class="muted">Base: ‚Çπ<span id="chartBaseRate">0.00</span></div>
        </div>

        <div class="modalBody onecol" style="overflow-y: auto; flex: 1; min-height: 0;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead style="position: sticky; top: 0; background: #fff; z-index: 10;">
              <tr style="background: #f8fafc;">
                <th style="padding: 12px; border: 1px solid #e2e8f0; font-size: 13px;">FAT %</th>
                <th style="padding: 12px; border: 1px solid #e2e8f0; font-size: 13px;">RATE (‚Çπ/L)</th>
              </tr>
            </thead>
            <tbody id="rateTableBody" style="background: #fff;">
              <!-- Rates populated by JavaScript -->
            </tbody>
          </table>
        </div>

        <div class="modalFoot" style="flex-shrink: 0; display: flex; gap: 8px;">
          <button class="footBtn good" onclick="editRateFromChart();">‚úèÔ∏è Edit Rate</button>
          <button class="footBtn" onclick="sendRateChartWhatsApp();">üí¨ WhatsApp</button>
          <button class="footBtn" data-close="overlayRateEditor">Close</button>
        </div>
      </div>
    </div>

    <!-- CENTER SUMMARY MODAL -->
    <div class="overlay" id="overlayCenterSummary">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayCenterSummary">‚úñ</button>
            <div>üìä Center Summary</div>
          </div>
          <div class="muted" id="centerSummaryTitle">‚Äî</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <div class="center-summary-card">
              <div class="center-summary-header">
                <div class="center-summary-title">Collection Summary</div>
                <div class="center-summary-date" id="centerSummaryDate">Center: ‚Äî</div>
              </div>

              <div class="center-summary-stats">
                <div class="center-summary-stat">
                  <div class="center-summary-stat-label">Entries</div>
                  <div class="center-summary-stat-value" id="summaryEntries">0</div>
                </div>
                <div class="center-summary-stat">
                  <div class="center-summary-stat-label">Total Milk (L)</div>
                  <div class="center-summary-stat-value" id="summaryMilk">0.0</div>
                </div>
                <div class="center-summary-stat">
                  <div class="center-summary-stat-label">Fat Range</div>
                  <div class="center-summary-stat-value" id="summaryFat">‚Äî</div>
                </div>
                <div class="center-summary-stat">
                  <div class="center-summary-stat-label">Total Amount</div>
                  <div class="center-summary-stat-value" id="summaryAmount">‚Çπ0</div>
                </div>
              </div>

              <div class="dispatch-action">
                <button class="dispatch-action-btn" id="btnMarkDispatch">Mark Milk Sent to Dairy</button>
                <button class="whatsapp-share-btn" id="btnShareCenterSummary">üì§ Send Center Summary (WhatsApp)</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn" id="btnCloseCenterSummary">‚úÖ Close</button>
        </div>
      </div>
    </div>

    <!-- DISPATCH MODAL -->
    <div class="overlay" id="overlayDispatch">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayDispatch">‚úñ</button>
            <div>üöõ Mark Milk Dispatch</div>
          </div>
          <div class="muted">Fill Cane Record</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>Dispatch Information</h3>
            <div class="formGrid">
              <div class="field">
                <label>Total Milk Sent (L)</label>
                <input id="dispatchMilkQty" inputmode="decimal" placeholder="Enter quantity" />
              </div>
              <div class="field">
                <label>Destination</label>
                <select id="dispatchDestination">
                  <option value="dairy">Dairy</option>
                  <option value="bmc">BMC</option>
                </select>
              </div>
              <div class="field full">
                <label>Notes</label>
                <textarea id="dispatchNotes" placeholder="Additional information"></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn good" id="btnSaveDispatch">‚úÖ Save Dispatch</button>
          <button class="footBtn" id="btnCancelDispatch">‚ùå Cancel</button>
        </div>
      </div>
    </div>

    <!-- BMC RECONCILIATION MODAL -->
    <div class="overlay" id="overlayBMCReconcile">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayBMCReconcile">‚úñ</button>
            <div>‚öñÔ∏è BMC Reconciliation</div>
          </div>
          <div class="muted">Compare Records</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>Reconciliation Details</h3>
            <div class="formGrid">
              <div class="field">
                <label>Our Records (L)</label>
                <input id="reconcileOurRecords" inputmode="decimal" readonly />
              </div>
              <div class="field">
                <label>BMC Records (L)</label>
                <input id="reconcileBMCRecords" inputmode="decimal" placeholder="Enter BMC quantity" />
              </div>
              <div class="field">
                <label>Difference (L)</label>
                <input id="reconcileDifference" inputmode="decimal" readonly />
              </div>
              <div class="field">
                <label>Status</label>
                <select id="reconcileStatus">
                  <option value="matched">‚úÖ Matched</option>
                  <option value="variance">‚ö†Ô∏è Variance</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn good" id="btnSaveReconcile">‚úÖ Save Reconciliation</button>
          <button class="footBtn" id="btnCancelBMCReconcile">‚ùå Cancel</button>
        </div>
      </div>
    </div>

    <!-- PAYMENT OBLIGATION MODAL -->
    <div class="overlay" id="overlayPaymentObligation">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayPaymentObligation">‚úñ</button>
            <div>üí∞ Payment Obligation</div>
          </div>
          <div class="muted">Monthly Summary</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>Payment Summary</h3>
            <div class="center-summary-stats">
              <div class="center-summary-stat">
                <div class="center-summary-stat-label">Total Milk Purchased</div>
                <div class="center-summary-stat-value" id="paymentTotalMilk">0.0 L</div>
              </div>
              <div class="center-summary-stat">
                <div class="center-summary-stat-label">Total Amount Due</div>
                <div class="center-summary-stat-value" id="paymentTotalAmount">‚Çπ0</div>
              </div>
              <div class="center-summary-stat">
                <div class="center-summary-stat-label">Advances Given</div>
                <div class="center-summary-stat-value" id="paymentAdvancesGiven">‚Çπ0</div>
              </div>
              <div class="center-summary-stat">
                <div class="center-summary-stat-label">Net Payable</div>
                <div class="center-summary-stat-value" id="paymentNetPayable">‚Çπ0</div>
              </div>
            </div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn" id="btnClosePaymentObligation">‚úÖ Close</button>
        </div>
      </div>
    </div>

    <!-- ADD FARMER MODAL -->
    <div class="overlay" id="overlayFarmer">
      <div class="modal" style="height: auto; max-height: 90vh; display: flex; flex-direction: column;">
        <div class="modalHead" style="flex-shrink: 0;">
          <div class="left">
            <button class="closeBtn" onclick="closeOverlay('overlayFarmer')" title="Close (ESC)">‚úñ</button>
            <div>‚ûï Add Farmer</div>
          </div>
          <div class="muted">Quick & Simple</div>
        </div>

        <div class="modalBody" style="overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch;">
          <div class="formGrid" style="grid-template-columns: repeat(2, 1fr); gap: 16px; padding: 12px;">
            <!-- Essential Fields First -->
            <div class="field" style="padding: 8px;">
              <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">üî¢ Serial No. <span style="font-size: 10px; color: var(--muted); font-weight: normal;">(Auto-generated, editable)</span></label>
              <input id="fSerial" type="text" autocomplete="off" placeholder="Auto: #1" style="font-size: 15px; padding: 14px 12px; width: 100%; border: 2px solid #3b82f6; border-radius: 10px; box-sizing: border-box; background: #f0f9ff;" />
            </div>
            <div class="field" style="padding: 8px;">
              <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">üë§ Name <span style="font-size: 9px; color: var(--muted); font-weight: normal;">(First Last for easy search)</span></label>
              <input id="fName" type="text" autocomplete="name" autocapitalize="words" placeholder="e.g., Ramesh Kumar" style="font-size: 15px; padding: 14px 12px; width: 100%; border: 2px solid var(--line); border-radius: 10px; box-sizing: border-box;" />
            </div>
            <div class="field" style="padding: 8px;">
              <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">üì± Phone Number</label>
              <input id="fPhone" type="tel" inputmode="tel" autocomplete="tel" pattern="[0-9]{10}" maxlength="10" placeholder="10 digit mobile" style="font-size: 15px; padding: 14px 12px; width: 100%; border: 2px solid var(--line); border-radius: 10px; box-sizing: border-box;" />
            </div>
            <div class="field" style="padding: 8px;">
              <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">ü•õ Milk Type <span style="font-size: 10px; color: var(--muted);">(Press Enter to toggle)</span></label>
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px;" onkeydown="if(event.key==='Enter'){event.preventDefault(); const current=document.getElementById('fAnimalType').value; const next=current==='cow'?'buffalo':current==='buffalo'?'both':'cow'; selectFarmerAnimal(next);}">
                <button type="button" id="fAnimalCow" onclick="selectFarmerAnimal('cow')" style="padding: 12px; border: 2px solid var(--line); border-radius: 8px; background: white; cursor: pointer; font-weight: 700; font-size: 13px;" tabindex="0">üêÑ Cow</button>
                <button type="button" id="fAnimalBuffalo" onclick="selectFarmerAnimal('buffalo')" style="padding: 12px; border: 2px solid var(--line); border-radius: 8px; background: white; cursor: pointer; font-weight: 700; font-size: 13px;" tabindex="0">üêÉ Buffalo</button>
                <button type="button" id="fAnimalBoth" onclick="selectFarmerAnimal('both')" style="padding: 12px; border: 2px solid var(--line); border-radius: 8px; background: white; cursor: pointer; font-weight: 700; font-size: 13px;" tabindex="0">üîÑ Both</button>
              </div>
              <input type="hidden" id="fAnimalType" value="cow" />
            </div>
            <div class="field" style="padding: 8px;">
              <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">‚Çπ Opening Balance</label>
              <input id="fBalance" type="number" inputmode="decimal" step="0.01" min="0" value="0" onkeydown="if(event.key==='Enter'){event.preventDefault(); document.getElementById('btnCreateFarmer').click();}" style="font-size: 15px; padding: 14px 12px; width: 100%; border: 2px solid var(--line); border-radius: 10px; box-sizing: border-box;" />
            </div>

            <!-- Shop Details Below -->
            <div style="grid-column: 1 / -1; padding: 16px 8px 8px; margin-top: 8px; border-top: 3px dashed var(--line);">
              <label style="font-size: 12px; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">üè™ Shop Details</label>
            </div>
            <div class="field full" style="padding: 8px; grid-column: 1 / -1;">
              <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">üìç Shop Address</label>
              <input id="fAddress" type="text" autocomplete="street-address" placeholder="Shop no., street, landmark" style="font-size: 15px; padding: 14px 12px; width: 100%; border: 2px solid var(--line); border-radius: 10px; box-sizing: border-box;" />
            </div>
            <div class="field" style="padding: 8px;">
              <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">üèôÔ∏è City</label>
              <input id="fCity" type="text" autocomplete="address-level2" placeholder="City" style="font-size: 15px; padding: 14px 12px; width: 100%; border: 2px solid var(--line); border-radius: 10px; box-sizing: border-box;" />
            </div>
            <div class="field" style="padding: 8px;">
              <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">üìÆ Pincode</label>
              <input id="fPincode" type="text" inputmode="numeric" autocomplete="postal-code" pattern="[0-9]{6}" maxlength="6" placeholder="6 digit" style="font-size: 15px; padding: 14px 12px; width: 100%; border: 2px solid var(--line); border-radius: 10px; box-sizing: border-box;" />
            </div>
            <div class="field" style="padding: 8px;">
              <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">Status</label>
              <select id="fActive" style="font-size: 15px; padding: 14px 12px; width: 100%; border: 2px solid var(--line); border-radius: 10px; background: white; box-sizing: border-box;">
                <option value="1">‚úÖ Active</option>
                <option value="0">‚õî Inactive</option>
              </select>
            </div>
            
            <!-- Payment Details Section (Private - Toggle to View) -->
            <div style="grid-column: 1 / -1; padding: 16px 8px 8px; margin-top: 16px; border-top: 3px dashed #3b82f6; background: #eff6ff; border-radius: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label style="font-size: 12px; color: #1e40af; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; display: block;">üîí Private: Payment Details</label>
                <button onclick="toggleFarmerPaymentDetails()" id="togglePaymentBtn" style="padding: 4px 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 10px;" title="Show/Hide payment details">üëÅÔ∏è Show</button>
              </div>
              <div id="farmerPaymentFields" style="display: none;">
            </div>
            <div class="field full" style="padding: 8px; grid-column: 1 / -1;">
              <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">üì± UPI ID / VPA</label>
              <div style="display: flex; gap: 6px;">
                <input id="fUPI" type="text" autocomplete="off" placeholder="e.g., 9876543210@paytm or mobile@upi" style="font-size: 15px; padding: 14px 12px; width: 100%; border: 2px solid #3b82f6; border-radius: 10px; box-sizing: border-box; flex: 1;" />
                <button onclick="copyToClipboard('fUPI')" style="padding: 8px 12px; background: #e2e8f0; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" title="Copy">üìã</button>
              </div>
            </div>
            <div class="field full" style="padding: 8px; grid-column: 1 / -1;">
              <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">üè¶ Bank Name</label>
              <div style="display: flex; gap: 6px;">
                <input id="fBankName" type="text" autocomplete="off" placeholder="e.g., State Bank of India" style="font-size: 15px; padding: 14px 12px; width: 100%; border: 2px solid #3b82f6; border-radius: 10px; box-sizing: border-box; flex: 1;" />
                <button onclick="copyToClipboard('fBankName')" style="padding: 8px 12px; background: #e2e8f0; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" title="Copy">üìã</button>
              </div>
            </div>
            <div class="field" style="padding: 8px;">
              <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">üî¢ Account Number</label>
              <div style="display: flex; gap: 6px;">
                <input id="fAccountNo" type="text" inputmode="numeric" autocomplete="off" placeholder="Account number" style="font-size: 15px; padding: 14px 12px; width: 100%; border: 2px solid #3b82f6; border-radius: 10px; box-sizing: border-box; flex: 1;" />
                <button onclick="copyToClipboard('fAccountNo')" style="padding: 8px 12px; background: #e2e8f0; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" title="Copy">üìã</button>
              </div>
            </div>
            <div class="field" style="padding: 8px;">
              <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">üîë IFSC Code</label>
              <div style="display: flex; gap: 6px;">
                <input id="fIFSC" type="text" inputmode="text" autocomplete="off" placeholder="e.g., SBIN0001234" style="font-size: 15px; padding: 14px 12px; width: 100%; border: 2px solid #3b82f6; border-radius: 10px; box-sizing: border-box; text-transform: uppercase; flex: 1;" />
                <button onclick="copyToClipboard('fIFSC')" style="padding: 8px 12px; background: #e2e8f0; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" title="Copy">üìã</button>
              </div>
            </div>
            <div class="field full" style="padding: 8px; grid-column: 1 / -1;">
              <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">üë§ Account Holder Name</label>
              <div style="display: flex; gap: 6px;">
                <input id="fAccountName" type="text" autocomplete="name" placeholder="Name as per bank records" style="font-size: 15px; padding: 14px 12px; width: 100%; border: 2px solid #3b82f6; border-radius: 10px; box-sizing: border-box; flex: 1;" />
                <button onclick="copyToClipboard('fAccountName')" style="padding: 8px 12px; background: #e2e8f0; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" title="Copy">üìã</button>
              </div>
            </div>
              <div style="padding: 8px; background: #dbeafe; border-radius: 6px; border-left: 3px solid #3b82f6; margin-top: 8px;">
                <p style="font-size: 11px; color: #1e40af; margin: 0; font-weight: 600;">üí° These details are private. Click üëÅÔ∏è to show/hide.</p>
              </div>
          </div>
        </div>

        <div class="modalFoot" style="flex-shrink: 0;">
          <button class="footBtn good" id="btnCreateFarmer">‚úÖ Create</button>
          <button class="footBtn" id="btnDemoFarmers">üß™ Demo Farmers</button>
        </div>
        
        <!-- Fixed Bottom Actions -->
        <div style="position: sticky; bottom: 0; background: white; border-top: 2px solid #e2e8f0; padding: 12px 20px; display: flex; gap: 8px;">
          <button type="button" onclick="closeOverlay('overlayFarmer')" style="flex: 1; padding: 12px; background: #f1f5f9; color: #64748b; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px;">‚ùå Cancel</button>
          <button type="button" onclick="document.getElementById('btnCreateFarmer').click()" style="flex: 2; padding: 12px; background: #16a34a; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px;">‚úÖ Create</button>
        </div>
        <div style="position: sticky; bottom: 0; background: white; border-top: 1px solid #e2e8f0; padding: 8px 20px;">
          <button type="button" onclick="document.getElementById('btnDemoFarmers').click()" style="width: 100%; padding: 10px; background: #f8fafc; color: #64748b; border: 1px dashed #cbd5e1; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 13px;">üß™ Demo Farmers</button>
        </div>
      </div>
    </div>

    <!-- RECEIPT MODAL -->
    <div class="overlay" id="overlayReceipt">
      <div class="modal">
        <div class="modalHead">
          <div class="left">
            <button class="closeBtn" data-close="overlayReceipt">‚úñ</button>
            <div>üì© Receipt (Locked)</div>
          </div>
          <div class="muted">Copy ‚Ä¢ WhatsApp</div>
        </div>

        <div class="modalBody onecol">
          <div class="modalCol">
            <h3>üßæ Message</h3>
            <div class="receiptBox" id="receiptText">‚Äî</div>
          </div>
        </div>

        <div class="modalFoot">
          <button class="footBtn good" id="btnCopyReceipt">üìã Copy</button>
          <button class="footBtn warn" id="btnWhatsApp">üí¨ WhatsApp</button>
          <button class="footBtn" id="btnCloseReceipt">‚úÖ Done</button>
        </div>
      </div>
    </div>
    <div class="overlay" id="overlayEntryDetail">
  <div class="modal" style="height: auto; align-self: flex-end; border-bottom-left-radius: 0; border-bottom-right-radius: 0;">
    <div class="modalHead">
      <div class="left">
        <button class="closeBtn" data-close="overlayEntryDetail">‚úñ</button>
        <div style="font-weight: 1200;">Entry Detail & Proof</div>
      </div>
    </div>
    <div class="modalBody onecol" id="entryDetailContent" style="padding: 20px; font-weight: 900;">
        </div>
    <div class="modalFoot">
        <button class="pillbtn primary" id="btnSendSingleProof" style="width:100%; justify-content: center;">üì© Send Entry Proof (WhatsApp)</button>
    </div>
  </div>
</div>

<!-- Edit Phone Modal -->
<div class="overlay" id="overlayEditPhone">
  <div class="modal" style="height: auto; max-height: 60vh; width: min(400px, 95vw);">
    <div class="modalHead">
      <div class="left">
        <button class="closeBtn" data-close="overlayEditPhone">‚úñ</button>
        <div>üì± Update Phone Number</div>
      </div>
    </div>
    <div class="modalBody onecol" style="padding: 20px;">
      <p style="font-size: 13px; color: #64748b; margin-bottom: 16px;">
        This farmer doesn't have a phone number. Add one to enable WhatsApp features.
      </p>
      <div style="margin-bottom: 16px;">
        <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">üë§ Farmer Name</label>
        <input id="editPhoneFarmerName" type="text" readonly style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-weight: 700; font-size: 14px; background: #f8fafc;" />
      </div>
      <div style="margin-bottom: 16px;">
        <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 6px;">üì± Phone Number *</label>
        <input id="editPhoneInput" type="tel" inputmode="tel" placeholder="e.g., 9876543210" style="width: 100%; padding: 12px; border: 2px solid #3b82f6; border-radius: 8px; font-weight: 700; font-size: 14px;" />
        <p style="font-size: 11px; color: #64748b; margin-top: 6px;">10 digit mobile number</p>
      </div>
      <button onclick="savePhoneFromEditModal()" style="width: 100%; padding: 14px; background: #16a34a; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 15px;">üíæ Save Phone Number</button>
    </div>
  </div>
</div>

<!-- Farmer Transaction History Modal -->
<div class="overlay" id="overlayFarmerTransactions">
  <div class="modal" style="height: auto; max-height: 80vh;">
    <div class="modalHead">
      <div class="left">
        <button class="closeBtn" data-close="overlayFarmerTransactions">‚úñ</button>
        <div>üìï <span id="transFarmerName">Farmer Name</span> - Advance Management</div>
      </div>
      <div class="muted" id="transDateRange">‚Äî</div>
    </div>
    <div class="modalBody onecol" style="overflow-y: auto; padding: 0;">
      <!-- Summary Cards -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #fef3c7; border-bottom: 1px solid #f59e0b;">
        <div style="background: white; padding: 15px; border-radius: 12px; text-align: center;">
          <div style="font-size: 11px; color: #64748b; font-weight: 700;">TOTAL MILK (MONTH)</div>
          <div style="font-size: 24px; font-weight: 900; color: #1e293b;" id="transTotalMilk">0.0 L</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 12px; text-align: center;">
          <div style="font-size: 11px; color: #64748b; font-weight: 700;">CURRENT ADVANCE</div>
          <div style="font-size: 24px; font-weight: 900; color: #166534;" id="transCurrentAdvance">‚Çπ0.00</div>
        </div>
      </div>
      
      <!-- Farmer Payment Details -->
      <div style="padding: 15px; background: #eff6ff; border-bottom: 1px solid #3b82f6;">
        <div style="font-size: 12px; font-weight: 800; color: #1e40af; margin-bottom: 8px; text-transform: uppercase;">üí≥ Farmer Payment Details</div>
        <div id="farmerPaymentDetails" style="font-size: 11px; color: #1e40af; line-height: 1.6;">
          <!-- Payment details will be inserted here -->
        </div>
      </div>
      
      <!-- Transaction List -->
      <div style="padding: 15px;">
        <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 700; color: #1e293b;">üìä Transaction History</h4>
        <div id="transList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;"></div>
      </div>
      
      <!-- Quick Actions -->
      <div style="padding: 0 15px 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <input type="number" id="transAmount" placeholder="Amount (‚Çπ)" style="padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; font-weight: 700; font-size: 14px;" />
        <select id="transAction" style="padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; font-weight: 700; font-size: 14px;">
          <option value="give">‚ûï Give Advance</option>
          <option value="cut">‚ûñ Cut Advance</option>
          <option value="payment">üíµ Record Payment</option>
        </select>
      </div>
      <div style="padding: 0 15px 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button onclick="updateFarmerAdvance()" style="padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">Update</button>
        <button onclick="sendFarmerSummary()" style="padding: 12px; background: #25D366; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">üí¨ Send Summary</button>
      </div>
    </div>
  </div>
</div>

<div id="kitchenOverlay" class="overlay" style="display:none; align-items: center; justify-content: center;">
    <div class="modal" style="width: 350px;">
        <div class="modalHead">
            <div class="left">Yield Calculator (Paneer/Dahi)</div>
            <button class="closeBtn" onclick="closeKitchen()">‚úñ</button>
        </div>
        <div class="modalBody onecol" style="padding: 20px;">
            <label>Kitna Doodh Use Hua? (Liters)</label>
            <input id="kQty" type="number" oninput="calcYield()" placeholder="0.0" class="numInput" style="width:100%; font-size:24px; margin-bottom:15px;">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div style="background:#f0f9ff; padding:10px; border-radius:10px; text-align:center;">
                    <div style="font-size:12px; color:#0369a1;">Buffalo Paneer</div>
                    <div id="buffPaneer" style="font-size:20px; font-weight:1000; color:#0369a1;">0.00 kg</div>
                </div>
                <div style="background:#fff7ed; padding:10px; border-radius:10px; text-align:center;">
                    <div style="font-size:12px; color:#9a3412;">Cow Paneer</div>
                    <div id="cowPaneer" style="font-size:20px; font-weight:1000; color:#9a3412;">0.00 kg</div>
                </div>
            </div>
            <p style="font-size:11px; color:var(--muted); margin-top:15px; line-height:1.4;">
                *Standard Yield: Buffalo (22%), Cow (15%). Agar isse kam paneer nikal raha hai toh check karein.
            </p>
        </div>
    </div>
</div>
    <script>
      // Point 2.6: Success Sound Feedback Logic
function playSuccessSound() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    oscillator.type = 'sine'; // Soft sound
    oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // Pitch (High Note)
    
    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.1);
}
      /***********************
       * OFFLINE DATA MODEL  *
       ***********************/
      const LS = {
        farmers: "milkapp_farmers_v2",
        entries: "milkapp_entries_v2",
        settings: "milkapp_settings_v2",
        hold: "milkapp_hold_v2",
        lastUndo: "milkapp_lastundo_v2",
      };

      const defaultSettings = {
        cowBase: 18.0,
        cowBaseOp: 'fixed',
        cowFactor: 6.0,
        cowFatOp: 'multiply',
        cowSnfFactor: 3.0,
        cowSnfOp: 'multiply',
        buffBase: 22.0,
        buffBaseOp: 'fixed',
        buffFactor: 7.0,
        buffFatOp: 'multiply',
        buffSnfFactor: 3.5,
        buffSnfOp: 'multiply',
        qtyStep: 0.5,
        fatStep: 0.1,
        snfStep: 0.1,
        sessionSwitchHour: 14,
      };

      function loadSettings() {
        try {
          const saved = localStorage.getItem(LS.settings);
          console.log('üîµ Raw settings from localStorage:', saved);
          
          const s = saved ? JSON.parse(saved) : null;
          const settings = { ...defaultSettings, ...(s || {}) };
          console.log('üîµ Settings loaded - cowBase:', settings.cowBase, 'buffBase:', settings.buffBase);
          return settings;
        } catch (e) {
          console.log('‚ö†Ô∏è Settings load error:', e);
          return { ...defaultSettings };
        }
      }
      function saveSettings(s) {
        console.log('üíæ Saving settings:', s.cowBase, s.buffBase);
        localStorage.setItem(LS.settings, JSON.stringify(s));
        console.log('‚úÖ Settings saved, verifying...');
        const verify = localStorage.getItem(LS.settings);
        console.log('üîç Saved value:', verify);
      }

      function loadFarmers() {
        try {
          return JSON.parse(localStorage.getItem(LS.farmers) || "[]") || [];
        } catch (e) {
          return [];
        }
      }
      function saveFarmers(arr) {
        localStorage.setItem(LS.farmers, JSON.stringify(arr));
      }

      function loadEntries() {
        try {
          return JSON.parse(localStorage.getItem(LS.entries) || "[]") || [];
        } catch (e) {
          return [];
        }
      }
      function saveEntries(arr) {
        localStorage.setItem(LS.entries, JSON.stringify(arr));
      }

      function uid(prefix = "id") {
        return (
          prefix +
          "_" +
          Math.random().toString(16).slice(2) +
          "_" +
          Date.now().toString(16)
        );
      }

      /***********************
       * TIME + DATE HELPERS *
       ***********************/
      function pad(n) {
        return String(n).padStart(2, "0");
      }
      function fmtTime(d) {
        return pad(d.getHours()) + ":" + pad(d.getMinutes());
      }
      function fmtDate(d) {
        const y = d.getFullYear();
        const m = pad(d.getMonth() + 1);
        const da = pad(d.getDate());
        return `${y}-${m}-${da}`;
      }
      function startOfDay(d) {
        const x = new Date(d);
        x.setHours(0, 0, 0, 0);
        return x;
      }
      function daysAgo(n) {
        const d = new Date();
        d.setDate(d.getDate() - n);
        return startOfDay(d);
      }

      function autoSessionLabel() {
    const h = new Date().getHours();
    // settings.sessionSwitchHour humne 14 (2 PM) rakha hai
    // Agar ghanta 14 se kam hai toh Morning, varna Evening
    return h < settings.sessionSwitchHour ? "Morning" : "Evening"; 
}

      /***********************
       * APP STATE           *
       ***********************/
      let settings = loadSettings();
      let farmers = loadFarmers();
      let entries = loadEntries();

      let selectedFarmerId = null;
      let selectedCollectionPointId = "DEFAULT";

      let qty = 0.0;
      let fat = 0.0;
      let snf = 0.0;
      let clr = 0.0; // Naya variable CLR ke liye

      let animal = "cow"; // cow | buffalo
      let rateMode = "auto"; // auto | manual
      let manualRate = 0.0;
      let paymentMode = "Cash"; // Cash | Credit (for SAVE vs LIKHLO buttons)

      // Farmer paging
      const FARMERS_PER_PAGE = 20; // 4x5 grid (20 farmers per page)
      let farmerPage = 0;
      let farmerSearch = "";

      // History paging
      const LIST_PER_PAGE = 6;
      let todayPage = 0,
        weekPage = 0;

      // Leader paging
      const LEADER_PER_PAGE = 8;
      let leaderPage = 0;
      let leaderMode = "amount"; // amount | liters | count

      // Timer
      let timerStart = Date.now();
      let timerInt = null;

      /***********************
       * UI HOOKS            *
       ***********************/
      const el = (id) => document.getElementById(id);

      const farmerGrid = el("farmerGrid");
      const searchInput = el("searchInput");
      const farmerCount = el("farmerCount");

      const amountView = el("amountView");
      const rateView = el("rateView"); // hidden but used
      const selectedName = el("selectedName");

      const balBefore = el("balBefore");
      const balAfter = el("balAfter");

      const manualRateRow = el("manualRateRow");
      const manualRateInput = el("manualRateInput");
      const rateTypeLabel = el("rateTypeLabel");
      const holdBadge = el("holdBadge");
      const toast = el("toast");

      // Auto-select text on click for manual rate input
      if (manualRateInput) {
        manualRateInput.addEventListener("click", function() { this.select(); });
      }

      const recentTbody = el("recentTbody");
      const recentMeta = el("recentMeta");
      const trailMini = el("trailMini");

      const animalSelect = el("animalSelect");
      const manualRateApply = el("manualRateApply");

      const qtyInput = el("qtyInput");
      const fatInput = el("fatInput");
      const snfInput = el("snfInput");

      // Auto-select all text on click/focus for easy editing
      qtyInput.addEventListener("click", function() { this.select(); });
      fatInput.addEventListener("click", function() { this.select(); });
      snfInput.addEventListener("click", function() { this.select(); });

      /* Manual typing ‚Üí state update */
      qtyInput.addEventListener("input", (e) => {
        qty = Number(e.target.value) || 0;
        console.log('üîµ Qty changed:', qty, 'Calling renderTrust()');
        renderTrust();
      });
      // Enter key navigation: Qty ‚Üí Fat
      qtyInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          e.stopPropagation();
          fatInput.focus();
          fatInput.select();
        }
      });

      fatInput.addEventListener("input", (e) => {
        fat = Number(e.target.value) || 0;
        console.log('üîµ Fat changed:', fat, 'Calling renderTrust()');
        renderTrust();
      });
      // Enter key navigation: Fat ‚Üí SNF
      fatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          e.stopPropagation();
          snfInput.focus();
          snfInput.select();
        }
      });

      snfInput.addEventListener("input", (e) => {
        snf = Number(e.target.value) || 0;
        console.log('üîµ SNF changed:', snf, 'Calling renderTrust()');
        renderTrust();
      });
      // Enter key navigation: SNF ‚Üí Animal Type (Cow button)
      snfInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          e.stopPropagation();
          const cowBtn = el("animalCow");
          if (cowBtn) {
            cowBtn.focus();
          }
        }
      });

      /* + / ‚àí ke baad input sync */
      function syncInputs() {
  // Check karein: User jis dabba mein type kar raha hai, use refresh mat karo
  if (document.activeElement !== el("qtyInput")) {
    el("qtyInput").value = round2(qty).toFixed(1);
  }
  if (document.activeElement !== el("fatInput")) {
    el("fatInput").value = round2(fat).toFixed(1);
  }
  if (document.activeElement !== el("snfInput")) {
    el("snfInput").value = round2(snf).toFixed(1);
  }
  // Iske andar density update add karein
  if (document.activeElement !== el("densityInput")) {
    el("densityInput").value = clr;
  }
  
  // Manual rate input ko current rate se pre-fill karo
  if (manualRateInput && document.activeElement !== manualRateInput) {
    if (!manualRate || manualRate === 0) {
      // Auto mode: Current rate se pre-fill
      const currentRate = settings.cowBase ? Number(settings.cowBase).toFixed(2) : "0.00";
      manualRateInput.value = currentRate;
      manualRateInput.placeholder = `Auto: ‚Çπ${currentRate}`;
    } else {
      // Manual mode: User ka entered value dikhao
      manualRateInput.value = manualRate.toFixed(2);
      manualRateInput.placeholder = `Manual: ‚Çπ${manualRate.toFixed(2)}`;
    }
  }
  
  // Ensure manual rate input ALWAYS has a value (never empty)
  if (manualRateInput && !manualRateInput.value) {
    const currentRate = settings.cowBase ? Number(settings.cowBase).toFixed(2) : "0.00";
    manualRateInput.value = currentRate;
  }
}
  // Calculate SNF from CLR (Density) - only if SNF field is empty
  function calculateSNFFromCLR() {
  // Only auto-calculate if SNF input is empty or zero (user hasn't entered manually)
  const snfValue = el("snfInput")?.value;
  const userEnteredSNF = snfValue && Number(snfValue) > 0;
  
  // If user already entered SNF, don't overwrite it
  if (userEnteredSNF) return;
  
  if (clr > 0 && fat > 0) {
    // Standard SNF calculation formula
    snf = round2((clr / 4) + (fat * 0.21) + 0.36);
    // Update SNF input field
    if (el("snfInput")) el("snfInput").value = snf.toFixed(1);
  }
}
      /***********************
       * TOAST               *
       ***********************/
      let toastT = null;
      function showToast(msg) {
        toast.textContent = msg;
        toast.classList.add("show");
        clearTimeout(toastT);
        toastT = setTimeout(() => toast.classList.remove("show"), 1200);
      }

      // Copy to clipboard utility function
      function copyToClipboard(elementId) {
        const el = document.getElementById(elementId);
        if (el && el.value) {
          navigator.clipboard.writeText(el.value).then(() => {
            showToast('üìã Copied!');
          }).catch(() => {
            // Fallback for older browsers
            el.select();
            document.execCommand('copy');
            showToast('üìã Copied!');
          });
        } else {
          showToast('‚ö†Ô∏è Nothing to copy');
        }
      }

      // Copy all farmer payment details
      function copyFarmerPaymentDetails() {
        const upi = document.getElementById('fUPI')?.value || '';
        const bank = document.getElementById('fBankName')?.value || '';
        const account = document.getElementById('fAccountNo')?.value || '';
        const ifsc = document.getElementById('fIFSC')?.value || '';
        const accountName = document.getElementById('fAccountName')?.value || '';
        
        let details = 'üí≥ Farmer Payment Details\n';
        details += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
        if (upi) details += `üì± UPI: ${upi}\n`;
        if (bank) details += `üè¶ Bank: ${bank}\n`;
        if (account) details += `üî¢ Account: ${account}\n`;
        if (ifsc) details += `üîë IFSC: ${ifsc}\n`;
        if (accountName) details += `üë§ Name: ${accountName}\n`;
        
        if (details.split('\n').length > 2) {
          navigator.clipboard.writeText(details).then(() => {
            showToast('üìã All details copied!');
          }).catch(() => {
            showToast('‚ö†Ô∏è Copy failed');
          });
        } else {
          showToast('‚ö†Ô∏è No details to copy');
        }
      }

      // Toggle farmer payment details visibility
      function toggleFarmerPaymentDetails() {
        const fieldsDiv = document.getElementById('farmerPaymentFields');
        const toggleBtn = document.getElementById('togglePaymentBtn');

        if (fieldsDiv.style.display === 'none') {
          fieldsDiv.style.display = 'block';
          toggleBtn.textContent = 'üôà Hide';
          showToast('üîì Payment details shown');
        } else {
          fieldsDiv.style.display = 'none';
          toggleBtn.textContent = 'üëÅÔ∏è Show';
          showToast('üîí Payment details hidden');
        }
      }

      // Open edit phone modal
      function openEditPhoneModal() {
        const f = getFarmerById(selectedFarmerId);
        if (!f) return;

        document.getElementById('editPhoneFarmerName').value = f.name;
        document.getElementById('editPhoneInput').value = f.phone || '';
        openOverlay('overlayEditPhone');

        // Focus phone input
        setTimeout(() => {
          const phoneInput = document.getElementById('editPhoneInput');
          if (phoneInput) {
            phoneInput.focus();
            phoneInput.select();
          }
        }, 300);
      }

      // Save phone from edit modal
      function savePhoneFromEditModal() {
        const f = getFarmerById(selectedFarmerId);
        const phone = document.getElementById('editPhoneInput').value.trim();

        if (!phone) {
          showToast('‚ö†Ô∏è Phone number required');
          return;
        }

        if (phone.length !== 10 || !/^[0-9]+$/.test(phone)) {
          showToast('‚ö†Ô∏è Enter valid 10 digit number');
          return;
        }

        // Update farmer phone
        f.phone = phone;
        saveFarmers(farmers);

        closeOverlay('overlayEditPhone');
        showToast('‚úÖ Phone number saved!');

        // Refresh UI
        renderAll();
      }

      /***********************
       * FARMER HELPERS      *
       ***********************/
      function getFarmerById(id) {
        return farmers.find((f) => f.id === id) || null;
      }
      function activeFarmers() {
        return farmers.filter((f) => f.active !== false);
      }
      function filterFarmers() {
        let list = activeFarmers();

        // Filter by selected booth/collection point (show farmers from selected booth first)
        if (selectedCollectionPointId && selectedCollectionPointId !== 'DEFAULT') {
          // Sort: Farmers from selected booth first, then others
          list = list.sort((a, b) => {
            const aBooth = a.collectionPoint || 'DEFAULT';
            const bBooth = b.collectionPoint || 'DEFAULT';
            if (aBooth === selectedCollectionPointId && bBooth !== selectedCollectionPointId) return -1;
            if (aBooth !== selectedCollectionPointId && bBooth === selectedCollectionPointId) return 1;
            return 0;
          });
        }

        if (!farmerSearch.trim()) return list;
        const q = farmerSearch.trim().toLowerCase();
        // Enhanced search: serial, full name, first name, last name, short name, phone, address, city, pincode
        return list.filter((f) => {
          return (f.serial || "").toLowerCase().includes(q) ||
                 (f.name || "").toLowerCase().includes(q) ||
                 (f.firstName || "").toLowerCase().includes(q) ||
                 (f.lastName || "").toLowerCase().includes(q) ||
                 (f.shortName || "").toLowerCase().includes(q) ||
                 (f.phone || "").toLowerCase().includes(q) ||
                 (f.address || "").toLowerCase().includes(q) ||
                 (f.city || "").toLowerCase().includes(q) ||
                 (f.pincode || "").toLowerCase().includes(q);
        });
      }

      // Edit farmer name
      function editFarmerName(farmerId) {
        const farmer = getFarmerById(farmerId);
        if (!farmer) return;

        const newName = prompt("Edit farmer name:", farmer.name);
        if (newName && newName.trim() !== "" && newName !== farmer.name) {
          // Capitalize first letter of each word
          const capitalizeName = (str) => {
            return str.replace(/\b\w/g, c => c.toUpperCase());
          };
          farmer.name = capitalizeName(newName.trim());
          // Update split name fields for better search
          const nameParts = farmer.name.split(/\s+/).filter(p => p.length > 0);
          farmer.firstName = nameParts[0] || '';
          farmer.lastName = nameParts.slice(1).join(' ') || '';
          farmer.shortName = farmer.firstName ? farmer.firstName.charAt(0).toUpperCase() : '';
          saveFarmers(farmers);
          renderFarmers();
          renderAll();
          showToast(`Name updated: ${farmer.name} ‚úÖ`);
        }
      }

      function ensureSelectedFarmer() {
        const list = activeFarmers();
        if (!selectedFarmerId && list.length) {
          selectedFarmerId = list[0].id;
        } else if (
          selectedFarmerId &&
          !list.some((f) => f.id === selectedFarmerId)
        ) {
          selectedFarmerId = list.length ? list[0].id : null;
        }
      }
      function openKitchen() { el("kitchenOverlay").style.display = "flex"; el("kQty").focus(); }
function closeKitchen() { el("kitchenOverlay").style.display = "none"; }

function calcYield() {
    const qty = Number(el("kQty").value) || 0;
    // Standard Math: Buff 22%, Cow 15%
    el("buffPaneer").textContent = (qty * 0.22).toFixed(2) + " kg";
    el("cowPaneer").textContent = (qty * 0.15).toFixed(2) + " kg";
}
      /***********************
       * CALCULATION         *
       ***********************/
      function round2(n) {
        return Math.round((n + Number.EPSILON) * 100) / 100;
      }

      // Indian number formatting (lakhs/crores system): 1,11,11,111
      function formatIndianNumber(num) {
        const parts = num.toString().split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{2})+(?!\d)(?=(\d{3})))/g, ',');
        return parts.join('.');
      }

      // Format amount with Indian numbering: ‚Çπ1,11,11,111.00
      function formatAmount(num) {
        return '‚Çπ' + formatIndianNumber(round2(num).toFixed(2));
      }

      function getAutoRatePerLiter(fatVal, animalType) {
        const f = Number(fatVal) || 0;
        let rate;
        
        if (animalType === "buffalo") {
          // Buffalo rate calculation with operators
          rate = settings.buffBase;
          
          // Apply base operator
          if (settings.buffBaseOp === 'fat') rate = settings.buffBase * f;
          else if (settings.buffBaseOp === 'snf') rate = settings.buffBase * f;
          else if (settings.buffBaseOp === 'fat_snf') rate = settings.buffBase * (f + f);
          
          // Apply fat operator
          if (settings.buffFatOp === 'multiply') rate += settings.buffFactor * f;
          else if (settings.buffFatOp === 'add') rate += settings.buffFactor + f;
          
          // Apply SNF operator (using same fat value for buffalo)
          if (settings.buffSnfOp === 'multiply') rate += settings.buffSnfFactor * f;
          else if (settings.buffSnfOp === 'add') rate += settings.buffSnfFactor + f;
        } else {
          // Cow rate calculation with operators
          rate = settings.cowBase;
          
          // Apply base operator
          if (settings.cowBaseOp === 'fat') rate = settings.cowBase * f;
          else if (settings.cowBaseOp === 'snf') rate = settings.cowBase * f;
          else if (settings.cowBaseOp === 'fat_snf') rate = settings.cowBase * (f + f);
          
          // Apply fat operator
          if (settings.cowFatOp === 'multiply') rate += settings.cowFactor * f;
          else if (settings.cowFatOp === 'add') rate += settings.cowFactor + f;
          
          // Apply SNF operator
          if (settings.cowSnfOp === 'multiply') rate += settings.cowSnfFactor * f;
          else if (settings.cowSnfOp === 'add') rate += settings.cowSnfFactor + f;
        }
        
        const finalRate = round2(rate);
        console.log('üîµ getAutoRatePerLiter:', animalType, 'Fat:', f, '‚Üí Rate:', finalRate, '(Base:', settings.cowBase, 'Factor:', settings.cowFactor + ')');
        return finalRate;
      }

      function getRatePerLiter() {
    // Check if manual rate override has a value
    const mInput = el("manualRateInput");
    if (mInput && mInput.value && Number(mInput.value) > 0) {
        return round2(Number(mInput.value));
    }

    // Auto calculate from Fat AND SNF using configured operators
    // Use global variables (already updated by input listeners)
    const f = fat || 0;
    const s = snf || 0;
    const a = animal || 'cow';

    if (a === "buffalo") {
        // Buffalo rate calculation with operators
        let rate = settings.buffBase;
        
        // Apply base operator
        if (settings.buffBaseOp === 'fat') rate = settings.buffBase * f;
        else if (settings.buffBaseOp === 'snf') rate = settings.buffBase * s;
        else if (settings.buffBaseOp === 'fat_snf') rate = settings.buffBase * (f + s);
        
        // Apply fat operator
        if (settings.buffFatOp === 'multiply') rate += settings.buffFactor * f;
        else if (settings.buffFatOp === 'add') rate += settings.buffFactor + f;
        
        // Apply SNF operator
        if (settings.buffSnfOp === 'multiply') rate += settings.buffSnfFactor * s;
        else if (settings.buffSnfOp === 'add') rate += settings.buffSnfFactor + s;
        
        return round2(rate);
    }
    
    // Cow rate calculation with operators
    let rate = settings.cowBase;
    
    // Apply base operator
    if (settings.cowBaseOp === 'fat') rate = settings.cowBase * f;
    else if (settings.cowBaseOp === 'snf') rate = settings.cowBase * s;
    else if (settings.cowBaseOp === 'fat_snf') rate = settings.cowBase * (f + s);
    
    // Apply fat operator
    if (settings.cowFatOp === 'multiply') rate += settings.cowFactor * f;
    else if (settings.cowFatOp === 'add') rate += settings.cowFactor + f;
    
    // Apply SNF operator
    if (settings.cowSnfOp === 'multiply') rate += settings.cowSnfFactor * s;
    else if (settings.cowSnfOp === 'add') rate += settings.cowSnfFactor + s;
    
    return round2(rate);
}
      function getAmount() {
        const r = getRatePerLiter();
        const q = Number(qty) || 0;
        return round2(q * r);
      }

      function farmerBalanceBefore(farmer) {
        return round2(Number(farmer.balance || 0));
      }

      /***********************
       * RENDER FARMERS      *
       ***********************/
      function escapeHtml(s) {
        return String(s).replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            })[c],
        );
      }

      // Global variable photo store karne ke liye
let currentEntryImage = null;

// Photo khinchne par use capture karein
document.getElementById("fImageEntry").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            currentEntryImage = event.target.result; // Photo data tayyar hai
            showToast("Photo Attached! üì∑ ‚úÖ");
        };
        reader.readAsDataURL(file);
    }
});

      function renderFarmers() {
    const activeCount = activeFarmers().length;
    farmerCount.textContent = `${activeCount} üë§`;

    // Debug logging
    console.log('Farmers:', farmers.length, 'Active:', activeCount, 'Page:', farmerPage);

    const list = filterFarmers();
    const maxPage = Math.max(0, Math.ceil(list.length / FARMERS_PER_PAGE) - 1);
    if (farmerPage > maxPage) farmerPage = maxPage;
    if (farmerPage < 0) farmerPage = 0;

    // Show/hide navigation buttons based on farmer count
    const farmerNav = el("prevFarmers")?.parentElement;
    const farmerCountEl = el("farmerCount");
    const prevBtn = el("prevFarmers");
    const nextBtn = el("nextFarmers");

    if (farmerNav) {
      farmerNav.style.display = list.length > FARMERS_PER_PAGE ? 'flex' : 'none';
    }

    // Update button states
    if (prevBtn) prevBtn.disabled = farmerPage <= 0;
    if (nextBtn) nextBtn.disabled = farmerPage >= maxPage;

    // Update farmer count display
    if (farmerCountEl) {
      farmerCountEl.textContent = `${list.length} üë§ Page ${farmerPage + 1}/${maxPage + 1}`;
    }

    const start = farmerPage * FARMERS_PER_PAGE;
    const pageItems = list.slice(start, start + FARMERS_PER_PAGE);

    console.log('Rendering farmers:', pageItems.length, 'from index', start);

    farmerGrid.innerHTML = "";

    // Only show actual farmers, no empty slots
    pageItems.forEach((f) => {
        const card = document.createElement("div");
        card.className = "fcard";

        if (f) {
            // --- 1. Focus & Double Click Support (NAYA) ---
            card.setAttribute("tabindex", "0");

            // Double Click logic: Yahan kisan ke card par double tap karne se dabba khulega
            card.ondblclick = (e) => {
                e.stopPropagation();
                openFarmerDetail(f.id);
            };
            // ----------------------------------------------

            const isSel = f.id === selectedFarmerId;
            if (isSel) card.classList.add("fsel");

            const imgHTML = f.imageData ? `<img alt="" src="${f.imageData}">` : `üë§`;
            
            // Show animal type icon if farmer has preference
            const animalIcon = f.animalType === 'cow' ? 'üêÑ' : f.animalType === 'buffalo' ? 'üêÉ' : f.animalType === 'both' ? 'üîÑ' : '';

            card.innerHTML = `
                <div class="fimg">${imgHTML}</div>
                <div style="min-width:0; flex: 1;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 2px;">
                        <div class="fname" title="${escapeHtml(f.name || "")}" style="flex: 1;">${escapeHtml(f.name || "")}</div>
                        ${animalIcon ? `<span style="font-size: 10px;">${animalIcon}</span>` : ''}
                        ${f.serial ? `<span style="font-size: 7px; font-weight: 700; color: #3b82f6; background: #dbeafe; padding: 1px 3px; border-radius: 2px;">#${escapeHtml(f.serial)}</span>` : ''}
                    </div>
                    <div class="fsub">${f.phone || ""} ‚Ä¢ ${formatAmount(f.balance || 0)}</div>
                </div>
                <button class="editFarmerBtn" onclick="event.stopPropagation(); editFarmerName('${f.id}')" title="Edit Name" style="background:none; border:none; cursor:pointer; font-size:10px; padding:1px; opacity:0.6;">‚úèÔ∏è</button>
                ${isSel ? `<div class="badge">Selected</div>` : ``}
            `;

            card.addEventListener("click", () => {
                selectedFarmerId = f.id;
                //  ‚úÖ SOUND UNLOCK LOGIC
    // Jab operator kisan ko touch karega, browser sound bajane ki permission de dega
    const dummyCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (dummyCtx.state === 'suspended') dummyCtx.resume();
    // ----------------------------

                // Auto-fill from previous entry for this farmer
                loadFarmerMemory(f.id);

                renderAll();
                el("qtyInput").focus();
                el("qtyInput").select();
            });

            // Double-click to view transaction history
            card.addEventListener("dblclick", (e) => {
                e.stopPropagation();
                openFarmerTransactions(f.id);
            });

        } else if (farmerSearch && list.length === 0) {
            // "Add New Farmer" card when search has no results
            card.style.opacity = 1;
            card.style.background = '#f0fdf4';
            card.style.borderColor = '#16a34a';
            card.innerHTML = `
                <div class="fimg" style="font-size: 32px;">‚ûï</div>
                <div style="min-width:0;">
                    <div class="fname" style="color: #16a34a;">Add "${escapeHtml(farmerSearch)}"</div>
                    <div class="fsub">Click to create new farmer</div>
                </div>
            `;
            card.addEventListener("click", () => {
                // Open farmer modal and pre-fill name
                openOverlay("overlayFarmer");
                setTimeout(() => {
                    el("fName").value = farmerSearch;
                    el("fPhone").focus();
                }, 300);
            });
        }

        farmerGrid.appendChild(card);
    });

    el("prevFarmers").disabled = farmerPage <= 0;
    el("nextFarmers").disabled = farmerPage >= maxPage;
}

      // Rate List kholne ke liye - show the rate chart
function openRateEditor() {
    openRateTable();  // Show rate list chart
}

// Update formula preview in settings
function updateFormulaPreview() {
    const cowBase = Number(el("setCowBase")?.value || 0);
    const cowBaseOp = el("setCowBaseOp")?.value || 'fixed';
    const cowFactor = Number(el("setCowFactor")?.value || 0);
    const cowFatOp = el("setCowFatOp")?.value || 'multiply';
    const cowSnfFactor = Number(el("setCowSnfFactor")?.value || 0);
    const cowSnfOp = el("setCowSnfOp")?.value || 'multiply';
    
    const buffBase = Number(el("setBuffBase")?.value || 0);
    const buffBaseOp = el("setBuffBaseOp")?.value || 'fixed';
    const buffFactor = Number(el("setBuffFactor")?.value || 0);
    const buffFatOp = el("setBuffFatOp")?.value || 'multiply';
    const buffSnfFactor = Number(el("setBuffSnfFactor")?.value || 0);
    const buffSnfOp = el("setBuffSnfOp")?.value || 'multiply';

    const preview = el("formulaPreview");
    if (preview) {
      // Build Cow formula string
      let cowFormula = `‚Çπ${cowBase}`;
      if (cowBaseOp === 'fat') cowFormula = `‚Çπ${cowBase} √ó Fat%`;
      else if (cowBaseOp === 'snf') cowFormula = `‚Çπ${cowBase} √ó SNF%`;
      else if (cowBaseOp === 'fat_snf') cowFormula = `‚Çπ${cowBase} √ó (Fat% + SNF%)`;
      
      if (cowFatOp === 'multiply' && cowFatOp !== 'disabled') cowFormula += ` + (‚Çπ${cowFactor} √ó Fat%)`;
      else if (cowFatOp === 'add' && cowFatOp !== 'disabled') cowFormula += ` + (‚Çπ${cowFactor} + Fat%)`;
      
      if (cowSnfOp === 'multiply' && cowSnfOp !== 'disabled') cowFormula += ` + (‚Çπ${cowSnfFactor} √ó SNF%)`;
      else if (cowSnfOp === 'add' && cowSnfOp !== 'disabled') cowFormula += ` + (‚Çπ${cowSnfFactor} + SNF%)`;
      
      // Build Buffalo formula string
      let buffFormula = `‚Çπ${buffBase}`;
      if (buffBaseOp === 'fat') buffFormula = `‚Çπ${buffBase} √ó Fat%`;
      else if (buffBaseOp === 'snf') buffFormula = `‚Çπ${buffBase} √ó SNF%`;
      else if (buffBaseOp === 'fat_snf') buffFormula = `‚Çπ${buffBase} √ó (Fat% + SNF%)`;
      
      if (buffFatOp === 'multiply' && buffFatOp !== 'disabled') buffFormula += ` + (‚Çπ${buffFactor} √ó Fat%)`;
      else if (buffFatOp === 'add' && buffFatOp !== 'disabled') buffFormula += ` + (‚Çπ${buffFactor} + Fat%)`;
      
      if (buffSnfOp === 'multiply' && buffSnfOp !== 'disabled') buffFormula += ` + (‚Çπ${buffSnfFactor} √ó SNF%)`;
      else if (buffSnfOp === 'add' && buffSnfOp !== 'disabled') buffFormula += ` + (‚Çπ${buffSnfFactor} + SNF%)`;
      
      preview.innerHTML = `
        <div style="color: #16a34a; margin-bottom: 6px;">üêÑ Cow: ${cowFormula}</div>
        <div style="color: #d97706;">üêÉ Buffalo: ${buffFormula}</div>
      `;
    }
}

// Live rate preview for Cow and Buffalo
function updateLivePreview() {
    // Get current Fat and SNF from main form
    const fat = Number(el("fatInput")?.value || 4.0);
    const snf = Number(el("snfInput")?.value || 8.5);
    
    // Update Fat/SNF displays
    if (el("cowFatDisplay")) el("cowFatDisplay").textContent = fat.toFixed(1);
    if (el("cowSnfDisplay")) el("cowSnfDisplay").textContent = snf.toFixed(1);
    if (el("buffFatDisplay")) el("buffFatDisplay").textContent = fat.toFixed(1);
    if (el("buffSnfDisplay")) el("buffSnfDisplay").textContent = snf.toFixed(1);
    
    // Calculate Cow rate
    const cowBase = Number(el("setCowBase")?.value || 0);
    const cowBaseOp = el("setCowBaseOp")?.value || 'fixed';
    const cowFactor = Number(el("setCowFactor")?.value || 0);
    const cowFatOp = el("setCowFatOp")?.value || 'multiply';
    const cowSnfFactor = Number(el("setCowSnfFactor")?.value || 0);
    const cowSnfOp = el("setCowSnfOp")?.value || 'multiply';
    
    let cowRate = cowBase;
    let cowFormula = `‚Çπ${cowBase}`;
    let cowExample = `${cowBase}`;
    
    if (cowBaseOp === 'fat') { 
        cowRate = cowBase * fat; 
        cowFormula = `‚Çπ${cowBase}√óFat`; 
        cowExample = `${cowBase}√ó${fat.toFixed(1)}`; 
    } else if (cowBaseOp === 'snf') { 
        cowRate = cowBase * snf; 
        cowFormula = `‚Çπ${cowBase}√óSNF`; 
        cowExample = `${cowBase}√ó${snf.toFixed(1)}`; 
    } else if (cowBaseOp === 'fat_snf') { 
        cowRate = cowBase * (fat + snf); 
        cowFormula = `‚Çπ${cowBase}√ó(Fat+SNF)`; 
        cowExample = `${cowBase}√ó(${fat.toFixed(1)}+${snf.toFixed(1)})`; 
    }
    
    if (cowFatOp === 'multiply') { 
        cowRate += cowFactor * fat; 
        cowFormula += ` + (‚Çπ${cowFactor}√óFat)`; 
        cowExample += ` + (${cowFactor}√ó${fat.toFixed(1)})`; 
    } else if (cowFatOp === 'add') { 
        cowRate += cowFactor + fat; 
        cowFormula += ` + (‚Çπ${cowFactor}+Fat)`; 
        cowExample += ` + (${cowFactor}+${fat.toFixed(1)})`; 
    } else if (cowFatOp === 'disabled') {
        cowFormula += ` + (Fat: Disabled)`;
    }
    
    if (cowSnfOp === 'multiply') { 
        cowRate += cowSnfFactor * snf; 
        cowFormula += ` + (‚Çπ${cowSnfFactor}√óSNF)`; 
        cowExample += ` + (${cowSnfFactor}√ó${snf.toFixed(1)})`; 
    } else if (cowSnfOp === 'add') { 
        cowRate += cowSnfFactor + snf; 
        cowFormula += ` + (‚Çπ${cowSnfFactor}+SNF)`; 
        cowExample += ` + (${cowSnfFactor}+${snf.toFixed(1)})`; 
    } else if (cowSnfOp === 'disabled') {
        cowFormula += ` + (SNF: Disabled)`;
    }
    
    // Calculate Buffalo rate
    const buffBase = Number(el("setBuffBase")?.value || 0);
    const buffBaseOp = el("setBuffBaseOp")?.value || 'fixed';
    const buffFactor = Number(el("setBuffFactor")?.value || 0);
    const buffFatOp = el("setBuffFatOp")?.value || 'multiply';
    const buffSnfFactor = Number(el("setBuffSnfFactor")?.value || 0);
    const buffSnfOp = el("setBuffSnfOp")?.value || 'multiply';
    
    let buffRate = buffBase;
    let buffFormula = `‚Çπ${buffBase}`;
    let buffExample = `${buffBase}`;
    
    if (buffBaseOp === 'fat') { 
        buffRate = buffBase * fat; 
        buffFormula = `‚Çπ${buffBase}√óFat`; 
        buffExample = `${buffBase}√ó${fat.toFixed(1)}`; 
    } else if (buffBaseOp === 'snf') { 
        buffRate = buffBase * snf; 
        buffFormula = `‚Çπ${buffBase}√óSNF`; 
        buffExample = `${buffBase}√ó${snf.toFixed(1)}`; 
    } else if (buffBaseOp === 'fat_snf') { 
        buffRate = buffBase * (fat + snf); 
        buffFormula = `‚Çπ${buffBase}√ó(Fat+SNF)`; 
        buffExample = `${buffBase}√ó(${fat.toFixed(1)}+${snf.toFixed(1)})`; 
    }
    
    if (buffFatOp === 'multiply') { 
        buffRate += buffFactor * fat; 
        buffFormula += ` + (‚Çπ${buffFactor}√óFat)`; 
        buffExample += ` + (${buffFactor}√ó${fat.toFixed(1)})`; 
    } else if (buffFatOp === 'add') { 
        buffRate += buffFactor + fat; 
        buffFormula += ` + (‚Çπ${buffFactor}+Fat)`; 
        buffExample += ` + (${buffFactor}+${fat.toFixed(1)})`; 
    } else if (buffFatOp === 'disabled') {
        buffFormula += ` + (Fat: Disabled)`;
    }
    
    if (buffSnfOp === 'multiply') { 
        buffRate += buffSnfFactor * snf; 
        buffFormula += ` + (‚Çπ${buffSnfFactor}√óSNF)`; 
        buffExample += ` + (${buffSnfFactor}√ó${snf.toFixed(1)})`; 
    } else if (buffSnfOp === 'add') { 
        buffRate += buffSnfFactor + snf; 
        buffFormula += ` + (‚Çπ${buffSnfFactor}+SNF)`; 
        buffExample += ` + (${buffSnfFactor}+${snf.toFixed(1)})`; 
    } else if (buffSnfOp === 'disabled') {
        buffFormula += ` + (SNF: Disabled)`;
    }
    
    // Update rate previews
    if (el("cowRatePreview")) el("cowRatePreview").textContent = `${formatAmount(cowRate)}/L`;
    if (el("buffRatePreview")) el("buffRatePreview").textContent = `${formatAmount(buffRate)}/L`;
    
    // Update formula text previews
    if (el("cowFormulaPreview")) el("cowFormulaPreview").textContent = cowFormula;
    if (el("buffFormulaPreview")) el("buffFormulaPreview").textContent = buffFormula;
    
    // Update calculation breakdown with actual values and selected operators
    if (el("cowCalcBreakdown")) el("cowCalcBreakdown").textContent = `Example: ${cowExample} = ${formatAmount(cowRate)}/L`;
    if (el("buffCalcBreakdown")) el("buffCalcBreakdown").textContent = `Example: ${buffExample} = ${formatAmount(buffRate)}/L`;
}

function updateCowFormulaText() {
    const cowBase = Number(el("setCowBase")?.value || 0);
    const cowBaseOp = el("setCowBaseOp")?.value || 'fixed';
    const cowFactor = Number(el("setCowFactor")?.value || 0);
    const cowFatOp = el("setCowFatOp")?.value || 'multiply';
    const cowSnfFactor = Number(el("setCowSnfFactor")?.value || 0);
    const cowSnfOp = el("setCowSnfOp")?.value || 'multiply';
    
    let formula = `‚Çπ${cowBase}`;
    if (cowBaseOp === 'fat') formula = `‚Çπ${cowBase}√óFat`;
    else if (cowBaseOp === 'snf') formula = `‚Çπ${cowBase}√óSNF`;
    else if (cowBaseOp === 'fat_snf') formula = `‚Çπ${cowBase}√ó(Fat+SNF)`;
    
    if (cowFatOp === 'multiply' && cowFatOp !== 'disabled') formula += ` + (‚Çπ${cowFactor}√óFat)`;
    else if (cowFatOp === 'add' && cowFatOp !== 'disabled') formula += ` + (‚Çπ${cowFactor}+Fat)`;
    
    if (cowSnfOp === 'multiply' && cowSnfOp !== 'disabled') formula += ` + (‚Çπ${cowSnfFactor}√óSNF)`;
    else if (cowSnfOp === 'add' && cowSnfOp !== 'disabled') formula += ` + (‚Çπ${cowSnfFactor}+SNF)`;
    
    if (el("cowFormulaPreview")) el("cowFormulaPreview").textContent = formula;
}

function updateBuffFormulaText() {
    const buffBase = Number(el("setBuffBase")?.value || 0);
    const buffBaseOp = el("setBuffBaseOp")?.value || 'fixed';
    const buffFactor = Number(el("setBuffFactor")?.value || 0);
    const buffFatOp = el("setBuffFatOp")?.value || 'multiply';
    const buffSnfFactor = Number(el("setBuffSnfFactor")?.value || 0);
    const buffSnfOp = el("setBuffSnfOp")?.value || 'multiply';
    
    let formula = `‚Çπ${buffBase}`;
    if (buffBaseOp === 'fat') formula = `‚Çπ${buffBase}√óFat`;
    else if (buffBaseOp === 'snf') formula = `‚Çπ${buffBase}√óSNF`;
    else if (buffBaseOp === 'fat_snf') formula = `‚Çπ${buffBase}√ó(Fat+SNF)`;
    
    if (buffFatOp === 'multiply' && buffFatOp !== 'disabled') formula += ` + (‚Çπ${buffFactor}√óFat)`;
    else if (buffFatOp === 'add' && buffFatOp !== 'disabled') formula += ` + (‚Çπ${buffFactor}+Fat)`;
    
    if (buffSnfOp === 'multiply' && buffSnfOp !== 'disabled') formula += ` + (‚Çπ${buffSnfFactor}√óSNF)`;
    else if (buffSnfOp === 'add' && buffSnfOp !== 'disabled') formula += ` + (‚Çπ${buffSnfFactor}+SNF)`;
    
    if (el("buffFormulaPreview")) el("buffFormulaPreview").textContent = formula;
}

// City-wise rate presets (based on common dairy standards)
const cityPresets = {
  mumbai: { cowBase: 20, cowFactor: 7, cowSnfFactor: 3.5, buffBase: 25, buffFactor: 8, buffSnfFactor: 4 },
  pune: { cowBase: 18, cowFactor: 6, cowSnfFactor: 3, buffBase: 22, buffFactor: 7, buffSnfFactor: 3.5 },
  delhi: { cowBase: 22, cowFactor: 8, cowSnfFactor: 4, buffBase: 28, buffFactor: 9, buffSnfFactor: 4.5 },
  bangalore: { cowBase: 19, cowFactor: 6.5, cowSnfFactor: 3.2, buffBase: 24, buffFactor: 7.5, buffSnfFactor: 3.8 },
  chennai: { cowBase: 21, cowFactor: 7.5, cowSnfFactor: 3.8, buffBase: 26, buffFactor: 8.5, buffSnfFactor: 4.2 },
  ahmedabad: { cowBase: 17, cowFactor: 5.5, cowSnfFactor: 2.8, buffBase: 21, buffFactor: 6.5, buffSnfFactor: 3.2 },
  kolkata: { cowBase: 16, cowFactor: 5, cowSnfFactor: 2.5, buffBase: 20, buffFactor: 6, buffSnfFactor: 3 }
};

// Apply preset when user clicks city button
function applyPreset(city) {
  const preset = cityPresets[city];
  if (!preset) return;
  
  // Fill in the values
  if (el("setCowBase")) el("setCowBase").value = preset.cowBase;
  if (el("setCowFactor")) el("setCowFactor").value = preset.cowFactor;
  if (el("setCowSnfFactor")) el("setCowSnfFactor").value = preset.cowSnfFactor;
  if (el("setBuffBase")) el("setBuffBase").value = preset.buffBase;
  if (el("setBuffFactor")) el("setBuffFactor").value = preset.buffFactor;
  if (el("setBuffSnfFactor")) el("setBuffSnfFactor").value = preset.buffSnfFactor;
  
  // Update preview
  updateFormulaPreview();
  
  // Show confirmation
  showToast(`‚úÖ ${city.charAt(0).toUpperCase() + city.slice(1)} rates applied!`);
}

// üéØ ACTIVE RATE UPDATE LOGIC - Simplified
function updateActiveRate() {
    const val = Number(el("newRateInput").value);
    if (val <= 0) {
        showToast("Invalid Rate!");
        return;
    }
    updateRate(val);
}

// Animal Type Toggle Function - Keyboard optimized with VISUAL SELECTION
function selectAnimal(type) {
  // Reset both buttons
  ['animalCow', 'animalBuffalo'].forEach(id => {
    const btn = el(id);
    if (btn) {
      btn.style.borderColor = 'var(--line)';
      btn.style.background = 'white';
      btn.style.boxShadow = 'none';
      btn.style.transform = 'none';
      btn.classList.remove('selected');
    }
  });

  // Set selected
  el("animalSelect").value = type;
  const selectedBtn = el("animal" + type.charAt(0).toUpperCase() + type.slice(1));
  if (selectedBtn) {
    selectedBtn.style.borderColor = '#2563eb';
    selectedBtn.style.background = '#dbeafe';
    selectedBtn.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.2)';
    selectedBtn.classList.add('selected');
  }
  
  // Re-render to update calculations
  renderTrust();
}

// Farmer Form Animal Type Toggle - Keyboard optimized with VISUAL SELECTION
function selectFarmerAnimal(type) {
  // Reset all buttons
  ['fAnimalCow', 'fAnimalBuffalo', 'fAnimalBoth'].forEach(id => {
    const btn = el(id);
    if (btn) {
      btn.style.borderColor = 'var(--line)';
      btn.style.background = 'white';
      btn.style.boxShadow = 'none';
      btn.style.transform = 'none';
    }
  });

  // Set selected
  el("fAnimalType").value = type;
  const selectedBtn = el("fAnimal" + type.charAt(0).toUpperCase() + type.slice(1));
  if (selectedBtn) {
    selectedBtn.style.borderColor = '#2563eb';
    selectedBtn.style.background = '#dbeafe';
    selectedBtn.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.2)';
  }

  // Add Enter key support to move to LIKH LO button
  ['fAnimalCow', 'fAnimalBuffalo', 'fAnimalBoth'].forEach(id => {
    const btn = el(id);
    if (btn) {
      btn.onkeydown = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const likhloBtn = el("btnLikhlo");
          if (likhloBtn) {
            likhloBtn.focus();
          }
        }
      };
    }
  });
}

// Pill par rate dikhane ke liye
function refreshRatePill() {
    if (el("rateDisplay")) {
        const currentRate = formatAmount(Number(settings.cowBase));
        el("rateDisplay").textContent = `Rate: ${currentRate}`;
        console.log('‚úÖ Rate pill updated to:', currentRate);
    }
}

       /***********************
       * RENDER RIGHT PANEL  *
       ***********************/
      function renderRecentToday() {
        const today = fmtDate(new Date());
        let todays = entries
          .filter((e) => e.day === today)
          .sort((a, b) => b.createdAt - a.createdAt);

        // Filter by selected farmer if one is selected
        if (selectedFarmerId) {
          todays = todays.filter(e => e.farmerId === selectedFarmerId);
        }

        recentMeta.textContent = `${todays.length} records`;

        if (todays.length === 0 && (!qty || qty === 0)) {
          recentTbody.innerHTML = `<tr><td colspan="9" style="color:var(--muted);font-weight:1100;">No records recorded today</td></tr>`;
          return;
        }

        // Build rows from saved entries
        const rows = todays
          .slice(0, 25)
          .map((e) => {
            const typeTag =
              e.animal === "buffalo"
                ? `<span class="tag buff">üêÉ Buffalo</span>`
                : `<span class="tag cow">üêÑ Cow</span>`;
            // Photo icon with null check
            const photoIcon = (e.images && Array.isArray(e.images) && e.images.length > 0)
    ? ` <span onclick="viewProof('${e.images[0]}')" style="cursor:pointer;">üì∏</span>`
    : '';
            const f = getFarmerById(e.farmerId);
            const phone = (f && f.phone) ? f.phone : "";

            const msg = `*Milk Receipt* ü•õ\nDate: ${e.day} (${e.session})\nQty: ${e.qty}L | Fat: ${e.fat}\n*Amount: ${formatAmount(e.amount)}*\nGopal Dairy Shop`;
            const wpLink = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;

            return `
  <tr onclick="showAuditProof('${e.id}')" style="cursor:pointer;">
    <td>${escapeHtml(e.day)}</td>
    <td style="font-weight:1100;">
        ${escapeHtml(e.farmerName || "")}
        ${photoIcon} ${e.edited ? `<br><small class="edit-note" style="color:var(--muted); font-weight:normal; font-size:10px;">‚úèÔ∏è Sudhara gaya: ${fmtTime(new Date(e.edited))}</small>` : ''}
    </td>
    <td><span class="rtag">${escapeHtml(e.session || "")}</span></td>
    <td>${typeTag}</td>
    <td style="font-weight:1100;">${Number(e.qty || 0).toFixed(1)} L</td>
    <td>${Number(e.fat || 0).toFixed(1)}%</td>
    <td>${Number(e.snf || 0).toFixed(1)}</td>
    <td style="color:var(--muted); font-size:11px;">
        ${formatAmount(e.rateSnapshot || e.ratePerL || 0)}
    </td>
    <td style="font-weight:1200; color:#1d4ed8; display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
        ${formatAmount(e.amount || 0)}
        <button onclick="event.stopPropagation(); editEntry('${e.id}')" title="Edit" style="border:none; background:transparent; cursor:pointer; font-size:14px;">‚úèÔ∏è</button>
        ${phone ? `<a href="${wpLink}" target="_blank" onclick="event.stopPropagation();" title="Send WhatsApp" style="text-decoration:none; font-size:16px;">üü¢</a>` : ''}
    </td>
    <td style="text-align: center;" title="Retail entry. Source & quality verification not recorded.">‚ùå Retail</td>
  </tr>
`;
          })
          .join("");

        // Add LIVE PREVIEW row for current entry being calculated
        const farmer = getFarmerById(selectedFarmerId);
        if (farmer && qty > 0) {
          const r = getRatePerLiter();
          const a = getAmount();
          const session = autoSessionLabel();
          const typeTag = animal === "buffalo" 
            ? `<span class="tag buff">üêÉ Buffalo</span>` 
            : `<span class="tag cow">üêÑ Cow</span>`;
          
          const previewRow = `
  <tr style="background: #f0f9ff; border: 2px solid #3b82f6;">
    <td>${today}</td>
    <td style="font-weight:1100; color: #1d4ed8;">
        ${escapeHtml(farmer.name || "")}
        <br><small style="color: #3b82f6; font-weight: normal;">üî¥ LIVE (not saved yet)</small>
    </td>
    <td><span class="rtag">${escapeHtml(session || "")}</span></td>
    <td>${typeTag}</td>
    <td style="font-weight:1100;">${round2(qty).toFixed(1)} L</td>
    <td>${round2(fat).toFixed(1)}%</td>
    <td>${round2(snf).toFixed(1)}</td>
    <td style="color:var(--muted); font-size:11px;">
        ${formatAmount(r)}
    </td>
    <td style="font-weight:1200; color:#1d4ed8; display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
        ${formatAmount(a)}
        <span style="font-size:16px;">‚è≥</span>
    </td>
    <td style="text-align: center; color: #3b82f6; font-weight: 700;">üî¥ LIVE</td>
  </tr>
`;
          recentTbody.innerHTML = previewRow + rows;
        } else {
          recentTbody.innerHTML = rows;
        }

        // Update inline quantities
        updateInlineQuantities();

        // Update today's collection summary (Kitna Collection)
        updateTodayCollection();
      }

      // Update today's collection summary
      function updateTodayCollection() {
        const today = fmtDate(new Date());
        const todays = entries.filter(e => e.day === today);
        
        const totalMilk = todays.reduce((sum, e) => sum + Number(e.qty || 0), 0);
        const totalAmount = todays.reduce((sum, e) => sum + Number(e.amount || 0), 0);
        
        if (el("todayMilk")) el("todayMilk").textContent = totalMilk.toFixed(1);
        if (el("todayAmount")) el("todayAmount").textContent = formatAmount(totalAmount);
        if (el("todayEntries")) el("todayEntries").textContent = todays.length;
      }
      
      // Update inline cow/buff quantities for today
      function updateInlineQuantities() {
        const today = fmtDate(new Date());
        const todays = entries.filter(e => e.day === today && e.farmerId === selectedFarmerId);
        
        let cowQty = 0;
        let buffQty = 0;
        
        todays.forEach(e => {
          if (e.animal === 'cow') {
            cowQty += Number(e.qty || 0);
          } else if (e.animal === 'buffalo') {
            buffQty += Number(e.qty || 0);
          }
        });
        
        if (el('cowQtyInline')) el('cowQtyInline').textContent = cowQty.toFixed(1);
        if (el('buffQtyInline')) el('buffQtyInline').textContent = buffQty.toFixed(1);
      }
      function viewProof(imgData) {
    if(!imgData) return;
    const w = window.open("");
    w.document.write(`<img src="${imgData}" style="max-width:100%;">`);
}

      function editEntry(id) {
    const entry = entries.find(e => e.id === id);
    if (!entry) return;

    // 1. Confirm karein (Trust Safe)
    if (!confirm("Do you want to edit this entry? It will update farmer balance.")) return;

    // 2. Pehle purani entry ka asar khatam karein (Balance reverse)
    const farmer = getFarmerById(entry.farmerId);
    if (farmer) {
        farmer.balance = round2(farmer.balance - entry.amount);
    }

    // 3. Data ko wapas form mein load karein
    selectedFarmerId = entry.farmerId;
    qty = entry.qty;
    fat = entry.fat;
    snf = entry.snf;
    animal = entry.animal;
    
    // 4. Entry ko mark karein taaki save hone par naya record na bane, purana update ho
    // (Simple rasta: purani entry delete karke naya form bhardein)
    entries = entries.filter(e => e.id !== id);
    saveEntries(entries);
    saveFarmers(farmers);

    renderAll();
    showToast("Editing: " + entry.farmerName + " ‚úèÔ∏è");
    el("qtyInput").focus();
}

      // Load farmer memory (previous values) - ONLY if user hasn't entered new values
      function loadFarmerMemory(farmerId) {
        if (!farmerId) return;

        const memory = JSON.parse(localStorage.getItem('mr_farmer_memory') || '{}');
        const farmerMemory = memory[farmerId];

        // Get last entry for this farmer to auto-fill liters
        const today = fmtDate(new Date());
        const farmerEntries = entries.filter(e => e.farmerId === farmerId && e.day === today).sort((a, b) => b.createdAt - a.createdAt);
        const lastEntry = farmerEntries.length > 0 ? farmerEntries[0] : null;

        if (farmerMemory) {
          // Only restore if inputs are empty/zero (user hasn't typed yet)
          const qtyEmpty = !qtyInput.value || qtyInput.value === '0' || qtyInput.value === '';
          const fatEmpty = !fatInput.value || fatInput.value === '0' || fatInput.value === '';
          const snfEmpty = !snfInput.value || snfInput.value === '0' || snfInput.value === '';

          // Auto-fill last entry's liters if available and qty is empty
          if (lastEntry && qtyEmpty) {
            qty = Number(lastEntry.qty) || 0;
            if (qtyInput) qtyInput.value = qty.toFixed(1);
            console.log('‚úÖ Auto-filled liters from last entry:', qty);
          }

          // Auto-fill previous values ONLY if fields are empty
          if (farmerMemory.animal && qtyEmpty) animal = farmerMemory.animal;

          if (farmerMemory.fat && fatEmpty) {
            fat = farmerMemory.fat;
            if (fatInput) fatInput.value = fat.toFixed(1);
          }

          if (farmerMemory.snf && snfEmpty) {
            snf = farmerMemory.snf;
            if (snfInput) snfInput.value = snf.toFixed(1);
          }

          if (farmerMemory.rate && manualRateInput && !manualRateInput.value) {
            manualRateInput.value = farmerMemory.rate;
          }

          console.log('‚úÖ Loaded farmer memory:', farmerMemory, '(only if fields were empty)');
        }
      }
      
      // Save farmer memory - ONLY save non-zero values that user explicitly entered
      function saveFarmerMemory(farmerId) {
        if (!farmerId) return;

        const memory = JSON.parse(localStorage.getItem('mr_farmer_memory') || '{}');

        // Only save if user entered meaningful values (not zero/empty)
        memory[farmerId] = {
          animal: animal || 'cow',
          fat: fat > 0 ? fat : 0,
          snf: snf > 0 ? snf : 0,
          rate: manualRateInput && manualRateInput.value ? Number(manualRateInput.value) : 0,
          lastUpdated: Date.now()
        };

        localStorage.setItem('mr_farmer_memory', JSON.stringify(memory));
        console.log('üíæ Saved farmer memory for', farmerId);
      }

      function renderTrust() {
    console.log('üîµ renderTrust() called, qty:', qty, 'fat:', fat, 'snf:', snf, 'selectedFarmerId:', selectedFarmerId);

    const farmer = getFarmerById(selectedFarmerId);
    console.log('üîµ Farmer:', farmer ? farmer.name : 'none selected', 'Farmers in array:', farmers.length);
    
    // ‚úÖ AUTO SELECT LOGIC:
    if (farmer && farmer.animalType) {
      if (farmer.animalType !== "both") {
        animal = farmer.animalType; // Cow ya Buffalo fix ho jayega
      }
      // Note: Agar 'both' hai toh purana selection hi rahega
    }

    // --- Update farmer name display ---
    const selectedNameEl = el("selectedName");
    if (selectedNameEl) {
      if (farmer) {
        const stdSNF = 8.5;
        const typeIcon = farmer.animalType === 'cow' ? 'üêÑ' : 'üêÉ';
        const typeText = farmer.animalType === 'both' ? 'üîÑ Both' : (farmer.animalType === 'cow' ? 'Cow' : 'Buffalo');
        let nameHTML = `${farmer.name} <small style="color:var(--muted)">(${typeIcon} ${typeText})</small>`;

        if (snf > 0 && snf < stdSNF) {
          const waterPercent = round2(((stdSNF - snf) / stdSNF) * 100);
          nameHTML += `<br><span style="color:red; font-size:11px; font-weight:bold;">‚ö†Ô∏è Pani: ${waterPercent}%</span>`;
        }
        selectedNameEl.innerHTML = nameHTML;
        console.log('‚úÖ selectedName updated:', farmer.name);
      } else {
        selectedNameEl.textContent = "‚Äî";
        console.log('‚úÖ selectedName cleared (no farmer)');
      }
    } else {
      console.error('‚ùå selectedName element not found!');
    }

    // Calculate rate and amount
    const r = getRatePerLiter();
    const a = getAmount();
    
    console.log('üîµ Rate:', r, 'Amount:', a, 'qty:', qty);

    // Update rate view (hidden element)
    if (rateView) {
      rateView.textContent = formatAmount(r);
    }
    
    // Update TOTAL AMOUNT display - THIS IS THE KEY ONE!
    const amountViewEl = document.getElementById("amountView");
    if (amountViewEl) {
      const formatted = formatAmount(a);
      amountViewEl.textContent = formatted;
      console.log('‚úÖ‚úÖ‚úÖ amountView UPDATED to:', formatted);
    } else {
      console.error('‚ùå‚ùå‚ùå amountView element NOT FOUND in DOM!');
    }

    // Update summary calculation text with full formula breakdown
    const summaryCalcText = el("summaryCalcText");
    if (summaryCalcText) {
      // Show: Qty √ó Rate (F: X% | S: Y%) = Amount
      const calcText = `${round2(qty).toFixed(1)}L √ó ${formatAmount(r)}/L (F: ${fat.toFixed(1)}% | S: ${snf.toFixed(1)}%)`;
      summaryCalcText.textContent = calcText;
      summaryCalcText.title = `Formula: ${settings.cowBase} + (${settings.cowFactor}√ó${fat.toFixed(1)}) + (${settings.cowSnfFactor}√ó${snf.toFixed(1)}) = ${formatAmount(r)}/L`;
      console.log('‚úÖ summaryCalcText updated:', calcText);
    } else {
      console.error('‚ùå summaryCalcText element not found!');
    }

    // Update inline cow/buff quantities
    updateInlineQuantities();

    // Update balances
    const before = farmer ? farmerBalanceBefore(farmer) : 0;
    const after = round2(before + a);

    const balBeforeEl = document.getElementById("balBefore");
    if (balBeforeEl) {
      balBeforeEl.textContent = formatAmount(before);
    }
    
    const balAfterEl = document.getElementById("balAfter");
    if (balAfterEl) {
      balAfterEl.textContent = formatAmount(after);
      if (after > 10000) {
        balAfterEl.innerHTML = `${balAfterEl.textContent} <span style="color: #f59e0b;" title="Large outstanding balance">‚ö†Ô∏è</span>`;
      }
    }

    // steps + values
    if (el("qtyStep")) el("qtyStep").textContent = `¬±${settings.qtyStep}`;
    if (el("fatStep")) el("fatStep").textContent = `¬±${settings.fatStep}`;
    if (el("snfStep")) el("snfStep").textContent = `¬±${settings.snfStep}`;

    // Density Sync (Agar density dabba add kiya hai toh ye line add karein)
    if (el("densityInput") && document.activeElement !== el("densityInput")) {
        el("densityInput").value = clr;
    }

    // animal dropdown sync
    animalSelect.value = animal;

    // Manual rate UI - always visible, pre-fill with current rate
    if (!manualRate || manualRate === 0) {
        rateTypeLabel.textContent = "Rate: Auto";
        // Auto mode: Pre-fill with current base rate
        if (manualRateInput) {
            const currentRate = settings.cowBase ? Number(settings.cowBase).toFixed(2) : "0.00";
            manualRateInput.value = currentRate;
            manualRateInput.placeholder = `Auto: ‚Çπ${currentRate}`;
        }
    } else {
        rateTypeLabel.textContent = "Rate: Manual";
        // Manual mode: Show user's entered value
        if (manualRateInput) {
            const manualVal = manualRate.toFixed(2);
            manualRateInput.value = manualVal;
            manualRateInput.placeholder = `Manual: ‚Çπ${manualVal}`;
        }
    }

    // Load saved final amount for this farmer
    loadFinalAmount();

    // HOLD badge
    const hold = loadHold();
    holdBadge.textContent = hold ? "ADVANCE ‚úÖ" : "";

    // recent today - with LIVE PREVIEW
    renderRecentToday();

    syncInputs();
    updateDailySummaryButton();
}

      function renderTodayLabel() {
        const d = new Date();
        el("todayLabel").textContent = `${fmtDate(d)} ‚Ä¢ ${autoSessionLabel()}`;
      }

      function renderAll() {
        ensureSelectedFarmer();
        renderFarmers();
        renderTrust();
        renderTodayLabel();
      }

      /***********************
       * HOLD + UNDO         *
       ***********************/
      function loadHold() {
        try {
          return JSON.parse(localStorage.getItem(LS.hold) || "null");
        } catch (e) {
          return null;
        }
      }
      function saveHold(obj) {
        if (!obj) localStorage.removeItem(LS.hold);
        else localStorage.setItem(LS.hold, JSON.stringify(obj));
      }

      function saveUndoToken(token) {
        localStorage.setItem(LS.lastUndo, JSON.stringify(token));
      }
      function loadUndoToken() {
        try {
          return JSON.parse(localStorage.getItem(LS.lastUndo) || "null");
        } catch (e) {
          return null;
        }
      }
      function clearUndoToken() {
        localStorage.removeItem(LS.lastUndo);
      }
      // Rate Chart kholne ka logic - REGENERATE every time
function openRateTable() {
    console.log('üîµ Opening rate table, base rate:', settings.cowBase);
    
    const base = Number(settings.cowBase);
    el("chartBaseRate").textContent = base.toFixed(2);
    const tbody = el("rateTableBody");
    tbody.innerHTML = "";

    // FAT 4.0 se 9.0 tak ki list (0.1 ke gap par)
    for (let f = 4.0; f <= 9.0; f = round2(f + 0.1)) {
        const r = getAutoRatePerLiter(f, "cow"); // Default Cow rate dikhate hain chart mein
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td style="padding: 8px; border: 1px solid #f1f5f9; font-weight: bold;">${f.toFixed(1)}%</td>
            <td style="padding: 8px; border: 1px solid #f1f5f9; color: var(--blue2); font-weight: 1000;">${formatAmount(r)}</td>
        `;
        tbody.appendChild(tr);
    }
    
    console.log('‚úÖ Rate table populated with', tbody.children.length, 'rows');
    openOverlay('overlayRateEditor');
}

function closeRateTable() {
    closeOverlay('overlayRateEditor');
}

// Edit rate from chart modal
function editRateFromChart() {
    const currentRate = Number(settings.cowBase);
    const newRate = prompt(`Enter new base rate (‚Çπ/L):\nCurrent: ‚Çπ${currentRate.toFixed(2)}`, currentRate.toFixed(2));
    
    if (newRate !== null && newRate !== '') {
        const val = Number(newRate);
        if (val > 0) {
            updateRate(val);
        } else {
            showToast("Invalid rate!");
        }
    }
}

// Update rate function - REAL-TIME UPDATE EVERYWHERE
function updateRate(val) {
    console.log('üîµ Updating rate to:', val);

    settings.cowBase = val;
    settings.buffBase = val + 5;

    console.log('üîµ Settings updated:', settings.cowBase, settings.buffBase);
    saveSettings(settings);

    // REAL-TIME UPDATE EVERYWHERE
    refreshRatePill();           // Update rate pill in header
    renderTrust();               // Update right panel (amount, rate, balances)
    renderAll();                 // Re-render all farmers and UI
    
    // Regenerate rate table with new rates
    openRateTable();
    
    // Update formula previews
    updateFormulaPreview();
    updateLivePreview();

    showToast(`‚úÖ Rate updated: ${formatAmount(val)} - Applied everywhere!`);
    console.log('‚úÖ Rate updated successfully, all UI refreshed');
}

// üéØ WHATSAPP PLAIN TEXT LOGIC
function sendRateChartWhatsApp() {
    const base = Number(settings.cowBase);
    let msg = `*ü•õ ‡§Ü‡§ú ‡§ï‡•Ä ‡§∞‡•á‡§ü ‡§≤‡§ø‡§∏‡•ç‡§ü - ‡§ó‡•ã‡§™‡§æ‡§≤ ‡§°‡•á‡§Ø‡§∞‡•Ä*\n`;
    msg += `Base Rate: ‚Çπ${base.toFixed(2)}\n`;
    msg += `---------------------------\n`;
    msg += `*FAT%* |   *RATE (‚Çπ/L)*\n`;
    msg += `---------------------------\n`;

    // Sirf main points bhejte hain taaki message zyada lamba na ho
    for (let f = 4.0; f <= 8.5; f = round2(f + 0.5)) {
        const r = getAutoRatePerLiter(f, "cow");
        msg += `${f.toFixed(1)} fat   ->   ${formatAmount(r)}\n`;
    }

    msg += `---------------------------\n`;
    msg += `*‡§Ø‡§π ‡§∞‡•á‡§ü ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§ú‡§®‡§∞‡•á‡§ü‡•á‡§° ‡§π‡•à*`;

    const wpUrl = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(wpUrl, '_blank');
}
      function holdCurrent() {
        // Open farmer advance management directly
        if (selectedFarmerId) {
          openFarmerTransactions(selectedFarmerId);
          showToast("üí≥ Opening Advance Management");
        } else {
          showToast("‚ö†Ô∏è Select farmer first");
        }
      }

      function restoreHoldIfAny() {
        const h = loadHold();
        if (!h) return;
        selectedFarmerId = h.selectedFarmerId || selectedFarmerId;
        qty = Number(h.qty) || 0;
        fat = Number(h.fat) || 0;
        snf = Number(h.snf) || 0;
        animal = h.animal || "cow";
        rateMode = h.rateMode || "auto";
        manualRate = Number(h.manualRate) || 0;
        manualRateInput.value = manualRate ? String(manualRate) : "";
        saveHold(null);
        showToast("üí≥ Advance restored");
        renderAll();
      }

      /***********************
       * SAVE ENTRY          *
       ***********************/
      function canSave() {
        if (!selectedFarmerId) return false;
        if (qty <= 0) return false;
        if (fat <= 0) return false;
        if (getRatePerLiter() <= 0) return false;
        return true;
      }
      // Point 2.6: Success Sound Feedback (No external file needed)
function playSuccessSound() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.type = 'sine'; 
    oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime); 
    gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.15);
}
      let isSaving = false; // Prevent double-save
      function saveEntry() {
    if (isSaving) {
        showToast("Already saving...");
        return;
    }
    if (!canSave()) {
        showToast("Need: Farmer + Qty + Fat");
        return;
    }
    const farmer = getFarmerById(selectedFarmerId);
    if (!farmer) {
        showToast("Select farmer");
        return;
    }

    isSaving = true; // Lock save

    const before = farmerBalanceBefore(farmer);
    const ratePerL = getRatePerLiter();
    const amount = getAmount();

    // Check if final amount is set by user
    const finalAmountInput = el("finalAmountInput");
    let finalAmount = null;
    if (finalAmountInput && finalAmountInput.value) {
      finalAmount = parseFloat(finalAmountInput.value);
    }

    // Get the ROUNDED balance from UI (final accepted amount)
    const balAfterEl = el("balAfter");
    const afterDisplay = finalAmount !== null ? finalAmount : (balAfterEl ? parseFloat(balAfterEl.textContent.replace('‚Çπ', '')) : round2(before + amount));
    const after = round2(afterDisplay);

    // Calculate if there's a discount (rounded down) or extra (rounded up)
    const calculatedAfter = round2(before + amount);
    const difference = after - calculatedAfter;

    // --- ‚úÖ POINT 3.4: GET PAYMENT MODE FROM VARIABLE ---
    const selectedPayMode = paymentMode;

    const currentRate = getRatePerLiter(); // üëà Usi second ka active rate uthao
    const currentAmount = getAmount();
    
    console.log('üíæ Saving entry:', {
        qty, fat, snf,
        rate: currentRate,
        amount: currentAmount,
        farmer: farmer.name
    });

    const entry = {
        id: uid("e"),
        farmerId: farmer.id,
        farmerName: farmer.name || "",
        qty: round2(qty),
        fat: round2(fat),
        snf: round2(snf),
        paymentMode: selectedPayMode,

        // üéØ SNAPSHOT LOGIC: Rate ko value ki tarah chipka do
        rateSnapshot: round2(currentRate),
        amount: round2(currentAmount),

        // Cash entries are settled (milk + cash received)
        // Mark as cancelled/settled for clarity
        isSettled: selectedPayMode === 'Cash',

        // Discount/Adjustment if rounded amount differs
        adjustment: difference !== 0 ? round2(difference) : undefined,

        // Audit Metadata
        rateMode: rateMode, // auto ya manual
        animal: animal,
        session: autoSessionLabel(),
        createdAt: Date.now(),
        day: fmtDate(new Date()),
        deviceId: navigator.userAgent.slice(0, 40)
    };
    // --- DATA SAVING ---
    // Only update balance for Credit/Udhar entries
    // Cash entries: Milk received + Cash received = Settled (no balance change)
    // Credit entries: Milk received + Payment pending = Balance updated
    if (selectedPayMode === 'Credit') {
        farmer.balance = after; // Update balance for credit
    }
    // For Cash: Don't update balance (transaction complete)
    saveFarmers(farmers);

    entries.push(entry);
    saveEntries(entries);
    
    // Save to backend if API mode is enabled
    if (window.USE_API && window.MilkRecordAPI) {
      window.MilkRecordAPI.milkEntries.create({
        farmer_id: farmer.id,
        day: entry.day,
        session: entry.session,
        animal: entry.animal,
        quantity: entry.qty,
        fat: entry.fat,
        snf: entry.snf,
        rate_per_l: entry.rateSnapshot,
        amount: entry.amount,
        reading_mode: 'manual',
        images: entry.images || []
      }).catch(error => {
        console.error('Failed to save to backend:', error);
      });
    }
    
    playSuccessSound();
    saveUndoToken({
        entryId: entry.id,
        farmerId: farmer.id,
        prevBalance: before,
    });

    // --- ‚úÖ RESET LOGIC FOR NEXT FARMER ---
    // Save farmer memory BEFORE reset
    saveFarmerMemory(farmer.id);

    qty = 0;
    fat = 0;
    snf = 0;
    manualRate = 0;
    if (el("manualRateInput")) el("manualRateInput").value = "";
    
    // Clear final amount input
    if (el("finalAmountInput")) el("finalAmountInput").value = "";

    // Toggle ko wapas 'Cash' (‡§Ü‡§ú ‡§®‡§ï‡§¶) par le aao
    const cashRadio = document.querySelector('input[name="payMode"][value="Cash"]');
    if (cashRadio) {
      cashRadio.checked = true;
      if (typeof updatePayUI === "function") updatePayUI();
    }

    currentEntryImage = null; 
    const imgInput = document.getElementById("fImageEntry");
    if(imgInput) imgInput.value = ""; 
    
    autoNextFarmer();
    renderAll();
    playSuccessSound(); // üîä Ye bajega har save par
    // --- ‚úÖ FEEDBACK ---
    if (typeof playSuccessSound === "function") playSuccessSound(); // üîä Ting!
    
    document.body.classList.add("flash-success");
    setTimeout(() => {
        document.body.classList.remove("flash-success");
    }, 600);

    // Snapshot update (‡§Ü‡§ú ‡§ï‡§æ ‡§π‡§ø‡§∏‡§æ‡§¨)
    if (typeof updateSnapshotData === "function") updateSnapshotData();

    updateDailySummaryButton();
    updateTodayCollection(); // Update Kitna Collection

    // Print bill/receipt after save (MANDATORY)
    printCollectionBill(entry);

    // Send WhatsApp after save (MANDATORY for paid entries)
    if (selectedPayMode === 'Cash' || selectedPayMode === 'UPI' || selectedPayMode === 'Account') {
        setTimeout(() => {
            sendEntryWhatsApp(entry);
        }, 500);
    }

    // Show feedback toast based on payment mode
    if (selectedPayMode === 'Cash') {
        showToast(`üíµ Cash ‚Çπ${formatAmount(a)} mil gaya! Settled ‚úÖ`);
    } else if (selectedPayMode === 'Credit') {
        showToast(`üìí Udhar ‚Çπ${formatAmount(a)} likh lia! Balance: ‚Çπ${formatAmount(after)}`);
    } else {
        showToast(`Entry Saved: ${formatAmount(a)} (${selectedPayMode === 'Cash' ? '‡§®‡§ï‡§¶' : '‡§â‡§ß‡§æ‡§∞'}) ‚úÖ`);
    }

    isSaving = false; // Unlock save
}

// Send entry via WhatsApp
function sendEntryWhatsApp(entry) {
    const f = getFarmerById(entry.farmerId);
    if (!f || !f.phone) return;

    let msg = `*ü•õ Milk Collection Receipt*\n`;
    msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    msg += `Farmer: ${entry.farmerName}\n`;
    if (f.serial) msg += `Serial: #${f.serial}\n`;
    if (entry.id) msg += `Entry ID: #${entry.id.slice(-6).toUpperCase()}\n`;
    if (f.phone) msg += `Phone: ${f.phone}\n`;
    msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    msg += `Qty: ${entry.qty}L | Fat: ${entry.fat}%\n`;
    if (entry.snf) msg += `SNF: ${entry.snf}\n`;
    msg += `Rate: ${formatAmount(entry.rateSnapshot)}/L\n`;
    msg += `*Amount: ${formatAmount(entry.amount)}*\n`;
    msg += `Payment: ${entry.paymentMode === 'Cash' ? 'üíµ Cash' : entry.paymentMode === 'UPI' ? 'üì± UPI' : entry.paymentMode === 'Account' ? 'üè¶ Account' : 'üìí Credit'}\n`;
    msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    msg += `Date: ${new Date(entry.createdAt).toLocaleString()}\n`;
    
    // Add transaction ID request for paid entries
    if (entry.paymentMode === 'Cash' || entry.paymentMode === 'UPI' || entry.paymentMode === 'Account') {
        msg += `\nüì± *Please send txn ID / pic of txn received*\n`;
    }
    
    msg += `\nüôè Thank you!\nGopal Dairy Shop`;

    const wpUrl = `https://wa.me/91${f.phone.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`;
    window.open(wpUrl, '_blank');
}

// Save entry as CREDIT (‡§â‡§ß‡§æ‡§∞) - for Likh Lo button
function saveEntryAsCredit() {
    const farmer = getFarmerById(selectedFarmerId);
    if (!farmer) {
        showToast("‚ö†Ô∏è Select farmer");
        return;
    }

    const before = farmerBalanceBefore(farmer);
    const ratePerL = getRatePerLiter();
    const amount = getAmount();

    // Check for duplicate recent LIKH LO entry (same farmer, same amount, within 5 minutes)
    const now = Date.now();
    const recentCredit = entries.find(e => 
        e.farmerId === farmer.id && 
        e.paymentMode === 'Credit' && 
        Math.abs(e.amount - amount) < 0.01 &&
        (now - e.createdAt) < 300000 // 5 minutes
    );

    if (recentCredit) {
        const recentTime = new Date(recentCredit.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const confirmSave = confirm(
            `‚ö†Ô∏è Similar LIKH LO entry found!\n\n` +
            `üìí Udhar ‚Çπ${amount} was recorded at ${recentTime}\n` +
            `Farmer: ${farmer.name}\n\n` +
            `Click OK to save again, or Cancel to skip.`
        );
        if (!confirmSave) {
            showToast("‚ö†Ô∏è Duplicate entry skipped");
            return;
        }
    }

    const entry = {
        id: uid("e"),
        farmerId: farmer.id,
        farmerName: farmer.name || "",
        qty: round2(qty),
        fat: round2(fat),
        snf: round2(snf),
        paymentMode: 'Credit',

        // üéØ SNAPSHOT LOGIC: Rate ko value ki tarah chipka do
        rateSnapshot: round2(ratePerL),
        amount: round2(amount),
        creditAmount: round2(amount),

        // Audit Metadata
        rateMode: rateMode,
        animal: animal,
        session: autoSessionLabel(),
        createdAt: Date.now(),
        day: fmtDate(new Date()),
        deviceId: navigator.userAgent.slice(0, 40)
    };

    // Add to balance as udhar
    farmer.balance = round2(before + amount);
    saveFarmers(farmers);

    entries.push(entry);
    saveEntries(entries);

    // ALSO save to sales history for Customer Ledger
    const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
    const saleRecord = {
        id: entry.id,
        date: entry.day,
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        customer: farmer.name,
        products: `${entry.qty}L Milk (Fat: ${entry.fat}%)`,
        amount: entry.amount.toString(),
        paidAmount: '0.00',
        creditAmount: entry.creditAmount.toString(),
        method: 'Credit',
        cartItems: [{name: 'Milk', qty: entry.qty, rate: entry.rateSnapshot}],
        createdAt: entry.createdAt
    };
    history.push(saleRecord);
    localStorage.setItem('mr_sales_history', JSON.stringify(history));

    playSuccessSound();
    saveUndoToken({
        entryId: entry.id,
        farmerId: farmer.id,
        prevBalance: before,
    });

    // Reset for next entry
    saveFarmerMemory(farmer.id);
    qty = 0;
    fat = 0;
    snf = 0;
    manualRate = 0;
    if (el("manualRateInput")) el("manualRateInput").value = "";

    autoNextFarmer();
    renderAll();

    document.body.classList.add("flash-success");
    setTimeout(() => {
        document.body.classList.remove("flash-success");
    }, 600);

    updateDailySummaryButton();
    updateTodayCollection();

    // Print bill/receipt after save
    printCollectionBill(entry);
}

// Print collection bill/receipt - NON-BLOCKING for uninterrupted workflow
function printCollectionBill(entry) {
    const farmer = getFarmerById(entry.farmerId);
    if (!farmer) return;

    const date = new Date().toLocaleString('en-IN');

    // Format amount with Indian numbering
    const formatAmt = (num) => {
        const rounded = Math.round((num + Number.EPSILON) * 100) / 100;
        const parts = rounded.toFixed(2).split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{2})+(?!\d)(?=(\d{3})))/g, ',');
        return '‚Çπ' + parts.join('.');
    };

    const shopName = localStorage.getItem('MilkRecord_shop_name') || 'Gopal Dairy Shop';
    const shopUPI = localStorage.getItem('MilkRecord_shop_upi') || '';
    const shopBankName = localStorage.getItem('MilkRecord_shop_bank') || '';
    const shopAccountNo = localStorage.getItem('MilkRecord_shop_account') || '';
    const shopIFSC = localStorage.getItem('MilkRecord_shop_ifsc') || '';

    const billHTML = `
<!DOCTYPE html>
<html>
<head>
    <title>Milk Collection Bill - ${farmer.name}</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .bill { max-width: 400px; margin: 0 auto; border: 2px solid #000; padding: 20px; }
        .header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 15px; }
        .header h2 { margin: 5px 0; }
        .row { display: flex; justify-content: space-between; padding: 5px 0; }
        .row.bold { font-weight: bold; }
        .total { border-top: 2px dashed #000; margin-top: 10px; padding-top: 10px; }
        .footer { text-align: center; margin-top: 20px; font-size: 12px; color: #666; }
        @media print {
            body { padding: 0; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="bill">
        <div class="header">
            <h2>ü•õ Milk Collection Bill</h2>
            <p>${shopName}</p>
            <p>${date}</p>
        </div>

        <div class="row">
            <span>Farmer:</span>
            <span class="bold">${farmer.name}</span>
        </div>
        ${farmer.serial ? `<div class="row"><span>Serial:</span><span class="bold">#${farmer.serial}</span></div>` : ''}
        ${entry.id ? `<div class="row"><span>Entry ID:</span><span class="bold">#${entry.id.slice(-6).toUpperCase()}</span></div>` : ''}
        ${farmer.phone ? `<div class="row"><span>Phone:</span><span class="bold">${farmer.phone}</span></div>` : ''}
        ${farmer.address ? `<div class="row"><span>Address:</span><span class="bold">${farmer.address}</span></div>` : ''}
        ${farmer.city ? `<div class="row"><span>City:</span><span class="bold">${farmer.city}${farmer.pincode ? ' - ' + farmer.pincode : ''}</span></div>` : ''}

        <div style="border-top: 1px dashed #000; margin: 10px 0;"></div>

        <div class="row">
            <span>Quantity:</span>
            <span class="bold">${entry.qty} L</span>
        </div>
        <div class="row">
            <span>Fat:</span>
            <span class="bold">${entry.fat}%</span>
        </div>
        ${entry.snf ? `<div class="row"><span>SNF:</span><span class="bold">${entry.snf}%</span></div>` : ''}
        <div class="row">
            <span>Animal:</span>
            <span class="bold">${entry.animal === 'cow' ? 'üêÑ Cow' : 'üêÉ Buffalo'}</span>
        </div>
        <div class="row">
            <span>Rate:</span>
            <span class="bold">${formatAmt(entry.rateSnapshot || 0)}/L</span>
        </div>

        <div class="row total bold">
            <span>TOTAL AMOUNT:</span>
            <span>${formatAmt(entry.amount || 0)}</span>
        </div>

        <div class="row">
            <span>Payment:</span>
            <span class="bold">
${entry.paymentMode === 'Cash' ? 'üíµ Cash' : entry.paymentMode === 'UPI' ? 'üì± UPI' : entry.paymentMode === 'Account' ? 'üè¶ Account' : 'üìí Credit'}
</span>
        </div>
        ${entry.paymentMode === 'Credit' ? `
        <div class="row">
            <span>Previous Balance:</span>
            <span class="bold">${formatAmt((farmer.balance || 0) - (entry.amount || 0))}</span>
        </div>
        <div class="row bold" style="background: #fef3c7; padding: 8px; margin-top: 5px;">
            <span>NEW BALANCE:</span>
            <span>${formatAmt(farmer.balance || 0)}</span>
        </div>
        ` : `
        <div class="row bold" style="background: #f0fdf4; padding: 8px; margin-top: 5px;">
            <span>STATUS:</span>
            <span style="color: #16a34a;">‚úÖ Settled / Paid</span>
        </div>
        `}

        ${shopUPI || shopBankName ? `
        <div style="margin-top: 15px; padding: 12px; background: #eff6ff; border: 2px dashed #3b82f6; border-radius: 8px;">
            <div style="font-weight: 700; color: #1e40af; margin-bottom: 8px; font-size: 13px;">üí≥ Payment Details (For UPI/Account)</div>
            ${shopUPI ? `<div style="font-size: 12px; color: #1e40af;"><strong>üì± UPI ID:</strong> ${shopUPI}</div>` : ''}
            ${shopBankName ? `<div style="font-size: 12px; color: #1e40af;"><strong>üè¶ Bank:</strong> ${shopBankName}</div>` : ''}
            ${shopAccountNo ? `<div style="font-size: 12px; color: #1e40af;"><strong>üî¢ Account:</strong> ${shopAccountNo}</div>` : ''}
            ${shopIFSC ? `<div style="font-size: 12px; color: #1e40af;"><strong>üîë IFSC:</strong> ${shopIFSC}</div>` : ''}
        </div>
        ` : ''}

        <div class="footer">
            <p>Thank you for your business!</p>
            <p>${shopName}</p>
        </div>

        <button class="no-print" onclick="window.print();" style="width: 100%; padding: 10px; background: #16a34a; color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; margin-top: 15px;">üñ®Ô∏è Print Bill (Ctrl+P)</button>
    </div>

    <scr` + `ipt>
        // Auto-print after short delay (NON-BLOCKING - user can continue working)
        setTimeout(() => {
            window.print();
            // Don't auto-close - user controls when to close
        }, 100);
    </scr` + `ipt>
</body>
</html>`;

    // Open in background tab (NON-BLOCKING)
    const printWindow = window.open('', '_blank');
    if (printWindow) {
        printWindow.document.write(billHTML);
        printWindow.document.close();
        console.log('üñ®Ô∏è Bill opened in background for:', farmer.name, '- Continue working!');
    }
}

// Isse kisi bhi purani entry ka metadata check kar sakte hain
function showAuditProof(entryId) {
    const e = entries.find(x => x.id === entryId);
    if(!e) return;

    // Update summary panel to show this entry's data
    selectedFarmerId = e.farmerId;
    qty = Number(e.qty || 0);
    fat = Number(e.fat || 0);
    snf = Number(e.snf || 0);
    animal = e.animal || 'cow';
    
    // Update input fields
    if (el("qtyInput")) el("qtyInput").value = qty;
    if (el("fatInput")) el("fatInput").value = fat;
    if (el("snfInput")) el("snfInput").value = snf;
    if (el("animalSelect")) el("animalSelect").value = animal;
    
    // Refresh the trust panel to show updated values
    renderTrust();
    
    const content = el("entryDetailContent");
    const isEdited = e.edited ? "Yes" : "No";

    content.innerHTML = `
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:14px;">
            <div>Farmer: <br><span style="color:var(--blue)">${e.farmerName}</span></div>
            <div>Amount: <br><span style="color:var(--green)">${formatAmount(e.amount)}</span></div>
            <hr style="grid-column: 1/-1; width:100%; opacity:0.2;">
            <div>Qty: ${e.qty} L</div>
            <div>Fat: ${e.fat}%</div>
            <div>SNF: ${e.snf}</div>
            <div>Rate Mode: ${e.rateMode.toUpperCase()}</div>
            <hr style="grid-column: 1/-1; width:100%; opacity:0.2;">
            <div style="font-size:11px; color:var(--muted);">Recorded: ${new Date(e.createdAt).toLocaleString()}</div>
            <div style="font-size:11px; color:var(--muted);">Source: ${e.entrySource}</div>
            <div style="font-size:11px; color:var(--muted);">Device ID: ${e.deviceId}</div>
            <div style="font-size:11px; color:var(--muted);">Edited: ${isEdited}</div>
        </div>
        ${e.images && e.images.length > 0 ? `<div style="margin-top:15px;"><label>Photo Proof:</label><img src="${e.images[0]}" style="width:100%; border-radius:10px; margin-top:5px;"></div>` : ''}
    `;

    // WhatsApp Button Logic for this single entry
    el("btnSendSingleProof").onclick = () => {
        const f = getFarmerById(e.farmerId);
        let msg = `*Milk Entry Proof* ü•õ\n`;
        msg += `Farmer: ${e.farmerName}\n`;
        if (f && f.serial) msg += `Serial: #${f.serial}\n`;
        if (f && f.phone) msg += `Phone: ${f.phone}\n`;
        if (f && f.address) msg += `Address: ${f.address}\n`;
        msg += `Qty: ${e.qty}L | Fat: ${e.fat}%\n`;
        if (e.snf) msg += `SNF: ${e.snf}\n`;
        msg += `Amount: ${formatAmount(e.amount)}\n`;
        msg += `Time: ${new Date(e.createdAt).toLocaleString()}\n`;
        msg += `Source: ${e.entrySource}\n`;

        // Add farmer payment details for WhatsApp only
        if (f && (f.upi || f.bankName)) {
            msg += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            msg += `*üí≥ Payment Details:*\n`;
            if (f.upi) msg += `üì± UPI: ${f.upi}\n`;
            if (f.bankName) msg += `üè¶ Bank: ${f.bankName}\n`;
            if (f.accountNo) msg += `üî¢ Account: ${f.accountNo}\n`;
            if (f.ifsc) msg += `üîë IFSC: ${f.ifsc}\n`;
            if (f.accountName) msg += `üë§ Name: ${f.accountName}\n`;
        }

        msg += `\nGopal Dairy Shop`;
        
        const phone = f.phone ? f.phone.replace(/\D/g, '') : '';
        if (phone) {
            window.open(`https://wa.me/91${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        } else {
            showToast('‚ö†Ô∏è Phone number not available');
        }
    };

    openOverlay("overlayEntryDetail");
}
      function autoNextFarmer() {
        const list = filterFarmers();
        const idx = list.findIndex((f) => f.id === selectedFarmerId);
        if (idx >= 0 && idx < list.length - 1) {
          selectedFarmerId = list[idx + 1].id;
        }
      }

      function undoLast() {
        const token = loadUndoToken();
        if (!token) {
          showToast("Nothing to undo");
          return;
        }

        const idx = entries.findIndex((e) => e.id === token.entryId);
        if (idx < 0) {
          clearUndoToken();
          showToast("Undo not found");
          return;
        }

        // Restore farmer balance
        const farmer = getFarmerById(token.farmerId);
        if (farmer) {
          farmer.balance = round2(Number(token.prevBalance) || 0);
          saveFarmers(farmers);
        }

        // Remove entry
        entries.splice(idx, 1);
        saveEntries(entries);

        clearUndoToken();
        showToast("UNDO ‚úÖ");
        renderAll();
      }

      /***********************
       * HISTORY + EXPORT     *
       ***********************/
      function entriesToday() {
        const today = fmtDate(new Date());
        return entries
          .filter((e) => e.day === today)
          .sort((a, b) => b.createdAt - a.createdAt);
      }
      function entriesWeek() {
        const start = daysAgo(6).getTime();
        return entries
          .filter((e) => e.createdAt >= start)
          .sort((a, b) => b.createdAt - a.createdAt);
      }

      function makeEntryCard(e) {
        const t = fmtTime(new Date(e.createdAt));
        const d = fmtDate(new Date(e.createdAt));
        const icon = e.animal === "buffalo" ? "üêÉ" : "üêÑ";
        const rt = e.rateMode === "manual" ? "Manual" : "Auto";
        return `
    <div class="cardRow">
      <div style="min-width:0; flex: 1;">
        <div class="title">${escapeHtml(e.farmerName || "")}</div>
        <div class="meta">${d} ${t} ‚Ä¢ ${icon} <strong style="color: #16a34a; font-size: 15px;">${e.qty} L</strong> ‚Ä¢ Fat ${e.fat}% ‚Ä¢ SNF ${e.snf} ‚Ä¢ ${rt}</div>
      </div>
      <div class="val">‚Çπ${Number(e.amount || 0).toFixed(2)}</div>
    </div>
  `;
      }

      function renderHistory() {
        const today = entriesToday();
        const week = entriesWeek();

        el("historyTitleRight").textContent =
          `${today.length} today ‚Ä¢ ${week.length} in 7d`;

        const tMax = Math.max(0, Math.ceil(today.length / LIST_PER_PAGE) - 1);
        if (todayPage > tMax) todayPage = tMax;
        const tSlice = today.slice(
          todayPage * LIST_PER_PAGE,
          todayPage * LIST_PER_PAGE + LIST_PER_PAGE,
        );
        el("todayList").innerHTML =
          tSlice.map(makeEntryCard).join("") ||
          `<div style="color:var(--muted);font-weight:1100;">No entries</div>`;
        el("todayPageInfo").textContent =
          `Page ${today.length ? todayPage + 1 : 0}/${today.length ? tMax + 1 : 0}`;
        el("todayPrev").disabled = todayPage <= 0;
        el("todayNext").disabled = todayPage >= tMax;

        const wMax = Math.max(0, Math.ceil(week.length / LIST_PER_PAGE) - 1);
        if (weekPage > wMax) weekPage = wMax;
        const wSlice = week.slice(
          weekPage * LIST_PER_PAGE,
          weekPage * LIST_PER_PAGE + LIST_PER_PAGE,
        );
        el("weekList").innerHTML =
          wSlice.map(makeEntryCard).join("") ||
          `<div style="color:var(--muted);font-weight:1100;">No entries</div>`;
        el("weekPageInfo").textContent =
          `Page ${week.length ? weekPage + 1 : 0}/${week.length ? wMax + 1 : 0}`;
        el("weekPrev").disabled = weekPage <= 0;
        el("weekNext").disabled = weekPage >= wMax;
      }

      function exportJSON() {
        const payload = {
          exportedAt: new Date().toISOString(),
          settings,
          farmers,
          entries,
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `milkapp_export_${fmtDate(new Date())}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast("Exported ‚úÖ");
      }

      function clearToday() {
        const today = fmtDate(new Date());
        const beforeLen = entries.length;
        entries = entries.filter((e) => e.day !== today);
        saveEntries(entries);
        showToast(
          entries.length !== beforeLen ? "Today cleared" : "No entries today",
        );
        renderHistory();
        renderAll();
      }

      /***********************
       * LEADERBOARD         *
       ***********************/
      function buildLeader() {
        const week = entriesWeek();
        const map = new Map();
        week.forEach((e) => {
          const cur = map.get(e.farmerId) || {
            farmerId: e.farmerId,
            name: e.farmerName,
            amount: 0,
            liters: 0,
            count: 0,
          };
          cur.amount = round2(cur.amount + Number(e.amount || 0));
          cur.liters = round2(cur.liters + Number(e.qty || 0));
          cur.count = cur.count + 1;
          map.set(e.farmerId, cur);
        });
        let arr = Array.from(map.values());
        arr.sort((a, b) => {
          if (leaderMode === "amount") return b.amount - a.amount;
          if (leaderMode === "liters") return b.liters - a.liters;
          return b.count - a.count;
        });
        return arr;
      }

      function renderLeader() {
        const leaders = buildLeader();
        const maxPage = Math.max(
          0,
          Math.ceil(leaders.length / LEADER_PER_PAGE) - 1,
        );
        if (leaderPage > maxPage) leaderPage = maxPage;

        const slice = leaders.slice(
          leaderPage * LEADER_PER_PAGE,
          leaderPage * LEADER_PER_PAGE + LEADER_PER_PAGE,
        );

        el("leaderRight").textContent =
          `${leaders.length} farmers ‚Ä¢ sorted by ${leaderMode}`;

        el("leaderPageInfo").textContent =
          `Page ${leaders.length ? leaderPage + 1 : 0}/${leaders.length ? maxPage + 1 : 0}`;

        el("leaderPrev").disabled = leaderPage <= 0;
        el("leaderNext").disabled = leaderPage >= maxPage;

        el("leaderList").innerHTML =
          slice
            .map(
              (l) => `
      <div class="cardRow">
        <div style="min-width:0;">
          <div class="title">${escapeHtml(l.name || "")}</div>
          <div class="meta">
            ${formatAmount(l.amount)} ‚Ä¢ ${l.liters.toFixed(1)} L ‚Ä¢ ${l.count} entries
          </div>
        </div>
        <div class="val">
          ${
            leaderMode === "amount"
              ? formatAmount(l.amount)
              : leaderMode === "liters"
                ? l.liters.toFixed(1) + " L"
                : l.count
          }
        </div>
      </div>
    `,
            )
            .join("") ||
          `<div style="color:var(--muted);font-weight:1100;">No data</div>`;
      }

      /***********************
       * OVERLAYS HELPERS    *
       ***********************/
      function openOverlay(id) {
        const overlay = document.getElementById(id);
        if (overlay) {
          overlay.style.display = "flex";
          // Scroll modal body to top
          const modalBody = overlay.querySelector('.modalBody');
          if (modalBody) modalBody.scrollTop = 0;
          
          // Load settings values when opening settings modal
          if (id === "overlaySettings") {
            if (el("setCowBase")) el("setCowBase").value = settings.cowBase || 0;
            if (el("setCowBaseOp")) el("setCowBaseOp").value = settings.cowBaseOp || 'fixed';
            if (el("setCowFactor")) el("setCowFactor").value = settings.cowFactor || 0;
            if (el("setCowFatOp")) el("setCowFatOp").value = settings.cowFatOp || 'multiply';
            if (el("setCowSnfFactor")) el("setCowSnfFactor").value = settings.cowSnfFactor || 0;
            if (el("setCowSnfOp")) el("setCowSnfOp").value = settings.cowSnfOp || 'multiply';
            if (el("setBuffBase")) el("setBuffBase").value = settings.buffBase || 0;
            if (el("setBuffBaseOp")) el("setBuffBaseOp").value = settings.buffBaseOp || 'fixed';
            if (el("setBuffFactor")) el("setBuffFactor").value = settings.buffFactor || 0;
            if (el("setBuffFatOp")) el("setBuffFatOp").value = settings.buffFatOp || 'multiply';
            if (el("setBuffSnfFactor")) el("setBuffSnfFactor").value = settings.buffSnfFactor || 0;
            if (el("setBuffSnfOp")) el("setBuffSnfOp").value = settings.buffSnfOp || 'multiply';
            if (el("setQtyStep")) el("setQtyStep").value = settings.qtyStep || 0.1;
            if (el("setFatStep")) el("setFatStep").value = settings.fatStep || 0.1;
            if (el("setSnfStep")) el("setSnfStep").value = settings.snfStep || 0.1;
            if (el("setSessionHour")) el("setSessionHour").value = settings.sessionSwitchHour || 4;

            updateFormulaPreview();
            updateLivePreview();
          }
          
          // Auto-generate serial number when opening farmer modal
          if (id === "overlayFarmer") {
            const fSerial = el("fSerial");
            if (fSerial) {
              const nextNum = farmers.length + 1;
              fSerial.value = `#${nextNum}`;
              console.log('üî¢ Serial auto-filled:', fSerial.value);
              // Focus and select serial field so user can edit if needed
              setTimeout(() => {
                fSerial.focus();
                fSerial.select();
              }, 300);
            }
          }
          
          // Focus first input in the overlay
          const firstInput = overlay.querySelector('input:not([type="hidden"]), select, textarea');
          if (firstInput) {
            // Use requestAnimationFrame for better timing with CSS transitions
            requestAnimationFrame(() => {
              setTimeout(() => {
                firstInput.focus();
                // Select text for text inputs for better UX
                if (firstInput.tagName === 'INPUT' && firstInput.type !== 'file') {
                  firstInput.select();
                }
                // Scroll input into view if needed
                firstInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 50);
            });
          }
        }
        if (id === "overlayHistory") renderHistory();
        if (id === "overlayLeader") renderLeader();
      }
      function closeOverlay(id) {
        const overlay = document.getElementById(id);
        if (overlay) {
          overlay.style.display = "none";
        }
      }

      // Enter key navigation for forms - move to next field on Enter
      // (Doesn't apply to farmer modal - has its own dedicated handler)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
          // Skip if farmer modal is open (has dedicated handler)
          if (el("overlayFarmer")?.style.display === "flex") return;
          
          e.preventDefault();
          const form = e.target.closest('form, .modalBody, .formGrid');
          if (form) {
            const inputs = Array.from(form.querySelectorAll('input:not([type="hidden"]):not([type="file"]), select, textarea'));
            const currentIndex = inputs.indexOf(e.target);
            if (currentIndex !== -1 && currentIndex < inputs.length - 1) {
              inputs[currentIndex + 1].focus();
              // Select text for text inputs
              if (inputs[currentIndex + 1].tagName === 'INPUT' && inputs[currentIndex + 1].type !== 'file') {
                inputs[currentIndex + 1].select();
              }
              // Scroll input into view
              inputs[currentIndex + 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        }
      });
      
      // Close overlay when clicking outside modal (EXCEPT farmer form - prevent accidental close)
      document.querySelectorAll('.overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            // Prevent closing farmer form by clicking outside - must use X button or ESC
            if (overlay.id === 'overlayFarmer') {
              showToast('‚ùå Use X button or ESC to close farmer form');
              return;
            }
            overlay.style.display = "none";
          }
        });
      });

      // Close overlay when clicking close button (using event delegation for reliability)
      // EXCEPT farmer form - prevent accidental close
      document.addEventListener('click', (e) => {
        if (e.target.hasAttribute('data-close')) {
          const overlayId = e.target.getAttribute('data-close');
          // Prevent closing farmer form via X button - must use ESC or submit
          if (overlayId === 'overlayFarmer') {
            showToast('‚ùå Use ESC to close farmer form');
            return;
          }
          closeOverlay(overlayId);
        }
      });

      /***********************
       * EVENTS              *
       ***********************/
      // Initialize everything when DOM is ready
      window.addEventListener('DOMContentLoaded', () => {
        // Manual rate input initialization
        const manualRateInput = el("manualRateInput");
        if (manualRateInput && settings.cowBase) {
          manualRateInput.value = Number(settings.cowBase).toFixed(2);
          manualRateInput.placeholder = `Auto: ‚Çπ${manualRateInput.value}`;
        }

        // Reset farmer page to 0 and render
        farmerPage = 0;
        renderFarmers();

        // Paging with bounds checking
        const prevFarmers = el("prevFarmers");
        if (prevFarmers) {
          prevFarmers.onclick = () => {
            const list = filterFarmers();
            const maxPage = Math.max(0, Math.ceil(list.length / FARMERS_PER_PAGE) - 1);
            if (farmerPage > 0) {
              farmerPage--;
              renderFarmers();
            }
          };
        }

        const nextFarmers = el("nextFarmers");
        if (nextFarmers) {
          nextFarmers.onclick = () => {
            const list = filterFarmers();
            const maxPage = Math.max(0, Math.ceil(list.length / FARMERS_PER_PAGE) - 1);
            if (farmerPage < maxPage) {
              farmerPage++;
              renderFarmers();
            }
          };
        }

        // Manual rate override
        const manualRateApply = el("manualRateApply");
        if (manualRateApply) {
          manualRateApply.onclick = () => {
            manualRate = Number(manualRateInput.value) || 0;
            renderTrust();
            // Focus on LIKH LO button after applying rate
            const likhloBtn = el("btnLikhlo");
            if (likhloBtn) {
              likhloBtn.focus();
            }
          };
        }

        // Save with Payment Mode function
        window.saveWithPaymentMode = function(mode) {
          if (!canSave()) {
            showToast("Need: Farmer + Qty + Fat");
            return;
          }
          const farmer = getFarmerById(selectedFarmerId);
          if (!farmer) {
            showToast("Select farmer");
            return;
          }
          paymentMode = mode; // Set payment mode
          saveEntry();
        };

        // Hold button
        const btnHold = el("btnHold");
        if (btnHold) {
          btnHold.onclick = holdCurrent;
          console.log('‚úÖ Hold button initialized');
        } else {
          console.error('‚ùå Hold button not found!');
        }

        const btnLikhlo = el("btnLikhlo");
        if (btnLikhlo) {
          btnLikhlo.onclick = () => {
            // Save as CREDIT (‡§â‡§ß‡§æ‡§∞) and generate invoice
            if (!canSave()) {
              showToast("Need: Farmer + Qty + Fat");
              return;
            }
            const farmer = getFarmerById(selectedFarmerId);
            if (!farmer) {
              showToast("Select farmer");
              return;
            }

            paymentMode = "Credit"; // Set to Credit for Likhlo
            saveEntryAsCredit();
          };
          // Add Enter key support - when focused, Enter triggers click
          btnLikhlo.onkeydown = (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              btnLikhlo.click();
            }
          };
          console.log('‚úÖ Likh Lo button initialized');
        } else {
          console.error('‚ùå Likh Lo button not found!');
        }

        // History (if button exists)
        const btnHistoryMain = el("btnHistoryMain");
        if (btnHistoryMain) {
          btnHistoryMain.onclick = () => openOverlay("overlayHistory");
        }
        
        const todayPrev = el("todayPrev");
        if (todayPrev) todayPrev.onclick = () => { todayPage--; renderHistory(); };
        
        const todayNext = el("todayNext");
        if (todayNext) todayNext.onclick = () => { todayPage++; renderHistory(); };
        
        const weekPrev = el("weekPrev");
        if (weekPrev) weekPrev.onclick = () => { weekPage--; renderHistory(); };
        
        const weekNext = el("weekNext");
        if (weekNext) weekNext.onclick = () => { weekPage++; renderHistory(); };
        
        const btnExport = el("btnExport");
        if (btnExport) btnExport.onclick = exportJSON;
        
        const btnClearToday = el("btnClearToday");
        if (btnClearToday) btnClearToday.onclick = clearToday;

        // Leader buttons
        const btnLeader = el("btnLeader");
        if (btnLeader) btnLeader.onclick = () => openOverlay("overlayLeader");
        
        const leaderPrev = el("leaderPrev");
        if (leaderPrev) leaderPrev.onclick = () => { leaderPage--; renderLeader(); };
        
        const leaderNext = el("leaderNext");
        if (leaderNext) leaderNext.onclick = () => { leaderPage++; renderLeader(); };
        
        const btnLeaderByAmt = el("btnLeaderByAmt");
        if (btnLeaderByAmt) btnLeaderByAmt.onclick = () => { leaderMode = "amount"; leaderPage = 0; renderLeader(); };
        
        const btnLeaderByLit = el("btnLeaderByLit");
        if (btnLeaderByLit) btnLeaderByLit.onclick = () => { leaderMode = "liters"; leaderPage = 0; renderLeader(); };
        
        const btnLeaderByCount = el("btnLeaderByCount");
        if (btnLeaderByCount) btnLeaderByCount.onclick = () => { leaderMode = "count"; leaderPage = 0; renderLeader(); };

        // Settings buttons
        const btnSettings = el("btnSettings");
        if (btnSettings) btnSettings.onclick = () => openOverlay("overlaySettings");
        
        const btnSaveSettings = el("btnSaveSettings");
        if (btnSaveSettings) btnSaveSettings.onclick = () => {
          settings.cowBase = Number(el("setCowBase").value) || settings.cowBase;
          settings.cowBaseOp = el("setCowBaseOp").value || 'fixed';
          settings.cowFactor = Number(el("setCowFactor").value) || settings.cowFactor;
          settings.cowFatOp = el("setCowFatOp").value || 'multiply';
          settings.cowSnfFactor = Number(el("setCowSnfFactor").value) || settings.cowSnfFactor;
          settings.cowSnfOp = el("setCowSnfOp").value || 'multiply';
          settings.buffBase = Number(el("setBuffBase").value) || settings.buffBase;
          settings.buffBaseOp = el("setBuffBaseOp").value || 'fixed';
          settings.buffFactor = Number(el("setBuffFactor").value) || settings.buffFactor;
          settings.buffFatOp = el("setBuffFatOp").value || 'multiply';
          settings.buffSnfFactor = Number(el("setBuffSnfFactor").value) || settings.buffSnfFactor;
          settings.buffSnfOp = el("setBuffSnfOp").value || 'multiply';
          settings.qtyStep = Number(el("setQtyStep").value) || settings.qtyStep;
          settings.fatStep = Number(el("setFatStep").value) || settings.fatStep;
          settings.snfStep = Number(el("setSnfStep").value) || settings.snfStep;
          settings.sessionSwitchHour = Number(el("setSessionHour").value) || settings.sessionSwitchHour;

          saveSettings(settings);

          // REAL-TIME UPDATE EVERYWHERE
          refreshRatePill();           // Update rate pill in header
          renderTrust();               // Update right panel (amount, rate, balances)
          renderAll();                 // Re-render all farmers and UI
          
          // If rate table is open, regenerate it with new rates
          const rateTableOverlay = document.getElementById('overlayRateEditor');
          if (rateTableOverlay && rateTableOverlay.style.display === 'flex') {
            openRateTable();  // Regenerate rate table with new formula
          }
          
          // Update formula previews
          updateFormulaPreview();
          updateLivePreview();
          
          showToast("‚úÖ Settings saved & applied everywhere!");
          console.log('‚úÖ Settings saved, all UI updated in real-time');
        };

        // Add farmer modal
        const addBtn = el("btnAddFarmerMain");
        if (addBtn) {
          addBtn.onclick = () => {
            // Pre-fill name field with search text if exists
            const searchInput = el("searchInput");
            const nameField = el("fName");
            if (searchInput && searchInput.value.trim() && nameField) {
              nameField.value = searchInput.value.trim();
              searchInput.value = ""; // Clear search
            }
            openOverlay("overlayFarmer");
            // Focus on name field (or next empty field)
            setTimeout(() => {
              if (nameField && !nameField.value) {
                nameField.focus();
                nameField.select();
              } else {
                const phoneField = el("fPhone");
                if (phoneField) {
                  phoneField.focus();
                  phoneField.select();
                }
              }
            }, 300);
          };
          console.log('‚úÖ + Farmer button initialized');
        } else {
          console.error('‚ùå + Farmer button not found!');
        }

        // Create Farmer button
        const createBtn = el("btnCreateFarmer");
        if (createBtn) {
          createBtn.onclick = async () => {
            console.log('üîµ Create button clicked!');

            // Get all form values with null checks
            const fSerial = el("fSerial");
            const fName = el("fName");
            const fPhone = el("fPhone");
            const fAddress = el("fAddress");
            const fCity = el("fCity");
            const fPincode = el("fPincode");
            const fGst = el("fGst");
            const fBalance = el("fBalance");
            const fActive = el("fActive");
            const fAnimalType = el("fAnimalType");

            if (!fName) {
              showToast("Form error: Name field not found");
              return;
            }

            // Auto-generate serial number if not provided or empty
            let serialNum = fSerial && fSerial.value.trim() ? fSerial.value.trim() : '';
            if (!serialNum) {
              // Count existing farmers and generate next serial
              const nextNum = farmers.length + 1;
              serialNum = `#${nextNum}`;
              console.log('üî¢ Auto-generated serial:', serialNum);
            }

            const fullName = fName.value ? fName.value.trim() : '';

            // Capitalize first letter of each word in name
            const capitalizeName = (str) => {
              return str.replace(/\b\w/g, c => c.toUpperCase());
            };
            const capitalizedFullName = capitalizeName(fullName);

            // Split name for better search (first name, last name, short name)
            const nameParts = capitalizedFullName.split(/\s+/).filter(p => p.length > 0);
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';
            const shortName = firstName ? firstName.charAt(0).toUpperCase() : '';

            const f = {
              serial: serialNum,
              name: capitalizedFullName,
              firstName: firstName,
              lastName: lastName,
              shortName: shortName,
              phone: fPhone ? (fPhone.value ? fPhone.value.trim() : '') : '',
              address: fAddress ? (fAddress.value ? fAddress.value.trim() : '') : '',
              city: fCity ? capitalizeName(fCity.value.trim()) : '',
              pincode: fPincode ? (fPincode.value ? fPincode.value.trim() : '') : '',
              balance: fBalance ? (Number(fBalance.value) || 0) : 0,
              active: fActive ? fActive.value === "1" : true,
              animalType: fAnimalType ? fAnimalType.value : 'cow',
              // Payment Details
              upi: fUPI ? (fUPI.value ? fUPI.value.trim().toLowerCase() : '') : '',
              bankName: fBankName ? (fBankName.value ? fBankName.value.trim() : '') : '',
              accountNo: fAccountNo ? (fAccountNo.value ? fAccountNo.value.trim() : '') : '',
              ifsc: fIFSC ? (fIFSC.value ? fIFSC.value.trim().toUpperCase() : '') : '',
              accountName: fAccountName ? (fAccountName.value ? fAccountName.value.trim() : '') : ''
            };
            console.log('üîµ Farmer data:', f);

            if (!f.name) {
              showToast("Name required");
              console.error('‚ùå Farmer creation failed: Name is required');
              return;
            }

            // Check for duplicate phone number
            if (f.phone) {
              const existing = farmers.find(farmer => farmer.phone === f.phone);
              if (existing) {
                showToast(`‚ö†Ô∏è Farmer with phone ${f.phone} already exists!`);
                return;
              }
            }

            const btn = el("btnCreateFarmer");
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Creating...';

            try {
              // Create farmer in local storage only (API removed for simplicity)
              const localFarmer = {
                id: "f" + Date.now(),
                ...f
              };
              farmers.push(localFarmer);
              saveFarmers(farmers);
              selectedFarmerId = localFarmer.id;

              closeOverlay("overlayFarmer");
              renderAll();
              showToast("Farmer created ‚úÖ");
              console.log('‚úÖ Farmer created:', localFarmer);

            } catch (error) {
              console.error('‚ùå Error creating farmer:', error);
              showToast("Error creating farmer");
            } finally {
              btn.disabled = false;
              btn.innerHTML = '‚úÖ Create';
            }
          };
          console.log('‚úÖ Create Farmer button initialized');
        } else {
          console.error('‚ùå Create Farmer button NOT found!');
        }

        // Demo Farmers button - Hide if 3+ farmers already exist
        const demoBtn = el("btnDemoFarmers");
        if (demoBtn) {
          // Hide button if already have 3+ farmers
          if (farmers.length >= 3) {
            demoBtn.style.display = 'none';
          }
          
          demoBtn.onclick = () => {
            const demoFarmers = [
              { id: "f1", name: "Raj Kumar", phone: "9876543210", address: "Vadgaon", balance: 0, active: true, animalType: "cow" },
              { id: "f2", name: "Suresh Patil", phone: "9876543211", address: "Shivaji Nagar", balance: 500, active: true, animalType: "buffalo" },
              { id: "f3", name: "Anita Desai", phone: "9876543212", address: "Market Yard", balance: 0, active: true, animalType: "both" },
              { id: "f4", name: "Vikram More", phone: "9876543213", address: "Gandhi Chowk", balance: 1000, active: true, animalType: "cow" },
              { id: "f5", name: "Priya Jadhav", phone: "9876543214", address: "Station Road", balance: 0, active: true, animalType: "buffalo" }
            ];

            let added = 0;
            demoFarmers.forEach(df => {
              if (!farmers.find(f => f.phone === df.phone)) {
                farmers.push(df);
                added++;
              }
            });

            if (added > 0) {
              saveFarmers(farmers);
              showToast(`Added ${added} demo farmers ‚úÖ`);
              renderAll();
              // Hide button after adding farmers
              if (farmers.length >= 3) {
                demoBtn.style.display = 'none';
              }
            } else {
              showToast("Demo farmers already exist");
            }
            closeOverlay("overlayFarmer");
          };
          console.log('‚úÖ Demo Farmers button initialized');
        }
      });

      // Farmer search (outside DOMContentLoaded as searchInput exists)
      if (searchInput) searchInput.addEventListener("input", (e) => {
        farmerSearch = e.target.value;
        farmerPage = 0;
        renderFarmers();
      });

      // Input listeners with real-time preview update
      if (el("qtyInput")) el("qtyInput").oninput = (e) => { qty = Number(e.target.value) || 0; renderTrust(); };
      if (el("fatInput")) el("fatInput").oninput = (e) => { fat = Number(e.target.value) || 0; renderTrust(); };
      if (el("snfInput")) el("snfInput").oninput = (e) => { snf = Number(e.target.value) || 0; renderTrust(); };
      if (el("densityInput")) el("densityInput").oninput = (e) => { clr = Number(e.target.value) || 0; calculateSNFFromCLR(); renderTrust(); };

      // Enter key navigation for collection inputs - FULLY OPTIMIZED
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const collectionInputs = ['qtyInput', 'fatInput', 'densityInput', 'snfInput'];
          const curId = e.target.id;
          const curIdx = collectionInputs.indexOf(curId);

          // Move to next input on Enter
          if (curIdx !== -1 && curIdx < collectionInputs.length - 1) {
            e.preventDefault();
            const nextInput = el(collectionInputs[curIdx + 1]);
            if (nextInput) {
              nextInput.focus();
              nextInput.select();
            }
          }

          // From SNF, toggle Animal Type (Cow ‚Üí Buffalo ‚Üí Cow)
          if (curId === 'snfInput') {
            e.preventDefault();
            const currentAnimal = el("animalSelect").value;
            const nextAnimal = currentAnimal === 'cow' ? 'buffalo' : 'cow';
            selectAnimal(nextAnimal);
            // Move focus to next logical element (manual rate or summary)
            if (manualRateInput) {
              manualRateInput.focus();
              manualRateInput.select();
            }
          }
          
          // Toggle animal type with Enter when animal buttons are focused
          if (e.target.id === 'animalCow' || e.target.id === 'animalBuffalo') {
            e.preventDefault();
            const currentAnimal = el("animalSelect").value;
            const nextAnimal = currentAnimal === 'cow' ? 'buffalo' : 'cow';
            selectAnimal(nextAnimal);
          }
        }
      });

      // Animal selector - keep hidden select synced
      if (animalSelect) animalSelect.onchange = (e) => { animal = e.target.value; renderTrust(); };

      // Clear manual rate on farmer change
      function clearManualRate() {
        manualRate = 0;
        if (manualRateInput) manualRateInput.value = '';
      }
      
      // Logout function
      function logout() {
          if (confirm('Are you sure you want to logout?')) {
              // Clear session
              localStorage.removeItem('MilkRecord_session');

              showToast('Logged out successfully!');

              // Redirect to login page
              setTimeout(() => {
                  window.location.href = 'login.html';
              }, 500);
          }
      }
      
      // Toggle profile dropdown
      function toggleProfileDropdown() {
          const dropdown = document.getElementById('profileDropdown');
          dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';

          // Load user info
          const session = localStorage.getItem('MilkRecord_session');
          if (session) {
              const data = JSON.parse(session);
              document.getElementById('profileName').textContent = data.shop_name || 'User';
              document.getElementById('dropdownEmail').textContent = data.email || 'user@email.com';
              document.getElementById('dropdownShop').textContent = data.shop_name || 'Shop';
          }
      }

      // Get progress emoji based on transaction count
      function getProgressEmoji(count) {
          if (count <= 2) return { emoji: 'üìö', name: 'Learning', color: '#3b82f6' };
          if (count <= 4) return { emoji: 'üòä', name: 'Happy', color: '#16a34a' };
          if (count <= 25) return { emoji: 'ü™ô', name: 'Prosperity', color: '#f59e0b' };
          return { emoji: '‚ö°', name: 'Power', color: '#dc2626' };
      }

      // Get current shift (morning/evening)
      function getCurrentShift() {
          const hour = new Date().getHours();
          return hour >= 4 && hour < 16 ? 'morning' : 'evening';
      }

      // Get shift color
      function getShiftColor() {
          return getCurrentShift() === 'morning' ? '#3b82f6' : '#7c3aed';
      }

      // Get today's transaction count
      function getTodayTransactionCount() {
          const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
          const today = new Date().toLocaleDateString();
          return history.filter(h => {
              const entryDate = new Date(h.createdAt || Date.now()).toLocaleDateString();
              return entryDate === today;
          }).length;
      }

      // Toggle header dropdown - Make explicitly global
      window.toggleHeaderDropdown = function() {
          const dropdown = document.getElementById('headerDropdown');
          console.log('üîµ toggleHeaderDropdown called, dropdown:', dropdown);
          if (dropdown) {
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';
            
            // Update with progress info
            const session = localStorage.getItem('MilkRecord_session');
            if (session && isVisible === false) {
                const data = JSON.parse(session);
                const txCount = getTodayTransactionCount();
                const progress = getProgressEmoji(txCount);
                const shiftColor = getShiftColor();
                
                // Update header button with emoji
                const headerBtn = document.getElementById('headerUserName');
                if (headerBtn) {
                    headerBtn.innerHTML = `${progress.emoji} ${data.shop_name || 'User'}`;
                }
                
                // Update dropdown header with progress
                const dropdownHeader = dropdown.querySelector('div[style*="border-bottom"]');
                if (dropdownHeader) {
                    dropdownHeader.innerHTML = `
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                            <span style="font-size:24px;">${progress.emoji}</span>
                            <div>
                                <div style="font-weight:700; font-size:14px;">${progress.name} Level</div>
                                <div style="font-size:11px; color:${shiftColor}; font-weight:700;">${getCurrentShift() === 'morning' ? 'üåÖ Morning Shift' : 'üåÜ Evening Shift'}</div>
                            </div>
                        </div>
                        <div style="font-size:12px; color:var(--muted);">${txCount} transactions today</div>
                    `;
                }
            }
            
            console.log('üîµ Header dropdown toggled:', isVisible ? 'closed' : 'opened');
          }
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
          const headerDropdown = document.getElementById('headerDropdown');
          const userButton = e.target.closest('button[onclick*="toggleHeaderDropdown"]');
          
          if (headerDropdown && !userButton && !headerDropdown.contains(e.target)) {
              headerDropdown.style.display = 'none';
          }
      });

      // Close overlays
      document.querySelectorAll("[data-close]").forEach((b) => {
        b.onclick = () => closeOverlay(b.dataset.close);
      });
      
      // Auto focus search on load
      window.addEventListener("load", () => {
        if (el("searchInput")) el("searchInput").focus();
      });

      // 1. Translation Map
      const translations = {
        en: {
          station: "Milk Intake Station",
          history: "History",
          liters: "2. Liters (L)",
          fat: "3. Fat %",
          snf: "4. SNF",
          animal: "5. Animal Type",
          summary: "Summary",
          totalAmt: "TOTAL AMOUNT",
          oldBal: "OLD BALANCE",
          newBal: "NEW BALANCE",
          recent: "RECENT TODAY",
          save: "SAVE ENTRY",
          hold: "üí≥ ADVANCE",
          undo: "UNDO",
        },
        hi: {
          station: "‡§¶‡•Ç‡§ß ‡§∏‡§Ç‡§ï‡§≤‡§® ‡§∏‡•ç‡§ü‡•á‡§∂‡§®",
          history: "‡§á‡§§‡§ø‡§π‡§æ‡§∏",
          liters: "2. ‡§≤‡•Ä‡§ü‡§∞ (L)",
          fat: "3. ‡§´‡•à‡§ü %",
          snf: "4. SNF",
          animal: "5. ‡§™‡§∂‡•Å ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞",
          summary: "‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂",
          totalAmt: "‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø",
          oldBal: "‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ",
          newBal: "‡§®‡§Ø‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ",
          recent: "‡§Ü‡§ú ‡§ï‡•á ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°",
          save: "‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç",
          hold: "üí≥ ‡§è‡§°‡§µ‡§æ‡§Ç‡§∏",
          undo: "‡§µ‡§æ‡§™‡§∏ (Undo)",
        },
      };

      // 2. Language Toggle Function
      const langSwitch = el("langSwitch");
      if (langSwitch) {
        langSwitch.onclick = () => {
          currentLang = currentLang === "en" ? "hi" : "en";
          const t = translations[currentLang];
          const isHi = currentLang === "hi";
           el("btnIntakeText").textContent = t.intake;
          // UI Elements Update (Ensure these IDs exist in your HTML)
          if (el("stationTitle")) el("stationTitle").textContent = t.station;
          if (el("btnHistoryMain"))
            el("btnHistoryMain").innerHTML = "üßæ " + t.history;

          // Inputs Section
          if (el("qtyLabel")) el("qtyLabel").textContent = t.liters; // HTML mein <div> ko id="qtyLabel" de dena
          if (el("fatLabel")) el("fatLabel").textContent = t.fat;
          if (el("snfLabel")) el("snfLabel").textContent = t.snf;

          // Summary Section
          if (el("summaryTitle")) el("summaryTitle").textContent = t.summary;
          if (el("amtLabel")) el("amtLabel").textContent = t.totalAmt;
          if (el("oldBalLabel")) el("oldBalLabel").textContent = t.oldBal;
          if (el("newBalLabel")) el("newBalLabel").textContent = t.newBal;
          if (el("recentTitle")) el("recentTitle").textContent = t.recent;

          // Footer Buttons
          if (el("btnSave"))
            el("btnSave").innerHTML = (isHi ? "üü¢ " : "") + t.save;
          if (el("btnHold"))
            el("btnHold").innerHTML =
              (isHi ? "üü° " : "") +
            t.hold +
            ' <span class="subnote">pause</span>';
        if (el("btnUndo"))
          el("btnUndo").innerHTML =
            (isHi ? "üî¥ " : "") + t.undo + ' <span class="subnote">last</span>';

        showToast(isHi ? "‡§≠‡§æ‡§∑‡§æ: ‡§π‡§ø‡§Ç‡§¶‡•Ä" : "Language: English");
        
        // Update language display in dropdown
        const langDisplay = document.getElementById('headerLangDisplay');
        if (langDisplay) {
          langDisplay.textContent = isHi ? '‡§π‡§ø‡§Ç‡§¶‡•Ä' : 'English';
        }
      };
      }

  // --- MASTER NAVIGATION: Arrows & Enter (Main Screen + Form) ---
document.addEventListener('keydown', (e) => {
    const active = document.activeElement;
    const isFarmerModalOpen = el("overlayFarmer")?.style.display === "flex";

    // ESC to close farmer modal
    if (isFarmerModalOpen && e.key === "Escape") {
        e.preventDefault();
        closeOverlay("overlayFarmer");
        return;
    }

    // 1. ADD FARMER FORM LOGIC (Sirf tab chalega jab Form khula ho)
    if (isFarmerModalOpen) {
        const formOrder = ["fName", "fPhone", "fAnimalCow", "fAnimalBuffalo", "fAnimalBoth", "fBalance", "fActive", "fAddress", "fCity", "fPincode", "fGst", "fImage", "btnCreateFarmer"];
        const curIdx = formOrder.indexOf(active.id);

        if (e.key === "Enter") {
            e.preventDefault();

            // Skip readonly serial field - auto-generated
            if (active.id === "fSerial") {
                el("fName").focus();
                return;
            }

            // Toggle animal type with Enter (Cow ‚Üí Buffalo ‚Üí Both ‚Üí Cow)
            if (active.id === 'fAnimalCow' || active.id === 'fAnimalBuffalo' || active.id === 'fAnimalBoth') {
                const animalTypeField = el("fAnimalType");
                if (animalTypeField) {
                  const currentAnimal = animalTypeField.value;
                  const nextAnimal = currentAnimal === 'cow' ? 'buffalo' : currentAnimal === 'buffalo' ? 'both' : 'cow';
                  selectFarmerAnimal(nextAnimal);
                }
                return;
            }

            // On fName ‚Üí Move to Phone
            if (active.id === "fName") {
                const phoneField = el("fPhone");
                if (phoneField) phoneField.focus();
                return;
            }

            // On fPhone ‚Üí Move to Milk Type (Cow button)
            if (active.id === "fPhone") {
                const cowBtn = el("fAnimalCow");
                if (cowBtn) cowBtn.focus();
                return;
            }

            // On fActive ‚Üí Move to Address (optional section)
            if (active.id === "fActive") {
                const addressField = el("fAddress");
                if (addressField) addressField.focus();
                return;
            }

            // On fCity ‚Üí Move to Pincode
            if (active.id === "fCity") {
                const pincodeField = el("fPincode");
                if (pincodeField) pincodeField.focus();
                return;
            }

            // On fPincode ‚Üí Move to GST
            if (active.id === "fPincode") {
                const gstField = el("fGst");
                if (gstField) gstField.focus();
                return;
            }

            // On fGst ‚Üí Move to Image
            if (active.id === "fGst") {
                const imageField = el("fImage");
                if (imageField) imageField.focus();
                return;
            }

            // On fBalance ‚Üí Move to Status
            if (active.id === "fBalance") {
                const statusField = el("fActive");
                if (statusField) statusField.focus();
                return;
            }

            // On fImage ‚Üí Move to Create button
            if (active.id === "fImage") {
                const createBtn = el("btnCreateFarmer");
                if (createBtn) createBtn.focus();
                return;
            }

            // On Create button ‚Üí Create farmer
            if (active.id === "btnCreateFarmer") {
                const createBtn = el("btnCreateFarmer");
                if (createBtn) {
                  createBtn.click();
                  setTimeout(() => {
                    const searchInput = el("searchInput");
                    if (searchInput) searchInput.focus();
                  }, 150);
                }
                return;
            }

            // Move to next field in form order
            if (curIdx !== -1 && curIdx < formOrder.length - 1) {
                const nextField = el(formOrder[curIdx + 1]);
                if (nextField) {
                    nextField.focus();
                    if (nextField.tagName === "INPUT" && nextField.type !== "file") {
                        nextField.select();
                    }
                }
            }
        }

        if (e.key === "ArrowRight" || e.key === "ArrowLeft") {
            if (active.id === "fAddress") return; // Textarea mein typing ke liye arrows chhod do
            e.preventDefault();
            if (e.key === "ArrowRight" && curIdx < formOrder.length - 1) {
                el(formOrder[curIdx + 1]).focus();
            } else if (e.key === "ArrowLeft" && curIdx > 0) {
                el(formOrder[curIdx - 1]).focus();
            }
        }
        return; // Modal ka kaam khatam, niche wala main screen code nahi chalega
    }

    // 2. MAIN SCREEN LOGIC (Sirf tab chalega jab Form BAND ho)
    if (e.key === "ArrowRight" || e.key === "ArrowLeft") {
        if (active.classList.contains("fcard")) {
            e.preventDefault();
            const cards = Array.from(el("farmerGrid").children);
            const list = filterFarmers();
            const idx = cards.indexOf(active);
            let nextIdx = e.key === "ArrowRight" ? idx + 1 : idx - 1;

            if (nextIdx >= 0 && nextIdx < cards.length && list[nextIdx]) {
                cards[nextIdx].focus();
                selectedFarmerId = list[nextIdx].id;
                renderTrust();
            }
        }
    }
    
    // --- QTY INPUT PAR SHIFT + ENTER KA LOGIC ---
    if (active.id === "qtyInput") {
        // Agar Shift + Enter dabayein toh seedha Advance modal khule
        if (e.shiftKey && e.key === "Enter") {
            e.preventDefault();
            if (selectedFarmerId) {
                openFarmerDetail(selectedFarmerId);
            }
            return;
        }
    }

    if (e.key === "Enter") {
        e.preventDefault();
        if (active.id === "searchInput") {
            const firstCard = el("farmerGrid").querySelector('.fcard');
            if (firstCard) firstCard.focus();
        }
        else if (active.classList.contains("fcard")) {
            const list = filterFarmers();
            const cards = Array.from(el("farmerGrid").children);
            const idx = cards.indexOf(active);
            if (list[idx]) {
                selectedFarmerId = list[idx].id;
                renderAll();
                setTimeout(() => {
                    el("qtyInput").focus();
                    el("qtyInput").select();
                }, 50);
            }
        }
        else if (active.id === "qtyInput") {
            const fatInput = el("fatInput");
            if (fatInput) { fatInput.focus(); fatInput.select(); }
        }
        else if (active.id === "fatInput") {
            const densityInput = el("densityInput");
            if (densityInput) densityInput.focus();
        }
        else if (active.id === "densityInput") {
            const snfInput = el("snfInput");
            if (snfInput) snfInput.focus();
        }
        else if (active.id === "snfInput") {
            const btnSave = el("btnSave");
            if (btnSave) btnSave.focus();
        }
        else if (active.id === "btnSave") {
            saveEntry();
            const searchInput = el("searchInput");
            if (searchInput) {
                searchInput.focus();
                searchInput.value = "";
            }
        }
    }
});

// Open farmer relations/profile from footer button
function openFarmerRelations() {
    if (!selectedFarmerId) {
        showToast("‚ö†Ô∏è Select a farmer first");
        return;
    }
    openFarmerDetail(selectedFarmerId);
    // Auto-open Relations tab
    setTimeout(() => {
        showDetailTab('relations');
    }, 300);
}

// --- COMPREHENSIVE FARMER DETAIL MODAL ---
function openFarmerDetail(fId) {
    const f = getFarmerById(fId);
    if (!f) return;
    selectedFarmerId = fId;
    
    console.log('üîµ Opening farmer detail for:', f.name, f.id);

    // Header
    const nameDisplay = f.serial ? `${f.name} (#${f.serial})` : f.name;
    el("detailFarmerName").textContent = nameDisplay;
    
    // Info Cards
    el("detailPhone").textContent = f.phone || '‚Äî';
    el("detailSerial").textContent = f.serial || '‚Äî';
    el("detailAnimal").textContent = f.animalType === 'cow' ? 'üêÑ Cow' : f.animalType === 'buffalo' ? 'üêÉ Buffalo' : 'üîÑ Both';
    el("detailAddress").textContent = f.address || f.city || '‚Äî';
    
    // Balance with clear label - Hinglish for clarity
    const balance = f.balance || 0;
    el("detailBalance").textContent = formatAmount(balance);
    el("detailBalance").style.color = balance < 0 ? '#16a34a' : '#dc2626'; // Green if we owe, Red if they owe
    const balanceLabel = el("detailBalanceLabel");
    if (balance < 0) {
        balanceLabel.textContent = '‚¨áÔ∏è Humko farmer ko dene hai';
        balanceLabel.style.color = '#16a34a';
    } else if (balance > 0) {
        balanceLabel.textContent = '‚¨ÜÔ∏è Farmer se lena hai';
        balanceLabel.style.color = '#dc2626';
    } else {
        balanceLabel.textContent = '‚úÖ Settled / Barabar';
        balanceLabel.style.color = '#16a34a';
    }
    
    el("detailAdvance").textContent = formatAmount(f.advance || 0);
    
    // Monthly milk
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthEntries = entries.filter(e => e.farmerId === fId && new Date(e.createdAt) >= monthStart);
    const totalL = monthEntries.reduce((sum, e) => sum + Number(e.qty || 0), 0);
    el("detailMonthlyMilk").textContent = `${totalL.toFixed(1)} L`;
    
    // Load edit form
    el("editName").value = f.name || '';
    el("editPhone").value = f.phone || '';
    el("editSerial").value = f.serial || '';
    el("editAnimal").value = f.animalType || 'cow';
    el("editAddress").value = f.address || '';
    el("editCity").value = f.city || '';
    el("editPincode").value = f.pincode || '';
    
    // Load payment details
    if (el("editUPI")) el("editUPI").value = f.upi || '';
    if (el("editBankName")) el("editBankName").value = f.bankName || '';
    if (el("editAccountNo")) el("editAccountNo").value = f.accountNo || '';
    if (el("editIFSC")) el("editIFSC").value = f.ifsc || '';
    if (el("editAccountName")) el("editAccountName").value = f.accountName || '';
    
    // Load transactions
    loadFarmerTransactions(fId);
    
    // Load advance history ledger
    loadAdvanceHistory(fId);
    
    // Show modal
    openOverlay("overlayFarmerDetail");
    showDetailTab('transactions'); // Default to transactions tab
}

// Tab switching
function showDetailTab(tabName) {
    // Hide all tabs
    ['transactions', 'edit', 'advance', 'relations'].forEach(name => {
        let contentId = 'detail' + name.charAt(0).toUpperCase() + name.slice(1);
        // Special case for advance tab (ID conflict fix)
        if (name === 'advance') contentId = 'detailAdvanceTab';

        const content = document.getElementById(contentId);
        const tab = document.getElementById('tab' + name.charAt(0).toUpperCase() + name.slice(1));
        if (content) content.style.display = 'none';
        if (tab) {
            tab.style.background = 'white';
            tab.style.borderBottomColor = 'transparent';
            tab.style.color = '#64748b';
            tab.style.fontWeight = '600';
        }
    });

    // Show selected tab
    let selectedContentId = 'detail' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
    if (tabName === 'advance') selectedContentId = 'detailAdvanceTab';

    const selectedContent = document.getElementById(selectedContentId);
    const selectedTab = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
    if (selectedContent) selectedContent.style.display = 'block';
    if (selectedTab) {
        selectedTab.style.background = '#f1f5f9';
        selectedTab.style.borderBottomColor = '#3b82f6';
        selectedTab.style.color = '#1e293b';
        selectedTab.style.fontWeight = '700';
    }
    
    // Load data for relations tab
    if (tabName === 'relations') {
        loadLast5Purchases();
        loadPurchasePattern();
        loadPurchaseStreak();
    }
}

// Load farmer transactions
function loadFarmerTransactions(fId) {
    const f = getFarmerById(fId);
    if (!f) return;
    
    const allEntries = entries.filter(e => e.farmerId === fId);
    const transactions = [];
    
    allEntries.forEach(e => {
        const rate = e.rateSnapshot || e.ratePerL || 0;
        // Cash entries are settled (milk + cash received = no balance update)
        const isSettled = e.isSettled || e.paymentMode === 'Cash';
        const paymentDisplay = isSettled ? '‚úÖ Settled' : (e.paymentMode === 'Credit' ? 'üìí Udhar' : e.paymentMode);
        transactions.push({
            date: new Date(e.createdAt),
            type: isSettled ? 'settled' : (e.paymentMode === 'Credit' ? 'credit' : 'payment'),
            description: `${e.qty}L @ ${formatAmount(rate)}/L (Fat: ${e.fat}%)`,
            paymentMode: paymentDisplay,
            amount: Number(e.amount),
            entryId: e.id,
            isSettled: isSettled
        });
    });
    
    // Sort by date (newest first)
    transactions.sort((a, b) => b.date - a.date);
    
    // Calculate running balance
    let balance = f.balance || 0;
    transactions.forEach(t => {
        t.balance = balance;
        balance -= t.amount;
    });
    
    // Update summary
    const totalAmount = transactions.reduce((sum, t) => sum + t.amount, 0);
    el("detailTransactionSummary").textContent = `${transactions.length} entries | Total: ${formatAmount(totalAmount)}`;
    
    // Render transactions
    const transList = document.getElementById('detailTransactionList');
    if (transactions.length === 0) {
        transList.innerHTML = '<div style="padding: 40px; text-align: center; color: #94a3b8;">No transactions yet</div>';
    } else {
        transList.innerHTML = transactions.map((t, i) => `
          <div style="display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #e2e8f0; ${t.isSettled ? 'background: #f0fdf4; opacity: 0.7;' : (i === 0 ? 'background: #fef3c7;' : '')}" onclick="showAuditProof('${t.entryId}')">
            <div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <span style="font-size: 16px;">${t.type === 'credit' ? 'üìí' : t.isSettled ? '‚úÖ' : 'üíµ'}</span>
                <div style="font-weight: 700; font-size: 13px;">${t.description}</div>
              </div>
              <div style="font-size: 11px; color: #64748b;">
                üìÖ ${t.date.toLocaleDateString()} ${t.date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} ‚Ä¢ ${t.paymentMode}
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 700; color: ${t.isSettled ? '#16a34a' : '#dc2626'}; font-size: 14px;">${t.isSettled ? 'Settled' : '-'+formatAmount(t.amount)}</div>
              <div style="color: #64748b; font-size: 11px;">Bal: ${formatAmount(t.balance)}</div>
              ${i === 0 ? '<div style="color: #f59e0b; font-size: 10px; font-weight: 700;">‚¨ÖÔ∏è LATEST</div>' : ''}
            </div>
          </div>
        `).join('');
    }
}

// Save farmer details
function saveFarmerDetails() {
    const f = getFarmerById(selectedFarmerId);
    if (!f) return;

    f.name = el("editName").value.trim();
    f.phone = el("editPhone").value.trim();
    f.serial = el("editSerial").value.trim();
    f.animalType = el("editAnimal").value;
    f.address = el("editAddress").value.trim();
    f.city = el("editCity").value.trim();
    f.pincode = el("editPincode").value.trim();
    
    // Save payment details
    f.upi = el("editUPI") ? el("editUPI").value.trim() : (f.upi || '');
    f.bankName = el("editBankName") ? el("editBankName").value.trim() : (f.bankName || '');
    f.accountNo = el("editAccountNo") ? el("editAccountNo").value.trim() : (f.accountNo || '');
    f.ifsc = el("editIFSC") ? el("editIFSC").value.trim().toUpperCase() : (f.ifsc || '');
    f.accountName = el("editAccountName") ? el("editAccountName").value.trim() : (f.accountName || '');

    saveFarmers(farmers);
    renderFarmers();
    showToast("‚úÖ Farmer details updated!");

    // Refresh modal
    openFarmerDetail(selectedFarmerId);
}

// Send offer message
function sendOfferMessage() {
    const f = getFarmerById(selectedFarmerId);
    if (!f || !f.phone) {
        showToast('‚ö†Ô∏è Phone number not available');
        return;
    }
    
    const offers = [
        `üéâ Special Offer for ${f.name}!\n\nGet ‚Çπ5 bonus on every 100L milk collection this month!\n\nüìû Call us for more details.\nGopal Dairy Shop`,
        `üíù Loyalty Bonus!\n\nDear ${f.name}, you've collected ${formatAmount(500)} cashback this month. Continue collecting to unlock more rewards!\n\nGopal Dairy Shop`,
        `üåü Refer & Earn!\n\nDear ${f.name}, refer a new farmer and get ‚Çπ100 bonus on their first collection!\n\nGopal Dairy Shop`
    ];
    
    const offer = offers[Math.floor(Math.random() * offers.length)];
    const wpUrl = `https://wa.me/91${f.phone.replace(/\D/g, '')}?text=${encodeURIComponent(offer)}`;
    window.open(wpUrl, '_blank');
    showToast('üéÅ Offer sent!');
}

// Send wishes
function sendWishes() {
    const f = getFarmerById(selectedFarmerId);
    if (!f || !f.phone) {
        showToast('‚ö†Ô∏è Phone number not available');
        return;
    }
    
    const today = new Date();
    const day = today.toLocaleDateString('en-IN', { weekday: 'long' });
    const date = today.toLocaleDateString('en-IN', { day: 'numeric', month: 'long' });
    
    const wishes = [
        `üåÖ Good Morning ${f.name}!\n\nHave a wonderful ${day} ahead! May your day be filled with happiness and prosperity.\n\nüôè Gopal Dairy Shop`,
        `üéâ Happy ${date}!\n\nDear ${f.name}, wishing you a day full of joy and success. Thank you for being a valued customer!\n\nüôè Gopal Dairy Shop`,
        `üíê Best Wishes!\n\nDear ${f.name}, may success and happiness always be yours. Thank you for your continued trust in us!\n\nüôè Gopal Dairy Shop`
    ];
    
    const wish = wishes[Math.floor(Math.random() * wishes.length)];
    const wpUrl = `https://wa.me/91${f.phone.replace(/\D/g, '')}?text=${encodeURIComponent(wish)}`;
    window.open(wpUrl, '_blank');
    showToast('üíê Wishes sent!');
}

// Load last 5 purchases
function loadLast5Purchases() {
    const f = getFarmerById(selectedFarmerId);
    if (!f) return;
    
    const allEntries = entries.filter(e => e.farmerId === f.id);
    const last5 = allEntries.sort((a, b) => b.createdAt - a.createdAt).slice(0, 5);
    
    const container = document.getElementById('last5Purchases');
    if (!container) return;
    
    if (last5.length === 0) {
        container.innerHTML = '<div style="color: #64748b; text-align: center; padding: 20px;">No purchases yet</div>';
        return;
    }
    
    let html = '';
    last5.forEach((e, i) => {
        html += `
        <div style="display: flex; justify-content: space-between; padding: 8px 0; ${i < last5.length - 1 ? 'border-bottom: 1px solid #e2e8f0' : ''}">
            <div>
                <div style="font-weight: 700; font-size: 12px;">${new Date(e.createdAt).toLocaleDateString()}</div>
                <div style="font-size: 11px; color: #64748b;">${e.qty}L @ ${formatAmount(e.rateSnapshot)}/L</div>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: 700; font-size: 12px;">${formatAmount(e.amount)}</div>
                <div style="font-size: 10px; color: ${e.paymentMode === 'Credit' ? '#dc2626' : '#16a34a'};">${e.paymentMode === 'Credit' ? 'üìí Credit' : 'üíµ Paid'}</div>
            </div>
        </div>`;
    });
    
    container.innerHTML = html;
}

// Give advance from Relations tab
function giveAdvanceFromRelations() {
    const amountInput = document.getElementById('relationsAdvanceAmount');
    const amount = parseFloat(amountInput.value);
    
    if (!amount || amount <= 0) {
        showToast("‚ö†Ô∏è Enter valid amount");
        return;
    }
    
    const f = getFarmerById(selectedFarmerId);
    if (!f) {
        showToast("‚ö†Ô∏è Select farmer first");
        return;
    }
    
    // Initialize advance history if not exists
    if (!f.advanceHistory) {
        f.advanceHistory = [];
    }
    
    // Add advance
    f.advance = (f.advance || 0) + amount;
    f.balance = (f.balance || 0) - amount;
    
    // Record in advance ledger
    f.advanceHistory.push({
        id: 'adv_' + Date.now(),
        type: 'give',
        amount: amount,
        date: new Date().toISOString(),
        note: 'Advance given from Relations',
        balance: f.advance
    });
    
    saveFarmers(farmers);
    amountInput.value = '';
    
    showToast(`‚úÖ ‚Çπ${amount} advance given to ${f.name}`);
    
    // Refresh the detail modal
    openFarmerDetail(selectedFarmerId);
}

// Load purchase pattern
function loadPurchasePattern() {
    const f = getFarmerById(selectedFarmerId);
    if (!f) return;
    
    const allEntries = entries.filter(e => e.farmerId === f.id);
    
    const container = document.getElementById('purchasePattern');
    if (!container) return;
    
    if (allEntries.length === 0) {
        container.innerHTML = '<div style="color: #64748b; text-align: center; padding: 20px;">No purchase data</div>';
        return;
    }
    
    // Calculate average
    const totalMilk = allEntries.reduce((sum, e) => sum + (e.qty || 0), 0);
    const totalAmt = allEntries.reduce((sum, e) => sum + (e.amount || 0), 0);
    const avgPerVisit = totalMilk / allEntries.length;
    
    // Find most frequent day
    const dayCount = {};
    allEntries.forEach(e => {
        const day = new Date(e.createdAt).toLocaleDateString('en-IN', { weekday: 'long' });
        dayCount[day] = (dayCount[day] || 0) + 1;
    });
    const mostFrequentDay = Object.keys(dayCount).reduce((a, b) => dayCount[a] > dayCount[b] ? a : b);
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            <div style="background: white; padding: 12px; border-radius: 6px;">
                <div style="font-size: 11px; color: #64748b;">Total Visits</div>
                <div style="font-size: 18px; font-weight: 900; color: #1e293b;">${allEntries.length}</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 6px;">
                <div style="font-size: 11px; color: #64748b;">Avg per Visit</div>
                <div style="font-size: 18px; font-weight: 900; color: #1e293b;">${avgPerVisit.toFixed(1)}L</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 6px;">
                <div style="font-size: 11px; color: #64748b;">Total Milk</div>
                <div style="font-size: 18px; font-weight: 900; color: #1e293b;">${totalMilk.toFixed(1)}L</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 6px;">
                <div style="font-size: 11px; color: #64748b;">Total Spent</div>
                <div style="font-size: 18px; font-weight: 900; color: #16a34a;">${formatAmount(totalAmt)}</div>
            </div>
        </div>
        <div style="margin-top: 12px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 12px;">
            <strong>üìÖ Most Frequent Day:</strong> ${mostFrequentDay} (${dayCount[mostFrequentDay]} visits)
        </div>
    `;
}

// Load purchase streak (Snapchat-style)
function loadPurchaseStreak() {
    const f = getFarmerById(selectedFarmerId);
    if (!f) return;
    
    const allEntries = entries.filter(e => e.farmerId === f.id);
    
    const container = document.getElementById('purchaseStreak');
    if (!container) return;
    
    if (allEntries.length === 0) {
        container.innerHTML = '<div style="color: #64748b; font-size: 14px;">No purchases yet</div>';
        return;
    }
    
    // Sort entries by date
    const sortedEntries = allEntries.sort((a, b) => b.createdAt - a.createdAt);
    
    // Calculate current streak
    let currentStreak = 1;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    let lastDate = new Date(sortedEntries[0].createdAt);
    lastDate.setHours(0, 0, 0, 0);
    
    // Check if last purchase was today or yesterday
    const daysDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
    if (daysDiff > 1) {
        // Streak broken
        currentStreak = 1;
    } else {
        // Calculate streak
        for (let i = 1; i < sortedEntries.length; i++) {
            const currentDate = new Date(sortedEntries[i].createdAt);
            currentDate.setHours(0, 0, 0, 0);
            
            const diff = Math.floor((lastDate - currentDate) / (1000 * 60 * 60 * 24));
            
            if (diff === 1) {
                currentStreak++;
                lastDate = currentDate;
            } else if (diff > 1) {
                break;
            }
        }
    }
    
    // Find longest streak
    let longestStreak = 1;
    let tempStreak = 1;
    let prevDate = new Date(sortedEntries[0].createdAt);
    prevDate.setHours(0, 0, 0, 0);
    
    for (let i = 1; i < sortedEntries.length; i++) {
        const currentDate = new Date(sortedEntries[i].createdAt);
        currentDate.setHours(0, 0, 0, 0);
        
        const diff = Math.floor((prevDate - currentDate) / (1000 * 60 * 60 * 24));
        
        if (diff === 1) {
            tempStreak++;
            longestStreak = Math.max(longestStreak, tempStreak);
        } else {
            tempStreak = 1;
        }
        prevDate = currentDate;
    }
    
    // Display streak
    const emoji = currentStreak >= 7 ? 'üî•' : currentStreak >= 3 ? 'üí™' : '‚ú®';
    container.innerHTML = `
        <div style="display: flex; justify-content: space-around; align-items: center;">
            <div>
                <div style="font-size: 36px; font-weight: 900; color: #dc2626;">${emoji} ${currentStreak}</div>
                <div style="font-size: 11px; color: #64748b; font-weight: 700;">CURRENT STREAK</div>
            </div>
            <div style="border-left: 2px solid #e2e8f0; height: 50px;"></div>
            <div>
                <div style="font-size: 36px; font-weight: 900; color: #f59e0b;">üèÜ ${longestStreak}</div>
                <div style="font-size: 11px; color: #64748b; font-weight: 700;">LONGEST STREAK</div>
            </div>
        </div>
        ${currentStreak >= 7 ? '<div style="margin-top: 12px; font-size: 12px; color: #dc2626; font-weight: 700;">üéâ Amazing! Keep it up!</div>' : ''}
    `;
}

// Update footer advance (quick advance management)
function updateFooterAdvance(action) {
    const amt = Number(document.getElementById('footerAdvanceAmount').value);
    if (!amt || amt <= 0) {
        showToast("‚ùå Enter valid amount");
        return;
    }

    const f = getFarmerById(selectedFarmerId);
    if (!f) {
        showToast("‚ö†Ô∏è Select farmer first");
        return;
    }

    // Initialize advance history if not exists
    if (!f.advanceHistory) {
        f.advanceHistory = [];
    }

    if (action === 'give') {
        // GIVE ADVANCE
        f.advance = (f.advance || 0) + amt;
        f.balance = (f.balance || 0) - amt;

        // Record in advance ledger
        f.advanceHistory.push({
            id: 'adv_' + Date.now(),
            type: 'give',
            amount: amt,
            date: new Date().toISOString(),
            note: 'Advance given',
            balance: f.advance
        });

        saveFarmers(farmers);
        document.getElementById('footerAdvanceAmount').value = '';
        showToast(`${formatAmount(amt)} advance given ‚úÖ`);
        renderAll();
    } else {
        // CUT ADVANCE
        if (f.advance < amt) {
            showToast(`‚ö†Ô∏è Insufficient advance! Current: ${formatAmount(f.advance)}`);
            return;
        }

        f.advance = (f.advance || 0) - amt;
        f.balance = (f.balance || 0) + amt;

        // Record in advance ledger
        f.advanceHistory.push({
            id: 'cut_' + Date.now(),
            type: 'cut',
            amount: amt,
            date: new Date().toISOString(),
            note: 'Advance cut from milk payment',
            balance: f.advance
        });

        saveFarmers(farmers);
        document.getElementById('footerAdvanceAmount').value = '';
        showToast(`${formatAmount(amt)} advance cut ‚úÖ`);
        renderAll();
    }
}

// Toggle footer advance section visibility
function toggleFooterAdvance() {
    const section = document.getElementById('footerAdvanceSection');
    if (section.style.display === 'none') {
        section.style.display = 'block';
        document.getElementById('footerAdvanceAmount').focus();
    } else {
        section.style.display = 'none';
    }
}

// Update farmer advance - WITH COMPLETE LEDGER TRACKING
function updateFarmerAdvance(action) {
    // Get action from parameter or from select dropdown
    if (!action) {
        action = el("transAction") ? el("transAction").value : 'give';
    }
    
    const amt = Number(el("advAmount").value);
    if (!amt || amt <= 0) {
        showToast("‚ùå Enter valid amount");
        return;
    }

    const f = getFarmerById(selectedFarmerId);
    if (!f) return;

    // Initialize advance history if not exists
    if (!f.advanceHistory) {
        f.advanceHistory = [];
    }

    if (action === 'give') {
        // GIVE ADVANCE - Add to history
        f.advance = (f.advance || 0) + amt;
        f.balance = (f.balance || 0) - amt;

        // Record in advance ledger
        f.advanceHistory.push({
            id: 'adv_' + Date.now(),
            type: 'give',
            amount: amt,
            date: new Date().toISOString(),
            note: 'Advance given',
            balance: f.advance
        });

        showToast(`${formatAmount(amt)} advance given ‚úÖ`);
    } else if (action === 'payment') {
        // RECORD PAYMENT - Customer pays back credit/udhari
        // This REDUCES their balance (they owe less now)
        f.balance = (f.balance || 0) - amt;
        
        // If balance goes negative, it means they have advance credit
        if (f.balance < 0) {
            f.advance = Math.abs(f.balance);
        }

        // Record in advance ledger
        f.advanceHistory.push({
            id: 'pay_' + Date.now(),
            type: 'payment',
            amount: amt,
            date: new Date().toISOString(),
            note: 'Payment received (credit reduced)',
            balance: f.balance
        });

        // ALSO save to sales history for Customer Ledger
        const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
        const paymentRecord = {
            id: 'payment_' + Date.now(),
            date: new Date().toLocaleDateString(),
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            customer: f.name,
            products: 'Payment received',
            amount: amt,
            paidAmount: amt.toString(),
            creditAmount: '0.00',
            method: 'Cash In', // Payment is like cash in from customer
            cartItems: [],
            createdAt: Date.now()
        };
        history.push(paymentRecord);
        localStorage.setItem('mr_sales_history', JSON.stringify(history));

        showToast(`${formatAmount(amt)} payment recorded! Credit reduced ‚úÖ`);
    } else {
        // CUT ADVANCE
        if ((f.advance || 0) < amt) {
            showToast("‚ùå Insufficient advance");
            return;
        }

        // CUT ADVANCE - Add to history
        f.advance = (f.advance || 0) - amt;
        f.balance = (f.balance || 0) + amt;

        // Record in advance ledger
        f.advanceHistory.push({
            id: 'adv_' + Date.now(),
            type: 'cut',
            amount: amt,
            date: new Date().toISOString(),
            note: 'Advance cut from balance',
            balance: f.advance
        });

        showToast(`${formatAmount(amt)} advance cut ‚úÖ`);
    }

    saveFarmers(farmers);
    el("advAmount").value = '';

    // Refresh modal with advance history
    openFarmerDetail(selectedFarmerId);
    loadAdvanceHistory(selectedFarmerId);
}

// Load and display advance history ledger
function loadAdvanceHistory(fId) {
    const f = getFarmerById(fId);
    if (!f) return;
    
    const historyList = document.getElementById('advanceHistoryList');
    if (!historyList) return;
    
    const history = f.advanceHistory || [];
    
    if (history.length === 0) {
        historyList.innerHTML = `
          <div style="padding: 40px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 10px;">üìí</div>
            <div style="font-size: 16px; font-weight: 700; color: #64748b; margin-bottom: 5px;">No advance records yet</div>
            <div style="font-size: 13px; color: #94a3b8;">Use Give/Cut buttons to manage advance</div>
          </div>`;
        return;
    }
    
    // Sort by date (newest first)
    const sorted = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    let html = `
      <div style="background: #f0f9ff; padding: 12px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #0284c7;">
        <div style="display: flex; justify-content: space-between; font-size: 13px;">
          <span style="font-weight: 700; color: #0369a1;">üìí Advance Ledger:</span>
          <span style="color: #0369a1;">${history.length} transactions</span>
        </div>
      </div>
    `;
    
    sorted.forEach((h, i) => {
        const date = new Date(h.date);
        const isGive = h.type === 'give';
        
        html += `
          <div style="display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #e2e8f0; ${i === 0 ? 'background: #fef3c7;' : ''}">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <span style="font-size: 18px;">${isGive ? '‚ûï' : '‚ûñ'}</span>
                <div>
                  <div style="font-weight: 700; font-size: 13px; color: ${isGive ? '#16a34a' : '#dc2626'};">
                    ${isGive ? 'üíµ Advance GIVEN' : '‚úÇÔ∏è Advance CUT'}
                  </div>
                  <div style="font-size: 11px; color: #64748b;">${h.note}</div>
                </div>
              </div>
              <div style="font-size: 11px; color: #64748b;">
                üìÖ ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 700; font-size: 16px; color: ${isGive ? '#16a34a' : '#dc2626'};">
                ${isGive ? '+' : '-'}${formatAmount(h.amount)}
              </div>
              <div style="color: #64748b; font-size: 11px; margin-top: 4px;">
                Balance: ${formatAmount(h.balance)}
              </div>
              ${i === 0 ? '<div style="color: #f59e0b; font-size: 10px; font-weight: 700; margin-top: 4px;">‚¨ÖÔ∏è LATEST</div>' : ''}
            </div>
          </div>
        `;
    });
    
    historyList.innerHTML = html;
}

// Send WhatsApp summary
function sendFarmerWhatsAppSummary() {
    const f = getFarmerById(selectedFarmerId);
    if (!f || !f.phone) {
        // Open edit phone modal instead of toast
        openEditPhoneModal();
        return;
    }
    
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthEntries = entries.filter(e => e.farmerId === f.id && new Date(e.createdAt) >= monthStart);
    const totalMilk = monthEntries.reduce((sum, e) => sum + Number(e.qty || 0), 0);
    const totalAmt = monthEntries.reduce((sum, e) => sum + Number(e.amount || 0), 0);
    
    const msg = `*ü•õ Monthly Summary - ${f.name}*\n` +
                `üìÖ ${now.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' })}\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `üìä Total Milk: ${totalMilk.toFixed(1)} L\n` +
                `üí∞ Total Amount: ${formatAmount(totalAmt)}\n` +
                `üìí Current Balance: ${formatAmount(f.balance || 0)}\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `Gopal Dairy Shop`;
    
    const wpUrl = `https://wa.me/91${f.phone}?text=${encodeURIComponent(msg)}`;
    window.open(wpUrl, '_blank');
}

// Copy farmer UPI ID
function copyFarmerUPI() {
    const f = getFarmerById(selectedFarmerId);
    if (!f || !f.upi) {
        showToast('‚ö†Ô∏è UPI ID not set! Edit farmer to add.');
        return;
    }
    
    navigator.clipboard.writeText(f.upi).then(() => {
        showToast('üìã UPI ID copied!');
    }).catch(() => {
        showToast('‚ö†Ô∏è Copy failed');
    });
}

// Record UPI payment
function recordUPIPayment() {
    const f = getFarmerById(selectedFarmerId);
    const amountInput = document.getElementById('upiPaymentAmount');
    const amount = parseFloat(amountInput.value);
    
    if (!f) {
        showToast('‚ö†Ô∏è No farmer selected');
        return;
    }
    
    if (!amount || amount <= 0) {
        showToast('‚ö†Ô∏è Enter valid amount');
        return;
    }
    
    if (f.balance < amount) {
        showToast('‚ö†Ô∏è Amount exceeds balance!');
        return;
    }
    
    // Reduce balance
    f.balance = round2(f.balance - amount);
    saveFarmers(farmers);
    
    // Record in history
    const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
    history.push({
        id: 'upi_' + Date.now(),
        date: new Date().toLocaleDateString(),
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        customer: f.name,
        products: 'UPI Payment',
        amount: amount.toString(),
        paidAmount: amount.toString(),
        creditAmount: '0.00',
        method: 'UPI',
        cartItems: [],
        createdAt: Date.now()
    });
    localStorage.setItem('mr_sales_history', JSON.stringify(history));
    
    amountInput.value = '';
    showToast(`‚úÖ UPI Payment ${formatAmount(amount)} recorded!`);
    
    // Refresh modal
    openFarmerDetail(selectedFarmerId);
}

// Print farmer statement
function printFarmerStatement() {
    const f = getFarmerById(selectedFarmerId);
    if (!f) return;
    
    const allEntries = entries.filter(e => e.farmerId === f.id);
    const printWindow = window.open('', '_blank');
    
    let html = `<!DOCTYPE html><html><head><title>Statement - ${f.name}</title>`;
    html += `<style>
      body { font-family: Arial; padding: 20px; }
      .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
      th { background: #f3f4f6; }
      .total { font-weight: bold; background: #fef3c7; }
      @media print { .no-print { display: none; } }
    </style></head><body>`;
    
    html += `<div class="header">
      <h2>ü•õ Farmer Statement</h2>
      <p><strong>${f.name}</strong>${f.serial ? ` (#${f.serial})` : ''}</p>
      <p>Phone: ${f.phone || '‚Äî'} | Generated: ${new Date().toLocaleString()}</p>
    </div>`;
    
    html += `<table>
      <thead><tr><th>Date</th><th>Type</th><th>Qty</th><th>Rate</th><th>Amount</th></tr></thead>
      <tbody>`;
    
    let total = 0;
    allEntries.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(e => {
      total += Number(e.amount || 0);
      html += `<tr>
        <td>${new Date(e.createdAt).toLocaleDateString()}</td>
        <td>${e.paymentMode === 'Cash' ? 'üíµ Cash' : e.paymentMode === 'UPI' ? 'üì± UPI' : e.paymentMode === 'Account' ? 'üè¶ Account' : 'üìí Credit'}</td>
        <td>${e.qty}L</td>
        <td>‚Çπ${e.rateSnapshot || e.ratePerL || 0}/L</td>
        <td>‚Çπ${e.amount}</td>
      </tr>`;
    });
    
    html += `<tr class="total"><td colspan="4">TOTAL</td><td>‚Çπ${total}</td></tr>`;
    html += `</tbody></table>`;
    html += `<div style="margin-top: 20px; padding: 10px; background: #f3f4f6;">
      <strong>Current Balance:</strong> ${formatAmount(f.balance || 0)} | 
      <strong>Advance:</strong> ${formatAmount(f.advance || 0)}
    </div>`;
    html += `<button class="no-print" onclick="window.print(); window.close();" style="margin-top: 20px; padding: 10px 20px; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer;">üñ®Ô∏è Print</button>`;
    html += `</body></html>`;
    
    printWindow.document.write(html);
    printWindow.document.close();
}

// ========== COMPREHENSIVE LEDGER MANAGEMENT ==========

// Open ledger management modal
function openLedgerManagement() {
    openOverlay('overlayLedgerManagement');
    loadLedgerData();
}

// Load all ledger data
function loadLedgerData() {
    // Set default dates (current month)
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
    document.getElementById('ledgerFromDate').value = firstDay.toISOString().split('T')[0];
    document.getElementById('ledgerToDate').value = now.toISOString().split('T')[0];
    
    // Update summary cards
    updateLedgerSummary();
    
    // Load default view (all farmers)
    loadAllFarmersList();
}

// Update summary cards
function updateLedgerSummary() {
    // Total farmers
    const activeFarmers = farmers.filter(f => f.active !== false);
    el('sumTotalFarmers').textContent = activeFarmers.length;
    
    // Total advance
    const totalAdvance = activeFarmers.reduce((sum, f) => sum + (f.advance || 0), 0);
    el('sumTotalAdvance').textContent = formatAmount(totalAdvance);
    
    // Total credit (udhari)
    const totalCredit = entries.filter(e => e.paymentMode === 'Credit').reduce((sum, e) => sum + (e.amount || 0), 0);
    el('sumTotalCredit').textContent = formatAmount(totalCredit);
    
    // Cash collected
    const totalCash = entries.filter(e => e.paymentMode === 'Cash').reduce((sum, e) => sum + (e.amount || 0), 0);
    el('sumCashCollected').textContent = formatAmount(totalCash);
    
    // Today's milk
    const today = fmtDate(new Date());
    const todayMilk = entries.filter(e => e.day === today).reduce((sum, e) => sum + (e.qty || 0), 0);
    el('sumTodayMilk').textContent = `${todayMilk.toFixed(1)} L`;
}

// Switch ledger view
function switchLedgerView() {
    const view = el('ledgerView').value;
    
    // Hide all lists
    ['advancesList', 'creditsList', 'allFarmersList', 'todayList'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });
    
    // Show selected view
    if (view === 'advances') {
        document.getElementById('advancesList').style.display = 'block';
        loadAdvancesList();
    } else if (view === 'credits') {
        document.getElementById('creditsList').style.display = 'block';
        loadCreditsList();
    } else if (view === 'today') {
        document.getElementById('todayList').style.display = 'block';
        loadTodayCollection();
    } else {
        document.getElementById('allFarmersList').style.display = 'block';
        loadAllFarmersList();
    }
}

// Load all farmers master list
function loadAllFarmersList() {
    const table = document.getElementById('farmersTable');
    const filtered = filterLedgerData();
    
    if (filtered.length === 0) {
        table.innerHTML = '<div style="padding: 40px; text-align: center; color: #94a3b8;">No farmers found</div>';
        return;
    }
    
    let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
    html += '<thead><tr style="background: #f1f5f9;">';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">üë§ Farmer</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">üì± Phone</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">üè∑Ô∏è Serial</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">ü•õ Animal</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">üìç Address</th>';
    html += '<th style="padding: 12px; text-align: right; border: 1px solid #e2e8f0;">üí∞ Advance</th>';
    html += '<th style="padding: 12px; text-align: right; border: 1px solid #e2e8f0;">üíµ Balance</th>';
    html += '<th style="padding: 12px; text-align: center; border: 1px solid #e2e8f0;">Actions</th>';
    html += '</tr></thead><tbody>';
    
    filtered.forEach(f => {
        const totalMilk = entries.filter(e => e.farmerId === f.id).reduce((sum, e) => sum + (e.qty || 0), 0);
        const totalPaid = entries.filter(e => e.farmerId === f.id).reduce((sum, e) => sum + (e.amount || 0), 0);
        
        html += `<tr style="border-bottom: 1px solid #e2e8f0;" ondblclick="openFarmerDetail('${f.id}')">`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;"><strong>${f.name}</strong>${f.serial ? ` <span style="color: #3b82f6;">(#${f.serial})</span>` : ''}</td>`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;">${f.phone || '‚Äî'}</td>`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;">${f.serial || '‚Äî'}</td>`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;">${f.animalType === 'cow' ? 'üêÑ Cow' : f.animalType === 'buffalo' ? 'üêÉ Buffalo' : 'üîÑ Both'}</td>`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;">${f.address || '‚Äî'}</td>`;
        html += `<td style="padding: 12px; text-align: right; border: 1px solid #e2e8f0; color: ${f.advance > 0 ? '#dc2626' : '#16a34a'}; font-weight: 700;">${formatAmount(f.advance || 0)}</td>`;
        html += `<td style="padding: 12px; text-align: right; border: 1px solid #e2e8f0; color: ${f.balance > 0 ? '#dc2626' : '#16a34a'}; font-weight: 700;">${formatAmount(f.balance || 0)}</td>`;
        html += `<td style="padding: 12px; text-align: center; border: 1px solid #e2e8f0;">`;
        html += `<button onclick="openFarmerDetail('${f.id}')" style="padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; margin-right: 4px;">üìã View</button>`;
        html += `<button onclick="sendFarmerReceipt('${f.id}')" style="padding: 4px 8px; background: #25d366; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">üí¨ Receipt</button>`;
        html += `</td></tr>`;
    });
    
    html += '</tbody></table></div>';
    table.innerHTML = html;
}

// Load advances list (with delivery date & address)
function loadAdvancesList() {
    const table = document.getElementById('advancesTable');
    const advances = [];
    
    // Collect all advance transactions from all farmers
    farmers.forEach(f => {
        if (f.advanceHistory && f.advanceHistory.length > 0) {
            f.advanceHistory.forEach(h => {
                if (h.type === 'give') {
                    advances.push({
                        farmer: f.name,
                        phone: f.phone,
                        serial: f.serial,
                        address: f.address || f.city || '‚Äî',
                        amount: h.amount,
                        date: h.date,
                        balance: h.balance
                    });
                }
            });
        }
    });
    
    if (advances.length === 0) {
        table.innerHTML = '<div style="padding: 40px; text-align: center; color: #94a3b8;">No advance deposits recorded</div>';
        return;
    }
    
    // Sort by date (newest first)
    advances.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
    html += '<thead><tr style="background: #fef3c7;">';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">üìÖ Date</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">üë§ Farmer</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">üìç Delivery Address</th>';
    html += '<th style="padding: 12px; text-align: right; border: 1px solid #e2e8f0;">üí∞ Amount</th>';
    html += '<th style="padding: 12px; text-align: right; border: 1px solid #e2e8f0;">üìí Balance</th>';
    html += '<th style="padding: 12px; text-align: center; border: 1px solid #e2e8f0;">Actions</th>';
    html += '</tr></thead><tbody>';
    
    advances.forEach(a => {
        const date = new Date(a.date);
        html += `<tr style="border-bottom: 1px solid #e2e8f0;">`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;">${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;"><strong>${a.farmer}</strong>${a.serial ? ` <span style="color: #3b82f6;">(#${a.serial})</span>` : ''}<br><span style="color: #64748b; font-size: 11px;">${a.phone || '‚Äî'}</span></td>`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;">${a.address}</td>`;
        html += `<td style="padding: 12px; text-align: right; border: 1px solid #e2e8f0; color: #16a34a; font-weight: 700;">+${formatAmount(a.amount)}</td>`;
        html += `<td style="padding: 12px; text-align: right; border: 1px solid #e2e8f0; font-weight: 700;">${formatAmount(a.balance)}</td>`;
        html += `<td style="padding: 12px; text-align: center; border: 1px solid #e2e8f0;">`;
        html += `<button onclick="sendAdvanceReceipt('${a.farmer}', '${a.amount}', '${a.date}')" style="padding: 4px 8px; background: #25d366; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">üí¨ WhatsApp</button>`;
        html += `</td></tr>`;
    });
    
    html += '</tbody></table></div>';
    table.innerHTML = html;
}

// Load credits/udhari list (date-wise)
function loadCreditsList() {
    const table = document.getElementById('creditsTable');
    const credits = entries.filter(e => e.paymentMode === 'Credit');
    
    console.log('üîµ Loading Credits List:', credits.length, 'entries');
    console.log('üîµ All entries:', entries.length);
    console.log('üîµ Credit entries:', credits.map(c => ({name: c.farmerName, amount: c.amount, mode: c.paymentMode})));

    if (credits.length === 0) {
        table.innerHTML = '<div style="padding: 40px; text-align: center; color: #94a3b8;">No credit (udhari) records</div>';
        return;
    }

    // Sort by date (newest first)
    credits.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

    let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
    html += '<thead><tr style="background: #fef2f2;">';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">üìÖ Date</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">üë§ Farmer</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">ü•õ Details</th>';
    html += '<th style="padding: 12px; text-align: right; border: 1px solid #e2e8f0;">üìí Amount</th>';
    html += '<th style="padding: 12px; text-align: center; border: 1px solid #e2e8f0;">Actions</th>';
    html += '</tr></thead><tbody>';

    credits.forEach(c => {
        const date = new Date(c.createdAt);
        html += `<tr style="border-bottom: 1px solid #e2e8f0;">`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;">${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;"><strong>${c.farmerName}</strong></td>`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;">${c.qty}L @ ‚Çπ${c.rateSnapshot || c.ratePerL || 0}/L (Fat: ${c.fat}%)</td>`;
        html += `<td style="padding: 12px; text-align: right; border: 1px solid #e2e8f0; color: #dc2626; font-weight: 700;">${formatAmount(c.amount)}</td>`;
        html += `<td style="padding: 12px; text-align: center; border: 1px solid #e2e8f0;">`;
        html += `<button onclick="sendCreditReminder('${c.farmerId}', '${c.amount}')" style="padding: 4px 8px; background: #dc2626; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">üí¨ Reminder</button>`;
        html += `</td></tr>`;
    });

    html += '</tbody></table></div>';
    table.innerHTML = html;
    console.log('‚úÖ Credits table rendered');
}

// Load today's collection
function loadTodayCollection() {
    const table = document.getElementById('todayTable');
    const today = fmtDate(new Date());
    const todayEntries = entries.filter(e => e.day === today);
    
    if (todayEntries.length === 0) {
        table.innerHTML = '<div style="padding: 40px; text-align: center; color: #94a3b8;">No collection today yet</div>';
        return;
    }
    
    // Sort by time (newest first)
    todayEntries.sort((a, b) => b.createdAt - a.createdAt);
    
    let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
    html += '<thead><tr style="background: #f0f9ff;">';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">‚è∞ Time</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">üë§ Farmer</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">ü•õ Qty</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">üß™ Fat</th>';
    html += '<th style="padding: 12px; text-align: right; border: 1px solid #e2e8f0;">üí∞ Rate</th>';
    html += '<th style="padding: 12px; text-align: right; border: 1px solid #e2e8f0;">üíµ Amount</th>';
    html += '<th style="padding: 12px; text-align: center; border: 1px solid #e2e8f0;">Payment</th>';
    html += '</tr></thead><tbody>';
    
    todayEntries.forEach(e => {
        const time = new Date(e.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        html += `<tr style="border-bottom: 1px solid #e2e8f0;">`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;">${time}</td>`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;"><strong>${e.farmerName}</strong></td>`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;">${e.qty} L</td>`;
        html += `<td style="padding: 12px; border: 1px solid #e2e8f0;">${e.fat}%</td>`;
        html += `<td style="padding: 12px; text-align: right; border: 1px solid #e2e8f0;">‚Çπ${e.rateSnapshot || e.ratePerL || 0}/L</td>`;
        html += `<td style="padding: 12px; text-align: right; border: 1px solid #e2e8f0; font-weight: 700;">${formatAmount(e.amount)}</td>`;
        html += `<td style="padding: 12px; text-align: center; border: 1px solid #e2e8f0;">${e.paymentMode === 'Cash' ? 'üíµ Cash' : e.paymentMode === 'UPI' ? 'üì± UPI' : e.paymentMode === 'Account' ? 'üè¶ Account' : 'üìí Credit'}</td>`;
        html += `</tr>`;
    });
    
    html += '</tbody></table></div>';
    
    // Add summary
    const totalQty = todayEntries.reduce((sum, e) => sum + (e.qty || 0), 0);
    const totalAmt = todayEntries.reduce((sum, e) => sum + (e.amount || 0), 0);
    html += `<div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; display: flex; justify-content: space-around; font-weight: 700;">`;
    html += `<span>üìä Total: ${totalQty.toFixed(1)} L</span>`;
    html += `<span>üíµ Total: ${formatAmount(totalAmt)}</span>`;
    html += `</div>`;
    
    table.innerHTML = html;
}

// Filter ledger data based on search and dates
function filterLedgerData() {
    const search = (el('ledgerSearch')?.value || '').toLowerCase();
    const fromDate = el('ledgerFromDate')?.value;
    const toDate = el('ledgerToDate')?.value;
    
    return farmers.filter(f => {
        // Search filter
        const matchSearch = !search || 
            (f.name && f.name.toLowerCase().includes(search)) ||
            (f.phone && f.phone.includes(search)) ||
            (f.serial && f.serial.toLowerCase().includes(search));
        
        // Date filter (check if farmer has entries in date range)
        let matchDate = true;
        if (fromDate || toDate) {
            const farmerEntries = entries.filter(e => e.farmerId === f.id);
            if (farmerEntries.length > 0) {
                const entryDates = farmerEntries.map(e => new Date(e.createdAt).toISOString().split('T')[0]);
                if (fromDate && !entryDates.some(d => d >= fromDate)) matchDate = false;
                if (toDate && !entryDates.some(d => d <= toDate)) matchDate = false;
            }
        }
        
        return matchSearch && matchDate;
    });
}

// Filter ledger (called on input change)
function filterLedger() {
    const view = el('ledgerView').value;
    if (view === 'all') loadAllFarmersList();
    else if (view === 'advances') loadAdvancesList();
    else if (view === 'credits') loadCreditsList();
    else if (view === 'today') loadTodayCollection();
    
    updateLedgerSummary();
}

// Send advance receipt via WhatsApp
function sendAdvanceReceipt(farmerName, amount, date) {
    const f = farmers.find(f => f.name === farmerName);
    if (!f || !f.phone) {
        openEditPhoneModal();
        return;
    }
    
    const msg = `*üí∞ Advance Receipt*\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `Farmer: ${farmerName}\n` +
                `Amount: ${formatAmount(Number(amount))}\n` +
                `Date: ${new Date(date).toLocaleString()}\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `Thank you!\nGopal Dairy Shop`;
    
    const wpUrl = `https://wa.me/91${f.phone}?text=${encodeURIComponent(msg)}`;
    window.open(wpUrl, '_blank');
}

// Send credit reminder via WhatsApp
function sendCreditReminder(farmerId, amount) {
    const f = getFarmerById(farmerId);
    if (!f || !f.phone) {
        openEditPhoneModal();
        return;
    }
    
    const msg = `*üìí Payment Reminder*\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `Dear ${f.name},\n\n` +
                `Your outstanding amount: ${formatAmount(Number(amount))}\n\n` +
                `Please settle your payment at your earliest convenience.\n\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `Gopal Dairy Shop`;
    
    const wpUrl = `https://wa.me/91${f.phone}?text=${encodeURIComponent(msg)}`;
    window.open(wpUrl, '_blank');
}

// Send farmer receipt (billing amount)
function sendFarmerReceipt(farmerId) {
    const f = getFarmerById(farmerId);
    if (!f || !f.phone) {
        openEditPhoneModal();
        return;
    }
    
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthEntries = entries.filter(e => e.farmerId === f.id && new Date(e.createdAt) >= monthStart);
    const totalMilk = monthEntries.reduce((sum, e) => sum + Number(e.qty || 0), 0);
    const totalAmt = monthEntries.reduce((sum, e) => sum + Number(e.amount || 0), 0);
    
    const msg = `*üßæ Billing Receipt*\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `Farmer: ${f.name}${f.serial ? ` (#${f.serial})` : ''}\n` +
                `Period: ${now.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' })}\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `üìä Total Milk: ${totalMilk.toFixed(1)} L\n` +
                `üí∞ Total Amount: ${formatAmount(totalAmt)}\n` +
                `üìí Current Balance: ${formatAmount(f.balance || 0)}\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `Thank you for your business!\nGopal Dairy Shop`;
    
    const wpUrl = `https://wa.me/91${f.phone}?text=${encodeURIComponent(msg)}`;
    window.open(wpUrl, '_blank');
}

// Export ledger to Excel (CSV)
function exportLedgerExcel() {
    const filtered = filterLedgerData();
    let csv = 'Farmer,Phone,Serial,Animal,Address,Advance,Balance\n';
    
    filtered.forEach(f => {
        csv += `"${f.name || ''}","${f.phone || ''}","${f.serial || ''}","${f.animalType || ''}","${f.address || ''}",${f.advance || 0},${f.balance || 0}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ledger_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    showToast('üìä Ledger exported to Excel!');
}

// Print ledger report
function printLedgerReport() {
    const filtered = filterLedgerData();
    const printWindow = window.open('', '_blank');
    
    let html = `<!DOCTYPE html><html><head><title>Ledger Report</title>`;
    html += `<style>
      body { font-family: Arial; padding: 20px; }
      .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 8px; text-align: left; border: 1px solid #000; }
      th { background: #f3f4f6; }
      @media print { .no-print { display: none; } }
    </style></head><body>`;
    
    html += `<div class="header">
      <h2>üìí Farmer Ledger Report</h2>
      <p>Generated: ${new Date().toLocaleString()}</p>
    </div>`;
    
    html += `<table>
      <thead><tr><th>Farmer</th><th>Phone</th><th>Serial</th><th>Advance</th><th>Balance</th></tr></thead>
      <tbody>`;
    
    filtered.forEach(f => {
        html += `<tr>
          <td>${f.name || ''}${f.serial ? ` (#${f.serial})` : ''}</td>
          <td>${f.phone || '‚Äî'}</td>
          <td>${f.serial || '‚Äî'}</td>
          <td>‚Çπ${f.advance || 0}</td>
          <td>‚Çπ${f.balance || 0}</td>
        </tr>`;
    });
    
    html += `</tbody></table>`;
    html += `<button class="no-print" onclick="window.print(); window.close();" style="margin-top: 20px; padding: 10px 20px; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer;">üñ®Ô∏è Print</button>`;
    html += `</body></html>`;
    
    printWindow.document.write(html);
    printWindow.document.close();
}

// Send bulk WhatsApp to all farmers
function sendBulkWhatsApp() {
    const filtered = filterLedgerData();
    if (filtered.length === 0) {
        showToast('‚ùå No farmers to send');
        return;
    }
    
    const count = confirm(`Send WhatsApp messages to ${filtered.length} farmers?`);
    if (!count) return;
    
    let sent = 0;
    filtered.forEach(f => {
        if (f.phone) {
            const msg = `*üìä Monthly Update - ${f.name}*\n` +
                       `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                       `Current Balance: ${formatAmount(f.balance || 0)}\n` +
                       `Advance: ${formatAmount(f.advance || 0)}\n` +
                       `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                       `Gopal Dairy Shop`;
            
            const wpUrl = `https://wa.me/91${f.phone}?text=${encodeURIComponent(msg)}`;
            window.open(wpUrl, '_blank');
            sent++;
        }
    });
    
    showToast(`üí¨ Sent to ${sent} farmers!`);
}

// ========== END LEDGER MANAGEMENT ==========

// Open farmer transaction history (double-click) - COMPREHENSIVE LOG
function openFarmerTransactions(fId) {
    const f = getFarmerById(fId);
    if (!f) return;

    selectedFarmerId = fId;
    el("transFarmerName").textContent = f.name + (f.serial ? ` (#${f.serial})` : '');
    
    // Show farmer payment details
    const paymentDetailsEl = el("farmerPaymentDetails");
    if (paymentDetailsEl) {
        let detailsHtml = '';
        if (f.upi) detailsHtml += `<div><strong>üì± UPI ID:</strong> ${f.upi}</div>`;
        if (f.bankName) detailsHtml += `<div><strong>üè¶ Bank:</strong> ${f.bankName}</div>`;
        if (f.accountNo) detailsHtml += `<div><strong>üî¢ Account:</strong> ${f.accountNo}</div>`;
        if (f.ifsc) detailsHtml += `<div><strong>üîë IFSC:</strong> ${f.ifsc}</div>`;
        if (f.accountName) detailsHtml += `<div><strong>üë§ Account Name:</strong> ${f.accountName}</div>`;
        if (f.phone) detailsHtml += `<div><strong>üì± Phone:</strong> ${f.phone}</div>`;
        if (f.address) detailsHtml += `<div><strong>üìç Address:</strong> ${f.address}</div>`;
        if (f.city) detailsHtml += `<div><strong>üèôÔ∏è City:</strong> ${f.city}${f.pincode ? ` - ${f.pincode}` : ''}</div>`;
        
        if (detailsHtml) {
            paymentDetailsEl.innerHTML = detailsHtml;
        } else {
            paymentDetailsEl.innerHTML = '<div style="color: #64748b; font-style: italic;">No payment details added yet</div>';
        }
    }

    // Get ALL entries for this farmer (not just current month)
    const allEntries = entries.filter(e => e.farmerId === fId);

    // Calculate total milk
    const totalMilk = allEntries.reduce((sum, e) => sum + Number(e.qty || 0), 0);
    el("transTotalMilk").textContent = `${totalMilk.toFixed(1)} L (All Time)`;
    el("transCurrentAdvance").textContent = formatAmount(f.advance || 0);

    // Generate COMPREHENSIVE transaction list
    const transList = el("transList");
    const transactions = [];

    // 1. Add ALL milk entries with full details
    allEntries.forEach(e => {
        const rate = e.rateSnapshot || e.ratePerL || 0;
        const paymentMode = e.paymentMode || 'Cash';
        const isCredit = paymentMode === 'Credit';

        transactions.push({
            date: new Date(e.createdAt),
            type: isCredit ? 'credit' : 'sale',
            category: 'milk',
            description: `ü•õ ${e.qty}L @ ${formatAmount(rate)}/L (Fat: ${e.fat}%, SNF: ${e.snf || 0}%)`,
            paymentMode: isCredit ? 'üìí Credit (Likh Lo)' : `üíµ ${paymentMode}`,
            amount: Number(e.amount),
            balance: 0,
            entryId: e.id,
            edited: e.edited,
            editedAt: e.editedAt
        });
    });

    // 2. Add Cash In / Cash Out from history
    const history = JSON.parse(localStorage.getItem('mr_sales_history') || '[]');
    history.forEach(h => {
        if (h.customer === f.name) {
            if (h.method === 'Cash In') {
                transactions.push({
                    date: new Date(h.createdAt || Date.now()),
                    type: 'cash_in',
                    category: 'cash_flow',
                    description: `üí∞ Cash In: ${h.products || 'Cash received'}`,
                    paymentMode: 'üí∞ Income',
                    amount: -Number(h.amount), // Negative = farmer gave us money (reduces their balance)
                    balance: 0,
                    entryId: h.id
                });
            } else if (h.method === 'Cash Out') {
                transactions.push({
                    date: new Date(h.createdAt || Date.now()),
                    type: 'cash_out',
                    category: 'cash_flow',
                    description: `üí∏ Cash Out: ${h.products || 'Cash paid'}`,
                    paymentMode: 'üí∏ Expense',
                    amount: Number(h.amount), // Positive = we gave money (increases their balance)
                    balance: 0,
                    entryId: h.id
                });
            }
        }
    });

    // Sort by date (newest first)
    transactions.sort((a, b) => b.date - a.date);

    // Calculate running balance
    let balance = f.balance || 0;
    transactions.forEach(t => {
        t.balance = balance;
        if (t.category === 'milk') {
            balance -= t.amount;
        } else if (t.category === 'cash_flow') {
            balance += t.amount; // Cash In (negative) reduces balance, Cash Out (positive) increases
        }
    });

    if (transactions.length === 0) {
        transList.innerHTML = `
          <div style="padding: 40px 20px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
            <div style="font-size: 16px; font-weight: 700; color: #64748b; margin-bottom: 5px;">No transactions yet</div>
            <div style="font-size: 13px; color: #94a3b8;">Double-click farmer to view entries</div>
          </div>`;
    } else {
        // Group by month
        let currentMonth = '';
        
        transList.innerHTML = `
          <div style="background: #f0f9ff; padding: 12px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #0284c7;">
            <div style="display: flex; justify-content: space-between; font-size: 13px;">
              <span style="font-weight: 700; color: #0369a1;">üìä Summary:</span>
              <span style="color: #0369a1;">${transactions.length} transactions | Total: ${formatAmount(transactions.reduce((sum, t) => sum + t.amount, 0))}</span>
            </div>
          </div>
        ` + transactions.map((t, index) => {
            const month = t.date.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
            const showMonth = month !== currentMonth;
            currentMonth = month;
            
            let icon = t.type === 'credit' ? 'üìí' : (t.type === 'cash_in' ? 'üí∞' : (t.type === 'cash_out' ? 'üí∏' : 'üíµ'));
            let amountColor = t.type === 'cash_in' ? '#16a34a' : (t.type === 'cash_out' ? '#f59e0b' : '#dc2626');
            let amountPrefix = t.type === 'cash_in' ? '+' : '-';
            
            return `
            ${showMonth ? `<div style="background:#f8fafc; padding:8px 12px; font-size:12px; font-weight:700; color:#64748b; border-bottom:1px solid #e2e8f0; position:sticky; top:0;">üìÖ ${month}</div>` : ''}
            <div style="display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #e2e8f0; ${index === 0 ? 'background: #fef3c7;' : ''} ${t.edited ? 'background:#fef3c7;' : ''}" onclick="${t.entryId ? `showAuditProof('${t.entryId}')` : ''}" style="cursor:${t.entryId ? 'pointer' : 'default'}">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <span style="font-size: 16px;">${icon}</span>
                        <div style="font-weight: 700; font-size: 13px;">${t.description}</div>
                    </div>
                    <div style="display: flex; gap: 12px; font-size: 11px; color: #64748b;">
                        <span>üìÖ ${t.date.toLocaleDateString()} ${t.date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        <span>‚Ä¢</span>
                        <span style="color: ${amountColor}; font-weight: 600;">${t.paymentMode}</span>
                        ${t.edited ? `<span>‚Ä¢ ‚úèÔ∏è Edited ${new Date(t.editedAt).toLocaleString()}</span>` : ''}
                    </div>
                </div>
                <div style="text-align: right; min-width: 120px;">
                    <div style="font-weight: 900; color: ${amountColor}; font-size: 14px;">${amountPrefix}${formatAmount(Math.abs(t.amount))}</div>
                    <div style="color: #64748b; font-size: 11px; margin-top: 4px;">Bal: ${formatAmount(t.balance)}</div>
                    ${index === 0 ? '<div style="color: #f59e0b; font-size: 10px; font-weight: 700; margin-top: 4px;">‚¨ÖÔ∏è LATEST</div>' : ''}
                </div>
            </div>
            `;
        }).join('');
    }

    openOverlay("overlayFarmerTransactions");
}

function sendFarmerSummary() {
    const f = getFarmerById(selectedFarmerId);
    if (!f) return;

    const totalMilk = el("transTotalMilk").textContent;
    const currentAdv = el("transCurrentAdvance").textContent;
    const currentBal = formatAmount(f.balance || 0);
    const monthName = new Date().toLocaleString('default', { month: 'long' });
    
    const msg = `*Milk Summary - ${monthName}*
---------------------------
*Kisan:* ${f.name}
*Total Milk:* ${totalMilk}
*Current Advance:* ${currentAdv}
*Net Balance:* ${currentBal}
---------------------------
Gopal Dairy Shop`;
    
    const wpUrl = f.phone ? `https://wa.me/${f.phone}?text=${encodeURIComponent(msg)}` : `https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(wpUrl, '_blank');
    showToast("Summary sent üí¨");
}

function sendDailySummary() {
    const today = fmtDate(new Date());
    // Aaj ki saari entries filter karein
    const todays = entries.filter(e => e.day === today && e.farmerId === selectedFarmerId);

    if (todays.length === 0) {
        showToast("No records found for this farmer today!");
        return;
    }

    // Total ka calculation karein
    let totalQty = 0;
    let totalAmt = 0;
    let detailMsg = "";

    todays.forEach((e, index) => {
        totalQty += Number(e.qty);
        totalAmt += Number(e.amount);
        detailMsg += `\n${index + 1}. ${e.session}: ${e.qty}L | ${formatAmount(e.amount)}`;
    });

    const farmer = getFarmerById(selectedFarmerId);
    const phone = farmer ? farmer.phone : "";

    // Naya Summary Message Template
    const summaryMsg = `*DAIRY DAILY SUMMARY* üìä\n` +
                       `Date: ${today}\n` +
                       `Farmer: ${farmer.name}\n` +
                       `--------------------------` +
                       `${detailMsg}\n` +
                       `--------------------------\n` +
                       `*Total Milk: ${totalQty.toFixed(1)} L*\n` +
                       `*Total Amount: ${formatAmount(totalAmt)}*\n\n` +
                       `Gopal Dairy Shop üôè`;

    if (phone) {
        const wpLink = `https://wa.me/${phone}?text=${encodeURIComponent(summaryMsg)}`;
        window.open(wpLink, '_blank');
        showToast("Summary Sent! üìä‚úÖ");
    } else {
        openEditPhoneModal();
    }
}

// Apply roundup for farmer balance - this becomes the FINAL accepted amount
function applyFarmerRoundup() {
  const roundValue = parseInt(el("farmerRoundupInput").value) || 0;
  const roundupLabel = el("farmerRoundupLabel");
  const roundupValue = el("farmerRoundupValue");
  const balAfter = el("balAfter");
  const finalAmountInput = el("finalAmountInput");

  if (roundValue > 0 && balAfter) {
    const currentBal = parseFloat(balAfter.textContent.replace('‚Çπ', '')) || 0;
    const rounded = Math.round(currentBal / roundValue) * roundValue;

    if (roundupLabel) {
      roundupLabel.style.display = 'flex';
      const diff = rounded - currentBal;
      if (diff >= 0) {
        roundupValue.textContent = `+${diff.toFixed(0)}`;
        roundupValue.style.color = '#16a34a';
      } else {
        roundupValue.textContent = diff.toFixed(0);
        roundupValue.style.color = '#dc2626';
      }
    }

    // Update balance display to show rounded (final accepted) value
    balAfter.textContent = formatAmount(rounded);
    
    // Auto-fill final amount input
    if (finalAmountInput) {
      finalAmountInput.value = round2(rounded).toFixed(2);
    }
  } else {
    if (roundupLabel) roundupLabel.style.display = 'none';
    // Re-render to restore original balance
    renderTrust();
  }
}

// Save final accepted amount for current farmer
function saveFinalAmount() {
  const finalAmountInput = el("finalAmountInput");
  if (!finalAmountInput || !selectedFarmerId) return;
  
  const finalAmount = parseFloat(finalAmountInput.value) || 0;
  
  // Save to localStorage per farmer
  const key = `farmer_final_amount_${selectedFarmerId}`;
  localStorage.setItem(key, finalAmount.toString());
  
  console.log(`üíæ Saved final amount ‚Çπ${finalAmount.toFixed(2)} for farmer ${selectedFarmerId}`);
}

// Load saved final amount for current farmer
function loadFinalAmount() {
  const finalAmountInput = el("finalAmountInput");
  if (!finalAmountInput || !selectedFarmerId) return;
  
  const key = `farmer_final_amount_${selectedFarmerId}`;
  const savedAmount = localStorage.getItem(key);
  
  if (savedAmount) {
    finalAmountInput.value = savedAmount;
    console.log(`üîÑ Loaded saved final amount ‚Çπ${savedAmount} for farmer ${selectedFarmerId}`);
  } else {
    finalAmountInput.value = '';
  }
}

function updatePayUI() {
    // 1. Check karo kaunsa radio button select hua hai
    const isCash = document.querySelector('input[name="payMode"]:checked').value === 'Cash';
    
    const cashDiv = el("optCash");
    const creditDiv = el("optCredit");

    if (isCash) {
        // Cash select hone par Green
        cashDiv.style.border = "2px solid var(--green)";
        cashDiv.style.background = "var(--soft-green)";
        creditDiv.style.border = "1px solid var(--line)";
        creditDiv.style.background = "#fff";
        showToast("Mode: ‡§®‡§ï‡§¶ (Cash) üí∞");
    } else {
        // Udhaar select hone par Red
        creditDiv.style.border = "2px solid var(--red)";
        creditDiv.style.background = "var(--soft-pink)";
        cashDiv.style.border = "1px solid var(--line)";
        cashDiv.style.background = "#fff";
        showToast("Mode: ‡§â‡§ß‡§æ‡§∞ (Credit) ‚úçÔ∏è");
    }
}
// Button ko tabhi dikhana jab koi entry ho
function updateDailySummaryButton() {
    const today = fmtDate(new Date());
    const hasEntries = entries.some(e => e.day === today);
    const wrapper = el("dailySummaryWrapper");
    if (wrapper) {
        wrapper.style.display = hasEntries ? "block" : "none";
    }
}
// ... iske niche init(); function hona chahiye ...

// ESC Key Handler for ALL Modals (EXCEPT farmer form - has its own handler)
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    // Skip farmer form - it has dedicated ESC handler that requires confirmation
    const farmerModal = document.getElementById('overlayFarmer');
    if (farmerModal && farmerModal.style.display === 'flex') {
      return; // Let the dedicated farmer modal ESC handler manage it
    }
    
    // Method 1: Close using closeOverlay function
    const overlays = [
      'overlayFarmerDetail',
      'overlayReceipt',
      'overlayEntryDetail',
      'overlayPayment',
      'overlayHold',
      'overlayRateEditor',
      'overlayHistory',
      'overlayLeader',
      'overlaySettings',
      'overlayCenterSummary',
      'overlayDispatch',
      'overlayBMCReconcile',
      'overlayPaymentObligation',
      'overlayLedgerManagement'
    ];

    overlays.forEach(id => {
      const overlay = document.getElementById(id);
      if (overlay && overlay.style.display === 'flex') {
        if (typeof closeOverlay === 'function') {
          closeOverlay(id);
        }
      }
    });

    // Method 2: Click any visible close button with data-close attribute
    document.querySelectorAll('[data-close]').forEach(btn => {
      const overlayId = btn.getAttribute('data-close');
      const overlay = document.getElementById(overlayId);
      if (overlay && overlay.style.display === 'flex' && btn.offsetParent !== null) {
        btn.click();
      }
    });

    // Method 3: Fallback - hide any visible overlay
    document.querySelectorAll('.overlay[style*="display: flex"]').forEach(overlay => {
      overlay.style.display = 'none';
    });
  }
});

// Collection Point (Booth) Functions
const defaultCollectionPoints = [
  { id: "DEFAULT", name: "Default Booth" },
  { id: "VILLAGE_A", name: "Village A Booth" },
  { id: "VILLAGE_B", name: "Village B Booth" },
  { id: "VILLAGE_C", name: "Village C Booth" },
  { id: "MAIN_MARKET", name: "Main Market Booth" },
  { id: "GANDHI_CHOWK", name: "Gandhi Chowk Booth" }
];

function updateCollectionPoint() {
  const select = document.getElementById('collectionPointSelect');
  selectedCollectionPointId = select.value;
  localStorage.setItem('MilkRecord_collection_point', selectedCollectionPointId);
  
  // Update header button to show booth name
  const headerUserName = document.getElementById('headerUserName');
  if (headerUserName) {
    const selectedText = select.options[select.selectedIndex].text;
    // Remove emoji from display text
    const cleanName = selectedText.replace(/^[^\s]+\s*/, '');
    headerUserName.textContent = cleanName;
  }
  
  const selectedName = select.options[select.selectedIndex].text;
  showToast(`Booth: ${selectedName}`);

  // Re-render farmers list to show booth-filtered results
  farmerPage = 0;
  renderFarmers();
}

// Load saved collection point on init
function loadSavedCollectionPoint() {
  const saved = localStorage.getItem('MilkRecord_collection_point');
  if (saved) {
    const select = document.getElementById('collectionPointSelect');
    if (select) {
      select.value = saved;
      selectedCollectionPointId = saved;
      
      // Update header button to show saved booth name
      const headerUserName = document.getElementById('headerUserName');
      if (headerUserName) {
        const selectedText = select.options[select.selectedIndex].text;
        const cleanName = selectedText.replace(/^[^\s]+\s*/, '');
        headerUserName.textContent = cleanName;
      }
    }
  }
}

// Keyboard Navigation - Auto Focus Flow
let keyboardMode = 'search'; // 'search' -> 'liters' -> 'fat' -> 'snf' -> 'save'

function setupKeyboardNavigation() {
  document.addEventListener('keydown', function(e) {
    // ESC key - Close any open modal/overlay
    if (e.key === 'Escape') {
      // Close all overlays
      document.querySelectorAll('.overlay[style*="display: flex"]').forEach(overlay => {
        overlay.style.display = 'none';
      });
      // Also click any visible close buttons
      document.querySelectorAll('[data-close]').forEach(btn => {
        const overlayId = btn.getAttribute('data-close');
        const overlay = document.getElementById(overlayId);
        if (overlay && overlay.style.display === 'flex' && btn.offsetParent !== null) {
          btn.click();
        }
      });
      keyboardMode = 'search';
      el('searchInput').focus();
      return;
    }

    // Only activate Enter when not in modal
    if (document.querySelector('.overlay[style*="display: flex"]')) return;

    if (e.key === 'Enter') {
      e.preventDefault();

      if (keyboardMode === 'search') {
        // Enter in search ‚Üí Select first farmer and focus liters
        const firstFarmer = document.querySelector('.fcard');
        if (firstFarmer) {
          firstFarmer.click();
          keyboardMode = 'liters';
          setTimeout(() => el('qtyInput').focus(), 100);
        }
      } else if (keyboardMode === 'liters') {
        // Enter in liters ‚Üí Focus fat
        console.log('Enter in Liters ‚Üí Moving to Fat');
        keyboardMode = 'fat';
        const fatInput = el('fatInput');
        if (fatInput) {
          fatInput.focus();
          fatInput.select();
        }
      } else if (keyboardMode === 'fat') {
        // Enter in fat ‚Üí Focus SNF
        console.log('Enter in Fat ‚Üí Moving to SNF');
        keyboardMode = 'snf';
        const snfInput = el('snfInput');
        if (snfInput) {
          snfInput.focus();
          snfInput.select();
        }
      } else if (keyboardMode === 'snf') {
        // Enter in SNF ‚Üí Save entry
        console.log('Enter in SNF ‚Üí Saving');
        el('btnSave').click();
        keyboardMode = 'search';
        setTimeout(() => el('searchInput').focus(), 100);
      }
    }
  });

  // Focus search on page load
  setTimeout(() => {
    el('searchInput').focus();
  }, 500);

  // Track focus changes - Enhanced with blur handling
  const inputModes = {
    'searchInput': 'search',
    'qtyInput': 'liters',
    'fatInput': 'fat',
    'snfInput': 'snf'
  };

  Object.keys(inputModes).forEach(id => {
    const input = el(id);
    if (input) {
      // On focus - set mode
      input.addEventListener('focus', function() {
        keyboardMode = inputModes[id];
        console.log('Focus:', id, '‚Üí Mode:', keyboardMode);
      });
      
      // On blur - keep mode for a short time
      input.addEventListener('blur', function() {
        setTimeout(() => {
          const newlyFocused = document.activeElement;
          if (!Object.keys(inputModes).includes(newlyFocused.id)) {
            // If focus moved outside inputs, reset to search
            keyboardMode = 'search';
          }
        }, 100);
      });
    }
  });

  // Prevent Enter on Add New button
  const addNewBtn = document.getElementById('btnAddFarmerMain');
  if (addNewBtn) {
    addNewBtn.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        e.stopPropagation();
        // Move to next farmer or field instead
        const firstFarmer = document.querySelector('.fcard');
        if (firstFarmer) {
          firstFarmer.click();
          keyboardMode = 'liters';
          setTimeout(() => el('qtyInput').focus(), 100);
        }
      }
    });
  }
}

// Show "What's missing?" panel
function showWhatMissing() {
  const msg = `Institutional systems track:
  
‚ùå Shift locking
‚ùå Analyzer linkage  
‚ùå Audit trail
‚ùå Settlement logic

These are required for procurement-grade accountability.`;
  alert(msg);
}

// Quantity threshold nudge logic (wrapped to avoid duplicate declaration)
(function() {
  const qtyInputLocal = el('qtyInput');
  if (qtyInputLocal) {
    qtyInputLocal.addEventListener('input', function() {
      const qty = parseFloat(this.value) || 0;
      const nudge = el('qtyThresholdNudge');
      if (nudge) {
        nudge.style.display = qty > 20 ? 'block' : 'none';
      }
    });
  }
})();

      /***********************
       * INIT                *
       ***********************/
      function init() {
        // --- SIRF YE 2 LINE SABSE UPAR JODO ---
    const today = fmtDate(new Date());
    if (el("todayLabel")) el("todayLabel").textContent = `${today} | ${autoSessionLabel()}`;
    // --------------------------------------
    // --- YE 3 LINE BHI JODO ---
    renderRecentToday();
    updateDailySummaryButton();
    updateTodayCollection(); // Kitna Collection - Today's summary
    loadSavedCollectionPoint(); // Load saved booth
    setupKeyboardNavigation(); // Enable keyboard-only workflow
    // --------------------------------------------------
        restoreHoldIfAny();
        renderAll();
        refreshRatePill();

        // Focus search input on page load
        setTimeout(() => {
          if (el("searchInput")) {
            el("searchInput").focus();
            el("searchInput").select();
          }
        }, 300);

        // timerInt = setInterval(() => {
        //   const sec = Math.floor((Date.now() - timerStart) / 1000);
        //   el("timerBox").textContent =
        //     `‚è± ${pad(Math.floor(sec / 60))}:${pad(sec % 60)}`;
        // }, 1000);
      }

      init();
    </script>
  </body>
</html>
