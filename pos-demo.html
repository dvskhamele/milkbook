<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MilkRecord POS</title>
    <style>
      :root {
        --bg: #f4f7fb; --panel: #ffffff; --line: #e5e7eb; --text: #0f172a; --muted: #64748b;
        --blue: #2563eb; --blue2: #1d4ed8; --green: #16a34a; --red: #dc2626; --yellow: #f59e0b;
        --shadow: 0 12px 26px rgba(0, 0, 0, 0.08);
      }
      * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        overflow: hidden;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
      }
      body {
        background: var(--bg);
        color: var(--text);
        font-family: system-ui, sans-serif;
        touch-action: manipulation;
      }
      .app {
        min-height: 100vh;
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 10px;
        width: 100%;
        box-sizing: border-box;
      }
      
      /* --- HEADER - Fully Responsive --- */
      .topbar { background: #fff; border: 1px solid var(--line); border-radius: 10px; box-shadow: var(--shadow); padding: 4px 10px; display: flex; align-items: center; justify-content: space-between; height: 40px; gap: 8px; }
      .brand { display: flex; align-items: center; gap: 6px; min-width: 0; }
      .logo-box { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; background: linear-gradient(180deg, #e0f2fe, #dbeafe); border: 1px solid #c7d2fe; font-size: 14px; flex-shrink: 0; }
      .brand-text { min-width: 0; }
      .brand-text .title { font-weight: 800; font-size: 12px; color: #0f172a; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }
      .brand-text .sub-text { font-size: 9px; font-weight: 600; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .hdr-actions { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
      .pillbtn { height: 30px; padding: 0 8px; border-radius: 6px; border: 1px solid var(--line); background: #fff; font-weight: 700; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s; white-space: nowrap; }
      .pillbtn.primary { background: #3b82f6; color: white; border-color: #3b82f6; }
      
      /* Mobile Responsive */
      @media (max-width: 768px) {
        html, body {
          position: relative;
          overflow: auto;
          height: auto;
          min-height: 100%;
        }
        .app {
          padding: 8px;
          gap: 8px;
          height: auto;
          min-height: 100vh;
          display: flex;
          flex-direction: column;
        }
        .topbar { height: 36px; padding: 4px 6px; flex-shrink: 0; }
        .logo-box { width: 24px; height: 24px; }
        .brand-text .title { font-size: 11px; max-width: 80px; }
        .brand-text .sub-text { font-size: 8px; }
        .pillbtn { height: 28px; padding: 0 6px; font-size: 10px; }
        .pillbtn span { display: none; }
        .pillbtn.primary span { display: inline; }
        .hdr-actions > div:first-child { display: none; }
        .core { grid-template-columns: 1fr; height: auto; min-height: auto; }
        .panel { max-height: none !important; height: auto; }
      }
      
      @media (max-width: 480px) {
        .topbar { height: 32px; }
        .logo-box { width: 20px; height: 20px; font-size: 12px; }
        .brand-text .title { font-size: 10px; max-width: 60px; }
        .brand-text .sub-text { display: none; }
        .pillbtn { height: 26px; font-size: 9px; }
      }
      
      /* Mobile: Fixed footer for save buttons */
      @media (max-width: 768px) {
        body { padding-bottom: 70px; }
        .mobile-footer { display: block !important; }
        .bottom { display: none !important; }
      }

      /* --- CORE LAYOUT --- */
      .core { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; flex: 1; min-height: 0; }
      .panel { background: var(--panel); border: 1px solid var(--line); border-radius: 22px; box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; }
      .left-panel { overflow: hidden; display: flex; flex-direction: column; }
      .right-panel { overflow-y: auto; display: flex; flex-direction: column; }
      
      /* Fixed Payment Section at Bottom */
      .payment-section {
        position: sticky;
        bottom: 0;
        background: var(--panel);
        border-top: 2px solid var(--line);
        padding: 10px 15px;
        z-index: 10;
        box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
      }

      /* Tablet (768px - 1024px): Side by side with adjusted heights */
      @media (min-width: 768px) and (max-width: 1024px) {
        .core { grid-template-columns: 1fr 1fr; gap: 10px; flex: 1; min-height: 0; }
        .panel { max-height: none; }
        .product-grid { grid-template-columns: repeat(4, 1fr) !important; }
      }

      /* Desktop (1024px+): Full side by side */
      @media (min-width: 1025px) {
        .core { grid-template-columns: 1fr 1fr; gap: 14px; }
        .product-grid { grid-template-columns: repeat(5, 1fr) !important; }
      }

      /* Mobile: Stack panels vertically with 100% width */
      @media (max-width: 767px) {
        .app { padding: 6px; gap: 6px; }
        .core { grid-template-columns: 1fr; gap: 8px; height: auto; min-height: auto; flex: 1; }
        .panel { max-height: none !important; height: auto; border-radius: 12px; }
        .left-panel { order: 1; }
        .right-panel { order: 2; }
        .product-grid { grid-template-columns: repeat(3, 1fr) !important; gap: 4px; }
        .p-card { padding: 4px 2px; }
        .p-card .emoji { font-size: 32px; }
        .p-card div { font-size: 9px; }
        .p-card small { font-size: 8px; }
        .summary-box { margin: 6px; padding: 12px; }
        .summary-box .amt { font-size: 28px; }
        /* Cart items scrollable on mobile */
        .recent-table tbody { max-height: 300px; overflow-y: auto; }
        /* Payment grid 2x2 on mobile */
        .pay-grid { grid-template-columns: 1fr 1fr !important; gap: 4px; padding: 0 6px 6px; }
        .pay-btn { height: 40px; font-size: 11px; }
        /* Fixed payment section on mobile */
        .payment-section {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background: white;
          border-top: 2px solid #e2e8f0;
          padding: 10px;
          z-index: 100;
          box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
        }
        /* Add padding to right panel to prevent content hiding behind fixed payment */
        .right-panel { padding-bottom: 180px; }
      }

      @media (max-width: 480px) {
        .core { gap: 8px; }
        .product-grid { grid-template-columns: repeat(2, 1fr) !important; }
        .p-card .emoji { font-size: 32px; }
        .topbar { height: 32px; }
        .logo-box { width: 20px; height: 20px; font-size: 12px; }
        .brand-text .title { font-size: 10px; max-width: 60px; }
        .brand-text .sub-text { display: none; }
        .pillbtn { height: 26px; font-size: 9px; }
      }
      .panelHeader { padding: 12px 16px; border-bottom: 1px solid var(--line); font-weight: 1000; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }

      /* --- SEARCH & PERSISTENCE AREA --- */
      .cust-control { padding: 10px 15px; background: #f8fafc; border-bottom: 1px solid var(--line); display: flex; gap: 10px; position: relative; }
      .search-box { flex: 1; position: relative; }
      .search-box input { width: 100%; height: 40px; border-radius: 10px; border: 2px solid #e2e8f0; padding-left: 35px; outline: none; font-weight: 700; font-size: 14px; transition: all 0.2s; }
      .search-box input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
      .search-box::before { content: 'üîç'; position: absolute; left: 10px; top: 10px; font-size: 14px; z-index: 1; }

      /* Integrated Dropdown Style */
      .search-dropdown { 
        position: absolute; 
        top: 100%; 
        left: 0; 
        width: 100%; 
        background: #fff; 
        border: 2px solid #3b82f6; 
        border-top: none;
        border-radius: 0 0 12px 12px; 
        z-index: 100; 
        display: none; 
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2); 
        max-height: 250px; 
        overflow-y: auto; 
        margin-top: -2px;
      }
      .drop-item { 
        padding: 12px 15px; 
        border-bottom: 1px solid #f1f5f9; 
        cursor: pointer; 
        font-weight: 700; 
        font-size: 13px;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .drop-item:hover, .drop-item.selected { 
        background: #eff6ff; 
        color: #1d4ed8;
        padding-left: 20px;
      }
      .drop-item.add-new {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-bottom: 2px solid #22c55e;
        font-weight: 900;
      }
      .drop-item.add-new:hover {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      }

      .add-btn { height: 40px; padding: 0 15px; border-radius: 10px; border: none; background: var(--blue); color: #fff; font-weight: 1000; cursor: pointer; }

      .product-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; padding: 8px; overflow-y: auto; flex: 1; outline: none; align-content: start; }
      .p-card {
        background: #fff;
        border: none;
        border-radius: 8px;
        padding: 8px 4px;
        text-align: center;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        position: relative;
      }
      .p-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
      .p-card:hover .edit-prod-btn { opacity: 1; }
      .p-card:active { transform: scale(0.95); }
      .p-card.selected { border: 2px solid #3b82f6 !important; background: #eff6ff !important; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transform: scale(1.05); }
      .p-card.focused { outline: 2px solid #3b82f6; outline-offset: 2px; }
      .p-card[draggable="true"]:hover { cursor: grab; }
      .p-card[draggable="true"]:active { cursor: grabbing; }
      .p-card.dragging { opacity: 0.4; border: 2px dashed #3b82f6; }
      .recent-table tr[draggable="true"]:hover { cursor: grab; }
      .recent-table tr[draggable="true"]:active { cursor: grabbing; }
      .recent-table tr[draggable="true"] { transition: all 0.2s; }
      .recent-table tr.dragging { opacity: 0.4; border: 2px dashed #3b82f6; }
      .p-card.cow { background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%); }
      .p-card.buff { background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%); }
      .p-card .emoji { font-size: 48px; margin-bottom: 4px; display: block; transition: all 0.2s; }
      .p-card div { font-weight: 900; font-size: 11px; line-height: 1.2; transition: all 0.2s; }
      .p-card small { color: #64748b; font-weight: 700; font-size: 10px; margin-top: 2px; transition: all 0.2s; }
      
      /* Dynamic styling based on quantity */
      .p-card[data-qty="0.5"] .emoji { font-size: 32px; }
      .p-card[data-qty="0.5"] div { font-weight: 700; color: #64748b; }
      .p-card[data-qty="1"] .emoji { font-size: 48px; }
      .p-card[data-qty="1"] div { font-weight: 900; color: #1e293b; }
      .p-card[data-qty="2"] .emoji { font-size: 56px; }
      .p-card[data-qty="2"] div { font-weight: 900; color: #166534; }

      .qty-bar { display: flex; gap: 10px; padding: 12px 15px; background: #f8fafc; border-top: 1px solid var(--line); }
      .qty-btn { flex: 1; height: 45px; border-radius: 10px; border: 1px solid var(--line); background: #fff; font-weight: 1000; cursor: pointer; }

      .summary-box { background: linear-gradient(180deg, var(--blue), var(--blue2)); color: #fff; padding: 15px; border-radius: 18px; margin: 10px; text-align: center; }
      .amt { font-size: 42px; font-weight: 1200; }

      .pay-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; padding: 0 10px 10px; }
      .pay-btn { flex: 1; min-width: 80px; height: 36px; border-radius: 8px; border: none; font-weight: 900; font-size: 11px; cursor: pointer; transition: all 0.15s; }
      .pay-btn:hover { transform: translateY(-1px); }
      .pay-btn:active { transform: scale(0.98); }
      .pay-btn.credit { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; min-width: 100%; height: 40px; }

      .recent-table { width: 100%; border-collapse: collapse; font-size: 13px; }
      .recent-table td { padding: 10px; border-bottom: 1px solid var(--line); font-weight: 700; vertical-align: middle; }
      .recent-table input { padding: 4px; border: 1px solid var(--line); border-radius: 6px; font-weight: 700; text-align: center; }
      .recent-table input[type="number"]::-webkit-inner-spin-button { opacity: 1; cursor: pointer; }
      .recent-table .remove-btn { background: #fecaca; color: #7f1d1d; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-weight: 700; font-size: 12px; }

      .overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.45); display: none; align-items: center; justify-content: center; z-index: 100; }
      .modal { width: min(800px, 95vw); height: min(600px, 90vh); background: #fff; border-radius: 22px; display: grid; grid-template-rows: 60px 1fr 70px; overflow: hidden; box-shadow: 0 24px 60px rgba(0,0,0,0.3); }
      .modalBody { padding: 20px; overflow-y: auto; background: #f8fafc; }
      .cardRow { background: #fff; border: 1px solid var(--line); border-radius: 16px; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }

      .toast { position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%); background: #0f172a; color: #fff; padding: 12px 20px; border-radius: 16px; font-weight: 1100; opacity: 0; transition: 0.3s; z-index: 200; }
      .toast.show { opacity: 1; }
      
      /* Demo Banner */
      .demo-banner { background: #fef3c7; border-bottom: 2px solid #f59e0b; padding: 10px 20px; text-align: center; font-size: 13px; font-weight: 600; color: #92400e; }
      
      /* Institutional Gaps Panel */
      .gaps-panel { position: fixed; right: 0; top: 0; bottom: 0; width: 300px; background: #f8fafc; border-left: 2px solid #e2e8f0; padding: 20px; overflow-y: auto; transform: translateX(100%); transition: transform 0.3s; z-index: 1000; }
      .gaps-panel.open { transform: translateX(0); }
      .gaps-toggle { position: fixed; right: 20px; bottom: 120px; width: 50px; height: 50px; border-radius: 50%; background: #64748b; color: white; border: none; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 999; }
      .gap-item { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 10px; opacity: 0.6; }
      .gap-item h4 { margin: 0 0 5px 0; font-size: 13px; color: #475569; }
      .gap-item p { margin: 0; font-size: 12px; color: #64748b; }
      .gap-tooltip { background: #fef3c7; color: #92400e; font-size: 11px; padding: 6px; border-radius: 4px; margin-top: 6px; font-style: italic; }

      /* Card Image aur Selection Style */
.p-card img { width: 45px; height: 45px; object-fit: cover; margin-bottom: 8px; border-radius: 10px; }
.p-card.selected { border: 3px solid var(--blue) !important; background: #eff6ff !important; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3) !important; transform: scale(1.02); }
.price-input { width: 60px; border: 1px solid var(--line); border-radius: 5px; padding: 2px; font-weight: bold; text-align: center; }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="topbar">
        <div class="brand">
          <a href="homepage.html" style="text-decoration:none; color:inherit;">
            <div class="logo-box">
              <img src="logo.jpg" alt="MilkRecord" style="width: 100%; height: 100%; object-fit: contain; border-radius: 4px;" onerror="this.style.display='none'; this.parentElement.innerHTML='ü•õ'" />
            </div>
            <div class="brand-text">
              <div class="title" id="shopTitle">MilkRecord POS</div>
              <div class="sub-text" id="todayLabel">‚Äî</div>
            </div>
          </a>
        </div>
        <div class="hdr-actions">
          <!-- Switch to Collection -->
          <button class="pillbtn primary" onclick="location.href='index.html'" style="background:#16a34a; border-color:#16a34a;">
            üìä Collection
          </button>
          
          <!-- Profile Dropdown (Top Right) -->
          <div style="position: relative; display: inline-block;">
            <button class="pillbtn" onclick="toggleProfileDropdown()" style="background:#f8fafc; border-color:#e2e8f0;">
              üë§ <span id="profileName">User</span> ‚ñº
            </button>
            <div id="profileDropdown" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 8px; background: white; border: 1px solid var(--line); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); min-width: 220px; z-index: 1000;">
              <div style="padding: 12px; border-bottom: 1px solid var(--line);">
                <div style="font-weight: 700; font-size: 13px;" id="dropdownEmail">user@email.com</div>
                <div style="font-size: 11px; color: var(--muted);" id="dropdownShop">Shop Name</div>
              </div>
              <button onclick="openModal('settingsModal'); toggleProfileDropdown()" style="width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text);">‚öôÔ∏è Settings</button>
              <button onclick="exportDetailedExcel(); toggleProfileDropdown()" style="width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text);">üìä Export Data</button>
              <button onclick="openModal('historyModal'); toggleProfileDropdown()" style="width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text);">üßæ History</button>
              <button onclick="toggleLanguage(); toggleProfileDropdown()" style="width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text);">üåê HI/EN Language</button>
              <div style="border-top: 1px solid var(--line); margin: 4px 0;"></div>
              <button onclick="logout()" style="width: 100%; padding: 10px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 13px; font-weight: 600; color: #dc2626;">üö™ Logout</button>
            </div>
          </div>
        </div>
      </div>

      <div class="core">
        <div class="panel">
          <!-- Product search field -->
          <div style="padding: 8px 12px; background: #f8fafc; border-bottom: 1px solid var(--line);">
            <input type="text" id="productSearch" placeholder="üîç Search products..." oninput="filterProducts(this.value)" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600;" onclick="event.stopPropagation()" />
          </div>

          <div class="product-grid" id="productGrid" onclick="closeSearchDropdown()" tabindex="0" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
            <!-- Drop zone hint -->
            <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #64748b; font-size: 12px; border: 2px dashed #e2e8f0; border-radius: 8px; margin: 8px;">
              üí° Drag products here to reorder ‚Ä¢ Drag to right panel to add to cart
            </div>
            <!-- Cow Products with multiple step cards -->
            <div class="p-card cow" onclick="tapAdd('Cow 1L', 64, 1)" data-qty="1" data-step="1" data-name="Cow 1L" data-price="64" data-unit="L" id="prod-cow-1l" draggable="true" ondragstart="handleDragStart(event)">
              <span class="emoji" style="font-size: 48px;">üêÑ</span>
              <div style="font-size: 11px; font-weight: 900; margin-top: 4px;">Cow 1L <span style="font-size:9px; color:#64748b;">(1x)</span></div>
              <small style="font-size: 10px; margin-top: 2px;">‚Çπ64</small>
              <button class="edit-prod-btn" onclick="event.stopPropagation(); editProduct('prod-cow-1l')" title="Edit Product" style="position: absolute; top: 4px; left: 4px; background: rgba(255,255,255,0.9); border: none; border-radius: 4px; cursor: pointer; font-size: 14px; padding: 2px; opacity: 0; transition: opacity 0.2s;">‚úèÔ∏è</button>
              <div class="qty-badge" style="position: absolute; top: 4px; right: 4px; background: #dc2626; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center; display: none;">0</div>
            </div>
            <div class="p-card cow" onclick="tapAdd('Cow 0.5L', 32, 0.5)" data-qty="0.5" data-step="0.5" data-name="Cow 0.5L" data-price="32" data-unit="L" id="prod-cow-05l" draggable="true" ondragstart="handleDragStart(event)">
              <span class="emoji" style="font-size: 32px;">üêÑ</span>
              <div style="font-size: 11px; font-weight: 700; margin-top: 4px; color: #64748b;">Cow 0.5L <span style="font-size:9px; color:#64748b;">(0.5x)</span></div>
              <small style="font-size: 10px; margin-top: 2px;">‚Çπ32</small>
              <button class="edit-prod-btn" onclick="event.stopPropagation(); editProduct('prod-cow-05l')" title="Edit Product" style="position: absolute; top: 4px; left: 4px; background: rgba(255,255,255,0.9); border: none; border-radius: 4px; cursor: pointer; font-size: 14px; padding: 2px; opacity: 0; transition: opacity 0.2s;">‚úèÔ∏è</button>
              <div class="qty-badge" style="position: absolute; top: 4px; right: 4px; background: #dc2626; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center; display: none;">0</div>
            </div>

            <!-- Buffalo Products with multiple step cards -->
            <div class="p-card buff" onclick="tapAdd('Buff 2L', 200, 2)" data-qty="2" data-step="2" data-name="Buff 2L" data-price="200" data-unit="L" id="prod-buff-2l" draggable="true" ondragstart="handleDragStart(event)">
              <span class="emoji" style="font-size: 56px;">üêÉ</span>
              <div style="font-size: 11px; font-weight: 900; margin-top: 4px;">Buff 2L <span style="font-size:9px; color:#64748b;">(2x)</span></div>
              <small style="font-size: 10px; margin-top: 2px;">‚Çπ200</small>
              <button class="edit-prod-btn" onclick="event.stopPropagation(); editProduct('prod-buff-2l')" title="Edit Product" style="position: absolute; top: 4px; left: 4px; background: rgba(255,255,255,0.9); border: none; border-radius: 4px; cursor: pointer; font-size: 14px; padding: 2px; opacity: 0; transition: opacity 0.2s;">‚úèÔ∏è</button>
              <div class="qty-badge" style="position: absolute; top: 4px; right: 4px; background: #dc2626; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center; display: none;">0</div>
            </div>
            <div class="p-card buff" onclick="tapAdd('Buff 1L', 100, 1)" data-qty="1" data-step="1" data-name="Buff 1L" data-price="100" data-unit="L" id="prod-buff-1l" draggable="true" ondragstart="handleDragStart(event)">
              <span class="emoji" style="font-size: 48px;">üêÉ</span>
              <div style="font-size: 11px; font-weight: 900; margin-top: 4px;">Buff 1L <span style="font-size:9px; color:#64748b;">(1x)</span></div>
              <small style="font-size: 10px; margin-top: 2px;">‚Çπ100</small>
              <button class="edit-prod-btn" onclick="event.stopPropagation(); editProduct('prod-buff-1l')" title="Edit Product" style="position: absolute; top: 4px; left: 4px; background: rgba(255,255,255,0.9); border: none; border-radius: 4px; cursor: pointer; font-size: 14px; padding: 2px; opacity: 0; transition: opacity 0.2s;">‚úèÔ∏è</button>
              <div class="qty-badge" style="position: absolute; top: 4px; right: 4px; background: #dc2626; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center; display: none;">0</div>
            </div>
            <div class="p-card buff" onclick="tapAdd('Buff 0.5L', 50, 0.5)" data-qty="0.5" data-step="0.5" data-name="Buff 0.5L" data-price="50" data-unit="L" id="prod-buff-05l" draggable="true" ondragstart="handleDragStart(event)">
              <span class="emoji" style="font-size: 32px;">üêÉ</span>
              <div style="font-size: 11px; font-weight: 700; margin-top: 4px; color: #64748b;">Buff 0.5L <span style="font-size:9px; color:#64748b;">(0.5x)</span></div>
              <small style="font-size: 10px; margin-top: 2px;">‚Çπ50</small>
              <button class="edit-prod-btn" onclick="event.stopPropagation(); editProduct('prod-buff-05l')" title="Edit Product" style="position: absolute; top: 4px; left: 4px; background: rgba(255,255,255,0.9); border: none; border-radius: 4px; cursor: pointer; font-size: 14px; padding: 2px; opacity: 0; transition: opacity 0.2s;">‚úèÔ∏è</button>
              <div class="qty-badge" style="position: absolute; top: 4px; right: 4px; background: #dc2626; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center; display: none;">0</div>
            </div>

            <!-- Other Products -->
            <div class="p-card" style="border-left:3px solid #fbbf24" onclick="tapAdd('Paneer', 320, 1)" data-qty="1" data-step="1" data-name="Paneer" data-price="320" data-unit="kg" id="prod-paneer" draggable="true" ondragstart="handleDragStart(event)">
              <span class="emoji" style="font-size: 48px;">üßÄ</span>
              <div style="font-size: 11px; font-weight: 900; margin-top: 4px;">Paneer <span style="font-size:9px; color:#64748b;">(1x)</span></div>
              <small style="font-size: 10px; margin-top: 2px;">‚Çπ320</small>
              <button class="edit-prod-btn" onclick="event.stopPropagation(); editProduct('prod-paneer')" title="Edit Product" style="position: absolute; top: 4px; left: 4px; background: rgba(255,255,255,0.9); border: none; border-radius: 4px; cursor: pointer; font-size: 14px; padding: 2px; opacity: 0; transition: opacity 0.2s;">‚úèÔ∏è</button>
              <div class="qty-badge" style="position: absolute; top: 4px; right: 4px; background: #dc2626; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center; display: none;">0</div>
            </div>
            <div class="p-card" style="border-left:3px solid #fb923c" onclick="tapAdd('Ghee', 180, 0.25)" data-qty="0.25" data-step="0.25" data-name="Ghee" data-price="180" data-unit="g" id="prod-ghee" draggable="true" ondragstart="handleDragStart(event)">
              <span class="emoji" style="font-size: 36px;">üçØ</span>
              <div style="font-size: 11px; font-weight: 700; margin-top: 4px; color: #64748b;">Ghee <span style="font-size:9px; color:#64748b;">(0.25x)</span></div>
              <small style="font-size: 10px; margin-top: 2px;">‚Çπ180</small>
              <button class="edit-prod-btn" onclick="event.stopPropagation(); editProduct('prod-ghee')" title="Edit Product" style="position: absolute; top: 4px; left: 4px; background: rgba(255,255,255,0.9); border: none; border-radius: 4px; cursor: pointer; font-size: 14px; padding: 2px; opacity: 0; transition: opacity 0.2s;">‚úèÔ∏è</button>
              <div class="qty-badge" style="position: absolute; top: 4px; right: 4px; background: #dc2626; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center; display: none;">0</div>
            </div>
            <div class="p-card" onclick="tapAdd('Milk Cake', 300, 1)" data-qty="1" data-step="1" data-name="Milk Cake" data-price="300" data-unit="kg" id="prod-milkcake" draggable="true" ondragstart="handleDragStart(event)">
              <span class="emoji" style="font-size: 48px;">üç∞</span>
              <div style="font-size: 11px; font-weight: 900; margin-top: 4px;">Milk Cake <span style="font-size:9px; color:#64748b;">(1x)</span></div>
              <small style="font-size: 10px; margin-top: 2px;">‚Çπ300</small>
              <button class="edit-prod-btn" onclick="event.stopPropagation(); editProduct('prod-milkcake')" title="Edit Product" style="position: absolute; top: 4px; left: 4px; background: rgba(255,255,255,0.9); border: none; border-radius: 4px; cursor: pointer; font-size: 14px; padding: 2px; opacity: 0; transition: opacity 0.2s;">‚úèÔ∏è</button>
              <div class="qty-badge" style="position: absolute; top: 4px; right: 4px; background: #dc2626; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center; display: none;">0</div>
            </div>

            <!-- Add & Edit Buttons -->
            <div class="p-card" style="border: 2px dashed #3b82f6; background: #eff6ff;" onclick="openModal('addProductModal')">
              <div style="font-size:48px; color:#3b82f6; font-weight: 900;">‚ûï</div>
              <div style="font-weight:900; color:#3b82f6; font-size:9px; margin-top: 4px;">ADD</div>
            </div>
            <div class="p-card" style="border: 2px solid #f59e0b; background: #fffbeb;" onclick="openEditInventory()" title="Edit Product Prices">
              <div style="font-size:36px; color:#f59e0b; font-weight: 900;">‚úèÔ∏è</div>
              <div style="font-weight:900; color:#f59e0b; font-size:9px; margin-top: 4px;">EDIT</div>
            </div>
          </div>
        </div>

        <div class="panel left-panel" ondragover="handleProductDragToCart(event)" ondrop="handleProductDragToCart(event)">
          <div class="panelHeader" style="padding: 8px 12px; height: 40px; background: #f8fafc; border-bottom: 1px solid var(--line);">
            <!-- Hidden element for active customer (for backwards compatibility) -->
            <span id="activeCust" style="display:none;">Walking Customer</span>

            <!-- Customer Search -->
            <div style="position: relative; width: 100%;">
              <input type="text" id="custSearch" placeholder="üë§ Search customer..." oninput="handleSearch(this.value)" style="width: 100%; padding: 8px 8px 8px 30px; border: 2px solid #3b82f6; border-radius: 8px; font-weight: 700; font-size: 13px; background: white;" />
              <span style="position: absolute; left: 10px; top: 8px; font-size: 14px;">üîé</span>
              <div id="searchDropdown" class="search-dropdown" onclick="event.stopPropagation()" style="top: 100%; border-radius: 0 0 8px 8px;"></div>
            </div>
          </div>
          
          <div class="summary-box">
            <div style="font-size:12px; opacity:0.8;" id="lblPayable">TOTAL PAYABLE</div>
            <div class="amt" id="totalAmt">‚Çπ0.00</div>
          </div>

          <!-- Advance/Cut Ledger Section - Collapsed by default -->
          <div id="advanceSection" style="display:none; background:#fef3c7; border:2px solid #f59e0b; border-radius:16px; margin:15px; padding:15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
              <h4 style="margin:0; color:#92400e; font-size:14px;">üìí Ledger Entry</h4>
              <button onclick="closeAdvance()" style="background:none; border:none; font-size:18px; cursor:pointer; color:#92400e;">‚úñ</button>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
              <div style="background:white; padding:10px; border-radius:8px; text-align:center;">
                <div style="font-size:11px; color:#64748b; font-weight:700;">TOTAL MILK (MONTH)</div>
                <div style="font-size:18px; font-weight:900; color:#1e293b;" id="monthMilk">0.0 L</div>
              </div>
              <div style="background:white; padding:10px; border-radius:8px; text-align:center;">
                <div style="font-size:11px; color:#64748b; font-weight:700;">CURRENT BALANCE</div>
                <div style="font-size:18px; font-weight:900; color:#166534;" id="currentAdvance">‚Çπ0.00</div>
              </div>
            </div>
            
            <!-- Credit/Debit Toggle -->
            <div style="margin-bottom:12px;">
              <div style="font-size:11px; color:#64748b; font-weight:700; margin-bottom:8px;">Transaction Type</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <label style="cursor:pointer;">
                  <input type="radio" name="ledgerType" value="credit" checked style="display:none;" onchange="updateLedgerPlaceholder()">
                  <div id="creditToggle" style="padding:10px; background:#f0fdf4; border:2px solid #22c55e; border-radius:8px; text-align:center; font-weight:700; color:#166534;">‚ûï Credit (Udhar)</div>
                </label>
                <label style="cursor:pointer;">
                  <input type="radio" name="ledgerType" value="debit" style="display:none;" onchange="updateLedgerPlaceholder()">
                  <div id="debitToggle" style="padding:10px; background:#fef2f2; border:2px solid #ef4444; border-radius:8px; text-align:center; font-weight:700; color:#7f1d1d;">‚ûñ Debit (Payment)</div>
                </label>
              </div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <input type="number" id="advanceAmount" placeholder="Kitna likhna hai? (‚Çπ)" style="padding:10px; border-radius:8px; border:1px solid #f59e0b; font-weight:700;" />
              <button onclick="updateAdvance()" style="padding:10px; background:#f59e0b; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer;">Update Ledger</button>
            </div>
            <button onclick="sendMonthlySummary()" style="width:100%; margin-top:8px; padding:12px; background:white; color:#92400e; border:1px solid #f59e0b; border-radius:8px; font-weight:700; cursor:pointer;">üí¨ Send Summary</button>
          </div>
          
          <!-- Advance Toggle Button (Always Visible) -->
          <button onclick="toggleAdvance()" id="advanceToggleBtn" style="margin:0 15px; padding:10px; background:#fef3c7; border:2px solid #f59e0b; border-radius:12px; font-weight:700; color:#92400e; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
            üìï Advance / Udhar
          </button>
          <div id="udharThresholdNudge" style="display: none; margin: 0 15px 15px; padding: 10px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; font-size: 11px; color: #92400e; font-weight: 700;">
            ‚ö†Ô∏è High outstanding credit<br>
            <span style="font-weight: 500; color: #64748b;">Retail POS tracks balance, not settlement responsibility.</span>
          </div>

          <!-- Cart Items (Top Priority - Visible Without Scroll) -->
          <div style="padding:15px; border-top:1px solid var(--line); border-bottom:1px solid var(--line); max-height: none; min-height: 300px; flex: 1; overflow-y: auto;" ondragover="handleCartDragOverTbody(event)" ondrop="handleCartDropTbody(event)" ondragleave="handleCartDragOut(event)">
            <table class="recent-table"><tbody id="cartItems" ondragover="handleCartDragOver(event)" ondrop="handleCartDrop(event)"></tbody></table>
          </div>

          <!-- Fixed Payment Section -->
          <div class="payment-section">
            <div style="font-size: 11px; color: #64748b; font-weight: 700; margin-bottom: 8px;">üí∞ Customer Paid</div>
            <input type="number" id="paymentAmount" placeholder="Enter amount (‚Çπ)" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 700; font-size: 16px; box-sizing:border-box;" oninput="calculateCredit()" onkeydown="if(event.key==='Enter'){saveAndInvoice();}" />
            <div id="creditDisplay" style="font-size: 12px; color: #16a34a; font-weight: 700; margin-top: 8px; text-align: center;"></div>

            <div class="pay-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap: 6px; margin-top: 10px;">
              <button class="pay-btn" id="btnCash" style="background:#dcfce7; color:#166534;" onclick="saveEntry('Cash')">CASH</button>
              <button class="pay-btn" id="btnUpi" style="background:#eff6ff; color:#1e40af;" onclick="saveEntry('UPI')">UPI</button>
              <button class="pay-btn" style="background:#fef3c7; color:#92400e;" onclick="holdCart()">üü° HOLD</button>
              <button class="pay-btn" style="background:#f1f5f9; color:#475569;" onclick="showHeldCarts()">üìã <span id="heldCount">0</span></button>
            </div>
            <button class="pay-btn credit" id="btnCredit" onclick="saveEntry('Credit')" style="width: 100%; margin-top: 6px;">LIKH LO (Credit)</button>
          </div>
        </div>
      </div>
    </div>

    <div class="overlay" id="addCustModal">
        <div class="modal" style="width:450px; height:auto;">
            <div class="panelHeader"><span>üë§ Add/Edit Customer</span> <button onclick="closeModal('addCustModal')">‚úñ</button></div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <input type="text" id="newName" placeholder="Full Name" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:1000;">
                <input type="tel" id="newPhone" placeholder="WhatsApp Mobile (e.g., 9876543210)" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:1000;" inputmode="tel" pattern="[0-9]{10}" />
                <input type="email" id="newEmail" placeholder="Email (for invoice)" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:1000;" />
                <input type="date" id="newBirthday" placeholder="Birthday" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:1000;" />
                <input type="text" id="newGst" placeholder="GST Number (Optional)" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:1000;" />
                <select id="newType" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:1000;">
                    <option value="Retail">Retail Walk-in</option>
                    <option value="PACS">PACS Member</option>
                    <option value="FPO">FPO Shareholder</option>
                </select>
                <div style="background:#f8fafc; padding:10px; border-radius:10px; border:1px solid var(--line);">
    <label style="font-size:11px; font-weight:1000; color:var(--muted);">SUBSCRIPTION PLAN (Point 17)</label>
    <input type="number" id="subQty" placeholder="Daily Quantity (L)" style="width:100%; padding:10px; border:none; background:transparent; font-weight:1000;">
</div>
                <button class="add-btn" style="height:50px; background:var(--green);" onclick="addCust()">Save Customer</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="memoryModal">
      <div class="modal" style="width:500px; height:auto;">
        <div class="panelHeader"><span id="lblMemTitle">Customer Memory üß†</span> <button onclick="closeModal('memoryModal')">‚úñ</button></div>
        <div class="modalBody" id="memoryList"></div>
      </div>
    </div>

    <div class="overlay" id="historyModal">
      <div class="modal" style="width:700px; height:auto; max-height:90vh;">
        <div class="panelHeader">
          <span id="lblHistTitle">üßæ History</span>
          <button onclick="closeModal('historyModal')">‚úñ</button>
        </div>

        <!-- Tabs -->
        <div style="display:flex; border-bottom:1px solid var(--line); padding:0 20px;">
          <button onclick="switchHistoryTab('today')" id="tabToday" style="flex:1; padding:12px; border:none; background:none; font-weight:700; cursor:pointer; border-bottom:3px solid var(--blue);">üìÖ Today</button>
          <button onclick="switchHistoryTab('all')" id="tabAll" style="flex:1; padding:12px; border:none; background:none; font-weight:700; cursor:pointer; border-bottom:3px solid transparent;">üìö All History</button>
        </div>

        <!-- Tab Content -->
        <div class="modalBody" style="display:block; padding:15px; overflow-y:auto; max-height:70vh;">
          <div id="historyToday" style="display:block;"></div>
          <div id="historyWeekly" style="display:none;"></div>
        </div>

        <!-- Footer Actions -->
        <div style="padding:15px 20px; border-top:1px solid var(--line); display:flex; gap:10px; justify-content:space-between;">
          <div style="font-size:13px; color:var(--muted); font-weight:700;">
            <span id="historyCount">1 today ‚Ä¢ 0 in 7d</span>
          </div>
          <div style="display:flex; gap:8px;">
            <button onclick="downloadHistoryCSV()" style="padding:8px 16px; background:#eff6ff; color:#1e40af; border:none; border-radius:8px; font-weight:700; cursor:pointer;">‚¨áÔ∏è Export</button>
            <button onclick="clearTodayHistory()" style="padding:8px 16px; background:#fecaca; color:#7f1d1d; border:none; border-radius:8px; font-weight:700; cursor:pointer;">üóëÔ∏è Clear Today</button>
          </div>
        </div>
      </div>
    </div>

    <div class="overlay" id="convertModal">
        <div class="modal" style="width:400px; height:auto;">
            <div class="panelHeader"><span>üîÑ Milk ‚Üí Product Conversion</span> <button onclick="closeModal('convertModal')">‚úñ</button></div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <input type="number" id="convQty" placeholder="Milk (L)" style="width:100%; padding:15px; border-radius:10px; border:1px solid var(--line); font-weight:1000;">
                <select id="convProduct" style="width:100%; padding:15px; border-radius:10px; border:1px solid var(--line); font-weight:1000;">
                    <option value="Cow Milk,64">Cow Milk (‚Çπ64/L)</option>
                    <option value="Buff Milk,100">Buff Milk (‚Çπ100/L)</option>
                    <option value="Buff Milk,80">Buff Milk (‚Çπ80/L)</option>
                </select>
                <button class="add-btn" style="width:100%; background:var(--green);" onclick="convertMilkToProduct()">Update Stock</button>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="overlay" id="addProductModal">
        <div class="modal" style="width:90vw !important; max-width:500px !important; height:auto !important; max-height:90vh !important; overflow-y:auto !important; display:block !important; grid-template-rows:none !important;">
            <div class="panelHeader"><span>üì¶ Add New Product</span> <button onclick="closeModal('addProductModal')" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center;">‚úñ</button></div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:15px;">
                <input type="text" id="pName" placeholder="Product Name (e.g., Curd 500g)" style="width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:700; font-size: 14px; box-sizing:border-box;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                  <input type="number" id="pPrice" placeholder="Price (‚Çπ)" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:700; font-size: 14px; box-sizing:border-box;">
                  <input type="text" id="pUnit" placeholder="Unit (L/kg/g)" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:700; font-size: 14px; box-sizing:border-box;">
                </div>
                <input type="text" id="pEmoji" placeholder="Emoji (ü•õ, üßÄ)" style="width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:700; font-size: 14px; box-sizing:border-box;">

                <!-- Editable Steps Section -->
                <div style="background:#f8fafc; padding:16px; border-radius:10px; border:1px solid var(--line);">
                  <div style="font-size:12px; font-weight:700; color:var(--muted); margin-bottom:12px; display:flex; align-items:center; gap:6px;">
                    <span>‚ö°</span> Quick Steps (edit values for product cards)
                  </div>
                  <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:8px;">
                    <div style="display:flex; flex-direction:column; gap:4px;">
                      <label style="font-size:10px; font-weight:700; color:var(--muted); text-align:center;">Step 1</label>
                      <input type="number" class="pStep" value="1" step="0.1" style="padding:8px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-align:center; width:100%; box-sizing:border-box;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                      <label style="font-size:10px; font-weight:700; color:var(--muted); text-align:center;">Step 2</label>
                      <input type="number" class="pStep" value="2" step="0.1" style="padding:8px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-align:center; width:100%; box-sizing:border-box;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                      <label style="font-size:10px; font-weight:700; color:var(--muted); text-align:center;">Step 3</label>
                      <input type="number" class="pStep" value="5" step="0.1" style="padding:8px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-align:center; width:100%; box-sizing:border-box;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                      <label style="font-size:10px; font-weight:700; color:var(--muted); text-align:center;">Step 4</label>
                      <input type="number" class="pStep" value="10" step="0.1" style="padding:8px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-align:center; width:100%; box-sizing:border-box;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                      <label style="font-size:10px; font-weight:700; color:var(--muted); text-align:center;">Step 5</label>
                      <input type="number" class="pStep" value="20" step="0.1" style="padding:8px; border-radius:6px; border:1px solid var(--line); font-weight:700; font-size:13px; text-align:center; width:100%; box-sizing:border-box;" />
                    </div>
                  </div>
                  <div style="font-size:10px; color:var(--muted); margin-top:10px; text-align:center;">üí° Set to 0 to disable. Negative values allowed.</div>
                </div>

                <button class="add-btn" style="width:100%; background:var(--green);" onclick="addNewProductFromModal()">Create Product</button>
            </div>
        </div>
    </div>

    <!-- Edit Products Modal -->
    <div class="overlay" id="editInventoryModal">
        <div class="modal" style="width:90vw !important; max-width:500px !important; height:auto !important; max-height:80vh !important; display:block !important; grid-template-rows:none !important;">
            <div class="panelHeader"><span>‚úèÔ∏è Edit Products</span> <button onclick="closeModal('editInventoryModal')" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center;">‚úñ</button></div>
            <div class="modalBody" id="editInventoryList" style="padding:20px; display:flex; flex-direction:column; gap:12px; overflow-y:auto; max-height:60vh;"></div>
        </div>
    </div>

    <!-- Held Carts Modal -->
    <div class="overlay" id="heldCartsModal">
        <div class="modal" style="width:500px; height:auto;">
            <div class="panelHeader"><span>üìã Held Orders</span> <button onclick="closeModal('heldCartsModal')">‚úñ</button></div>
            <div class="modalBody" id="heldCartsList" style="padding:20px; display:flex; flex-direction:column; gap:10px;"></div>
        </div>
    </div>

    <!-- Unsaved Cart Warning Modal -->
    <div class="overlay" id="unsavedCartModal" style="background: rgba(0,0,0,0.75);">
        <div class="modal" style="width:450px; height:auto; border-radius: 22px; box-shadow: 0 24px 60px rgba(0,0,0,0.5);">
            <div class="panelHeader" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; justify-content: space-between;">
                <span style="font-weight: 900;">‚ö†Ô∏è Unsaved Order!</span>
                <button onclick="closeModal('unsavedCartModal')" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">‚úñ</button>
            </div>
            <div style="padding:30px; text-align:center;">
                <div style="font-size:60px; margin-bottom:15px;">üõí</div>
                <h3 style="margin:0 0 10px 0; color:#1e293b; font-size:20px;">You have unsaved items in cart!</h3>
                <p style="color:#64748b; font-size:14px; margin:0 0 25px 0;">Do you want to HOLD or SAVE before closing?</p>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <button onclick="holdAndClose()" style="padding:15px; background:#fde68a; color:#92400e; border:2px solid #f59e0b; border-radius:12px; font-weight:900; font-size:16px; cursor:pointer;">
                        üü° HOLD<br><span style="font-size:12px; font-weight:700;">Save for later</span>
                    </button>
                    <button onclick="saveAndClose()" style="padding:15px; background:#22c55e; color:white; border:2px solid #16a34a; border-radius:12px; font-weight:900; font-size:16px; cursor:pointer;">
                        üü¢ SAVE<br><span style="font-size:12px; font-weight:700;">Complete order</span>
                    </button>
                </div>
                
                <button onclick="closeAndDiscard()" style="margin-top:15px; padding:10px; background:#f1f5f9; color:#64748b; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">
                    ‚ùå Discard and Close
                </button>
            </div>
        </div>
    </div>

    <!-- Shop Settings Modal -->
    <div class="overlay" id="settingsModal">
        <div class="modal" style="width:450px; height:auto;">
            <div class="panelHeader"><span>‚öôÔ∏è Shop Settings</span> <button onclick="closeModal('settingsModal')">‚úñ</button></div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:15px;">
                <div>
                    <label style="font-size:12px; font-weight:700; color:var(--muted); display:block; margin-bottom:5px;">Shop Name</label>
                    <input type="text" id="shopNameInput" placeholder="e.g., Gopal Dairy Shop" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--line); font-weight:700;" />
                </div>
                <div>
                    <label style="font-size:12px; font-weight:700; color:var(--muted); display:block; margin-bottom:5px;">Shop Phone (for invoice)</label>
                    <input type="tel" id="shopPhoneInput" placeholder="e.g., 9876543210" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--line); font-weight:700;" inputmode="tel" />
                </div>
                <div style="background:#f0f9ff; padding:12px; border-radius:8px; border:1px solid #3b82f6;">
                    <p style="font-size:12px; color:#1e40af; margin:0;">üí° Tip: Select booth or enter custom shop name. This appears on invoices and WhatsApp messages.</p>
                </div>
                <button onclick="saveShopSettings()" style="padding:15px; background:var(--green); color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:14px;">üíæ Save Settings</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Institutional Gaps Panel -->
    <button class="gaps-toggle" onclick="toggleGaps()" title="Institutional Records">üìã</button>
    <div class="gaps-panel" id="gapsPanel">
      <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #1e293b;">Institutional Records (Not Tracked)</h3>
      
      <div class="gap-item">
        <h4>üü° Farmer source</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
      
      <div class="gap-item">
        <h4>üü° Quality test (Fat/SNF)</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
      
      <div class="gap-item">
        <h4>üü° Payment settlement</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
      
      <div class="gap-item">
        <h4>üü° Deductions / loans</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
      
      <div class="gap-item">
        <h4>üü° Equipment logs</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
    </div>

    <!-- Backend API Calls -->
    <script>
      console.log('üöÄ POS Backend: Using Supabase APIs');
    </script>
    <script>
      // Check if backend is configured
      let useBackend = false;
      let currentShopId = null;
      let currentUserId = null;
      let authToken = null;
      
      // Initialize Supabase
      window.addEventListener('DOMContentLoaded', async () => {
        if (window.MilkBookConfig && window.MilkBookConfig.isConfigured()) {
          useBackend = true;
          console.log('‚úÖ Backend connected');
          
          // Check if user is logged in
          const session = localStorage.getItem('milkbook_session');
          if (session) {
            const sessionData = JSON.parse(session);
            currentShopId = sessionData.shop_id;
            currentUserId = sessionData.user_id;
            authToken = sessionData.token;
            
            // Load customers from backend
            await loadCustomersFromBackend();
            
            // Load sales history from backend
            await loadSalesFromBackend();
          }
        } else {
          console.log('‚ö†Ô∏è Using offline mode (localStorage)');
        }
      });
      
      // Warn before close/refresh if cart has items
      window.addEventListener('beforeunload', (e) => {
        if (cart.length > 0) {
          // Show our custom modal instead of browser default
          e.preventDefault();
          e.returnValue = '';
          
          // Open the unsaved cart modal
          const modal = document.getElementById('unsavedCartModal');
          if (modal) {
            modal.style.display = 'flex';
          }
          
          return '';
        }
      });
      
      // Hold and close
      function holdAndClose() {
        if (cart.length > 0) {
          holdCart();
          closeModal('unsavedCartModal');
          showToast('Order held! You can now close safely ‚úÖ');
        }
      }
      
      // Save and close
      function saveAndClose() {
        if (cart.length > 0) {
          saveEntry('Quick');
          closeModal('unsavedCartModal');
          showToast('Order saved! You can now close ‚úÖ');
        }
      }
      
      // Close and discard
      function closeAndDiscard() {
        cart = [];
        updateUI();
        closeModal('unsavedCartModal');
        showToast('Order discarded');
      }
      
      // Show hold/save popup on page hide (tab close, refresh, navigation)
      window.addEventListener('visibilitychange', async () => {
        if (document.visibilityState === 'hidden' && cart.length > 0) {
          // Auto-hold the cart
          const customerName = el("activeCust").innerText;
          const holdId = Date.now();
          
          heldCarts.push({
            id: holdId,
            customer: customerName,
            cart: [...cart],
            total: total,
            timestamp: new Date().toISOString()
          });
          
          localStorage.setItem('mr_held_carts', JSON.stringify(heldCarts));
          console.log('üü° Auto-held cart for', customerName);
        }
      });
      
      // Load customers from backend
      async function loadCustomersFromBackend() {
        if (!useBackend || !currentShopId) return;
        
        try {
          // In real implementation, fetch from API
          // const response = await fetch('/.netlify/functions/customers', {
          //   headers: { 'Authorization': `Bearer ${authToken}` }
          // });
          // const { customers } = await response.json();
          // customers.forEach(c => {
          //   if (!customersData.find(existing => existing.name === c.name)) {
          //     customersData.push(c);
          //   }
          // });
          console.log('Loaded customers from backend');
        } catch (error) {
          console.error('Failed to load customers:', error);
        }
      }
      
      // Load sales from backend
      async function loadSalesFromBackend() {
        if (!useBackend || !currentShopId) return;
        
        try {
          // In real implementation, fetch from API
          console.log('Loaded sales from backend');
        } catch (error) {
          console.error('Failed to load sales:', error);
        }
      }
      
      // Save sale to backend
      async function saveSaleToBackend(saleData) {
        if (!useBackend || !currentShopId) return null;
        
        try {
          const response = await fetch('/.netlify/functions/sales', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
              shop_id: currentShopId,
              customer_name: saleData.customer,
              customer_phone: saleData.phone || '',
              items: saleData.items,
              total_amount: saleData.total,
              payment_mode: saleData.paymentMode
            })
          });
          
          if (response.ok) {
            const { sale } = await response.json();
            return sale;
          }
          return null;
        } catch (error) {
          console.error('Failed to save sale:', error);
          return null;
        }
      }
    </script>
    <script>
      const el = (id) => document.getElementById(id);
      let cart = [], total = 0, exportHistory = [], currentLang = 'en';
      let heldCarts = JSON.parse(localStorage.getItem('mr_held_carts') || '[]'); // Hold functionality
      let lastRate = parseFloat(localStorage.getItem('mr_last_rate') || '64'); // Save/retrieve last rate
      
      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // Load data from LocalStorage taaki refresh par na ude
let customers = JSON.parse(localStorage.getItem('mr_pos_customers')) || [
    { name: "Rahul Sharma", lastOrder: "1.5L Cow Milk", rate: 64, qty: 1.5, type: "Retail", sub: 1.5 },
    { name: "Amit DCS", lastOrder: "1kg Paneer", rate: 320, qty: 1, type: "PACS", sub: 2 }
];


      // Logic: 4am-4pm Morning, 4pm-4am Evening
      function updateShift() {
          const now = new Date();
          const hrs = now.getHours();
          const dateStr = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
          const shift = (hrs >= 4 && hrs < 16) ? (currentLang === 'en' ? 'Morning Shift' : '‡§∏‡•Å‡§¨‡§π ‡§ï‡•Ä ‡§™‡§æ‡§≤‡•Ä') : (currentLang === 'en' ? 'Evening Shift' : '‡§∂‡§æ‡§Æ ‡§ï‡•Ä ‡§™‡§æ‡§≤‡•Ä');
          el("todayLabel").textContent = `${dateStr} | ${shift}`;
          
          // Load shop name and user info from session
          loadUserInfo();
      }
      
      // Load user info from session
      function loadUserInfo() {
          const session = localStorage.getItem('milkbook_session');
          if (session) {
              try {
                  const sessionData = JSON.parse(session);
                  const shopTitle = el("shopTitle");
                  const todayLabel = el("todayLabel");
                  
                  if (shopTitle && sessionData.shop_name) {
                      shopTitle.textContent = sessionData.shop_name;
                  }
                  
                  if (todayLabel && sessionData.email) {
                      const dateStr = todayLabel.textContent.split('|')[0] || '';
                      todayLabel.textContent = `${dateStr} | üë§ ${sessionData.email}`;
                  }
              } catch (error) {
                  console.error('Error loading session:', error);
              }
          }
      }

      // Logic: Hindi Translation Dictionary
      const langData = {
          en: { shop:"MilkRecord POS", mem:"üß† Memory", hist:"üßæ History", exp:"üìä Export", term:"Terminal", sum:"Summary", payable:"TOTAL PAYABLE", cash:"CASH", credit:"LIKH LO (Credit)", hold:"üü° HOLD", done:"üü¢ DONE", clear:"üî¥ CLEAR" },
          hi: { shop:"‡§Æ‡§ø‡§≤‡•ç‡§ï-‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°", mem:"üß† ‡§Ø‡§æ‡§¶‡•á‡§Ç", hist:"üßæ ‡§á‡§§‡§ø‡§π‡§æ‡§∏", exp:"üìä ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü", term:"‡§ü‡§∞‡•ç‡§Æ‡§ø‡§®‡§≤", sum:"‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂", payable:"‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø ‡§∞‡§æ‡§∂‡§ø", cash:"‡§®‡§ï‡§¶", credit:"‡§≤‡§ø‡§ñ ‡§≤‡•ã (‡§â‡§ß‡§æ‡§∞)", hold:"üü° ‡§π‡•ã‡§≤‡•ç‡§°", done:"üü¢ ‡§™‡•Ç‡§∞‡•ç‡§£", clear:"üî¥ ‡§∏‡§æ‡•û ‡§ï‡§∞‡•á‡§Ç" }
      };

      function toggleLanguage() {
          currentLang = currentLang === 'en' ? 'hi' : 'en';
          const t = langData[currentLang];
          
          // Safe element updates with null checks
          const shopTitle = el("shopTitle");
          if (shopTitle) shopTitle.textContent = t.shop;
          
          const btnMem = el("btnMem");
          if (btnMem) btnMem.innerHTML = t.mem;
          const btnHist = el("btnHist");
          if (btnHist) btnHist.innerHTML = t.hist;
          const btnExp = el("btnExp");
          if (btnExp) btnExp.innerHTML = t.exp;
          
          const lblTerm = el("lblTerm");
          if (lblTerm) lblTerm.textContent = t.term;
          const lblSum = el("lblSum");
          if (lblSum) lblSum.textContent = t.sum;
          const lblPayable = el("lblPayable");
          if (lblPayable) lblPayable.textContent = t.payable;
          
          const btnCash = el("btnCash");
          if (btnCash) btnCash.textContent = t.cash;
          const btnCredit = el("btnCredit");
          if (btnCredit) btnCredit.textContent = t.credit;

          const txtHold = el("txtHold");
          if (txtHold) txtHold.textContent = t.hold;
          const txtDone = el("txtDone");
          if (txtDone) txtDone.textContent = t.done;
          const txtClear = el("txtClear");
          if (txtClear) txtClear.textContent = t.clear;

          // Cards translation using data attributes
          document.querySelectorAll("[data-en]").forEach(i => i.textContent = currentLang === 'en' ? i.dataset.en : i.dataset.hi);
          updateShift();
          showToast(currentLang === 'en' ? "English Enabled" : "‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø");
      }

      // Logout function
      function logout() {
          if (confirm('Are you sure you want to logout?')) {
              // Clear session
              localStorage.removeItem('milkbook_session');

              // Clear any other stored data if needed
              // localStorage.removeItem('milkbook_supabase_url');
              // localStorage.removeItem('milkbook_supabase_key');

              showToast('Logged out successfully!');

              // Redirect to login page
              setTimeout(() => {
                  window.location.href = 'login.html';
              }, 500);
          }
      }
      
      // Toggle profile dropdown
      function toggleProfileDropdown() {
          const dropdown = document.getElementById('profileDropdown');
          dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
          
          // Load user info
          const session = localStorage.getItem('milkbook_session');
          if (session) {
              const data = JSON.parse(session);
              document.getElementById('profileName').textContent = data.shop_name || 'User';
              document.getElementById('dropdownEmail').textContent = data.email || 'user@email.com';
              document.getElementById('dropdownShop').textContent = data.shop_name || 'Shop';
          }
      }
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
          const dropdown = document.getElementById('profileDropdown');
          const button = e.target.closest('button');
          if (dropdown && (!button || !button.onclick?.toString().includes('toggleProfileDropdown'))) {
              dropdown.style.display = 'none';
          }
      });

      // Calculate credit based on payment amount
      function calculateCredit() {
        const paymentAmount = parseFloat(el("paymentAmount").value) || 0;
        const creditDisplay = el("creditDisplay");
        
        if (paymentAmount > 0) {
          const remaining = total - paymentAmount;
          if (remaining > 0) {
            creditDisplay.textContent = `‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§¶‡•á‡§Ç‡§ó‡•á: ‚Çπ${remaining.toFixed(2)}`;
            creditDisplay.style.color = '#dc2626';
          } else if (remaining < 0) {
            creditDisplay.textContent = `‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§Æ‡§ø‡§≤‡§æ: ‚Çπ${Math.abs(remaining).toFixed(2)}`;
            creditDisplay.style.color = '#16a34a';
          } else {
            creditDisplay.textContent = '‡§∏‡§π‡•Ä ‡§∞‡§æ‡§∂‡§ø!';
            creditDisplay.style.color = '#16a34a';
          }
        } else {
          creditDisplay.textContent = '';
        }
      }
      
      // Save entry, download invoice, and open WhatsApp or print
      function saveAndInvoice() {
        if (total === 0) return showToast('Cart is empty!');
        
        const customerName = el("activeCust").innerText;
        let paymentAmount = parseFloat(el("paymentAmount").value);
        
        // If payment amount not entered, ask user
        if (!paymentAmount || paymentAmount <= 0) {
          paymentAmount = total; // Default to full amount
        }
        
        const customer = customers.find(c => c.name === customerName);
        
        // Determine payment mode and calculate credit
        let paymentMode = 'Cash';
        let creditAmount = 0;
        
        if (paymentAmount < total) {
          paymentMode = 'Credit';
          creditAmount = total - paymentAmount;
        }
        
        // Update customer ledger with credit
        if (customer && creditAmount > 0) {
          if (!customer.balance) customer.balance = 0;
          customer.balance += creditAmount;
          if (!customer.advance) customer.advance = 0;
          customer.advance += creditAmount;
          localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
          showToast(`‚Çπ${creditAmount.toFixed(2)} added to ledger ‚úÖ`);
        }
        
        // Save the entry with correct payment info
        saveEntryWithPayment(paymentMode, paymentAmount, creditAmount);
        
        // Generate and download invoice
        generateInvoice(customerName, paymentAmount, paymentMode, creditAmount);
        
        // Open WhatsApp after a short delay if phone exists, otherwise print
        setTimeout(() => {
          if (customer && customer.phone && customer.phone.trim().length >= 10) {
            // Phone exists - open WhatsApp
            openWhatsAppInvoice(customer, paymentAmount, creditAmount);
          } else {
            // No phone - open invoice in new tab and print
            printInvoice(customerName, paymentAmount, paymentMode, creditAmount);
          }
        }, 500);
      }
      
      // Save entry with payment details
      function saveEntryWithPayment(mode, paidAmount, creditAmount) {
        if(total === 0) return showToast("Cart empty");
        const custName = el("activeCust").innerText;
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const itemsDetail = cart.map(i => `${i.qty}x ${i.name}`).join(" | ");

        // Auto-create customer if new (typed name)
        if (!customers.find(c => c.name === custName) && custName !== "Walking Customer") {
            customers.push({ 
              name: custName, 
              lastOrder: itemsDetail, 
              rate: cart[0]?.rate || 0, 
              qty: cart[0]?.qty || 0,
              type: "Retail",
              sub: 0,
              balance: creditAmount > 0 ? creditAmount : 0,
              advance: creditAmount > 0 ? creditAmount : 0,
              monthMilk: 0
            });
            localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
        }

        // Calculate total milk quantity for month tracking
        const totalMilkQty = cart.filter(i => i.name.includes('Milk')).reduce((sum, i) => sum + i.qty, 0);

        // Save full cart data for replay
        const newSale = {
          date: new Date().toLocaleDateString(),
          time,
          customer: custName,
          products: itemsDetail,
          amount: total.toFixed(2),
          method: mode,
          paidAmount: paidAmount.toFixed(2),
          creditAmount: creditAmount.toFixed(2),
          cartItems: JSON.parse(JSON.stringify(cart))
        };

        // Add to history
        exportHistory.push(newSale);
        localStorage.setItem('mr_sales_history', JSON.stringify(exportHistory));

        // Update customer
        let cIdx = customers.findIndex(c => c.name === custName);
        if(cIdx !== -1) {
            customers[cIdx].lastOrder = itemsDetail;
            customers[cIdx].rate = cart[0]?.rate || 0;
            customers[cIdx].qty = cart[0]?.qty || 0;
            customers[cIdx].lastProductName = cart[0]?.name || '';
            if (!customers[cIdx].monthMilk) customers[cIdx].monthMilk = 0;
            customers[cIdx].monthMilk += totalMilkQty;
            localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
        }

        // Update UI
        const entry = `<div class="cardRow" style="flex-direction:column; align-items:flex-start; gap:4px; cursor:pointer;" onclick="loadOrderFromHistory('${custName}', ${JSON.stringify(cart).replace(/"/g, '&quot;')})">
          <div style="width:100%; display:flex; justify-content:space-between;">
            <b>${custName}</b><b>‚Çπ${total.toFixed(2)}</b>
          </div>
          <div style="font-size:11px; color:var(--muted); font-weight:700;">
            ${time} ‚Ä¢ üõí ${itemsDetail} ‚Ä¢ ${modeIcon(mode)} ${mode}${creditAmount > 0 ? ` ‚Ä¢ Credit: ‚Çπ${creditAmount.toFixed(2)}` : ''}
            <span style="color:var(--blue); font-weight:700; margin-left:8px;">üîÅ Click to reload</span>
          </div>
        </div>`;
        el("historyToday").innerHTML = entry + el("historyToday").innerHTML;

        resetCart();
        showToast(`Saved! Paid: ‚Çπ${paidAmount.toFixed(2)}${creditAmount > 0 ? ` ‚Ä¢ Credit: ‚Çπ${creditAmount.toFixed(2)}` : ''} ‚úÖ`);
      }
      
      // Generate invoice HTML and download as PDF
      function generateInvoice(customerName, paymentAmount, paymentMode, creditAmount) {
        const date = new Date().toLocaleDateString('en-IN', {
          day: 'numeric', month: 'short', year: 'numeric',
          hour: '2-digit', minute: '2-digit'
        });
        const invoiceNo = 'INV-' + Date.now().toString().slice(-6);
        
        // Get customer object for contact details
        const customer = customers.find(c => c.name === customerName);
        
        // Get shop name from booth selection or localStorage
        const booth = localStorage.getItem('milkbook_booth') || 'main';
        const boothNames = {
          'main': 'Main Booth',
          'village-a': 'Village A Booth',
          'village-b': 'Village B Booth',
          'market': 'Market Booth'
        };
        const shopName = localStorage.getItem('milkbook_shop_name') || boothNames[booth] || 'Gopal Dairy Shop';
        const shopPhone = localStorage.getItem('milkbook_shop_phone') || '';

        // Create invoice HTML
        const invoiceHTML = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>Invoice - ${invoiceNo}</title>
            <style>
              @media print {
                body { padding: 10px; }
                .no-print { display: none; }
              }
              body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
              .header { text-align: center; border-bottom: 3px solid #3b82f6; padding-bottom: 15px; margin-bottom: 20px; }
              .header h1 { color: #1e293b; margin: 0; font-size: 24px; }
              .header p { color: #64748b; margin: 5px 0; font-size: 14px; }
              .shop-info { background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
              .shop-info h2 { margin: 0 0 5px 0; color: #1e293b; font-size: 18px; }
              .shop-info p { margin: 0; color: #64748b; font-size: 13px; }
              .info { display: flex; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; }
              .info div { font-size: 14px; line-height: 1.6; }
              .customer-details { font-weight: 600; color: #1e293b; }
              .customer-contact { font-size: 12px; color: #64748b; margin-top: 4px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
              th { background: #f1f5f9; padding: 10px; text-align: left; font-weight: 700; }
              td { padding: 10px; border-bottom: 1px solid #e2e8f0; }
              .total { text-align: right; font-size: 18px; font-weight: 900; color: #1e293b; padding: 10px; background: #f0fdf4; border-radius: 8px; }
              .payment { background: #f0fdf4; padding: 15px; border-radius: 8px; margin-top: 15px; }
              .footer { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 2px solid #e2e8f0; color: #64748b; font-size: 12px; }
              .btn-group { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
              .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px; text-decoration: none; display: inline-block; }
              .btn-print { background: #3b82f6; color: white; }
              .btn-whatsapp { background: #25D366; color: white; }
              .btn:hover { opacity: 0.9; }
            </style>
          </head>
          <body>
            <div class="shop-info">
              <h2>${shopName}</h2>
              ${shopPhone ? `<p>üì± +91${shopPhone}</p>` : ''}
            </div>
            <div class="header">
              <h1>üßæ Tax Invoice</h1>
              <p>${invoiceNo} | ${date}</p>
            </div>
            <div class="info">
              <div>
                <div class="customer-details"><strong>Customer:</strong><br>${customerName}</div>
                ${customer && customer.phone ? `<div class="customer-contact">üì± +91${customer.phone}</div>` : ''}
                ${customer && customer.email ? `<div class="customer-contact">‚úâÔ∏è ${customer.email}</div>` : ''}
              </div>
              <div style="text-align: right;">
                <strong>Payment:</strong><br>
                ${paymentMode} - ‚Çπ${paymentAmount.toFixed(2)}<br>
                ${creditAmount > 0 ? `<span style="color: #dc2626;">Credit (Udhar): ‚Çπ${creditAmount.toFixed(2)}</span>` : ''}
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th style="text-align:center">Qty</th>
                  <th style="text-align:right">Rate</th>
                  <th style="text-align:right">Amount</th>
                </tr>
              </thead>
              <tbody>
                ${cart.map(item => `
                  <tr>
                    <td>${item.name}</td>
                    <td style="text-align:center">${item.qty}</td>
                    <td style="text-align:right">‚Çπ${item.rate}</td>
                    <td style="text-align:right">‚Çπ${(item.qty * item.rate).toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <div class="total">
              Total: ‚Çπ${total.toFixed(2)}
            </div>
            <div class="payment">
              <strong>Amount Paid:</strong> ‚Çπ${paymentAmount.toFixed(2)}<br>
              ${creditAmount > 0 ? `<strong>Credit (Udhar):</strong> ‚Çπ${creditAmount.toFixed(2)}` : ''}
            </div>
            <div class="footer">
              <p>Thank you for your business! üôè</p>
              <p>${shopName} | MilkRecord POS</p>
              <p>Generated: ${date}</p>
            </div>
            <div class="btn-group no-print">
              <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Print Invoice</button>
              <a href="https://wa.me/${customer && customer.phone ? '91' + customer.phone.replace(/\D/g, '') : ''}?text=${encodeURIComponent(generateWhatsAppMessage(invoiceNo, date, customerName, paymentAmount, creditAmount))}" target="_blank" class="btn btn-whatsapp">üí¨ Share on WhatsApp</a>
            </div>
          </body>
          </html>
        `;

        // Create blob and download
        const blob = new Blob([invoiceHTML], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Invoice-${invoiceNo}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('Invoice downloaded! üìÑ');
      }
      
      // Generate WhatsApp message
      function generateWhatsAppMessage(invoiceNo, date, customerName, paymentAmount, creditAmount) {
        const booth = localStorage.getItem('milkbook_booth') || 'main';
        const boothNames = {
          'main': 'Main Booth',
          'village-a': 'Village A Booth',
          'village-b': 'Village B Booth',
          'market': 'Market Booth'
        };
        const shopName = localStorage.getItem('milkbook_shop_name') || boothNames[booth] || 'Gopal Dairy Shop';
        
        let message = `*${shopName}*\n`;
        message += `üßæ Invoice: ${invoiceNo}\n`;
        message += `üìÖ Date: ${date}\n\n`;
        message += `*Customer:* ${customerName}\n\n`;
        message += `*Items:*\n`;
        cart.forEach(item => {
          message += `‚Ä¢ ${item.name} - ${item.qty} x ‚Çπ${item.rate} = ‚Çπ${(item.qty * item.rate).toFixed(2)}\n`;
        });
        message += `\n*Total: ‚Çπ${total.toFixed(2)}*`;
        message += `\nPaid: ‚Çπ${paymentAmount.toFixed(2)}`;
        if (creditAmount > 0) {
          message += `\n*Credit (Udhar): ‚Çπ${creditAmount.toFixed(2)}*`;
        }
        message += `\n\nThank you for your business! üôè`;
        return message;
      }
      
      // Print invoice in new tab
      function printInvoice(customerName, paymentAmount, paymentMode, creditAmount) {
        const date = new Date().toLocaleDateString('en-IN', { 
          day: 'numeric', month: 'short', year: 'numeric',
          hour: '2-digit', minute: '2-digit'
        });
        const invoiceNo = 'INV-' + Date.now().toString().slice(-6);
        const customer = customers.find(c => c.name === customerName);
        
        // Create invoice HTML for printing
        const invoiceHTML = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>Print Invoice - ${invoiceNo}</title>
            <style>
              @media print {
                body { padding: 10px; }
                .no-print { display: none; }
                @page { margin: 10mm; }
              }
              body { font-family: Arial, sans-serif; padding: 20px; max-width: 580px; margin: 0 auto; }
              .header { text-align: center; border-bottom: 3px solid #3b82f6; padding-bottom: 15px; margin-bottom: 20px; }
              .header h1 { color: #1e293b; margin: 0; font-size: 22px; }
              .header p { color: #64748b; margin: 5px 0; }
              .info { display: flex; justify-content: space-between; margin-bottom: 20px; }
              .info div { font-size: 13px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
              th { background: #f1f5f9; padding: 8px; text-align: left; font-weight: 700; font-size: 13px; }
              td { padding: 8px; border-bottom: 1px solid #e2e8f0; font-size: 13px; }
              .total { text-align: right; font-size: 16px; font-weight: 900; color: #1e293b; }
              .payment { background: #f0fdf4; padding: 12px; border-radius: 6px; margin-top: 15px; font-size: 13px; }
              .footer { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 2px solid #e2e8f0; color: #64748b; font-size: 11px; }
              .print-btn { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px; margin: 20px auto; display: block; }
              .print-btn:hover { background: #2563eb; }
            </style>
          </head>
          <body onload="window.print()">
            <div class="header">
              <h1>üßæ MilkRecord Invoice</h1>
              <p>${invoiceNo} | ${date}</p>
            </div>
            <div class="info">
              <div><strong>Customer:</strong><br>${customerName}${customer && customer.phone ? `<br>üì± +91${customer.phone}` : ''}</div>
              <div><strong>Payment:</strong><br>${paymentMode} - ‚Çπ${paymentAmount.toFixed(2)}</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th style="text-align:center">Qty</th>
                  <th style="text-align:right">Rate</th>
                  <th style="text-align:right">Amount</th>
                </tr>
              </thead>
              <tbody>
                ${cart.map(item => `
                  <tr>
                    <td>${item.name}</td>
                    <td style="text-align:center">${item.qty}</td>
                    <td style="text-align:right">‚Çπ${item.rate}</td>
                    <td style="text-align:right">‚Çπ${(item.qty * item.rate).toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <div class="total">
              Total: ‚Çπ${total.toFixed(2)}
            </div>
            <div class="payment">
              <strong>Amount Paid:</strong> ‚Çπ${paymentAmount.toFixed(2)}<br>
              ${creditAmount > 0 ? `<strong>Credit (Udhar):</strong> ‚Çπ${creditAmount.toFixed(2)}` : ''}
              ${creditAmount > 0 ? `<br><strong>Remaining Balance:</strong> ‚Çπ${creditAmount.toFixed(2)}` : ''}
            </div>
            <div class="footer">
              <p>Thank you for your business! üôè</p>
              <p>MilkRecord POS | Generated: ${date}</p>
            </div>
            <button class="print-btn no-print" onclick="window.print()">üñ®Ô∏è Print Invoice</button>
            <p class="no-print" style="text-align:center; color:#64748b; font-size:12px;">Press Ctrl+P to print</p>
          </body>
          </html>
        `;
        
        // Open in new tab
        const newWindow = window.open('', '_blank');
        newWindow.document.write(invoiceHTML);
        newWindow.document.close();
        
        showToast('Opening invoice for print... üñ®Ô∏è');
      }
      
      // Open WhatsApp with invoice message
      function openWhatsAppInvoice(customer, paymentAmount, creditAmount) {
        const customerName = el("activeCust").innerText;
        const date = new Date().toLocaleDateString('en-IN');
        const invoiceNo = 'INV-' + Date.now().toString().slice(-6);

        // Build WhatsApp message with emojis
        let message = `üßæ *MilkRecord Invoice*
üìÖ ${date} | üîñ ${invoiceNo}

üë§ *Customer:* ${customerName}

üõí *Items:*
${cart.map(item => `${getEmojiForProduct(item.name)} ${item.name} - ${item.qty} x ‚Çπ${item.rate} = ‚Çπ${(item.qty * item.rate).toFixed(2)}`).join('\n')}

üí∞ *Total:* ‚Çπ${total.toFixed(2)}
üíµ *Paid:* ‚Çπ${paymentAmount.toFixed(2)}
${creditAmount > 0 ? `üìí *Credit (Udhar):* ‚Çπ${creditAmount.toFixed(2)}` : ''}
${creditAmount > 0 ? `‚öñÔ∏è *Balance:* ‚Çπ${creditAmount.toFixed(2)}` : ''}

üôè Thank you!
üè™ MilkRecord POS`;

        // Encode for WhatsApp
        const encodedMessage = encodeURIComponent(message);

        // Get customer phone or open WhatsApp picker
        let whatsappUrl;
        if (customer && customer.phone) {
          whatsappUrl = `https://wa.me/91${customer.phone.replace(/\D/g, '')}?text=${encodedMessage}`;
        } else {
          whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
        }

        // Open WhatsApp
        window.open(whatsappUrl, '_blank');
        showToast('Opening WhatsApp... üí¨');
      }
      
      // Logic: Persistent Search Dropdown with Keyboard Support
      let selectedDropIndex = -1;
      
      // Load customers from localStorage (offline mode)
      function loadCustomers() {
        try {
          const stored = localStorage.getItem('mr_pos_customers');
          if (stored) {
            customers = JSON.parse(stored);
            console.log('‚úÖ Loaded', customers.length, 'customers (Offline)');
          } else {
            // Initialize with empty array
            customers = [];
            localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
            console.log('‚úÖ Initialized customer storage (Offline)');
          }
        } catch (error) {
          console.error('Error loading customers:', error);
          customers = [];
        }
      }

      // Load customers on page load
      loadCustomers();

      function handleSearch(val) {
          const drop = el("searchDropdown");
          const searchVal = val.trim();

          // Show ALL customers when search is focused (even if empty)
          const filtered = !searchVal
            ? customers
            : customers.filter(c => c.name.toLowerCase().includes(searchVal.toLowerCase()));

          // Always show dropdown when there's input or focus
          if (searchVal || document.activeElement === el("custSearch")) {
              let html = '';
              selectedDropIndex = -1;

              // Always show "Add New Customer" option at top
              if (searchVal) {
                  html += `
                    <div class="drop-item add-new" onclick="addCustomerDirect('${escapeHtml(searchVal)}')" data-index="0">
                      <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:18px;">‚ûï</span>
                        <div>
                          <div style="font-weight:900; color:#166534;">Add New Customer</div>
                          <div style="font-size:11px; color:#15803d;">"${escapeHtml(searchVal)}"</div>
                        </div>
                      </div>
                    </div>
                  `;
              }

              // Show matching customers
              if (filtered.length > 0) {
                  html += filtered.map((c, i) => `
                    <div class="drop-item" onclick="selectCust('${c.name}')" data-index="${i + 1}" style="display:flex; justify-content:space-between; align-items:center;">
                      <div>
                        <div style="font-weight:700;">${c.name}</div>
                        <div style="font-size:11px; color:var(--muted);">${c.phone || 'No phone'}</div>
                      </div>
                      <div style="text-align:right;">
                        ${c.balance > 0 ? `<div style="font-size:11px; color:#dc2626; font-weight:700;">üìï ‚Çπ${c.balance.toFixed(2)}</div>` : ''}
                        <div style="font-size:11px; color:var(--muted);">Bal: ‚Çπ${(c.balance || 0).toFixed(2)}</div>
                      </div>
                    </div>
                  `).join('');
              } else if (!searchVal) {
                  html += '<div style="padding:15px; text-align:center; color:var(--muted); font-size:12px;">Start typing to search customers</div>';
              }

              drop.innerHTML = html;
              drop.style.display = 'block';
          } else {
            drop.style.display = 'none';
          }
      }
      
      // Arrow key navigation for dropdown
      el("custSearch").addEventListener('keydown', function(e) {
        const drop = el("searchDropdown");
        const items = drop.querySelectorAll('.drop-item');
        
        if (drop.style.display === 'none' || items.length === 0) return;
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedDropIndex = Math.min(selectedDropIndex + 1, items.length - 1);
          updateSelectedDropItem(items);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedDropIndex = Math.max(selectedDropIndex - 1, 0);
          updateSelectedDropItem(items);
        } else if (e.key === 'Enter' && selectedDropIndex >= 0) {
          e.preventDefault();
          items[selectedDropIndex].click();
        } else if (e.key === 'Escape') {
          drop.style.display = 'none';
        }
      });
      
      function updateSelectedDropItem(items) {
        items.forEach((item, i) => {
          if (i === selectedDropIndex) {
            item.classList.add('selected');
            item.scrollIntoView({ block: 'nearest' });
          } else {
            item.classList.remove('selected');
          }
        });
      }
      
      // Add customer directly from dropdown (offline mode)
      function addCustomerDirect(name) {
        if (!name) return;

        // Check if customer already exists
        const existing = customers.find(c => c.name.toLowerCase() === name.toLowerCase());
        if (existing) {
          selectCust(existing.name);
          showToast('Customer selected: ' + name);
          return;
        }

        // Create customer locally (offline mode)
        const newCustomer = {
          id: "cust_" + Date.now(),
          name: name,
          phone: "",
          email: "",
          balance: 0,
          advance: 0,
          monthMilk: 0,
          frequentBuys: [],
          createdAt: Date.now()
        };

        // Add to local array for immediate UI update
        customers.push(newCustomer);
        localStorage.setItem('mr_pos_customers', JSON.stringify(customers));

        selectCust(name);
        el("custSearch").value = name;
        el("searchDropdown").style.display = 'none';
        showToast(name + ' added (Offline) ‚úÖ');
      }
      
      // Show all customers when search is focused
      el("custSearch").addEventListener('focus', function() {
        handleSearch('');
      });
      
      // Add customer with validation
      function addCust() {
        const name = el("newName").value;
        const type = el("newType").value;
        const sub = el("subQty").value || 0;
        if(!name) return showToast("Name required!");

        customers.push({ name, lastOrder: "No order yet", rate: 0, qty: 0, type, sub });
        localStorage.setItem('mr_pos_customers', JSON.stringify(customers));

        selectCust(name);
        closeModal('addCustModal');
        el("newName").value = "";
        el("subQty").value = "";
        showToast(name + " Added!");
        
        // Return focus to search
        setTimeout(() => el("custSearch").focus(), 100);
      }
      
      // Select customer from search
      function selectCust(name) {
          // Update search input to show selected customer
          const searchInput = el("custSearch");
          searchInput.value = name;
          searchInput.style.borderColor = '#22c55e';
          searchInput.style.background = '#f0fdf4';
          el("searchDropdown").style.display = "none";

          // Update hidden activeCust element for backwards compatibility
          const activeCustEl = el("activeCust");
          if (activeCustEl) activeCustEl.innerText = name;

          showToast("Customer: " + name);

          // Auto-fill from customer memory (previous orders)
          loadCustomerMemory(name);

          // Auto-fill frequent buys / last invoice from memory
          const customer = customers.find(c => c.name === name);
          if (customer && customer.frequentBuys && customer.frequentBuys.length > 0) {
            // Clear current cart and add frequent buys
            cart = [];
            customer.frequentBuys.forEach(buy => {
              cart.push({
                name: buy.name,
                rate: buy.rate,
                qty: buy.qty,
                id: Date.now() + Math.random()
              });
            });
            updateUI();
            showToast(`Loaded ${customer.frequentBuys.length} frequent items ‚úÖ`);
          }

          // Show advance toggle for this customer
          showAdvanceSection(name);
      }
      
      // Show advance/cut ledger - ONLY if customer has credit history
      function showAdvanceSection(customerName) {
        const customer = customers.find(c => c.name === customerName);
        if (!customer) {
          el("advanceSection").style.display = "none";
          el("advanceToggleBtn").style.display = "none";
          el("udharThresholdNudge").style.display = "none";
          return;
        }

        // Initialize advance if not exists
        if (!customer.advance) customer.advance = 0;
        if (!customer.monthMilk) customer.monthMilk = 0;

        el("monthMilk").textContent = customer.monthMilk.toFixed(1) + ' L';
        el("currentAdvance").textContent = '‚Çπ' + customer.advance.toFixed(2);

        // Show advance toggle button ONLY if customer has unpaid/credit history
        const advanceBtn = el("advanceToggleBtn");
        if (customer.advance > 0 || customer.balance < 0) {
          // Customer has credit history - show button
          advanceBtn.style.display = "flex";
          if (customer.advance > 0) {
            advanceBtn.innerHTML = `üìï Udhar: ‚Çπ${customer.advance.toFixed(2)}`;
          } else {
            advanceBtn.innerHTML = 'üìï Advance / Udhar';
          }
        } else {
          // No credit history - hide button
          advanceBtn.style.display = "none";
        }

        // Show Udhar threshold nudge if high credit
        const udharNudge = el("udharThresholdNudge");
        if (udharNudge) {
          udharNudge.style.display = (customer.advance || 0) > 3000 ? 'block' : 'none';
        }
      }
      
      // Toggle advance section visibility
      function toggleAdvance() {
        const section = el("advanceSection");
        if (section.style.display === 'none' || section.style.display === '') {
          section.style.display = 'block';
          const customerName = el("activeCust").innerText;
          if (customerName && customerName !== 'Walking Customer') {
            showAdvanceSection(customerName);
          }
        } else {
          section.style.display = 'none';
        }
      }

      // Close advance section
      function closeAdvance() {
        el("advanceSection").style.display = 'none';
      }
      
      // Update ledger placeholder based on toggle
      function updateLedgerPlaceholder() {
        const isCredit = document.querySelector('input[name="ledgerType"][value="credit"]').checked;
        const creditToggle = document.getElementById('creditToggle');
        const debitToggle = document.getElementById('debitToggle');
        const amountInput = document.getElementById('advanceAmount');
        
        if (isCredit) {
          creditToggle.style.background = '#f0fdf4';
          creditToggle.style.borderColor = '#22c55e';
          creditToggle.style.color = '#166534';
          debitToggle.style.background = '#fff';
          debitToggle.style.borderColor = '#e2e8f0';
          debitToggle.style.color = '#64748b';
          amountInput.placeholder = 'Kitna likhna hai? (‚Çπ)';
        } else {
          debitToggle.style.background = '#fef2f2';
          debitToggle.style.borderColor = '#ef4444';
          debitToggle.style.color = '#7f1d1d';
          creditToggle.style.background = '#fff';
          creditToggle.style.borderColor = '#e2e8f0';
          creditToggle.style.color = '#64748b';
          amountInput.placeholder = 'Kitna payment hua? (‚Çπ)';
        }
      }

      // Update advance (give/cut)
      function updateAdvance() {
        const customerName = el("activeCust").innerText;
        const amount = parseFloat(el("advanceAmount").value);
        const isCredit = document.querySelector('input[name="ledgerType"][value="credit"]').checked;

        if (!amount || amount <= 0) return showToast("Enter valid amount");

        const customer = customers.find(c => c.name === customerName);
        if (!customer) return showToast("Customer not found");

        if (!customer.advance) customer.advance = 0;

        if (isCredit) {
          customer.advance += amount;
          showToast(`‚Çπ${amount} likha ${customerName} ke naam`);
        } else {
          customer.advance -= amount;
          showToast(`‚Çπ${amount} payment se kam hua`);
        }

        localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
        el("advanceAmount").value = "";
        showAdvanceSection(customerName);
      }
      
      // Send monthly summary via WhatsApp
      function sendMonthlySummary() {
        const customerName = el("activeCust").innerText;
        const customer = customers.find(c => c.name === customerName);
        
        if (!customer) return showToast("Customer not found");
        
        const monthMilk = customer.monthMilk || 0;
        const advance = customer.advance || 0;
        
        const message = `*Monthly Summary - ${customerName}*\n\nü•õ Total Milk: ${monthMilk.toFixed(1)}L\nüí∞ Current Advance: ‚Çπ${advance.toFixed(2)}\n\nThank you for your business!`;
        
        const phone = customer.phone || "";
        const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
        
        window.open(whatsappUrl, '_blank');
        showToast("Opening WhatsApp...");
      }

      // Existing Code Logic
      let selectedProduct = null; // Track selected product for highlighting

      // Edit Product Function
      function editProduct(cardId) {
        const card = document.getElementById(cardId);
        if (!card) return;
        
        const name = card.getAttribute('data-name');
        const price = card.getAttribute('data-price');
        const unit = card.getAttribute('data-unit');
        
        const newName = prompt("Edit product name:", name);
        if (newName === null) return; // Cancelled
        
        const newPrice = prompt("Edit price (‚Çπ):", price);
        if (newPrice === null) return;
        
        const newUnit = prompt("Edit unit (L, kg, g, etc.):", unit);
        if (newUnit === null) return;
        
        // Update the card
        card.setAttribute('data-name', newName);
        card.setAttribute('data-price', newPrice);
        card.setAttribute('data-unit', newUnit);
        
        // Update display text
        const nameDiv = card.querySelector('div[style*="font-weight: 900"], div[style*="font-weight:700"]');
        const small = card.querySelector('small');
        
        if (nameDiv) nameDiv.textContent = `${newName} ${newUnit}`;
        if (small) small.textContent = `‚Çπ${newPrice}`;
        
        // Update onclick handler with new values
        const onclickAttr = card.getAttribute('onclick');
        if (onclickAttr && onclickAttr.startsWith("tapAdd(")) {
          const newOnclick = `tapAdd('${newName}', ${newPrice}, ${card.getAttribute('data-qty')})`;
          card.setAttribute('onclick', newOnclick);
        }
        
        showToast(`Product updated: ${newName} ‚úÖ`);
      }

      function tapAdd(name, rate, qty, step) {
        // Check if item already exists in cart - match by NAME ONLY (merge Cow Milk regardless of rate)
        const existingItem = cart.find(item => item.name === name);
        if (existingItem) {
          // Increase quantity of existing item (merge all Cow Milk together)
          existingItem.qty = Math.round((existingItem.qty + qty) * 10) / 10;
        } else {
          // Add new item with step size
          cart.push({name, rate, qty, step: step || qty, id: Date.now()});
        }
        selectedProduct = {name, rate}; // Track for highlighting
        updateUI();
        showToast(name + " added");

        // Highlight the clicked card by finding it via onclick attribute
        highlightProductCard(name);
      }
      
      function highlightProductCard(productName) {
        // Remove highlight from all cards
        document.querySelectorAll('.p-card').forEach(card => {
          card.classList.remove('selected');
        });
        
        // Find the card by matching onclick attribute
        document.querySelectorAll('.p-card').forEach(card => {
          const onclick = card.getAttribute('onclick') || '';
          if (onclick.includes(`'${productName}'`)) {
            card.classList.add('selected');
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        });
      }
      // adjustQty removed - use inline quantity editing instead
      function updateUI() {
        const tbody = el("cartItems"); tbody.innerHTML = ""; total = 0;
        
        // Calculate purchase frequency for each item
        const purchaseCount = {};
        cart.forEach(item => {
          purchaseCount[item.name] = (purchaseCount[item.name] || 0) + (item.qty * item.rate);
        });
        const maxAmount = Math.max(...Object.values(purchaseCount), 1);
        
        cart.forEach((i, index) => {
          const itemAmount = i.rate * i.qty;
          total += itemAmount;
          
          // Calculate emoji size based on quantity (scale from 24px to 48px)
          const emojiSize = Math.min(48, Math.max(24, 24 + (i.qty * 4)));
          
          // Calculate background darkness based on purchase amount (0-0.3 opacity)
          const bgOpacity = (purchaseCount[i.name] / maxAmount) * 0.3;
          const bgColor = `rgba(59, 130, 246, ${bgOpacity})`;
          
          tbody.innerHTML += `<tr style="border-bottom:1px solid #f1f5f9; background:${bgColor};" draggable="true" ondragstart="handleCartDragStart(event)" ondragover="handleCartDragOver(event)" ondrop="handleCartDrop(event)" ondragend="handleCartDragEnd(event)" data-index="${index}">
            <td style="padding:8px 0;">
              <div style="display:flex; align-items:center; gap:8px;">
                <span style="font-size:${emojiSize}px;">${getEmojiForProduct(i.name)}</span>
                <div>
                  <div style="font-weight:700; font-size:13px;">${i.name}</div>
                  <div style="font-size:10px; color:var(--muted); font-weight:700;">‚Çπ${i.rate}/unit</div>
                </div>
              </div>
            </td>
            <td style="padding:8px 4px;">
              <div style="display:flex; align-items:center; gap:4px;">
                <button onclick="decreaseQty(${index})" style="width:32px; height:32px; border:1px solid #e2e8f0; background:#f8fafc; border-radius:6px; font-weight:900; font-size:18px; cursor:pointer; color:#64748b;">‚àí</button>
                <input type="number" value="${i.qty}" min="0.1" step="0.1"
                  onchange="updateItemQty(${index}, this.value)"
                  onblur="updateItemQty(${index}, this.value)"
                  style="width:70px; padding:6px; border:2px solid #3b82f6; border-radius:6px; font-weight:700; text-align:center; font-size:14px;"
                  title="Edit Quantity" />
                <button onclick="increaseQty(${index})" style="width:32px; height:32px; border:1px solid #e2e8f0; background:#f8fafc; border-radius:6px; font-weight:900; font-size:18px; cursor:pointer; color:#16a34a;">+</button>
              </div>
            </td>
            <td style="padding:8px 4px;">
              <input type="number" value="${itemAmount.toFixed(2)}"
                onchange="updateItemAmount(${index}, this.value)"
                onblur="updateItemAmount(${index}, this.value)"
                style="width:80px; padding:6px; border:1px solid #e2e8f0; border-radius:6px; font-weight:700; text-align:right; font-size:13px;"
                title="Edit Price (auto-calculates quantity)" />
            </td>
            <td style="padding:8px 0; text-align:right;">
              <button onclick="removeItem(${index})" style="background:#fecaca; color:#dc2626; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; font-weight:700; font-size:11px;">‚úï Remove</button>
            </td>
          </tr>`;
        });

        // Update total display
        el("totalAmt").textContent = `‚Çπ${total.toFixed(2)}`;

        // Update payment amount field - auto-update but keep editable
        const paymentInput = el("paymentAmount");
        if (paymentInput) {
          // Only auto-update if field is empty OR if it matches the previous total
          const currentValue = parseFloat(paymentInput.value) || 0;
          const wasExactMatch = Math.abs(currentValue - (parseFloat(paymentInput.dataset.prevTotal) || 0)) < 0.01;
          
          if (!paymentInput.value || wasExactMatch || currentValue === total) {
            paymentInput.value = total.toFixed(2);
          }
          paymentInput.dataset.prevTotal = total.toFixed(2);
        }

        // Recalculate credit if payment amount exists
        if (paymentInput && paymentInput.value) {
          calculateCredit();
        }

        // Update product card quantity badges
        updateCardBadges();
      }
      
      // Get emoji for product name
      function getEmojiForProduct(name) {
        const emojiMap = {
          'Cow': 'üêÑ', 'Buff': 'üêÉ', 'Paneer': 'üßÄ', 'Ghee': 'üçØ', 
          'Milk Cake': 'üç∞', 'Curd': 'ü•õ', 'Milk': 'ü•õ'
        };
        for (const [key, emoji] of Object.entries(emojiMap)) {
          if (name.includes(key)) return emoji;
        }
        return 'üì¶'; // Default
      }
      
      // Decrease quantity (uses item's step size)
      function decreaseQty(index) {
        const step = cart[index].step || 0.5; // Use item's step or default to 0.5
        const newQty = Math.max(0.1, cart[index].qty - step);
        cart[index].qty = Math.round(newQty * 10) / 10;
        if (cart[index].qty <= 0) {
          removeItem(index);
        } else {
          updateUI();
        }
      }

      // Increase quantity (uses item's step size)
      function increaseQty(index) {
        const step = cart[index].step || 0.5; // Use item's step or default to 0.5
        cart[index].qty = Math.round((cart[index].qty + step) * 10) / 10;
        updateUI();
      }
      
      // Update quantity badges on product cards
      function updateCardBadges() {
        try {
          // Reset all badges first
          document.querySelectorAll('.qty-badge').forEach(badge => {
            badge.style.display = 'none';
          });

          // Remove all highlights and reset icon sizes
          document.querySelectorAll('.p-card').forEach(card => {
            card.style.boxShadow = '';
            card.style.border = '';
            const emoji = card.querySelector('.emoji');
            if (emoji) {
              // Reset to default size based on card data-qty
              const defaultQty = parseFloat(card.getAttribute('data-qty'));
              if (defaultQty >= 2) {
                emoji.style.fontSize = '56px';
              } else if (defaultQty >= 1) {
                emoji.style.fontSize = '48px';
              } else {
                emoji.style.fontSize = '32px';
              }
            }
          });

          // Update badges for items in cart
          cart.forEach(item => {
            // Find card by ID based on product name
            let cardId = null;
            if (item.name === 'Cow 1L') cardId = 'prod-cow-1l';
            else if (item.name === 'Cow 0.5L') cardId = 'prod-cow-05l';
            else if (item.name === 'Buff 2L') cardId = 'prod-buff-2l';
            else if (item.name === 'Buff 1L') cardId = 'prod-buff-1l';
            else if (item.name === 'Buff 0.5L') cardId = 'prod-buff-05l';
            else if (item.name === 'Paneer') cardId = 'prod-paneer';
            else if (item.name === 'Ghee') cardId = 'prod-ghee';
            else if (item.name === 'Milk Cake') cardId = 'prod-milkcake';
            
            if (cardId) {
              const card = document.getElementById(cardId);
              if (card) {
                const badge = card.querySelector('.qty-badge');
                const emoji = card.querySelector('.emoji');
                const nameDiv = card.querySelector('div[style*="font-weight: 900"]');

                if (badge) {
                  // Show badge with quantity
                  badge.textContent = item.qty;
                  badge.style.display = 'block';

                  // Highlight based on quantity
                  if (item.qty >= 2) {
                    card.style.boxShadow = '0 0 0 3px #dc2626';
                    card.style.border = '2px solid #dc2626';
                  } else if (item.qty >= 1) {
                    card.style.boxShadow = '0 0 0 3px #3b82f6';
                    card.style.border = '2px solid #3b82f6';
                  } else {
                    card.style.boxShadow = '0 0 0 3px #16a34a';
                    card.style.border = '2px solid #16a34a';
                  }
                }

                // Update icon size based on cart quantity
                if (emoji) {
                  if (item.qty >= 2) {
                    emoji.style.fontSize = '64px';
                    emoji.style.filter = 'brightness(1.2)';
                  } else if (item.qty >= 1) {
                    emoji.style.fontSize = '52px';
                    emoji.style.filter = 'brightness(1.1)';
                  } else {
                    emoji.style.fontSize = '36px';
                    emoji.style.filter = 'brightness(1)';
                  }
                }

                // Update name to show quantity
                if (nameDiv) {
                  const baseName = item.name;
                  nameDiv.textContent = `${baseName} (${item.qty}x)`;
                }
              }
            }
          });
        } catch (error) {
          console.error('Error updating card badges:', error);
        }
      }
      
      // Load customer memory (previous orders)
      function loadCustomerMemory(customerName) {
        if (!customerName || customerName === 'Walking Customer') return;
        
        const memory = JSON.parse(localStorage.getItem('mr_customer_memory') || '{}');
        const customerMemory = memory[customerName];
        
        if (customerMemory && customerMemory.items && customerMemory.items.length > 0) {
          // Clear current cart
          cart = [];
          
          // Load previous items
          customerMemory.items.forEach(item => {
            cart.push({
              name: item.name,
              rate: item.rate,
              qty: item.qty
            });
          });
          
          updateUI();
          showToast(`Loaded memory: ${customerMemory.items.length} items ‚úÖ`);
        }
      }
      
      // Save customer memory
      function saveCustomerMemory(customerName) {
        if (!customerName || customerName === 'Walking Customer') return;
        
        const memory = JSON.parse(localStorage.getItem('mr_customer_memory') || '{}');
        
        memory[customerName] = {
          items: JSON.parse(JSON.stringify(cart)),
          lastUpdated: Date.now()
        };
        
        localStorage.setItem('mr_customer_memory', JSON.stringify(memory));
      }
      
      // Update item quantity (amount auto-calculates)
      function updateItemQty(index, newQty) {
        const qty = parseFloat(newQty);
        if (qty > 0) {
          cart[index].qty = qty;
          updateUI();
        } else {
          removeItem(index);
        }
      }
      
      // Update item amount (quantity auto-calculates)
      function updateItemAmount(index, newAmount) {
        const amount = parseFloat(newAmount);
        if (amount > 0 && cart[index].rate > 0) {
          cart[index].qty = amount / cart[index].rate;
          updateUI();
        } else {
          removeItem(index);
        }
      }
      
      // Remove item from cart
      function removeItem(index) {
        cart.splice(index, 1);
        updateUI();
        showToast("Item removed");
      }

      // Save entry - FULLY OFFLINE MODE
      async function saveEntry(mode) {
        if(total === 0) return showToast("Cart empty");

        const custName = el("activeCust").innerText;
        const customer = customers.find(c => c.name === custName);
        const customerPhone = customer?.phone;
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const itemsDetail = cart.map(i => `${i.qty}x ${i.name}`).join(" | ");

        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Saving...';

        try {
          // 1. Find or create customer (offline)
          let customerId = null;
          let existingCustomer = customers.find(c => c.name.toLowerCase() === custName.toLowerCase());

          if (!existingCustomer && custName !== "Walking Customer") {
            // Create new customer locally
            customerId = "cust_" + Date.now();
            const newCustomer = {
              id: customerId,
              name: custName,
              phone: "",
              balance: 0,
              advance: 0,
              monthMilk: 0,
              createdAt: Date.now()
            };
            customers.push(newCustomer);
            localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
          } else if (existingCustomer) {
            customerId = existingCustomer.id;
          }

          // 2. Calculate credit amount
          const paymentAmount = parseFloat(el("paymentAmount").value) || total;
          const creditAmount = mode === 'Credit' ? total : Math.max(0, total - paymentAmount);

          // 3. Save sale locally (offline mode)
          const saleData = {
            id: "sale_" + Date.now(),
            customer_id: customerId,
            customer_name: custName,
            items: JSON.parse(JSON.stringify(cart)),
            total_amount: total,
            paid_amount: paymentAmount,
            credit_amount: creditAmount,
            payment_mode: mode.toLowerCase(),
            createdAt: Date.now()
          };

          // Save to localStorage
          const sales = JSON.parse(localStorage.getItem('mr_pos_sales') || '[]');
          sales.push(saleData);
          localStorage.setItem('mr_pos_sales', JSON.stringify(sales));

          console.log('‚úÖ Sale saved locally:', saleData);

          // 4. Update customer balance if credit (offline)
          if (creditAmount > 0 && customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
              customer.balance = (customer.balance || 0) + creditAmount;
              localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
            }
          }

          // Save customer memory (for auto-fill next time)
          saveCustomerMemory(custName);

          // 5. Update local history for immediate UI
          const newSale = {
            date: new Date().toLocaleDateString(),
            time,
            customer: custName,
            products: itemsDetail,
            amount: total.toFixed(2),
            method: mode,
            cartItems: JSON.parse(JSON.stringify(cart)),
            credit: creditAmount,
            invoiceId: result.sale.id
          };

          exportHistory.push(newSale);
          localStorage.setItem('mr_sales_history', JSON.stringify(exportHistory));

          // 6. Update UI
          const entry = `<div class="cardRow" style="flex-direction:column; align-items:flex-start; gap:4px; cursor:pointer;" onclick="loadOrderFromHistory('${custName}', ${JSON.stringify(cart).replace(/"/g, '&quot;')})">
            <div style="width:100%; display:flex; justify-content:space-between;">
              <b>${custName}</b><b>‚Çπ${total.toFixed(2)}</b>
            </div>
            <div style="font-size:11px; color:var(--muted); font-weight:700;">
              ${time} ‚Ä¢ üõí ${itemsDetail} ‚Ä¢ ${modeIcon(mode)} ${mode}
              ${creditAmount > 0 ? `<span style="color:#dc2626; font-weight:700;"> ‚Ä¢ üìï ‚Çπ${creditAmount.toFixed(2)} Udhar</span>` : ''}
              <span style="color:var(--blue); font-weight:700; margin-left:8px;">üîÅ Click to reload</span>
            </div>
          </div>`;
          el("historyToday").innerHTML = entry + el("historyToday").innerHTML;

          // 7. Auto-download invoice (silent, no new tab)
          downloadInvoiceAuto(custName, paymentAmount, mode, creditAmount, result.sale.id);

          // 8. Show success message
          if (creditAmount > 0) {
            showToast(`Saved! ‚Çπ${creditAmount.toFixed(2)} added to Udhar ‚úÖ`);
          } else {
            showToast(`Saved ‚úÖ`);
          }

          // 9. Reset cart and prepare for next customer
          resetCart();
          
          // 10. If customer has phone and it's credit mode, offer WhatsApp
          if (creditAmount > 0 && customerPhone && customerPhone.length >= 10) {
            setTimeout(() => {
              if (confirm(`Send WhatsApp reminder to ${custName}?`)) {
                sendWhatsAppReminder(custName, customerPhone, creditAmount, total);
              }
            }, 500);
          }

        } catch (error) {
          console.error('Error saving sale:', error);
          showToast('‚ùå Failed to save: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }
      
      // Auto-download invoice (SILENT - no print dialog, no focus change)
      function downloadInvoiceAuto(customerName, paymentAmount, paymentMode, creditAmount, invoiceId) {
        const date = new Date();
        const dateStr = date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
        const timeStr = date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        const invoiceNo = `INV-${invoiceId ? invoiceId.substring(0,8).toUpperCase() : Date.now().toString().substring(5)}`;
        
        // Get shop name from session
        const session = localStorage.getItem('milkbook_session');
        const shopName = session ? JSON.parse(session).shop_name : 'MilkRecord POS';
        
        // Create simple text invoice for download
        let invoiceText = `${shopName}\n`;
        invoiceText += `${invoiceNo} | ${dateStr} ${timeStr}\n`;
        invoiceText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
        invoiceText += `Customer: ${customerName}\n`;
        invoiceText += `Payment: ${paymentMode} - ‚Çπ${paymentAmount.toFixed(2)}\n\n`;
        invoiceText += `ITEMS:\n`;
        cart.forEach(item => {
          invoiceText += `  ${item.name} x${item.qty} @ ‚Çπ${item.rate} = ‚Çπ${(item.qty * item.rate).toFixed(2)}\n`;
        });
        invoiceText += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        invoiceText += `TOTAL: ‚Çπ${total.toFixed(2)}\n`;
        if (creditAmount > 0) {
          invoiceText += `CREDIT (Udhar): ‚Çπ${creditAmount.toFixed(2)}\n`;
        }
        invoiceText += `\nThank you! üôè\n`;
        invoiceText += `${shopName}\n`;
        
        // Create blob and download SILENTLY (no print, no focus)
        const blob = new Blob([invoiceText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Invoice-${invoiceNo}.txt`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // No console log, no alert - completely silent
      }
      
      // Send WhatsApp reminder for credit
      function sendWhatsAppReminder(customerName, phone, creditAmount, total) {
        const session = localStorage.getItem('milkbook_session');
        const shopName = session ? JSON.parse(session).shop_name : 'MilkRecord POS';
        const date = new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
        
        let message = `*${shopName}*\n`;
        message += `üìÖ ${date}\n\n`;
        message += `Hi ${customerName},\n`;
        message += `Your credit balance: *‚Çπ${creditAmount.toFixed(2)}*\n`;
        message += `Total purchase: ‚Çπ${total.toFixed(2)}\n\n`;
        message += `Items:\n`;
        cart.forEach(item => {
          message += `‚Ä¢ ${item.name} (${item.qty}) - ‚Çπ${(item.qty * item.rate).toFixed(2)}\n`;
        });
        message += `\nPlease settle soon. Thank you! üôè`;
        
        const whatsappUrl = `https://wa.me/91${phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
      }

// Get payment mode icon
function modeIcon(mode) {
    if (mode === 'Credit' || mode === 'Udhar') return 'üìï';
    if (mode === 'UPI') return 'üì±';
    return 'üíµ';
}

// Load order from history (clickable history items)
function loadOrderFromHistory(customerName, cartItems) {
  // Set customer
  el("activeCust").innerText = customerName;
  el("custSearch").value = customerName;
  
  // Load cart items
  cart = cartItems.map(item => ({...item, id: Date.now() + Math.random()}));
  
  // Update UI
  updateUI();
  closeModal('historyModal');
  showToast(`Loaded order for ${customerName}`);
}

// Switch history tab (today/all)
function switchHistoryTab(tab) {
  const todayDiv = el("historyToday");
  const allDiv = el("historyWeekly"); // Reusing same div for all history
  const tabToday = el("tabToday");
  const tabAll = el("tabAll");
  
  if (tab === 'today') {
    todayDiv.style.display = 'block';
    allDiv.style.display = 'none';
    tabToday.style.borderBottomColor = 'var(--blue)';
    tabAll.style.borderBottomColor = 'transparent';
    renderHistory();
  } else {
    todayDiv.style.display = 'none';
    allDiv.style.display = 'block';
    tabToday.style.borderBottomColor = 'transparent';
    tabAll.style.borderBottomColor = 'var(--blue)';
    renderAllHistory();
  }
}

// Render ALL history (no date limit)
function renderAllHistory() {
  const container = el("historyWeekly");
  
  if (exportHistory.length === 0) {
    container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted);">No sales history yet</div>';
    return;
  }
  
  // Show ALL history, newest first
  const allHistory = [...exportHistory].reverse();
  
  container.innerHTML = allHistory.map((sale, i) => {
    // Get payment mode icon
    let modeIcon = 'üíµ';
    if (sale.method === 'Credit' || sale.method === 'Udhar') modeIcon = 'üìï';
    else if (sale.method === 'UPI') modeIcon = 'üì±';
    
    return `
    <div class="cardRow" style="cursor:pointer;" onclick="loadOrderFromHistory('${sale.customer.replace(/'/g, "\\'")}', ${JSON.stringify(sale.cartItems || []).replace(/"/g, '&quot;')})">
      <div style="flex:1">
        <b>${sale.customer}</b><br>
        <small style="color:var(--muted); font-weight:700;">${sale.date} ${sale.time} ‚Ä¢ ${sale.products} ‚Ä¢ ${modeIcon} ${sale.method}</small>
      </div>
      <b style="color:var(--blue);">‚Çπ${sale.amount}</b>
    </div>
  `}).join('');
  
  // Update count
  const todayCount = exportHistory.filter(s => s.date === new Date().toLocaleDateString()).length;
  el("historyCount").textContent = `${todayCount} today ‚Ä¢ ${exportHistory.length} total`;
}

// Export history to CSV
function downloadHistoryCSV() {
  if (exportHistory.length === 0) return showToast("No history to export!");

  let csv = "Date,Time,Customer,Products,Amount,Payment Method\n";
  exportHistory.forEach(r => {
    let safeCust = r.customer.replace(/,/g, "");
    let safeProd = r.products.replace(/,/g, " | ");
    csv += `${r.date},${r.time},${safeCust},"${safeProd}",${r.amount},${r.method}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.setAttribute("href", url);
  a.setAttribute("download", `MilkRecord_History_${new Date().toISOString().split('T')[0]}.csv`);
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  showToast("History Exported! üìä‚úÖ");
}

// Clear today's history
function clearTodayHistory() {
  const today = new Date().toLocaleDateString();
  if (!confirm(`Clear all ${today} sales? This cannot be undone!`)) return;

  exportHistory = exportHistory.filter(sale => sale.date !== today);
  localStorage.setItem('mr_sales_history', JSON.stringify(exportHistory));
  loadHistoryOnStart();
  renderAllHistory();
  showToast("Today's history cleared! üóëÔ∏è");
}

      function exportDetailedExcel() {
    // 1. Check if history exists
    if(exportHistory.length === 0) return showToast("No sales to export!");

    // 2. CSV Header (Point 21: Institutional Export)
    let csv = "Date,Time,Customer,Products,Amount,Payment Method\n";

    // 3. Row Logic
    exportHistory.forEach(r => {
        // Customer ya Product name mein agar comma ho toh use clean karna
        let safeCust = r.customer.replace(/,/g, "");
        let safeProd = r.products.replace(/,/g, " | "); // Comma handling
        
        csv += `${r.date},${r.time},${safeCust},"${safeProd}",${r.amount},${r.method}\n`;
    });

    // --- ‚úÖ 4. ADDED: File Creation & Auto-Download Logic ---
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    
    // File name format (e.g., MilkRecord_Report_2026-02-16.csv)
    const fileName = `MilkRecord_Report_${new Date().toISOString().split('T')[0]}.csv`;
    
    a.setAttribute("href", url);
    a.setAttribute("download", fileName);
    document.body.appendChild(a); // Temporary addition
    a.click(); // Trigger click to download
    document.body.removeChild(a); // Cleanup
    
    showToast("Excel Exported! üìä‚úÖ");
}
      function addCust() {
          const name = el("newName").value;
          const phone = el("newPhone").value;
          const email = el("newEmail").value;
          const birthday = el("newBirthday").value;
          const gst = el("newGst").value;
          if(!name) return showToast("Name required!");
          
          // Update or create customer
          let customer = customers.find(c => c.name === name);
          if (customer) {
            // Update existing
            customer.phone = phone || customer.phone;
            customer.email = email || customer.email;
            customer.birthday = birthday || customer.birthday;
            customer.gst = gst || customer.gst;
          } else {
            // Create new
            customers.push({ 
              name: name, 
              phone: phone || '', 
              email: email || '',
              birthday: birthday || '',
              gst: gst || '',
              lastOrder: "New Customer", 
              frequentBuys: [],
              rate: 0, 
              qty: 0, 
              type: el("newType").value,
              balance: 0,
              advance: 0,
              monthMilk: 0
            });
          }
          
          el("activeCust").innerText = name;
          updateCustomerDisplay();
          closeModal('addCustModal'); 
          el("newName").value = "";
          el("newPhone").value = "";
          el("newEmail").value = "";
          el("newBirthday").value = "";
          el("newGst").value = "";
          localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
          showToast(name + (phone ? ` (+91${phone})` : '') + " Saved!");
      }
      
      // Update customer display in summary panel
      function updateCustomerDisplay() {
        const customerName = el("activeCust").innerText;
        const phoneDisplay = el("customerPhoneDisplay");
        const customer = customers.find(c => c.name === customerName);
        
        if (customer && customer.phone) {
          phoneDisplay.innerHTML = `üì± +91${customer.phone} <span style="color:#22c55e; font-weight:900;" title="Invoice will be sent to WhatsApp">‚úì</span>`;
        } else if (customer && customer.email) {
          phoneDisplay.innerHTML = `‚úâÔ∏è ${customer.email} <span style="color:#22c55e; font-weight:900;" title="Invoice will be sent to Email">‚úì</span>`;
        } else {
          phoneDisplay.innerHTML = '';
        }
      }

      function renderMemory() {
    const list = el("memoryList");
    list.innerHTML = "";
    customers.forEach(c => {
        list.innerHTML += `
        <div class="cardRow">
            <div style="flex:1">
                <b>${c.name}</b><br>
                <small>Last: ${c.lastOrder} ${c.sub > 0 ? '| Subscribed: '+c.sub+'L' : ''}</small>
            </div>
            <button class="pillbtn primary" onclick="repeatOrder('${c.name}', '${c.lastProductName || 'Cow Milk'}', ${c.rate || 64}, ${c.qty || 1})">Repeat</button>
        </div>`;
    });
    openModal('memoryModal');
}

      function repeatOrder(name, productName, rate, qty) {
        el("activeCust").innerText = name;
        if(rate > 0) {
          // Add the actual product from customer's last order
          cart = [{name: productName, rate: parseFloat(rate) || 64, qty: parseFloat(qty) || 1, id: Date.now()}];
          updateUI();
        }
        closeModal('memoryModal');
      }
      function resetCart() { cart = []; updateUI(); el("activeCust").innerText = "Walking Customer"; el("custSearch").value = ""; el("advanceSection").style.display = "none"; el("advanceToggleBtn").style.display = "none"; }
      
      // Hold cart functionality
      function holdCart() {
        if (cart.length === 0) return showToast("Cart is empty!");
        const customerName = el("activeCust").innerText;
        const holdId = Date.now();
        
        heldCarts.push({
          id: holdId,
          customer: customerName,
          cart: [...cart],
          total: total,
          timestamp: new Date().toISOString()
        });
        
        localStorage.setItem('mr_held_carts', JSON.stringify(heldCarts));
        cart = [];
        updateUI();
        showToast(`Order held for ${customerName} ‚úÖ`);
        updateHoldButton();
      }
      
      // Retrieve held cart
      function retrieveHoldCart(holdId) {
        const holdIndex = heldCarts.findIndex(h => h.id === holdId);
        if (holdIndex === -1) return;
        
        const heldCart = heldCarts[holdIndex];
        cart = heldCart.cart;
        total = heldCart.total;
        el("activeCust").innerText = heldCart.customer;
        
        heldCarts.splice(holdIndex, 1);
        localStorage.setItem('mr_held_carts', JSON.stringify(heldCarts));
        
        updateUI();
        updateHoldButton();
        showToast(`Order retrieved for ${heldCart.customer} ‚úÖ`);
      }
      
      // Update hold button display
      function updateHoldButton() {
        const holdBtn = document.querySelector('button[onclick*="holdCart"]');
        const heldCountEl = document.getElementById('heldCount');
        
        if (holdBtn && heldCarts.length > 0) {
          holdBtn.innerHTML = `üü° HOLD <span class="subnote">${heldCarts.length} saved</span>`;
        } else if (holdBtn) {
          holdBtn.innerHTML = `üü° HOLD <span class="subnote">save</span>`;
        }

        if (heldCountEl) {
          heldCountEl.textContent = heldCarts.length;
        }
        
        // Sync mobile footer count
        const heldCountMobile = document.getElementById('heldCountMobile');
        if (heldCountMobile) {
          heldCountMobile.textContent = heldCarts.length;
        }
      }
      
      // Show held carts modal
      function showHeldCarts() {
        if (heldCarts.length === 0) return showToast("No held orders");
        
        const modal = document.getElementById('heldCartsModal');
        const list = document.getElementById('heldCartsList');
        
        list.innerHTML = heldCarts.map(h => `
          <div class="cardRow" style="cursor:pointer;" onclick="retrieveHoldCart(${h.id})">
            <div>
              <b>${h.customer}</b>
              <div style="font-size:11px; color:var(--muted);">${new Date(h.timestamp).toLocaleString()}</div>
            </div>
            <b>‚Çπ${h.total.toFixed(2)}</b>
          </div>
        `).join('');
        
        openModal('heldCartsModal');
      }
      
      function openModal(id) {
        const modal = el(id);
        if (modal) {
          modal.style.display = "flex";
          // Focus first input in modal
          const firstInput = modal.querySelector('input, select, textarea');
          if (firstInput) setTimeout(() => firstInput.focus(), 100);
          
          // Debug: Log step input values when Add Product modal opens
          if (id === 'addProductModal') {
            setTimeout(() => {
              const stepInputs = document.querySelectorAll('.pStep');
              console.log('=== Modal Opened - Step Inputs Debug ===');
              console.log('Total step inputs found:', stepInputs.length);
              stepInputs.forEach((input, idx) => {
                const rect = input.getBoundingClientRect();
                console.log(`Step ${idx + 1}: value="${input.value}", visible=${rect.width > 0}, width=${rect.width.toFixed(0)}px`);
              });
              console.log('Modal width:', modal.querySelector('.modal').offsetWidth, 'px');
            }, 200);
          }
        }
      }
      function closeModal(id) { 
        const modal = el(id);
        if (modal) modal.style.display = "none"; 
      }
      
      // Close modal when clicking on overlay (outside modal content)
      document.querySelectorAll('.overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.style.display = 'none';
          }
        });
      });
      
      function showToast(msg) { const t = el("toast"); t.textContent = msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 1500); }

      // Drag and Drop for Product Cards
      let draggedCard = null;
      let draggedCardId = null;

      function handleDragStart(e) {
        draggedCard = this;
        draggedCardId = this.id;
        this.style.opacity = '0.4';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.id);
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
      }

      function handleDrop(e) {
        e.stopPropagation();
        if (draggedCard && this !== draggedCard) {
          const grid = document.getElementById('productGrid');
          const cards = Array.from(grid.querySelectorAll('.p-card'));
          const draggedIndex = cards.indexOf(draggedCard);
          const dropIndex = cards.indexOf(this);

          if (draggedIndex < dropIndex) {
            grid.insertBefore(draggedCard, this.nextSibling);
          } else {
            grid.insertBefore(draggedCard, this);
          }

          // Save card order to localStorage
          saveCardOrder();
        }
        if (draggedCard) draggedCard.style.opacity = '1';
        return false;
      }

      function saveCardOrder() {
        const grid = document.getElementById('productGrid');
        const cards = grid.querySelectorAll('.p-card:not([onclick*="addProduct"]):not([onclick*="openEdit"])');
        const order = Array.from(cards).map(card => card.id);
        localStorage.setItem('mr_pos_card_order', JSON.stringify(order));
      }

      function loadCardOrder() {
        const order = JSON.parse(localStorage.getItem('mr_pos_card_order') || 'null');
        if (!order) return;

        const grid = document.getElementById('productGrid');
        const addBtn = grid.querySelector('.p-card[onclick*="addProductModal"]');

        order.forEach(id => {
          const card = document.getElementById(id);
          if (card && addBtn) {
            grid.insertBefore(card, addBtn);
          }
        });
      }

      // Drag and Drop for Cart Items
      let draggedCartItem = null;
      let draggedCartIndex = null;

      function handleCartDragStart(e) {
        draggedCartItem = this;
        draggedCartIndex = parseInt(this.getAttribute('data-index'));
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedCartIndex);
        console.log('üõí Drag started:', draggedCartIndex);
      }

      function handleCartDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        e.dataTransfer.dropEffect = 'move';
        
        // Find the row being dragged over
        const row = e.target.closest('tr');
        if (row && row !== draggedCartItem) {
          // Remove highlight from all rows
          document.querySelectorAll('#cartItems tr').forEach(r => r.style.borderTop = '');
          // Add highlight to this row
          row.style.borderTop = '3px solid #3b82f6';
        }
        return false;
      }

      function handleCartDragEnd(e) {
        this.classList.remove('dragging');
        // Remove all border highlights
        document.querySelectorAll('#cartItems tr').forEach(tr => {
          tr.style.borderTop = '';
          tr.classList.remove('dragging');
        });
      }

      function handleCartDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('üõí handleCartDrop called');
        console.log('  e.target:', e.target);
        console.log('  draggedCartItem:', draggedCartItem);
        
        // Find the row being dropped on
        const targetRow = e.target.closest('tr');
        console.log('  targetRow:', targetRow);
        
        // Remove all border highlights
        document.querySelectorAll('#cartItems tr').forEach(tr => {
          tr.style.borderTop = '';
          tr.classList.remove('dragging');
        });
        
        if (!targetRow || !draggedCartItem || targetRow === draggedCartItem) {
          console.log('  Drop cancelled: invalid target');
          draggedCartItem = null;
          draggedCartIndex = null;
          return false;
        }
        
        const dropIndex = parseInt(targetRow.getAttribute('data-index'));
        console.log('üõí Drop:', draggedCartIndex, '->', dropIndex);

        // Reorder cart array
        const draggedItem = cart[draggedCartIndex];
        cart.splice(draggedCartIndex, 1);
        cart.splice(dropIndex, 0, draggedItem);

        updateUI();
        showToast('Item reordered ‚úì');
        
        draggedCartItem = null;
        draggedCartIndex = null;
        return false;
      }

      // Handlers for tbody
      function handleCartDragOverTbody(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
      }

      function handleCartDropTbody(e) {
        e.preventDefault();
        // Let the row's drop handler deal with it
        return false;
      }

      // Drag product to cart (add to cart)
      function handleProductDragToCart(e) {
        e.preventDefault();
        console.log('üì¶ handleProductDragToCart:', e.type);
        if (!draggedCard || !(draggedCard instanceof Element)) {
          console.log('  Invalid draggedCard');
          return false;
        }
        console.log('  draggedCard:', draggedCard);
        const onclick = draggedCard.getAttribute('onclick');
        console.log('  onclick:', onclick);
        if (onclick) {
          const match = onclick.match(/tapAdd\('([^']+)',\s*([\d.]+),\s*([\d.]+)\)/);
          console.log('  match:', match);
          if (match) {
            const name = match[1];
            const rate = parseFloat(match[2]);
            const step = parseFloat(match[3]);
            tapAdd(name, rate, step, step);
            showToast(`${name} added to cart`);
          }
        }
        return false;
      }

      // Drag cart item out to remove
      function handleCartDragOut(e) {
        e.preventDefault();
        if (draggedCartItem) {
          const index = parseInt(draggedCartItem.getAttribute('data-index'));
          removeItem(index);
          showToast('Item removed');
        }
        return false;
      }

      window.onload = () => {
    updateShift();
    loadHistoryOnStart();
    loadCustomProducts();
    loadCardOrder(); // Load saved card order
    setInterval(updateShift, 60000);
    
    // ESC key closes all modals
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.overlay[style*="display: flex"]').forEach(modal => {
          modal.style.display = 'none';
        });
        const searchDrop = document.getElementById('searchDropdown');
        if (searchDrop) searchDrop.style.display = 'none';
      }
    });
    
    // Arrow key navigation for products
    let productFocusIndex = -1;
    const productGrid = document.getElementById('productGrid');
    
    if (productGrid) {
      // Update focus on product cards
      function updateProductFocus() {
        const cards = Array.from(productGrid.querySelectorAll('.p-card'));
        cards.forEach((card, i) => {
          if (i === productFocusIndex) {
            card.classList.add('focused');
            card.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          } else {
            card.classList.remove('focused');
          }
        });
      }
      
      productGrid.addEventListener('keydown', function(e) {
        const cards = Array.from(productGrid.querySelectorAll('.p-card'));
        if (cards.length === 0) return;
        
        const cols = 5; // 5 columns in grid
        
        if (e.key === 'ArrowRight') {
          e.preventDefault();
          productFocusIndex = Math.min(productFocusIndex + 1, cards.length - 1);
          updateProductFocus();
        } else if (e.key === 'ArrowLeft') {
          e.preventDefault();
          productFocusIndex = Math.max(productFocusIndex - 1, 0);
          updateProductFocus();
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          productFocusIndex = Math.min(productFocusIndex + cols, cards.length - 1);
          updateProductFocus();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          productFocusIndex = Math.max(productFocusIndex - cols, 0);
          updateProductFocus();
        } else if (e.key === 'Enter' || e.key === 'Tab') {
          if (productFocusIndex >= 0 && cards[productFocusIndex]) {
            e.preventDefault();
            cards[productFocusIndex].click();
            // Move focus to payment amount field
            setTimeout(() => {
              const paymentInput = document.getElementById('paymentAmount');
              if (paymentInput) {
                paymentInput.value = total.toFixed(2);
                paymentInput.focus();
                paymentInput.select();
                calculateCredit();
              }
            }, 100);
          }
        }
      });
      
      // Click handler updates focus index
      productGrid.addEventListener('click', function(e) {
        const cards = Array.from(productGrid.querySelectorAll('.p-card'));
        cards.forEach((card, i) => {
          if (card.contains(e.target)) {
            productFocusIndex = i;
            updateProductFocus();
          }
        });
      });
    }
}

function loadHistoryOnStart() {
    const historyContainer = document.getElementById("historyToday");
    if(!historyContainer) return;
    historyContainer.innerHTML = "";
    
    const today = new Date().toLocaleDateString();
    const todaySales = exportHistory.filter(s => s.date === today);
    
    // Render today's history with clickable items and payment mode
    todaySales.forEach(sale => {
        // Get payment mode icon
        let modeIcon = 'üíµ';
        if (sale.method === 'Credit' || sale.method === 'Udhar') modeIcon = 'üìï';
        else if (sale.method === 'UPI') modeIcon = 'üì±';
        
        const entry = `<div class="cardRow" style="flex-direction:column; align-items:flex-start; gap:4px; cursor:pointer;" onclick="loadOrderFromHistory('${sale.customer.replace(/'/g, "\\'")}', ${JSON.stringify(sale.cartItems || []).replace(/"/g, '&quot;')})">
            <div style="width:100%; display:flex; justify-content:space-between;">
              <b>${sale.customer}</b><b>‚Çπ${sale.amount}</b>
            </div>
            <small style="color:var(--muted); font-weight:700;">
              ${sale.time} ‚Ä¢ ${sale.products} ‚Ä¢ ${modeIcon} ${sale.method}
              <span style="color:var(--blue); font-weight:700; margin-left:8px;">üîÅ Click to reload</span>
            </small>
          </div>`;
        historyContainer.insertAdjacentHTML('afterbegin', entry);
    });
    
    // Update count
    const totalCount = exportHistory.length;
    el("historyCount").textContent = `${todaySales.length} today ‚Ä¢ ${totalCount} total`;
}

function toggleGaps() { el("gapsPanel").classList.toggle("open"); }

// Convert milk to product
function convertMilkToProduct() {
  const qty = parseFloat(el("convQty").value);
  const productData = el("convProduct").value.split(',');
  const productName = productData[0];
  const rate = parseFloat(productData[1]);

  if (!qty || qty <= 0) return showToast("Enter valid quantity");

  // Add to cart
  const existingItem = cart.find(item => item.name === productName && item.rate === rate);
  if (existingItem) {
    existingItem.qty += qty;
  } else {
    cart.push({name: productName, rate, qty, id: Date.now()});
  }
  updateUI();
  closeModal('convertModal');
  el("convQty").value = "";
  showToast(`Converted ${qty}L to ${productName}`);
}

// Add new product card from modal - creates multiple cards for each step
function addNewProductFromModal() {
  console.log('=== addNewProductFromModal called ===');
  
  const name = el("pName").value.trim();
  const price = parseFloat(el("pPrice").value);
  const unit = el("pUnit").value.trim() || 'unit';
  const emoji = el("pEmoji").value.trim() || 'üì¶';

  console.log('Input values:', { name, price, unit, emoji });

  // Get all step values
  const stepInputs = document.querySelectorAll('.pStep');
  console.log('Found step inputs:', stepInputs.length);
  
  const steps = Array.from(stepInputs).map((input, idx) => {
    const val = parseFloat(input.value) || 0;
    console.log(`  Step ${idx + 1}: input.value="${input.value}", parsed=${val}`);
    return val;
  });

  console.log('Steps array:', steps);

  if (!name || !price) return showToast("Name and Price required!");

  const grid = el("productGrid");
  const addCardBtn = grid.querySelector('.p-card[onclick*="addProductModal"]');
  let cardsCreated = 0;

  // Create a card for each non-zero step
  steps.forEach((step, idx) => {
    console.log(`Processing step ${idx + 1}: value=${step}`);
    if (step === 0) {
      console.log(`  Skipping step ${idx + 1} (value is 0)`);
      return; // Skip zero steps
    }

    cardsCreated++;
    console.log(`  Creating card for step ${idx + 1}...`);
    const newCard = document.createElement('div');
    newCard.className = 'p-card';
    newCard.setAttribute('data-qty', '1');
    newCard.setAttribute('data-step', step);
    newCard.setAttribute('draggable', 'true');
    newCard.ondragstart = handleDragStart;
    newCard.onclick = function() { tapAdd(name, price, step); };

    // Format step display
    const stepDisplay = step < 0 ? `(${step}x)` : `(${step}x)`;
    const nameDisplay = step < 0 ? `${name} ${stepDisplay}` : `${name} ${stepDisplay}`;

    newCard.innerHTML = `
      <span class="emoji" style="font-size: 48px;">${emoji}</span>
      <div style="font-size: 11px; font-weight: 900; margin-top: 4px;">${nameDisplay}</div>
      <small style="font-size: 10px; margin-top: 2px;">‚Çπ${price}/${unit}</small>
      <button class="edit-prod-btn" onclick="event.stopPropagation(); editProductCard(this)" title="Edit Product" style="position: absolute; top: 4px; left: 4px; background: rgba(255,255,255,0.9); border: none; border-radius: 4px; cursor: pointer; font-size: 14px; padding: 2px; opacity: 0; transition: opacity 0.2s;">‚úèÔ∏è</button>
      <div class="qty-badge" style="position: absolute; top: 4px; right: 4px; background: #dc2626; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center; display: none;">0</div>
    `;

    grid.insertBefore(newCard, addCardBtn);
    console.log(`  Card ${idx + 1} inserted into grid`);
  });

  console.log(`Total cards created: ${cardsCreated}`);

  // Save to localStorage
  const customProducts = JSON.parse(localStorage.getItem('mr_pos_custom_products') || '[]');
  steps.forEach(step => {
    if (step !== 0) {
      customProducts.push({name, price, unit, emoji, step});
    }
  });
  localStorage.setItem('mr_pos_custom_products', JSON.stringify(customProducts));
  console.log('Saved to localStorage:', customProducts.filter(p => p.name === name));

  // Close modal and clear
  closeModal('addProductModal');
  el("pName").value = "";
  el("pPrice").value = "";
  el("pEmoji").value = "";
  // Reset step inputs to defaults
  stepInputs.forEach((input, i) => {
    const defaults = [1, 2, 5, 10, 20];
    input.value = defaults[i] || 1;
  });
  
  showToast(`${cardsCreated} product cards added! ‚úÖ`);
}

// Edit individual product card
function editProductCard(btn) {
  const card = btn.closest('.p-card');
  const nameDiv = card.querySelector('div[style*="font-weight: 900"]');
  const small = card.querySelector('small');
  
  const newName = prompt("Edit product name:", nameDiv.textContent.replace(/\s*\([^)]*\)\s*$/, ''));
  if (!newName) return;
  
  const newPrice = prompt("Edit price (‚Çπ):", small.textContent.replace('‚Çπ', '').split('/')[0]);
  if (!newPrice) return;
  
  // Update card
  nameDiv.textContent = newName + nameDiv.textContent.match(/\s*\([^)]*\)\s*$/)[0];
  small.textContent = `‚Çπ${parseFloat(newPrice)}/${small.textContent.split('/')[1]}`;
  
  // Update onclick handler
  const step = card.getAttribute('data-step');
  card.onclick = function() { tapAdd(newName, parseFloat(newPrice), parseFloat(step)); };
  
  showToast("Product updated ‚úÖ");
}

// Filter products by search
function filterProducts(query) {
  const search = query.toLowerCase().trim();
  const grid = document.getElementById("productGrid");
  const cards = grid.querySelectorAll('.p-card');
  
  let visibleCount = 0;
  let hasAddCard = grid.querySelector('.p-card.add-new-product');

  cards.forEach(card => {
    // Skip the "Add New Product" card
    if (card.classList.contains('add-new-product')) {
      return;
    }
    
    const text = card.textContent.toLowerCase();
    if (search === '' || text.includes(search)) {
      card.style.display = 'flex';
      visibleCount++;
    } else {
      card.style.display = 'none';
    }
  });

  // Show "Add New Product" card if search has no results
  if (search !== '' && visibleCount === 0) {
    if (!hasAddCard) {
      // Create "Add New Product" card
      const addCard = document.createElement('div');
      addCard.className = 'p-card add-new-product';
      addCard.style.background = '#f0fdf4';
      addCard.style.borderColor = '#16a34a';
      addCard.innerHTML = `
        <div style="font-size:48px; color:#16a34a; font-weight:900;">‚ûï</div>
        <div style="font-weight:900; color:#16a34a; font-size:10px; margin-top:4px;">Add "${escapeHtml(search)}"</div>
        <small style="color:#15803d; font-size:9px;">Click to create</small>
      `;
      addCard.onclick = function() {
        openModal('addProductModal');
        setTimeout(() => {
          el("newProdName").value = search.charAt(0).toUpperCase() + search.slice(1);
          el("newProdPrice").focus();
        }, 300);
      };
      
      // Insert before the regular "Add" button
      const regularAddBtn = grid.querySelector('.p-card[onclick*="addProductModal"]');
      if (regularAddBtn) {
        grid.insertBefore(addCard, regularAddBtn);
      }
    } else {
      hasAddCard.style.display = 'flex';
      hasAddCard.querySelector('div:nth-child(2)').innerHTML = `Add "${escapeHtml(search)}"`;
    }
  } else if (hasAddCard) {
    hasAddCard.style.display = 'none';
  }
}

// Close customer search dropdown
function closeSearchDropdown() {
  const dropdown = el("searchDropdown");
  if (dropdown) dropdown.style.display = 'none';
}

// Add new product card (legacy function)
function addNewProduct() {
  addNewProductFromModal();
}

// Load custom products on page load
function loadCustomProducts() {
  const customProducts = JSON.parse(localStorage.getItem('mr_pos_custom_products') || '[]');
  const grid = el("productGrid");
  const addCardBtn = grid.querySelector('.p-card[onclick*="addProduct"]');

  customProducts.forEach(p => {
    const newCard = document.createElement('div');
    newCard.className = 'p-card';
    newCard.onclick = function() { tapAdd(p.name, p.price, 1); };
    newCard.innerHTML = `
      ${p.image ? `<img src="${p.image}" alt="${p.name}">` : `<div class="emoji">üì¶</div>`}
      <div>${p.name}</div>
      <small>‚Çπ${p.price}</small>
      <div class="qty-badge" style="position: absolute; top: 4px; right: 4px; background: #dc2626; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center; display: none;">0</div>
    `;
    grid.insertBefore(newCard, addCardBtn);
  });
}

// Edit Products Modal - with 5 editable steps per product
function openEditInventory() {
  const list = el("editInventoryList");
  const products = [
    { name: 'Cow 1L', emoji: 'üêÑ', rate: 64, unit: 'L', steps: [1, 2, 5, 10, 20] },
    { name: 'Cow 0.5L', emoji: 'üêÑ', rate: 32, unit: 'L', steps: [0.5, 1, 2, 5, 10] },
    { name: 'Buff 2L', emoji: 'üêÉ', rate: 200, unit: 'L', steps: [2, 5, 10, 20, 50] },
    { name: 'Buff 1L', emoji: 'üêÉ', rate: 100, unit: 'L', steps: [1, 2, 5, 10, 20] },
    { name: 'Buff 0.5L', emoji: 'üêÉ', rate: 50, unit: 'L', steps: [0.5, 1, 2, 5, 10] },
    { name: 'Paneer', emoji: 'üßÄ', rate: 320, unit: 'kg', steps: [0.25, 0.5, 1, 2, 5] },
    { name: 'Ghee', emoji: 'üçØ', rate: 180, unit: 'g', steps: [0.25, 0.5, 1, 2, 5] },
    { name: 'Milk Cake', emoji: 'üç∞', rate: 300, unit: 'kg', steps: [0.5, 1, 2, 5, 10] }
  ];

  list.innerHTML = products.map((p, i) => `
    <div style="padding:12px; background:#f8fafc; border-radius:10px; border:1px solid var(--line);">
      <div style="display:grid; grid-template-columns: 36px 1fr 70px 55px; gap:8px; align-items:center; margin-bottom:10px;">
        <div style="font-size:20px;">${p.emoji}</div>
        <input type="text" id="editName_${i}" value="${p.name}" style="padding:8px; border:2px solid #e2e8f0; border-radius:6px; font-weight:700; font-size:12px; min-width:0;" />
        <input type="number" id="editRate_${i}" value="${p.rate}" style="padding:8px; border:2px solid #e2e8f0; border-radius:6px; font-weight:700; text-align:center; font-size:12px;" />
        <input type="text" id="editUnit_${i}" value="${p.unit}" style="padding:8px; border:2px solid #e2e8f0; border-radius:6px; font-weight:700; text-align:center; font-size:12px;" />
      </div>

      <div style="font-size:10px; font-weight:700; color:var(--muted); margin-bottom:8px; display:flex; align-items:center; gap:6px;">
        <span>‚ö°</span> Quick Steps (edit or set 0 to disable):
      </div>
      <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:6px;">
        <div style="display:flex; flex-direction:column; gap:2px;">
          <label style="font-size:8px; font-weight:700; color:var(--muted); text-align:center;">1</label>
          <input type="number" id="editStep_${i}_0" value="${p.steps[0]}" step="0.1" style="padding:6px; border:1px solid #e2e8f0; border-radius:4px; font-weight:700; text-align:center; font-size:11px; width:100%; box-sizing:border-box;" />
        </div>
        <div style="display:flex; flex-direction:column; gap:2px;">
          <label style="font-size:8px; font-weight:700; color:var(--muted); text-align:center;">2</label>
          <input type="number" id="editStep_${i}_1" value="${p.steps[1]}" step="0.1" style="padding:6px; border:1px solid #e2e8f0; border-radius:4px; font-weight:700; text-align:center; font-size:11px; width:100%; box-sizing:border-box;" />
        </div>
        <div style="display:flex; flex-direction:column; gap:2px;">
          <label style="font-size:8px; font-weight:700; color:var(--muted); text-align:center;">3</label>
          <input type="number" id="editStep_${i}_2" value="${p.steps[2]}" step="0.1" style="padding:6px; border:1px solid #e2e8f0; border-radius:4px; font-weight:700; text-align:center; font-size:11px; width:100%; box-sizing:border-box;" />
        </div>
        <div style="display:flex; flex-direction:column; gap:2px;">
          <label style="font-size:8px; font-weight:700; color:var(--muted); text-align:center;">4</label>
          <input type="number" id="editStep_${i}_3" value="${p.steps[3]}" step="0.1" style="padding:6px; border:1px solid #e2e8f0; border-radius:4px; font-weight:700; text-align:center; font-size:11px; width:100%; box-sizing:border-box;" />
        </div>
        <div style="display:flex; flex-direction:column; gap:2px;">
          <label style="font-size:8px; font-weight:700; color:var(--muted); text-align:center;">5</label>
          <input type="number" id="editStep_${i}_4" value="${p.steps[4]}" step="0.1" style="padding:6px; border:1px solid #e2e8f0; border-radius:4px; font-weight:700; text-align:center; font-size:11px; width:100%; box-sizing:border-box;" />
        </div>
      </div>

      <button onclick="updateProductWithSteps(${i}, '${p.name}')" style="margin-top:10px; padding:8px 16px; background:#22c55e; color:white; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:12px; width:100%;">üíæ Update Product</button>
    </div>
  `).join('');

  openModal('editInventoryModal');
}

function updateProductWithSteps(index, oldName) {
  const newName = el(`editName_${index}`).value;
  const newRate = parseFloat(el(`editRate_${index}`).value);
  const newUnit = el(`editUnit_${index}`).value;
  
  // Get all 5 step values
  const newSteps = [
    parseFloat(el(`editStep_${index}_0`).value) || 0,
    parseFloat(el(`editStep_${index}_1`).value) || 0,
    parseFloat(el(`editStep_${index}_2`).value) || 0,
    parseFloat(el(`editStep_${index}_3`).value) || 0,
    parseFloat(el(`editStep_${index}_4`).value) || 0
  ];

  if (!newName || !newRate || newRate <= 0) return showToast('Invalid name or rate!');

  // Update in localStorage (for custom products)
  const customProducts = JSON.parse(localStorage.getItem('mr_pos_custom_products') || '[]');
  
  // Remove old product cards for this product
  const filteredProducts = customProducts.filter(p => p.name !== oldName);
  
  // Add new product cards for each non-zero step
  newSteps.forEach(step => {
    if (step !== 0) {
      filteredProducts.push({
        name: newName,
        price: newRate,
        unit: newUnit,
        step: step
      });
    }
  });
  
  localStorage.setItem('mr_pos_custom_products', JSON.stringify(filteredProducts));

  const activeSteps = newSteps.filter(s => s !== 0);
  showToast(`${newName} updated! ‚Çπ${newRate}/${newUnit} (${activeSteps.length} steps: ${activeSteps.join(', ')}) ‚úÖ`);
  closeModal('editInventoryModal');

  // Reload page to apply changes
  setTimeout(() => location.reload(), 1000);
}

// Update booth selection
function updateBooth() {
  const booth = el("boothSelect").value;
  const boothNames = {
    'main': 'Main Booth',
    'village-a': 'Village A Booth',
    'village-b': 'Village B Booth',
    'market': 'Market Booth'
  };
  localStorage.setItem('milkbook_booth', booth);
  localStorage.setItem('milkbook_shop_name', boothNames[booth]);
  showToast(`Booth: ${boothNames[booth]}`);
}

// Save shop settings
function saveShopSettings() {
  const shopName = el("shopNameInput").value.trim();
  const shopPhone = el("shopPhoneInput").value.trim();
  
  if (shopName) {
    localStorage.setItem('milkbook_shop_name', shopName);
  }
  if (shopPhone) {
    localStorage.setItem('milkbook_shop_phone', shopPhone);
  }
  
  closeModal('settingsModal');
  showToast('Shop settings saved! ‚úÖ');
}

// Load saved booth on startup
window.addEventListener('DOMContentLoaded', function() {
  const savedBooth = localStorage.getItem('milkbook_booth');
  if (savedBooth && el('boothSelect')) {
    el('boothSelect').value = savedBooth;
    // Also set shop name from booth
    const boothNames = {
      'main': 'Main Booth',
      'village-a': 'Village A Booth',
      'village-b': 'Village B Booth',
      'market': 'Market Booth'
    };
    if (!localStorage.getItem('milkbook_shop_name')) {
      localStorage.setItem('milkbook_shop_name', boothNames[savedBooth]);
    }
  }

  // Load shop settings if opening settings modal
  const settingsModal = document.getElementById('settingsModal');
  if (settingsModal) {
    settingsModal.addEventListener('click', function(e) {
      if (e.target === settingsModal) {
        // Load current settings
        const currentName = localStorage.getItem('milkbook_shop_name') || '';
        const currentPhone = localStorage.getItem('milkbook_shop_phone') || '';
        el('shopNameInput').value = currentName;
        el('shopPhoneInput').value = currentPhone;
      }
    });
  }
  
  // Show mobile footer on small screens
  function checkMobileFooter() {
    const mobileFooter = document.getElementById('mobileFooter');
    const desktopFooter = document.querySelector('.bottom');
    if (window.innerWidth <= 768) {
      if (mobileFooter) mobileFooter.style.display = 'block';
      if (desktopFooter) desktopFooter.style.display = 'none';
    } else {
      if (mobileFooter) mobileFooter.style.display = 'none';
      if (desktopFooter) desktopFooter.style.display = 'flex';
    }
  }
  
  // Check on load and resize
  checkMobileFooter();
  window.addEventListener('resize', checkMobileFooter);
});

// Keyboard Navigation - Full End-to-End Invoice Creation
document.addEventListener('keydown', function(e) {
  // Auto-focus product search when typing (if no other focus)
  if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
    const activeElement = document.activeElement;
    const isInputFocused = activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA';
    
    if (!isInputFocused) {
      e.preventDefault();
      const productSearch = document.getElementById('productSearch');
      if (productSearch) {
        productSearch.focus();
        productSearch.value = e.key;
      }
      return;
    }
  }
  
  // F1 = New Customer
  if (e.key === 'F1') {
    e.preventDefault();
    openModal('addCustModal');
    setTimeout(() => el("newName").focus(), 100);
    return;
  }
  
  // Enter key handling
  if (e.key === 'Enter') {
    e.preventDefault(); // Prevent default form submission
    
    // In search box - select first result or current customer
    if (document.activeElement === el("custSearch")) {
      const firstResult = document.querySelector('.drop-item');
      if (firstResult) {
        firstResult.click();
      }
      // Move focus to product grid (first product)
      const firstProduct = document.querySelector('.p-card:not([onclick*="addProduct"])');
      if (firstProduct) firstProduct.focus();
      return;
    }

    // In add customer modal - navigate fields
    if (el("addCustModal") && el("addCustModal").style.display === 'flex') {
      if (document.activeElement === el("newName")) {
        el("subQty").focus();
        el("subQty").select();
      } else if (document.activeElement === el("subQty")) {
        addCust();
      }
      return;
    }

    // In cart quantity/amount fields - move to next
    if (document.activeElement.tagName === 'INPUT' &&
        document.activeElement.type === 'number' &&
        document.activeElement.closest('.recent-table')) {
      const inputs = Array.from(document.querySelectorAll('.recent-table input[type="number"]'));
      if (inputs && inputs.length > 0) {
        const currentIndex = inputs.indexOf(document.activeElement);
        if (currentIndex >= 0 && currentIndex < inputs.length - 1) {
          inputs[currentIndex + 1].focus();
          inputs[currentIndex + 1].select();
        }
      }
      return;
    }
    
    // In payment amount field - save invoice
    if (document.activeElement === el("paymentAmount")) {
      saveAndInvoice();
      return;
    }
  }
  
  // Escape - clear search
  if (e.key === 'Escape') {
    if (document.activeElement === el("custSearch")) {
      el("custSearch").value = "";
      el("searchDropdown").style.display = "none";
    }
    // Don't close modals on Escape - user might be typing
    return;
  }
  
  // Number keys 1-9 when product grid focused - quick add
  if (document.activeElement.classList.contains('p-card')) {
    const num = parseInt(e.key);
    if (num >= 1 && num <= 9) {
      const products = document.querySelectorAll('.p-card:not([onclick*="addProduct"])');
      if (products[num - 1]) {
        products[num - 1].click();
      }
    }
  }
});

// Make product cards focusable for keyboard navigation
document.querySelectorAll('.p-card').forEach(card => {
  card.setAttribute('tabindex', '0');
  card.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      this.click();
    }
  });
});

// Focus search on page load
setTimeout(() => el("custSearch").focus(), 500);
    </script>
  </body>
</html>