<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
    <title>MilkRecord - Institutional Speed POS</title>
    <style>
      :root {
        --bg: #f4f7fb; --panel: #ffffff; --line: #e5e7eb; --text: #0f172a; --muted: #64748b;
        --blue: #2563eb; --blue2: #1d4ed8; --green: #16a34a; --red: #dc2626; --yellow: #f59e0b;
        --shadow: 0 12px 26px rgba(0, 0, 0, 0.08);
      }
      * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; margin: 0; overflow: auto; min-height: 100vh; }
      .app { min-height: 100vh; display: grid; grid-template-rows: auto 1fr auto; gap: 14px; padding: 14px; }
      
      /* --- HEADER --- */
      .topbar { background: #fff; border: 1px solid var(--line); border-radius: 22px; box-shadow: var(--shadow); padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
      .brand { display: flex; align-items: center; gap: 14px; }
      .logo-box { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: linear-gradient(180deg, #e0f2fe, #dbeafe); border: 1px solid #c7d2fe; font-size: 22px; }
      .brand-text .title { font-weight: 800; font-size: 17px; color: #0f172a; line-height: 1.2; }
      .brand-text .sub-text { font-size: 12px; font-weight: 600; color: var(--muted); }
      .hdr-actions { display: flex; align-items: center; gap: 10px; }
      .pillbtn { height: 42px; padding: 0 16px; border-radius: 12px; border: 1px solid var(--line); background: #fff; font-weight: 700; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }

      /* --- CORE LAYOUT --- */
      .core { display: grid; grid-template-columns: 1.3fr 0.7fr; gap: 14px; }
      .panel { background: var(--panel); border: 1px solid var(--line); border-radius: 22px; box-shadow: var(--shadow); display: flex; flex-direction: column; max-height: calc(100vh - 200px); }
      .panelHeader { padding: 12px 16px; border-bottom: 1px solid var(--line); font-weight: 1000; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }

      /* --- SEARCH & PERSISTENCE AREA --- */
      .cust-control { padding: 10px 15px; background: #f8fafc; border-bottom: 1px solid var(--line); display: flex; gap: 10px; position: relative; }
      .search-box { flex: 1; position: relative; }
      .search-box input { width: 100%; height: 40px; border-radius: 10px; border: 1px solid var(--line); padding-left: 35px; outline: none; }
      .search-box::before { content: 'üîç'; position: absolute; left: 10px; top: 10px; font-size: 14px; }
      
      /* New Dropdown Style */
      .search-dropdown { position: absolute; left: 0; width: 100%; background: #fff; border: 1px solid var(--line); border-radius: 10px; z-index: 100; display: none; box-shadow: var(--shadow); max-height: 200px; overflow-y: auto; }
      .drop-item { padding: 10px; border-bottom: 1px solid #f1f5f9; cursor: pointer; font-weight: 700; font-size: 13px; }
      .drop-item:hover { background: #f8fafc; color: var(--blue); }

      .add-btn { height: 40px; padding: 0 15px; border-radius: 10px; border: none; background: var(--blue); color: #fff; font-weight: 1000; cursor: pointer; }

      .product-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; overflow-y: auto; flex: 1; }
      .p-card { background: #fff; border: 1px solid var(--line); border-radius: 18px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.1s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
      .p-card:active { transform: scale(0.95); background: #f8fafc; }
      .p-card.cow { border-left: 6px solid var(--green); }
      .p-card.buff { border-left: 6px solid var(--red); }
      .p-card div { font-weight: 900; font-size: 14px; }
      .p-card small { color: var(--muted); font-weight: 700; }

      .qty-bar { display: flex; gap: 10px; padding: 12px 15px; background: #f8fafc; border-top: 1px solid var(--line); }
      .qty-btn { flex: 1; height: 45px; border-radius: 10px; border: 1px solid var(--line); background: #fff; font-weight: 1000; cursor: pointer; }

      .summary-box { background: linear-gradient(180deg, var(--blue), var(--blue2)); color: #fff; padding: 20px; border-radius: 18px; margin: 15px; text-align: center; }
      .amt { font-size: 42px; font-weight: 1200; }
      
      .pay-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 15px 15px; }
      .pay-btn { height: 45px; border-radius: 12px; border: none; font-weight: 1000; cursor: pointer; }
      .pay-btn.credit { grid-column: 1/-1; background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }

      .recent-table { width: 100%; border-collapse: collapse; font-size: 13px; }
      .recent-table td { padding: 10px; border-bottom: 1px solid var(--line); font-weight: 700; vertical-align: middle; }
      .recent-table input { padding: 4px; border: 1px solid var(--line); border-radius: 6px; font-weight: 700; text-align: center; }
      .recent-table input[type="number"]::-webkit-inner-spin-button { opacity: 1; cursor: pointer; }
      .recent-table .remove-btn { background: #fecaca; color: #7f1d1d; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-weight: 700; font-size: 12px; }

      .overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.45); display: none; align-items: center; justify-content: center; z-index: 100; }
      .modal { width: min(800px, 95vw); height: min(600px, 90vh); background: #fff; border-radius: 22px; display: grid; grid-template-rows: 60px 1fr 70px; overflow: hidden; box-shadow: 0 24px 60px rgba(0,0,0,0.3); }
      .modalBody { padding: 20px; overflow-y: auto; background: #f8fafc; }
      .cardRow { background: #fff; border: 1px solid var(--line); border-radius: 16px; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
      
      .bottom { display: grid; grid-template-columns: 1fr 1.4fr 1fr; gap: 12px; height: 96px; }
      .panicBtn { border: none; border-radius: 22px; font-size: 22px; font-weight: 1200; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: var(--shadow); }
      .subnote { font-size: 11px; font-weight: 1000; opacity: 0.7; }
      .badge { font-size: 10px; padding: 2px 6px; border-radius: 5px; background: #dcfce7; color: #166534; font-weight: 1000; }
      .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); display: inline-block; margin-right: 5px; }
      .sync-msg { font-size: 10px; font-weight: 900; color: var(--muted); text-transform: uppercase; }
      .toast { position: fixed; left: 50%; bottom: 116px; transform: translateX(-50%); background: #0f172a; color: #fff; padding: 12px 20px; border-radius: 16px; font-weight: 1100; opacity: 0; transition: 0.3s; z-index: 200; }
      .toast.show { opacity: 1; }
      
      /* Demo Banner */
      .demo-banner { background: #fef3c7; border-bottom: 2px solid #f59e0b; padding: 10px 20px; text-align: center; font-size: 13px; font-weight: 600; color: #92400e; }
      
      /* Institutional Gaps Panel */
      .gaps-panel { position: fixed; right: 0; top: 0; bottom: 0; width: 300px; background: #f8fafc; border-left: 2px solid #e2e8f0; padding: 20px; overflow-y: auto; transform: translateX(100%); transition: transform 0.3s; z-index: 1000; }
      .gaps-panel.open { transform: translateX(0); }
      .gaps-toggle { position: fixed; right: 20px; bottom: 120px; width: 50px; height: 50px; border-radius: 50%; background: #64748b; color: white; border: none; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 999; }
      .gap-item { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 10px; opacity: 0.6; }
      .gap-item h4 { margin: 0 0 5px 0; font-size: 13px; color: #475569; }
      .gap-item p { margin: 0; font-size: 12px; color: #64748b; }
      .gap-tooltip { background: #fef3c7; color: #92400e; font-size: 11px; padding: 6px; border-radius: 4px; margin-top: 6px; font-style: italic; }

      /* Hover Info - Subtle, minimal UI */
      .hover-info {
        background: #f1f5f9;
        color: #64748b;
        padding: 6px;
        font-size: 11px;
        font-weight: 600;
        text-align: center;
        border-radius: 0 0 8px 8px;
        opacity: 0;
        transform: translateY(-5px);
        transition: all 0.2s ease;
        cursor: help;
      }
      .panel:hover .hover-info {
        opacity: 1;
        transform: translateY(0);
      }
      .summary-box .hover-info {
        margin-top: 10px;
        border-radius: 6px;
        opacity: 1;
        transform: none;
        background: rgba(255,255,255,0.2);
        color: white;
      }

      /* Card Image aur Selection Style */
.p-card img { width: 45px; height: 45px; object-fit: cover; margin-bottom: 8px; border-radius: 10px; }
.p-card.selected { border: 3px solid var(--blue) !important; background: #eff6ff !important; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3) !important; transform: scale(1.02); }
.price-input { width: 60px; border: 1px solid var(--line); border-radius: 5px; padding: 2px; font-weight: bold; text-align: center; }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="topbar">
        <div class="brand">
          <a href="homepage.html" style="text-decoration:none; color:inherit;">
            <div class="logo-box">üíß</div>
            <div class="brand-text">
              <div class="title" id="shopTitle">MilkRecord POS</div>
              <div class="sub-text" id="todayLabel">‚Äî</div>
            </div>
          </a>
        </div>
        <div class="hdr-actions">
          <div style="margin-right: 10px; text-align: right;">
            <div class="sync-msg"><span class="status-dot"></span> Cloud Active</div>
            <div style="font-size: 9px; color: var(--muted);">Offline-First Data</div>
          </div>
          <button class="pillbtn primary" onclick="location.href='index.html'">üçº <span id="btnIntakeText">Milk Intake</span></button>
          <button class="pillbtn" id="btnMem" onclick="renderMemory()">üß† Memory</button>
          <button class="pillbtn" id="btnHist" onclick="openModal('historyModal')">üßæ History</button>
          <button class="pillbtn" id="btnExp" style="background:#eef2ff;" onclick="exportDetailedExcel()">üìä Export</button>
          
          <button class="pillbtn" id="langSwitch" onclick="toggleLanguage()">üåê HI/EN</button>
        </div>
      </div>

      <div class="core">
        <div class="panel">
          <div class="panelHeader">
            <span id="lblTerm">Terminal</span> 
            <div style="display:flex; gap:10px; align-items:center;">
                <button onclick="openModal('convertModal')" id="btnConv" style="font-size:10px; font-weight:1000; background:#fff; border:1px solid var(--line); border-radius:6px; padding:4px 8px; cursor:pointer;">üîÑ CONVERT</button>
                <small id="activeCust" style="color:var(--blue); font-weight:1000;">Walking Customer</small>
            </div>
          </div>
          
          <div class="cust-control">
            <!-- Customer search dropdown positioned ABOVE -->
            <div class="search-box" style="position: relative;">
              <span style="font-size: 18px;">üîé</span>
              <input type="text" id="custSearch" placeholder="Search customer..." oninput="handleSearch(this.value)" onclick="event.stopPropagation()" style="width: 100%;" />
              <div id="searchDropdown" class="search-dropdown" onclick="event.stopPropagation()" style="top: auto; bottom: 100%; margin-bottom: 8px;"></div>
            </div>
            <button class="add-btn" id="btnAdd" onclick="openModal('addCustModal'); event.stopPropagation();">+ Add New</button>
          </div>

          <!-- Product search field -->
          <div style="padding: 10px 15px; background: #f8fafc; border-top: 1px solid var(--line);">
            <input type="text" id="productSearch" placeholder="üîç Search products..." oninput="filterProducts(this.value)" style="width: 100%; padding: 10px; border: 2px solid var(--line); border-radius: 10px; font-size: 14px; font-weight: 600;" onclick="event.stopPropagation()" />
          </div>

          <div class="product-grid" id="productGrid" onclick="closeSearchDropdown()">
            <!-- Cow Products -->
            <div class="p-card cow" onclick="tapAdd('Cow Milk', 64, 1)">
              <span class="emoji" style="font-size: 56px;">üêÑ</span>
              <div data-en="Cow 1L" data-hi="‡§ó‡§æ‡§Ø ‡§¶‡•Ç‡§ß 1L" style="font-size: 18px; font-weight: 900; margin-top: 8px;">Cow 1L</div>
              <small style="font-size: 16px; margin-top: 4px;">‚Çπ64</small>
            </div>
            <div class="p-card cow" onclick="tapAdd('Cow Milk', 32, 0.5)">
              <span class="emoji" style="font-size: 42px;">üêÑ</span>
              <div data-en="Cow 0.5L" data-hi="‡§ó‡§æ‡§Ø ‡§¶‡•Ç‡§ß 0.5L" style="font-size: 16px; font-weight: 900; margin-top: 8px;">Cow 0.5L</div>
              <small style="font-size: 14px; margin-top: 4px;">‚Çπ32</small>
            </div>
            
            <!-- Buffalo Products -->
            <div class="p-card buff" onclick="tapAdd('Buff Milk', 100, 1)">
              <span class="emoji" style="font-size: 56px;">üêÉ</span>
              <div data-en="Buff 1L" data-hi="‡§≠‡•à‡§Ç‡§∏ ‡§¶‡•Ç‡§ß 1L" style="font-size: 18px; font-weight: 900; margin-top: 8px;">Buff 1L</div>
              <small style="font-size: 16px; margin-top: 4px;">‚Çπ100</small>
            </div>
            <div class="p-card buff" onclick="tapAdd('Buff Milk', 80, 1)">
              <span class="emoji" style="font-size: 56px;">üêÉ</span>
              <div data-en="Buff 1L" data-hi="‡§≠‡•à‡§Ç‡§∏ ‡§¶‡•Ç‡§ß 1L" style="font-size: 18px; font-weight: 900; margin-top: 8px;">Buff 1L</div>
              <small style="font-size: 16px; margin-top: 4px;">‚Çπ80</small>
            </div>
            <div class="p-card buff" onclick="tapAdd('Buff Milk', 40, 0.5)">
              <span class="emoji" style="font-size: 42px;">üêÉ</span>
              <div data-en="Buff 0.5L" data-hi="‡§≠‡•à‡§Ç‡§∏ ‡§¶‡•Ç‡§ß 0.5L" style="font-size: 16px; font-weight: 900; margin-top: 8px;">Buff 0.5L</div>
              <small style="font-size: 14px; margin-top: 4px;">‚Çπ40</small>
            </div>
            
            <!-- Other Products -->
            <div class="p-card" style="border-left:6px solid var(--yellow)" onclick="tapAdd('Paneer', 320, 1)">
              <span class="emoji" style="font-size: 56px;">üßÄ</span>
              <div data-en="Paneer kg" data-hi="‡§™‡§®‡•Ä‡§∞ ‡§ï‡§ø‡§≤‡•ã" style="font-size: 18px; font-weight: 900; margin-top: 8px;">Paneer kg</div>
              <small style="font-size: 16px; margin-top: 4px;">‚Çπ320</small>
            </div>
            <div class="p-card" style="border-left:6px solid #fb923c" onclick="tapAdd('Ghee', 180, 0.25)">
              <span class="emoji" style="font-size: 56px;">üçØ</span>
              <div data-en="Ghee 250g" data-hi="‡§ò‡•Ä 250g" style="font-size: 18px; font-weight: 900; margin-top: 8px;">Ghee 250g</div>
              <small style="font-size: 16px; margin-top: 4px;">‚Çπ180</small>
            </div>
            <div class="p-card" onclick="tapAdd('Milk Cake', 300, 1)">
              <span class="emoji" style="font-size: 56px;">üç∞</span>
              <div data-en="Milk Cake" data-hi="‡§Æ‡§ø‡§≤‡•ç‡§ï ‡§ï‡•á‡§ï" style="font-size: 18px; font-weight: 900; margin-top: 8px;">Milk Cake</div>
              <small style="font-size: 16px; margin-top: 4px;">‚Çπ300</small>
            </div>
            <div class="p-card" style="border: 3px dashed var(--blue); background: #eff6ff;" onclick="openModal('addProductModal')">
              <div style="font-size:60px; color:var(--blue); font-weight: 900;">‚ûï</div>
              <div style="font-weight:900; color:var(--blue); font-size:16px; margin-top: 8px;">ADD PRODUCT</div>
            </div>
          </div>

          <!-- Keyboard shortcuts - Hidden by default, show on hover -->
          <div class="hover-info" style="text-align: center; border-top: 1px solid var(--line);" title="Enter = Next field | Esc = Clear search | F1 = New customer">
            ‚å®Ô∏è Keyboard shortcuts
          </div>
        </div>

        <div class="panel">
          <div class="panelHeader" id="lblSum">Summary</div>
          <div class="summary-box">
            <div style="font-size:12px; opacity:0.8;" id="lblPayable">TOTAL PAYABLE</div>
            <div class="amt" id="totalAmt">‚Çπ0.00</div>
            <!-- Record Strength Tag - Hidden by default, show on hover -->
            <div class="hover-info" title="Retail records are valid for daily sales and udhar tracking">
              üìä Record Strength: <span style="color: #f59e0b;">RETAIL</span>
            </div>
          </div>

          <!-- Advance/Cut Ledger Section - Collapsed by default -->
          <div id="advanceSection" style="display:none; background:#fef3c7; border:2px solid #f59e0b; border-radius:16px; margin:15px; padding:15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
              <h4 style="margin:0; color:#92400e; font-size:14px;">üìí Ledger Entry</h4>
              <button onclick="closeAdvance()" style="background:none; border:none; font-size:18px; cursor:pointer; color:#92400e;">‚úñ</button>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
              <div style="background:white; padding:10px; border-radius:8px; text-align:center;">
                <div style="font-size:11px; color:#64748b; font-weight:700;">TOTAL MILK (MONTH)</div>
                <div style="font-size:18px; font-weight:900; color:#1e293b;" id="monthMilk">0.0 L</div>
              </div>
              <div style="background:white; padding:10px; border-radius:8px; text-align:center;">
                <div style="font-size:11px; color:#64748b; font-weight:700;">CURRENT BALANCE</div>
                <div style="font-size:18px; font-weight:900; color:#166534;" id="currentAdvance">‚Çπ0.00</div>
              </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <input type="number" id="advanceAmount" placeholder="Amount (‚Çπ)" style="padding:10px; border-radius:8px; border:1px solid #f59e0b; font-weight:700;" />
              <select id="advanceAction" style="padding:10px; border-radius:8px; border:1px solid #f59e0b; font-weight:700;">
                <option value="give">‚ûï Credit (Udhar)</option>
                <option value="cut">‚ûñ Debit (Payment)</option>
              </select>
            </div>
            <button onclick="updateAdvance()" style="width:100%; margin-top:10px; padding:12px; background:#f59e0b; color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer;">Update Ledger</button>
            <button onclick="sendMonthlySummary()" style="width:100%; margin-top:8px; padding:12px; background:white; color:#92400e; border:1px solid #f59e0b; border-radius:8px; font-weight:700; cursor:pointer;">üí¨ Send Summary</button>
          </div>
          
          <!-- Advance Toggle Button (Always Visible) -->
          <button onclick="toggleAdvance()" id="advanceToggleBtn" style="margin:0 15px; padding:10px; background:#fef3c7; border:2px solid #f59e0b; border-radius:12px; font-weight:700; color:#92400e; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
            üìï Advance / Udhar
          </button>
          <div id="udharThresholdNudge" style="display: none; margin: 0 15px 15px; padding: 10px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; font-size: 11px; color: #92400e; font-weight: 700;">
            ‚ö†Ô∏è High outstanding credit<br>
            <span style="font-weight: 500; color: #64748b;">Retail POS tracks balance, not settlement responsibility.</span>
          </div>

          <div class="pay-grid">
            <button class="pay-btn" id="btnCash" style="background:#dcfce7; color:#166534;" onclick="saveEntry('Cash')">CASH</button>
            <button class="pay-btn" id="btnUpi" style="background:#eff6ff; color:#1e40af;" onclick="saveEntry('UPI')">UPI</button>
            <button class="pay-btn credit" id="btnCredit" onclick="saveEntry('Credit')">LIKH LO (Credit)</button>
          </div>

          <!-- Payment info - Hidden by default, show on hover -->
          <div class="hover-info" style="text-align: center;" title="Settlement traceability available in collection center system">
            Retail payment mode
          </div>

          <div style="padding:15px; flex:1; overflow-y:auto; border-top:1px solid var(--line);">
            <table class="recent-table"><tbody id="cartItems"></tbody></table>
          </div>
        </div>
      </div>

      <div class="bottom" style="flex-shrink: 0;">
        <button class="panicBtn" style="background:#22c55e; color:#064e3b;" onclick="saveEntry('Quick')"><span>üü¢ SAVE</span> <span class="subnote">complete</span></button>
        <button class="panicBtn" style="background:#fde68a; color:#78350f;" onclick="holdCart()"><span id="txtHold">üü° HOLD</span> <span class="subnote">save</span></button>
        <button class="panicBtn" style="background:#fef3c7; color:#92400e; font-size:18px;" onclick="showHeldCarts()" title="View held orders">üìã <span class="subnote" id="heldCount">0</span></button>
      </div>

      <!-- Unsaved cart warning - Hover only -->
      <div class="hover-info" title="Click SAVE to complete or HOLD to save for later">
        Completes retail transaction only
      </div>
    </div>

    <div class="overlay" id="addCustModal">
        <div class="modal" style="width:450px; height:auto;">
            <div class="panelHeader"><span>üë§ Institutional Record</span> <button onclick="closeModal('addCustModal')">‚úñ</button></div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <input type="text" id="newName" placeholder="Full Name" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:1000;">
                <select id="newType" style="padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:1000;">
                    <option value="Retail">Retail Walk-in</option>
                    <option value="PACS">PACS Member</option>
                    <option value="FPO">FPO Shareholder</option>
                </select>
                <div style="background:#f8fafc; padding:10px; border-radius:10px; border:1px solid var(--line);">
    <label style="font-size:11px; font-weight:1000; color:var(--muted);">SUBSCRIPTION PLAN (Point 17)</label>
    <input type="number" id="subQty" placeholder="Daily Quantity (L)" style="width:100%; padding:10px; border:none; background:transparent; font-weight:1000;">
</div>
                <button class="add-btn" style="height:50px;" onclick="addCust()">Save & Link Identity</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="memoryModal">
      <div class="modal" style="width:500px; height:auto;">
        <div class="panelHeader"><span id="lblMemTitle">Customer Memory üß†</span> <button onclick="closeModal('memoryModal')">‚úñ</button></div>
        <div class="modalBody" id="memoryList"></div>
      </div>
    </div>

    <div class="overlay" id="historyModal">
      <div class="modal" style="height:auto; max-height:80vh;">
        <div class="panelHeader">
          <span id="lblHistTitle">üßæ History</span>
          <button onclick="closeModal('historyModal')">‚úñ</button>
        </div>
        
        <!-- Tabs -->
        <div style="display:flex; border-bottom:1px solid var(--line); padding:0 20px;">
          <button onclick="switchHistoryTab('today')" id="tabToday" style="flex:1; padding:12px; border:none; background:none; font-weight:700; cursor:pointer; border-bottom:3px solid var(--blue);">üìÖ Today</button>
          <button onclick="switchHistoryTab('all')" id="tabAll" style="flex:1; padding:12px; border:none; background:none; font-weight:700; cursor:pointer; border-bottom:3px solid transparent;">üìö All History</button>
        </div>
        
        <!-- Tab Content -->
        <div class="modalBody" style="display:block; padding:15px; overflow-y:auto; max-height:50vh;">
          <div id="historyToday" style="display:block;"></div>
          <div id="historyWeekly" style="display:none;"></div>
        </div>
        
        <!-- Footer Actions -->
        <div style="padding:15px 20px; border-top:1px solid var(--line); display:flex; gap:10px; justify-content:space-between;">
          <div style="font-size:13px; color:var(--muted); font-weight:700;">
            <span id="historyCount">1 today ‚Ä¢ 0 in 7d</span>
          </div>
          <div style="display:flex; gap:8px;">
            <button onclick="downloadHistoryCSV()" style="padding:8px 16px; background:#eff6ff; color:#1e40af; border:none; border-radius:8px; font-weight:700; cursor:pointer;">‚¨áÔ∏è Export</button>
            <button onclick="clearTodayHistory()" style="padding:8px 16px; background:#fecaca; color:#7f1d1d; border:none; border-radius:8px; font-weight:700; cursor:pointer;">üóëÔ∏è Clear Today</button>
          </div>
        </div>
      </div>
    </div>

    <div class="overlay" id="convertModal">
        <div class="modal" style="width:400px; height:auto;">
            <div class="panelHeader"><span>üîÑ Milk ‚Üí Product Conversion</span> <button onclick="closeModal('convertModal')">‚úñ</button></div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <input type="number" id="convQty" placeholder="Milk (L)" style="width:100%; padding:15px; border-radius:10px; border:1px solid var(--line); font-weight:1000;">
                <select id="convProduct" style="width:100%; padding:15px; border-radius:10px; border:1px solid var(--line); font-weight:1000;">
                    <option value="Cow Milk,64">Cow Milk (‚Çπ64/L)</option>
                    <option value="Buff Milk,100">Buff Milk (‚Çπ100/L)</option>
                    <option value="Buff Milk,80">Buff Milk (‚Çπ80/L)</option>
                </select>
                <button class="add-btn" style="width:100%; background:var(--green);" onclick="convertMilkToProduct()">Update Stock</button>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="overlay" id="addProductModal">
        <div class="modal" style="width:400px; height:auto;">
            <div class="panelHeader"><span>üì¶ Add New Product</span> <button onclick="closeModal('addProductModal')">‚úñ</button></div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <input type="text" id="pName" placeholder="Product Name (e.g., Curd 500g)" style="width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:700; font-size: 14px;">
                <input type="number" id="pPrice" placeholder="Price (‚Çπ)" style="width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:700; font-size: 14px;">
                <input type="text" id="pEmoji" placeholder="Emoji (e.g., ü•õ, üßÄ, üçØ)" style="width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); font-weight:700; font-size: 14px;">
                <button class="add-btn" style="width:100%; background:var(--green);" onclick="addNewProductFromModal()">Create Product</button>
            </div>
        </div>
    </div>

    <!-- Held Carts Modal -->
    <div class="overlay" id="heldCartsModal">
        <div class="modal" style="width:500px; height:auto;">
            <div class="panelHeader"><span>üìã Held Orders</span> <button onclick="closeModal('heldCartsModal')">‚úñ</button></div>
            <div class="modalBody" id="heldCartsList" style="padding:20px; display:flex; flex-direction:column; gap:10px;"></div>
        </div>
    </div>

    <!-- Unsaved Cart Warning Modal -->
    <div class="overlay" id="unsavedCartModal" style="background: rgba(0,0,0,0.75);">
        <div class="modal" style="width:450px; height:auto; border-radius: 22px; box-shadow: 0 24px 60px rgba(0,0,0,0.5);">
            <div class="panelHeader" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; justify-content: space-between;">
                <span style="font-weight: 900;">‚ö†Ô∏è Unsaved Order!</span>
                <button onclick="closeModal('unsavedCartModal')" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">‚úñ</button>
            </div>
            <div style="padding:30px; text-align:center;">
                <div style="font-size:60px; margin-bottom:15px;">üõí</div>
                <h3 style="margin:0 0 10px 0; color:#1e293b; font-size:20px;">You have unsaved items in cart!</h3>
                <p style="color:#64748b; font-size:14px; margin:0 0 25px 0;">Do you want to HOLD or SAVE before closing?</p>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <button onclick="holdAndClose()" style="padding:15px; background:#fde68a; color:#92400e; border:2px solid #f59e0b; border-radius:12px; font-weight:900; font-size:16px; cursor:pointer;">
                        üü° HOLD<br><span style="font-size:12px; font-weight:700;">Save for later</span>
                    </button>
                    <button onclick="saveAndClose()" style="padding:15px; background:#22c55e; color:white; border:2px solid #16a34a; border-radius:12px; font-weight:900; font-size:16px; cursor:pointer;">
                        üü¢ SAVE<br><span style="font-size:12px; font-weight:700;">Complete order</span>
                    </button>
                </div>
                
                <button onclick="closeAndDiscard()" style="margin-top:15px; padding:10px; background:#f1f5f9; color:#64748b; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">
                    ‚ùå Discard and Close
                </button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Institutional Gaps Panel -->
    <button class="gaps-toggle" onclick="toggleGaps()" title="Institutional Records">üìã</button>
    <div class="gaps-panel" id="gapsPanel">
      <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #1e293b;">Institutional Records (Not Tracked)</h3>
      
      <div class="gap-item">
        <h4>üü° Farmer source</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
      
      <div class="gap-item">
        <h4>üü° Quality test (Fat/SNF)</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
      
      <div class="gap-item">
        <h4>üü° Payment settlement</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
      
      <div class="gap-item">
        <h4>üü° Deductions / loans</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
      
      <div class="gap-item">
        <h4>üü° Equipment logs</h4>
        <p>Not recorded</p>
        <div class="gap-tooltip">Required only for milk collection centers</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="netlify-client.js"></script>
    <script>
      // Check if backend is configured
      let useBackend = false;
      let currentShopId = null;
      let currentUserId = null;
      let authToken = null;
      
      // Initialize Supabase
      window.addEventListener('DOMContentLoaded', async () => {
        if (window.MilkBookConfig && window.MilkBookConfig.isConfigured()) {
          useBackend = true;
          console.log('‚úÖ Backend connected');
          
          // Check if user is logged in
          const session = localStorage.getItem('milkbook_session');
          if (session) {
            const sessionData = JSON.parse(session);
            currentShopId = sessionData.shop_id;
            currentUserId = sessionData.user_id;
            authToken = sessionData.token;
            
            // Load customers from backend
            await loadCustomersFromBackend();
            
            // Load sales history from backend
            await loadSalesFromBackend();
          }
        } else {
          console.log('‚ö†Ô∏è Using offline mode (localStorage)');
        }
      });
      
      // Warn before close/refresh if cart has items
      window.addEventListener('beforeunload', (e) => {
        if (cart.length > 0) {
          // Show our custom modal instead of browser default
          e.preventDefault();
          e.returnValue = '';
          
          // Open the unsaved cart modal
          const modal = document.getElementById('unsavedCartModal');
          if (modal) {
            modal.style.display = 'flex';
          }
          
          return '';
        }
      });
      
      // Hold and close
      function holdAndClose() {
        if (cart.length > 0) {
          holdCart();
          closeModal('unsavedCartModal');
          showToast('Order held! You can now close safely ‚úÖ');
        }
      }
      
      // Save and close
      function saveAndClose() {
        if (cart.length > 0) {
          saveEntry('Quick');
          closeModal('unsavedCartModal');
          showToast('Order saved! You can now close ‚úÖ');
        }
      }
      
      // Close and discard
      function closeAndDiscard() {
        cart = [];
        updateUI();
        closeModal('unsavedCartModal');
        showToast('Order discarded');
      }
      
      // Show hold/save popup on page hide (tab close, refresh, navigation)
      window.addEventListener('visibilitychange', async () => {
        if (document.visibilityState === 'hidden' && cart.length > 0) {
          // Auto-hold the cart
          const customerName = el("activeCust").innerText;
          const holdId = Date.now();
          
          heldCarts.push({
            id: holdId,
            customer: customerName,
            cart: [...cart],
            total: total,
            timestamp: new Date().toISOString()
          });
          
          localStorage.setItem('mr_held_carts', JSON.stringify(heldCarts));
          console.log('üü° Auto-held cart for', customerName);
        }
      });
      
      // Load customers from backend
      async function loadCustomersFromBackend() {
        if (!useBackend || !currentShopId) return;
        
        try {
          // In real implementation, fetch from API
          // const response = await fetch('/.netlify/functions/customers', {
          //   headers: { 'Authorization': `Bearer ${authToken}` }
          // });
          // const { customers } = await response.json();
          // customers.forEach(c => {
          //   if (!customersData.find(existing => existing.name === c.name)) {
          //     customersData.push(c);
          //   }
          // });
          console.log('Loaded customers from backend');
        } catch (error) {
          console.error('Failed to load customers:', error);
        }
      }
      
      // Load sales from backend
      async function loadSalesFromBackend() {
        if (!useBackend || !currentShopId) return;
        
        try {
          // In real implementation, fetch from API
          console.log('Loaded sales from backend');
        } catch (error) {
          console.error('Failed to load sales:', error);
        }
      }
      
      // Save sale to backend
      async function saveSaleToBackend(saleData) {
        if (!useBackend || !currentShopId) return null;
        
        try {
          const response = await fetch('/.netlify/functions/sales', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
              shop_id: currentShopId,
              customer_name: saleData.customer,
              customer_phone: saleData.phone || '',
              items: saleData.items,
              total_amount: saleData.total,
              payment_mode: saleData.paymentMode
            })
          });
          
          if (response.ok) {
            const { sale } = await response.json();
            return sale;
          }
          return null;
        } catch (error) {
          console.error('Failed to save sale:', error);
          return null;
        }
      }
    </script>
    <script>
      const el = (id) => document.getElementById(id);
      let cart = [], total = 0, exportHistory = [], currentLang = 'en';
      let heldCarts = JSON.parse(localStorage.getItem('mr_held_carts') || '[]'); // Hold functionality
      let lastRate = parseFloat(localStorage.getItem('mr_last_rate') || '64'); // Save/retrieve last rate
      
      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // Load data from LocalStorage taaki refresh par na ude
let customers = JSON.parse(localStorage.getItem('mr_pos_customers')) || [
    { name: "Rahul Sharma", lastOrder: "1.5L Cow Milk", rate: 64, qty: 1.5, type: "Retail", sub: 1.5 },
    { name: "Amit DCS", lastOrder: "1kg Paneer", rate: 320, qty: 1, type: "PACS", sub: 2 }
];


      // Logic: 4am-4pm Morning, 4pm-4am Evening
      function updateShift() {
          const now = new Date();
          const hrs = now.getHours();
          const dateStr = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
          const shift = (hrs >= 4 && hrs < 16) ? (currentLang === 'en' ? 'Morning Shift' : '‡§∏‡•Å‡§¨‡§π ‡§ï‡•Ä ‡§™‡§æ‡§≤‡•Ä') : (currentLang === 'en' ? 'Evening Shift' : '‡§∂‡§æ‡§Æ ‡§ï‡•Ä ‡§™‡§æ‡§≤‡•Ä');
          el("todayLabel").textContent = `${dateStr} | ${shift}`;
      }

      // Logic: Hindi Translation Dictionary
      const langData = {
          en: { shop:"MilkRecord POS", mem:"üß† Memory", hist:"üßæ History", exp:"üìä Export", term:"Terminal", sum:"Summary", payable:"TOTAL PAYABLE", cash:"CASH", credit:"LIKH LO (Credit)", hold:"üü° HOLD", done:"üü¢ DONE", clear:"üî¥ CLEAR" },
          hi: { shop:"‡§Æ‡§ø‡§≤‡•ç‡§ï-‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°", mem:"üß† ‡§Ø‡§æ‡§¶‡•á‡§Ç", hist:"üßæ ‡§á‡§§‡§ø‡§π‡§æ‡§∏", exp:"üìä ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü", term:"‡§ü‡§∞‡•ç‡§Æ‡§ø‡§®‡§≤", sum:"‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂", payable:"‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø ‡§∞‡§æ‡§∂‡§ø", cash:"‡§®‡§ï‡§¶", credit:"‡§≤‡§ø‡§ñ ‡§≤‡•ã (‡§â‡§ß‡§æ‡§∞)", hold:"üü° ‡§π‡•ã‡§≤‡•ç‡§°", done:"üü¢ ‡§™‡•Ç‡§∞‡•ç‡§£", clear:"üî¥ ‡§∏‡§æ‡•û ‡§ï‡§∞‡•á‡§Ç" }
      };

      function toggleLanguage() {
          currentLang = currentLang === 'en' ? 'hi' : 'en';
          const t = langData[currentLang];
          el("shopTitle").textContent = t.shop;
          el("btnMem").innerHTML = t.mem; el("btnHist").innerHTML = t.hist; el("btnExp").innerHTML = t.exp;
          el("lblTerm").textContent = t.term; el("lblSum").textContent = t.sum; el("lblPayable").textContent = t.payable;
          el("btnCash").textContent = t.cash; el("btnCredit").textContent = t.credit;
          el("txtHold").textContent = t.hold; el("txtDone").textContent = t.done; el("txtClear").textContent = t.clear;
          
          // Cards translation using data attributes
          document.querySelectorAll("[data-en]").forEach(i => i.textContent = currentLang === 'en' ? i.dataset.en : i.dataset.hi);
          updateShift();
          showToast(currentLang === 'en' ? "English Enabled" : "‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø");
      }

      // Logic: Persistent Search Dropdown with Keyboard Support
      function handleSearch(val) {
          const drop = el("searchDropdown");
          const searchVal = val.trim();

          // Show ALL customers when search is focused (even if empty)
          const filtered = !searchVal
            ? customers
            : customers.filter(c => c.name.toLowerCase().includes(searchVal.toLowerCase()));

          // Always show dropdown when there's input or focus
          if (searchVal || document.activeElement === el("custSearch")) {
              let html = '';
              
              // Always show "Add New Customer" option at top
              if (searchVal) {
                  html += `
                    <div class="drop-item" onclick="addCustomerDirect('${escapeHtml(searchVal)}')" style="background: #f0fdf4; border-bottom: 2px solid #22c55e;">
                      <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:18px;">‚ûï</span>
                        <div>
                          <div style="font-weight:900; color:#166534;">Add New Customer</div>
                          <div style="font-size:11px; color:#15803d;">"${escapeHtml(searchVal)}"</div>
                        </div>
                      </div>
                    </div>
                  `;
              }
              
              // Show matching customers
              if (filtered.length > 0) {
                  html += filtered.map((c, i) => `
                    <div class="drop-item" onclick="selectCust('${c.name}')" data-index="${i}" style="display:flex; justify-content:space-between; align-items:center;">
                      <div>
                        <div style="font-weight:700;">${c.name}</div>
                        <div style="font-size:11px; color:var(--muted);">${c.phone || 'No phone'}</div>
                      </div>
                      <div style="text-align:right;">
                        ${c.advance > 0 ? `<div style="font-size:11px; color:#dc2626; font-weight:700;">üìï ‚Çπ${c.advance.toFixed(2)}</div>` : ''}
                        <div style="font-size:11px; color:var(--muted);">Bal: ‚Çπ${(c.balance || 0).toFixed(2)}</div>
                      </div>
                    </div>
                  `).join('');
              } else if (!searchVal) {
                  html += '<div style="padding:15px; text-align:center; color:var(--muted); font-size:12px;">Start typing to search customers</div>';
              }
              
              drop.innerHTML = html;
              drop.style.display = 'block';
          } else {
            drop.style.display = 'none';
          }
      }
      
      // Add customer directly from dropdown (no popup)
      function addCustomerDirect(name) {
        if (!name) return;
        
        // Check if customer already exists
        const existing = customers.find(c => c.name.toLowerCase() === name.toLowerCase());
        if (existing) {
          selectCust(existing.name);
          showToast('Customer selected: ' + name);
          return;
        }
        
        // Add new customer directly
        customers.push({ 
          name: name, 
          lastOrder: "No order yet", 
          rate: 0, 
          qty: 0, 
          type: "Retail",
          sub: 0,
          balance: 0,
          advance: 0
        });
        localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
        
        selectCust(name);
        el("custSearch").value = name;
        el("searchDropdown").style.display = 'none';
        showToast(name + ' added! ‚úÖ');
      }
      
      // Show all customers when search is focused
      el("custSearch").addEventListener('focus', function() {
        handleSearch('');
      });
      
      // Add customer with validation
      function addCust() {
        const name = el("newName").value;
        const type = el("newType").value;
        const sub = el("subQty").value || 0;
        if(!name) return showToast("Name required!");

        customers.push({ name, lastOrder: "No order yet", rate: 0, qty: 0, type, sub });
        localStorage.setItem('mr_pos_customers', JSON.stringify(customers));

        selectCust(name);
        closeModal('addCustModal');
        el("newName").value = "";
        el("subQty").value = "";
        showToast(name + " Added!");
        
        // Return focus to search
        setTimeout(() => el("custSearch").focus(), 100);
      }
      
      // Select customer from search
      function selectCust(name) {
          el("activeCust").innerText = name;
          el("custSearch").value = name;
          el("searchDropdown").style.display = "none";
          showToast("Customer: " + name);
          
          // Show advance toggle for this customer
          showAdvanceSection(name);
      }
      
      // Show advance/cut ledger
      function showAdvanceSection(customerName) {
        const customer = customers.find(c => c.name === customerName);
        if (!customer) {
          el("advanceSection").style.display = "none";
          el("advanceToggleBtn").style.display = "none";
          el("udharThresholdNudge").style.display = "none";
          return;
        }
        
        // Initialize advance if not exists
        if (!customer.advance) customer.advance = 0;
        if (!customer.monthMilk) customer.monthMilk = 0;
        
        el("monthMilk").textContent = customer.monthMilk.toFixed(1) + ' L';
        el("currentAdvance").textContent = '‚Çπ' + customer.advance.toFixed(2);
        
        // Show advance toggle button with existing advance amount
        const advanceBtn = el("advanceToggleBtn");
        advanceBtn.style.display = "flex";
        if (customer.advance > 0) {
          advanceBtn.innerHTML = `üìï Udhar: ‚Çπ${customer.advance.toFixed(2)}`;
        } else {
          advanceBtn.innerHTML = 'üìï Advance / Udhar';
        }
        
        // Show Udhar threshold nudge if high credit
        const udharNudge = el("udharThresholdNudge");
        if (udharNudge) {
          udharNudge.style.display = (customer.advance || 0) > 3000 ? 'block' : 'none';
        }
      }
      
      // Toggle advance section visibility
      function toggleAdvance() {
        const section = el("advanceSection");
        if (section.style.display === 'none' || section.style.display === '') {
          section.style.display = 'block';
          const customerName = el("activeCust").innerText;
          if (customerName && customerName !== 'Walking Customer') {
            showAdvanceSection(customerName);
          }
        } else {
          section.style.display = 'none';
        }
      }
      
      // Close advance section
      function closeAdvance() {
        el("advanceSection").style.display = 'none';
      }
      
      // Update advance (give/cut)
      function updateAdvance() {
        const customerName = el("activeCust").innerText;
        const amount = parseFloat(el("advanceAmount").value);
        const action = el("advanceAction").value;
        
        if (!amount || amount <= 0) return showToast("Enter valid amount");
        
        const customer = customers.find(c => c.name === customerName);
        if (!customer) return showToast("Customer not found");
        
        if (!customer.advance) customer.advance = 0;
        
        if (action === 'give') {
          customer.advance += amount;
          showToast(`‚Çπ${amount} given to ${customerName}`);
        } else if (action === 'cut') {
          customer.advance -= amount;
          showToast(`‚Çπ${amount} cut from ${customerName}`);
        }
        
        localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
        el("advanceAmount").value = "";
        showAdvanceSection(customerName);
      }
      
      // Send monthly summary via WhatsApp
      function sendMonthlySummary() {
        const customerName = el("activeCust").innerText;
        const customer = customers.find(c => c.name === customerName);
        
        if (!customer) return showToast("Customer not found");
        
        const monthMilk = customer.monthMilk || 0;
        const advance = customer.advance || 0;
        
        const message = `*Monthly Summary - ${customerName}*\n\nü•õ Total Milk: ${monthMilk.toFixed(1)}L\nüí∞ Current Advance: ‚Çπ${advance.toFixed(2)}\n\nThank you for your business!`;
        
        const phone = customer.phone || "";
        const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
        
        window.open(whatsappUrl, '_blank');
        showToast("Opening WhatsApp...");
      }

      // Existing Code Logic
      let selectedProduct = null; // Track selected product for highlighting
      
      function tapAdd(name, rate, qty) { 
        // Check if item already exists in cart - match by NAME ONLY (merge Cow Milk regardless of rate)
        const existingItem = cart.find(item => item.name === name);
        if (existingItem) {
          // Increase quantity of existing item (merge all Cow Milk together)
          existingItem.qty += qty;
        } else {
          // Add new item
          cart.push({name, rate, qty, id: Date.now()});
        }
        selectedProduct = {name, rate}; // Track for highlighting
        updateUI(); 
        showToast(name + " added"); 
        
        // Highlight the clicked card by finding it via onclick attribute
        highlightProductCard(name);
      }
      
      function highlightProductCard(productName) {
        // Remove highlight from all cards
        document.querySelectorAll('.p-card').forEach(card => {
          card.classList.remove('selected');
        });
        
        // Find the card by matching onclick attribute
        document.querySelectorAll('.p-card').forEach(card => {
          const onclick = card.getAttribute('onclick') || '';
          if (onclick.includes(`'${productName}'`)) {
            card.classList.add('selected');
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        });
      }
      // adjustQty removed - use inline quantity editing instead
      function updateUI() {
        const tbody = el("cartItems"); tbody.innerHTML = ""; total = 0;
        cart.forEach((i, index) => {
          const itemAmount = i.rate * i.qty;
          total += itemAmount;
          tbody.innerHTML += `<tr>
            <td>${i.name}<br><small style="color:var(--muted); font-weight:700;">‚Çπ${i.rate}/unit</small></td>
            <td>
              <input type="number" value="${i.qty}" min="0.1" step="0.1"
                onchange="updateItemQty(${index}, this.value)"
                style="width:70px; padding:4px; border:1px solid var(--line); border-radius:6px; font-weight:700; text-align:center;"
                title="Quantity" />
            </td>
            <td>
              <input type="number" value="${itemAmount.toFixed(2)}" min="1" step="1"
                onchange="updateItemAmount(${index}, this.value)"
                style="width:80px; padding:4px; border:1px solid var(--line); border-radius:6px; font-weight:700; text-align:center;"
                title="Amount in ‚Çπ" />
            </td>
            <td style="text-align:right;">
              <button onclick="removeItem(${index})" style="background:#fecaca; color:#7f1d1d; border:none; border-radius:6px; padding:4px 8px; cursor:pointer; font-weight:700; font-size:12px;">‚úï Remove</button>
            </td>
          </tr>`;
        });
        el("totalAmt").textContent = `‚Çπ${total.toFixed(2)}`;
        
        // Highlight product cards based on cart items
        highlightCardsFromCart();
      }
      
      function highlightCardsFromCart() {
        // Remove highlight from all cards first
        document.querySelectorAll('.p-card').forEach(card => {
          card.classList.remove('selected');
        });
        
        // Highlight cards for items in cart by matching onclick
        cart.forEach(item => {
          document.querySelectorAll('.p-card').forEach(card => {
            const onclick = card.getAttribute('onclick') || '';
            if (onclick.includes(`'${item.name}'`)) {
              card.classList.add('selected');
            }
          });
        });
      }
      
      // Update item quantity (amount auto-calculates)
      function updateItemQty(index, newQty) {
        const qty = parseFloat(newQty);
        if (qty > 0) {
          cart[index].qty = qty;
          updateUI();
        } else {
          removeItem(index);
        }
      }
      
      // Update item amount (quantity auto-calculates)
      function updateItemAmount(index, newAmount) {
        const amount = parseFloat(newAmount);
        if (amount > 0 && cart[index].rate > 0) {
          cart[index].qty = amount / cart[index].rate;
          updateUI();
        } else {
          removeItem(index);
        }
      }
      
      // Remove item from cart
      function removeItem(index) {
        cart.splice(index, 1);
        updateUI();
        showToast("Item removed");
      }

     function saveEntry(mode) {
    if(total === 0) return showToast("Cart empty");
    const custName = el("activeCust").innerText;
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const itemsDetail = cart.map(i => `${i.qty}x ${i.name}`).join(" | ");

    // Calculate total milk quantity for month tracking
    const totalMilkQty = cart.filter(i => i.name.includes('Milk')).reduce((sum, i) => sum + i.qty, 0);

    // Save full cart data for replay
    const newSale = {
      date: new Date().toLocaleDateString(),
      time,
      customer: custName,
      products: itemsDetail,
      amount: total.toFixed(2),
      method: mode,
      cartItems: JSON.parse(JSON.stringify(cart)) // Save full cart for replay
    };

    // 1. Array mein add karo
    exportHistory.push(newSale);

    // ‚úÖ 2. FIX: Browser memory mein History save karo (Ye line zaroori hai)
    localStorage.setItem('mr_sales_history', JSON.stringify(exportHistory));

    // 3. UI update - Make clickable
    const entry = `<div class="cardRow" style="flex-direction:column; align-items:flex-start; gap:4px; cursor:pointer;" onclick="loadOrderFromHistory('${custName}', ${JSON.stringify(cart).replace(/"/g, '&quot;')})">
      <div style="width:100%; display:flex; justify-content:space-between;">
        <b>${custName}</b><b>‚Çπ${total.toFixed(2)}</b>
      </div>
      <div style="font-size:11px; color:var(--muted); font-weight:700;">
        ${time} ‚Ä¢ üõí ${itemsDetail} ‚Ä¢ ${modeIcon(mode)} ${mode}
        <span style="color:var(--blue); font-weight:700; margin-left:8px;">üîÅ Click to reload</span>
      </div>
    </div>`;
    el("historyToday").innerHTML = entry + el("historyToday").innerHTML;

    // Customer persistence + advance tracking
    let cIdx = customers.findIndex(c => c.name === custName);
    if(cIdx !== -1) {
        customers[cIdx].lastOrder = itemsDetail;
        customers[cIdx].rate = cart[0].rate;
        customers[cIdx].qty = cart[0].qty;
        customers[cIdx].lastProductName = cart[0].name;

        // Update monthly milk tracking
        if (!customers[cIdx].monthMilk) customers[cIdx].monthMilk = 0;
        customers[cIdx].monthMilk += totalMilkQty;
        
        // Handle Credit/Udhar - Add to customer balance
        if (mode === 'Credit' || mode === 'Udhar') {
            if (!customers[cIdx].balance) customers[cIdx].balance = 0;
            customers[cIdx].balance += total;
            showToast(`‚Çπ${total.toFixed(2)} added to Udhar ‚úÖ`);
        } else {
            showToast(`Saved ‚úÖ`);
        }

        localStorage.setItem('mr_pos_customers', JSON.stringify(customers));
    } else {
        showToast(`Saved ‚úÖ`);
    }
    
    resetCart();
}

// Get payment mode icon
function modeIcon(mode) {
    if (mode === 'Credit' || mode === 'Udhar') return 'üìï';
    if (mode === 'UPI') return 'üì±';
    return 'üíµ';
}

// Load order from history (clickable history items)
function loadOrderFromHistory(customerName, cartItems) {
  // Set customer
  el("activeCust").innerText = customerName;
  el("custSearch").value = customerName;
  
  // Load cart items
  cart = cartItems.map(item => ({...item, id: Date.now() + Math.random()}));
  
  // Update UI
  updateUI();
  closeModal('historyModal');
  showToast(`Loaded order for ${customerName}`);
}

// Switch history tab (today/all)
function switchHistoryTab(tab) {
  const todayDiv = el("historyToday");
  const allDiv = el("historyWeekly"); // Reusing same div for all history
  const tabToday = el("tabToday");
  const tabAll = el("tabAll");
  
  if (tab === 'today') {
    todayDiv.style.display = 'block';
    allDiv.style.display = 'none';
    tabToday.style.borderBottomColor = 'var(--blue)';
    tabAll.style.borderBottomColor = 'transparent';
    renderHistory();
  } else {
    todayDiv.style.display = 'none';
    allDiv.style.display = 'block';
    tabToday.style.borderBottomColor = 'transparent';
    tabAll.style.borderBottomColor = 'var(--blue)';
    renderAllHistory();
  }
}

// Render ALL history (no date limit)
function renderAllHistory() {
  const container = el("historyWeekly");
  
  if (exportHistory.length === 0) {
    container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted);">No sales history yet</div>';
    return;
  }
  
  // Show ALL history, newest first
  const allHistory = [...exportHistory].reverse();
  
  container.innerHTML = allHistory.map((sale, i) => {
    // Get payment mode icon
    let modeIcon = 'üíµ';
    if (sale.method === 'Credit' || sale.method === 'Udhar') modeIcon = 'üìï';
    else if (sale.method === 'UPI') modeIcon = 'üì±';
    
    return `
    <div class="cardRow" style="cursor:pointer;" onclick="loadOrderFromHistory('${sale.customer.replace(/'/g, "\\'")}', ${JSON.stringify(sale.cartItems || []).replace(/"/g, '&quot;')})">
      <div style="flex:1">
        <b>${sale.customer}</b><br>
        <small style="color:var(--muted); font-weight:700;">${sale.date} ${sale.time} ‚Ä¢ ${sale.products} ‚Ä¢ ${modeIcon} ${sale.method}</small>
      </div>
      <b style="color:var(--blue);">‚Çπ${sale.amount}</b>
    </div>
  `}).join('');
  
  // Update count
  const todayCount = exportHistory.filter(s => s.date === new Date().toLocaleDateString()).length;
  el("historyCount").textContent = `${todayCount} today ‚Ä¢ ${exportHistory.length} total`;
}

// Export history to CSV
function downloadHistoryCSV() {
  if (exportHistory.length === 0) return showToast("No history to export!");

  let csv = "Date,Time,Customer,Products,Amount,Payment Method\n";
  exportHistory.forEach(r => {
    let safeCust = r.customer.replace(/,/g, "");
    let safeProd = r.products.replace(/,/g, " | ");
    csv += `${r.date},${r.time},${safeCust},"${safeProd}",${r.amount},${r.method}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.setAttribute("href", url);
  a.setAttribute("download", `MilkRecord_History_${new Date().toISOString().split('T')[0]}.csv`);
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  showToast("History Exported! üìä‚úÖ");
}

// Clear today's history
function clearTodayHistory() {
  const today = new Date().toLocaleDateString();
  if (!confirm(`Clear all ${today} sales? This cannot be undone!`)) return;

  exportHistory = exportHistory.filter(sale => sale.date !== today);
  localStorage.setItem('mr_sales_history', JSON.stringify(exportHistory));
  loadHistoryOnStart();
  renderAllHistory();
  showToast("Today's history cleared! üóëÔ∏è");
}

      function exportDetailedExcel() {
    // 1. Check if history exists
    if(exportHistory.length === 0) return showToast("No sales to export!");

    // 2. CSV Header (Point 21: Institutional Export)
    let csv = "Date,Time,Customer,Products,Amount,Payment Method\n";

    // 3. Row Logic
    exportHistory.forEach(r => {
        // Customer ya Product name mein agar comma ho toh use clean karna
        let safeCust = r.customer.replace(/,/g, "");
        let safeProd = r.products.replace(/,/g, " | "); // Comma handling
        
        csv += `${r.date},${r.time},${safeCust},"${safeProd}",${r.amount},${r.method}\n`;
    });

    // --- ‚úÖ 4. ADDED: File Creation & Auto-Download Logic ---
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    
    // File name format (e.g., MilkRecord_Report_2026-02-16.csv)
    const fileName = `MilkRecord_Report_${new Date().toISOString().split('T')[0]}.csv`;
    
    a.setAttribute("href", url);
    a.setAttribute("download", fileName);
    document.body.appendChild(a); // Temporary addition
    a.click(); // Trigger click to download
    document.body.removeChild(a); // Cleanup
    
    showToast("Excel Exported! üìä‚úÖ");
}
      function addCust() {
          const name = el("newName").value;
          if(!name) return showToast("Name required!");
          customers.push({ name: name, lastOrder: "New Customer", rate: 0, qty: 0, type: el("newType").value });
          el("activeCust").innerText = name;
          closeModal('addCustModal'); el("newName").value = "";
          showToast(name + " Added!");
      }

      function renderMemory() {
    const list = el("memoryList");
    list.innerHTML = "";
    customers.forEach(c => {
        list.innerHTML += `
        <div class="cardRow">
            <div style="flex:1">
                <b>${c.name}</b><br>
                <small>Last: ${c.lastOrder} ${c.sub > 0 ? '| Subscribed: '+c.sub+'L' : ''}</small>
            </div>
            <button class="pillbtn primary" onclick="repeatOrder('${c.name}', '${c.lastProductName || 'Cow Milk'}', ${c.rate || 64}, ${c.qty || 1})">Repeat</button>
        </div>`;
    });
    openModal('memoryModal');
}

      function repeatOrder(name, productName, rate, qty) {
        el("activeCust").innerText = name;
        if(rate > 0) {
          // Add the actual product from customer's last order
          cart = [{name: productName, rate: parseFloat(rate) || 64, qty: parseFloat(qty) || 1, id: Date.now()}];
          updateUI();
        }
        closeModal('memoryModal');
      }
      function resetCart() { cart = []; updateUI(); el("activeCust").innerText = "Walking Customer"; el("custSearch").value = ""; el("advanceSection").style.display = "none"; el("advanceToggleBtn").style.display = "none"; }
      
      // Hold cart functionality
      function holdCart() {
        if (cart.length === 0) return showToast("Cart is empty!");
        const customerName = el("activeCust").innerText;
        const holdId = Date.now();
        
        heldCarts.push({
          id: holdId,
          customer: customerName,
          cart: [...cart],
          total: total,
          timestamp: new Date().toISOString()
        });
        
        localStorage.setItem('mr_held_carts', JSON.stringify(heldCarts));
        cart = [];
        updateUI();
        showToast(`Order held for ${customerName} ‚úÖ`);
        updateHoldButton();
      }
      
      // Retrieve held cart
      function retrieveHoldCart(holdId) {
        const holdIndex = heldCarts.findIndex(h => h.id === holdId);
        if (holdIndex === -1) return;
        
        const heldCart = heldCarts[holdIndex];
        cart = heldCart.cart;
        total = heldCart.total;
        el("activeCust").innerText = heldCart.customer;
        
        heldCarts.splice(holdIndex, 1);
        localStorage.setItem('mr_held_carts', JSON.stringify(heldCarts));
        
        updateUI();
        updateHoldButton();
        showToast(`Order retrieved for ${heldCart.customer} ‚úÖ`);
      }
      
      // Update hold button display
      function updateHoldButton() {
        const holdBtn = document.querySelector('button[onclick*="holdCart"]');
        const heldCountEl = document.getElementById('heldCount');
        
        if (holdBtn && heldCarts.length > 0) {
          holdBtn.innerHTML = `üü° HOLD <span class="subnote">${heldCarts.length} saved</span>`;
        } else if (holdBtn) {
          holdBtn.innerHTML = `üü° HOLD <span class="subnote">save</span>`;
        }
        
        if (heldCountEl) {
          heldCountEl.textContent = heldCarts.length;
        }
      }
      
      // Show held carts modal
      function showHeldCarts() {
        if (heldCarts.length === 0) return showToast("No held orders");
        
        const modal = document.getElementById('heldCartsModal');
        const list = document.getElementById('heldCartsList');
        
        list.innerHTML = heldCarts.map(h => `
          <div class="cardRow" style="cursor:pointer;" onclick="retrieveHoldCart(${h.id})">
            <div>
              <b>${h.customer}</b>
              <div style="font-size:11px; color:var(--muted);">${new Date(h.timestamp).toLocaleString()}</div>
            </div>
            <b>‚Çπ${h.total.toFixed(2)}</b>
          </div>
        `).join('');
        
        openModal('heldCartsModal');
      }
      
      function openModal(id) { el(id).style.display = "flex"; }
      function closeModal(id) { el(id).style.display = "none"; }
      function showToast(msg) { const t = el("toast"); t.textContent = msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 1500); }
      
      window.onload = () => {
    updateShift();
    loadHistoryOnStart(); // Ye function history ke cards wapas banayega
    loadCustomProducts(); // Load custom product cards
    setInterval(updateShift, 60000);
}

function loadHistoryOnStart() {
    const historyContainer = document.getElementById("historyToday");
    if(!historyContainer) return;
    historyContainer.innerHTML = "";
    
    const today = new Date().toLocaleDateString();
    const todaySales = exportHistory.filter(s => s.date === today);
    
    // Render today's history with clickable items and payment mode
    todaySales.forEach(sale => {
        // Get payment mode icon
        let modeIcon = 'üíµ';
        if (sale.method === 'Credit' || sale.method === 'Udhar') modeIcon = 'üìï';
        else if (sale.method === 'UPI') modeIcon = 'üì±';
        
        const entry = `<div class="cardRow" style="flex-direction:column; align-items:flex-start; gap:4px; cursor:pointer;" onclick="loadOrderFromHistory('${sale.customer.replace(/'/g, "\\'")}', ${JSON.stringify(sale.cartItems || []).replace(/"/g, '&quot;')})">
            <div style="width:100%; display:flex; justify-content:space-between;">
              <b>${sale.customer}</b><b>‚Çπ${sale.amount}</b>
            </div>
            <small style="color:var(--muted); font-weight:700;">
              ${sale.time} ‚Ä¢ ${sale.products} ‚Ä¢ ${modeIcon} ${sale.method}
              <span style="color:var(--blue); font-weight:700; margin-left:8px;">üîÅ Click to reload</span>
            </small>
          </div>`;
        historyContainer.insertAdjacentHTML('afterbegin', entry);
    });
    
    // Update count
    const totalCount = exportHistory.length;
    el("historyCount").textContent = `${todaySales.length} today ‚Ä¢ ${totalCount} total`;
}

function toggleGaps() { el("gapsPanel").classList.toggle("open"); }

// Convert milk to product
function convertMilkToProduct() {
  const qty = parseFloat(el("convQty").value);
  const productData = el("convProduct").value.split(',');
  const productName = productData[0];
  const rate = parseFloat(productData[1]);

  if (!qty || qty <= 0) return showToast("Enter valid quantity");

  // Add to cart
  const existingItem = cart.find(item => item.name === productName && item.rate === rate);
  if (existingItem) {
    existingItem.qty += qty;
  } else {
    cart.push({name: productName, rate, qty, id: Date.now()});
  }
  updateUI();
  closeModal('convertModal');
  el("convQty").value = "";
  showToast(`Converted ${qty}L to ${productName}`);
}

// Add new product card from modal
function addNewProductFromModal() {
  const name = el("pName").value.trim();
  const price = parseFloat(el("pPrice").value);
  const emoji = el("pEmoji").value.trim() || 'üì¶';

  if (!name || !price) return showToast("Name and Price required!");

  // Create new product card
  const grid = el("productGrid");
  const newCard = document.createElement('div');
  newCard.className = 'p-card';
  newCard.onclick = function() { tapAdd(name, price, 1); };
  newCard.innerHTML = `
    <span class="emoji" style="font-size: 56px;">${emoji}</span>
    <div style="font-size: 18px; font-weight: 900; margin-top: 8px;">${name}</div>
    <small style="font-size: 16px; margin-top: 4px;">‚Çπ${price}</small>
  `;

  // Insert before ADD PRODUCT button
  const addCardBtn = grid.querySelector('.p-card[onclick*="addProductModal"]');
  grid.insertBefore(newCard, addCardBtn);

  // Save to localStorage
  const customProducts = JSON.parse(localStorage.getItem('mr_pos_custom_products') || '[]');
  customProducts.push({name, price, emoji});
  localStorage.setItem('mr_pos_custom_products', JSON.stringify(customProducts));

  // Close modal and clear
  closeModal('addProductModal');
  el("pName").value = "";
  el("pPrice").value = "";
  el("pEmoji").value = "";
  showToast(`${name} added! ‚úÖ`);
}

// Filter products by search
function filterProducts(query) {
  const search = query.toLowerCase().trim();
  const cards = document.querySelectorAll('.p-card');
  
  cards.forEach(card => {
    const text = card.textContent.toLowerCase();
    if (search === '' || text.includes(search)) {
      card.style.display = 'flex';
    } else {
      card.style.display = 'none';
    }
  });
}

// Close customer search dropdown
function closeSearchDropdown() {
  const dropdown = el("searchDropdown");
  if (dropdown) dropdown.style.display = 'none';
}

// Add new product card (legacy function)
function addNewProduct() {
  addNewProductFromModal();
}

// Load custom products on page load
function loadCustomProducts() {
  const customProducts = JSON.parse(localStorage.getItem('mr_pos_custom_products') || '[]');
  const grid = el("productGrid");
  const addCardBtn = grid.querySelector('.p-card[onclick*="addProduct"]');
  
  customProducts.forEach(p => {
    const newCard = document.createElement('div');
    newCard.className = 'p-card';
    newCard.onclick = function() { tapAdd(p.name, p.price, 1); };
    newCard.innerHTML = `
      ${p.image ? `<img src="${p.image}" alt="${p.name}">` : `<div class="emoji">üì¶</div>`}
      <div>${p.name}</div>
      <small>‚Çπ${p.price}</small>
    `;
    grid.insertBefore(newCard, addCardBtn);
  });
}

// Keyboard Navigation - Full End-to-End Invoice Creation
document.addEventListener('keydown', function(e) {
  // F1 = New Customer
  if (e.key === 'F1') {
    e.preventDefault();
    openModal('addCustModal');
    setTimeout(() => el("newName").focus(), 100);
    return;
  }
  
  // Enter key handling
  if (e.key === 'Enter') {
    // In search box - select first result or current customer
    if (document.activeElement === el("custSearch")) {
      const firstResult = document.querySelector('.drop-item');
      if (firstResult) {
        firstResult.click();
      }
      // Move focus to product grid (first product)
      const firstProduct = document.querySelector('.p-card:not([onclick*="addProduct"])');
      if (firstProduct) firstProduct.focus();
      return;
    }
    
    // In add customer modal - navigate fields
    if (el("addCustModal").style.display === 'flex') {
      if (document.activeElement === el("newName")) {
        el("subQty").focus();
      } else if (document.activeElement === el("subQty")) {
        addCust();
      }
      return;
    }
    
    // In cart quantity/amount fields - move to next
    if (document.activeElement.tagName === 'INPUT' && 
        document.activeElement.type === 'number' &&
        document.activeElement.closest('.recent-table')) {
      const inputs = Array.from(document.querySelectorAll('.recent-table input[type="number"]'));
      const currentIndex = inputs.indexOf(document.activeElement);
      if (currentIndex < inputs.length - 1) {
        inputs[currentIndex + 1].focus();
        inputs[currentIndex + 1].select();
      }
      return;
    }
  }
  
  // Escape - clear search
  if (e.key === 'Escape') {
    if (document.activeElement === el("custSearch")) {
      el("custSearch").value = "";
      el("searchDropdown").style.display = "none";
    }
    // Close any open modals
    closeModal('addCustModal');
    closeModal('memoryModal');
    closeModal('historyModal');
    return;
  }
  
  // Number keys 1-9 when product grid focused - quick add
  if (document.activeElement.classList.contains('p-card')) {
    const num = parseInt(e.key);
    if (num >= 1 && num <= 9) {
      const products = document.querySelectorAll('.p-card:not([onclick*="addProduct"])');
      if (products[num - 1]) {
        products[num - 1].click();
      }
    }
  }
});

// Make product cards focusable for keyboard navigation
document.querySelectorAll('.p-card').forEach(card => {
  card.setAttribute('tabindex', '0');
  card.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      this.click();
    }
  });
});

// Focus search on page load
setTimeout(() => el("custSearch").focus(), 500);
    </script>
  </body>
</html>